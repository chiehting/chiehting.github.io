<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1C48BPHVP"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1C48BPHVP")}</script><meta charset=UTF-8><meta charset=utf-8><meta name=viewport content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimal-ui"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=robots content="index, follow"><meta name=author content><meta name=description content="This website is preview about Chiehting. irregular update."><link rel=manifest href=/site.webmanifest><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><meta name=apple-mobile-web-app-title content="Chiehting's Blog"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Creating Redis Cluster"><meta itemprop=description content="後端服務需要使用 Redis Cluster, 此篇紀錄在 Centos 7 安裝 Redis Cluster 的過程."><meta itemprop=datePublished content="2020-01-14T10:56:00+08:00"><meta itemprop=dateModified content="2020-01-14T10:56:00+08:00"><meta itemprop=wordCount content="1235"><meta itemprop=keywords content="Redis"><meta property="og:url" content="https://chiehting.com/posts/redis-cluster-install-again/"><meta property="og:site_name" content="Chiehting's Blog"><meta property="og:title" content="Creating Redis Cluster"><meta property="og:description" content="後端服務需要使用 Redis Cluster, 此篇紀錄在 Centos 7 安裝 Redis Cluster 的過程."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-14T10:56:00+08:00"><meta property="article:modified_time" content="2020-01-14T10:56:00+08:00"><meta property="article:tag" content="Redis"><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating Redis Cluster"><meta name=twitter:description content="後端服務需要使用 Redis Cluster, 此篇紀錄在 Centos 7 安裝 Redis Cluster 的過程."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Creating Redis Cluster","name":"Creating Redis Cluster","description":"後端服務需要使用 Redis Cluster, 此篇紀錄在 Centos 7 安裝 Redis Cluster 的過程.\n","keywords":["redis"],"articleBody":"後端服務需要使用 Redis Cluster, 此篇紀錄在 Centos 7 安裝 Redis Cluster 的過程.\nCluster教學 https://redis.io/topics/cluster-tutorial\n注意: binary file放置位置,會造成SELinux異常 在 Build Redis 時,其中有一個參數 PREFIX 是編譯完成後 binary 的位置,如下. 使用 Centos7 時,有變更這個參數,導致 redis-server 無法在 /var/log/redis 底下建立檔案,碰到 avc denied open,若不異動則正常, 原因是SELinux引起的.\n[Justin.Lee@dev-cache redis-5.0.7]$ cat src/Makefile ... PREFIX?=/usr/local INSTALL_BIN=$(PREFIX)/bin INSTALL=install ... 注意: 建置 Redis Cluster 群集時, 密碼配置時要注意 建立 Redis Cluster 時有配置密碼, 第一次建立沒問題, 但是若做restart時, 報錯誤說NOAUTH Authentication required.,原因是因為設定檔內只有配置 requirepass 參數未配置 masterauth 參數導致的,補上排除.\n[Justin.Lee@dev-cache redis]# cat /etc/redis/redis_7000.conf ... requirepass {{ redis_config_requirepass }} # If the master is password protected (using the \"requirepass\" configuration # directive below) it is possible to tell the replica to authenticate before # starting the replication synchronization process, otherwise the master will # refuse the replica request. masterauth {{ redis_config_requirepass }} ... error log\n[Justin.Lee@dev-cache redis]# cat /var/log/redis/redis_7004.log 10920:S 20 Jan 2020 02:29:51.238 # MASTER aborted replication with an error: NOAUTH Authentication required. 10920:S 20 Jan 2020 02:29:52.240 * Connecting to MASTER 192.168.20.188:7002 10920:S 20 Jan 2020 02:29:52.240 * MASTER \u003c-\u003e REPLICA sync started 10920:S 20 Jan 2020 02:29:52.240 * Non blocking connect for SYNC fired the event. 10920:S 20 Jan 2020 02:29:52.240 * Master replied to PING, replication can continue... 10920:S 20 Jan 2020 02:29:52.240 * (Non critical) Master does not understand REPLCONF listening-port: -NOAUTH Authentication required. 10920:S 20 Jan 2020 02:29:52.240 * (Non critical) Master does not understand REPLCONF capa: -NOAUTH Authentication required. 10920:S 20 Jan 2020 02:29:52.240 * Partial resynchronization not possible (no cached master) 10920:S 20 Jan 2020 02:29:52.240 # Unexpected reply to PSYNC from master: -NOAUTH Authentication required. 確認主機配置 firewall [Justin.Lee@dev-db2 ~]$ sudo firewall-cmd --list-all public (active) target: default icmp-block-inversion: no interfaces: ens192 sources: services: ssh dhcpv6-client ports: protocols: masquerade: no forward-ports: source-ports: icmp-blocks: rich rules: ip address [Justin.Lee@dev-db2 ~]$ ip a 1: lo: mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever 2: ens192: mtu 1500 qdisc mq state UP group default qlen 1000 link/ether 00:0c:29:90:78:61 brd ff:ff:ff:ff:ff:ff inet 192.168.20.189/24 brd 192.168.20.255 scope global noprefixroute ens192 valid_lft forever preferred_lft forever inet6 fe80::13b6:9f1a:cc9f:b263/64 scope link noprefixroute valid_lft forever preferred_lft forever before starting Redis Cluster TCP ports Every Redis Cluster node requires two TCP connections open. The normal Redis TCP port used to serve clients, for example 6379, plus the port obtained by adding 10000 to the data port, so 16379 in the example.\nRedis Cluster data sharding Redis Cluster does not use consistent hashing, but a different form of sharding where every key is conceptually part of what we call an hash slot.\nThere are 16384 hash slots in Redis Cluster, and to compute what is the hash slot of a given key, we simply take the CRC16 of the key modulo 16384.\ninstall Redis 5.0.7 安裝 remi-release-7.rpm\n[Justin.Lee@dev-db2 ~]$ yum.repos.d]$ sudo yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm 安裝Redis 5.0.7-1.el7.remi\n[Justin.Lee@dev-db2 ~]$ sudo yum list redis --enablerepo=remi --showduplicates [Justin.Lee@dev-db2 ~]$ sudo yum install redis-5.0.7-1.el7.remi --enablerepo=remi Redis service disable\n[Justin.Lee@dev-db2 ~]$ sudo systemctl disable redis setting Redis configuration 配置其中一個 redis.conf, 其中7000單一個 Redis 的 port 號. 其他的 redis.conf 就依序更改 7000 的數字.\n# Redis 5.0.7 configuration file example. bind 0.0.0.0 protected-mode no port 7000 daemonize yes pidfile /var/run/redis_7000.pid logfile /var/log/redis/redis_7000.log dir /var/lib/redis appendonly yes cluster-enabled yes cluster-config-file nodes-6379.conf cluster-node-timeout 15000 cluster-require-full-coverage no 確認 port 後, 必須開啟防火牆, 例如 port 7000, 就必須要開起 7000/tcp 跟 17000/tcp.\n[Justin.Lee@dev-cache ~]$ sudo firewall-cmd --add-port=7000/tcp --permanent [Justin.Lee@dev-cache ~]$ sudo firewall-cmd --add-port=17000/tcp --permanent [Justin.Lee@dev-cache ~]$ sudo firewall-cmd --reload [Justin.Lee@dev-cache ~]$ sudo firewall-cmd --list-all Creating the cluster 最少需要 3 個 master, 參數--cluster-replicas為一個 master 需要幾個 slave, 如下依此類推.\n每群Redis Cluster\n–cluster-replicas 0, 1 master 0 slave –cluster-replicas 1, 1 master 1 slave –cluster-replicas 2, 1 master 2 slave [Justin.Lee@dev-db2 ~]$ redis-cli --cluster help [Justin.Lee@dev-db2 ~]$ redis-cli --cluster create 192.168.20.189:7000 192.168.20.189:7001 192.168.20.189:7002 192.168.20.189:7003 192.168.20.189:7004 192.168.20.189:7005 --cluster-replicas 1 -a password \u003e\u003e\u003e Performing hash slots allocation on 6 nodes... Master[0] -\u003e Slots 0 - 5460 Master[1] -\u003e Slots 5461 - 10922 Master[2] -\u003e Slots 10923 - 16383 Adding replica 127.0.0.1:7004 to 127.0.0.1:7000 Adding replica 127.0.0.1:7005 to 127.0.0.1:7001 Adding replica 127.0.0.1:7003 to 127.0.0.1:7002 \u003e\u003e\u003e Trying to optimize slaves allocation for anti-affinity [WARNING] Some slaves are in the same host as their master M: 99ff53a04d977692016e7df517533226ff3bd218 127.0.0.1:7000 slots:[0-5460] (5461 slots) master M: 4f9af42e6c6e2239e46cf9cd14af3e8c688638d5 127.0.0.1:7001 slots:[5461-10922] (5462 slots) master M: 01279d2e588ac7b25da2df232412153b26950184 127.0.0.1:7002 slots:[10923-16383] (5461 slots) master S: c12c3b7aed21133f078a3262ec201ec9106a6ae0 127.0.0.1:7003 replicates 99ff53a04d977692016e7df517533226ff3bd218 S: ea108846aba5cd010feebe8482f29babcbc51ee0 127.0.0.1:7004 replicates 4f9af42e6c6e2239e46cf9cd14af3e8c688638d5 S: 7ea79aec309af8048453c6059d3cd35da57468df 127.0.0.1:7005 replicates 01279d2e588ac7b25da2df232412153b26950184 驗證 連至其中一台Redis後可以開始做查詢,例如下面的命令.\n[Justin.Lee@dev-db2 ~]$ redis-cli -c -p 7000 -h 192.168.20.189 -a password 192.168.20.189:7000\u003e cluster info 192.168.20.189:7000\u003e cluster nodes 查看log,發現有些warning,依照建議去調整主機配置.\n[Justin.Lee@dev-db2 redis]$ cat redis_7000.log 2030:C 16 Jan 2020 01:27:43.297 # Redis version=5.0.7, bits=64, commit=00000000, modified=0, pid=2030, just started ... 2031:M 16 Jan 2020 01:27:43.301 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128. 2031:M 16 Jan 2020 01:27:43.301 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect. 2031:M 16 Jan 2020 01:27:43.301 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never \u003e /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled. ... ","wordCount":"1235","inLanguage":"en","datePublished":"2020-01-14T10:56:00+08:00","dateModified":"2020-01-14T10:56:00+08:00","author":{"@type":"Person","name":null},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chiehting.com/posts/redis-cluster-install-again/"},"publisher":{"@type":"Organization","name":"Chiehting's Blog","description":"This website is preview about Chiehting. irregular update.","logo":{"@type":"ImageObject","url":"https://chiehting.com/favicon.ico"}}}</script><title>Creating Redis Cluster</title><link rel="stylesheet dns-prefetch preconnect preload prefetch" as=style media=screen href=https://chiehting.com/css/style.min.4a728eca217aff37d24d94ea492de99e69fea0a53bb05c836db76b9d0504ef60.css integrity="sha256-SnKOyiF6/zfSTZTqSS3pnmn+oKU7sFyDbbdrnQUE72A=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://chiehting.com/>Chiehting's Blog</a></div><nav class="site-nav hide-in-mobile"><a href=https://chiehting.com/posts/>Posts</a><a href=https://chiehting.com/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-links hide-in-mobile"><a href=ting911111@gmail.com target=_blank rel="noopener me" title=Email><svg class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a><a href=https://github.com/chiehting target=_blank rel="noopener me" title=Github><svg class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://chiehting.com/posts/>Posts</a></li><li><a href=https://chiehting.com/about/>About</a></li></ul></div><main class="site-main section-inner thin animated fadeIn faster"><h1>Creating Redis Cluster</h1><div class=content><p>後端服務需要使用 Redis Cluster, 此篇紀錄在 Centos 7 安裝 Redis Cluster 的過程.</p><p>Cluster教學 <code>https://redis.io/topics/cluster-tutorial</code></p><h3 id=注意-binary-file放置位置會造成selinux異常>注意: binary file放置位置,會造成SELinux異常<a href=#%e6%b3%a8%e6%84%8f-binary-file%e6%94%be%e7%bd%ae%e4%bd%8d%e7%bd%ae%e6%9c%83%e9%80%a0%e6%88%90selinux%e7%95%b0%e5%b8%b8 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>在 Build Redis 時,其中有一個參數 PREFIX 是編譯完成後 binary 的位置,如下. 使用 Centos7 時,有變更這個參數,導致 redis-server 無法在 <code>/var/log/redis</code> 底下建立檔案,碰到 <code>avc denied open</code>,若不異動則正常, 原因是SELinux引起的.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-cache redis-5.0.7<span class=o>]</span>$ cat src/Makefile
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>PREFIX?<span class=o>=</span>/usr/local
</span></span><span class=line><span class=cl><span class=nv>INSTALL_BIN</span><span class=o>=</span><span class=k>$(</span>PREFIX<span class=k>)</span>/bin
</span></span><span class=line><span class=cl><span class=nv>INSTALL</span><span class=o>=</span>install
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><h3 id=注意-建置-redis-cluster-群集時-密碼配置時要注意>注意: 建置 Redis Cluster 群集時, 密碼配置時要注意<a href=#%e6%b3%a8%e6%84%8f-%e5%bb%ba%e7%bd%ae-redis-cluster-%e7%be%a4%e9%9b%86%e6%99%82-%e5%af%86%e7%a2%bc%e9%85%8d%e7%bd%ae%e6%99%82%e8%a6%81%e6%b3%a8%e6%84%8f class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>建立 Redis Cluster 時有配置密碼, 第一次建立沒問題, 但是若做restart時, 報錯誤說<code>NOAUTH Authentication required.</code>,原因是因為設定檔內只有配置 requirepass 參數未配置 masterauth 參數導致的,補上排除.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-cache redis<span class=o>]</span><span class=c1># cat /etc/redis/redis_7000.conf</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>requirepass <span class=o>{{</span> redis_config_requirepass <span class=o>}}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># If the master is password protected (using the &#34;requirepass&#34; configuration</span>
</span></span><span class=line><span class=cl><span class=c1># directive below) it is possible to tell the replica to authenticate before</span>
</span></span><span class=line><span class=cl><span class=c1># starting the replication synchronization process, otherwise the master will</span>
</span></span><span class=line><span class=cl><span class=c1># refuse the replica request.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>masterauth <span class=o>{{</span> redis_config_requirepass <span class=o>}}</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>error log</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-cache redis<span class=o>]</span><span class=c1># cat /var/log/redis/redis_7004.log</span>
</span></span><span class=line><span class=cl>10920:S <span class=m>20</span> Jan <span class=m>2020</span> 02:29:51.238 <span class=c1># MASTER aborted replication with an error: NOAUTH Authentication required.</span>
</span></span><span class=line><span class=cl>10920:S <span class=m>20</span> Jan <span class=m>2020</span> 02:29:52.240 * Connecting to MASTER 192.168.20.188:7002
</span></span><span class=line><span class=cl>10920:S <span class=m>20</span> Jan <span class=m>2020</span> 02:29:52.240 * MASTER &lt;-&gt; REPLICA sync started
</span></span><span class=line><span class=cl>10920:S <span class=m>20</span> Jan <span class=m>2020</span> 02:29:52.240 * Non blocking connect <span class=k>for</span> SYNC fired the event.
</span></span><span class=line><span class=cl>10920:S <span class=m>20</span> Jan <span class=m>2020</span> 02:29:52.240 * Master replied to PING, replication can <span class=k>continue</span>...
</span></span><span class=line><span class=cl>10920:S <span class=m>20</span> Jan <span class=m>2020</span> 02:29:52.240 * <span class=o>(</span>Non critical<span class=o>)</span> Master does not understand REPLCONF listening-port: -NOAUTH Authentication required.
</span></span><span class=line><span class=cl>10920:S <span class=m>20</span> Jan <span class=m>2020</span> 02:29:52.240 * <span class=o>(</span>Non critical<span class=o>)</span> Master does not understand REPLCONF capa: -NOAUTH Authentication required.
</span></span><span class=line><span class=cl>10920:S <span class=m>20</span> Jan <span class=m>2020</span> 02:29:52.240 * Partial resynchronization not possible <span class=o>(</span>no cached master<span class=o>)</span>
</span></span><span class=line><span class=cl>10920:S <span class=m>20</span> Jan <span class=m>2020</span> 02:29:52.240 <span class=c1># Unexpected reply to PSYNC from master: -NOAUTH Authentication required.</span>
</span></span></code></pre></div><h3 id=確認主機配置>確認主機配置<a href=#%e7%a2%ba%e8%aa%8d%e4%b8%bb%e6%a9%9f%e9%85%8d%e7%bd%ae class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><h4 id=firewall>firewall<a href=#firewall class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-db2 ~<span class=o>]</span>$ sudo firewall-cmd --list-all
</span></span><span class=line><span class=cl>public <span class=o>(</span>active<span class=o>)</span>
</span></span><span class=line><span class=cl>  target: default
</span></span><span class=line><span class=cl>  icmp-block-inversion: no
</span></span><span class=line><span class=cl>  interfaces: ens192
</span></span><span class=line><span class=cl>  sources:
</span></span><span class=line><span class=cl>  services: ssh dhcpv6-client
</span></span><span class=line><span class=cl>  ports:
</span></span><span class=line><span class=cl>  protocols:
</span></span><span class=line><span class=cl>  masquerade: no
</span></span><span class=line><span class=cl>  forward-ports:
</span></span><span class=line><span class=cl>  source-ports:
</span></span><span class=line><span class=cl>  icmp-blocks:
</span></span><span class=line><span class=cl>  rich rules:
</span></span></code></pre></div><h4 id=ip-address>ip address<a href=#ip-address class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-db2 ~<span class=o>]</span>$ ip a
</span></span><span class=line><span class=cl>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class=m>65536</span> qdisc noqueue state UNKNOWN group default qlen <span class=m>1000</span>
</span></span><span class=line><span class=cl>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class=line><span class=cl>    inet 127.0.0.1/8 scope host lo
</span></span><span class=line><span class=cl>       valid_lft forever preferred_lft forever
</span></span><span class=line><span class=cl>    inet6 ::1/128 scope host
</span></span><span class=line><span class=cl>       valid_lft forever preferred_lft forever
</span></span><span class=line><span class=cl>2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class=m>1500</span> qdisc mq state UP group default qlen <span class=m>1000</span>
</span></span><span class=line><span class=cl>    link/ether 00:0c:29:90:78:61 brd ff:ff:ff:ff:ff:ff
</span></span><span class=line><span class=cl>    inet 192.168.20.189/24 brd 192.168.20.255 scope global noprefixroute ens192
</span></span><span class=line><span class=cl>       valid_lft forever preferred_lft forever
</span></span><span class=line><span class=cl>    inet6 fe80::13b6:9f1a:cc9f:b263/64 scope link noprefixroute
</span></span><span class=line><span class=cl>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><h3 id=before-starting>before starting<a href=#before-starting class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><h4 id=redis-cluster-tcp-ports>Redis Cluster TCP ports<a href=#redis-cluster-tcp-ports class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><blockquote><p>Every Redis Cluster node requires two TCP connections open. The normal Redis TCP port used to serve clients, for example 6379, plus the port obtained by adding 10000 to the data port, so 16379 in the example.</p></blockquote><h4 id=redis-cluster-data-sharding>Redis Cluster data sharding<a href=#redis-cluster-data-sharding class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><blockquote><p>Redis Cluster does not use consistent hashing, but a different form of sharding where every key is conceptually part of what we call an hash slot.</p></blockquote><blockquote><p>There are 16384 hash slots in Redis Cluster, and to compute what is the hash slot of a given key, we simply take the CRC16 of the key modulo 16384.</p></blockquote><h3 id=install-redis-507>install Redis 5.0.7<a href=#install-redis-507 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>安裝 remi-release-7.rpm</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-db2 ~<span class=o>]</span>$ yum.repos.d<span class=o>]</span>$ sudo yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm
</span></span></code></pre></div><p>安裝Redis 5.0.7-1.el7.remi</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-db2 ~<span class=o>]</span>$ sudo yum list redis --enablerepo<span class=o>=</span>remi --showduplicates
</span></span><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-db2 ~<span class=o>]</span>$ sudo yum install redis-5.0.7-1.el7.remi --enablerepo<span class=o>=</span>remi
</span></span></code></pre></div><p>Redis service disable</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-db2 ~<span class=o>]</span>$ sudo systemctl disable redis
</span></span></code></pre></div><h3 id=setting-redis-configuration>setting Redis configuration<a href=#setting-redis-configuration class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>配置其中一個 redis.conf, 其中7000單一個 Redis 的 port 號. 其他的 redis.conf 就依序更改 7000 的數字.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Redis 5.0.7 configuration file example.</span>
</span></span><span class=line><span class=cl><span class=nb>bind</span> 0.0.0.0
</span></span><span class=line><span class=cl>protected-mode no
</span></span><span class=line><span class=cl>port <span class=m>7000</span>
</span></span><span class=line><span class=cl>daemonize yes
</span></span><span class=line><span class=cl>pidfile /var/run/redis_7000.pid
</span></span><span class=line><span class=cl>logfile /var/log/redis/redis_7000.log
</span></span><span class=line><span class=cl>dir /var/lib/redis
</span></span><span class=line><span class=cl>appendonly yes
</span></span><span class=line><span class=cl>cluster-enabled yes
</span></span><span class=line><span class=cl>cluster-config-file nodes-6379.conf
</span></span><span class=line><span class=cl>cluster-node-timeout <span class=m>15000</span>
</span></span><span class=line><span class=cl>cluster-require-full-coverage no
</span></span></code></pre></div><p>確認 port 後, 必須開啟防火牆, 例如 port 7000, 就必須要開起 7000/tcp 跟 17000/tcp.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-cache ~<span class=o>]</span>$ sudo firewall-cmd --add-port<span class=o>=</span>7000/tcp --permanent
</span></span><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-cache ~<span class=o>]</span>$ sudo firewall-cmd --add-port<span class=o>=</span>17000/tcp --permanent
</span></span><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-cache ~<span class=o>]</span>$ sudo firewall-cmd --reload
</span></span><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-cache ~<span class=o>]</span>$ sudo firewall-cmd --list-all
</span></span></code></pre></div><h3 id=creating-the-cluster>Creating the cluster<a href=#creating-the-cluster class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>最少需要 3 個 master, 參數<code>--cluster-replicas</code>為一個 master 需要幾個 slave, 如下依此類推.</p><p>每群Redis Cluster</p><ul><li>&ndash;cluster-replicas 0, 1 master 0 slave</li><li>&ndash;cluster-replicas 1, 1 master 1 slave</li><li>&ndash;cluster-replicas 2, 1 master 2 slave</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-db2 ~<span class=o>]</span>$ redis-cli --cluster <span class=nb>help</span>
</span></span><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-db2 ~<span class=o>]</span>$ redis-cli --cluster create 192.168.20.189:7000 192.168.20.189:7001 192.168.20.189:7002 192.168.20.189:7003 192.168.20.189:7004 192.168.20.189:7005 --cluster-replicas <span class=m>1</span> -a password
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Performing <span class=nb>hash</span> slots allocation on <span class=m>6</span> nodes...
</span></span><span class=line><span class=cl>Master<span class=o>[</span>0<span class=o>]</span> -&gt; Slots <span class=m>0</span> - <span class=m>5460</span>
</span></span><span class=line><span class=cl>Master<span class=o>[</span>1<span class=o>]</span> -&gt; Slots <span class=m>5461</span> - <span class=m>10922</span>
</span></span><span class=line><span class=cl>Master<span class=o>[</span>2<span class=o>]</span> -&gt; Slots <span class=m>10923</span> - <span class=m>16383</span>
</span></span><span class=line><span class=cl>Adding replica 127.0.0.1:7004 to 127.0.0.1:7000
</span></span><span class=line><span class=cl>Adding replica 127.0.0.1:7005 to 127.0.0.1:7001
</span></span><span class=line><span class=cl>Adding replica 127.0.0.1:7003 to 127.0.0.1:7002
</span></span><span class=line><span class=cl>&gt;&gt;&gt; Trying to optimize slaves allocation <span class=k>for</span> anti-affinity
</span></span><span class=line><span class=cl><span class=o>[</span>WARNING<span class=o>]</span> Some slaves are in the same host as their master
</span></span><span class=line><span class=cl>M: 99ff53a04d977692016e7df517533226ff3bd218 127.0.0.1:7000
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>0-5460<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>M: 4f9af42e6c6e2239e46cf9cd14af3e8c688638d5 127.0.0.1:7001
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>5461-10922<span class=o>]</span> <span class=o>(</span><span class=m>5462</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>M: 01279d2e588ac7b25da2df232412153b26950184 127.0.0.1:7002
</span></span><span class=line><span class=cl>   slots:<span class=o>[</span>10923-16383<span class=o>]</span> <span class=o>(</span><span class=m>5461</span> slots<span class=o>)</span> master
</span></span><span class=line><span class=cl>S: c12c3b7aed21133f078a3262ec201ec9106a6ae0 127.0.0.1:7003
</span></span><span class=line><span class=cl>   replicates 99ff53a04d977692016e7df517533226ff3bd218
</span></span><span class=line><span class=cl>S: ea108846aba5cd010feebe8482f29babcbc51ee0 127.0.0.1:7004
</span></span><span class=line><span class=cl>   replicates 4f9af42e6c6e2239e46cf9cd14af3e8c688638d5
</span></span><span class=line><span class=cl>S: 7ea79aec309af8048453c6059d3cd35da57468df 127.0.0.1:7005
</span></span><span class=line><span class=cl>   replicates 01279d2e588ac7b25da2df232412153b26950184
</span></span></code></pre></div><h3 id=驗證>驗證<a href=#%e9%a9%97%e8%ad%89 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>連至其中一台Redis後可以開始做查詢,例如下面的命令.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-db2 ~<span class=o>]</span>$ redis-cli -c -p <span class=m>7000</span> -h  192.168.20.189 -a password
</span></span><span class=line><span class=cl>192.168.20.189:7000&gt; cluster info
</span></span><span class=line><span class=cl>192.168.20.189:7000&gt; cluster nodes
</span></span></code></pre></div><p>查看log,發現有些warning,依照建議去調整主機配置.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Justin.Lee@dev-db2 redis<span class=o>]</span>$ cat redis_7000.log
</span></span><span class=line><span class=cl>2030:C <span class=m>16</span> Jan <span class=m>2020</span> 01:27:43.297 <span class=c1># Redis version=5.0.7, bits=64, commit=00000000, modified=0, pid=2030, just started</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>2031:M <span class=m>16</span> Jan <span class=m>2020</span> 01:27:43.301 <span class=c1># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span>
</span></span><span class=line><span class=cl>2031:M <span class=m>16</span> Jan <span class=m>2020</span> 01:27:43.301 <span class=c1># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &#39;vm.overcommit_memory = 1&#39; to /etc/sysctl.conf and then reboot or run the command &#39;sysctl vm.overcommit_memory=1&#39; for this to take effect.</span>
</span></span><span class=line><span class=cl>2031:M <span class=m>16</span> Jan <span class=m>2020</span> 01:27:43.301 <span class=c1># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &#39;echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled&#39; as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div></div><div class="human single"><a href=https://brainmade.org/ target=_blank rel="external noreferrer noopener"><abbr title="I don't hate AIs; but I love humans!"><svg fill="#fff" width="128" height="40" viewBox="0 0 128 40"><path d="M26.306 39.391H11.665a1.28 1.28.0 01-1.28-1.28v-3.838H6.399a1.28 1.28.0 01-1.28-1.28v-5.336l-4.41-2.198a1.28 1.28.0 01-.493-1.855l4.904-7.357v-2.175C5.12 6.298 11.422.0 19.194.0s14.073 6.3 14.075 14.071c-.316 13.912-5.38 11.758-5.59 17.023l-.093 7.018a1.3 1.3.0 01-.375.905 1.27 1.27.0 01-.905.375zm-13.361-2.559h12.082l.143-7.27c-.132-3.329 5.858-4.122 5.54-15.368-.179-6.356-5.157-11.635-11.515-11.635S7.68 7.713 7.679 14.071v2.559c-.001.253-.075.5-.215.71l-4.315 6.471 3.822 1.91a1.28 1.28.0 01.708 1.145v4.848h3.987a1.28 1.28.0 011.28 1.28z"/><path d="M20.186 29.111v-9.644c.059.0.118.009.177.009 4.885-.006 8.525-4.506 7.511-9.284a1.19 1.19.0 00-.911-.911 7.67 7.67.0 00-9.049 5.67l-.033-.036a7.66 7.66.0 00-7.03-2.085 1.19 1.19.0 00-.911.91c-1.014 4.777 2.627 9.277 7.51 9.284.118.0.246-.014.369-.02v6.106zm1.419-16.072a5.33 5.33.0 014.062-1.553 5.33 5.33.0 01-5.614 5.615 5.3 5.3.0 011.552-4.061zm-7.904 6.057a5.3 5.3.0 01-1.559-4.061 5.323 5.323.0 015.614 5.615 5.3 5.3.0 01-4.055-1.554m38.419-6.79q0 2.346-1.567 3.63-1.567 1.282-4.351 1.283h-7.669V0h7.016q2.807.0 4.242 1.1 1.446 1.087 1.446 3.226.0 1.467-.729 2.481-.718 1.002-2.197 1.357 1.86.244 2.828 1.32.979 1.063.979 2.823zm-4.112-7.491q0-1.161-.663-1.65-.652-.488-1.947-.488h-3.655v4.265h3.677q1.36.0 1.968-.525.62-.537.62-1.601m.892 7.209q0-2.42-3.089-2.42h-4.069v4.938h4.188q1.545.0 2.252-.624.718-.635.718-1.894m16.26 5.194-3.557-6.538h-3.764v6.538H54.63V0h7.658q2.741.0 4.231 1.332 1.49 1.32 1.49 3.8.0 1.808-.913 3.128-.914 1.308-2.47 1.723l4.144 7.235zm-.381-11.94q0-2.481-2.828-2.481h-4.112v5.083h4.199q1.349.0 2.045-.684.696-.685.696-1.919m16.785 11.94-1.36-4.399h-5.841l-1.359 4.399h-3.209L75.386.0h3.785l5.569 17.219zM77.278 2.651l-.066.269q-.109.44-.261 1.002c-.152.563-.725 2.436-1.871 6.184h4.405l-1.512-4.949-.468-1.662zm9.551 14.567V0h3.209v17.219zm15.53.0L95.681 3.959q.196 1.931.196 3.104v10.155h-2.849V0h3.666l6.777 13.37q-.196-1.846-.196-3.361V0h2.85v17.219zM52.63 39.375V28.331q.011-.351.115-3.015-.818 3.257-1.209 4.541l-2.925 9.518h-2.418l-2.925-9.518-1.232-4.541q.139 2.809.139 3.717v10.342h-3.017V22.313h4.548l2.902 9.543.253.92.553 2.289.725-2.736 2.983-10.015h4.526v17.063zm17.64.0-1.44-4.359h-6.184l-1.44 4.359h-3.397l5.919-17.063h4.007l5.896 17.063zm-4.537-14.434-.069.267q-.115.436-.277.993c-.162.557-.767 2.414-1.98 6.128h4.663l-1.601-4.905-.495-1.647zm24.577 5.776q0 2.64-.99 4.614-.979 1.961-2.787 3.003-1.796 1.042-4.122 1.042h-6.564V22.313h5.873q4.099.0 6.345 2.18 2.245 2.167 2.245 6.224m-3.42.0q0-2.748-1.359-4.19-1.359-1.453-3.881-1.453h-2.407v11.54h2.879q2.188.0 3.478-1.586t1.29-4.311m6 8.659V22.313h12.759v2.761h-9.362v4.287h8.66v2.761h-8.66v4.492h9.835v2.761zm15.75.0v-3.693h3.328v3.693zm12.445-12.149q2.082.0 3.662.781 1.58.78 2.422 2.235.833 1.454.833 3.393.0 2.98-1.845 4.676Q124.302 40 121.085 40q-3.208.0-5.005-1.688-1.798-1.688-1.798-4.695c0-3.007.606-3.57 1.817-4.694q1.817-1.696 4.986-1.696m0 2.702q-2.157.0-3.378.97-1.23.97-1.23 2.72.0 1.777 1.22 2.747 1.211.97 3.388.97 2.195.0 3.462-.988 1.258-.997 1.258-2.711.0-1.778-1.23-2.738-1.23-.97-3.491-.97m6.725-13.402-5.062 2.935v3.107h5.062v2.648h-13.331v-6.322q0-2.261 1.031-3.491 1.022-1.23 2.942-1.23 1.4.0 2.422.754 1.012.754 1.334 2.038l5.601-3.42zm-9.244.314q-1.92.0-1.921 2.334v3.393h3.936v-3.465q0-1.113-.53-1.688t-1.486-.575m7.249-10.915a6.5 6.5.0 00-.313-2.002q-.321-.969-.814-1.499h-1.845v3.088h-2.063V0h4.901q1.088 1.005 1.703 2.622a9.4 9.4.0 01.615 3.375q0 3.088-1.798 4.748-1.808 1.661-5.119 1.661-3.292.0-5.043-1.67-1.76-1.67-1.76-4.803.0-4.452 3.473-5.664l.776 2.442q-1.012.395-1.533 1.238-.52.844-.52 1.984.0 1.867 1.192 2.837t3.416.97q2.261.0 3.501-.997 1.23-1.005 1.23-2.818z"/></svg></abbr></a></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2026 <a href=https://chiehting.com/>Chiehting's Blog</a>
&#183; Copyright © 2025 Chiehting Lee. All rights reserved.</p></footer><script async src=https://chiehting.com/js/bundle.min.217d62397cbef6f9f5d8bab30d7e7969d78c52a436ca5d5790cef4d6fef3f1f2.js integrity="sha256-IX1iOXy+9vn12LqzDX55adeMUqQ2yl1XkM701v7z8fI=" crossorigin=anonymous></script><script async src=https://chiehting.com/js/link-share.min.24409a4f6e5537d70ffc55ec8f9192208d718678cb8638585342423020b37f39.js integrity="sha256-JECaT25VN9cP/FXsj5GSII1xhnjLhjhYU0JCMCCzfzk=" crossorigin=anonymous></script></body></html>