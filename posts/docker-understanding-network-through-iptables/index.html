<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1C48BPHVP"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1C48BPHVP")}</script><meta charset=UTF-8><meta charset=utf-8><meta name=viewport content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimal-ui"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=robots content="index, follow"><meta name=author content><meta name=description content="This website is preview about Chiehting. irregular update."><link rel=manifest href=/site.webmanifest><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><meta name=apple-mobile-web-app-title content="Chiehting's Blog"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Understanding Docker network through iptables"><meta itemprop=description content="Docker 為主流的容器化技術之一，而 Docker 則是使用 iptables 做 provide network isolation。 這篇來了解 Docker 預設的 iptables 規則是什麼。"><meta itemprop=datePublished content="2021-06-21T16:46:00+08:00"><meta itemprop=dateModified content="2021-06-21T16:46:00+08:00"><meta itemprop=wordCount content="2409"><meta itemprop=keywords content="Network,Docker"><meta property="og:url" content="https://chiehting.com/posts/docker-understanding-network-through-iptables/"><meta property="og:site_name" content="Chiehting's Blog"><meta property="og:title" content="Understanding Docker network through iptables"><meta property="og:description" content="Docker 為主流的容器化技術之一，而 Docker 則是使用 iptables 做 provide network isolation。 這篇來了解 Docker 預設的 iptables 規則是什麼。"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-21T16:46:00+08:00"><meta property="article:modified_time" content="2021-06-21T16:46:00+08:00"><meta property="article:tag" content="Network"><meta property="article:tag" content="Docker"><meta name=twitter:card content="summary"><meta name=twitter:title content="Understanding Docker network through iptables"><meta name=twitter:description content="Docker 為主流的容器化技術之一，而 Docker 則是使用 iptables 做 provide network isolation。 這篇來了解 Docker 預設的 iptables 規則是什麼。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Understanding Docker network through iptables","name":"Understanding Docker network through iptables","description":"Docker 為主流的容器化技術之一，而 Docker 則是使用 iptables 做 provide network isolation。 這篇來了解 Docker 預設的 iptables 規則是什麼。\n","keywords":["network","docker"],"articleBody":"Docker 為主流的容器化技術之一，而 Docker 則是使用 iptables 做 provide network isolation。 這篇來了解 Docker 預設的 iptables 規則是什麼。\n之前有寫過 iptables guide([[iptables-guide]])，知道 iptables 底層是使用 Netfilter 模組作封包的控制。\n官方也有相關的資料可以參考 Docker and iptables\nOn Linux, Docker manipulates iptables rules to provide network isolation. While this is an implementation detail and you should not modify the rules Docker inserts into your iptables policies, it does have some implications on what you need to do if you want to have your own policies in addition to those managed by Docker.\n思路 建立虛擬機，確認初始 network interface 與 iptables 安裝 Docker 並確認 network interface 與 iptables 建置 nginx 容器，測試封包走向 環境與版本 OS：\nroot@ip-172-31-37-164:/home/ubuntu# cat /etc/os-release NAME=\"Ubuntu\" VERSION=\"20.04.2 LTS (Focal Fossa)\" ・・・・・・ Docker：\nroot@ip-172-31-37-164:/home/ubuntu# docker version Client: Docker Engine - Community Version: 20.10.7 API version: 1.41 ・・・・・・ Server: Docker Engine - Community Engine: Version: 20.10.7 API version: 1.41 (minimum version 1.12) ・・・・・・ containerd: Version: 1.4.6 GitCommit: d71fcd7d8303cbf684402823e425e9dd2e99285d runc: Version: 1.0.0-rc95 GitCommit: b9ee9c6314599f1b4a7f497e1f1f856fe433d3b7 docker-init: Version: 0.19.0 GitCommit: de40ad0 確認初始的 iptables rules 在一個新的虛擬機中，一開始的網路介面有 lo 跟 eth0。 其中 lo 為這虛擬機的 LOOPBACK 使用; 而 eth0 則為可廣播的網路介面使用。\nroot@ip-172-31-37-164:/home/ubuntu# ip a 1: lo: mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever inet6 ::1/128 scope host valid_lft forever preferred_lft forever 2: eth0: mtu 9001 qdisc fq_codel state UP group default qlen 1000 link/ether 06:3d:47:e2:09:ba brd ff:ff:ff:ff:ff:ff inet 172.31.37.164/20 brd 172.31.47.255 scope global dynamic eth0 valid_lft 3514sec preferred_lft 3514sec inet6 fe80::43d:47ff:fee2:9ba/64 scope link valid_lft forever preferred_lft forever 新的虛擬機中，一開始是沒有配置 Chain、Table 的。\nroot@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t nat Chain PREROUTING (policy ACCEPT 6 packets, 328 bytes) num pkts bytes target prot opt in out source destination Chain INPUT (policy ACCEPT 6 packets, 328 bytes) num pkts bytes target prot opt in out source destination Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes) num pkts bytes target prot opt in out source destination Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes) num pkts bytes target prot opt in out source destination root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t filter Chain INPUT (policy ACCEPT 58 packets, 5352 bytes) num pkts bytes target prot opt in out source destination Chain FORWARD (policy ACCEPT 0 packets, 0 bytes) num pkts bytes target prot opt in out source destination Chain OUTPUT (policy ACCEPT 48 packets, 6066 bytes) num pkts bytes target prot opt in out source destination 安裝 Docker 並且確認 iptables rules 確認網路介面 Docker 安裝完成後，看到新增了一個網路介面 docker0。 其 docker0 的網路介面 ip 位置可以看到被分配到 172.17.0.1/16 的 private ip。而 router 部分則看到 172.17.0.0/16 網段都 link src 172.17.0.1。\n# ip address root@ip-172-31-37-164:/home/ubuntu# ip a ・・・・・・ 3: docker0: mtu 1500 qdisc noqueue state DOWN group default link/ether 02:42:d3:81:15:1c brd ff:ff:ff:ff:ff:ff inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0 valid_lft forever preferred_lft forever # ip route root@ip-172-31-37-164:/home/ubuntu# ip r default via 172.31.32.1 dev eth0 proto dhcp src 172.31.37.164 metric 100 172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 172.31.32.0/20 dev eth0 proto kernel scope link src 172.31.37.164 172.31.32.1 dev eth0 proto dhcp scope link src 172.31.37.164 metric 100 # ip route show table local root@ip-172-31-37-164:/home/ubuntu# ip r show table local broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1 local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1 broadcast 172.17.0.0 dev docker0 proto kernel scope link src 172.17.0.1 local 172.17.0.1 dev docker0 proto kernel scope host src 172.17.0.1 broadcast 172.17.255.255 dev docker0 proto kernel scope link src 172.17.0.1 broadcast 172.31.32.0 dev eth0 proto kernel scope link src 172.31.37.164 local 172.31.37.164 dev eth0 proto kernel scope host src 172.31.37.164 broadcast 172.31.47.255 dev eth0 proto kernel scope link src 172.31.37.164 確認 iptables 的 NAT Table 下面列出了 nat table 的 Chain。看到新增了多個 Chain DOCKER，而這 Chain 被 references 在 PREROUTING、OUTPUT 中。 而我們知道 iptables 的規則是從上至下順序執行，直至匹配的的規則為止，否則執行預設 policy。\n下面說明 nat table 的 Chain：\nPREROUTING num 1 是指如果進來的封包目的地址 match LOCAL 都跳到 Chain DOCKER，這邊要注意 LOCAL 並不是指本地，可以使用 “ip route show table local” 命令來確認哪些 ip 為 LOCAL DOCKER num 1 指如果封包是從 docker0 網路介面進來的，則結束 Chain DOCKER 然後返回原來的 Chain 繼續跑規則 OUTPUT num 1 是指如果出去封包目的地址 match LOCAL 都跳到 Chain DOCKER，除了 127.0.0.0/8 網段 DOCKER num 1 指如果封包是從 docker0 網路介面進來的，則結束 Chain DOCKER 然後返回原來的 Chain 繼續跑規則 POSTROUTING num 1 是指如果出去封包不是 docker0 網路介面和 ip 來源是 172.17.0.0/16 時，不做修改 root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t nat Chain PREROUTING (policy ACCEPT 6 packets, 328 bytes) num pkts bytes target prot opt in out source destination 1 14138 743K DOCKER all -- * * 0.0.0.0/0 0.0.0.0/0 ADDRTYPE match dst-type LOCAL Chain INPUT (policy ACCEPT 6 packets, 328 bytes) num pkts bytes target prot opt in out source destination Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes) num pkts bytes target prot opt in out source destination 1 4 240 DOCKER all -- * * 0.0.0.0/0 !127.0.0.0/8 ADDRTYPE match dst-type LOCAL Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes) num pkts bytes target prot opt in out source destination 1 34 2073 MASQUERADE all -- * !docker0 172.17.0.0/16 0.0.0.0/0 Chain DOCKER (2 references) num pkts bytes target prot opt in out source destination 1 19 1140 RETURN all -- docker0 * 0.0.0.0/0 0.0.0.0/0 確認 iptables 的 Filter Table 可以看到新增了多個 Chain DOCKER、DOCKER-ISOLATION-STAGE-1、DOCKER-ISOLATION-STAGE-2、DOCKER-USER，而這些 Chain 都被 references 在 FORWARD 中。 可以看到 Chain FORWARD 的預設 policy 已經被改為 DROP，而我們知道 iptables 的規則是從上至下順序執行，直至匹配的的規則為止，否則執行預設 policy。\n看到 FORWARD 的規則：\nFORWARD num 1 規則是跳到 DOCKER-USER 鏈中 DOCKER-USER num 1 規則是 RETURN 封包，回 FORWARD 中繼續直執行其他的規則 FORWARD num 2 規則是跳到 DOCKER-ISOLATION-STAGE-1 鏈中 DOCKER-ISOLATION-STAGE-1 num 1 封包又跳到 DOCKER-ISOLATION-STAGE-2 鏈中 DOCKER-ISOLATION-STAGE-2 num 1 丟棄所有 docker0 網路介面出去的封包 DOCKER-ISOLATION-STAGE-2 num 2 RETURN 所有封包繼續執封包繼續執行 DOCKER-ISOLATION-STAGE-1 的其他規則 DOCKER-ISOLATION-STAGE-1 num 2 RETURN 所有封包繼續執封包繼續執行 FORWARD 的其他規則 FORWARD num 3 規則為允許由 docker0 網路介面出去的封包，但封包狀態是 RELATED,ESTABLISHED FORWARD num 4 規則為當封包是 docker0 網路介面出去的，則跳到 DOCKER 鏈中 DOCKER 暫無規則 FORWARD num 5、FORWARD num 6 為允許經由 docker0 網路介面近來的所有封包進出 不在上述規則中的封包全部都 drop root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t fillter Chain INPUT (policy ACCEPT 385 packets, 28200 bytes) num pkts bytes target prot opt in out source destination Chain FORWARD (policy DROP 0 packets, 0 bytes) num pkts bytes target prot opt in out source destination 1 0 0 DOCKER-USER all -- * * 0.0.0.0/0 0.0.0.0/0 2 0 0 DOCKER-ISOLATION-STAGE-1 all -- * * 0.0.0.0/0 0.0.0.0/0 3 0 0 ACCEPT all -- * docker0 0.0.0.0/0 0.0.0.0/0 ctstate RELATED,ESTABLISHED 4 0 0 DOCKER all -- * docker0 0.0.0.0/0 0.0.0.0/0 5 0 0 ACCEPT all -- docker0 !docker0 0.0.0.0/0 0.0.0.0/0 6 0 0 ACCEPT all -- docker0 docker0 0.0.0.0/0 0.0.0.0/0 Chain OUTPUT (policy ACCEPT 304 packets, 59638 bytes) num pkts bytes target prot opt in out source destination Chain DOCKER (1 references) num pkts bytes target prot opt in out source destination Chain DOCKER-ISOLATION-STAGE-1 (1 references) num pkts bytes target prot opt in out source destination 1 0 0 DOCKER-ISOLATION-STAGE-2 all -- docker0 !docker0 0.0.0.0/0 0.0.0.0/0 2 0 0 RETURN all -- * * 0.0.0.0/0 0.0.0.0/0 Chain DOCKER-ISOLATION-STAGE-2 (1 references) num pkts bytes target prot opt in out source destination 1 0 0 DROP all -- * docker0 0.0.0.0/0 0.0.0.0/0 2 0 0 RETURN all -- * * 0.0.0.0/0 0.0.0.0/0 Chain DOCKER-USER (1 references) num pkts bytes target prot opt in out source destination 1 0 0 RETURN all -- * * 0.0.0.0/0 0.0.0.0/0 建置 nginx 容器，測試封包走向 啟動 container nginx\ndocker run --name nginx -p 80:80 -d nginx 查看本機 listen port 看到 port 80 被 docker-proxy 監聽著\nroot@ip-172-31-37-164:/home/ubuntu# netstat -tlnp Active Internet connections (only servers) Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN 253681/docker-proxy tcp 0 0 127.0.0.53:53 0.0.0.0:* LISTEN 370/systemd-resolve tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN 576/sshd: /usr/sbin tcp6 0 0 :::80 :::* LISTEN 253686/docker-proxy tcp6 0 0 :::22 :::* LISTEN 576/sshd: /usr/sbin 確認網路變化 網路介面新增了 veth3ce1bed\nroot@ip-172-31-37-164:~# ip link 1: lo: mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 2: eth0: mtu 9001 qdisc fq_codel state UP mode DEFAULT group default qlen 1000 link/ether 06:3d:47:e2:09:ba brd ff:ff:ff:ff:ff:ff 18: docker0: mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 02:42:55:24:1f:ed brd ff:ff:ff:ff:ff:ff 22: veth3ce1bed@if21: mtu 1500 qdisc noqueue master docker0 state UP mode DEFAULT group default link/ether ea:ba:b9:7b:48:ea brd ff:ff:ff:ff:ff:ff link-netnsid 1 還有將新增的網路介面 veth3ce1bed 橋接在 docker0 上。\nroot@ip-172-31-37-164:~# brctl show bridge name bridge id STP enabled interfaces docker0 8000.024255241fed no veth3ce1bed iptables NAT table 新增了兩條規則。\nPOSTROUTING 封包來源為封包目的為 172.17.0.2 地址為裝封包內容 tcp dpt:80 DOCKER num 2 規則為所有非 docker0 網路介面近來且 tcp dpt:80 的封包，改到 172.17.0.2:80 iptables -L -n -v --line-numbers -t nat Chain POSTROUTING (policy ACCEPT 266 packets, 17090 bytes) num pkts bytes target prot opt in out source destination 2 0 0 MASQUERADE tcp -- * * 172.17.0.2 172.17.0.2 tcp dpt:80 Chain DOCKER (2 references) num pkts bytes target prot opt in out source destination 2 136 7472 DNAT tcp -- !docker0 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:80 to:172.17.0.2:80 root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t filter Chain DOCKER (1 references) num pkts bytes target prot opt in out source destination 1 123 6692 ACCEPT tcp -- !docker0 docker0 0.0.0.0/0 172.17.0.2 tcp dpt:80 測試封包走向 在不同 client 端嘗試連上 nginx 服務，觀察封包所經過的網路規則。\n監控 iptalbes 的 pkts 變化。\nroot@ip-172-31-37-164:/home/ubuntu# watch iptables -L -n -v --line-numbers -t nat root@ip-172-31-37-164:/home/ubuntu# watch iptables -L -n -v --line-numbers -t filter 監控 docker0 網路介面的封包裝況。\ntcpdump -i docker0 -q -v tcp port 80 ","wordCount":"2409","inLanguage":"en","datePublished":"2021-06-21T16:46:00+08:00","dateModified":"2021-06-21T16:46:00+08:00","author":{"@type":"Person","name":null},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chiehting.com/posts/docker-understanding-network-through-iptables/"},"publisher":{"@type":"Organization","name":"Chiehting's Blog","description":"This website is preview about Chiehting. irregular update.","logo":{"@type":"ImageObject","url":"https://chiehting.com/favicon.ico"}}}</script><title>Understanding Docker network through iptables</title><link rel="stylesheet dns-prefetch preconnect preload prefetch" as=style media=screen href=https://chiehting.com/css/style.min.4a728eca217aff37d24d94ea492de99e69fea0a53bb05c836db76b9d0504ef60.css integrity="sha256-SnKOyiF6/zfSTZTqSS3pnmn+oKU7sFyDbbdrnQUE72A=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://chiehting.com/>Chiehting's Blog</a></div><nav class="site-nav hide-in-mobile"><a href=https://chiehting.com/posts/>Posts</a><a href=https://chiehting.com/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-links hide-in-mobile"><a href=ting911111@gmail.com target=_blank rel="noopener me" title=Email><svg class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a><a href=https://github.com/chiehting target=_blank rel="noopener me" title=Github><svg class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://chiehting.com/posts/>Posts</a></li><li><a href=https://chiehting.com/about/>About</a></li></ul></div><main class="site-main section-inner thin animated fadeIn faster"><h1>Understanding Docker network through iptables</h1><div class=content><p>Docker 為主流的容器化技術之一，而 Docker 則是使用 iptables 做 provide network isolation。
這篇來了解 Docker 預設的 iptables 規則是什麼。</p><p>之前有寫過 iptables guide([[iptables-guide]])，知道 iptables 底層是使用 Netfilter 模組作封包的控制。</p><p>官方也有相關的資料可以參考 <a href=https://docs.docker.com/network/iptables/>Docker and iptables</a></p><blockquote><p>On Linux, Docker manipulates <code>iptables</code> rules to provide network isolation. While this is an implementation detail and you should not modify the rules Docker inserts into your <code>iptables</code> policies, it does have some implications on what you need to do if you want to have your own policies in addition to those managed by Docker.</p></blockquote><h3 id=思路>思路<a href=#%e6%80%9d%e8%b7%af class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><ol><li>建立虛擬機，確認初始 network interface 與 iptables</li><li>安裝 Docker 並確認 network interface 與 iptables</li><li>建置 nginx 容器，測試封包走向</li></ol><h3 id=環境與版本>環境與版本<a href=#%e7%92%b0%e5%a2%83%e8%88%87%e7%89%88%e6%9c%ac class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>OS：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# cat /etc/os-release
</span></span><span class=line><span class=cl><span class=nv>NAME</span><span class=o>=</span><span class=s2>&#34;Ubuntu&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>VERSION</span><span class=o>=</span><span class=s2>&#34;20.04.2 LTS (Focal Fossa)&#34;</span>
</span></span><span class=line><span class=cl>・・・・・・
</span></span></code></pre></div><p>Docker：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# docker version
</span></span><span class=line><span class=cl>Client: Docker Engine - Community
</span></span><span class=line><span class=cl> Version:           20.10.7
</span></span><span class=line><span class=cl> API version:       1.41
</span></span><span class=line><span class=cl>・・・・・・
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Server: Docker Engine - Community
</span></span><span class=line><span class=cl> Engine:
</span></span><span class=line><span class=cl>  Version:          20.10.7
</span></span><span class=line><span class=cl>  API version:      1.41 <span class=o>(</span>minimum version 1.12<span class=o>)</span>
</span></span><span class=line><span class=cl>・・・・・・
</span></span><span class=line><span class=cl> containerd:
</span></span><span class=line><span class=cl>  Version:          1.4.6
</span></span><span class=line><span class=cl>  GitCommit:        d71fcd7d8303cbf684402823e425e9dd2e99285d
</span></span><span class=line><span class=cl> runc:
</span></span><span class=line><span class=cl>  Version:          1.0.0-rc95
</span></span><span class=line><span class=cl>  GitCommit:        b9ee9c6314599f1b4a7f497e1f1f856fe433d3b7
</span></span><span class=line><span class=cl> docker-init:
</span></span><span class=line><span class=cl>  Version:          0.19.0
</span></span><span class=line><span class=cl>  GitCommit:        de40ad0
</span></span></code></pre></div><h3 id=確認初始的-iptables-rules>確認初始的 iptables rules<a href=#%e7%a2%ba%e8%aa%8d%e5%88%9d%e5%a7%8b%e7%9a%84-iptables-rules class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>在一個新的虛擬機中，一開始的網路介面有 lo 跟 eth0。
其中 lo 為這虛擬機的 LOOPBACK 使用; 而 eth0 則為可廣播的網路介面使用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# ip a
</span></span><span class=line><span class=cl>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class=m>65536</span> qdisc noqueue state UNKNOWN group default qlen <span class=m>1000</span>
</span></span><span class=line><span class=cl>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class=line><span class=cl>    inet 127.0.0.1/8 scope host lo
</span></span><span class=line><span class=cl>       valid_lft forever preferred_lft forever
</span></span><span class=line><span class=cl>    inet6 ::1/128 scope host
</span></span><span class=line><span class=cl>       valid_lft forever preferred_lft forever
</span></span><span class=line><span class=cl>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class=m>9001</span> qdisc fq_codel state UP group default qlen <span class=m>1000</span>
</span></span><span class=line><span class=cl>    link/ether 06:3d:47:e2:09:ba brd ff:ff:ff:ff:ff:ff
</span></span><span class=line><span class=cl>    inet 172.31.37.164/20 brd 172.31.47.255 scope global dynamic eth0
</span></span><span class=line><span class=cl>       valid_lft 3514sec preferred_lft 3514sec
</span></span><span class=line><span class=cl>    inet6 fe80::43d:47ff:fee2:9ba/64 scope link
</span></span><span class=line><span class=cl>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><p>新的虛擬機中，一開始是沒有配置 Chain、Table 的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t nat
</span></span><span class=line><span class=cl>Chain PREROUTING <span class=o>(</span>policy ACCEPT <span class=m>6</span> packets, <span class=m>328</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain INPUT <span class=o>(</span>policy ACCEPT <span class=m>6</span> packets, <span class=m>328</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT <span class=m>0</span> packets, <span class=m>0</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain POSTROUTING <span class=o>(</span>policy ACCEPT <span class=m>0</span> packets, <span class=m>0</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t filter
</span></span><span class=line><span class=cl>Chain INPUT <span class=o>(</span>policy ACCEPT <span class=m>58</span> packets, <span class=m>5352</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain FORWARD <span class=o>(</span>policy ACCEPT <span class=m>0</span> packets, <span class=m>0</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT <span class=m>48</span> packets, <span class=m>6066</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span></code></pre></div><h3 id=安裝-docker-並且確認-iptables-rules>安裝 Docker 並且確認 iptables rules<a href=#%e5%ae%89%e8%a3%9d-docker-%e4%b8%a6%e4%b8%94%e7%a2%ba%e8%aa%8d-iptables-rules class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><h4 id=確認網路介面>確認網路介面<a href=#%e7%a2%ba%e8%aa%8d%e7%b6%b2%e8%b7%af%e4%bb%8b%e9%9d%a2 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>Docker 安裝完成後，看到新增了一個網路介面 docker0。
其 docker0 的網路介面 ip 位置可以看到被分配到 172.17.0.1/16 的 private ip。而 router 部分則看到 172.17.0.0/16 網段都 link src 172.17.0.1。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ip address</span>
</span></span><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# ip a
</span></span><span class=line><span class=cl>・・・・・・
</span></span><span class=line><span class=cl>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class=m>1500</span> qdisc noqueue state DOWN group default
</span></span><span class=line><span class=cl>    link/ether 02:42:d3:81:15:1c brd ff:ff:ff:ff:ff:ff
</span></span><span class=line><span class=cl>    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
</span></span><span class=line><span class=cl>       valid_lft forever preferred_lft forever
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ip route</span>
</span></span><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# ip r
</span></span><span class=line><span class=cl>default via 172.31.32.1 dev eth0 proto dhcp src 172.31.37.164 metric <span class=m>100</span>
</span></span><span class=line><span class=cl>172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1
</span></span><span class=line><span class=cl>172.31.32.0/20 dev eth0 proto kernel scope link src 172.31.37.164
</span></span><span class=line><span class=cl>172.31.32.1 dev eth0 proto dhcp scope link src 172.31.37.164 metric <span class=m>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ip route show table local</span>
</span></span><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# ip r show table <span class=nb>local</span>
</span></span><span class=line><span class=cl>broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1
</span></span><span class=line><span class=cl><span class=nb>local</span> 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1
</span></span><span class=line><span class=cl><span class=nb>local</span> 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1
</span></span><span class=line><span class=cl>broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1
</span></span><span class=line><span class=cl>broadcast 172.17.0.0 dev docker0 proto kernel scope link src 172.17.0.1
</span></span><span class=line><span class=cl><span class=nb>local</span> 172.17.0.1 dev docker0 proto kernel scope host src 172.17.0.1
</span></span><span class=line><span class=cl>broadcast 172.17.255.255 dev docker0 proto kernel scope link src 172.17.0.1
</span></span><span class=line><span class=cl>broadcast 172.31.32.0 dev eth0 proto kernel scope link src 172.31.37.164
</span></span><span class=line><span class=cl><span class=nb>local</span> 172.31.37.164 dev eth0 proto kernel scope host src 172.31.37.164
</span></span><span class=line><span class=cl>broadcast 172.31.47.255 dev eth0 proto kernel scope link src 172.31.37.164
</span></span></code></pre></div><h4 id=確認-iptables-的-nat-table>確認 iptables 的 NAT Table<a href=#%e7%a2%ba%e8%aa%8d-iptables-%e7%9a%84-nat-table class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>下面列出了 nat table 的 Chain。看到新增了多個 Chain <code>DOCKER</code>，而這 Chain 被 references 在 PREROUTING、OUTPUT 中。
而我們知道 iptables 的規則是從上至下順序執行，直至匹配的的規則為止，否則執行預設 policy。</p><p>下面說明 nat table 的 Chain：</p><ol><li><code>PREROUTING num 1</code> 是指如果進來的封包目的地址 match LOCAL 都跳到 Chain DOCKER，這邊要注意 LOCAL 並不是指本地，可以使用 &ldquo;ip route show table local&rdquo; 命令來確認哪些 ip 為 LOCAL<ol><li><code>DOCKER num 1</code> 指如果封包是從 docker0 網路介面進來的，則結束 Chain DOCKER 然後返回原來的 Chain 繼續跑規則</li></ol></li><li><code>OUTPUT num 1</code> 是指如果出去封包目的地址 match LOCAL 都跳到 Chain DOCKER，除了 127.0.0.0/8 網段<ol><li><code>DOCKER num 1</code> 指如果封包是從 docker0 網路介面進來的，則結束 Chain DOCKER 然後返回原來的 Chain 繼續跑規則</li></ol></li><li><code>POSTROUTING num 1</code> 是指如果出去封包不是 docker0 網路介面和 ip 來源是 172.17.0.0/16 時，不做修改</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t nat
</span></span><span class=line><span class=cl>Chain PREROUTING <span class=o>(</span>policy ACCEPT <span class=m>6</span> packets, <span class=m>328</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl><span class=m>1</span>    <span class=m>14138</span>  743K DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain INPUT <span class=o>(</span>policy ACCEPT <span class=m>6</span> packets, <span class=m>328</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT <span class=m>0</span> packets, <span class=m>0</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl><span class=m>1</span>        <span class=m>4</span>   <span class=m>240</span> DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain POSTROUTING <span class=o>(</span>policy ACCEPT <span class=m>0</span> packets, <span class=m>0</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl><span class=m>1</span>       <span class=m>34</span>  <span class=m>2073</span> MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain DOCKER <span class=o>(</span><span class=m>2</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl><span class=m>1</span>       <span class=m>19</span>  <span class=m>1140</span> RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0
</span></span></code></pre></div><h4 id=確認-iptables-的-filter-table>確認 iptables 的 Filter Table<a href=#%e7%a2%ba%e8%aa%8d-iptables-%e7%9a%84-filter-table class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>可以看到新增了多個 Chain <code>DOCKER</code>、<code>DOCKER-ISOLATION-STAGE-1</code>、<code>DOCKER-ISOLATION-STAGE-2</code>、<code>DOCKER-USER</code>，而這些 Chain 都被 references 在 FORWARD 中。
可以看到 Chain FORWARD 的預設 policy 已經被改為 DROP，而我們知道 iptables 的規則是從上至下順序執行，直至匹配的的規則為止，否則執行預設 policy。</p><p>看到 FORWARD 的規則：</p><ol><li><code>FORWARD num 1</code> 規則是跳到 <code>DOCKER-USER</code> 鏈中<ol><li><code>DOCKER-USER num 1</code> 規則是 RETURN 封包，回 <code>FORWARD</code> 中繼續直執行其他的規則</li></ol></li><li><code>FORWARD num 2</code> 規則是跳到 <code>DOCKER-ISOLATION-STAGE-1</code> 鏈中<ol><li><code>DOCKER-ISOLATION-STAGE-1 num 1</code> 封包又跳到 <code>DOCKER-ISOLATION-STAGE-2</code> 鏈中<ol><li><code>DOCKER-ISOLATION-STAGE-2 num 1</code> 丟棄所有 docker0 網路介面出去的封包</li><li><code>DOCKER-ISOLATION-STAGE-2 num 2</code> RETURN 所有封包繼續執封包繼續執行 <code>DOCKER-ISOLATION-STAGE-1</code> 的其他規則</li></ol></li><li><code>DOCKER-ISOLATION-STAGE-1 num 2</code> RETURN 所有封包繼續執封包繼續執行 <code>FORWARD</code> 的其他規則</li></ol></li><li><code>FORWARD num 3</code> 規則為允許由 docker0 網路介面出去的封包，但封包狀態是 RELATED,ESTABLISHED</li><li><code>FORWARD num 4</code> 規則為當封包是 docker0 網路介面出去的，則跳到 <code>DOCKER</code> 鏈中<ol><li><code>DOCKER</code> 暫無規則</li></ol></li><li><code>FORWARD num 5</code>、<code>FORWARD num 6</code> 為允許經由 docker0 網路介面近來的所有封包進出</li><li>不在上述規則中的封包全部都 drop</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t fillter
</span></span><span class=line><span class=cl>Chain INPUT <span class=o>(</span>policy ACCEPT <span class=m>385</span> packets, <span class=m>28200</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain FORWARD <span class=o>(</span>policy DROP <span class=m>0</span> packets, <span class=m>0</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl><span class=m>1</span>        <span class=m>0</span>     <span class=m>0</span> DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span class=line><span class=cl><span class=m>2</span>        <span class=m>0</span>     <span class=m>0</span> DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span class=line><span class=cl><span class=m>3</span>        <span class=m>0</span>     <span class=m>0</span> ACCEPT     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED
</span></span><span class=line><span class=cl><span class=m>4</span>        <span class=m>0</span>     <span class=m>0</span> DOCKER     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0
</span></span><span class=line><span class=cl><span class=m>5</span>        <span class=m>0</span>     <span class=m>0</span> ACCEPT     all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0
</span></span><span class=line><span class=cl><span class=m>6</span>        <span class=m>0</span>     <span class=m>0</span> ACCEPT     all  --  docker0 docker0  0.0.0.0/0            0.0.0.0/0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT <span class=m>304</span> packets, <span class=m>59638</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain DOCKER <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain DOCKER-ISOLATION-STAGE-1 <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl><span class=m>1</span>        <span class=m>0</span>     <span class=m>0</span> DOCKER-ISOLATION-STAGE-2  all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0
</span></span><span class=line><span class=cl><span class=m>2</span>        <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain DOCKER-ISOLATION-STAGE-2 <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl><span class=m>1</span>        <span class=m>0</span>     <span class=m>0</span> DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0
</span></span><span class=line><span class=cl><span class=m>2</span>        <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain DOCKER-USER <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl><span class=m>1</span>        <span class=m>0</span>     <span class=m>0</span> RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0
</span></span></code></pre></div><h3 id=建置-nginx-容器測試封包走向>建置 nginx 容器，測試封包走向<a href=#%e5%bb%ba%e7%bd%ae-nginx-%e5%ae%b9%e5%99%a8%e6%b8%ac%e8%a9%a6%e5%b0%81%e5%8c%85%e8%b5%b0%e5%90%91 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>啟動 container nginx</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker run --name nginx -p 80:80  -d nginx
</span></span></code></pre></div><h4 id=查看本機-listen-port>查看本機 listen port<a href=#%e6%9f%a5%e7%9c%8b%e6%9c%ac%e6%a9%9f-listen-port class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>看到 port 80 被 docker-proxy 監聽著</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# netstat -tlnp
</span></span><span class=line><span class=cl>Active Internet connections <span class=o>(</span>only servers<span class=o>)</span>
</span></span><span class=line><span class=cl>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span></span><span class=line><span class=cl>tcp        <span class=m>0</span>      <span class=m>0</span> 0.0.0.0:80              0.0.0.0:*               LISTEN      253681/docker-proxy
</span></span><span class=line><span class=cl>tcp        <span class=m>0</span>      <span class=m>0</span> 127.0.0.53:53           0.0.0.0:*               LISTEN      370/systemd-resolve
</span></span><span class=line><span class=cl>tcp        <span class=m>0</span>      <span class=m>0</span> 0.0.0.0:22              0.0.0.0:*               LISTEN      576/sshd: /usr/sbin
</span></span><span class=line><span class=cl>tcp6       <span class=m>0</span>      <span class=m>0</span> :::80                   :::*                    LISTEN      253686/docker-proxy
</span></span><span class=line><span class=cl>tcp6       <span class=m>0</span>      <span class=m>0</span> :::22                   :::*                    LISTEN      576/sshd: /usr/sbin
</span></span></code></pre></div><h4 id=確認網路變化>確認網路變化<a href=#%e7%a2%ba%e8%aa%8d%e7%b6%b2%e8%b7%af%e8%ae%8a%e5%8c%96 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>網路介面新增了 <code>veth3ce1bed</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:~# ip link
</span></span><span class=line><span class=cl>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class=m>65536</span> qdisc noqueue state UNKNOWN mode DEFAULT group default qlen <span class=m>1000</span>
</span></span><span class=line><span class=cl>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span class=line><span class=cl>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class=m>9001</span> qdisc fq_codel state UP mode DEFAULT group default qlen <span class=m>1000</span>
</span></span><span class=line><span class=cl>    link/ether 06:3d:47:e2:09:ba brd ff:ff:ff:ff:ff:ff
</span></span><span class=line><span class=cl>18: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class=m>1500</span> qdisc noqueue state UP mode DEFAULT group default
</span></span><span class=line><span class=cl>    link/ether 02:42:55:24:1f:ed brd ff:ff:ff:ff:ff:ff
</span></span><span class=line><span class=cl>22: veth3ce1bed@if21: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class=m>1500</span> qdisc noqueue master docker0 state UP mode DEFAULT group default
</span></span><span class=line><span class=cl>    link/ether ea:ba:b9:7b:48:ea brd ff:ff:ff:ff:ff:ff link-netnsid <span class=m>1</span>
</span></span></code></pre></div><p>還有將新增的網路介面 <code>veth3ce1bed</code> 橋接在 <code>docker0</code> 上。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:~# brctl show
</span></span><span class=line><span class=cl>bridge name     bridge id               STP enabled     interfaces
</span></span><span class=line><span class=cl>docker0         8000.024255241fed       no              veth3ce1bed
</span></span></code></pre></div><p>iptables NAT table 新增了兩條規則。</p><ol><li><code>POSTROUTING</code> 封包來源為封包目的為 172.17.0.2 地址為裝封包內容 tcp dpt:80</li><li><code>DOCKER num 2</code> 規則為所有非 docker0 網路介面近來且 tcp dpt:80 的封包，改到 172.17.0.2:80</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>iptables -L -n -v --line-numbers -t nat
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain POSTROUTING <span class=o>(</span>policy ACCEPT <span class=m>266</span> packets, <span class=m>17090</span> bytes<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl><span class=m>2</span>        <span class=m>0</span>     <span class=m>0</span> MASQUERADE  tcp  --  *      *       172.17.0.2           172.17.0.2           tcp dpt:80
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain DOCKER <span class=o>(</span><span class=m>2</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl><span class=m>2</span>      <span class=m>136</span>  <span class=m>7472</span> DNAT       tcp  --  !docker0 *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80 to:172.17.0.2:80
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t filter
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain DOCKER <span class=o>(</span><span class=m>1</span> references<span class=o>)</span>
</span></span><span class=line><span class=cl>num   pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl><span class=m>1</span>      <span class=m>123</span>  <span class=m>6692</span> ACCEPT     tcp  --  !docker0 docker0  0.0.0.0/0            172.17.0.2           tcp dpt:80
</span></span></code></pre></div><h4 id=測試封包走向>測試封包走向<a href=#%e6%b8%ac%e8%a9%a6%e5%b0%81%e5%8c%85%e8%b5%b0%e5%90%91 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>在不同 client 端嘗試連上 nginx 服務，觀察封包所經過的網路規則。</p><p>監控 iptalbes 的 pkts 變化。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# watch iptables -L -n -v --line-numbers -t nat
</span></span><span class=line><span class=cl>root@ip-172-31-37-164:/home/ubuntu# watch iptables -L -n -v --line-numbers -t filter
</span></span></code></pre></div><p>監控 docker0 網路介面的封包裝況。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i docker0 -q -v tcp port <span class=m>80</span>
</span></span></code></pre></div></div><div class="human single"><a href=https://brainmade.org/ target=_blank rel="external noreferrer noopener"><abbr title="I don't hate AIs; but I love humans!"><svg fill="#fff" width="128" height="40" viewBox="0 0 128 40"><path d="M26.306 39.391H11.665a1.28 1.28.0 01-1.28-1.28v-3.838H6.399a1.28 1.28.0 01-1.28-1.28v-5.336l-4.41-2.198a1.28 1.28.0 01-.493-1.855l4.904-7.357v-2.175C5.12 6.298 11.422.0 19.194.0s14.073 6.3 14.075 14.071c-.316 13.912-5.38 11.758-5.59 17.023l-.093 7.018a1.3 1.3.0 01-.375.905 1.27 1.27.0 01-.905.375zm-13.361-2.559h12.082l.143-7.27c-.132-3.329 5.858-4.122 5.54-15.368-.179-6.356-5.157-11.635-11.515-11.635S7.68 7.713 7.679 14.071v2.559c-.001.253-.075.5-.215.71l-4.315 6.471 3.822 1.91a1.28 1.28.0 01.708 1.145v4.848h3.987a1.28 1.28.0 011.28 1.28z"/><path d="M20.186 29.111v-9.644c.059.0.118.009.177.009 4.885-.006 8.525-4.506 7.511-9.284a1.19 1.19.0 00-.911-.911 7.67 7.67.0 00-9.049 5.67l-.033-.036a7.66 7.66.0 00-7.03-2.085 1.19 1.19.0 00-.911.91c-1.014 4.777 2.627 9.277 7.51 9.284.118.0.246-.014.369-.02v6.106zm1.419-16.072a5.33 5.33.0 014.062-1.553 5.33 5.33.0 01-5.614 5.615 5.3 5.3.0 011.552-4.061zm-7.904 6.057a5.3 5.3.0 01-1.559-4.061 5.323 5.323.0 015.614 5.615 5.3 5.3.0 01-4.055-1.554m38.419-6.79q0 2.346-1.567 3.63-1.567 1.282-4.351 1.283h-7.669V0h7.016q2.807.0 4.242 1.1 1.446 1.087 1.446 3.226.0 1.467-.729 2.481-.718 1.002-2.197 1.357 1.86.244 2.828 1.32.979 1.063.979 2.823zm-4.112-7.491q0-1.161-.663-1.65-.652-.488-1.947-.488h-3.655v4.265h3.677q1.36.0 1.968-.525.62-.537.62-1.601m.892 7.209q0-2.42-3.089-2.42h-4.069v4.938h4.188q1.545.0 2.252-.624.718-.635.718-1.894m16.26 5.194-3.557-6.538h-3.764v6.538H54.63V0h7.658q2.741.0 4.231 1.332 1.49 1.32 1.49 3.8.0 1.808-.913 3.128-.914 1.308-2.47 1.723l4.144 7.235zm-.381-11.94q0-2.481-2.828-2.481h-4.112v5.083h4.199q1.349.0 2.045-.684.696-.685.696-1.919m16.785 11.94-1.36-4.399h-5.841l-1.359 4.399h-3.209L75.386.0h3.785l5.569 17.219zM77.278 2.651l-.066.269q-.109.44-.261 1.002c-.152.563-.725 2.436-1.871 6.184h4.405l-1.512-4.949-.468-1.662zm9.551 14.567V0h3.209v17.219zm15.53.0L95.681 3.959q.196 1.931.196 3.104v10.155h-2.849V0h3.666l6.777 13.37q-.196-1.846-.196-3.361V0h2.85v17.219zM52.63 39.375V28.331q.011-.351.115-3.015-.818 3.257-1.209 4.541l-2.925 9.518h-2.418l-2.925-9.518-1.232-4.541q.139 2.809.139 3.717v10.342h-3.017V22.313h4.548l2.902 9.543.253.92.553 2.289.725-2.736 2.983-10.015h4.526v17.063zm17.64.0-1.44-4.359h-6.184l-1.44 4.359h-3.397l5.919-17.063h4.007l5.896 17.063zm-4.537-14.434-.069.267q-.115.436-.277.993c-.162.557-.767 2.414-1.98 6.128h4.663l-1.601-4.905-.495-1.647zm24.577 5.776q0 2.64-.99 4.614-.979 1.961-2.787 3.003-1.796 1.042-4.122 1.042h-6.564V22.313h5.873q4.099.0 6.345 2.18 2.245 2.167 2.245 6.224m-3.42.0q0-2.748-1.359-4.19-1.359-1.453-3.881-1.453h-2.407v11.54h2.879q2.188.0 3.478-1.586t1.29-4.311m6 8.659V22.313h12.759v2.761h-9.362v4.287h8.66v2.761h-8.66v4.492h9.835v2.761zm15.75.0v-3.693h3.328v3.693zm12.445-12.149q2.082.0 3.662.781 1.58.78 2.422 2.235.833 1.454.833 3.393.0 2.98-1.845 4.676Q124.302 40 121.085 40q-3.208.0-5.005-1.688-1.798-1.688-1.798-4.695c0-3.007.606-3.57 1.817-4.694q1.817-1.696 4.986-1.696m0 2.702q-2.157.0-3.378.97-1.23.97-1.23 2.72.0 1.777 1.22 2.747 1.211.97 3.388.97 2.195.0 3.462-.988 1.258-.997 1.258-2.711.0-1.778-1.23-2.738-1.23-.97-3.491-.97m6.725-13.402-5.062 2.935v3.107h5.062v2.648h-13.331v-6.322q0-2.261 1.031-3.491 1.022-1.23 2.942-1.23 1.4.0 2.422.754 1.012.754 1.334 2.038l5.601-3.42zm-9.244.314q-1.92.0-1.921 2.334v3.393h3.936v-3.465q0-1.113-.53-1.688t-1.486-.575m7.249-10.915a6.5 6.5.0 00-.313-2.002q-.321-.969-.814-1.499h-1.845v3.088h-2.063V0h4.901q1.088 1.005 1.703 2.622a9.4 9.4.0 01.615 3.375q0 3.088-1.798 4.748-1.808 1.661-5.119 1.661-3.292.0-5.043-1.67-1.76-1.67-1.76-4.803.0-4.452 3.473-5.664l.776 2.442q-1.012.395-1.533 1.238-.52.844-.52 1.984.0 1.867 1.192 2.837t3.416.97q2.261.0 3.501-.997 1.23-1.005 1.23-2.818z"/></svg></abbr></a></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2026 <a href=https://chiehting.com/>Chiehting's Blog</a>
&#183; Copyright © 2025 Chiehting Lee. All rights reserved.</p></footer><script async src=https://chiehting.com/js/bundle.min.217d62397cbef6f9f5d8bab30d7e7969d78c52a436ca5d5790cef4d6fef3f1f2.js integrity="sha256-IX1iOXy+9vn12LqzDX55adeMUqQ2yl1XkM701v7z8fI=" crossorigin=anonymous></script><script async src=https://chiehting.com/js/link-share.min.24409a4f6e5537d70ffc55ec8f9192208d718678cb8638585342423020b37f39.js integrity="sha256-JECaT25VN9cP/FXsj5GSII1xhnjLhjhYU0JCMCCzfzk=" crossorigin=anonymous></script></body></html>