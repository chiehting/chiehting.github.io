<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-G1C48BPHVP"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G1C48BPHVP")}</script><meta charset=UTF-8><meta charset=utf-8><meta name=viewport content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimal-ui"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=robots content="index, follow"><meta name=author content><meta name=description content="This website is preview about Chiehting. irregular update."><link rel=manifest href=/site.webmanifest><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><meta name=apple-mobile-web-app-title content="Chiehting's Blog"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Iptables guide"><meta itemprop=description content="iptables 被許多服務廣泛的運用著, 例如 Docker, Kubernetes 都是基於 iptables 來管理網路封包的處理, 所以此篇來研究 iptables 工具, 看看這些服務底層究竟在做些什麼事."><meta itemprop=datePublished content="2021-05-04T10:30:00+08:00"><meta itemprop=dateModified content="2021-05-04T10:30:00+08:00"><meta itemprop=wordCount content="1394"><meta itemprop=keywords content="Internet,Linux"><meta property="og:url" content="https://chiehting.com/posts/iptables-guide/"><meta property="og:site_name" content="Chiehting's Blog"><meta property="og:title" content="Iptables guide"><meta property="og:description" content="iptables 被許多服務廣泛的運用著, 例如 Docker, Kubernetes 都是基於 iptables 來管理網路封包的處理, 所以此篇來研究 iptables 工具, 看看這些服務底層究竟在做些什麼事."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-04T10:30:00+08:00"><meta property="article:modified_time" content="2021-05-04T10:30:00+08:00"><meta property="article:tag" content="Internet"><meta property="article:tag" content="Linux"><meta name=twitter:card content="summary"><meta name=twitter:title content="Iptables guide"><meta name=twitter:description content="iptables 被許多服務廣泛的運用著, 例如 Docker, Kubernetes 都是基於 iptables 來管理網路封包的處理, 所以此篇來研究 iptables 工具, 看看這些服務底層究竟在做些什麼事."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Iptables guide","name":"Iptables guide","description":"iptables 被許多服務廣泛的運用著, 例如 Docker, Kubernetes 都是基於 iptables 來管理網路封包的處理, 所以此篇來研究 iptables 工具, 看看這些服務底層究竟在做些什麼事.\n","keywords":["internet","linux"],"articleBody":"iptables 被許多服務廣泛的運用著, 例如 Docker, Kubernetes 都是基於 iptables 來管理網路封包的處理, 所以此篇來研究 iptables 工具, 看看這些服務底層究竟在做些什麼事.\nLinux 核心 Netfilter 模組提供了網路的框架, 用於管理 Linux 主機的封包, 包括了過濾封包、NAT、Port 轉發. 而 Linux 系統上有許多軟體是基於 Netfilter 模組實作網路管理介面, 例如 firewalld、ntw、iptables、nftables.\niptables and ip6tables 分別為 IPv4 and IPv6, 組成包括了 Chain、Target、Table、Match, 而規則方面有 PREROUTING、INPUT、FORWARD、OUTPUT、POSTROUTIONG.\nPacket flow 引用 wiki netfilter packet flow 的圖, 可以看到封包在主機中的流量.\nTables 與 chain 下面列出 tables 內建 chain 關係\nPREROUTING INPUT FORWARD OUTPUT POSTROUTIONG raw o x x o x mangle o o o o o nat o x x o o filter x o o o x Tables 優先層級為 raw -\u003e mangle -\u003e nat -\u003e filter.\nraw: 於處理異常(優先層級最高). mangle: 提供改寫封包的功能. nat(network address translation): IP 轉發; port 轉發. filter: 封包過濾 (此為預設表). Chain PREROUTING: 數據包進入路由表之前. INPUT: 通過路由表後目的地為本機. FORWARD: 通過路由表後, 目的地不為本機. OUTPUT: 由本機產生, 向外轉發. POSTROUTIONG: 發送到網卡接口之前. State NEW: 一個新的連線封包 (建立新連線後的第一個封包). ESTABLISHED: 成功建立的連線, 即建立追蹤連線後所有封包狀態 (跟在 NEW 封包後面的所有封包). RELATED: 新建連線,由 ESTABLISHED session 所建立的新獨立連線 (ex. ftp-data 連線). INVALID: 非法連線狀態的封包 (DROP 封包). UNKOWN: 不明連線狀態的封包. Policy and target ACCEPT: 允許封包移動至目的地或另一個 chain. DROP: 丟棄封包,不回應要求,不傳送失敗訊息. REJECT: 拒絕封包,回應要求,傳送失敗訊息. SNAT: 修改 Source Socket. DNAT: 修改 Destination Socket. MASQUERADE: 動態修改 Source Socket (無法指定 IP,取當時網卡的 IP),較方便但效率較差. REDIRECT: 將連線導至本機行程 (Local Process). RETURN: 結束自行定義的 Chain 然後返回原來的 Chain 繼續跑規則 (rules). QUEUE: 封包排隊等待處理. LOG: 記錄指定的規則封包 (/etc/syslog.conf , default /var/log/messges). iptables 輸出格式說明 下面指令可以列出表 filter 的規則清單, 可以看到有三條 Chain, 有九個欄位, 說明如下:\npkts: 總共通過的封包的數量 bytes: 總共通過的流量大小 target: 執行的動作, 例如 ACCEPT、REJECT、RETURN、DROP、LOG,也可以參照到其他 Chain. port: 使用封包的協定, 例如 all、tcp、udp、icmp opt: 額外的選項說明 in: 進入的網路介面 out: 出去的網路介面 source: 此規則是針對哪個來源進行限制,例如 0.0.0.0/0 destination: 此規則是針對哪個目標進行限制,例如 0.0.0.0/0 root@server:~ iptables -L -n -v --line-numbers -t filter Chain INPUT (policy ACCEPT) pkts bytes target prot opt in out source destination Chain FORWARD (policy ACCEPT) pkts bytes target prot opt in out source destination Chain OUTPUT (policy ACCEPT) pkts bytes target prot opt in out source destination iptables 應用 參數說明 -P chain target: 變更 chain 的預設政策. -A chain: 加入規則至 chain 的最後. -I chain [rulenum]: 插入規則至 chain. -D chain [rulenum]: 刪除 chain 上的規則. -R chain [rulenum]: 取代 chain 上的規則. -L [chain [rulenum]]: 列出 chain 上的規則. -F [chain]: 刪除 chain 上的所有規則. -Z [chain [rulenum]]: 將計數器歸零. -N chain: 建立使用者定義的 chain. -X [chain]: 刪除使用者定義的 chain. -E old-chain new-chain: 變更 chain 的名稱. 其中 rulenum 是從上至下順序執行，直至匹配的的規則為止，否則執行預設政策。\n狀況題 測試主機有網路介面有 lo and eth0.\n查看 table filter 的規則 root@server:~ iptables -L -n -v --line-numbers -t filter 修改 chain 的預設政策 先將 22 port 打開, 以免被擋在家門外. INPUT 預設政策為 DROP.\n# INPUT chain accept port 22 root@server:~ iptables -I INPUT -i eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT # OUTPUT chain accept port 22 root@server:~ iptables -I OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT # INPUT chain default drop root@server:~ iptables -P INPUT DROP 還原\n# INPUT chain default accept root@server:~ iptables -P INPUT ACCEPT # Delete the INPUT chain first rule root@server:~ iptables -D INPUT 1 # Delete the OUTPUT chain first rule root@server:~ iptables -D OUTPUT 1 封鎖 INPUT chain 指定的 port ＃ 拒絕由網卡 eth0 進來的 tcp port 80 所有封包 iptables -A INPUT -p tcp -dport 80 -i eth0 -j REJECT ＃ 拒絕由網卡 eth0 進來的 tcp port 7000 ~ 7005 所有封包 iptables -A INPUT -p tcp -sport 7000:7005 -i eth0 -j REJECT 封鎖 INPUT chain 指定的 來源 iptables -I INPUT -p tcp --dport 80 -s 1.34.113.121/32 -m state --state ESTABLISHED -j REJECT 刪除 INPUT chain 所有的規則 iptables -F INPUT Rafances iptables 的表格 (table) 與鏈 (chain) ","wordCount":"1394","inLanguage":"en","datePublished":"2021-05-04T10:30:00+08:00","dateModified":"2021-05-04T10:30:00+08:00","author":{"@type":"Person","name":null},"mainEntityOfPage":{"@type":"WebPage","@id":"https://chiehting.com/posts/iptables-guide/"},"publisher":{"@type":"Organization","name":"Chiehting's Blog","description":"This website is preview about Chiehting. irregular update.","logo":{"@type":"ImageObject","url":"https://chiehting.com/favicon.ico"}}}</script><title>Iptables guide</title><link rel="stylesheet dns-prefetch preconnect preload prefetch" as=style media=screen href=https://chiehting.com/css/style.min.4a728eca217aff37d24d94ea492de99e69fea0a53bb05c836db76b9d0504ef60.css integrity="sha256-SnKOyiF6/zfSTZTqSS3pnmn+oKU7sFyDbbdrnQUE72A=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://chiehting.com/>Chiehting's Blog</a></div><nav class="site-nav hide-in-mobile"><a href=https://chiehting.com/posts/>Posts</a><a href=https://chiehting.com/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-links hide-in-mobile"><a href=ting911111@gmail.com target=_blank rel="noopener me" title=Email><svg class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a><a href=https://github.com/chiehting target=_blank rel="noopener me" title=Github><svg class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://chiehting.com/posts/>Posts</a></li><li><a href=https://chiehting.com/about/>About</a></li></ul></div><main class="site-main section-inner thin animated fadeIn faster"><h1>Iptables guide</h1><div class=content><p>iptables 被許多服務廣泛的運用著, 例如 Docker, Kubernetes 都是基於 iptables 來管理網路封包的處理, 所以此篇來研究 iptables 工具, 看看這些服務底層究竟在做些什麼事.</p><p>Linux 核心 <a href=https://www.netfilter.org/>Netfilter</a> 模組提供了網路的框架, 用於管理 Linux 主機的封包, 包括了<code>過濾封包</code>、<code>NAT</code>、<code>Port 轉發</code>. 而 Linux 系統上有許多軟體是基於 <a href=https://www.netfilter.org/>Netfilter</a> 模組實作網路管理介面, 例如 firewalld、ntw、iptables、nftables.</p><p>iptables and ip6tables 分別為 IPv4 and IPv6, 組成包括了 <code>Chain</code>、<code>Target</code>、<code>Table</code>、<code>Match</code>, 而規則方面有 <code>PREROUTING</code>、<code>INPUT</code>、<code>FORWARD</code>、<code>OUTPUT</code>、<code>POSTROUTIONG</code>.</p><h3 id=packet-flow>Packet flow<a href=#packet-flow class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>引用 wiki <a href=https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg>netfilter packet flow</a> 的圖, 可以看到封包在主機中的流量.</p><h3 id=tables-與-chain>Tables 與 chain<a href=#tables-%e8%88%87-chain class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>下面列出 <code>tables</code> 內建 <code>chain</code> 關係</p><table><thead><tr><th></th><th>PREROUTING</th><th>INPUT</th><th>FORWARD</th><th>OUTPUT</th><th>POSTROUTIONG</th></tr></thead><tbody><tr><td>raw</td><td>o</td><td>x</td><td>x</td><td>o</td><td>x</td></tr><tr><td>mangle</td><td>o</td><td>o</td><td>o</td><td>o</td><td>o</td></tr><tr><td>nat</td><td>o</td><td>x</td><td>x</td><td>o</td><td>o</td></tr><tr><td>filter</td><td>x</td><td>o</td><td>o</td><td>o</td><td>x</td></tr></tbody></table><h4 id=tables>Tables<a href=#tables class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>優先層級為 <code>raw</code> -> <code>mangle</code> -> <code>nat</code> -> <code>filter</code>.</p><ul><li>raw: 於處理異常(優先層級最高).</li><li>mangle: 提供改寫封包的功能.</li><li>nat(network address translation): IP 轉發; port 轉發.</li><li>filter: 封包過濾 (此為預設表).</li></ul><h4 id=chain>Chain<a href=#chain class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><ul><li>PREROUTING: 數據包進入路由表之前.</li><li>INPUT: 通過路由表後目的地為本機.</li><li>FORWARD: 通過路由表後, 目的地不為本機.</li><li>OUTPUT: 由本機產生, 向外轉發.</li><li>POSTROUTIONG: 發送到網卡接口之前.</li></ul><h4 id=state>State<a href=#state class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><ul><li>NEW: 一個新的連線封包 (建立新連線後的第一個封包).</li><li>ESTABLISHED: 成功建立的連線, 即建立追蹤連線後所有封包狀態 (跟在 NEW 封包後面的所有封包).</li><li>RELATED: 新建連線,由 ESTABLISHED session 所建立的新獨立連線 (ex. ftp-data 連線).</li><li>INVALID: 非法連線狀態的封包 (DROP 封包).</li><li>UNKOWN: 不明連線狀態的封包.</li></ul><h4 id=policy-and-target>Policy and target<a href=#policy-and-target class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><ul><li>ACCEPT: 允許封包移動至目的地或另一個 chain.</li><li>DROP: 丟棄封包,不回應要求,不傳送失敗訊息.</li><li>REJECT: 拒絕封包,回應要求,傳送失敗訊息.</li><li>SNAT: 修改 Source Socket.</li><li>DNAT: 修改 Destination Socket.</li><li>MASQUERADE: 動態修改 Source Socket (無法指定 IP,取當時網卡的 IP),較方便但效率較差.</li><li>REDIRECT: 將連線導至本機行程 (Local Process).</li><li>RETURN: 結束自行定義的 Chain 然後返回原來的 Chain 繼續跑規則 (rules).</li><li>QUEUE: 封包排隊等待處理.</li><li>LOG: 記錄指定的規則封包 (/etc/syslog.conf , default /var/log/messges).</li></ul><h3 id=iptables-輸出格式說明>iptables 輸出格式說明<a href=#iptables-%e8%bc%b8%e5%87%ba%e6%a0%bc%e5%bc%8f%e8%aa%aa%e6%98%8e class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>下面指令可以列出表 <code>filter</code> 的規則清單, 可以看到有三條 <code>Chain</code>, 有九個欄位, 說明如下:</p><ul><li>pkts: 總共通過的封包的數量</li><li>bytes: 總共通過的流量大小</li><li>target: 執行的動作, 例如 <code>ACCEPT</code>、<code>REJECT</code>、<code>RETURN</code>、<code>DROP</code>、<code>LOG</code>,也可以參照到其他 <code>Chain</code>.</li><li>port: 使用封包的協定, 例如 <code>all</code>、<code>tcp</code>、<code>udp</code>、<code>icmp</code></li><li>opt: 額外的選項說明</li><li>in: 進入的網路介面</li><li>out: 出去的網路介面</li><li>source: 此規則是針對哪個來源進行限制,例如 <code>0.0.0.0/0</code></li><li>destination: 此規則是針對哪個目標進行限制,例如 <code>0.0.0.0/0</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@server:~ iptables -L -n -v --line-numbers -t filter
</span></span><span class=line><span class=cl>Chain INPUT <span class=o>(</span>policy ACCEPT<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain FORWARD <span class=o>(</span>policy ACCEPT<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Chain OUTPUT <span class=o>(</span>policy ACCEPT<span class=o>)</span>
</span></span><span class=line><span class=cl> pkts bytes target     prot opt in     out     <span class=nb>source</span>               destination
</span></span></code></pre></div><h3 id=iptables-應用>iptables 應用<a href=#iptables-%e6%87%89%e7%94%a8 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><h4 id=參數說明>參數說明<a href=#%e5%8f%83%e6%95%b8%e8%aa%aa%e6%98%8e class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><ul><li>-P chain target: 變更 chain 的預設政策.</li><li>-A chain: 加入規則至 chain 的最後.</li><li>-I chain [rulenum]: 插入規則至 chain.</li><li>-D chain [rulenum]: 刪除 chain 上的規則.</li><li>-R chain [rulenum]: 取代 chain 上的規則.</li><li>-L [chain [rulenum]]: 列出 chain 上的規則.</li><li>-F [chain]: 刪除 chain 上的所有規則.</li><li>-Z [chain [rulenum]]: 將計數器歸零.</li><li>-N chain: 建立使用者定義的 chain.</li><li>-X [chain]: 刪除使用者定義的 chain.</li><li>-E old-chain new-chain: 變更 chain 的名稱.</li></ul><p>其中 rulenum 是從上至下順序執行，直至匹配的的規則為止，否則執行預設政策。</p><h4 id=狀況題>狀況題<a href=#%e7%8b%80%e6%b3%81%e9%a1%8c class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4><p>測試主機有網路介面有 <code>lo</code> and <code>eth0</code>.</p><h5 id=查看-table-filter-的規則>查看 table filter 的規則<a href=#%e6%9f%a5%e7%9c%8b-table-filter-%e7%9a%84%e8%a6%8f%e5%89%87 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root@server:~ iptables -L -n -v --line-numbers -t filter
</span></span></code></pre></div><h5 id=修改-chain-的預設政策>修改 chain 的預設政策<a href=#%e4%bf%ae%e6%94%b9-chain-%e7%9a%84%e9%a0%90%e8%a8%ad%e6%94%bf%e7%ad%96 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h5><p>先將 22 port 打開, 以免被擋在家門外. INPUT 預設政策為 DROP.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># INPUT chain accept port 22</span>
</span></span><span class=line><span class=cl>root@server:~ iptables -I INPUT -i eth0 -p tcp --dport <span class=m>22</span> -m state --state NEW,ESTABLISHED -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># OUTPUT chain accept port 22</span>
</span></span><span class=line><span class=cl>root@server:~ iptables -I OUTPUT -o eth0 -p tcp --sport <span class=m>22</span> -m state --state ESTABLISHED -j ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># INPUT chain default drop</span>
</span></span><span class=line><span class=cl>root@server:~ iptables -P INPUT DROP
</span></span></code></pre></div><p>還原</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># INPUT chain default accept</span>
</span></span><span class=line><span class=cl>root@server:~ iptables -P INPUT ACCEPT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Delete the INPUT chain first rule</span>
</span></span><span class=line><span class=cl>root@server:~ iptables -D INPUT <span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Delete the OUTPUT chain first rule</span>
</span></span><span class=line><span class=cl>root@server:~ iptables -D OUTPUT <span class=m>1</span>
</span></span></code></pre></div><h5 id=封鎖-input-chain-指定的-port>封鎖 INPUT chain 指定的 port<a href=#%e5%b0%81%e9%8e%96-input-chain-%e6%8c%87%e5%ae%9a%e7%9a%84-port class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>＃ 拒絕由網卡 eth0 進來的 tcp port <span class=m>80</span> 所有封包
</span></span><span class=line><span class=cl>iptables -A INPUT -p tcp -dport <span class=m>80</span> -i eth0 -j REJECT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>＃ 拒絕由網卡 eth0 進來的 tcp port <span class=m>7000</span> ~ <span class=m>7005</span> 所有封包
</span></span><span class=line><span class=cl>iptables -A INPUT -p tcp -sport 7000:7005 -i eth0 -j REJECT
</span></span></code></pre></div><h5 id=封鎖-input-chain-指定的-來源>封鎖 INPUT chain 指定的 來源<a href=#%e5%b0%81%e9%8e%96-input-chain-%e6%8c%87%e5%ae%9a%e7%9a%84-%e4%be%86%e6%ba%90 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>iptables -I INPUT -p tcp --dport <span class=m>80</span> -s 1.34.113.121/32 -m state --state ESTABLISHED -j REJECT
</span></span></code></pre></div><h5 id=刪除-input-chain-所有的規則>刪除 INPUT chain 所有的規則<a href=#%e5%88%aa%e9%99%a4-input-chain-%e6%89%80%e6%9c%89%e7%9a%84%e8%a6%8f%e5%89%87 class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>iptables -F INPUT
</span></span></code></pre></div><h3 id=rafances>Rafances<a href=#rafances class=anchor aria-hidden=true><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><ul><li><a href=http://linux.vbird.org/linux_server/0250simple_firewall.php#netfilter_chain>iptables 的表格 (table) 與鏈 (chain)</a></li><li></li></ul></div><div class="human single"><a href=https://brainmade.org/ target=_blank rel="external noreferrer noopener"><abbr title="I don't hate AIs; but I love humans!"><svg fill="#fff" width="128" height="40" viewBox="0 0 128 40"><path d="M26.306 39.391H11.665a1.28 1.28.0 01-1.28-1.28v-3.838H6.399a1.28 1.28.0 01-1.28-1.28v-5.336l-4.41-2.198a1.28 1.28.0 01-.493-1.855l4.904-7.357v-2.175C5.12 6.298 11.422.0 19.194.0s14.073 6.3 14.075 14.071c-.316 13.912-5.38 11.758-5.59 17.023l-.093 7.018a1.3 1.3.0 01-.375.905 1.27 1.27.0 01-.905.375zm-13.361-2.559h12.082l.143-7.27c-.132-3.329 5.858-4.122 5.54-15.368-.179-6.356-5.157-11.635-11.515-11.635S7.68 7.713 7.679 14.071v2.559c-.001.253-.075.5-.215.71l-4.315 6.471 3.822 1.91a1.28 1.28.0 01.708 1.145v4.848h3.987a1.28 1.28.0 011.28 1.28z"/><path d="M20.186 29.111v-9.644c.059.0.118.009.177.009 4.885-.006 8.525-4.506 7.511-9.284a1.19 1.19.0 00-.911-.911 7.67 7.67.0 00-9.049 5.67l-.033-.036a7.66 7.66.0 00-7.03-2.085 1.19 1.19.0 00-.911.91c-1.014 4.777 2.627 9.277 7.51 9.284.118.0.246-.014.369-.02v6.106zm1.419-16.072a5.33 5.33.0 014.062-1.553 5.33 5.33.0 01-5.614 5.615 5.3 5.3.0 011.552-4.061zm-7.904 6.057a5.3 5.3.0 01-1.559-4.061 5.323 5.323.0 015.614 5.615 5.3 5.3.0 01-4.055-1.554m38.419-6.79q0 2.346-1.567 3.63-1.567 1.282-4.351 1.283h-7.669V0h7.016q2.807.0 4.242 1.1 1.446 1.087 1.446 3.226.0 1.467-.729 2.481-.718 1.002-2.197 1.357 1.86.244 2.828 1.32.979 1.063.979 2.823zm-4.112-7.491q0-1.161-.663-1.65-.652-.488-1.947-.488h-3.655v4.265h3.677q1.36.0 1.968-.525.62-.537.62-1.601m.892 7.209q0-2.42-3.089-2.42h-4.069v4.938h4.188q1.545.0 2.252-.624.718-.635.718-1.894m16.26 5.194-3.557-6.538h-3.764v6.538H54.63V0h7.658q2.741.0 4.231 1.332 1.49 1.32 1.49 3.8.0 1.808-.913 3.128-.914 1.308-2.47 1.723l4.144 7.235zm-.381-11.94q0-2.481-2.828-2.481h-4.112v5.083h4.199q1.349.0 2.045-.684.696-.685.696-1.919m16.785 11.94-1.36-4.399h-5.841l-1.359 4.399h-3.209L75.386.0h3.785l5.569 17.219zM77.278 2.651l-.066.269q-.109.44-.261 1.002c-.152.563-.725 2.436-1.871 6.184h4.405l-1.512-4.949-.468-1.662zm9.551 14.567V0h3.209v17.219zm15.53.0L95.681 3.959q.196 1.931.196 3.104v10.155h-2.849V0h3.666l6.777 13.37q-.196-1.846-.196-3.361V0h2.85v17.219zM52.63 39.375V28.331q.011-.351.115-3.015-.818 3.257-1.209 4.541l-2.925 9.518h-2.418l-2.925-9.518-1.232-4.541q.139 2.809.139 3.717v10.342h-3.017V22.313h4.548l2.902 9.543.253.92.553 2.289.725-2.736 2.983-10.015h4.526v17.063zm17.64.0-1.44-4.359h-6.184l-1.44 4.359h-3.397l5.919-17.063h4.007l5.896 17.063zm-4.537-14.434-.069.267q-.115.436-.277.993c-.162.557-.767 2.414-1.98 6.128h4.663l-1.601-4.905-.495-1.647zm24.577 5.776q0 2.64-.99 4.614-.979 1.961-2.787 3.003-1.796 1.042-4.122 1.042h-6.564V22.313h5.873q4.099.0 6.345 2.18 2.245 2.167 2.245 6.224m-3.42.0q0-2.748-1.359-4.19-1.359-1.453-3.881-1.453h-2.407v11.54h2.879q2.188.0 3.478-1.586t1.29-4.311m6 8.659V22.313h12.759v2.761h-9.362v4.287h8.66v2.761h-8.66v4.492h9.835v2.761zm15.75.0v-3.693h3.328v3.693zm12.445-12.149q2.082.0 3.662.781 1.58.78 2.422 2.235.833 1.454.833 3.393.0 2.98-1.845 4.676Q124.302 40 121.085 40q-3.208.0-5.005-1.688-1.798-1.688-1.798-4.695c0-3.007.606-3.57 1.817-4.694q1.817-1.696 4.986-1.696m0 2.702q-2.157.0-3.378.97-1.23.97-1.23 2.72.0 1.777 1.22 2.747 1.211.97 3.388.97 2.195.0 3.462-.988 1.258-.997 1.258-2.711.0-1.778-1.23-2.738-1.23-.97-3.491-.97m6.725-13.402-5.062 2.935v3.107h5.062v2.648h-13.331v-6.322q0-2.261 1.031-3.491 1.022-1.23 2.942-1.23 1.4.0 2.422.754 1.012.754 1.334 2.038l5.601-3.42zm-9.244.314q-1.92.0-1.921 2.334v3.393h3.936v-3.465q0-1.113-.53-1.688t-1.486-.575m7.249-10.915a6.5 6.5.0 00-.313-2.002q-.321-.969-.814-1.499h-1.845v3.088h-2.063V0h4.901q1.088 1.005 1.703 2.622a9.4 9.4.0 01.615 3.375q0 3.088-1.798 4.748-1.808 1.661-5.119 1.661-3.292.0-5.043-1.67-1.76-1.67-1.76-4.803.0-4.452 3.473-5.664l.776 2.442q-1.012.395-1.533 1.238-.52.844-.52 1.984.0 1.867 1.192 2.837t3.416.97q2.261.0 3.501-.997 1.23-1.005 1.23-2.818z"/></svg></abbr></a></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2026 <a href=https://chiehting.com/>Chiehting's Blog</a>
&#183; Copyright © 2025 Chiehting Lee. All rights reserved.</p></footer><script async src=https://chiehting.com/js/bundle.min.217d62397cbef6f9f5d8bab30d7e7969d78c52a436ca5d5790cef4d6fef3f1f2.js integrity="sha256-IX1iOXy+9vn12LqzDX55adeMUqQ2yl1XkM701v7z8fI=" crossorigin=anonymous></script><script async src=https://chiehting.com/js/link-share.min.24409a4f6e5537d70ffc55ec8f9192208d718678cb8638585342423020b37f39.js integrity="sha256-JECaT25VN9cP/FXsj5GSII1xhnjLhjhYU0JCMCCzfzk=" crossorigin=anonymous></script></body></html>