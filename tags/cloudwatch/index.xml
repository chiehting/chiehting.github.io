<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>cloudwatch on Chiehting</title><link>https://chiehting.com/tags/cloudwatch/</link><description>Recent content in cloudwatch on Chiehting</description><generator>Hugo -- gohugo.io</generator><copyright>Copyright © 2008–2018, Steve Francia and the Hugo Authors; all rights reserved.</copyright><lastBuildDate>Thu, 24 Nov 2022 10:00:00 +0800</lastBuildDate><atom:link href="https://chiehting.com/tags/cloudwatch/index.xml" rel="self" type="application/rss+xml"/><item><title>How to send log from AWS eks to cloudwatch.</title><link>https://chiehting.com/posts/kubernetes-send-log-to-cloudwatch/</link><pubDate>Thu, 24 Nov 2022 10:00:00 +0800</pubDate><guid>https://chiehting.com/posts/kubernetes-send-log-to-cloudwatch/</guid><description>
&lt;p>研究如何使用 AWS 的 CloudWatch 來收集 EKS 的 log. 並使用 Grafana 做 log search.&lt;/p>
&lt;p>原本的 logging architecture 是使用 Elasticsearch + Filebeat + Kibana; 現在改用 AWS CloudWatch + Fluent Bit + Grafana.&lt;/p>
&lt;h3 id="問題描述">問題描述&lt;/h3>
&lt;p>原架構為 Elasticsearch + Filebeat + Kibana, 基於下述狀況決定改架構, 來減少維護成本.&lt;/p>
&lt;ul>
&lt;li>目前開發使用情境, 之需要查看 log 且可以搜尋, 不需要做資料探勘. 殺雞用牛刀了.&lt;/li>
&lt;li>Elasticsearch 在 Basic License 下, 無法使用 LDAP, PKI3, Active Directory authentication 功能.&lt;/li>
&lt;li>Elasticsearch &lt;a href="https://www.elastic.co/guide/en/cloud-enterprise/current/ece-hardware-prereq.html">硬體需求&lt;/a>較高, 最低的硬體需求為 t2.large (2 vCPU, 8 Mem).&lt;/li>
&lt;li>Elasticsearch 使用門檻較高, 能維護的人員不多, 維護上困難.&lt;/li>
&lt;/ul>
&lt;h3 id="日誌蒐集狀況">日誌蒐集狀況&lt;/h3>
&lt;h4 id="index-lifecycle-management-配置">Index lifecycle Management 配置&lt;/h4>
&lt;p>取 kubernetes 的 ilm 配置, 看到熱資料配置為 20gb or 15d 做 rollover.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">elasticsearch:/opt$ curl -XGET --user &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$account&lt;/span>&lt;span class="s2">:&lt;/span>&lt;span class="nv">$password&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;http://&lt;/span>&lt;span class="nv">$host&lt;/span>&lt;span class="s2">/_ilm/policy/kubernetes?pretty&amp;#34;&lt;/span>&lt;span class="p">|&lt;/span>jq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;kubernetes&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;version&amp;#34;&lt;/span> : 23,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;modified_date&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;2021-07-07T07:58:49.033Z&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;policy&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;phases&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> ..................
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;hot&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;min_age&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;0ms&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;actions&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;rollover&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;max_primary_shard_size&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;20gb&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;max_age&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;15d&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;forcemerge&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;max_num_segments&amp;#34;&lt;/span> : &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;readonly&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;shrink&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;number_of_shards&amp;#34;&lt;/span> : &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;set_priority&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;priority&amp;#34;&lt;/span> : &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> ..................
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="資料使用量">資料使用量&lt;/h4>
&lt;p>目前資料使用量為 167G (./elasticsearch/data).&lt;/p>
&lt;p>取其中一個 site 的 production 環境資料,平均 index 約 9.62 GB.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">curl -XGET --user &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$account&lt;/span>&lt;span class="s2">:&lt;/span>&lt;span class="nv">$password&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;http://&lt;/span>&lt;span class="nv">$host&lt;/span>&lt;span class="s2">/_cat/indices/*prod*?v=true&amp;amp;pretty&amp;amp;s=index&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">health status index uuid pri rep docs.count docs.deleted store.size pri.store.size
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">green open kubernetes-prod-000039 co5bX1YqSOu11BaKVkUnKw &lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">10075181&lt;/span> &lt;span class="m">0&lt;/span> 6.5gb 6.5gb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">green open shrink-arvp-kubernetes-prod-000036 tgcGQwEZSliq9H2R4QJDCQ &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">16602612&lt;/span> &lt;span class="m">0&lt;/span> 10gb 10gb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">green open shrink-kvlp-kubernetes-prod-000038 g0if66MHTDmyWm4vcuX9cw &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">15674075&lt;/span> &lt;span class="m">0&lt;/span> 9.7gb 9.7gb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">green open shrink-laqk-kubernetes-prod-000035 FxLNQzpjQRKjsz_H8Vkl5w &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">20661224&lt;/span> &lt;span class="m">0&lt;/span> 12.7gb 12.7gb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">green open shrink-ttkl-kubernetes-prod-000037 DpeVcQVgTg-VKfOykWkN3Q &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">15092948&lt;/span> &lt;span class="m">0&lt;/span> 9.2gb 9.2gb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="執行">執行&lt;/h3>
&lt;p>照著 AWS 教學文件 &lt;a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-logs-FluentBit.html">Set up Fluent Bit as a DaemonSet to send logs to CloudWatch Logs&lt;/a> 實作.&lt;/p>
&lt;h4 id="create-aws-cloudwatch-logs">Create AWS CloudWatch Logs&lt;/h4>
&lt;p>首先需要建立 AWS CloudWatch 的 Log groups for log stream. 其中 &lt;code>Cluster_Name&lt;/code> 為 EKS cluster 名稱.&lt;/p>
&lt;ul>
&lt;li>/aws/containerinsights/&lt;code>Cluster_Name&lt;/code>/application&lt;/li>
&lt;li>/aws/containerinsights/&lt;code>Cluster_Name&lt;/code>/host&lt;/li>
&lt;li>/aws/containerinsights/&lt;code>Cluster_Name&lt;/code>/dataplane&lt;/li>
&lt;/ul>
&lt;p>在這邊使用 Terraform &lt;a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_group">aws_cloudwatch_log_group&lt;/a> 來實作.&lt;/p>
&lt;h4 id="quick-start-setup-for-container-insights-on-amazon-eks-and-kubernetes">Quick Start setup for Container Insights on Amazon EKS and Kubernetes&lt;/h4>
&lt;h5 id="配置-iam-權限-eks-的-node-iam-role-需含下面權限">配置 IAM 權限. EKS 的 Node IAM role 需含下面權限&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-terraform" data-lang="terraform">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kr">data&lt;/span> &lt;span class="s2">&amp;#34;aws_iam_policy_document&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;eks_node_group_cloudwatch_role&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nx">statement&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="na">actions&lt;/span> = &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;logs:CreateLogStream&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;logs:CreateLogGroup&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;logs:DescribeLogStreams&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;logs:PutLogEvents&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="na">effect&lt;/span> = &lt;span class="s2">&amp;#34;Allow&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="na">resources&lt;/span> = &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>接著按照文件 &lt;a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-EKS-quickstart.html">Quick Start setup for Container Insights on Amazon EKS and Kubernetes&lt;/a> 安裝 DaemonSet of Fluent Bit.&lt;/p>
&lt;h5 id="建立-kubernetes-namespace">建立 kubernetes namespace&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">kubectl apply -f https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/cloudwatch-namespace.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="執行-fluent-bityaml">執行 fluent-bit.yaml&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">ClusterName&lt;/span>&lt;span class="o">=&lt;/span>production
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">RegionName&lt;/span>&lt;span class="o">=&lt;/span>us-east-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="nv">FluentBitHttpPort&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;2020&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="nv">FluentBitReadFromHead&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;Off&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="o">[[&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitReadFromHead&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;On&amp;#39;&lt;/span> &lt;span class="o">]]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">FluentBitReadFromTail&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;Off&amp;#39;&lt;/span>&lt;span class="o">||&lt;/span> &lt;span class="nv">FluentBitReadFromTail&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;On&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="o">[[&lt;/span> -z &lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitHttpPort&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="o">]]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">FluentBitHttpServer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;Off&amp;#39;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nv">FluentBitHttpServer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;On&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">curl https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/quickstart/cwagent-fluent-bit-quickstart.yaml &lt;span class="p">|&lt;/span> sed &lt;span class="s1">&amp;#39;s/{{cluster_name}}/&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">ClusterName&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;/;s/{{region_name}}/&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">RegionName&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;/;s/{{http_server_toggle}}/&amp;#34;&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitHttpServer&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;/;s/{{http_server_port}}/&amp;#34;&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitHttpPort&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;/;s/{{read_from_head}}/&amp;#34;&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitReadFromHead&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;/;s/{{read_from_tail}}/&amp;#34;&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitReadFromTail&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;/&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> kubectl apply -f -
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="調整-application-logconf">調整 application-log.conf&lt;/h5>
&lt;p>由於有做 healthcheck, 所以在 log 希望可以過濾掉 healthcheck 的資料.&lt;/p>
&lt;p>需要再 application-log.conf 中加入下面資訊&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">[FILTER]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> Name grep
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> Match application.*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> Exclude log /.*healthcheck.*/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">kubectl edit configmap/fluent-bit-config -n amazon-cloudwatch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="使用-grafana-做-dashborad">使用 Grafana 做 Dashborad&lt;/h4>
&lt;h5 id="帳戶管理-ldap">帳戶管理 LDAP&lt;/h5>
&lt;p>上面提到痛點之一就是帳戶無法統一管理, 容易遺漏. 這邊 Grafana 原生就提供 LDAP 的功能.&lt;/p>
&lt;p>確認 LDAP 功能有 enable, 在 &lt;code>/usr/share/grafana/conf/defaults.ini&lt;/code>.
這邊以 &lt;code>image: grafana/grafana:8.3.1&lt;/code> 為例, 編輯 &lt;code>/usr/share/grafana/conf/ldap.toml&lt;/code> 檔案.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-toml" data-lang="toml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">[[&lt;/span>&lt;span class="nx">servers&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="nx">host&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;ldap.example.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="nx">port&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">389&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="nx">use_ssl&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="nx">start_tls&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="nx">ssl_skip_verify&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="nx">bind_dn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;uid=uid,cn=users,cn=accounts,dc=example,dc=com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="nx">bind_password&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;passowrd&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="nx">search_filter&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;(uid=%s)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="nx">search_base_dns&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;cn=users,cn=accounts,dc=example,dc=com&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="nx">servers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">attributes&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="nx">name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;givenName&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="nx">surname&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;sn&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="nx">username&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;uid&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="nx">member_of&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;memberOf&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="nx">email&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;email&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="p">[[&lt;/span>&lt;span class="nx">servers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">group_mappings&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="nx">group_dn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;cn=admins,cn=groups,cn=accounts,dc=example,dc=com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="nx">org_role&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Admin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="p">[[&lt;/span>&lt;span class="nx">servers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">group_mappings&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="nx">group_dn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;cn=groups,ou=accounts,dc=example,dc=com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="nx">org_role&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Editor&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="p">[[&lt;/span>&lt;span class="nx">servers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">group_mappings&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">&lt;span class="nx">group_dn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="nx">org_role&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Viewer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="create-data-source">Create Data Source&lt;/h4>
&lt;p>進到 Grafana 中的 Data Source, 加入 CloudWatch 源.&lt;/p>
&lt;h3 id="完成效果">完成效果&lt;/h3>
&lt;p>完成後會在 AWS CloudWatch 的 log groups 有接收到 log streams.&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2022-11-24-how-to-send-eks-log-to-cloudwatch-1.png" alt="AWS CloudWatch Logs Insights">&lt;/p>
&lt;p>在 Grafana 中建立 Dashboard.&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2022-11-24-how-to-send-eks-log-to-cloudwatch-2.png" alt="Grafana Dashboard">&lt;/p>
&lt;h4 id="結論">結論&lt;/h4>
&lt;p>上面提到的問題, 改了架構後做觀察.&lt;/p>
&lt;blockquote>
&lt;p>目前開發使用情境, 之需要查看 log 且可以搜尋, 不需要做 log 分析..&lt;/p>
&lt;/blockquote>
&lt;p>這邊換了架構對開發並無影響. (開發沒過多反應, 平時有在使用嗎?)&lt;/p>
&lt;blockquote>
&lt;p>Elasticsearch 在 Basic License 下, 無法使用 LDAP, PKI3, Active Directory authentication 功能.&lt;/p>
&lt;/blockquote>
&lt;p>這邊改用 Grafana 的 LDAP 功能做改善, 帳密的管理統一, 維護上變簡單.&lt;/p>
&lt;blockquote>
&lt;p>Elasticsearch 硬體需求較高, 為 t2.large (2 vCPU, 8 Mem).&lt;/p>
&lt;/blockquote>
&lt;p>原本 t2.large, 使用 AWS 計算機算出的費用約 108.96 USD/Monthly cost
更改 CloudWatch, 收到的費用為 108.96 USD/Monthly cost (這邊為所有 groups 的費用, 包括 application, EKS, RDS 等)&lt;/p>
&lt;p>這邊比較尷尬, 由於兩邊收集的 log 量不同, 不容易比較.&lt;/p>
&lt;blockquote>
&lt;p>Elasticsearch 能維護的人員不多, 維護上困難.&lt;/p>
&lt;/blockquote>
&lt;p>在寫這篇文章的同時, 也看到一些新的 index 配置並無做優化. 相關配置也已經被動到. 很難受.&lt;br/>
改新架構後維護應該要變簡單, 因為不用去搞 index 跟 ilm.&lt;/p></description></item></channel></rss>