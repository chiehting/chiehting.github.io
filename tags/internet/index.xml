<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>internet on Chiehting</title><link>https://chiehting.com/tags/internet/</link><description>Recent content in internet on Chiehting</description><generator>Hugo -- gohugo.io</generator><copyright>Copyright © 2008–2018, Steve Francia and the Hugo Authors; all rights reserved.</copyright><lastBuildDate>Wed, 16 Jul 2025 11:55:09 +0800</lastBuildDate><atom:link href="https://chiehting.com/tags/internet/index.xml" rel="self" type="application/rss+xml"/><item><title>rtsp 串流異常分析</title><link>https://chiehting.com/posts/rtsp-rtp-packet-analyzer/</link><pubDate>Wed, 16 Jul 2025 11:55:09 +0800</pubDate><guid>https://chiehting.com/posts/rtsp-rtp-packet-analyzer/</guid><description>
&lt;p>Real Time Streaming Protocol &lt;a href="https://datatracker.ietf.org/doc/html/rfc2326">(RTSP)&lt;/a> 是基於 Real-time Transport Protocol &lt;a href="https://datatracker.ietf.org/doc/html/rfc3550">(RTP)&lt;/a> 之上的協議，負責控制串流會話。&lt;/p>
&lt;p>這次發生的問題是串流會異常終止，查看封包後發現 client 送 RTP 長度不足，導致串流中斷。&lt;/p>
&lt;h3 id="tcpdump">Tcpdump&lt;/h3>
&lt;p>使用 tcpdump 來抓包，保存成 Wireshark 可以開啟的檔案。在 Server 上執行命令開始抓包。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">tcpdump -i any -s &lt;span class="m">0&lt;/span> -w /tmp/dump.pcap -U
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="packet-analyzer">Packet Analyzer&lt;/h3>
&lt;h4 id="packet-protocol">Packet protocol&lt;/h4>
&lt;p>這邊抓到了異常的封包，關注其中的 RTSP Interleaved Frame、Real-Time Transport Protocol、Real Time Streaming Protocol，正常的傳輸中不會出現 Real Time Streaming Protocol。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">Frame 477: 1508 bytes on wire (12064 bits), 1508 bytes captured (12064 bits)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Linux cooked capture v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">Internet Protocol Version 4, Src: 10.2.1.220, Dst: 10.2.3.199
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">Transmission Control Protocol, Src Port: 40725, Dst Port: 8554, Seq: 16706, Ack: 1449, Len: 1452
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">[2 Reassembled TCP Segments (1018 bytes): #475(1002), #477(16)]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">RTSP Interleaved Frame, Channel: 0x00, 1014 bytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> Magic: 0x24
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> Channel: 0x00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> Length: 1014
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">Real-Time Transport Protocol
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> [Stream setup by DECODE AS (frame 443)]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> 10.. .... = Version: RFC 1889 Version (2)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> ..0. .... = Padding: False
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> ...0 .... = Extension: False
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> .... 0000 = Contributing source identifiers count: 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> 0... .... = Marker: False
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> Payload type: DynamicRTP-Type-96 (96)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> Sequence number: 16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> [Extended sequence number: 65552]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> Timestamp: 13747590
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> [Extended timestamp: 4308714886]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> Synchronization Source identifier: 0x18877309 (411529993)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> Payload […]: 7c05d4fe1ff6280a012732b0fecce5fd5c5fe4461807787cfabe2b0e3caf228
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">Real Time Streaming Protocol
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> Data (1436 bytes)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="rtsp-interleaved-frame">RTSP Interleaved Frame&lt;/h4>
&lt;p>RTSP交錯幀允許在同一條連接上交錯傳輸RTSP控制信息與媒體流數據。RTSP Interleaved Frame 是 4 bytes 的內容，下面是 RTSP Interleaved Frame 的 packet bytes 內容範例，用 Hex Dump 顯示。&lt;/p>
&lt;p>RTSP Interleaved Frame 內容包括了三個資訊：&lt;/p>
&lt;ol>
&lt;li>Magic: 0x24&lt;/li>
&lt;li>Channel: 0x00&lt;/li>
&lt;li>Length: 0x03f6，這邊換算出來是 1014&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">0000 24 00 03 f6
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>依照上面內容，接下來的 RTP 需要傳送 1014 bytes 的內容，接著再接收一次 RTSP Interleaved Frame。&lt;/p>
&lt;h4 id="real-time-transport-protocol">Real-Time Transport Protocol&lt;/h4>
&lt;p>在 RTS 傳輸時發生問題，RTS 的內容長度不足 1014 bytes 導致後面的串流幀都亂掉了。接著收到 Real Time Streaming Protocol，其內容 RTSP 已經無法使用，導致 RTSP session 中斷。&lt;/p>
&lt;ol>
&lt;li>使用 &lt;code>24&lt;/code> 去搜尋，發現在 01c0 行有 RTSP Interleaved Frame 的內容 &lt;code>24 00 03 f6&lt;/code>，看到交錯幀提早到了。&lt;/li>
&lt;li>在 0000 行有 &lt;code>00 10&lt;/code> 表示第 16 幀。接著看到 01c0 行有 &lt;code>00 11&lt;/code> 表示第 17 幀。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">0000 80 60 00 10 00 d1 c5 86 18 87 73 09 7c 05 d4 fe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">0010 1f f6 28 0a 01 27 32 b0 fe cc e5 fd 5c 5f e4 46
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">0020 18 07 78 7c fa be 2b 0e 3c af 22 8b c5 24 c4 0f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">0030 15 f9 b1 49 ea e3 85 df 77 f0 0a bb 93 95 2a a5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">0040 38 f2 ff 9e 07 fb e5 ca 60 c2 e0 30 8f 78 37 5a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">0050 45 e1 45 77 f0 6a 4a 21 cc 43 8d 85 ca cc 69 6e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">0060 f0 87 72 7d ee 78 73 c2 8a 85 05 5f 87 38 ee 32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">0070 a7 3c e1 f5 bb 93 85 49 c2 ac ca 7c 22 1c 21 04
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">0080 f0 8d 92 7b cf f8 51 51 0f 38 73 c7 80 62 18 5c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">0090 65 4b 19 ce 75 07 4b cd 60 77 12 93 95 e2 e1 07
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">00a0 00 7b 59 53 d3 ff fd 5f 3d e1 08 08 42 8b 0a 0a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">00b0 bf 5d cb e5 a9 72 0f 5d 74 50 7f 44 d4 10 0d 18
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">00c0 c8 87 db b5 7e 7c f9 c0 2f ff 58 d4 6f 38 c6 54
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">00d0 b0 19 20 2b 6e c8 c1 b2 5f 10 e0 50 56 b3 a2 28
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">00e0 df ff 86 e5 e5 55 4b 2f 9b 4c 43 c7 6e 59 9f e5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">00f0 da 9c 38 e4 82 bf 87 24 03 00 1c 80 c8 00 06 61
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">0100 66 fb 2a ec 20 69 5c b6 9f be 76 00 12 a5 e0 00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">0110 00 00 00 00 00 00 00 24 02 00 ac 80 00 00 64 00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">0120 12 ac c8 61 66 fb 2a 7a 79 77 76 7a 7b 7b fc 7e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">0130 7d fd fd fe 7d 7c 78 78 76 76 76 73 76 76 78 78
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">0140 7b 7e fb fc f9 fa fa fc 7e 7d 76 77 78 79 78 78
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">0150 78 7b fc fb f7 ef ee ec e9 e7 ea ea eb ec f2 f6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">0160 fd 7e 7b 79 7b 79 78 77 79 fd f7 f3 f1 f4 f7 fa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">0170 fb fe ff 7d 7c fe fb f8 f8 f8 fb fc ff 7d fa fd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">0180 f9 f4 f1 ef f0 f4 f4 f9 fd fd 7e f9 f6 f1 f0 f1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">0190 f4 f6 f7 fb ff 7d ff fb f8 f7 f6 f7 f4 f4 f5 f6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">01a0 f8 fe 7b 75 70 6d 6b 6c 6c 71 74 7d fe fb fb fb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">01b0 f7 fb fe 78 7a 78 75 74 75 76 75 79 7b 7b 79 7c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">01c0 7b 7d 7c 7b 7a 7b 7b 24 00 03 f6 80 60 00 11 00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">01d0 d1 c5 86 18 87 73 09 7c 05 21 88 6c 3d 7f 3a d3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">01e0 2f fe 01 0b c2 10 89 ce 1e f1 49 a8 56 e9 bd 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">01f0 a1 9d 55 54 55 94 e8 75 f7 77 7e 66 3c 43 3e dc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl">0200 6d 5b ae df 8a eb 06 b5 3b b7 7c 00 38 88 3a 51
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">0210 c3 db 6c 0f 86 ae fa e4 82 a7 39 6f e1 1a d2 fd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl">0220 53 0f b6 da ac 3e 1f f6 f8 ad ef 77 f6 a3 cb a5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl">0230 10 26 03 9a 52 e2 ac b0 5c f8 19 54 63 28 eb 69
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl">0240 9c 90 54 0d 6f 4c b5 ee 8d 6e f4 10 00 70 14 d1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl">0250 3f 4d 12 b3 14 61 55 41 84 d4 95 58 8b f5 77 6c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl">0260 37 40 77 dd fc d2 81 18 47 31 26 7d 95 f2 9b c7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl">0270 6f 1a 77 5d 9d 52 33 58 bb f4 4f f5 d4 4b 81 33
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">41&lt;/span>&lt;span class="cl">0280 fa 0e 89 d7 ff 77 75 bc 5e 2b cb 85 c9 71 d6 4b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">42&lt;/span>&lt;span class="cl">0290 81 1c 01 ce 1c 96 2f f4 fa 69 e9 df e1 7b dd df
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">43&lt;/span>&lt;span class="cl">02a0 19 48 56 21 c3 9c 15 97 05 6d c3 da 5d 88 73 47
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">44&lt;/span>&lt;span class="cl">02b0 03 c2 fe 3e 5e 91 5a e0 d9 aa 72 48 00 3c f3 89
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">45&lt;/span>&lt;span class="cl">02c0 0a fd 1e 5e 0e 5f 32 00 7f bb c1 44 6e a2 0e 0a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">46&lt;/span>&lt;span class="cl">02d0 f0 0e 3c f0 be c9 15 1d f0 bd d9 50 da d8 e4 3c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">47&lt;/span>&lt;span class="cl">02e0 7e 0d e3 e2 f1 b4 7d 59 51 bf 89 74 4b bd ff 75
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">48&lt;/span>&lt;span class="cl">02f0 77 7f dc 57 76 e2 64 80 a8 9e 24 7f 62 0b 3e 2c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">49&lt;/span>&lt;span class="cl">0300 71 39 44 e1 bb fd f7 ff c2 94 43 84 cf 9b c9 01
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">50&lt;/span>&lt;span class="cl">0310 56 e1 e3 42 ea ce 79 ee 7b 7c 4b 4e fb bf 0c 63
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">51&lt;/span>&lt;span class="cl">0320 4e 3c 79 65 b1 59 70 b6 70 39 bb f1 b6 d9 7d 14
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">52&lt;/span>&lt;span class="cl">0330 f5 bf 85 0d 1a 1b f5 e6 92 78 b2 fd 1f fc 35 84
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">53&lt;/span>&lt;span class="cl">0340 03 ab f7 f7 7d a0 aa b5 a7 58 c4 23 fe 71 d4 cb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">54&lt;/span>&lt;span class="cl">0350 df 12 e4 f9 54 db b7 d3 4d 34 e0 b3 f8 1a 1b ae
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">55&lt;/span>&lt;span class="cl">0360 79 72 21 cb b4 b9 0a 2a 39 3b d6 ec 61 80 28 a7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">56&lt;/span>&lt;span class="cl">0370 58 c2 f8 ae 6d b6 8b f7 d3 2f ae 1a ee fc 42 fa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">57&lt;/span>&lt;span class="cl">0380 2c b8 de 5c 29 1a 82 df 8f 62 5e 91 6c 65 49 41
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">58&lt;/span>&lt;span class="cl">0390 5a 9f ca a4 a8 07 b8 26 fd ef 1d a9 ce 17 ae c8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">59&lt;/span>&lt;span class="cl">03a0 3b 92 89 00 38 59 9f c9 2a 84 a7 9e 4c 15 3f ce
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">60&lt;/span>&lt;span class="cl">03b0 a9 f8 24 42 0e 3e 18 2b c5 c1 62 3f ea 0c 9a 97
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">61&lt;/span>&lt;span class="cl">03c0 9c 03 92 f4 92 03 c3 4a 0f 83 f7 81 ff 1f 2a 38
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">62&lt;/span>&lt;span class="cl">03d0 2e 22 00 5f dd ef de 63 77 42 0d e7 00 c0 6a c9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">63&lt;/span>&lt;span class="cl">03e0 44 e5 0b c1 59 e2 fd d0 01 5e 79 8b 93 61 41 54
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">64&lt;/span>&lt;span class="cl">03f0 60 fd 65 57 80 b8
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>什麼是 IPv6</title><link>https://chiehting.com/posts/what-is-ipv6/</link><pubDate>Wed, 18 Jun 2025 13:47:21 +0800</pubDate><guid>https://chiehting.com/posts/what-is-ipv6/</guid><description>
&lt;p>IPv6（Internet Protocol version 6）是網際網路協議（IP）的第六版，用於識別和定位網路上的設備，並負責在它們之間傳輸數據。IPv6 使用 128 bit 的地址長度，比起 IPv4 的 32 bit 的地址長度更多。&lt;/p>
&lt;h2 id="ipv6-定義">IPv6 定義&lt;/h2>
&lt;p>假設 IPv6 地址為 2001:0db8:85a3:0000:0000:8a2e:0370:7334&lt;/p>
&lt;h3 id="簡化表示規則">簡化表示規則&lt;/h3>
&lt;p>可簡化表示: 2001:db8:85a3::8a2e:370:7334。&lt;/p>
&lt;ul>
&lt;li>去除連續零，85a3:0000:0000:8a2e 可表示為 85a3::8a2e&lt;/li>
&lt;li>去除前導零，0370 可以表示為 370&lt;/li>
&lt;/ul>
&lt;h3 id="結構分解">結構分解&lt;/h3>
&lt;p>IPv6 地址是一個 &lt;strong>128 位(bit)&lt;/strong> 的地址，以 16 進位表示，分為 8 組，每組 4 個 16 位元(16-bit)，用冒號分隔例如：&lt;code>2001:0db8:85a3:0000:0000:8a2e:0370:7334&lt;/code>，下面表格為 128 位的定義，包括 &lt;code>Global Prefix&lt;/code>、&lt;code>Subnet ID&lt;/code>、&lt;code>Interface ID&lt;/code>。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Global Prefix&lt;/th>
&lt;th>Subnet ID&lt;/th>
&lt;th>Interface ID&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>48 bits&lt;/td>
&lt;td>16 bits&lt;/td>
&lt;td>64 bits&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>以上面地址為例子，其結構如下表。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Global Prefix（48 bits）&lt;/th>
&lt;th>Subnet ID&lt;/th>
&lt;th>Interface ID&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>2001:0db8:85a3&lt;/td>
&lt;td>0000&lt;/td>
&lt;td>0000:8a2e:0370:7334&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>全球路由前綴 (Global Prefix)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>地址的前 &lt;strong>48 位&lt;/strong>，用於標識網路範圍。&lt;/li>
&lt;li>在該地址中：&lt;br>
&lt;strong>&lt;code>2001:0db8:85a3&lt;/code>&lt;/strong> 是全球路由前綴。
&lt;ul>
&lt;li>&lt;code>2001&lt;/code>：表示該地址屬於全球可路由的 IPv6 網段。&lt;/li>
&lt;li>&lt;code>0db8&lt;/code>：是一個特殊的文檔範例前綴（RFC 3849 定義，僅用於教學與測試）。&lt;/li>
&lt;li>&lt;code>85a3&lt;/code>：進一步標識特定網路範圍。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>子網 ID (Subnet ID)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>地址的第 &lt;strong>49 至 64 位&lt;/strong>，用於標識子網。&lt;/li>
&lt;li>在該地址中：&lt;br>
&lt;strong>&lt;code>0000&lt;/code>&lt;/strong> 是子網 ID，表示該地址位於主網或未進行子網劃分。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>接口 ID (Interface ID)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>地址的最後 &lt;strong>64 位&lt;/strong>，用於標識子網內的具體設備（主機）。&lt;/li>
&lt;li>在該地址中：&lt;br>
&lt;strong>&lt;code>0000:8a2e:0370:7334&lt;/code>&lt;/strong> 是接口 ID，通常由設備自動生成或手動配置。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol></description></item><item><title>如何做網際網路的效能測試</title><link>https://chiehting.com/posts/how-to-test-internet-efficiency/</link><pubDate>Thu, 09 May 2024 13:58:56 +0800</pubDate><guid>https://chiehting.com/posts/how-to-test-internet-efficiency/</guid><description>
&lt;p>如何做跨區線路測試，分析兩區域網路傳輸的狀況。例如 ap-southeast-1 到 us-east-1 的網路效率。&lt;/p>
&lt;h3 id="解題方向">解題方向&lt;/h3>
&lt;p>在進行跨區的網路線路測試時，不考慮服務運行時間的情況下，可能會關注以下指標：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>延遲（Latency）&lt;/strong>：延遲是從發送請求到收到響應所需的時間。你會測試不同地區之間的平均延遲、最大延遲和最小延遲，以評估網路的反應速度。可使用工具 &lt;code>ping&lt;/code>、&lt;code>traceroute&lt;/code>、&lt;code>mtr&lt;/code> 來做測試。&lt;/li>
&lt;li>&lt;strong>丟包率（Packet Loss Rate）&lt;/strong>：丟包率是指在網絡傳輸過程中丟失的數據包的比率。你會關注丟包率的高低，因為高丟包率可能導致數據傳輸的不完整和延遲增加。可使用工具 &lt;code>ping&lt;/code>、&lt;code>traceroute&lt;/code>、&lt;code>mtr&lt;/code> 來做測試。&lt;/li>
&lt;li>&lt;strong>頻寬利用率（Bandwidth Utilization）&lt;/strong>：帶寬利用率是指在一定時間內使用的網絡帶寬的比率。你會測試網絡的帶寬利用率，以確保帶寬資源充足並且沒有過度使用。可用工具 &lt;code>iperf&lt;/code>、&lt;code>speedtest-cli&lt;/code>做測試。&lt;/li>
&lt;li>&lt;strong>往返時間（Round-Trip Time，RTT）&lt;/strong>：RTT 是從發送一個數據包到收到對應的響應所需的時間。你會關注不同地區之間的平均 RTT，以評估網路的往返時間。可使用工具 &lt;code>ping&lt;/code>、&lt;code>traceroute&lt;/code>、&lt;code>mtr&lt;/code> 、&lt;code>iperf&lt;/code>來做測試。&lt;/li>
&lt;li>&lt;strong>連通性和穩定性（Connectivity and Stability）&lt;/strong>：你會測試不同地區之間的連通性和穩定性，確保網路連接的可靠性和持久性。可使用工具 &lt;code>ping&lt;/code>、&lt;code>traceroute&lt;/code>、&lt;code>mtr&lt;/code> 來做測試。&lt;/li>
&lt;li>&lt;strong>DNS 解析時間（DNS Resolution Time）&lt;/strong>：DNS 解析時間是指從域名解析請求開始到獲得對應 IP 地址的時間。你會測試 DNS 解析時間，以評估域名解析的效率和穩定性。可使用工具 &lt;code>dig&lt;/code>、&lt;code>nslookup&lt;/code> 來做測試。&lt;/li>
&lt;/ol>
&lt;h3 id="收集資訊">收集資訊&lt;/h3>
&lt;p>DNS Resloutiime Time&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># Google&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# dig @8.8.8.8 example.com &lt;span class="p">|&lt;/span> grep Query
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">;;&lt;/span> Query time: &lt;span class="m">220&lt;/span> msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1"># Cloudflare&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# dig @1.1.1.1 example.com &lt;span class="p">|&lt;/span> grep Query
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="p">;;&lt;/span> Query time: &lt;span class="m">152&lt;/span> msec
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Bandwidth&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># Display a list of speedtest.net servers sorted by distance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# speedtest-cli --list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">Retrieving speedtest.net configuration...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">17336&lt;span class="o">)&lt;/span> ETISALAT-UAE &lt;span class="o">(&lt;/span>Dubai, United Arab Emirates&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>19.67 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">33712&lt;span class="o">)&lt;/span> ETISALAT-UAE &lt;span class="o">(&lt;/span>Sharjah, United Arab Emirates&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>32.80 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">34238&lt;span class="o">)&lt;/span> ETISALAT-UAE &lt;span class="o">(&lt;/span>Ajman, United Arab Emirates&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>42.82 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">11271&lt;span class="o">)&lt;/span> Ooredoo Oman &lt;span class="o">(&lt;/span>Seeb, Oman&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>330.64 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> 6193&lt;span class="o">)&lt;/span> Ooredoo Qatar &lt;span class="o">(&lt;/span>Doha, Qatar&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>379.79 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">36046&lt;span class="o">)&lt;/span> stc Bahrain &lt;span class="o">(&lt;/span>Seef, Bahrain&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>489.93 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">25379&lt;span class="o">)&lt;/span> Mobily &lt;span class="o">(&lt;/span>Khobar, Saudi Arabia&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>526.86 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">16051&lt;span class="o">)&lt;/span> Saudi Telecom Company &lt;span class="o">(&lt;/span>STC&lt;span class="o">)&lt;/span> &lt;span class="o">(&lt;/span>Dammam, Saudi Arabia&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>528.27 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">17373&lt;span class="o">)&lt;/span> Salam &lt;span class="o">(&lt;/span>Dammam, Saudi Arabia&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>528.27 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">24200&lt;span class="o">)&lt;/span> Saudi Telecom Company &lt;span class="o">(&lt;/span>STC&lt;span class="o">)&lt;/span> &lt;span class="o">(&lt;/span>Al Hofuf, Saudi Arabia&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>575.26 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# speedtest-cli
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">Retrieving speedtest.net configuration...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">Testing from Amazon.com &lt;span class="o">(&lt;/span>51.112.52.76&lt;span class="o">)&lt;/span>...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">Retrieving speedtest.net server list...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">Selecting best server based on ping...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">Hosted by ETISALAT-UAE &lt;span class="o">(&lt;/span>Dubai&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>19.67 km&lt;span class="o">]&lt;/span>: 5.772 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">Testing download speed................................................................................
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">Download: 1908.86 Mbit/s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">Testing upload speed......................................................................................................
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">Upload: 1475.68 Mbit/s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Request time&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@ip-172-31-4-174:~# curl -4 -w &amp;#34;@curl-format.txt&amp;#34; -o /dev/null -s https://example.com/api
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">time_namelookup: 0.155062
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">time_connect: 0.351696
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">time_appconnect: 0.586982
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">time_pretransfer: 0.587111
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">time_redirect: 0.000000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">time_starttransfer: 0.781766
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">----------time_total: 0.781826
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>到 Server IP &lt;code>1.2.3.4&lt;/code> 的線路測試&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# traceroute -T 1.2.3.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">traceroute to 1.2.3.4 &lt;span class="o">(&lt;/span>1.2.3.4&lt;span class="o">)&lt;/span>, &lt;span class="m">30&lt;/span> hops max, &lt;span class="m">60&lt;/span> byte packets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="m">1&lt;/span> * * *
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="m">2&lt;/span> 240.1.24.4 &lt;span class="o">(&lt;/span>240.1.24.4&lt;span class="o">)&lt;/span> 0.211 ms 240.1.24.5 &lt;span class="o">(&lt;/span>240.1.24.5&lt;span class="o">)&lt;/span> 0.225 ms 0.486 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="m">3&lt;/span> 242.3.43.1 &lt;span class="o">(&lt;/span>242.3.43.1&lt;span class="o">)&lt;/span> 3.451 ms 242.3.43.5 &lt;span class="o">(&lt;/span>242.3.43.5&lt;span class="o">)&lt;/span> 2.972 ms 242.3.42.7 &lt;span class="o">(&lt;/span>242.3.42.7&lt;span class="o">)&lt;/span> 2.963 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="m">4&lt;/span> 52.93.68.29 &lt;span class="o">(&lt;/span>52.93.68.29&lt;span class="o">)&lt;/span> 1.320 ms 52.93.68.79 &lt;span class="o">(&lt;/span>52.93.68.79&lt;span class="o">)&lt;/span> 8.062 ms 52.93.68.97 &lt;span class="o">(&lt;/span>52.93.68.97&lt;span class="o">)&lt;/span> 0.557 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl"> &lt;span class="m">5&lt;/span> 100.91.177.167 &lt;span class="o">(&lt;/span>100.91.177.167&lt;span class="o">)&lt;/span> 190.061 ms 100.106.85.41 &lt;span class="o">(&lt;/span>100.106.85.41&lt;span class="o">)&lt;/span> 191.664 ms 100.91.176.251 &lt;span class="o">(&lt;/span>100.91.176.251&lt;span class="o">)&lt;/span> 190.035 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl"> &lt;span class="m">6&lt;/span> * 240.0.184.13 &lt;span class="o">(&lt;/span>240.0.184.13&lt;span class="o">)&lt;/span> 1860.666 ms 240.0.236.34 &lt;span class="o">(&lt;/span>240.0.236.34&lt;span class="o">)&lt;/span> 1901.460 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl"> &lt;span class="m">7&lt;/span> 242.2.212.33 &lt;span class="o">(&lt;/span>242.2.212.33&lt;span class="o">)&lt;/span> 191.295 ms 242.3.84.161 &lt;span class="o">(&lt;/span>242.3.84.161&lt;span class="o">)&lt;/span> 192.339 ms 242.3.85.33 &lt;span class="o">(&lt;/span>242.3.85.33&lt;span class="o">)&lt;/span> 191.432 ms
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# mtr -b -T -r -c &lt;span class="m">30&lt;/span> 1.2.3.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Start: 2024-05-09T10:16:58+0000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">HOST: ip-172-31-41-190 Loss% Snt Last Avg Best Wrst StDev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> 1.&lt;span class="p">|&lt;/span>-- ??? 100.0 &lt;span class="m">30&lt;/span> 0.0 0.0 0.0 0.0 0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> 2.&lt;span class="p">|&lt;/span>-- 240.1.24.5 0.0% &lt;span class="m">30&lt;/span> 0.3 0.3 0.3 0.4 0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> 240.1.24.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> 240.1.24.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> 240.1.24.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> 3.&lt;span class="p">|&lt;/span>-- 242.3.42.135 0.0% &lt;span class="m">30&lt;/span> 2.8 5.7 2.5 20.4 5.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> 242.3.42.129
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> 242.3.43.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> 242.3.43.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> 242.3.43.133
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> 242.3.43.131
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> 242.3.43.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> 242.3.42.131
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> 4.&lt;span class="p">|&lt;/span>-- 52.93.68.95 0.0% &lt;span class="m">30&lt;/span> 0.7 4.7 0.6 21.9 5.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> 52.93.68.93
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> 52.93.68.45
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> 52.93.68.125
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> 52.93.68.79
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> 52.93.68.129
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> 52.93.68.143
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> 52.93.68.65
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> 5.&lt;span class="p">|&lt;/span>-- 100.106.85.13 0.0% &lt;span class="m">30&lt;/span> 193.4 193.8 190.2 211.9 5.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> 100.91.177.73
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> 100.91.176.243
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> 100.91.177.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> 100.91.176.221
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> 100.91.177.93
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> 100.106.86.73
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> 100.106.85.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> 100.91.177.113
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# iperf3 -t &lt;span class="m">30&lt;/span> -c 1.2.3.4 -p &lt;span class="m">31987&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Connecting to host 1.2.3.4, port &lt;span class="m">31987&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> &lt;span class="nb">local&lt;/span> 172.31.41.190 port &lt;span class="m">42998&lt;/span> connected to 1.2.3.4 port &lt;span class="m">31987&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> ID&lt;span class="o">]&lt;/span> Interval Transfer Bitrate Retr Cwnd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 0.00-1.00 sec 2.25 MBytes 18.9 Mbits/sec &lt;span class="m">0&lt;/span> &lt;span class="m">440&lt;/span> KBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 1.00-2.00 sec 9.81 MBytes 82.3 Mbits/sec &lt;span class="m">61&lt;/span> 3.88 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 2.00-3.00 sec 10.0 MBytes 83.9 Mbits/sec &lt;span class="m">303&lt;/span> 2.84 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 3.00-4.00 sec 13.8 MBytes &lt;span class="m">115&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 4.00-5.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 5.00-6.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 6.00-7.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 7.00-8.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 8.00-9.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 9.00-10.00 sec 13.8 MBytes &lt;span class="m">115&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 10.00-11.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 11.00-12.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 12.00-13.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 13.00-14.00 sec 13.8 MBytes &lt;span class="m">115&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 14.00-15.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 15.00-16.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 16.00-17.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 17.00-18.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 18.00-19.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 19.00-20.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 20.00-21.00 sec 13.8 MBytes &lt;span class="m">115&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 21.00-22.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 22.00-23.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 23.00-24.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 24.00-25.00 sec 13.8 MBytes &lt;span class="m">115&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 25.00-26.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 26.00-27.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 27.00-28.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 28.00-29.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 29.00-30.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl">- - - - - - - - - - - - - - - - - - - - - - - - -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> ID&lt;span class="o">]&lt;/span> Interval Transfer Bitrate Retr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 0.00-30.00 sec &lt;span class="m">430&lt;/span> MBytes &lt;span class="m">120&lt;/span> Mbits/sec &lt;span class="m">364&lt;/span> sender
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 0.00-30.19 sec &lt;span class="m">429&lt;/span> MBytes &lt;span class="m">119&lt;/span> Mbits/sec receiver
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>DNS resolution takes a long time</title><link>https://chiehting.com/posts/dns-resolution-long-time/</link><pubDate>Fri, 19 Apr 2024 10:00:19 +0800</pubDate><guid>https://chiehting.com/posts/dns-resolution-long-time/</guid><description>
&lt;p>最近發現 CI/CD 流程中一直發生異常通知，異常的失敗率達 50%，排查之後發現是 DNS 解析異常導致流程無法順利執行。由於伺服器在內地，所以最後將 DNS 服務器更換成百度的服務器，當下異常問題則排除，後續持續做觀察。&lt;/p>
&lt;h3 id="evergreen-note">Evergreen Note&lt;/h3>
&lt;p>Question :: 這篇文章主要在說什麼?&lt;/p>
&lt;p>Answer :: 在排除 DNS 解析過慢的問題。這次的問題是阿里雲的 DNS 伺服器很慢甚至沒回應（這邊不討論阿里雲怎麼了，但...），所以要選用好的 DNS 伺服器，我通常是用 Google 的 &lt;code>8.8.8.8&lt;/code>，但是在牆內不是一個好的決定，經過一波測試後，最後選擇使用百度雲的 DNS 伺服器。&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;h4 id="log-analysis">Log analysis&lt;/h4>
&lt;p>這兩天一直發生 CI/CD 異常問題時好時壞。發生的太過頻繁近 20 筆資料的錯誤率達（10 error/20 tirgger）50%，覺得可能不是公司內部網路的問題，於是就查看了服務的 log，兩個服務的錯誤原因皆是 DNS 解析異常。&lt;/p>
&lt;p>GitLab log 上顯示異常原因為 DNS 解析異常，下面列出一筆 log 資訊。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">curl: (6) Could not resolve host: hooks.slack.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Harbor log 上顯示異常原因為 DNS 解析異常，下面列出一筆 log 資訊。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">2024-04-18T02:50:02Z [ERROR] [/controller/replication/transfer/image/transfer.go:335]::: dial tcp: lookup swr.cn-east-3.myhuaweicloud.com: No address associated with hostname
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="dns-resolve">DNS resolve&lt;/h4>
&lt;p>預設是使用阿里雲的 DNS 解析服務器 &lt;code>233.5.5.5&lt;/code>，看到解析不是超時就是過慢（約莫 1 min）。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@infra:~# resolvectl dns eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">Link 4 (eno1): 233.5.5.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">root@infra:~# resolvectl query hooks.slack.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">hooks.slack.com: resolve call failed: All attempts to contact name servers or networks failed
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>下意識就更換了 Google 的 DNS 解析服務器 &lt;code>8.8.8.8&lt;/code>，解析時間時好時壞（約莫 25.6ms ~ 1 min），也不知道取決於什麼。但是在牆內用 Google DNS 解析可能不是好的選則。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@infra:~# resolvectl dns eno1 8.8.8.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">root@infra:~# resolvectl dns eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">Link 4 (eno1): 8.8.8.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">root@infra:~# resolvectl query hooks.slack.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">hooks.slack.com: 52.192.46.121 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> 52.196.128.139 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> 35.74.58.174 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> 35.73.126.78 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">-- Information acquired via protocol DNS in 25.6ms.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">-- Data is authenticated: no; Data was acquired via local or encrypted transport: no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">-- Data from: network
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>下面更換了百度的 DNS 解析服務器 &lt;code>180.76.76.76&lt;/code>，效果就好很多，幾乎在 200 ms 內回覆，所以就決定是你了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@infra:~# resolvectl dns eno1 180.76.76.76
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">root@infra:~# resolvectl dns eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">Link 4 (eno1): 180.76.76.76
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">root@infra:~# resolvectl query hooks.slack.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">hooks.slack.com: 35.74.58.174 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> 35.73.126.78 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> 52.196.128.139 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> 52.192.46.121 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">-- Information acquired via protocol DNS in 11.9ms.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">-- Data is authenticated: no; Data was acquired via local or encrypted transport: no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">-- Data from: cache network
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>rfc6265</title><link>https://chiehting.com/posts/internet-rfc-6265-server-requirements/</link><pubDate>Fri, 16 Feb 2024 11:28:57 +0800</pubDate><guid>https://chiehting.com/posts/internet-rfc-6265-server-requirements/</guid><description>
&lt;p>文章是在導讀 Set-Cookie header fields 規範以及重要屬性。&lt;/p>
&lt;h3 id="referances">Referances&lt;/h3>
&lt;p>&lt;a href="https://www.rfc-editor.org/rfc/rfc6265.html#section-4">HTTP State Management Mechanism&lt;/a>&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>第四章節是在說明 Set-Cookie 的方式，其中關鍵字為 &lt;code>Set-Cookie&lt;/code>，將 Set-Cookie 加到 response header 內容中，其格式是使用 name-value-pair，並返回給 user agent。&lt;/p>
&lt;p>user agent 收到 Set-Cookie 後會保存其資料，如果該資料已經存在則會覆蓋。這邊也建議伺服器將資料內容做編碼，例如 base64。&lt;/p>
&lt;p>在 4.1.2 的章節中有幾個重要的屬性，條列如下：&lt;/p>
&lt;p>4.1.2.1. The Expires Attribute：定義 Cookies 的過期時間，過期後則不保留 cookie。&lt;/p>
&lt;p>4.1.2.2. The Max-Age Attribute：定義 Cookies 的保留日期，過期後則不保留 cookie。&lt;/p>
&lt;p>4.1.2.3. The Domain Attribute：定義 Cookies 的域名。&lt;/p>
&lt;blockquote>
&lt;p>For example, if the value of the Domain attribute is
&amp;quot;example.com&amp;quot;, the user agent will include the cookie in the Cookie
header when making HTTP requests to example.com, &lt;a href="https://www.example.com">www.example.com&lt;/a>, and
&lt;a href="https://www.corp.example.com">www.corp.example.com&lt;/a>.&lt;/p>
&lt;/blockquote>
&lt;p>4.1.2.4. The Path Attribute：定義 Cookies 的路徑。配置 Path Attribute 後，就只會在指定的路徑中做 Cookies 的交互。&lt;/p>
&lt;p>4.1.2.5. The Secure Attribute：限制 Cookies 只能在 &amp;quot;安全&amp;quot; 頻道中做傳輸。配置 Secure Attribute 後，就只能在 HTTPS 的請求中做 Cookies 的交互。&lt;/p>
&lt;p>4.1.2.6. The HttpOnly Attribute：限制 Cookies 的存取方式。配置 HttpOnly Attribute 後，就只能使用 http 請求做 Cookies 的存取，否則會被省略，例如無法使用 javascript 來存取 Cookies 的內容。&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.rfc-editor.org/rfc/rfc6265.html#section-4">rfc6265&lt;/a>&lt;/p>
&lt;h4 id="4-server-requirements">4. Server Requirements&lt;/h4>
&lt;p>This section describes the syntax and semantics of a well-behaved
profile of the Cookie and Set-Cookie headers.&lt;/p>
&lt;p>4.1. Set-Cookie&lt;/p>
&lt;p>The Set-Cookie HTTP response header is used to send cookies from the
server to the user agent.&lt;/p>
&lt;p>4.1.1. Syntax&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red"> Informally, the Set-Cookie response header contains the header name
&amp;quot;Set-Cookie&amp;quot; followed by a &amp;quot;:&amp;quot; and a cookie.&lt;/span> Each cookie begins with
a name-value-pair, followed by zero or more attribute-value pairs.
Servers SHOULD NOT send Set-Cookie headers that fail to conform to
the following grammar:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">set-cookie-header = &amp;#34;Set-Cookie:&amp;#34; SP set-cookie-string
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">set-cookie-string = cookie-pair *( &amp;#34;;&amp;#34; SP cookie-av )
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">cookie-pair = cookie-name &amp;#34;=&amp;#34; cookie-value
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">cookie-name = token
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">cookie-value = *cookie-octet / ( DQUOTE *cookie-octet DQUOTE )
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">cookie-octet = %x21 / %x23-2B / %x2D-3A / %x3C-5B / %x5D-7E
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> ; US-ASCII characters excluding CTLs,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> ; whitespace DQUOTE, comma, semicolon,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> ; and backslash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">token = &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">token&lt;/span>&lt;span class="err">,&lt;/span> &lt;span class="na">defined&lt;/span> &lt;span class="na">in&lt;/span> &lt;span class="err">[&lt;/span>&lt;span class="na">RFC2616&lt;/span>&lt;span class="err">],&lt;/span> &lt;span class="na">Section&lt;/span> &lt;span class="na">2&lt;/span>&lt;span class="err">.&lt;/span>&lt;span class="na">2&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">cookie-av = expires-av / max-age-av / domain-av /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> path-av / secure-av / httponly-av /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> extension-av
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">expires-av = &amp;#34;Expires=&amp;#34; sane-cookie-date
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">sane-cookie-date = &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">rfc1123-date&lt;/span>&lt;span class="err">,&lt;/span> &lt;span class="na">defined&lt;/span> &lt;span class="na">in&lt;/span> &lt;span class="err">[&lt;/span>&lt;span class="na">RFC2616&lt;/span>&lt;span class="err">],&lt;/span> &lt;span class="na">Section&lt;/span> &lt;span class="na">3&lt;/span>&lt;span class="err">.&lt;/span>&lt;span class="na">3&lt;/span>&lt;span class="err">.&lt;/span>&lt;span class="na">1&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">max-age-av = &amp;#34;Max-Age=&amp;#34; non-zero-digit *DIGIT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> ; In practice, both expires-av and max-age-av
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> ; are limited to dates representable by the
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> ; user agent.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">non-zero-digit = %x31-39
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> ; digits 1 through 9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">domain-av = &amp;#34;Domain=&amp;#34; domain-value
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">domain-value = &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">subdomain&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> ; defined in [RFC1034], Section 3.5, as
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> ; enhanced by [RFC1123], Section 2.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">path-av = &amp;#34;Path=&amp;#34; path-value
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">path-value = &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">any&lt;/span> &lt;span class="na">CHAR&lt;/span> &lt;span class="na">except&lt;/span> &lt;span class="na">CTLs&lt;/span> &lt;span class="na">or&lt;/span> &lt;span class="err">&amp;#34;;&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">secure-av = &amp;#34;Secure&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">httponly-av = &amp;#34;HttpOnly&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">extension-av = &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">any&lt;/span> &lt;span class="na">CHAR&lt;/span> &lt;span class="na">except&lt;/span> &lt;span class="na">CTLs&lt;/span> &lt;span class="na">or&lt;/span> &lt;span class="err">&amp;#34;;&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Note that some of the grammatical terms above reference documents
that use different grammatical notations than this document (which
uses ABNF from [RFC5234]).&lt;/p>
&lt;p>The semantics of the cookie-value are not defined by this document.&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">To maximize compatibility with user agents, servers that wish to
store arbitrary data in a cookie-value SHOULD encode that data, for
example, using Base64 [RFC4648].&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The portions of the set-cookie-string produced by the cookie-av term
are known as attributes. To maximize compatibility with user agents,
servers SHOULD NOT produce two attributes with the same name in the
same set-cookie-string. (See Section 5.3 for how user agents handle
this case.)&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">Servers SHOULD NOT include more than one Set-Cookie header field in
the same response with the same cookie-name. (See Section 5.2 for
how user agents handle this case.)&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">If a server sends multiple responses containing Set-Cookie headers
concurrently to the user agent (e.g., when communicating with the
user agent over multiple sockets), these responses create a &amp;quot;race
condition&amp;quot; that can lead to unpredictable behavior.&lt;/span>&lt;/p>
&lt;p>NOTE: Some existing user agents differ in their interpretation of
two-digit years. To avoid compatibility issues, servers SHOULD use
the rfc1123-date format, which requires a four-digit year.&lt;/p>
&lt;p>NOTE: Some user agents store and process dates in cookies as 32-bit
UNIX time_t values. Implementation bugs in the libraries supporting
time_t processing on some systems might cause such user agents to
process dates after the year 2038 incorrectly.&lt;/p>
&lt;p>4.1.2. Semantics (Non-Normative)&lt;/p>
&lt;p>This section describes simplified semantics of the Set-Cookie header.
These semantics are detailed enough to be useful for understanding
the most common uses of cookies by servers. The full semantics are
described in Section 5.&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">When the user agent receives a Set-Cookie header, the user agent
stores the cookie together with its attributes. Subsequently, when
the user agent makes an HTTP request, the user agent includes the
applicable, non-expired cookies in the Cookie header.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">If the user agent receives a new cookie with the same cookie-name,
domain-value, and path-value as a cookie that it has already stored,
the existing cookie is evicted and replaced with the new cookie.
Notice that servers can delete cookies by sending the user agent a
new cookie with an Expires attribute with a value in the past.&lt;/span>&lt;/p>
&lt;p>Unless the cookie's attributes indicate otherwise, the cookie is
returned only to the origin server (and not, for example, to any
subdomains), and it expires at the end of the current session (as
defined by the user agent). User agents ignore unrecognized cookie
attributes (but not the entire cookie).&lt;/p>
&lt;p>4.1.2.1. The Expires Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The Expires attribute indicates the maximum lifetime of the cookie,
represented as the date and time at which the cookie expires. The
user agent is not required to retain the cookie until the specified
date has passed. In fact, user agents often evict cookies due to
memory pressure or privacy concerns.&lt;/span>&lt;/p>
&lt;p>4.1.2.2. The Max-Age Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red"> The Max-Age attribute indicates the maximum lifetime of the cookie,
represented as the number of seconds until the cookie expires. The
user agent is not required to retain the cookie for the specified
duration. In fact, user agents often evict cookies due to memory
pressure or privacy concerns.&lt;/span>&lt;/p>
&lt;pre>&lt;code> NOTE: Some existing user agents do not support the Max-Age
attribute. User agents that do not support the Max-Age attribute
ignore the attribute.
&lt;/code>&lt;/pre>
&lt;p>If a cookie has both the Max-Age and the Expires attribute, the Max-
Age attribute has precedence and controls the expiration date of the
cookie. If a cookie has neither the Max-Age nor the Expires
attribute, the user agent will retain the cookie until &amp;quot;the current
session is over&amp;quot; (as defined by the user agent).&lt;/p>
&lt;p>4.1.2.3. The Domain Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The Domain attribute specifies those hosts to which the cookie will
be sent. For example, if the value of the Domain attribute is
&amp;quot;example.com&amp;quot;, the user agent will include the cookie in the Cookie
header when making HTTP requests to example.com, &lt;a href="https://www.example.com">www.example.com&lt;/a>, and
&lt;a href="https://www.corp.example.com">www.corp.example.com&lt;/a>.&lt;/span> (Note that a leading %x2E (&amp;quot;.&amp;quot;), if present,
is ignored even though that character is not permitted, but a
trailing %x2E (&amp;quot;.&amp;quot;), if present, will cause the user agent to ignore
the attribute.) If the server omits the Domain attribute, the user
agent will return the cookie only to the origin server.&lt;/p>
&lt;pre>&lt;code> WARNING: Some existing user agents treat an absent Domain
attribute as if the Domain attribute were present and contained
the current host name. For example, if example.com returns a Set-
Cookie header without a Domain attribute, these user agents will
erroneously send the cookie to www.example.com as well.
&lt;/code>&lt;/pre>
&lt;p>The user agent will reject cookies unless the Domain attribute
specifies a scope for the cookie that would include the origin
server. For example, the user agent will accept a cookie with a
Domain attribute of &amp;quot;example.com&amp;quot; or of &amp;quot;foo.example.com&amp;quot; from
foo.example.com, but the user agent will not accept a cookie with a
Domain attribute of &amp;quot;bar.example.com&amp;quot; or of &amp;quot;baz.foo.example.com&amp;quot;.&lt;/p>
&lt;p>NOTE: For security reasons, many user agents are configured to reject
Domain attributes that correspond to &amp;quot;public suffixes&amp;quot;. For example,
some user agents will reject Domain attributes of &amp;quot;com&amp;quot; or &amp;quot;co.uk&amp;quot;.
(See Section 5.3 for more information.)&lt;/p>
&lt;p>4.1.2.4. The Path Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The scope of each cookie is limited to a set of paths, controlled by
the Path attribute. If the server omits the Path attribute, the user
agent will use the &amp;quot;directory&amp;quot; of the request-uri's path component as
the default value. (See Section 5.1.4 for more details.)&lt;/span>&lt;/p>
&lt;p>The user agent will include the cookie in an HTTP request only if the
path portion of the request-uri matches (or is a subdirectory of) the
cookie's Path attribute, where the %x2F (&amp;quot;/&amp;quot;) character is
interpreted as a directory separator.&lt;/p>
&lt;p>Although seemingly useful for isolating cookies between different
paths within a given host, the Path attribute cannot be relied upon
for security (see Section 8).&lt;/p>
&lt;p>4.1.2.5. The Secure Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The Secure attribute limits the scope of the cookie to &amp;quot;secure&amp;quot;
channels (where &amp;quot;secure&amp;quot; is defined by the user agent). When a
cookie has the Secure attribute, the user agent will include the
cookie in an HTTP request only if the request is transmitted over a
secure channel (typically HTTP over Transport Layer Security (TLS)
[RFC2818]).&lt;/span>&lt;/p>
&lt;p>Although seemingly useful for protecting cookies from active network
attackers, the Secure attribute protects only the cookie's
confidentiality. An active network attacker can overwrite Secure
cookies from an insecure channel, disrupting their integrity (see
Section 8.6 for more details).&lt;/p>
&lt;p>4.1.2.6. The HttpOnly Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The HttpOnly attribute limits the scope of the cookie to HTTP
requests. In particular, the attribute instructs the user agent to
omit the cookie when providing access to cookies via &amp;quot;non-HTTP&amp;quot; APIs
(such as a web browser API that exposes cookies to scripts).&lt;/span>&lt;/p>
&lt;p>Note that the HttpOnly attribute is independent of the Secure
attribute: a cookie can have both the HttpOnly and the Secure
attribute.&lt;/p>
&lt;p>4.2. Cookie&lt;/p>
&lt;p>4.2.1. Syntax&lt;/p>
&lt;p>The user agent sends stored cookies to the origin server in the
Cookie header. If the server conforms to the requirements in
Section 4.1 (and the user agent conforms to the requirements in
Section 5), the user agent will send a Cookie header that conforms to
the following grammar:&lt;/p>
&lt;p>cookie-header = &amp;quot;Cookie:&amp;quot; OWS cookie-string OWS
cookie-string = cookie-pair *( &amp;quot;;&amp;quot; SP cookie-pair )&lt;/p>
&lt;p>4.2.2. Semantics&lt;/p>
&lt;p>Each cookie-pair represents a cookie stored by the user agent. The
cookie-pair contains the cookie-name and cookie-value the user agent
received in the Set-Cookie header.&lt;/p>
&lt;p>Notice that the cookie attributes are not returned. In particular,
the server cannot determine from the Cookie header alone when a
cookie will expire, for which hosts the cookie is valid, for which
paths the cookie is valid, or whether the cookie was set with the
Secure or HttpOnly attributes.&lt;/p>
&lt;p>The semantics of individual cookies in the Cookie header are not
defined by this document. Servers are expected to imbue these
cookies with application-specific semantics.&lt;/p>
&lt;p>Although cookies are serialized linearly in the Cookie header,
servers SHOULD NOT rely upon the serialization order. In particular,
if the Cookie header contains two cookies with the same name (e.g.,
that were set with different Path or Domain attributes), servers
SHOULD NOT rely upon the order in which these cookies appear in the
header.&lt;/p></description></item><item><title>rfc6265</title><link>https://chiehting.com/posts/internet-rfc-6265/</link><pubDate>Fri, 16 Feb 2024 11:28:57 +0800</pubDate><guid>https://chiehting.com/posts/internet-rfc-6265/</guid><description>
&lt;p>文章主要在研究 RFC 6265 - HTTP State Management Mechanism。文章是在定義 HTTP Cookie and Set-Cookie header fields 規範。&lt;/p>
&lt;h3 id="referances">Referances&lt;/h3>
&lt;p>&lt;a href="https://www.rfc-editor.org/rfc/rfc6265.txt">RFC 6265&lt;/a>&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>RFC 6265 - HTTP State Management Mechanism 是在定義 HTTP Cookies and Set-Cookie header fields。Cookie 是 Server / Client 資料交互的方法之一，是 developers of cookie-
generating servers 和 developers of cookie-consuming user agents 需要關心的重要議題。&lt;/p>
&lt;p>第四章節在說明 Set-Cookie header fields 規範以及重要屬性 ([[internet-rfc-6265-server-requirements]])。&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.rfc-editor.org/info/rfc6265">rfc6265&lt;/a>&lt;/p>
&lt;h4 id="abstract">Abstract&lt;/h4>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">This document defines the HTTP Cookie and Set-Cookie header fields. These header fields can be used by HTTP servers to store state (called cookies) at HTTP user agents, letting the servers maintain a stateful session over the mostly stateless HTTP protocol.&lt;/span> Although cookies have many historical infelicities that degrade their security and privacy, the Cookie and Set-Cookie header fields are widely used on the Internet. This document obsoletes RFC 2965. [STANDARDS-TRACK]&lt;/p>
&lt;p>Table of Contents&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">1. Introduction
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">2. Conventions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> 2.1. Conformance Criteria
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> 2.2. Syntax Notation
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> 2.3. Terminology
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">3. Overview
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> 3.1. Examples
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">4. Server Requirements
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> 4.1. Set-Cookie
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> 4.1.1. Syntax
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> 4.1.2. Semantics (Non-Normative)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> 4.2. Cookie
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> 4.2.1. Syntax
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> 4.2.2. Semantics
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">5. User Agent Requirements
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> 5.1. Subcomponent Algorithms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> 5.1.1. Dates
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> 5.1.2. Canonicalized Host Names
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> 5.1.3. Domain Matching
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> 5.1.4. Paths and Path-Match
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> 5.2. The Set-Cookie Header
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> 5.2.1. The Expires Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> 5.2.2. The Max-Age Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> 5.2.3. The Domain Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> 5.2.4. The Path Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> 5.2.5. The Secure Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> 5.2.6. The HttpOnly Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> 5.3. Storage Model
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> 5.4. The Cookie Header
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">6. Implementation Considerations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> 6.1. Limits
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> 6.2. Application Programming Interfaces
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> 6.3. IDNA Dependency and Migration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">7. Privacy Considerations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl"> 7.1. Third-Party Cookies
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl"> 7.2. User Controls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl"> 7.3. Expiration Dates
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl">8. Security Considerations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl"> 8.1. Overview
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl"> 8.2. Ambient Authority
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">41&lt;/span>&lt;span class="cl"> 8.3. Clear Text
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">42&lt;/span>&lt;span class="cl"> 8.4. Session Identifiers
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">43&lt;/span>&lt;span class="cl"> 8.5. Weak Confidentiality
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">44&lt;/span>&lt;span class="cl"> 8.6. Weak Integrity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">45&lt;/span>&lt;span class="cl"> 8.7. Reliance on DNS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">46&lt;/span>&lt;span class="cl">9. IANA Considerations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">47&lt;/span>&lt;span class="cl"> 9.1. Cookie
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">48&lt;/span>&lt;span class="cl"> 9.2. Set-Cookie
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">49&lt;/span>&lt;span class="cl"> 9.3. Cookie2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">50&lt;/span>&lt;span class="cl"> 9.4. Set-Cookie2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">51&lt;/span>&lt;span class="cl">10. References
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">52&lt;/span>&lt;span class="cl"> 10.1. Normative References
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">53&lt;/span>&lt;span class="cl"> 10.2. Informative References
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">54&lt;/span>&lt;span class="cl">Appendix A. Acknowledgements
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="introduction">Introduction&lt;/h4>
&lt;p>This document defines the HTTP Cookie and Set-Cookie header fields.
&lt;span style="background-color: #ffffcc; color: red">Using the Set-Cookie header field, an HTTP server can pass name/value
pairs and associated metadata (called cookies) to a user agent. When
the user agent makes subsequent requests to the server, the user
agent uses the metadata and other information to determine whether to
return the name/value pairs in the Cookie header.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">Although simple on their surface, cookies have a number of
complexities. For example, the server indicates a scope for each
cookie when sending it to the user agent. The scope indicates the
maximum amount of time in which the user agent should return the
cookie, the servers to which the user agent should return the cookie,
and the URI schemes for which the cookie is applicable.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">For historical reasons, cookies contain a number of security and
privacy infelicities. For example, a server can indicate that a
given cookie is intended for &amp;quot;secure&amp;quot; connections, but the Secure
attribute does not provide integrity in the presence of an active
network attacker. Similarly, cookies for a given host are shared
across all the ports on that host, even though the usual &amp;quot;same-origin
policy&amp;quot; used by web browsers isolates content retrieved via different
ports.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">There are two audiences for this specification: developers of cookie-
generating servers and developers of cookie-consuming user agents.&lt;/span>&lt;/p>
&lt;p>To maximize interoperability with user agents, servers SHOULD limit
themselves to the well-behaved profile defined in Section 4 when
generating cookies.&lt;/p>
&lt;p>User agents MUST implement the more liberal processing rules defined
in Section 5, in order to maximize interoperability with existing
servers that do not conform to the well-behaved profile defined in
Section 4.&lt;/p>
&lt;p>This document specifies the syntax and semantics of these headers as
they are actually used on the Internet. In particular, this document
does not create new syntax or semantics beyond those in use today.
The recommendations for cookie generation provided in Section 4
represent a preferred subset of current server behavior, and even the
more liberal cookie processing algorithm provided in Section 5 does
not recommend all of the syntactic and semantic variations in use
today. Where some existing software differs from the recommended
protocol in significant ways, the document contains a note explaining
the difference.&lt;/p></description></item><item><title>資安團隊的建議回饋</title><link>https://chiehting.com/posts/security-session-and-cookise/</link><pubDate>Fri, 16 Feb 2024 11:28:57 +0800</pubDate><guid>https://chiehting.com/posts/security-session-and-cookise/</guid><description>
&lt;p>資安小組回饋了些建議，讓我們可以強化安全線。主要回報內容為 Session 跟 Cookie 的配置項。&lt;/p>
&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>This document defines the HTTP Cookie and Set-Cookie header fields.&lt;a href="https://www.rfc-editor.org/info/rfc6265">&lt;/a>&lt;/li>
&lt;/ol>
&lt;h3 id="專案被回饋資安-issue資安回饋的建議大致如下">專案被回饋資安 issue，資安回饋的建議大致如下：&lt;/h3>
&lt;ol>
&lt;li>檢視認證 Session 的資料長度，64bit 以上為安全線。 若 Session ID 的長度、複雜度不夠， 可 能被攻擊者猜測 、利用 。&lt;/li>
&lt;li>檢視 Cookie Flag 相關設定 Host Only、Secure、HTTP Only。
&lt;ol>
&lt;li>Host Only：Cookie 只能傳送至 Domain 屬性完全對應的網域 ，不傳送至子網域。&lt;/li>
&lt;li>Secure：只在 HTTPS 連線中傳遞 Cookie 。&lt;/li>
&lt;li>HTTP Only：防止 Cookie 被 Ja v aScript 存取。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;p>上面的問題，通常可以透過瀏覽器的開發工具來檢視是否符合，通常服務都會有配置可以設定。回報的內容是建議可以開啟 Cookies 的配置，例如 HTTP only、Secure，其定義在文章 [[internet-rfc-6265]]。&lt;/p></description></item><item><title>Laravel 框架產生的 cookie XSRF-TOKEN 需不需要使用 HttpOnly</title><link>https://chiehting.com/posts/laravel-xsrf-token-needless-httponly/</link><pubDate>Thu, 27 Jul 2023 17:02:44 +0800</pubDate><guid>https://chiehting.com/posts/laravel-xsrf-token-needless-httponly/</guid><description>
&lt;p>Question :: Does a CSRF cookie need to be HttpOnly such as XSRF-TOKEN cookie from Laravel.&lt;/p>
&lt;p>Answer :: CSRF cookie 可以不用使用 HttpOnly flag([[internet-rfc-6265-server-requirements]]), 因為 HttpOnly flag 保護的前提下已經是被 XSS([[cross-site-scripting]]) 攻擊, 同域的狀況下 CSRF cookie 已經失去其保護作用. 而且 XSS is a much bigger hole than CSRF. 所以 Laravel 產生的 XSRF-TOKEN cookie 可以不使用 HttpOnly flag.&lt;/p>
&lt;h3 id="referances">Referances&lt;/h3>
&lt;p>&lt;a href="https://security.stackexchange.com/questions/175536/does-a-csrf-cookie-need-to-be-httponly">Does a CSRF cookie need to be HttpOnly?&lt;/a>&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>這篇再討論防止 Cross Site Request Forgery(CSRF) 使用的 cookie 需不需要使用 HttpOnly. 像是 Laravel 框架中的 XSRF-TOKEN. 要理解這個問題, 首先要先釐清 CSRF 與 Cookie HttpOnly 的作用.&lt;/p>
&lt;p>CSRF 攻擊是惡意網站偽造我的網站並發送請求到我的服務, 一般情況下會透過用戶的瀏覽器發送請求, 所以儲存在用戶上的 cookie 也都會被帶上, 我的服務就會判定就是該用戶的請求. 而 CSRF token 則可以保護我的服務收到的請求都是同域, 因為跨域取不到 CSRF token.&lt;/p>
&lt;p>Cookie 的 HttpOnly flag 其目的是防止 Javascript 可以讀寫 cookie, 透過禁用 &lt;code>document.cookie&lt;/code> 的方式防止某些攻擊, 例如 Cross-Site Scripting(XSS) 攻擊時其更難執行. XSS 會注入攻擊碼至我的服務中, 使我的服務執行攻擊腳本, 進而對用戶造成傷害.&lt;/p>
&lt;p>現在回到 XSRF-TOKEN 需不需要使用 HttpOnly. 由於 XSRF-TOKEN 是防止跨站攻擊, HttpOnly flag 是 XSS 後防止 JS 竊取. 所以已經被 XSS 的話 XSRF-TOKEN 應該就失去保護之目的了, 因為是同域. 在被 XSS 的情況下, 攻擊者已經沒有竊取 XSRF-TOKEN 的必要, 因為每次請求用戶瀏覽器都會帶上; 攻擊者已經沒有改寫 XSRF-TOKEN 的必要, 因為改寫了用戶請求就會失敗. 所以 XSRF-TOKEN 可以不用 HttpOnly flag.&lt;/p>
&lt;p>另外 &lt;a href="https://laravel.com/docs/10.x/csrf#csrf-x-xsrf-token">Laravel 文件&lt;/a> 也明確表明 XSRF-TOKEN 創建是為了給 JavaScript 框架或套件使用的, 用於在同域下設置表頭 X-XSRF-TOKEN, 所以理應要給 JavaScript 讀取. Laravel 框架下產生的 XSRF-TOKEN 可以不用 HttpOnly flag.&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://security.stackexchange.com/questions/175536/does-a-csrf-cookie-need-to-be-httponly">Does a CSRF cookie need to be HttpOnly?&lt;/a>&lt;/p>
&lt;p>We were recently handed a security report containing the following:&lt;/p>
&lt;blockquote>
&lt;p>Cookie(s) without HttpOnly flag set&lt;/p>
&lt;/blockquote>
&lt;p>vulnerability, which we apparently had in one of our internal applications.&lt;/p>
&lt;p>The applied fix was as simple as setting Django's &lt;a href="https://docs.djangoproject.com/en/2.0/ref/settings/#csrf-cookie-httponly">&lt;code>CSRF_COOKIE_HTTPONLY&lt;/code> configuration parameter&lt;/a> to &lt;code>True&lt;/code>.&lt;/p>
&lt;p>But, this is what got me confused. The Django documentation says:&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Designating the CSRF cookie as HttpOnly doesn’t offer any practical protection because CSRF is only to protect against cross-domain attacks.&lt;/span> If an attacker can read the cookie via JavaScript, they’re already on the same domain as far as the browser knows, so they can do anything they like anyway. (XSS is a much bigger hole than CSRF.)&lt;/strong>&lt;/p>
&lt;p>Although the setting offers little practical benefit, it’s sometimes required by security auditors.&lt;/p>
&lt;/blockquote>
&lt;p>Does this mean that &lt;strong>&lt;span style="background-color: #ffffcc; color: red">there is no actual vulnerability here&lt;/span> and we just have to be compliant with the security auditing rules&lt;/strong>?&lt;/p>
&lt;h4 id="97-樓">97 樓&lt;/h4>
&lt;p>As &lt;a href="https://security.stackexchange.com/a/175538/98538">joe says&lt;/a>, &lt;strong>there is no real security benefit to this&lt;/strong>. It is pure security theater. I'd like to highlight this from &lt;a href="https://docs.djangoproject.com/en/2.0/ref/settings/#csrf-cookie-httponly">the documentation&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>If you enable this and need to send the value of the CSRF token with an AJAX request, your JavaScript must pull the value from a hidden CSRF token form input on the page instead of from the cookie.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>The purpose of the HttpOnly flag is to make the value of the cookie unavailable from JavaScript, so that it can not be stolen if there is a XSS vulnerability. But the CSRF-token must somehow be available so it can be double submitted&lt;/strong> - thats the whole point with it, after all. So Django solves this by including the value in a hidden form field. This negates the whole benefit of HttpOnly, since an attacker can just read the value of the form field instead of the cookie.&lt;/p>
&lt;h4 id="18-樓">18 樓&lt;/h4>
&lt;p>I think the main point of confusion here is that the Django docs are specifically talking about the &lt;em>CSRF&lt;/em> use case for a cookie. &lt;strong>In order to understand why the &lt;code>httpOnly&lt;/code> flag adds no value in preventing CSRF, you need to understand both CSRF and how cookies work.&lt;/strong>&lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">CSRF is when a 3rd party triggers your user's browser to make a request to your server, and their browser automatically sends your server's cookies along with the request, as expected&lt;/span>. What you don't want is for your server to interpret this request as actually coming from your user, so you use a &lt;a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">CSRF mitigation&lt;/a> technique.&lt;/strong> The whole point of CSRF mitigation is &lt;strong>to be able to detect when the request didn't come from your own domain (i.e. from your user interacting with your application)&lt;/strong>.&lt;/p>
&lt;p>Briefly, how cookies work: &lt;strong>Whenever a user's browser sends a request to your domain/server, it automatically sends all the cookies associated with your domain, regardless of the &lt;code>httpOnly&lt;/code> flag. Cookies therefore allow your client or your server to attach information to a user's browser that will be returned to your server automatically along with any follow-on requests. &lt;span style="background-color: #ffffcc; color: red">Cookies with the &lt;code>httpOnly&lt;/code> flag cannot be accessed from javascript.&lt;/span> They probably shouldn't be considered a secure place to store information, but they do provide the advertised functionality.&lt;/strong>&lt;/p>
&lt;p>Back to CSRF implemented using a cookie — &lt;span style="background-color: #ffffcc; color: red">&lt;strong>in this case&lt;/strong> the &lt;code>httpOnly&lt;/code> flag is pointless&lt;/span> — &lt;span style="background-color: #ffffcc; color: red">the crux of CSRF is that they don't need to read your user's cookies, they just need your user's browser to send the associated cookies to your server along with the network request they forced it to send.&lt;/span> The &lt;code>httpOnly&lt;/code> flag, in general, does provide value in that it prevents client access to those cookies, and if your server returns any cookies, you should probably make them &lt;code>httpOnly&lt;/code>. If you are using a cookie for CSRF, then, you shouldn't do that, and you should spend your time rethinking that rather than making it an &lt;code>httpOnly&lt;/code> cookie. So, in general, it seems like that is a good rule of thumb — your server shouldn't send any non-&lt;code>httpOnly&lt;/code> cookies unless it is specifically intended to be accessed by the client javascript.&lt;/p></description></item><item><title>比較 SSL Certificates 的驗證效率</title><link>https://chiehting.com/posts/kubernetes-compare-ssl-speed/</link><pubDate>Wed, 01 Mar 2023 14:27:00 +0800</pubDate><guid>https://chiehting.com/posts/kubernetes-compare-ssl-speed/</guid><description>
&lt;p>由於調整 DNS namespace 由 Cloudflare 改為 Amazon Route 53，做架構調整，這將會影響到 SSL Certificates 的申請。&lt;/p>
&lt;p>而原本就有 AWS Certificate Manager (ACM)，申請好的憑證可以跟 Amazon Route 53 做整合；
而現有的憑證管理方式是 Cloudflare + cert-manager。&lt;/p>
&lt;p>所以想要知道哪種架構的效率較好。&lt;/p>
&lt;h3 id="分析結果">分析結果&lt;/h3>
&lt;p>就分析報告來看，將 &amp;quot;SSL verifiation&amp;quot; 的工作放在 Ingress-NGINX 效率較好。&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2023-03-01-compare-the-authentication-efficiency-of-ssl-certificates-4.png" alt="Response Time Percentiles">&lt;/p>
&lt;h3 id="架構變更">架構變更&lt;/h3>
&lt;p>原本是使用 Cloudflare DNS01 challenge，透過 cert-manager([[using-ssl-certificates-on-kubernetes-ingress-via-cert-manager]]) 申請憑證；改為使用 ACM + Amazon Route 53 管理。&lt;/p>
&lt;p>架構為調整，將 &amp;quot;SSL verifiation&amp;quot; 由 Ingress-NGINX 改到 Network Load balancers。&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2023-03-01-compare-the-authentication-efficiency-of-ssl-certificates-1.png" alt="architecture">&lt;/p>
&lt;h3 id="jmeter-測試">Jmeter 測試&lt;/h3>
&lt;p>測試條件如下為: 總共循環 20 次，間隔 10 秒；每次觸發會有 10 個 threads；每個 thread 會請求發送一次請求。&lt;/p>
&lt;p>所以一次測試會有 &lt;code>20 * 10 = 200&lt;/code> 個取樣。&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2023-03-01-compare-the-authentication-efficiency-of-ssl-certificates-3.png" alt="summary">&lt;/p>
&lt;h4 id="報告靜態檔">報告靜態檔&lt;/h4>
&lt;p>&lt;a href="https://storage.googleapis.com/chiehting.com/blog/2023-03-01-compare-the-authentication-efficiency-of-ssl-certificates-2/index.html">jmeter report&lt;/a>&lt;/p></description></item><item><title>Cloudfloar proxy slow</title><link>https://chiehting.com/posts/cloudflare-proxy-slow-issue/</link><pubDate>Mon, 16 Aug 2021 14:55:00 +0800</pubDate><guid>https://chiehting.com/posts/cloudflare-proxy-slow-issue/</guid><description>
&lt;p>今天收到反應說服務 API 的反應速度有變慢, 盤查結果發現目前使用的 Cloudflare 中的 proxy 功能造成的, 這邊紀錄盤查過程.&lt;/p>
&lt;p>從下圖可以看到有多支 API 變慢，這邊先分析變慢的原因。&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2021-08-16-cloudflare-proxy-issu-1.jpg" alt="api request is slow">&lt;/p>
&lt;h3 id="分析">分析&lt;/h3>
&lt;ol>
&lt;li>測試網路節點狀況，看是否有節點異常緩慢&lt;/li>
&lt;li>測試 API 請求狀況，查看請求是否有緩慢的階段&lt;/li>
&lt;/ol>
&lt;h4 id="測試網路節點狀況">測試網路節點狀況&lt;/h4>
&lt;p>MTR 分析網路節點狀況，可以看到節點的響應速度在 200 ms 內，看起來還在可接受範圍內。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">➜ sudo mtr --tcp --port &lt;span class="m">443&lt;/span> --report --report-cycles &lt;span class="m">5&lt;/span> api.bitwin.ai
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Start: 2021-08-13T17:28:56+0800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">HOST: JustinLee Loss% Snt Last Avg Best Wrst StDev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> 1.&lt;span class="p">|&lt;/span>-- rt-ac68u-2ad0 0.0% &lt;span class="m">5&lt;/span> 2.5 2.4 1.8 3.5 0.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> 2.&lt;span class="p">|&lt;/span>-- h254.s98.ts.hinet.net 0.0% &lt;span class="m">5&lt;/span> 11.7 7.9 6.1 11.7 2.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> 3.&lt;span class="p">|&lt;/span>-- tpn2-3301.hinet.net 0.0% &lt;span class="m">5&lt;/span> 20.0 11.2 5.8 20.0 6.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> 4.&lt;span class="p">|&lt;/span>-- tpdb-3031.hinet.net 40.0% &lt;span class="m">5&lt;/span> 9.9 9.5 9.1 9.9 0.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> 5.&lt;span class="p">|&lt;/span>-- 220-128-8-121.hinet-ip.hi 0.0% &lt;span class="m">5&lt;/span> 8.5 10.7 7.5 18.5 4.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> 6.&lt;span class="p">|&lt;/span>-- tyfo-4011.hinet.net 0.0% &lt;span class="m">5&lt;/span> 12.0 9.1 6.8 12.0 2.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> 7.&lt;span class="p">|&lt;/span>-- r31-la.us.hinet.net 0.0% &lt;span class="m">5&lt;/span> 142.5 142.9 140.1 148.3 3.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> 8.&lt;span class="p">|&lt;/span>-- r32-la.us.hinet.net 0.0% &lt;span class="m">5&lt;/span> 139.9 141.4 139.0 143.1 1.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> 9.&lt;span class="p">|&lt;/span>-- 141.101.72.250 0.0% &lt;span class="m">5&lt;/span> 153.2 146.1 139.4 153.3 6.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> 10.&lt;span class="p">|&lt;/span>-- 104.21.33.138 0.0% &lt;span class="m">5&lt;/span> 140.3 141.2 139.8 142.6 1.2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="測試-api-請求狀況">測試 API 請求狀況&lt;/h4>
&lt;p>使用 curl 命令對 api/ping 做請求, 這支 API 非常輕量, 但響應時間需要 1144 ms, 有點不合理.&lt;/p>
&lt;p>由下面資訊可以看到在 time_appconnect 這邊花了比較長的時間, 也就是可能在做 TLS 的時候佔了很長的時間, 而因為有使用 Cloudflare proxy, 所以 client 端在是對 proxy 的機器做 TLS Handshake.&lt;/p>
&lt;blockquote>
&lt;p>time_appconnect here is TLS setup. The client is then ready to send it’s HTTP GET request.&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">➜ bash curl_timetrace.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1"># starting_time: Fri Aug 13 17:43:56 CST 2021&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> time_namelookup: 0.002113
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> time_connect: 0.187355
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> time_appconnect: 0.521270
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> time_redirect: 0.000000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> time_pretransfer: 0.521435
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">time_starttransfer: 1.144257
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> ---------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> time_total: 1.144484 seconds
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="troubleshoot">Troubleshoot&lt;/h3>
&lt;p>經由上面分析觀察到可能是 TLS 耗時太久. 嘗試移除 Cloudflare proxy 的功能, 讓 Cloudflare 只單純的做 DNS.&lt;/p>
&lt;p>目前路由狀況如下圖. 由於網站上的 SSL 綁定都是使用 &lt;a href="https://www.cloudflare.com/zh-tw/ssl/">Cloudflare 免費 SSL/TLS&lt;/a>, 這功能必須啟用 proxy. 若要禁用 proxy 的話, 必須將 SSL 憑證在其他地方綁定. 測試時先暫時把 SSL 憑證改綁在 AWS Elastic Load Balancing 上.&lt;/p>
&lt;pre class="mermaid">flowchart LR
client --> cloudflare["Cloudflare proxy"]
cloudflare --> originServer["origin server"]&lt;/pre>
&lt;h3 id="比較結果">比較結果&lt;/h3>
&lt;p>可以看到調整過後, 約提升了 60% 的效率. 這邊評估可能是 proxy 的節點較遠, 而 client 需要先經過 proxy 才能到達 origin server, 所以導致變慢.&lt;/p>
&lt;p>這邊有一個網站 &lt;a href="https://cloudflare-test.judge.sh/">cloudflare-test&lt;/a>，可以測試 proxy 的地理位置，另外 proxy 會隨時間作變動非固定。&lt;/p>
&lt;p>&lt;strong>Before&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">➜ bash curl_timetrace.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1"># starting_time: Fri Aug 13 17:43:56 CST 2021&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> time_namelookup: 0.002113
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> time_connect: 0.187355
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> time_appconnect: 0.521270
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> time_redirect: 0.000000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> time_pretransfer: 0.521435
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">time_starttransfer: 1.144257
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> ---------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> time_total: 1.144484 seconds
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>After&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">➜ bash curl_timetrace.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1">##### starting_time: Fri Aug 13 20:31:22 CST 2021&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> time_namelookup: 0.002898
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> time_connect: 0.117132
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> time_appconnect: 0.344409
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> time_redirect: 0.000000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> time_pretransfer: 0.344475
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> time_starttransfer: 0.453052
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> ---------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> time_total: 0.453251 seconds
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>什麼是 QUIC</title><link>https://chiehting.com/posts/quick-udp-internet-connections/</link><pubDate>Wed, 21 Jul 2021 13:55:00 +0800</pubDate><guid>https://chiehting.com/posts/quick-udp-internet-connections/</guid><description>
&lt;p>QUIC(Quick UDP Internet Connections) 為 OSI model 中 &amp;quot;傳輸層&amp;quot; 和 &amp;quot;應用層&amp;quot; 之間的一個新的協議層. 是基於 UDP 之上的, 但它在傳輸層和應用層之間引入了自己的協議層, 用於處理連接、可靠性、流控制和安全性等問題. 所以 QUIC 不好用 OSI model 去區分, 而是稱為 &amp;quot;安全的通用傳輸協議(secure general-purpose transport protocol)&amp;quot;.&lt;/p>
&lt;p>HTTP/3 是個新的 HTTP 版本，使用 QUIC 作為傳輸協議，與 HTTP/1.1、HTTP/2.0 使用的 TCP/IP 不同。相較於 TCP/IP 協議；QUIC 提高了網路效能。&lt;/p>
&lt;p>HTTP 是網際網路上重要的網路協議之一，至今已經發行了多個版本。在 &lt;a href="http://www.http2demo.io/">demo&lt;/a> 中可以看到 HTTP/1.1 與 HTTP/2.0 的差異。&lt;/p>
&lt;ul>
&lt;li>HTTP/1.0&lt;/li>
&lt;li>HTTP/1.1&lt;/li>
&lt;li>HTTP/2.0&lt;/li>
&lt;/ul>
&lt;p>HTTP（Hypertext Transfer Protocol）協議是 application-level protocol (OSI model: layer 7)，在 RFC 2616 中描述 HTTP 傳輸層預設是使用 TCP/IP 作為連線，原因是因為要基於可靠的傳輸方式，但不排除 HTTP 也可以使用在其他協議上，前提是需要可靠的傳輸。&lt;/p>
&lt;blockquote>
&lt;p>HTTP communication usually takes place over TCP/IP connections. The
default port is TCP 80 [19], but other ports can be used. This does
not preclude HTTP from being implemented on top of any other protocol
on the Internet, or on other networks. HTTP only presumes a reliable
transport; any protocol that provides such guarantees can be used;
the mapping of the HTTP/1.1 request and response structures onto the
transport data units of the protocol in question is outside the scope
of this specification.&lt;/p>
&lt;/blockquote>
&lt;p>HTTP/1.1 是使用多個 TCP 連接，一個連接的問題不會影響其他連接。&lt;/p>
&lt;p>而 HTTP/2.0 也是基於 TCP/IP 協議之上，在單個 TCP 連接上實現了多個請求的並行傳輸（多路復用），也就是多個 stream 在同一個 TCP 上做封包的傳送，但基於 TCP/IP 的關鍵機制 Retransmission Timer（重傳計時器），只要某個 tcp package 遺失就會觸發重傳封包進而造成隊頭阻塞（head of line blocking），在未收到該 ack 之前，所有 stream 都須等待。&lt;/p>
&lt;p>而在極端的網路環境之下，HTTP/2.0 可能比 HTTP/1.1 之效率來得差。&lt;/p>
&lt;h3 id="quic">QUIC&lt;/h3>
&lt;p>&lt;a href="https://www.chromium.org/quic/">QUIC, a multiplexed transport over UDP&lt;/a> 是由 Google 所提出的設計，後來演變為一個 IETF 標準化的協議（RFC 9000）。而這協議是在端點間建立數個 Multiplexing 的 UDP 連線。&lt;/p>
&lt;blockquote>
&lt;p>QUIC is a new multiplexed transport built on top of UDP. HTTP/3 is designed to take advantage of QUIC's features, including lack of Head-Of-Line blocking between streams.&lt;/p>
&lt;/blockquote>
&lt;p>而 QUIC 的優點：&lt;/p>
&lt;ul>
&lt;li>使用 UDP 連線，所以減少了三次握手的效能消耗&lt;/li>
&lt;li>封包遺失只會影響到對應的 stream，&lt;/li>
&lt;li>實現了 TCP 的可靠性，使用 Packet Number 來代替 TCP 的 sequence number&lt;/li>
&lt;li>實現了 HTTP/2.0 的多路復用（multiplexed），但相較於 HTTP/2.0 協議 QUIC 每個 stream 間沒有依賴關係，也就是說大幅減少隊頭阻塞(lack of Head-Of-Line)&lt;/li>
&lt;li>實現了 TLS 的安全性&lt;/li>
&lt;/ul>
&lt;h3 id="references">References&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://javascript.plainenglish.io/what-is-http-3-and-why-does-it-matter-cb7d7b4b600f">What is http/3&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://xiaorui.cc/archives/6117">技术分享之http2和quic的那些事儿&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/@the.real.yushuf/benchmarking-quic-1fd043e944c7">benchmarking quic&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://datatracker.ietf.org/doc/html/rfc2616">Hypertext Transfer Protocol&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.chromium.org/quic">QUIC&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://datatracker.ietf.org/doc/html/rfc9000">IETF rfc9000&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Iptables guide</title><link>https://chiehting.com/posts/iptables-guide/</link><pubDate>Tue, 04 May 2021 10:30:00 +0800</pubDate><guid>https://chiehting.com/posts/iptables-guide/</guid><description>
&lt;p>iptables 被許多服務廣泛的運用著, 例如 Docker, Kubernetes 都是基於 iptables 來管理網路封包的處理, 所以此篇來研究 iptables 工具, 看看這些服務底層究竟在做些什麼事.&lt;/p>
&lt;p>Linux 核心 &lt;a href="https://www.netfilter.org/">Netfilter&lt;/a> 模組提供了網路的框架, 用於管理 Linux 主機的封包, 包括了&lt;code>過濾封包&lt;/code>、&lt;code>NAT&lt;/code>、&lt;code>Port 轉發&lt;/code>. 而 Linux 系統上有許多軟體是基於 &lt;a href="https://www.netfilter.org/">Netfilter&lt;/a> 模組實作網路管理介面, 例如 firewalld、ntw、iptables、nftables.&lt;/p>
&lt;p>iptables and ip6tables 分別為 IPv4 and IPv6, 組成包括了 &lt;code>Chain&lt;/code>、&lt;code>Target&lt;/code>、&lt;code>Table&lt;/code>、&lt;code>Match&lt;/code>, 而規則方面有 &lt;code>PREROUTING&lt;/code>、&lt;code>INPUT&lt;/code>、&lt;code>FORWARD&lt;/code>、&lt;code>OUTPUT&lt;/code>、&lt;code>POSTROUTIONG&lt;/code>.&lt;/p>
&lt;h3 id="packet-flow">Packet flow&lt;/h3>
&lt;p>引用 wiki &lt;a href="https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg">netfilter packet flow&lt;/a> 的圖, 可以看到封包在主機中的流量.&lt;/p>
&lt;h3 id="tables-與-chain">Tables 與 chain&lt;/h3>
&lt;p>下面列出 &lt;code>tables&lt;/code> 內建 &lt;code>chain&lt;/code> 關係&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th>PREROUTING&lt;/th>
&lt;th>INPUT&lt;/th>
&lt;th>FORWARD&lt;/th>
&lt;th>OUTPUT&lt;/th>
&lt;th>POSTROUTIONG&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>raw&lt;/td>
&lt;td>o&lt;/td>
&lt;td>x&lt;/td>
&lt;td>x&lt;/td>
&lt;td>o&lt;/td>
&lt;td>x&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>mangle&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>nat&lt;/td>
&lt;td>o&lt;/td>
&lt;td>x&lt;/td>
&lt;td>x&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>filter&lt;/td>
&lt;td>x&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;td>x&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="tables">Tables&lt;/h4>
&lt;p>優先層級為 &lt;code>raw&lt;/code> -&amp;gt; &lt;code>mangle&lt;/code> -&amp;gt; &lt;code>nat&lt;/code> -&amp;gt; &lt;code>filter&lt;/code>.&lt;/p>
&lt;ul>
&lt;li>raw: 於處理異常(優先層級最高).&lt;/li>
&lt;li>mangle: 提供改寫封包的功能.&lt;/li>
&lt;li>nat(network address translation): IP 轉發; port 轉發.&lt;/li>
&lt;li>filter: 封包過濾 (此為預設表).&lt;/li>
&lt;/ul>
&lt;h4 id="chain">Chain&lt;/h4>
&lt;ul>
&lt;li>PREROUTING: 數據包進入路由表之前.&lt;/li>
&lt;li>INPUT: 通過路由表後目的地為本機.&lt;/li>
&lt;li>FORWARD: 通過路由表後, 目的地不為本機.&lt;/li>
&lt;li>OUTPUT: 由本機產生, 向外轉發.&lt;/li>
&lt;li>POSTROUTIONG: 發送到網卡接口之前.&lt;/li>
&lt;/ul>
&lt;h4 id="state">State&lt;/h4>
&lt;ul>
&lt;li>NEW: 一個新的連線封包 (建立新連線後的第一個封包).&lt;/li>
&lt;li>ESTABLISHED: 成功建立的連線, 即建立追蹤連線後所有封包狀態 (跟在 NEW 封包後面的所有封包).&lt;/li>
&lt;li>RELATED: 新建連線,由 ESTABLISHED session 所建立的新獨立連線 (ex. ftp-data 連線).&lt;/li>
&lt;li>INVALID: 非法連線狀態的封包 (DROP 封包).&lt;/li>
&lt;li>UNKOWN: 不明連線狀態的封包.&lt;/li>
&lt;/ul>
&lt;h4 id="policy-and-target">Policy and target&lt;/h4>
&lt;ul>
&lt;li>ACCEPT: 允許封包移動至目的地或另一個 chain.&lt;/li>
&lt;li>DROP: 丟棄封包,不回應要求,不傳送失敗訊息.&lt;/li>
&lt;li>REJECT: 拒絕封包,回應要求,傳送失敗訊息.&lt;/li>
&lt;li>SNAT: 修改 Source Socket.&lt;/li>
&lt;li>DNAT: 修改 Destination Socket.&lt;/li>
&lt;li>MASQUERADE: 動態修改 Source Socket (無法指定 IP,取當時網卡的 IP),較方便但效率較差.&lt;/li>
&lt;li>REDIRECT: 將連線導至本機行程 (Local Process).&lt;/li>
&lt;li>RETURN: 結束自行定義的 Chain 然後返回原來的 Chain 繼續跑規則 (rules).&lt;/li>
&lt;li>QUEUE: 封包排隊等待處理.&lt;/li>
&lt;li>LOG: 記錄指定的規則封包 (/etc/syslog.conf , default /var/log/messges).&lt;/li>
&lt;/ul>
&lt;h3 id="iptables-輸出格式說明">iptables 輸出格式說明&lt;/h3>
&lt;p>下面指令可以列出表 &lt;code>filter&lt;/code> 的規則清單, 可以看到有三條 &lt;code>Chain&lt;/code>, 有九個欄位, 說明如下:&lt;/p>
&lt;ul>
&lt;li>pkts: 總共通過的封包的數量&lt;/li>
&lt;li>bytes: 總共通過的流量大小&lt;/li>
&lt;li>target: 執行的動作, 例如 &lt;code>ACCEPT&lt;/code>、&lt;code>REJECT&lt;/code>、&lt;code>RETURN&lt;/code>、&lt;code>DROP&lt;/code>、&lt;code>LOG&lt;/code>,也可以參照到其他 &lt;code>Chain&lt;/code>.&lt;/li>
&lt;li>port: 使用封包的協定, 例如 &lt;code>all&lt;/code>、&lt;code>tcp&lt;/code>、&lt;code>udp&lt;/code>、&lt;code>icmp&lt;/code>&lt;/li>
&lt;li>opt: 額外的選項說明&lt;/li>
&lt;li>in: 進入的網路介面&lt;/li>
&lt;li>out: 出去的網路介面&lt;/li>
&lt;li>source: 此規則是針對哪個來源進行限制,例如 &lt;code>0.0.0.0/0&lt;/code>&lt;/li>
&lt;li>destination: 此規則是針對哪個目標進行限制,例如 &lt;code>0.0.0.0/0&lt;/code>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@server:~ iptables -L -n -v --line-numbers -t filter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">Chain INPUT &lt;span class="o">(&lt;/span>policy ACCEPT&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">Chain FORWARD &lt;span class="o">(&lt;/span>policy ACCEPT&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">Chain OUTPUT &lt;span class="o">(&lt;/span>policy ACCEPT&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl"> pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="iptables-應用">iptables 應用&lt;/h3>
&lt;h4 id="參數說明">參數說明&lt;/h4>
&lt;ul>
&lt;li>-P chain target: 變更 chain 的預設政策.&lt;/li>
&lt;li>-A chain: 加入規則至 chain 的最後.&lt;/li>
&lt;li>-I chain [rulenum]: 插入規則至 chain.&lt;/li>
&lt;li>-D chain [rulenum]: 刪除 chain 上的規則.&lt;/li>
&lt;li>-R chain [rulenum]: 取代 chain 上的規則.&lt;/li>
&lt;li>-L [chain [rulenum]]: 列出 chain 上的規則.&lt;/li>
&lt;li>-F [chain]: 刪除 chain 上的所有規則.&lt;/li>
&lt;li>-Z [chain [rulenum]]: 將計數器歸零.&lt;/li>
&lt;li>-N chain: 建立使用者定義的 chain.&lt;/li>
&lt;li>-X [chain]: 刪除使用者定義的 chain.&lt;/li>
&lt;li>-E old-chain new-chain: 變更 chain 的名稱.&lt;/li>
&lt;/ul>
&lt;p>其中 rulenum 是從上至下順序執行，直至匹配的的規則為止，否則執行預設政策。&lt;/p>
&lt;h4 id="狀況題">狀況題&lt;/h4>
&lt;p>測試主機有網路介面有 &lt;code>lo&lt;/code> and &lt;code>eth0&lt;/code>.&lt;/p>
&lt;h5 id="查看-table-filter-的規則">查看 table filter 的規則&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@server:~ iptables -L -n -v --line-numbers -t filter
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="修改-chain-的預設政策">修改 chain 的預設政策&lt;/h5>
&lt;p>先將 22 port 打開, 以免被擋在家門外. INPUT 預設政策為 DROP.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># INPUT chain accept port 22&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">root@server:~ iptables -I INPUT -i eth0 -p tcp --dport &lt;span class="m">22&lt;/span> -m state --state NEW,ESTABLISHED -j ACCEPT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1"># OUTPUT chain accept port 22&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">root@server:~ iptables -I OUTPUT -o eth0 -p tcp --sport &lt;span class="m">22&lt;/span> -m state --state ESTABLISHED -j ACCEPT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="c1"># INPUT chain default drop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">root@server:~ iptables -P INPUT DROP
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>還原&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># INPUT chain default accept&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">root@server:~ iptables -P INPUT ACCEPT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1"># Delete the INPUT chain first rule&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">root@server:~ iptables -D INPUT &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="c1"># Delete the OUTPUT chain first rule&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">root@server:~ iptables -D OUTPUT &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="封鎖-input-chain-指定的-port">封鎖 INPUT chain 指定的 port&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">＃ 拒絕由網卡 eth0 進來的 tcp port &lt;span class="m">80&lt;/span> 所有封包
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">iptables -A INPUT -p tcp -dport &lt;span class="m">80&lt;/span> -i eth0 -j REJECT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">＃ 拒絕由網卡 eth0 進來的 tcp port &lt;span class="m">7000&lt;/span> ~ &lt;span class="m">7005&lt;/span> 所有封包
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">iptables -A INPUT -p tcp -sport 7000:7005 -i eth0 -j REJECT
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="封鎖-input-chain-指定的-來源">封鎖 INPUT chain 指定的 來源&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">iptables -I INPUT -p tcp --dport &lt;span class="m">80&lt;/span> -s 1.34.113.121/32 -m state --state ESTABLISHED -j REJECT
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="刪除-input-chain-所有的規則">刪除 INPUT chain 所有的規則&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">iptables -F INPUT
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="rafances">Rafances&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="http://linux.vbird.org/linux_server/0250simple_firewall.php#netfilter_chain">iptables 的表格 (table) 與鏈 (chain)&lt;/a>&lt;/li>
&lt;li>&lt;/li>
&lt;/ul></description></item></channel></rss>