<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>apache on Chiehting</title><link>https://chiehting.com/tags/apache/</link><description>Recent content in apache on Chiehting</description><generator>Hugo -- gohugo.io</generator><copyright>Copyright © 2008–2018, Steve Francia and the Hugo Authors; all rights reserved.</copyright><lastBuildDate>Thu, 16 Nov 2023 10:30:51 +0800</lastBuildDate><atom:link href="https://chiehting.com/tags/apache/index.xml" rel="self" type="application/rss+xml"/><item><title>Apache Jmeter</title><link>https://chiehting.com/posts/testing-apache-jmeter/</link><pubDate>Thu, 16 Nov 2023 10:30:51 +0800</pubDate><guid>https://chiehting.com/posts/testing-apache-jmeter/</guid><description>
&lt;p>這篇文章主要在紀錄 Apache Jmeter 的使用筆記。&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>理解 Apache Jmeter 壓工具，研究其中的的元件&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>Apache Jmeter 是 Apache 研發的一個壓測軟體(在講廢話)，是使用 Java([[java-install]]) 編譯好的應用程式。&lt;/p>
&lt;h4 id="install">Install&lt;/h4>
&lt;p>當前版本為 Jmeter 5.6.3 的版本，下面操作皆是以這個版本為基礎。&lt;/p>
&lt;h5 id="required">Required&lt;/h5>
&lt;ol>
&lt;li>由於是 Java 編譯，所以需要先配置好 Jar([[java-install#Jar]]) 環境。&lt;/li>
&lt;/ol>
&lt;h5 id="download-jmeter">Download Jmeter&lt;/h5>
&lt;p>配置好環境後下載即可使用，下面為下載命令。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">curl -LO https://dlcdn.apache.org/jmeter/binaries/apache-jmeter-5.6.3.tgz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">tar zxf apache-jmeter-5.6.3.tgz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>插件安裝：&lt;/p>
&lt;ul>
&lt;li>[[jmeter-add-the-mqtt-plugin]]&lt;/li>
&lt;/ul>
&lt;h4 id="how-to-use">How to use&lt;/h4>
&lt;h5 id="編寫腳本">編寫腳本&lt;/h5>
&lt;p>Jmeter 有 IDE 可以使用，開啟 &lt;code>./bin/ApacheJMeter.jar&lt;/code> 就可以看到介面，可以透過 IDE 配置壓測流程。
官方也有提供一些範例在 &lt;code>./bin/examples&lt;/code> 底下，以及樣板 &lt;code>./bin/templates&lt;/code>，可以參考。&lt;/p>
&lt;p>&lt;em>Thread Group&lt;/em> 中有個配置 &lt;em>Ramp-up period&lt;/em>，這欄位的目的在於在 N 秒內執行指定的 thread number。
設定的話 thread 會線性執行，由於線性起初的壓力不會過大，產出的報表也相對好看；如果沒設定的話 thread 會在同一時間放行，在壓測的開始會對服務造成滿大的壓力，適合搶票的情境。&lt;/p>
&lt;p>&lt;em>JSR223 Sampler&lt;/em> 是滿好用的元件之一，可以使用多種語言（groovy、javascript, etc...）來編輯。&lt;/p>
&lt;p>&lt;em>If Controller&lt;/em> 可以做流程的判別式，要注意選項 &lt;em>Interpret Condition as Variable Expression?&lt;/em>，用來解義變數的擴展語言。使用 true or false 的變數內容的話，建議是開啟。&lt;/p>
&lt;h5 id="壓測機器">壓測機器&lt;/h5>
&lt;p>提升 Ubuntu server 22.04 的主機效能，設定配置。&lt;/p>
&lt;p>增加 ulimit 的配置，使主機能使用的 &lt;em>open file&lt;/em>、&lt;em>process&lt;/em> 都加大。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">vim /etc/pam.d/common-session
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">session required pam_limits.so
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">vim /etc/security/limits.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">* soft nproc &lt;span class="m">64000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">* hard nproc &lt;span class="m">64000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">* soft nofile &lt;span class="m">64000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">* hard nofile &lt;span class="m">64000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">root soft nofile &lt;span class="m">64000&lt;/span> &lt;span class="c1"># option&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">root hard nofile &lt;span class="m">64000&lt;/span> &lt;span class="c1"># option&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>調整 kernel 的配置。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">vim /etc/sysctl.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">net.ipv4.ip_local_port_range&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;15000 61000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">net.ipv4.tcp_fin_timeout&lt;span class="o">=&lt;/span>&lt;span class="m">30&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">net.ipv4.tcp_tw_recycle&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">net.ipv4.tcp_tw_reuse&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="c1"># 添加或修改以下参数，提高 TCP 缓冲区大小&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">net.core.rmem_max &lt;span class="o">=&lt;/span> &lt;span class="m">16777216&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">net.core.wmem_max &lt;span class="o">=&lt;/span> &lt;span class="m">16777216&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">net.ipv4.tcp_rmem &lt;span class="o">=&lt;/span> &lt;span class="m">4096&lt;/span> &lt;span class="m">87380&lt;/span> &lt;span class="m">16777216&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">net.ipv4.tcp_wmem &lt;span class="o">=&lt;/span> &lt;span class="m">4096&lt;/span> &lt;span class="m">87380&lt;/span> &lt;span class="m">16777216&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="c1"># 可開啟檔案數量&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">fs.file-max &lt;span class="o">=&lt;/span> &lt;span class="m">100000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">vm.swappiness&lt;span class="o">=&lt;/span>&lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>調整 &lt;em>transparent huge page&lt;/em> 策略。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">vim /etc/default/grub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">GRUB_CMDLINE_LINUX&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;transparent_hugepage=never&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="壓力測試">壓力測試&lt;/h5>
&lt;p>可以直接使用 IDE 或 Command 來執行壓測，下面為使用 Command 的方式做執行。&lt;/p>
&lt;p>腳本編寫完成後保存成 jmx 檔案，jmeter 會使用腳本去執行壓測流程。壓測完成後會產生 jtl 檔案為壓測結果，dashboard 為 htlm 的報告書。&lt;/p>
&lt;p>其中有配置 &lt;em>JVM_ARGS&lt;/em> 參數，開大 &lt;em>-Xms&lt;/em>、&lt;em>-Xmx&lt;/em> 為記憶體可使用量。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">JVM_ARGS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;-Dnashorn.args=--no-deprecation-warning -Xms3g -Xmx3g&amp;#34;&lt;/span> apache-jmeter-5.6.3/bin/jmeter -n -t 20250430-v1.jmx -l jmeter-result.jtl -e -o dashboard
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="報告">報告&lt;/h5></description></item><item><title>Apache Log4j Security Vulnerabilities</title><link>https://chiehting.com/posts/security-apache-log4j-security-vulnerabilities/</link><pubDate>Tue, 21 Dec 2021 13:55:00 +0800</pubDate><guid>https://chiehting.com/posts/security-apache-log4j-security-vulnerabilities/</guid><description>
&lt;p>在 2021 年 12 月 CVE 發布了一系列有關 Apache Log4j 的漏洞. 這邊初步了解 Log4j 的漏洞狀況跟應對.&lt;/p>
&lt;h3 id="apache-log4j-security-vulnerabilities">Apache Log4j Security Vulnerabilities&lt;/h3>
&lt;p>2021 年的 12 月 10 號發布了 public disclosure of the Apache Log4j vulnerability &lt;a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228">CVE-2021-44228&lt;/a>, 且風險分數為 CVSS 3.1 的滿分 10 分. 攻擊者若可以控制 log messages or log message parameters 就有機會在 LDAP 或 JNDI（Java Naming and Directory Interface）有關的服務加載任意程式碼. Log4j 在 2.15.0 版本中預設關閉了 message lookup substitution 功能; 在 2.16.0 版本中則完全移除了此功能.&lt;/p>
&lt;p>2021 年的 12 月 14 號發布了 &lt;a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046">CVE-2021-45046&lt;/a>, 且風險分數為 CVSS 3.1 的 9.0 分. 此漏洞是 CVE-2021-44228 的延伸, 於 Apache Log4j 2.15.0 中的預設配置不完整, 攻擊者可以透過 Thread Context Map (MDC) 上下文映射功能執行遠端程式碼或本地程式碼. 再 Log4j 2.16.0 (Java 8) and 2.12.2 (Java 7) 中移除 message lookup patterns 和預設關閉 JNDI functionality.&lt;/p>
&lt;p>2021 年的 12 月 18 號發布了 &lt;a href="https://nvd.nist.gov/vuln/detail/CVE-2021-45105">CVE-2021-45105&lt;/a>, 且風險分數為 CVSS 3.1 的 7.5 分. 再 2.16.0 版本沒有保護自身的遞迴查找, 所以攻擊者還能透過設計過的字串進行攻擊. 再 Log4j 2.17.0 and 2.12.3 中有修復此問題.&lt;/p>
&lt;h3 id="應對">應對&lt;/h3>
&lt;p>依據 CVE 報告, 服務需將 Log4j 升級到 2.17.0 的版本. 所以這邊目標是盤查系統是否有使用到 Log4j, 如果有就做升級.&lt;/p>
&lt;p>確認系統.&lt;/p>
&lt;ol>
&lt;li>Redmine is built with Ruby on Rails. &lt;a href="https://www.redmine.org/builds/">build status&lt;/a>.&lt;/li>
&lt;li>FreeIPA itself does not have Java components.&lt;/li>
&lt;li>Harbor is built with Golang, and is not running or using the JVM. &lt;a href="https://github.com/goharbor/harbor/issues/16136">issues&lt;/a>&lt;/li>
&lt;li>Grafana are chose not to use Java as a core part of our stack and have minimal dependencies on services and applications that make use of it. &lt;a href="https://grafana.com/blog/2021/12/14/grafana-labs-core-products-not-impacted-by-log4j-cve-2021-44228-and-related-vulnerabilities/">grafana blog&lt;/a>&lt;/li>
&lt;li>GitLAB is a low impact. &lt;a href="https://about.gitlab.com/blog/2021/12/15/updates-and-actions-to-address-logj-in-gitlab/">gitlab blog&lt;/a>&lt;/li>
&lt;li>Elasticsearch and Kibana needs to be upgrade to the 7.16.2 and 6.8.22 of Apache Log4j and address false positive concerns with some vulnerability scanners. &lt;a href="https://www.elastic.co/blog/new-elasticsearch-and-logstash-releases-upgrade-apache-log4j2">elastic blog&lt;/a>&lt;/li>
&lt;li>Ansible AWX does not depend on log4j. &lt;a href="https://github.com/ansible/awx/issues/11457">issue&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>盤查完後, 得知只有 Elasticsearch and Kibana 有使用到 log4j 的套件.&lt;/p>
&lt;h3 id="elasticsearch-and-kibana">Elasticsearch and Kibana&lt;/h3>
&lt;p>我之前是使用 Ansible 透過 apt-get 安裝 Elasitcsearch, 所以這邊更新 Elasticsearch role 版本參數為 7.16.2 並執行 playbook, 完成後 Elasticsearch 就升級完畢. 至於 Kibana 是使用 docker compose 執行, 更新 Kibana 的 container image 至 7.16.2 就可以了.&lt;/p>
&lt;h4 id="更新時碰到的問題">更新時碰到的問題&lt;/h4>
&lt;p>無法重新啟動 Elasticsearch 服務, 因為 ingest-attachment 版本是舊的. 這邊做重新安裝 ingest-attachment 來排除異常.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/usr/share/elasticsearch/bin/elasticsearch-plugin remove ingest-attachment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">/usr/share/elasticsearch/bin/elasticsearch-plugin install ingest-attachment
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>啟動 Kibana 時偵測到 .kibana 的 indexes 已經存在. 這邊做移除所有 .kibana* 的 indexes, 讓 Kibana 重新建立 indexes.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># Elasticsearch 服務地址為 127.0.0.1:9200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">curl --user &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$account&lt;/span>&lt;span class="s2">:&lt;/span>&lt;span class="nv">$password&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -XDELETE http://127.0.0.1:9200/.kibana*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>