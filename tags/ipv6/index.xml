<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ipv6 on Chiehting</title><link>https://chiehting.com/tags/ipv6/</link><description>Recent content in ipv6 on Chiehting</description><generator>Hugo -- gohugo.io</generator><copyright>Copyright © 2008–2018, Steve Francia and the Hugo Authors; all rights reserved.</copyright><lastBuildDate>Wed, 18 Jun 2025 13:47:21 +0800</lastBuildDate><atom:link href="https://chiehting.com/tags/ipv6/index.xml" rel="self" type="application/rss+xml"/><item><title>什麼是 IPv6</title><link>https://chiehting.com/posts/what-is-ipv6/</link><pubDate>Wed, 18 Jun 2025 13:47:21 +0800</pubDate><guid>https://chiehting.com/posts/what-is-ipv6/</guid><description>
&lt;p>IPv6（Internet Protocol version 6）是網際網路協議（IP）的第六版，用於識別和定位網路上的設備，並負責在它們之間傳輸數據。IPv6 使用 128 bit 的地址長度，比起 IPv4 的 32 bit 的地址長度更多。&lt;/p>
&lt;h2 id="ipv6-定義">IPv6 定義&lt;/h2>
&lt;p>假設 IPv6 地址為 2001:0db8:85a3:0000:0000:8a2e:0370:7334&lt;/p>
&lt;h3 id="簡化表示規則">簡化表示規則&lt;/h3>
&lt;p>可簡化表示: 2001:db8:85a3::8a2e:370:7334。&lt;/p>
&lt;ul>
&lt;li>去除連續零，85a3:0000:0000:8a2e 可表示為 85a3::8a2e&lt;/li>
&lt;li>去除前導零，0370 可以表示為 370&lt;/li>
&lt;/ul>
&lt;h3 id="結構分解">結構分解&lt;/h3>
&lt;p>IPv6 地址是一個 &lt;strong>128 位(bit)&lt;/strong> 的地址，以 16 進位表示，分為 8 組，每組 4 個 16 位元(16-bit)，用冒號分隔例如：&lt;code>2001:0db8:85a3:0000:0000:8a2e:0370:7334&lt;/code>，下面表格為 128 位的定義，包括 &lt;code>Global Prefix&lt;/code>、&lt;code>Subnet ID&lt;/code>、&lt;code>Interface ID&lt;/code>。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Global Prefix&lt;/th>
&lt;th>Subnet ID&lt;/th>
&lt;th>Interface ID&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>48 bits&lt;/td>
&lt;td>16 bits&lt;/td>
&lt;td>64 bits&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>以上面地址為例子，其結構如下表。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Global Prefix（48 bits）&lt;/th>
&lt;th>Subnet ID&lt;/th>
&lt;th>Interface ID&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>2001:0db8:85a3&lt;/td>
&lt;td>0000&lt;/td>
&lt;td>0000:8a2e:0370:7334&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>全球路由前綴 (Global Prefix)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>地址的前 &lt;strong>48 位&lt;/strong>，用於標識網路範圍。&lt;/li>
&lt;li>在該地址中：&lt;br>
&lt;strong>&lt;code>2001:0db8:85a3&lt;/code>&lt;/strong> 是全球路由前綴。
&lt;ul>
&lt;li>&lt;code>2001&lt;/code>：表示該地址屬於全球可路由的 IPv6 網段。&lt;/li>
&lt;li>&lt;code>0db8&lt;/code>：是一個特殊的文檔範例前綴（RFC 3849 定義，僅用於教學與測試）。&lt;/li>
&lt;li>&lt;code>85a3&lt;/code>：進一步標識特定網路範圍。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>子網 ID (Subnet ID)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>地址的第 &lt;strong>49 至 64 位&lt;/strong>，用於標識子網。&lt;/li>
&lt;li>在該地址中：&lt;br>
&lt;strong>&lt;code>0000&lt;/code>&lt;/strong> 是子網 ID，表示該地址位於主網或未進行子網劃分。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>接口 ID (Interface ID)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>地址的最後 &lt;strong>64 位&lt;/strong>，用於標識子網內的具體設備（主機）。&lt;/li>
&lt;li>在該地址中：&lt;br>
&lt;strong>&lt;code>0000:8a2e:0370:7334&lt;/code>&lt;/strong> 是接口 ID，通常由設備自動生成或手動配置。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol></description></item><item><title>建立支持 IPv6 的 權限給 EKS</title><link>https://chiehting.com/posts/aws-eks-vpc-cni-support-ipv6/</link><pubDate>Sat, 14 Jun 2025 13:24:19 +0800</pubDate><guid>https://chiehting.com/posts/aws-eks-vpc-cni-support-ipv6/</guid><description>
&lt;p>&lt;a href="https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/cni-ipv6.html">了解叢集、Pod 和 服務的 IPv6 地址&lt;/a>&lt;/p>
&lt;p>EKS 中的配置 Cluster IP address family 選擇 IPv6 時，需要&lt;a href="https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/cni-iam-role.html#cni-iam-role-create-ipv6-policy">設定 Amazon VPC CNI 外掛程式以使用 IRSA&lt;/a>。&lt;/p>
&lt;p>環境定義：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>參數說明&lt;/th>
&lt;th>參數內容&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>eks cluster 名稱&lt;/td>
&lt;td>development-souffle&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>policy 名稱&lt;/td>
&lt;td>development-souffle-VPCCNIIPv6&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>role 名稱&lt;/td>
&lt;td>development-souffle-VPCCNIIPv6&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="從-eks-中取得-oidc-url">從 EKS 中取得 OIDC URL&lt;/h2>
&lt;p>透過 aws cli 命令取得 EKS 中的 OIDC URL。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">aws eks describe-cluster --name development-souffle --query &lt;span class="s2">&amp;#34;cluster.identity.oidc.issuer&amp;#34;&lt;/span> --output text
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>回傳的結果如下。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">https://oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="建立-iam-policy-並定義可以使用的權限">建立 IAM policy 並定義可以使用的權限&lt;/h2>
&lt;p>因為 AWS 維護的 AmazonEKS_CNI_Policy 權限不足沒辦法分配 IPv6 地址，所以需要建立新 policy，下面為配置定義。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Version&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2012-10-17&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Statement&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Effect&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Allow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Action&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:AssignIpv6Addresses&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:DescribeInstances&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:DescribeTags&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:DescribeNetworkInterfaces&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:DescribeInstanceTypes&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Resource&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Effect&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Allow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Action&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:CreateTags&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Resource&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;arn:aws:ec2:*:*:network-interface/*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="建立-vpc-cni-role-並定義-trust-relationships">建立 VPC CNI role 並定義 trust relationships&lt;/h2>
&lt;p>要配置 IRSA(IAM role for service account) 讓 pod kube-system:aws-node 可以提權，所以需要定義 trust relationships，下面 json 是 Trusted entities 的定義，其中：&lt;/p>
&lt;ul>
&lt;li>Effect 固定 Allow&lt;/li>
&lt;li>Federated 為 OIDC 的 arn，可以去 IAM &amp;gt; Identity providers 底下找&lt;/li>
&lt;li>Action 固定 &amp;quot;sts:AssumeRoleWithWebIdentity&amp;quot;&lt;/li>
&lt;li>StringEquals
&lt;ol>
&lt;li>aud (Audience) 為 sts.amazonaws.com 可以使用 Token 授權&lt;/li>
&lt;li>sub (Subject) 為 system:serviceaccount:kube-system:aws-node 可以提權&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Version&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2012-10-17&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Statement&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Effect&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Allow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Principal&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Federated&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;arn:aws:iam::111122223333:oidc-provider/oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Action&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;sts:AssumeRoleWithWebIdentity&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Condition&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;StringEquals&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE:aud&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;sts.amazonaws.com&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE:sub&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;system:serviceaccount:kube-system:aws-node&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="將-policy-權限加入到-role-中">將 policy 權限加入到 role 中&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">aws iam attach-role-policy &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span> --policy-arn arn:aws:iam::111122223333:policy/development-souffle-VPCCNIIPv6 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span> --role-name development-souffle-VPCCNIIPv6
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="加入-ann-到-serviceaccount-aws-node-中使其角色可以提權">加入 ann 到 serviceaccount aws-node 中，使其角色可以提權&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">kubectl get serviceaccount -n kube-system aws-node -o yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">kubectl annotate serviceaccount &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span> -n kube-system aws-node &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span> eks.amazonaws.com/role-arn&lt;span class="o">=&lt;/span>arn:aws:iam::111122223333:role/development-souffle-VPCCNIIPv6
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="重新部署-aws-node-所有-pod-使其可以使用到新的-service-account-權限">重新部署 aws-node 所有 pod 使其可以使用到新的 service account 權限&lt;/h2></description></item></channel></rss>