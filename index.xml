<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Chiehting</title><link>https://chiehting.com/</link><description>Recent content on Chiehting</description><generator>Hugo -- gohugo.io</generator><copyright>Copyright © 2008–2018, Steve Francia and the Hugo Authors; all rights reserved.</copyright><lastBuildDate>Wed, 16 Jul 2025 15:07:51 +0800</lastBuildDate><atom:link href="https://chiehting.com/index.xml" rel="self" type="application/rss+xml"/><item><title>Unix 訊號定義</title><link>https://chiehting.com/posts/unix-signals/</link><pubDate>Wed, 16 Jul 2025 15:07:51 +0800</pubDate><guid>https://chiehting.com/posts/unix-signals/</guid><description>
&lt;p>在 unix 中的每個信號號都有對應的定義，決定了當進程接收到信號時的行為。下面表格中的 &lt;code>Action&lt;/code> 列條目指定了每個信號的默認處置。&lt;/p>
&lt;ul>
&lt;li>Ign：Default action is to ignore the signal.&lt;/li>
&lt;li>Core：Default action is to terminate the process and dump core (see &lt;a href="https://man7.org/linux/man-pages/man5/core.5.html">core(5)&lt;/a>).&lt;/li>
&lt;li>Stop：Default action is to stop the process.&lt;/li>
&lt;li>Cont：Default action is to continue the process if it is currently stopped.&lt;/li>
&lt;/ul>
&lt;h3 id="refencers">Refencers&lt;/h3>
&lt;p>&lt;a href="https://man7.org/linux/man-pages/man7/signal.7.html">https://man7.org/linux/man-pages/man7/signal.7.html&lt;/a>&lt;/p>
&lt;h3 id="standard-signals">Standard signals&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Signal&lt;/th>
&lt;th>Standard&lt;/th>
&lt;th>Action&lt;/th>
&lt;th>Comment&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>SIGABRT&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>Abort signal from abort(3)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGALRM&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Timer signal from alarm(2)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGBUS&lt;/td>
&lt;td>P2001&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>Bus error (bad memory access)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGCHLD&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Ign&lt;/td>
&lt;td>Child stopped or terminated&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGCLD&lt;/td>
&lt;td>-&lt;/td>
&lt;td>Ign&lt;/td>
&lt;td>A synonym for SIGCHLD&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGCONT&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Cont&lt;/td>
&lt;td>Continue if stopped&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGEMT&lt;/td>
&lt;td>-&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Emulator trap&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGFPE&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>Erroneous arithmetic operation&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGHUP&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Hangup detected on controlling terminal&lt;br>or death of controlling process&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGILL&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>Illegal Instruction&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGINFO&lt;/td>
&lt;td>-&lt;/td>
&lt;td>&lt;/td>
&lt;td>A synonym for SIGPWR&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGINT&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Interrupt from keyboard&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGIO&lt;/td>
&lt;td>-&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>I/O now possible (4.2BSD)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGIOT&lt;/td>
&lt;td>-&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>IOT trap. A synonym for SIGABRT&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGKILL&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Kill signal&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGLOST&lt;/td>
&lt;td>-&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>File lock lost (unused)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGPIPE&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Broken pipe: write to pipe with no&lt;br>readers; see pipe(7)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGPOLL&lt;/td>
&lt;td>P2001&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Pollable event (Sys V);&lt;br>synonym for SIGIO&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGPROF&lt;/td>
&lt;td>P2001&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Profiling timer expired&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGPWR&lt;/td>
&lt;td>-&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Power failure (System V)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGQUIT&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>Quit from keyboard&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGSEGV&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>Invalid memory reference&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGSTKFLT&lt;/td>
&lt;td>-&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Stack fault on coprocessor (unused)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGSTOP&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Stop&lt;/td>
&lt;td>Stop process&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGTSTP&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Stop&lt;/td>
&lt;td>Stop typed at terminal&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGSYS&lt;/td>
&lt;td>P2001&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>Bad system call (SVr4);&lt;br>see also seccomp(2)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGTERM&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Termination signal&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGTRAP&lt;/td>
&lt;td>P2001&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>Trace/breakpoint trap&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGTTIN&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Stop&lt;/td>
&lt;td>Terminal input for background process&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGTTOU&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Stop&lt;/td>
&lt;td>Terminal output for background process&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGUNUSED&lt;/td>
&lt;td>-&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>Synonymous with SIGSYS&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGURG&lt;/td>
&lt;td>P2001&lt;/td>
&lt;td>Ign&lt;/td>
&lt;td>Urgent condition on socket (4.2BSD)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGUSR1&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>User-defined signal 1&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGUSR2&lt;/td>
&lt;td>P1990&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>User-defined signal 2&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGVTALRM&lt;/td>
&lt;td>P2001&lt;/td>
&lt;td>Term&lt;/td>
&lt;td>Virtual alarm clock (4.2BSD)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGXCPU&lt;/td>
&lt;td>P2001&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>CPU time limit exceeded (4.2BSD);&lt;br>see setrlimit(2)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGXFSZ&lt;/td>
&lt;td>P2001&lt;/td>
&lt;td>Core&lt;/td>
&lt;td>File size limit exceeded (4.2BSD);&lt;br>see setrlimit(2)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>SIGWINCH&lt;/td>
&lt;td>-&lt;/td>
&lt;td>Ign&lt;/td>
&lt;td>Window resize signal (4.3BSD, Sun)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item><item><title>rtsp 串流異常分析</title><link>https://chiehting.com/posts/rtsp-rtp-packet-analyzer/</link><pubDate>Wed, 16 Jul 2025 11:55:09 +0800</pubDate><guid>https://chiehting.com/posts/rtsp-rtp-packet-analyzer/</guid><description>
&lt;p>Real Time Streaming Protocol &lt;a href="https://datatracker.ietf.org/doc/html/rfc2326">(RTSP)&lt;/a> 是基於 Real-time Transport Protocol &lt;a href="https://datatracker.ietf.org/doc/html/rfc3550">(RTP)&lt;/a> 之上的協議，負責控制串流會話。&lt;/p>
&lt;p>這次發生的問題是串流會異常終止，查看封包後發現 client 送 RTP 長度不足，導致串流中斷。&lt;/p>
&lt;h3 id="tcpdump">Tcpdump&lt;/h3>
&lt;p>使用 tcpdump 來抓包，保存成 Wireshark 可以開啟的檔案。在 Server 上執行命令開始抓包。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">tcpdump -i any -s &lt;span class="m">0&lt;/span> -w /tmp/dump.pcap -U
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="packet-analyzer">Packet Analyzer&lt;/h3>
&lt;h4 id="packet-protocol">Packet protocol&lt;/h4>
&lt;p>這邊抓到了異常的封包，關注其中的 RTSP Interleaved Frame、Real-Time Transport Protocol、Real Time Streaming Protocol，正常的傳輸中不會出現 Real Time Streaming Protocol。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">Frame 477: 1508 bytes on wire (12064 bits), 1508 bytes captured (12064 bits)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Linux cooked capture v1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">Internet Protocol Version 4, Src: 10.2.1.220, Dst: 10.2.3.199
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">Transmission Control Protocol, Src Port: 40725, Dst Port: 8554, Seq: 16706, Ack: 1449, Len: 1452
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">[2 Reassembled TCP Segments (1018 bytes): #475(1002), #477(16)]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">RTSP Interleaved Frame, Channel: 0x00, 1014 bytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> Magic: 0x24
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> Channel: 0x00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> Length: 1014
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">Real-Time Transport Protocol
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> [Stream setup by DECODE AS (frame 443)]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> 10.. .... = Version: RFC 1889 Version (2)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> ..0. .... = Padding: False
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> ...0 .... = Extension: False
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> .... 0000 = Contributing source identifiers count: 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> 0... .... = Marker: False
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> Payload type: DynamicRTP-Type-96 (96)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> Sequence number: 16
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> [Extended sequence number: 65552]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> Timestamp: 13747590
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> [Extended timestamp: 4308714886]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> Synchronization Source identifier: 0x18877309 (411529993)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> Payload […]: 7c05d4fe1ff6280a012732b0fecce5fd5c5fe4461807787cfabe2b0e3caf228
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">Real Time Streaming Protocol
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> Data (1436 bytes)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="rtsp-interleaved-frame">RTSP Interleaved Frame&lt;/h4>
&lt;p>RTSP交錯幀允許在同一條連接上交錯傳輸RTSP控制信息與媒體流數據。RTSP Interleaved Frame 是 4 bytes 的內容，下面是 RTSP Interleaved Frame 的 packet bytes 內容範例，用 Hex Dump 顯示。&lt;/p>
&lt;p>RTSP Interleaved Frame 內容包括了三個資訊：&lt;/p>
&lt;ol>
&lt;li>Magic: 0x24&lt;/li>
&lt;li>Channel: 0x00&lt;/li>
&lt;li>Length: 0x03f6，這邊換算出來是 1014&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">0000 24 00 03 f6
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>依照上面內容，接下來的 RTP 需要傳送 1014 bytes 的內容，接著再接收一次 RTSP Interleaved Frame。&lt;/p>
&lt;h4 id="real-time-transport-protocol">Real-Time Transport Protocol&lt;/h4>
&lt;p>在 RTS 傳輸時發生問題，RTS 的內容長度不足 1014 bytes 導致後面的串流幀都亂掉了。接著收到 Real Time Streaming Protocol，其內容 RTSP 已經無法使用，導致 RTSP session 中斷。&lt;/p>
&lt;ol>
&lt;li>使用 &lt;code>24&lt;/code> 去搜尋，發現在 01c0 行有 RTSP Interleaved Frame 的內容 &lt;code>24 00 03 f6&lt;/code>，看到交錯幀提早到了。&lt;/li>
&lt;li>在 0000 行有 &lt;code>00 10&lt;/code> 表示第 16 幀。接著看到 01c0 行有 &lt;code>00 11&lt;/code> 表示第 17 幀。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">0000 80 60 00 10 00 d1 c5 86 18 87 73 09 7c 05 d4 fe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">0010 1f f6 28 0a 01 27 32 b0 fe cc e5 fd 5c 5f e4 46
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">0020 18 07 78 7c fa be 2b 0e 3c af 22 8b c5 24 c4 0f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">0030 15 f9 b1 49 ea e3 85 df 77 f0 0a bb 93 95 2a a5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">0040 38 f2 ff 9e 07 fb e5 ca 60 c2 e0 30 8f 78 37 5a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">0050 45 e1 45 77 f0 6a 4a 21 cc 43 8d 85 ca cc 69 6e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">0060 f0 87 72 7d ee 78 73 c2 8a 85 05 5f 87 38 ee 32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">0070 a7 3c e1 f5 bb 93 85 49 c2 ac ca 7c 22 1c 21 04
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">0080 f0 8d 92 7b cf f8 51 51 0f 38 73 c7 80 62 18 5c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">0090 65 4b 19 ce 75 07 4b cd 60 77 12 93 95 e2 e1 07
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">00a0 00 7b 59 53 d3 ff fd 5f 3d e1 08 08 42 8b 0a 0a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">00b0 bf 5d cb e5 a9 72 0f 5d 74 50 7f 44 d4 10 0d 18
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">00c0 c8 87 db b5 7e 7c f9 c0 2f ff 58 d4 6f 38 c6 54
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">00d0 b0 19 20 2b 6e c8 c1 b2 5f 10 e0 50 56 b3 a2 28
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">00e0 df ff 86 e5 e5 55 4b 2f 9b 4c 43 c7 6e 59 9f e5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">00f0 da 9c 38 e4 82 bf 87 24 03 00 1c 80 c8 00 06 61
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">0100 66 fb 2a ec 20 69 5c b6 9f be 76 00 12 a5 e0 00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">0110 00 00 00 00 00 00 00 24 02 00 ac 80 00 00 64 00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">0120 12 ac c8 61 66 fb 2a 7a 79 77 76 7a 7b 7b fc 7e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">0130 7d fd fd fe 7d 7c 78 78 76 76 76 73 76 76 78 78
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">0140 7b 7e fb fc f9 fa fa fc 7e 7d 76 77 78 79 78 78
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">0150 78 7b fc fb f7 ef ee ec e9 e7 ea ea eb ec f2 f6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">0160 fd 7e 7b 79 7b 79 78 77 79 fd f7 f3 f1 f4 f7 fa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">0170 fb fe ff 7d 7c fe fb f8 f8 f8 fb fc ff 7d fa fd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">0180 f9 f4 f1 ef f0 f4 f4 f9 fd fd 7e f9 f6 f1 f0 f1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">0190 f4 f6 f7 fb ff 7d ff fb f8 f7 f6 f7 f4 f4 f5 f6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">01a0 f8 fe 7b 75 70 6d 6b 6c 6c 71 74 7d fe fb fb fb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">01b0 f7 fb fe 78 7a 78 75 74 75 76 75 79 7b 7b 79 7c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">01c0 7b 7d 7c 7b 7a 7b 7b 24 00 03 f6 80 60 00 11 00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">01d0 d1 c5 86 18 87 73 09 7c 05 21 88 6c 3d 7f 3a d3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">01e0 2f fe 01 0b c2 10 89 ce 1e f1 49 a8 56 e9 bd 20
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">01f0 a1 9d 55 54 55 94 e8 75 f7 77 7e 66 3c 43 3e dc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl">0200 6d 5b ae df 8a eb 06 b5 3b b7 7c 00 38 88 3a 51
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">0210 c3 db 6c 0f 86 ae fa e4 82 a7 39 6f e1 1a d2 fd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl">0220 53 0f b6 da ac 3e 1f f6 f8 ad ef 77 f6 a3 cb a5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl">0230 10 26 03 9a 52 e2 ac b0 5c f8 19 54 63 28 eb 69
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl">0240 9c 90 54 0d 6f 4c b5 ee 8d 6e f4 10 00 70 14 d1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl">0250 3f 4d 12 b3 14 61 55 41 84 d4 95 58 8b f5 77 6c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl">0260 37 40 77 dd fc d2 81 18 47 31 26 7d 95 f2 9b c7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl">0270 6f 1a 77 5d 9d 52 33 58 bb f4 4f f5 d4 4b 81 33
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">41&lt;/span>&lt;span class="cl">0280 fa 0e 89 d7 ff 77 75 bc 5e 2b cb 85 c9 71 d6 4b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">42&lt;/span>&lt;span class="cl">0290 81 1c 01 ce 1c 96 2f f4 fa 69 e9 df e1 7b dd df
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">43&lt;/span>&lt;span class="cl">02a0 19 48 56 21 c3 9c 15 97 05 6d c3 da 5d 88 73 47
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">44&lt;/span>&lt;span class="cl">02b0 03 c2 fe 3e 5e 91 5a e0 d9 aa 72 48 00 3c f3 89
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">45&lt;/span>&lt;span class="cl">02c0 0a fd 1e 5e 0e 5f 32 00 7f bb c1 44 6e a2 0e 0a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">46&lt;/span>&lt;span class="cl">02d0 f0 0e 3c f0 be c9 15 1d f0 bd d9 50 da d8 e4 3c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">47&lt;/span>&lt;span class="cl">02e0 7e 0d e3 e2 f1 b4 7d 59 51 bf 89 74 4b bd ff 75
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">48&lt;/span>&lt;span class="cl">02f0 77 7f dc 57 76 e2 64 80 a8 9e 24 7f 62 0b 3e 2c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">49&lt;/span>&lt;span class="cl">0300 71 39 44 e1 bb fd f7 ff c2 94 43 84 cf 9b c9 01
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">50&lt;/span>&lt;span class="cl">0310 56 e1 e3 42 ea ce 79 ee 7b 7c 4b 4e fb bf 0c 63
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">51&lt;/span>&lt;span class="cl">0320 4e 3c 79 65 b1 59 70 b6 70 39 bb f1 b6 d9 7d 14
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">52&lt;/span>&lt;span class="cl">0330 f5 bf 85 0d 1a 1b f5 e6 92 78 b2 fd 1f fc 35 84
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">53&lt;/span>&lt;span class="cl">0340 03 ab f7 f7 7d a0 aa b5 a7 58 c4 23 fe 71 d4 cb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">54&lt;/span>&lt;span class="cl">0350 df 12 e4 f9 54 db b7 d3 4d 34 e0 b3 f8 1a 1b ae
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">55&lt;/span>&lt;span class="cl">0360 79 72 21 cb b4 b9 0a 2a 39 3b d6 ec 61 80 28 a7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">56&lt;/span>&lt;span class="cl">0370 58 c2 f8 ae 6d b6 8b f7 d3 2f ae 1a ee fc 42 fa
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">57&lt;/span>&lt;span class="cl">0380 2c b8 de 5c 29 1a 82 df 8f 62 5e 91 6c 65 49 41
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">58&lt;/span>&lt;span class="cl">0390 5a 9f ca a4 a8 07 b8 26 fd ef 1d a9 ce 17 ae c8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">59&lt;/span>&lt;span class="cl">03a0 3b 92 89 00 38 59 9f c9 2a 84 a7 9e 4c 15 3f ce
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">60&lt;/span>&lt;span class="cl">03b0 a9 f8 24 42 0e 3e 18 2b c5 c1 62 3f ea 0c 9a 97
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">61&lt;/span>&lt;span class="cl">03c0 9c 03 92 f4 92 03 c3 4a 0f 83 f7 81 ff 1f 2a 38
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">62&lt;/span>&lt;span class="cl">03d0 2e 22 00 5f dd ef de 63 77 42 0d e7 00 c0 6a c9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">63&lt;/span>&lt;span class="cl">03e0 44 e5 0b c1 59 e2 fd d0 01 5e 79 8b 93 61 41 54
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">64&lt;/span>&lt;span class="cl">03f0 60 fd 65 57 80 b8
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>什麼是 IPv6</title><link>https://chiehting.com/posts/what-is-ipv6/</link><pubDate>Wed, 18 Jun 2025 13:47:21 +0800</pubDate><guid>https://chiehting.com/posts/what-is-ipv6/</guid><description>
&lt;p>IPv6（Internet Protocol version 6）是網際網路協議（IP）的第六版，用於識別和定位網路上的設備，並負責在它們之間傳輸數據。IPv6 使用 128 bit 的地址長度，比起 IPv4 的 32 bit 的地址長度更多。&lt;/p>
&lt;h2 id="ipv6-定義">IPv6 定義&lt;/h2>
&lt;p>假設 IPv6 地址為 2001:0db8:85a3:0000:0000:8a2e:0370:7334&lt;/p>
&lt;h3 id="簡化表示規則">簡化表示規則&lt;/h3>
&lt;p>可簡化表示: 2001:db8:85a3::8a2e:370:7334。&lt;/p>
&lt;ul>
&lt;li>去除連續零，85a3:0000:0000:8a2e 可表示為 85a3::8a2e&lt;/li>
&lt;li>去除前導零，0370 可以表示為 370&lt;/li>
&lt;/ul>
&lt;h3 id="結構分解">結構分解&lt;/h3>
&lt;p>IPv6 地址是一個 &lt;strong>128 位(bit)&lt;/strong> 的地址，以 16 進位表示，分為 8 組，每組 4 個 16 位元(16-bit)，用冒號分隔例如：&lt;code>2001:0db8:85a3:0000:0000:8a2e:0370:7334&lt;/code>，下面表格為 128 位的定義，包括 &lt;code>Global Prefix&lt;/code>、&lt;code>Subnet ID&lt;/code>、&lt;code>Interface ID&lt;/code>。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Global Prefix&lt;/th>
&lt;th>Subnet ID&lt;/th>
&lt;th>Interface ID&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>48 bits&lt;/td>
&lt;td>16 bits&lt;/td>
&lt;td>64 bits&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>以上面地址為例子，其結構如下表。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Global Prefix（48 bits）&lt;/th>
&lt;th>Subnet ID&lt;/th>
&lt;th>Interface ID&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>2001:0db8:85a3&lt;/td>
&lt;td>0000&lt;/td>
&lt;td>0000:8a2e:0370:7334&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>全球路由前綴 (Global Prefix)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>地址的前 &lt;strong>48 位&lt;/strong>，用於標識網路範圍。&lt;/li>
&lt;li>在該地址中：&lt;br>
&lt;strong>&lt;code>2001:0db8:85a3&lt;/code>&lt;/strong> 是全球路由前綴。
&lt;ul>
&lt;li>&lt;code>2001&lt;/code>：表示該地址屬於全球可路由的 IPv6 網段。&lt;/li>
&lt;li>&lt;code>0db8&lt;/code>：是一個特殊的文檔範例前綴（RFC 3849 定義，僅用於教學與測試）。&lt;/li>
&lt;li>&lt;code>85a3&lt;/code>：進一步標識特定網路範圍。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>子網 ID (Subnet ID)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>地址的第 &lt;strong>49 至 64 位&lt;/strong>，用於標識子網。&lt;/li>
&lt;li>在該地址中：&lt;br>
&lt;strong>&lt;code>0000&lt;/code>&lt;/strong> 是子網 ID，表示該地址位於主網或未進行子網劃分。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>接口 ID (Interface ID)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>地址的最後 &lt;strong>64 位&lt;/strong>，用於標識子網內的具體設備（主機）。&lt;/li>
&lt;li>在該地址中：&lt;br>
&lt;strong>&lt;code>0000:8a2e:0370:7334&lt;/code>&lt;/strong> 是接口 ID，通常由設備自動生成或手動配置。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol></description></item><item><title>建立支持 IPv6 的 權限給 EKS</title><link>https://chiehting.com/posts/aws-eks-vpc-cni-support-ipv6/</link><pubDate>Sat, 14 Jun 2025 13:24:19 +0800</pubDate><guid>https://chiehting.com/posts/aws-eks-vpc-cni-support-ipv6/</guid><description>
&lt;p>&lt;a href="https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/cni-ipv6.html">了解叢集、Pod 和 服務的 IPv6 地址&lt;/a>&lt;/p>
&lt;p>EKS 中的配置 Cluster IP address family 選擇 IPv6 時，需要&lt;a href="https://docs.aws.amazon.com/zh_tw/eks/latest/userguide/cni-iam-role.html#cni-iam-role-create-ipv6-policy">設定 Amazon VPC CNI 外掛程式以使用 IRSA&lt;/a>。&lt;/p>
&lt;p>環境定義：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>參數說明&lt;/th>
&lt;th>參數內容&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>eks cluster 名稱&lt;/td>
&lt;td>development-souffle&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>policy 名稱&lt;/td>
&lt;td>development-souffle-VPCCNIIPv6&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>role 名稱&lt;/td>
&lt;td>development-souffle-VPCCNIIPv6&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="從-eks-中取得-oidc-url">從 EKS 中取得 OIDC URL&lt;/h2>
&lt;p>透過 aws cli 命令取得 EKS 中的 OIDC URL。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">aws eks describe-cluster --name development-souffle --query &lt;span class="s2">&amp;#34;cluster.identity.oidc.issuer&amp;#34;&lt;/span> --output text
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>回傳的結果如下。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">https://oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="建立-iam-policy-並定義可以使用的權限">建立 IAM policy 並定義可以使用的權限&lt;/h2>
&lt;p>因為 AWS 維護的 AmazonEKS_CNI_Policy 權限不足沒辦法分配 IPv6 地址，所以需要建立新 policy，下面為配置定義。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Version&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2012-10-17&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Statement&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Effect&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Allow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Action&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:AssignIpv6Addresses&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:DescribeInstances&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:DescribeTags&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:DescribeNetworkInterfaces&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:DescribeInstanceTypes&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Resource&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Effect&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Allow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Action&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:CreateTags&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Resource&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;arn:aws:ec2:*:*:network-interface/*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="建立-vpc-cni-role-並定義-trust-relationships">建立 VPC CNI role 並定義 trust relationships&lt;/h2>
&lt;p>要配置 IRSA(IAM role for service account) 讓 pod kube-system:aws-node 可以提權，所以需要定義 trust relationships，下面 json 是 Trusted entities 的定義，其中：&lt;/p>
&lt;ul>
&lt;li>Effect 固定 Allow&lt;/li>
&lt;li>Federated 為 OIDC 的 arn，可以去 IAM &amp;gt; Identity providers 底下找&lt;/li>
&lt;li>Action 固定 &amp;quot;sts:AssumeRoleWithWebIdentity&amp;quot;&lt;/li>
&lt;li>StringEquals
&lt;ol>
&lt;li>aud (Audience) 為 sts.amazonaws.com 可以使用 Token 授權&lt;/li>
&lt;li>sub (Subject) 為 system:serviceaccount:kube-system:aws-node 可以提權&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Version&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2012-10-17&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Statement&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Effect&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Allow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Principal&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Federated&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;arn:aws:iam::111122223333:oidc-provider/oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Action&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;sts:AssumeRoleWithWebIdentity&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Condition&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;StringEquals&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE:aud&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;sts.amazonaws.com&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;oidc.eks.region-code.amazonaws.com/id/EXAMPLED539D4633E53DE1B71EXAMPLE:sub&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;system:serviceaccount:kube-system:aws-node&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="將-policy-權限加入到-role-中">將 policy 權限加入到 role 中&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">aws iam attach-role-policy &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span> --policy-arn arn:aws:iam::111122223333:policy/development-souffle-VPCCNIIPv6 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span> --role-name development-souffle-VPCCNIIPv6
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="加入-ann-到-serviceaccount-aws-node-中使其角色可以提權">加入 ann 到 serviceaccount aws-node 中，使其角色可以提權&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">kubectl get serviceaccount -n kube-system aws-node -o yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">kubectl annotate serviceaccount &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span> -n kube-system aws-node &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span> eks.amazonaws.com/role-arn&lt;span class="o">=&lt;/span>arn:aws:iam::111122223333:role/development-souffle-VPCCNIIPv6
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="重新部署-aws-node-所有-pod-使其可以使用到新的-service-account-權限">重新部署 aws-node 所有 pod 使其可以使用到新的 service account 權限&lt;/h2></description></item><item><title>使用 coco 2017 dataset 做 yolo11 訓練</title><link>https://chiehting.com/posts/yolo-with-coco-dataset/</link><pubDate>Sun, 18 May 2025 23:28:07 +0800</pubDate><guid>https://chiehting.com/posts/yolo-with-coco-dataset/</guid><description>
&lt;h2 id="使用-coco-2017-dataset-訓練-yolo11">使用 COCO 2017 Dataset 訓練 YOLO11&lt;/h2>
&lt;h3 id="專案流程總覽">專案流程總覽&lt;/h3>
&lt;p>&lt;a href="https://github.com/chiehting/yolo-with-coco-dataset">github: yolo-with-coco-dataset&lt;/a>&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>資料集準備&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>從 COCO 官方網站下載 2017 年版的訓練集、驗證集圖片及標註檔案。&lt;/li>
&lt;li>將資料分別放在 &lt;code>coco2017/annotations&lt;/code>、&lt;code>coco2017/train2017&lt;/code>、&lt;code>coco2017/val2017&lt;/code> 目錄下。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>資料格式轉換&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>使用 &lt;code>1_convert_to_yolo11.py&lt;/code> 進行 COCO → YOLO 格式轉換，並可過濾所需的類別（categories）。&lt;/li>
&lt;li>COCO bbox 格式為 &lt;code>[x_min, y_min, width, height]&lt;/code>，需轉成 YOLO 格式 &lt;code>[class_id, x_center, y_center, width, height]&lt;/code>，且所有值需歸一化到 [0, 1]。&lt;/li>
&lt;li>需自行設計類別對應（category mapping）。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>訓練流程&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>執行 &lt;code>2_train.py&lt;/code> 進行模型訓練。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>推論預測&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>執行 &lt;code>3_predict.py&lt;/code> 進行圖片預測。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="1-準備資料集">1. 準備資料集&lt;/h3>
&lt;p>這是最關鍵的步驟之一：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>收集圖片&lt;/strong>：收集包含您想要偵測物件的圖片&lt;/li>
&lt;li>&lt;strong>標註資料&lt;/strong>：為每張圖片中的目標物件創建標註（邊界框和類別）&lt;/li>
&lt;li>&lt;strong>資料集分割&lt;/strong>：將資料集分為訓練集、驗證集和測試集（通常比例為 70%/20%/10%）&lt;/li>
&lt;/ul>
&lt;p>YOLO 格式&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&amp;lt;class_id&amp;gt; &amp;lt;x_center&amp;gt; &amp;lt;y_center&amp;gt; &amp;lt;width&amp;gt; &amp;lt;height&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>COCO 的邊界框格式 &lt;code>[x_min, y_min, width, height]&lt;/code> 轉換為 YOLO 的 &lt;code>[x_center, y_center, width, height]&lt;/code> 格式&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># COCO 格式邊界框&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="n">x_min&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">433.61&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="n">y_min&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">213.88&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="n">width&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">39.67&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="n">height&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">112.56&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="n">category_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="c1"># 圖片尺寸&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="n">image_width&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">640&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="n">image_height&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">480&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="c1"># 計算 YOLO 格式的中心點座標&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="n">x_center&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">x_min&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">width&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">image_width&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="n">y_center&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">y_min&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">height&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">image_height&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="c1"># 計算 YOLO 格式的寬高（歸一化）&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="n">yolo_width&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">width&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">image_width&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="n">yolo_height&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">height&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">image_height&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="c1"># 假設我們將 COCO 類別 ID 16 映射到 YOLO 類別 ID 5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="n">yolo_class_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">5&lt;/span> &lt;span class="c1"># 這取決於您的類別映射&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="c1"># 生成 YOLO 格式的字串&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="n">yolo_format&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">yolo_class_id&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">x_center&lt;/span>&lt;span class="si">:&lt;/span>&lt;span class="s2">.6f&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">y_center&lt;/span>&lt;span class="si">:&lt;/span>&lt;span class="s2">.6f&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">yolo_width&lt;/span>&lt;span class="si">:&lt;/span>&lt;span class="s2">.6f&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">yolo_height&lt;/span>&lt;span class="si">:&lt;/span>&lt;span class="s2">.6f&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">yolo_format&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>File system of Linux</title><link>https://chiehting.com/posts/file-system/</link><pubDate>Mon, 12 May 2025 22:34:05 +0800</pubDate><guid>https://chiehting.com/posts/file-system/</guid><description>
&lt;h3 id="file-system-type">File system type&lt;/h3>
&lt;p>在 Linux 系統中，&lt;code>shm&lt;/code> 和 &lt;code>tmpfs&lt;/code> 是兩種特殊的檔案系統，代表不同的用途：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>shm（共享內存）：&lt;/strong>
&lt;ul>
&lt;li>&lt;code>shm&lt;/code> 是共享內存（Shared Memory）的縮寫，它是一種允許不同進程之間共享內存區域的機制。在 Linux 中，&lt;code>/dev/shm&lt;/code> 目錄用於掛載共享內存文件系統。這裡的檔案系統不是真正的硬碟，而是一個存在於記憶體中的虛擬檔案系統，用於進程之間的快速通信。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>tmpfs（臨時文件系統）：&lt;/strong>
&lt;ul>
&lt;li>&lt;code>tmpfs&lt;/code> 是一種基於記憶體的臨時文件系統，它允許將一部分系統內存用作檔案系統。它通常被用於存儲臨時文件和資料，而不是實際的硬碟。&lt;code>/tmp&lt;/code> 目錄通常是 &lt;code>tmpfs&lt;/code> 的一個例子，但也可以在其他地方創建 &lt;code>tmpfs&lt;/code> 檔案系統。這個臨時文件系統在系統重新啟動時通常會被清除。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>總之，&lt;code>shm&lt;/code> 是用於實現進程間共享內存的文件系統，而 &lt;code>tmpfs&lt;/code> 是一種臨時文件系統，通常用於存儲臨時文件和資料。&lt;/p>
&lt;h3 id="file-system-io">File system IO&lt;/h3>
&lt;p>Filesystem I/O 指的是檔案系統的輸入/輸出操作，包括多個操作，比如文件的打開和關閉、文件的定位、文件的截斷等。要注意觀念，不能過於簡單的使用 &lt;code>write/read&lt;/code> 的值作為 IO 結果。&lt;/p>
&lt;p>然而，如果問題是特別針對磁碟寫入和讀取，並且你有一個上下文，那麼簡單地使用 &lt;code>write/read&lt;/code> 作為衡量磁碟 I/O 性能的指標是有一定合理性的。這個比值可以給你一個粗略的概念，即磁碟的寫入速度相對於讀取速度的比例。較大的比值可能表示寫入操作的性能相對較差，反之則相對較好。&lt;/p></description></item><item><title>top 工具</title><link>https://chiehting.com/posts/linux-top/</link><pubDate>Mon, 12 May 2025 21:35:47 +0800</pubDate><guid>https://chiehting.com/posts/linux-top/</guid><description>
&lt;p>&lt;code>top&lt;/code> 是一個在類 Unix 系統（包括 macOS 和 Linux）中常用的工具，用於即時監控系統的行程（processes）和資源使用情況。&lt;/p>
&lt;h3 id="processes行程和執行緒總覽">Processes，行程和執行緒總覽&lt;/h3>
&lt;p>Processes: 491 total, 5 running, 486 sleeping, 3862 threads&lt;/p>
&lt;ul>
&lt;li>&lt;code>Processes: 491 total&lt;/code>: 系統中總共有 491 個行程。&lt;/li>
&lt;li>&lt;code>5 running&lt;/code>: 有 5 個行程目前正在執行中。&lt;/li>
&lt;li>&lt;code>486 sleeping&lt;/code>: 有 486 個行程目前處於睡眠狀態（等待某些事件發生）。&lt;/li>
&lt;li>&lt;code>3862 threads&lt;/code>: 系統中總共有 3862 個執行緒。執行緒是行程內部的執行單元，一個行程可以有多個執行緒。&lt;/li>
&lt;/ul>
&lt;h3 id="load-average-系統負載和-cpu-使用率">Load Average ，系統負載和 CPU 使用率&lt;/h3>
&lt;p>Load average 值是一個綜合性的指標，受到多種因素的影響。透過分析負載平均值的變化，系統管理員可以更好地了解系統的運行狀態，並及時採取適當的措施以維持穩定的性能。Linux 中的 load average 被描述為三個不同的十進制值。以下面的例子可以看到 &lt;code>load averages: 1.26 1.35 1.36&lt;/code>，由左至右分別為 1 分鐘、5 分鐘、10分鐘的平均負載狀況如下解釋：&lt;/p>
&lt;ul>
&lt;li>1 分鐘平均負載： 這表示過去 1 分鐘內正在運行或等待執行的平均進程數。&lt;/li>
&lt;li>5分鐘平均負載： 這表示過去 5 分鐘內正在運行或等待執行的平均進程數。&lt;/li>
&lt;li>15 分鐘平均負載： 這表示過去 15 分鐘內正在運行或等待執行的平均進程數。&lt;/li>
&lt;/ul>
&lt;p>下面有幾種狀況的解釋：&lt;/p>
&lt;ul>
&lt;li>如果平均值為 0.0，表示系統處於空閒狀態&lt;/li>
&lt;li>如果1min 平均值高於 5min 或 15min 平均值，則負載正在增加&lt;/li>
&lt;li>如果1min 平均值低於 5min 或 15min 平均值，則負載正在減少&lt;/li>
&lt;li>如果它們高於系統 CPU 的數量，那麼系統很可能會遇到效能問題（視情況而定）&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">➜ uptime
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> 9:14 up &lt;span class="m">4&lt;/span> days, 14:31, &lt;span class="m">1&lt;/span> user, load averages: 1.26 1.35 1.36
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Load average 的變化受到多種因素的影響，它主要反映了系統的活動水平和性能狀態。以下是一些可能影響負載平均值變化的因素：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>CPU 使用率： 系統中運行的進程需要使用 CPU 資源。如果 CPU 使用率較高，系統的負載平均值可能會增加。這可能是由於執行大量計算密集型任務或多個進程競爭 CPU 資源。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>I/O 操作： 大量的 I/O 操作，例如磁盤讀寫、網絡輸入輸出等，可能導致系統的負載增加。這可能是由於多個進程在等待 I/O 完成，使得系統處於等待狀態。下面有解釋到為什麼 I/O 操作會影響 load avg&lt;/p>
&lt;blockquote>
&lt;p>「「平均負載」的目的是從人的角度得出一個與系統繁忙程度有關的數字。TASK_UNINTERRUPTIBLE 意味著進程正在等待諸如磁碟讀取之類的東西，這會增加系統負載。一個嚴重受磁碟限制的系統可能會非常緩慢，但TASK_RUNNING 平均值僅為0.1，這對任何人都沒有幫助。”&lt;/p>
&lt;/blockquote>
&lt;/li>
&lt;li>
&lt;p>內存使用： 系統的內存使用情況也會影響 load avg。如果系統中的進程需要大量的內存，可能會導致系統的交換（swap）操作，進而增加 load avg。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>進程數量： 系統中運行的進程數量會影響 load avg。當存在大量的活動進程，無論是運行中還是等待執行，都可能導致 load avg 值升高。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>等待時間： 如果進程需要等待某些資源（例如鎖或同步），這可能導致系統的 load avg。這也包括在多核系統中，某些進程可能需要等待 CPU 核心的可用性。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>系統的整體性能： 硬體性能、網絡帶寬、存儲速度等硬體因素都可能影響系統的整體性能，進而影響 load avg。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>突發性事件： 例如突然的大量流量、系統故障、惡意攻擊等，都可能導致負載平均值的急劇增加。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="cpu-的使用率分佈">CPU 的使用率分佈&lt;/h3>
&lt;p>CPU usage: 14.20% user, 4.66% sys, 81.13% idle SharedLibs: 448M resident, 109M data, 66M linkedit. MemRegions: 117 total, 3936K resident, 4208K private, 2377M shared.&lt;/p>
&lt;ul>
&lt;li>&lt;code>CPU usage: 14.20% user, 4.66% sys, 81.13% idle&lt;/code>
&lt;ul>
&lt;li>&lt;code>user&lt;/code>: 14.20% 的 CPU 時間花費在執行使用者空間的行程（用戶啟動的應用程式等）。&lt;/li>
&lt;li>&lt;code>sys&lt;/code>: 4.66% 的 CPU 時間花費在執行核心空間的程式碼（系統呼叫、裝置驅動等）。&lt;/li>
&lt;li>&lt;code>idle&lt;/code>: 81.13% 的 CPU 時間處於空閒狀態。&lt;/li>
&lt;li>這表示機器的 CPU 大部分時間是空閒的，系統目前並未因為 CPU 瓶頸而變慢。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>SharedLibs: 448M resident, 109M data, 66M linkedit&lt;/code>: 共享函式庫的使用情況。&lt;code>resident&lt;/code> 是實際佔用的記憶體，&lt;code>data&lt;/code> 和 &lt;code>linkedit&lt;/code> 是其中的數據和連結編輯部分。這部分對於一般使用者來說不是最關鍵的指標。&lt;/li>
&lt;/ul>
&lt;h3 id="實體記憶體-ram-使用情況">實體記憶體 (RAM) 使用情況&lt;/h3>
&lt;p>PhysMem: 15G used (3217M wired, 5955M compressor), 138M unused.&lt;/p>
&lt;ul>
&lt;li>&lt;code>PhysMem: 15G used (3217M wired, 5955M compressor), 138M unused&lt;/code>: 實體記憶體（RAM）的總體使用情況。
&lt;ul>
&lt;li>&lt;code>15G used&lt;/code>: 總共使用了 15 GB 的實體記憶體。&lt;/li>
&lt;li>&lt;code>(3217M wired)&lt;/code>: 其中 3217 MB 是「有線記憶體」(wired memory)，這部分記憶體不能被交換到硬碟上，通常由核心和關鍵系統服務使用。&lt;/li>
&lt;li>&lt;code>(5955M compressor)&lt;/code>: 其中 5955 MB 是被壓縮的記憶體。macOS 會壓縮不常用的記憶體頁面，而不是直接交換到硬碟，以提高性能。&lt;/li>
&lt;li>&lt;code>138M unused&lt;/code>: 還有 138 MB 的實體記憶體是完全未使用的。&lt;/li>
&lt;li>這顯示機器有 16GB 記憶體（15G used + 138M unused ≈ 15.138G）大部分正在被使用，但有相當一部分是被壓縮的。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="虛擬記憶體-vm-使用情況">虛擬記憶體 (VM) 使用情況&lt;/h3>
&lt;p>VM: 260T vsize, 5684M framework vsize, 22745372(0) swapins, 26777028(0) swapouts.&lt;/p>
&lt;ul>
&lt;li>&lt;code>VM: 260T vsize, 5684M framework vsize, 22745372(0) swapins, 26777028(0) swapouts&lt;/code>: 虛擬記憶體的使用情況。
&lt;ul>
&lt;li>&lt;code>260T vsize&lt;/code>: 總共的虛擬位址空間大小 (Virtual Size)。這是一個非常大的數字，表示系統可以定址的總記憶體範圍，並不代表實際佔用的硬碟空間。&lt;/li>
&lt;li>&lt;code>5684M framework vsize&lt;/code>: 框架 (Framework) 佔用的虛擬位址空間。&lt;/li>
&lt;li>&lt;code>22745372(0) swapins&lt;/code>: 從硬碟交換空間讀入記憶體的次數。括號裡的 0 表示最近沒有發生 swapin。&lt;/li>
&lt;li>&lt;code>26777028(0) swapouts&lt;/code>: 從記憶體寫入硬碟交換空間的次數。括號裡的 0 表示最近沒有發生 swapout。&lt;/li>
&lt;li>&lt;code>swapins&lt;/code> 和 &lt;code>swapouts&lt;/code> 的次數如果持續增加，表示系統正在頻繁地使用硬碟作為擴充記憶體，這通常會導致系統變慢。輸出顯示最近沒有發生交換活動 (括號裡是 0)，這是一個好現象。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="網路活動">網路活動&lt;/h3>
&lt;p>Networks: packets: 120201633/129G in, 61599676/35G out.&lt;/p>
&lt;ul>
&lt;li>&lt;code>Networks: packets: 120201633/129G in, 61599676/35G out&lt;/code>: 網路流量統計，是系統啟動以來的累計數據。
&lt;ul>
&lt;li>&lt;code>120201633/129G in&lt;/code>: 總共接收了 120,201,633 個封包，總數據量為 129 GB。&lt;/li>
&lt;li>&lt;code>61599676/35G out&lt;/code>: 總共發送了 61,599,676 個封包，總數據量為 35 GB。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="硬碟活動">硬碟活動&lt;/h3>
&lt;p>Disks: 1351063132/22T read, 56259681/1931G written.&lt;/p>
&lt;ul>
&lt;li>&lt;code>Disks: 1351063132/22T read, 56259681/1931G written&lt;/code>: 磁碟讀寫統計，是系統啟動以來的累計數據。
&lt;ul>
&lt;li>&lt;code>1351063132/22T read&lt;/code>: 總共讀取了 1,351,063,132 次操作，總數據量為 22 TB。&lt;/li>
&lt;li>&lt;code>56259681/1931G written&lt;/code>: 總共寫入了 56,259,681 次操作，總數據量為 1931 GB (約 1.93 TB)。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item><item><title>Linux</title><link>https://chiehting.com/posts/linux-cpu/</link><pubDate>Mon, 12 May 2025 18:04:29 +0800</pubDate><guid>https://chiehting.com/posts/linux-cpu/</guid><description>
&lt;p>在 Linux 中，&lt;code>top&lt;/code> 或 &lt;code>vmstat&lt;/code> 等系統性能工具通常會顯示 CPU 使用情況，其中包括了不同的 CPU 狀態。以下是各種 CPU 狀態的意義：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>idle（閒置）：&lt;/strong> 這表示 CPU 完全空閒，沒有在執行任何任務。&lt;/li>
&lt;li>&lt;strong>iowait（I/O 等待）：&lt;/strong> 表示 CPU 正在等待I/O操作（例如磁盤讀寫）完成。當系統中的I/O操作比較繁忙時，這個值可能會上升。&lt;/li>
&lt;li>&lt;strong>irq（硬中斷）：&lt;/strong> 這表示 CPU 正在處理硬中斷。硬中斷通常來自硬體設備，例如網卡、鍵盤等。&lt;/li>
&lt;li>&lt;strong>nice（優先級）：&lt;/strong> 這表示 CPU 正在執行“優先級”比較高的進程，這通常是由使用者明確指定的。&lt;/li>
&lt;li>&lt;strong>softirq（軟中斷）：&lt;/strong> 類似於硬中斷，但是軟中斷通常是由內核中的軟體事件觸發的，而不是硬體設備觸發的。&lt;/li>
&lt;li>&lt;strong>steal（虛擬機器搶奪）：&lt;/strong> 在虛擬化環境中，如果主機上的其他虛擬機器需要 CPU 資源，則可能會有 steal 時間，表示虛擬機器正在失去 CPU 資源。&lt;/li>
&lt;li>&lt;strong>system（系統）：&lt;/strong> 表示 CPU 正在執行內核空間的代碼，例如系統呼叫。&lt;/li>
&lt;li>&lt;strong>user（使用者）：&lt;/strong> 表示 CPU 正在執行用戶空間的代碼，例如應用程式。&lt;/li>
&lt;/ol>
&lt;p>這些狀態是根據 Linux 中的 /proc/stat 文件中的數據生成的，可以使用 &lt;code>cat /proc/stat&lt;/code> 查看實時 CPU 相關信息。&lt;/p></description></item><item><title>加入 MQTT 插件</title><link>https://chiehting.com/posts/jmeter-add-the-mqtt-plugin/</link><pubDate>Tue, 06 May 2025 13:11:44 +0800</pubDate><guid>https://chiehting.com/posts/jmeter-add-the-mqtt-plugin/</guid><description>
&lt;p>要對服務做壓力測試，目前服務的應用成協議有使用到 MQTT。而 Jmeter 預設並未支持 MQTT 協議，需要透過其他插件才能跟 MQTT 服務做溝通。&lt;/p>
&lt;p>要把對應的 jar 檔放進 JMeter 的 lib 資料夾，插件專案&lt;a href="https://github.com/emqx/mqtt-jmeter">&lt;code>mqtt-jmeter&lt;/code>&lt;/a>。&lt;/p>
&lt;p>下載 jar 插件檔案&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">curl -OL https://github.com/emqx/mqtt-jmeter/releases/download/v2.0.2/mqtt-xmeter-2.0.2-jar-with-dependencies.jar
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>搬移檔案至 jmeter 工具下&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">mv mqtt-xmeter-2.0.2-jar-with-dependencies.jar apache-jmeter-5.6.3/lib/ext/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>How to install cert-manager for application Certificate on Kubernetes</title><link>https://chiehting.com/posts/how-to-install-cert-manager-for-application-certificate-on-kubernetes/</link><pubDate>Sat, 01 Mar 2025 02:21:48 +0800</pubDate><guid>https://chiehting.com/posts/how-to-install-cert-manager-for-application-certificate-on-kubernetes/</guid><description>
&lt;p>如何在 Kubernetes 上申請 SSL 憑證給服務使用&lt;/p>
&lt;h3 id="install-cert-manager">Install cert-manager&lt;/h3>
&lt;p>使用 helm 來安裝 cert-manager 並指定版本為 v1.5.1。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">bash$: helm repo add jetstack https://charts.jetstack.io
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">bash$: helm repo update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">bash$: helm install --namespace cert-manager --create-namespace cert-manager jetstack/cert-manager --version v1.5.1 --set &lt;span class="nv">installCRDs&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="get-cloudflare-token">Get Cloudflare token&lt;/h3>
&lt;p>在 cert-manager acme 中有兩種申請憑證的方案，這邊採用 DNS01 方案去申請域名的 wildcard certificate。&lt;/p>
&lt;ul>
&lt;li>HTTP01：透過 HTTP 請求來認證網站&lt;/li>
&lt;li>DNS01：透過 DNS 供應商來認證網站&lt;/li>
&lt;/ul>
&lt;p>使用 DNS01 的方案，所以需要在 Cloudflare 上建立 token 來做認證。進入 &lt;a href="https://dash.cloudflare.com/profile/api-tokens">Cloudflare User Profile&lt;/a>，依照下面配置建立 token。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">Permissions:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> * Zone - DNS - Edit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> * Zone - Zone - Read
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">Zone Resources:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> * Include - All Zones
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="create-issuer--clusterissuer">Create Issuer / ClusterIssuer&lt;/h3>
&lt;p>建立 ACME 的發證服務，其中 kind 類型有 &lt;a href="https://cert-manager.io/docs/concepts/issuer/">Issuer、ClusterIssuer&lt;/a>，差別在於 &lt;code>Issuer&lt;/code> 和 &lt;code>Certificate&lt;/code> 必須在同一個 namespace 下；而 &lt;code>ClusterIssuer&lt;/code> 和 &lt;code>Certificate&lt;/code> 可以在不同 namespace 下。&lt;/p>
&lt;h4 id="cloudflare">Cloudflare&lt;/h4>
&lt;p>Let's Encrypt 有提供測試環境 &lt;a href="https://letsencrypt.org/docs/staging-environment/">Staging Environment&lt;/a>，在使用額度的部分會比較多。&lt;/p>
&lt;ul>
&lt;li>production environment server: &lt;code>https://acme-v02.api.letsencrypt.org/directory&lt;/code>&lt;/li>
&lt;li>staging environment server: &lt;code>https://acme-staging-v02.api.letsencrypt.org/directory&lt;/code>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Secret&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cloudflare-api-token-secret&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cert-manager&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Opaque&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">stringData&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">api-token&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">pleace-change-cloudflare-secret-token&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cert-manager.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterIssuer&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">letsencrypt-dns01&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cert-manager&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">acme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">email&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">user@example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://acme-v02.api.letsencrypt.org/directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">privateKeySecretRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">letsencrypt-dns01&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">solvers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">dns01&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cloudflare&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">email&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">my-cloudflare-acc@example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">apiTokenSecretRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cloudflare-api-token-secret&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">api-token&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="aws-route53">AWS route53&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cert-manager.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterIssuer&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">letsencrypt-dns01&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cert-manager&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">acme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">email&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">my-route53@example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">privateKeySecretRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">letsencrypt-dns01&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">server&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://acme-v02.api.letsencrypt.org/directory&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">solvers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsZones&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;example1.com&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dns01&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">route53&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">region&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ap-southeast-1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostedZoneID&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">please-change-hosted-zone-id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsZones&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;example2.com&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dns01&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">route53&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">region&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ap-southeast-1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostedZoneID&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">please-change-hosted-zone-id&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>透過下面指令可以查詢服務狀況。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">bash$ kubectl get cert-manager -n cert-manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">NAME READY AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">clusterissuer.cert-manager.io/letsencrypt-dns01 True 62m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="create-certificate">Create Certificate&lt;/h3>
&lt;p>cert-manager 的 Certificate 會更新憑證並且將憑證保存至定義的 secret 中。
在 yaml 中定義好預期要申請的域名後，會跟 Issuer、ClusterIssuer 發起申請憑證。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cert-manager.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Certificate&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">example1.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">example1.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">duration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2160h&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 90d&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">renewBefore&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">360h&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 15d&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">issuerRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">letsencrypt-dns01&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterIssuer&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsNames&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;example1.com&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;*.example1.com&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cert-manager.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Certificate&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">example2.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">example2.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">duration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2160h&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 90d&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">renewBefore&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">360h&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># 15d&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">issuerRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">letsencrypt-dns01&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterIssuer&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsNames&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;example2.com&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;*.example2.com&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查詢服務狀況。第一次發起申請憑證的時候，狀態從 False -&amp;gt; True 大約等了 10 分鐘。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">bash$ kubectl get cert-manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">NAME STATE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">order.acme.cert-manager.io/example.com-certificate-bk8vh-2305456588 valid 54m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">NAME APPROVED DENIED READY ISSUER REQUESTOR AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">certificaterequest.cert-manager.io/example.com-certificate-bk8vh True True letsencrypt-dns01 system:serviceaccount:cert-manager:cert-manager 54m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">NAME READY SECRET AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">certificate.cert-manager.io/example.com-certificate True example.com-certificate 54m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">NAME READY AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">clusterissuer.cert-manager.io/letsencrypt-dns01 True 63m
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查詢憑證狀況。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">bash$ kubectl get secret
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">NAME TYPE DATA AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">example.com-certificate kubernetes.io/tls &lt;span class="m">2&lt;/span> 70m
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">bash$ kubectl describe secret/example.com-certificate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">Name: example.com-certificate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">Namespace: default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">Labels: &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">Annotations: cert-manager.io/alt-names: *.example.com,example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> cert-manager.io/certificate-name: example.com-certificate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> cert-manager.io/common-name: example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> cert-manager.io/ip-sans:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> cert-manager.io/issuer-group:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> cert-manager.io/issuer-kind: ClusterIssuer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> cert-manager.io/issuer-name: letsencrypt-dns01
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> cert-manager.io/uri-sans:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">Type: kubernetes.io/tls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="nv">Data&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="o">====&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">tls.crt: &lt;span class="m">5615&lt;/span> bytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">tls.key: &lt;span class="m">1675&lt;/span> bytes
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="modified-nginx-ingress">Modified Nginx ingress&lt;/h3>
&lt;p>確認申請憑證完成後，修改 ingress 的配置，這邊我的 ingress 是使用 &lt;a href="https://kubernetes.github.io/ingress-nginx">ingress-nginx&lt;/a> 搭配 AWS 的 network load balance。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">networking.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Ingress&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tls&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">justin.example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">acme-letsencrypt-certificate&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;example.com-certificate&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">paths&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">path&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pathType&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Prefix&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">backend&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">service&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">golang&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">number&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">80&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>How to use the PARA method</title><link>https://chiehting.com/posts/how-to-use-the-para-method/</link><pubDate>Wed, 26 Feb 2025 17:15:22 +0800</pubDate><guid>https://chiehting.com/posts/how-to-use-the-para-method/</guid><description>
&lt;p>在使用 PARA 方法管理資料夾時，除了基本結構的設計外，還需要考慮如何動態管理與維護，以下是具體的實踐方法與建議。&lt;/p>
&lt;h2 id="操作與維護">操作與維護&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>動態管理&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>當某個項目完成後，將其從 &lt;code>/Projects&lt;/code> 移動到 &lt;code>/Archive/Completed-Projects&lt;/code>。&lt;/li>
&lt;li>當某個領域的內容不再需要時，移動到 &lt;code>/Archive&lt;/code>。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>統一命名規則&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>使用清晰的命名方式（如 &lt;code>CloudApp-Development&lt;/code> 而非 &lt;code>App1&lt;/code>），方便快速定位。&lt;/li>
&lt;li>盡量避免過於深層的資料夾結構（3-4 層即可）。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>定期整理&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>每季度或半年檢查一次 &lt;code>/Projects&lt;/code> 和 &lt;code>/Areas&lt;/code>，確認是否有需要移動到 &lt;code>/Archive&lt;/code> 的內容。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2 id="實際應用">實際應用&lt;/h2>
&lt;h3 id="情境一">情境一&lt;/h3>
&lt;p>假設 &lt;code>Projects/CloudApp-Development&lt;/code> 需要 &lt;code>Areas/Cloud-Computing&lt;/code>、&lt;code>Areas/Databases&lt;/code>、&lt;code>Areas/Programming&lt;/code> 的內容，要怎麼簡單地將 &lt;strong>Projects&lt;/strong> 和 &lt;strong>Areas&lt;/strong> 做關聯，可以通過以下幾種方式來實現，確保資料夾結構清晰且易於維護。&lt;/p>
&lt;p>資料夾結構總覽：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">/PARA
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> /Projects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> /CloudApp-Development
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> /Database-Optimization
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> /AI-ML-Experimentation
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> /Kubernetes-Migration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> /Areas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> /Cloud-Computing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> /Databases
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> /AI-ML
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> /Programming
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> /Resources
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> /Books
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> /Tutorials
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> /Tools
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> /Research-Papers
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> /Archive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> /Completed-Projects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> /Old-Resources
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="方法-1在-projects-中建立指向-areas-的快捷方式或符號連結">&lt;strong>方法 1：在 Projects 中建立指向 Areas 的快捷方式（或符號連結）&lt;/strong>&lt;/h4>
&lt;p>你可以在每個項目的資料夾內，建立指向相關 Areas 子資料夾的&lt;strong>快捷方式（Windows）&lt;strong>或&lt;/strong>符號連結（macOS/Linux）&lt;/strong>。&lt;/p>
&lt;h5 id="操作步驟">&lt;strong>操作步驟&lt;/strong>：&lt;/h5>
&lt;ol>
&lt;li>在 &lt;strong>Projects&lt;/strong> 資料夾內，例如 &lt;code>/Projects/CloudApp-Development&lt;/code>。&lt;/li>
&lt;li>建立指向 &lt;code>/Areas/Cloud-Computing&lt;/code>、&lt;code>/Areas/Databases&lt;/code> 和 &lt;code>/Areas/Programming&lt;/code> 的快捷方式或符號連結。&lt;/li>
&lt;li>快捷方式的名稱可以加上描述性標籤，例如：
&lt;ul>
&lt;li>&lt;code>Cloud-Computing (shortcut)&lt;/code>&lt;/li>
&lt;li>&lt;code>Databases (shortcut)&lt;/code>&lt;/li>
&lt;li>&lt;code>Programming (shortcut)&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h5 id="效果">&lt;strong>效果&lt;/strong>：&lt;/h5>
&lt;p>資料夾結構如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/Projects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> /CloudApp-Development
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> /Frontend
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> /Backend
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> /Infrastructure
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> /Cloud-Computing (shortcut)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl"> /Databases (shortcut)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl"> /Programming (shortcut)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="優點">&lt;strong>優點&lt;/strong>：&lt;/h5>
&lt;ul>
&lt;li>&lt;strong>簡單直觀&lt;/strong>：只需點擊快捷方式，即可快速跳轉到相關領域的內容。&lt;/li>
&lt;li>&lt;strong>動態更新&lt;/strong>：當 Areas 資料夾內的內容更新時，快捷方式會自動反映最新資料。&lt;/li>
&lt;/ul>
&lt;h4 id="方法-2在-projects-資料夾中建立關聯文件">&lt;strong>方法 2：在 Projects 資料夾中建立「關聯文件」&lt;/strong>&lt;/h4>
&lt;p>在每個項目資料夾中，建立一個簡單的關聯文件（如 &lt;code>related-areas.txt&lt;/code> 或 &lt;code>README.md&lt;/code>），記錄該項目所需的 Areas 資料夾。&lt;/p>
&lt;h5 id="操作步驟-1">&lt;strong>操作步驟&lt;/strong>：&lt;/h5>
&lt;ol>
&lt;li>
&lt;p>在 &lt;strong>Projects&lt;/strong> 資料夾內，例如 &lt;code>/Projects/CloudApp-Development&lt;/code>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>建立一個 &lt;code>related-areas.txt&lt;/code> 或 &lt;code>README.md&lt;/code> 文件，內容如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">Related Areas for CloudApp-Development:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">- /Areas/Cloud-Computing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">- /Areas/Databases
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">- /Areas/Programming
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>如果需要，還可以加上具體的用途說明，例如：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">- /Areas/Cloud-Computing: 用於設計應用的雲端架構。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">- /Areas/Databases: 用於資料庫管理和優化。
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">- /Areas/Programming: 用於後端程式開發（Golang）。
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;h5 id="效果-1">&lt;strong>效果&lt;/strong>：&lt;/h5>
&lt;p>資料夾結構如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/Projects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> /CloudApp-Development
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> /Frontend
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> /Backend
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> /Infrastructure
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> related-areas.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="優點-1">&lt;strong>優點&lt;/strong>：&lt;/h5>
&lt;ul>
&lt;li>&lt;strong>簡單且不依賴系統功能&lt;/strong>：無需建立快捷方式，適合所有操作系統。&lt;/li>
&lt;li>&lt;strong>靈活性高&lt;/strong>：可以詳細描述每個領域的用途。&lt;/li>
&lt;/ul>
&lt;h4 id="方法-3在-areas-資料夾中標記關聯的-projects">&lt;strong>方法 3：在 Areas 資料夾中標記關聯的 Projects&lt;/strong>&lt;/h4>
&lt;p>反過來，也可以在 &lt;strong>Areas&lt;/strong> 資料夾內，對應的子資料夾中建立一個文件，標記與該領域相關的 Projects。&lt;/p>
&lt;h5 id="操作步驟-2">&lt;strong>操作步驟&lt;/strong>：&lt;/h5>
&lt;ol>
&lt;li>
&lt;p>在 &lt;strong>Areas&lt;/strong> 資料夾內，例如 &lt;code>/Areas/Cloud-Computing&lt;/code>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>建立一個 &lt;code>related-projects.txt&lt;/code> 或 &lt;code>README.md&lt;/code> 文件，內容如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">Related Projects for Cloud-Computing:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">- /Projects/CloudApp-Development
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">- /Projects/Kubernetes-Migration
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>每個領域可以記錄多個相關的項目。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h5 id="效果-2">&lt;strong>效果&lt;/strong>：&lt;/h5>
&lt;p>資料夾結構如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/Areas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> /Cloud-Computing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> related-projects.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> /Databases
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> related-projects.txt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> /Programming
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl"> related-projects.txt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="優點-2">&lt;strong>優點&lt;/strong>：&lt;/h5>
&lt;ul>
&lt;li>&lt;strong>雙向關聯&lt;/strong>：讓你可以從 Areas 資料夾中快速找到相關的 Projects。&lt;/li>
&lt;li>&lt;strong>清晰的文檔化&lt;/strong>：適合需要記錄和追蹤的場景。&lt;/li>
&lt;/ul>
&lt;h4 id="方法-4使用統一命名規則進行隱式關聯">&lt;strong>方法 4：使用統一命名規則進行隱式關聯&lt;/strong>&lt;/h4>
&lt;p>通過統一的命名規則，讓 Projects 和 Areas 的關聯更加直觀。例如，為相關的資料夾名稱添加標籤或前綴。&lt;/p>
&lt;h5 id="操作步驟-3">&lt;strong>操作步驟&lt;/strong>：&lt;/h5>
&lt;ol>
&lt;li>在 &lt;strong>Projects&lt;/strong> 和 &lt;strong>Areas&lt;/strong> 資料夾中使用相似的命名規則。例如：
&lt;ul>
&lt;li>&lt;code>/Projects/CloudApp-Development&lt;/code> 對應 &lt;code>/Areas/Cloud-Computing&lt;/code>&lt;/li>
&lt;li>&lt;code>/Projects/Database-Optimization&lt;/code> 對應 &lt;code>/Areas/Databases&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>如果一個項目涉及多個領域，可以在名稱中加入標籤：
&lt;ul>
&lt;li>&lt;code>/Projects/CloudApp-Development [Cloud-Computing, Databases, Programming]&lt;/code>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h5 id="效果-3">&lt;strong>效果&lt;/strong>：&lt;/h5>
&lt;p>資料夾結構如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/Projects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> /CloudApp-Development [Cloud-Computing, Databases, Programming]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> /Kubernetes-Migration [Cloud-Computing]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">/Areas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> /Cloud-Computing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> /Databases
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl"> /Programming
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="優點-3">&lt;strong>優點&lt;/strong>：&lt;/h5>
&lt;ul>
&lt;li>&lt;strong>無需額外文件或快捷方式&lt;/strong>：直接通過命名即可快速辨識關聯。&lt;/li>
&lt;li>&lt;strong>視覺化清晰&lt;/strong>：適合需要快速掃描資料夾的情境。&lt;/li>
&lt;/ul>
&lt;h3 id="情境二">情境二&lt;/h3>
&lt;p>學習 AWS 文件，並生產出使用教學跟測試報告，那是屬於 Areas 還是 Resources?
請明確該活動屬於以下哪一類別：&lt;/p>
&lt;ul>
&lt;li>Areas：包含技術領域的知識、技巧或能力&lt;/li>
&lt;li>Resources：包含工具、資料或參考資料等支持性信息&lt;/li>
&lt;/ul></description></item><item><title>uber/kraken container registry</title><link>https://chiehting.com/posts/kraken-container-registry/</link><pubDate>Thu, 24 Oct 2024 12:25:08 +0800</pubDate><guid>https://chiehting.com/posts/kraken-container-registry/</guid><description>
&lt;p>Kraken 是一個使用 P2P 技術的容器映像檔推拉服務，適合在分散式架構下使用。官方測試 Kraken distributes 20K 100MB-1G blobs in under 30 sec。&lt;/p>
&lt;h3 id="refencers">Refencers&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://github.com/uber/kraken">Github&lt;/a>&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>Kraken has been in production at Uber since early 2018. In our busiest cluster, Kraken distributes more than 1 million blobs per day, including 100k 1G+ blobs. At its peak production load, Kraken distributes 20K 100MB-1G blobs in under 30 sec.&lt;/p>
&lt;/blockquote>
&lt;h3 id="使用情境">使用情境&lt;/h3>
&lt;p>要在跨雲環境中使用Kraken，我們需要考慮幾個關鍵點：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>網絡連接：&lt;/p>
&lt;ul>
&lt;li>確保不同雲環境之間有穩定的網絡連接。這可能需要設置VPN或直接連接服務（如AWS Direct Connect或Azure ExpressRoute）。&lt;/li>
&lt;li>配置防火牆規則，允許Kraken組件之間的通信。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>中央協調：&lt;/p>
&lt;ul>
&lt;li>在一個中心位置部署Tracker組件。這可以是任何一個雲環境，或者是一個中立的位置。&lt;/li>
&lt;li>Tracker需要能夠與所有雲環境中的Agent和Origin通信。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>存儲配置：&lt;/p>
&lt;ul>
&lt;li>利用Kraken的可插拔存儲特性。在每個雲環境中配置適當的存儲後端（例如，在AWS中使用S3，在Azure中使用Blob Storage）。&lt;/li>
&lt;li>確保Origin組件可以訪問這些存儲後端。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>Agent部署：&lt;/p>
&lt;ul>
&lt;li>在每個雲環境的所有主機上部署Agent。&lt;/li>
&lt;li>配置Agent使其能夠與中央Tracker通信。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>跨雲複製：&lt;/p>
&lt;ul>
&lt;li>利用Kraken的跨集群複製功能。設置規則，以確保重要的映像在不同的雲環境之間同步。&lt;/li>
&lt;li>這可以通過Build-Index組件來管理。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>負載均衡：&lt;/p>
&lt;ul>
&lt;li>在每個雲環境中部署Proxy組件。&lt;/li>
&lt;li>使用雲提供商的負載均衡服務來分配對Proxy的請求。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>DNS配置：&lt;/p>
&lt;ul>
&lt;li>設置DNS以便各個組件可以相互發現。這可能需要使用跨雲DNS解決方案。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>監控和日誌：&lt;/p>
&lt;ul>
&lt;li>實施跨雲監控解決方案，以便您可以監視所有環境中的Kraken性能。&lt;/li>
&lt;li>集中日誌收集，以便於故障排除。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>安全性：&lt;/p>
&lt;ul>
&lt;li>實施端到端加密，特別是對於跨雲通信。&lt;/li>
&lt;li>使用雲提供商的身份和訪問管理服務來控制對Kraken組件的訪問。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>災難恢復：&lt;/p>
&lt;ul>
&lt;li>在不同的雲環境中設置備份和故障轉移機制。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="devcluster">devcluster&lt;/h3>
&lt;p>在專案下有提供測試使用的環境 devcluster，可以執行命令啟動服務。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">make images &lt;span class="c1"># 編譯所有組建映像檔&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">make devcluster &lt;span class="c1"># 本地運行測試&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在容器內 agent 的執行命令&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># kraken-agent-one&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">/usr/bin/kraken-agent --config&lt;span class="o">=&lt;/span>/etc/kraken/config/agent/development.yaml --peer-ip&lt;span class="o">=&lt;/span>host.docker.internal --peer-port&lt;span class="o">=&lt;/span>&lt;span class="m">16001&lt;/span> --agent-server-port&lt;span class="o">=&lt;/span>&lt;span class="m">16002&lt;/span> --agent-registry-port&lt;span class="o">=&lt;/span>&lt;span class="m">16000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1"># kraken-agent-two&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">/usr/bin/kraken-agent --config&lt;span class="o">=&lt;/span>/etc/kraken/config/agent/development.yaml --peer-ip&lt;span class="o">=&lt;/span>host.docker.internal --peer-port&lt;span class="o">=&lt;/span>&lt;span class="m">17001&lt;/span> --agent-server-port&lt;span class="o">=&lt;/span>&lt;span class="m">17002&lt;/span> --agent-registry-port&lt;span class="o">=&lt;/span>&lt;span class="m">17000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在容器內 testfs 的執行命令&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/usr/bin/kraken-testfs --port&lt;span class="o">=&lt;/span>&lt;span class="m">14000&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在容器內 origin 的執行命令&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/usr/bin/kraken-origin --config&lt;span class="o">=&lt;/span>/etc/kraken/config/origin/development.yaml --blobserver-hostname&lt;span class="o">=&lt;/span>host.docker.internal --blobserver-port&lt;span class="o">=&lt;/span>&lt;span class="m">15002&lt;/span> --peer-ip&lt;span class="o">=&lt;/span>host.docker.internal --peer-port&lt;span class="o">=&lt;/span>&lt;span class="m">15001&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在容器內 tracker 的執行命令&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/usr/bin/kraken-tracker --config&lt;span class="o">=&lt;/span>/etc/kraken/config/tracker/development.yaml --port&lt;span class="o">=&lt;/span>&lt;span class="m">15003&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在容器內 build-index 的執行命令&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/usr/bin/kraken-build-index --config&lt;span class="o">=&lt;/span>/etc/kraken/config/build-index/development.yaml --port&lt;span class="o">=&lt;/span>&lt;span class="m">15004&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在容器內 proxy 的執行命令&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/usr/bin/kraken-proxy --config&lt;span class="o">=&lt;/span>/etc/kraken/config/proxy/development.yaml --port&lt;span class="o">=&lt;/span>&lt;span class="m">15000&lt;/span> --server-port&lt;span class="o">=&lt;/span>&lt;span class="m">15005&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="相依性">相依性：&lt;/h3>
&lt;ul>
&lt;li>agent: build-index、tracker&lt;/li>
&lt;li>origin: origin、testfs&lt;/li>
&lt;li>build-index: origin、build-index、testfs&lt;/li>
&lt;li>testfs:&lt;/li>
&lt;li>tracker: origin&lt;/li>
&lt;li>proxy: origin、build-index&lt;/li>
&lt;/ul>
&lt;h3 id="安裝步驟">安裝步驟：&lt;/h3>
&lt;ol>
&lt;li>testfs：testfs是Kraken的測試檔案系統組件，主要用於測試環境中模擬儲存層。&lt;/li>
&lt;li>origin：origin是Kraken的核心儲存組件，作為整個分發系統的源頭，可以從上游 registry 拉取映像。&lt;/li>
&lt;li>build-index：build-index組件負責索引和管理映像與標籤的關係。&lt;/li>
&lt;li>proxy：proxy組件是Docker客戶端的接入點。&lt;/li>
&lt;li>tracker：tracker是P2P分發網路的協調者。&lt;/li>
&lt;li>agent：agent運行在每個需要Docker映像的主機上。&lt;/li>
&lt;/ol>
&lt;p>其中 push 需要服務 1、2、3、4
其中 pull 需要服務 1、2、3、4、5、6&lt;/p>
&lt;h3 id="整合結構">整合結構&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>優點：&lt;/p>
&lt;ol>
&lt;li>可以從其他 node 上獲取 images，減少 registry 的壓力&lt;/li>
&lt;li>拉取映像檔案效率較高&lt;/li>
&lt;li>隱匿映像檔來源&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>
&lt;p>缺點：&lt;/p>
&lt;ol>
&lt;li>需要多建立 daemonset 服務，佔用主機資源&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ul>
&lt;pre class="mermaid">flowchart TB
gitlab(GitLab)
gitlabci(gitlab runner)
nexus(Nexus)
harbor(Harbor)
awsecr(AWS ECR)
huaweiswr(Huawei SWR)
start -- git push --> gitlab
subgraph pn[priate network]
direction BT
gitlab --> gitlabci
gitlabci --> nexus
nexus -- cache --> gitlabci
gitlabci -- push artifacts --> harbor
end
subgraph aws[AWS]
harbor -- replications --> awsecr
awsecr -- pull images --> node1 &amp; node1' &amp; node2 &amp; node2'
subgraph kubernets cluster
node1 &lt;-- pull images --> node2
end
subgraph kubernets cluster
node1' &lt;-- pull images --> node2'
end
end
subgraph hc[Huawei Cloud]
harbor -- replications --> huaweiswr
huaweiswr -- pull images --> node1'' &amp; node1''' &amp; node2'' &amp; node2'''
subgraph kubernets cluster
node1'' &lt;-- pull images --> node2''
end
subgraph kubernets cluster
node1''' &lt;-- pull images --> node2'''
end
end&lt;/pre></description></item><item><title>Create the locally trusted development certificates</title><link>https://chiehting.com/posts/mkcert-tool-create-local-cert/</link><pubDate>Sun, 07 Jul 2024 15:37:56 +0800</pubDate><guid>https://chiehting.com/posts/mkcert-tool-create-local-cert/</guid><description>
&lt;p>開源專案 &lt;a href="https://github.com/FiloSottile/mkcert">mkcert&lt;/a>，建立本機信任憑證供開發時使用。&lt;/p>
&lt;p>透過 brew 安裝 mkcert 命令。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">brew install mkcert
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">brew install nss &lt;span class="c1"># if you use Firefox&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>建立 local CA。&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Warning&lt;/strong>: the &lt;code>rootCA-key.pem&lt;/code> file that mkcert automatically generates gives complete power to intercept secure requests from your machine. Do not share it.&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">mkcert -install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">Created a new &lt;span class="nb">local&lt;/span> CA 💥
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">The &lt;span class="nb">local&lt;/span> CA is now installed in the system trust store! ⚡️
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">The &lt;span class="nb">local&lt;/span> CA is now installed in the Firefox trust store &lt;span class="o">(&lt;/span>requires browser restart&lt;span class="o">)&lt;/span>! 🦊
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>建立憑證範例。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">mkcert example.com &lt;span class="s2">&amp;#34;*.example.com&amp;#34;&lt;/span> example.test localhost 127.0.0.1 ::1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>阿里雲技術文章-多租戶架構</title><link>https://chiehting.com/posts/multi-tenancy-architecture/</link><pubDate>Fri, 28 Jun 2024 23:53:03 +0800</pubDate><guid>https://chiehting.com/posts/multi-tenancy-architecture/</guid><description>
&lt;p>&lt;a href="https://developer.aliyun.com/article/1142510?spm=5176.26934562.main.11.5a37510bSLvY8d">阿里雲文章&lt;/a>，說明多種多租戶架構的方式&lt;/p>
&lt;h4 id="獨享資源模式">獨享資源模式&lt;/h4>
&lt;p>每個租入的 web、application、database 各自獨立。
用戶完全隔離，優點是用戶不互相影響、資料完全隔離，缺點是硬體成本較高&lt;/p>
&lt;pre class="mermaid">flowchart TB
subgraph 租戶一
direction TB
web1[web]-->app1[application]-->db1[DB]
end
subgraph 租戶二
direction TB
web2[web]-->app2[application]-->db2[DB]
end&lt;/pre>
&lt;h4 id="共享資源池租戶模式">共享資源池租戶模式&lt;/h4>
&lt;ol>
&lt;li>全共享模式&lt;/li>
&lt;/ol>
&lt;pre class="mermaid">flowchart TB
subgraph 租戶一 租戶二
direction TB
web1[web*n]-->app1[application*n]-->DB
end&lt;/pre>
&lt;ol start="2">
&lt;li>數據層共享模式&lt;/li>
&lt;/ol>
&lt;pre class="mermaid">flowchart TB
app1-->db1
app2-->db1
subgraph a[租戶一]
direction TB
web1[web]-->app1[application]
end
subgraph b[租戶二]
direction TB
web2[web]-->app2[application]
end
subgraph DB
direction TB
db1[DB]
end&lt;/pre>
&lt;ol start="3">
&lt;li>租戶應用環境共享模式&lt;/li>
&lt;/ol>
&lt;pre class="mermaid">flowchart TB
subgraph 租戶一 租戶二
direction TB
web[web*n]-->app[application*n]-->db1[DB]
app-->db2[DB]
end&lt;/pre>
&lt;h4 id="混合租戶模式">混合租戶模式&lt;/h4>
&lt;pre class="mermaid">flowchart TB
subgraph 租戶一 租戶二
direction TB
web1[web*n]-->app1[application*n]-->db1[DB]
end
subgraph 租戶三
direction TB
web2[web]-->app2[application]-->db2[DB]
end&lt;/pre></description></item><item><title>清理 Kubernetes node 上的映像檔</title><link>https://chiehting.com/posts/kubernetes-clean-the-node-image/</link><pubDate>Tue, 28 May 2024 13:01:00 +0800</pubDate><guid>https://chiehting.com/posts/kubernetes-clean-the-node-image/</guid><description>
&lt;p>Kubernetes 自有 Garbage Collection 機制，也可以手動提前清理，步驟如下。&lt;/p>
&lt;h3 id="創建節點除錯器-alpine">創建節點除錯器 alpine&lt;/h3>
&lt;p>建立一個 alpine 容器，並且裝上 crictl 命令。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">kubectl debug node/ip-10-2-1-49.ec2.internal -it --image&lt;span class="o">=&lt;/span>alpine -- sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">$ &lt;span class="nv">VERSION&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;v1.26.0&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">$ wget https://github.com/kubernetes-sigs/cri-tools/releases/download/&lt;span class="nv">$VERSION&lt;/span>/crictl-&lt;span class="nv">$VERSION&lt;/span>-linux-amd64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">$ tar zxvf crictl-&lt;span class="nv">$VERSION&lt;/span>-linux-amd64.tar.gz -C /usr/local/bin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="刪除節點內的-images">刪除節點內的 images&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">$ cat /etc/crictl.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">runtime-endpoint: unix:///host/run/containerd/containerd.sock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">image-endpoint: unix:///host/run/containerd/containerd.sock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">timeout: &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">debug: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">pull-image-on-create: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">$ crictl images
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">$ &lt;span class="c1">#crictl images|grep application | awk &amp;#39;{print $1&amp;#34;:&amp;#34;$2}&amp;#39; |xargs -n 1 crictl rmi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">$ crictl rmi name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">$ crictl rmi --prune &lt;span class="c1"># 要小心使用，重拉 pull image 可能會有權限問題&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>CURL</title><link>https://chiehting.com/posts/network-curl-test-the-request-time/</link><pubDate>Fri, 10 May 2024 10:34:42 +0800</pubDate><guid>https://chiehting.com/posts/network-curl-test-the-request-time/</guid><description>
&lt;p>使用 CURL 工具從客戶端測試請求速，觀察多個指標評估網路效率問題。&lt;/p>
&lt;h3 id="請求時間">請求時間&lt;/h3>
&lt;p>建立檔案 curl-format.txt 內容如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">time_namelookup: %{time_namelookup}\n
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">time_connect: %{time_connect}\n
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">time_appconnect: %{time_appconnect}\n
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">time_pretransfer: %{time_pretransfer}\n
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">time_redirect: %{time_redirect}\n
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">time_starttransfer: %{time_starttransfer}\n
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">----------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">time_total: %{time_total}\n
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>time_namelookup（DNS 解析時間）：從發起請求到 DNS 解析完成的時間，單位是秒。&lt;/li>
&lt;li>time_connect（連接建立時間）：從發起連接請求到建立 TCP 連接完成的時間，單位是秒。&lt;/li>
&lt;li>time_appconnect（應用層連接時間）：從發起連接請求到 SSL/TLS 握手完成的時間，單位是秒。如果沒有使用 SSL/TLS，這個時間通常為 0。&lt;/li>
&lt;li>time_pretransfer（預傳輸時間）：從發起請求到開始傳輸數據之前的時間，包括 DNS 解析、連接建立、SSL/TLS 握手等時間，單位是秒。&lt;/li>
&lt;li>time_redirect（重定向時間）：如果請求中發生了重定向，從開始重定向到最後一個重定向完成的時間，單位是秒。&lt;/li>
&lt;li>time_starttransfer（開始傳輸時間）：從發起請求到接收到第一個字節的時間，單位是秒。這表示請求開始接收響應的時間。&lt;/li>
&lt;li>time_total（總時間）：從發起請求到接收完整響應的總時間，包括所有的階段，單位是秒。&lt;/li>
&lt;/ol>
&lt;p>透過命令查詢請求時間&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 輸出 format 時間&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">➜ curl -w &lt;span class="s2">&amp;#34;@curl-format.txt&amp;#34;&lt;/span> -o /dev/null -s https://www.bitdegree.org/courses/course/kubernetes-docker-tutorial
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">time_namelookup: 0.002607
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">time_connect: 0.154302
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">time_appconnect: 0.315024
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">time_pretransfer: 0.315320
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">time_redirect: 0.000000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">time_starttransfer: 2.718007
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">----------time_total: 3.364941
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 直接輸出總時間&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">➜ curl -o /dev/null -s -w &lt;span class="s2">&amp;#34;Total time: %{time_total}\n&amp;#34;&lt;/span> https://www.bitdegree.org/courses/course/kubernetes-docker-tutorial
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">Total time: 2.906125
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>MTR</title><link>https://chiehting.com/posts/mtr/</link><pubDate>Thu, 09 May 2024 18:22:16 +0800</pubDate><guid>https://chiehting.com/posts/mtr/</guid><description>
&lt;p>使用 MTR 工具，監測網路狀態。&lt;/p>
&lt;h3 id="mtr-command">MTR command&lt;/h3>
&lt;p>&lt;a href="https://github.com/traviscross/mtr">Github&lt;/a> 原始碼。&lt;/p>
&lt;p>下面命令的含義是使用 MTR 工具對 google.com 進行路徑跟蹤，並使用 TCP 協議進行跟蹤，發送 30 個數據包，並實時顯示每個節點的數據，最終顯示結果並退出程序。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">sudo ./mtr -b -T -r -c &lt;span class="m">30&lt;/span> google.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>-b：表示啟用 Batch 模式。在 Batch 模式下，MTR 將在測試完成後立即顯示結果，並退出程序。這樣可以方便將結果保存到文件中或者進行其他處理。&lt;/p>
&lt;p>-T：表示使用 TCP 進行跟蹤。這個選項告訴 MTR 使用 TCP 協議而不是默認的 UDP 協議進行數據包跟蹤。&lt;/p>
&lt;p>-r：表示顯示實時數據。這個選項告訴 MTR 實時顯示每個節點的數據，而不是等待測試完成後一次性顯示。&lt;/p>
&lt;p>-c 30：表示指定發送的數據包數量為 30 個。這個選項告訴 MTR 在跟蹤路徑時發送 30 個數據包，以便更準確地評估網絡連接的質量。&lt;/p>
&lt;/blockquote>
&lt;p>其運行結果會顯示欄位 &lt;code>HOST&lt;/code>、&lt;code>Loss%&lt;/code>、&lt;code>Snt&lt;/code>、&lt;code>Last&lt;/code>、&lt;code>Avg&lt;/code>、&lt;code>Best&lt;/code>、&lt;code>Wrst&lt;/code>、`StDev，期解釋如下：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>Loss%：表示丟包率，即在發送的數據包中丟失的百分比。它表示了從本地主機到目標主機的路徑中，有多少個數據包在傳輸過程中丟失了。丟包率越低，表示網絡連接越穩定。單位為百分比。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Snt：表示發送的數據包數量，即已發送的數據包數量。單位為個。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Last：表示最後一個數據包的往返時間（Round-Trip Time, RTT），即最後一個數據包從本地主機發送到目標主機，並返回到本地主機的時間。單位為毫秒（ms）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Avg：表示所有已發送數據包的平均往返時間，即所有數據包往返時間的平均值。單位為毫秒（ms）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Best：表示已發送數據包的最低往返時間，即所有數據包往返時間中的最小值。單位為毫秒（ms）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Wrst：表示已發送數據包的最高往返時間，即所有數據包往返時間中的最大值。單位為毫秒（ms）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>StDev：表示所有已發送數據包的往返時間的標準偏差，即所有數據包往返時間與平均往返時間的偏差的平方的平均值的平方根。標準偏差越小，表示數據包往返時間的分佈越集中，網絡連接越穩定。單位為毫秒（ms）。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="中間節點的-icmp-封包行為">中間節點的 ICMP 封包行為&lt;/h3>
&lt;p>在使用 &lt;code>mtr&lt;/code> 命令時，&lt;code>-T&lt;/code> 參數的作用是讓 &lt;code>mtr&lt;/code> 使用 TCP 數據包進行探測，而不是默認的 ICMP 數據包。然而，即使使用了 &lt;code>-T&lt;/code> 參數，&lt;code>mtr&lt;/code> 仍然會在探測過程中進行類似於 &lt;code>ping&lt;/code> 的操作，這是因為 &lt;code>mtr&lt;/code> 的核心功能是結合了 &lt;code>ping&lt;/code> 和 &lt;code>traceroute&lt;/code> 的特性。&lt;/p>
&lt;p>具體來說，&lt;code>mtr&lt;/code> 的工作原理是：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>追蹤路由&lt;/strong>：&lt;code>mtr&lt;/code> 會追蹤數據包從源節點到目標節點（如 &lt;code>google.com&lt;/code>）所經過的所有中間節點。&lt;/li>
&lt;li>&lt;strong>持續測試&lt;/strong>：在追蹤路由的同時，&lt;code>mtr&lt;/code> 會對每個中間節點進行持續的測試，計算丟包率和延遲。&lt;/li>
&lt;li>&lt;strong>探測方式&lt;/strong>：即使使用 &lt;code>-T&lt;/code> 參數指定了 TCP 探測，&lt;code>mtr&lt;/code> 仍然會對每個節點進行類似 &lt;code>ping&lt;/code> 的測試，以獲取節點的響應時間和丟包率 。&lt;/li>
&lt;/ol>
&lt;p>因此，&lt;code>-T&lt;/code> 參數主要影響的是探測數據包的類型（TCP 而非 ICMP），但 &lt;code>mtr&lt;/code> 仍然需要對每個節點進行類似 &lt;code>ping&lt;/code> 的操作，以提供完整的網絡質量分析。&lt;/p></description></item><item><title>使用 iPerf 測試網路頻寬</title><link>https://chiehting.com/posts/iperf-internet-performance-testing/</link><pubDate>Thu, 09 May 2024 18:22:16 +0800</pubDate><guid>https://chiehting.com/posts/iperf-internet-performance-testing/</guid><description>
&lt;p>如何使用 iPerf 工具測試 client/server 的網路頻寬。&lt;/p>
&lt;h3 id="iperf-command">iPerf command&lt;/h3>
&lt;p>&lt;a href="https://github.com/esnet/iperf/issues">Github&lt;/a> 原始碼。&lt;/p>
&lt;p>iPerf 是一個網絡性能測試工具，用於測量網絡帶寬、延遲和數據包丟失率等性能指標。它可以在兩個網絡節點之間進行通信，是 Client/Server 的架構，可測量數據在網絡上的傳輸速率和延遲等性能參數。&lt;/p>
&lt;h4 id="server">Server&lt;/h4>
&lt;p>有公開的服務提供 &lt;a href="https://iperf.fr/iperf-servers.php">iperf public server&lt;/a> 使用。&lt;/p>
&lt;p>可以運行下面命令啟動 Server，預測 port 為 5210，可以透過 &lt;code>-p&lt;/code> 做調整。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">➜ iperf3 -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">-----------------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">Server listening on &lt;span class="m">5201&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="nb">test&lt;/span> &lt;span class="c1">#1)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">-----------------------------------------------------------
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="client">Client&lt;/h4>
&lt;p>下面命令的含義是使用 iperf3 工具連接到 google.com 主機的指定埠號 5201，進行網絡帶寬測試，測試持續時間為 30 秒。iperf3 將在測試期間測量網絡連接的帶寬、延遲等性能指標，並在測試完成後顯示結果。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">iperf3 -t &lt;span class="m">30&lt;/span> -c 127.0.0.1 -p &lt;span class="m">5201&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;blockquote>
&lt;p>-t 30：表示指定測試的持續時間為 30 秒。這個選項告訴 iperf3 在連接建立后持續運行 30 秒，進行網絡帶寬測試。&lt;/p>
&lt;p>-c google.com：表示指定測試的目標主機為 127.0.0.1。這個選項告訴 iperf3 在測試時連接到 google.com 主機，進行網絡帶寬測試。&lt;/p>
&lt;p>-p 5201：表示指定測試的端口號為 5201。這個選項告訴 iperf3 在進行測試時使用指定的端口號。&lt;/p>
&lt;/blockquote>
&lt;p>在 iperf3 的輸出中，包括欄位&lt;code>[ ID]&lt;/code>、&lt;code>Interval&lt;/code>、&lt;code>Transfer&lt;/code>、&lt;code>Bitrate&lt;/code>、&lt;code>Retr&lt;/code>、`Cwnd，每個字段的含義如下：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>ID：標識每個連接的唯一編號。當進行多個併發連接測試時，每個連接都會分配一個唯一的 ID。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Interval：顯示測試間隔的時間。默認情況下，iperf3 將在每個間隔內顯示一次性能統計信息。間隔時間可以通過 -i 選項進行設置，默認為 1 秒。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Transfer：顯示在測試期間傳輸的數據量。單位為字節（Bytes）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Bitrate：顯示在測試期間的平均 bit 率，即數據傳輸速率。單位為bits/每秒（bits per second，bps）或者兆比特每秒（Mbps）。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Retr：顯示在測試期間發生的重傳次數。重傳次數表示在數據傳輸過程中發生丟包或錯誤，需要重新發送的次數。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Cwnd：顯示在測試期間的擁塞窗口大小（Congestion Window）。擁塞窗口是 TCP 協議中的一個概念，用於控制數據流量的發送速率。它表示在任意時間點內，發送方允許在網絡上的未確認數據量的最大值。單位可以是字節（Bytes）或者數據包個數，具體取決於 iperf3 輸出的格式和設置。&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>這些字段提供了關於每個連接的性能統計信息，包括數據傳輸量、傳輸速率、重傳次數和擁塞窗口大小等。通過分析這些信息，可以評估網絡連接的質量和性能表現。&lt;/p></description></item><item><title>如何做網際網路的效能測試</title><link>https://chiehting.com/posts/how-to-test-internet-efficiency/</link><pubDate>Thu, 09 May 2024 13:58:56 +0800</pubDate><guid>https://chiehting.com/posts/how-to-test-internet-efficiency/</guid><description>
&lt;p>如何做跨區線路測試，分析兩區域網路傳輸的狀況。例如 ap-southeast-1 到 us-east-1 的網路效率。&lt;/p>
&lt;h3 id="解題方向">解題方向&lt;/h3>
&lt;p>在進行跨區的網路線路測試時，不考慮服務運行時間的情況下，可能會關注以下指標：&lt;/p>
&lt;ol>
&lt;li>&lt;strong>延遲（Latency）&lt;/strong>：延遲是從發送請求到收到響應所需的時間。你會測試不同地區之間的平均延遲、最大延遲和最小延遲，以評估網路的反應速度。可使用工具 &lt;code>ping&lt;/code>、&lt;code>traceroute&lt;/code>、&lt;code>mtr&lt;/code> 來做測試。&lt;/li>
&lt;li>&lt;strong>丟包率（Packet Loss Rate）&lt;/strong>：丟包率是指在網絡傳輸過程中丟失的數據包的比率。你會關注丟包率的高低，因為高丟包率可能導致數據傳輸的不完整和延遲增加。可使用工具 &lt;code>ping&lt;/code>、&lt;code>traceroute&lt;/code>、&lt;code>mtr&lt;/code> 來做測試。&lt;/li>
&lt;li>&lt;strong>頻寬利用率（Bandwidth Utilization）&lt;/strong>：帶寬利用率是指在一定時間內使用的網絡帶寬的比率。你會測試網絡的帶寬利用率，以確保帶寬資源充足並且沒有過度使用。可用工具 &lt;code>iperf&lt;/code>、&lt;code>speedtest-cli&lt;/code>做測試。&lt;/li>
&lt;li>&lt;strong>往返時間（Round-Trip Time，RTT）&lt;/strong>：RTT 是從發送一個數據包到收到對應的響應所需的時間。你會關注不同地區之間的平均 RTT，以評估網路的往返時間。可使用工具 &lt;code>ping&lt;/code>、&lt;code>traceroute&lt;/code>、&lt;code>mtr&lt;/code> 、&lt;code>iperf&lt;/code>來做測試。&lt;/li>
&lt;li>&lt;strong>連通性和穩定性（Connectivity and Stability）&lt;/strong>：你會測試不同地區之間的連通性和穩定性，確保網路連接的可靠性和持久性。可使用工具 &lt;code>ping&lt;/code>、&lt;code>traceroute&lt;/code>、&lt;code>mtr&lt;/code> 來做測試。&lt;/li>
&lt;li>&lt;strong>DNS 解析時間（DNS Resolution Time）&lt;/strong>：DNS 解析時間是指從域名解析請求開始到獲得對應 IP 地址的時間。你會測試 DNS 解析時間，以評估域名解析的效率和穩定性。可使用工具 &lt;code>dig&lt;/code>、&lt;code>nslookup&lt;/code> 來做測試。&lt;/li>
&lt;/ol>
&lt;h3 id="收集資訊">收集資訊&lt;/h3>
&lt;p>DNS Resloutiime Time&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># Google&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# dig @8.8.8.8 example.com &lt;span class="p">|&lt;/span> grep Query
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">;;&lt;/span> Query time: &lt;span class="m">220&lt;/span> msec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1"># Cloudflare&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# dig @1.1.1.1 example.com &lt;span class="p">|&lt;/span> grep Query
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="p">;;&lt;/span> Query time: &lt;span class="m">152&lt;/span> msec
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Bandwidth&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># Display a list of speedtest.net servers sorted by distance&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# speedtest-cli --list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">Retrieving speedtest.net configuration...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">17336&lt;span class="o">)&lt;/span> ETISALAT-UAE &lt;span class="o">(&lt;/span>Dubai, United Arab Emirates&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>19.67 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">33712&lt;span class="o">)&lt;/span> ETISALAT-UAE &lt;span class="o">(&lt;/span>Sharjah, United Arab Emirates&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>32.80 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">34238&lt;span class="o">)&lt;/span> ETISALAT-UAE &lt;span class="o">(&lt;/span>Ajman, United Arab Emirates&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>42.82 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">11271&lt;span class="o">)&lt;/span> Ooredoo Oman &lt;span class="o">(&lt;/span>Seeb, Oman&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>330.64 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> 6193&lt;span class="o">)&lt;/span> Ooredoo Qatar &lt;span class="o">(&lt;/span>Doha, Qatar&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>379.79 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">36046&lt;span class="o">)&lt;/span> stc Bahrain &lt;span class="o">(&lt;/span>Seef, Bahrain&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>489.93 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">25379&lt;span class="o">)&lt;/span> Mobily &lt;span class="o">(&lt;/span>Khobar, Saudi Arabia&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>526.86 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">16051&lt;span class="o">)&lt;/span> Saudi Telecom Company &lt;span class="o">(&lt;/span>STC&lt;span class="o">)&lt;/span> &lt;span class="o">(&lt;/span>Dammam, Saudi Arabia&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>528.27 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">17373&lt;span class="o">)&lt;/span> Salam &lt;span class="o">(&lt;/span>Dammam, Saudi Arabia&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>528.27 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">24200&lt;span class="o">)&lt;/span> Saudi Telecom Company &lt;span class="o">(&lt;/span>STC&lt;span class="o">)&lt;/span> &lt;span class="o">(&lt;/span>Al Hofuf, Saudi Arabia&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>575.26 km&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# speedtest-cli
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">Retrieving speedtest.net configuration...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">Testing from Amazon.com &lt;span class="o">(&lt;/span>51.112.52.76&lt;span class="o">)&lt;/span>...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">Retrieving speedtest.net server list...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">Selecting best server based on ping...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">Hosted by ETISALAT-UAE &lt;span class="o">(&lt;/span>Dubai&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>19.67 km&lt;span class="o">]&lt;/span>: 5.772 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">Testing download speed................................................................................
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">Download: 1908.86 Mbit/s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">Testing upload speed......................................................................................................
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">Upload: 1475.68 Mbit/s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Request time&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@ip-172-31-4-174:~# curl -4 -w &amp;#34;@curl-format.txt&amp;#34; -o /dev/null -s https://example.com/api
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">time_namelookup: 0.155062
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">time_connect: 0.351696
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">time_appconnect: 0.586982
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">time_pretransfer: 0.587111
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">time_redirect: 0.000000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">time_starttransfer: 0.781766
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">----------time_total: 0.781826
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>到 Server IP &lt;code>1.2.3.4&lt;/code> 的線路測試&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# traceroute -T 1.2.3.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">traceroute to 1.2.3.4 &lt;span class="o">(&lt;/span>1.2.3.4&lt;span class="o">)&lt;/span>, &lt;span class="m">30&lt;/span> hops max, &lt;span class="m">60&lt;/span> byte packets
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="m">1&lt;/span> * * *
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="m">2&lt;/span> 240.1.24.4 &lt;span class="o">(&lt;/span>240.1.24.4&lt;span class="o">)&lt;/span> 0.211 ms 240.1.24.5 &lt;span class="o">(&lt;/span>240.1.24.5&lt;span class="o">)&lt;/span> 0.225 ms 0.486 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="m">3&lt;/span> 242.3.43.1 &lt;span class="o">(&lt;/span>242.3.43.1&lt;span class="o">)&lt;/span> 3.451 ms 242.3.43.5 &lt;span class="o">(&lt;/span>242.3.43.5&lt;span class="o">)&lt;/span> 2.972 ms 242.3.42.7 &lt;span class="o">(&lt;/span>242.3.42.7&lt;span class="o">)&lt;/span> 2.963 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="m">4&lt;/span> 52.93.68.29 &lt;span class="o">(&lt;/span>52.93.68.29&lt;span class="o">)&lt;/span> 1.320 ms 52.93.68.79 &lt;span class="o">(&lt;/span>52.93.68.79&lt;span class="o">)&lt;/span> 8.062 ms 52.93.68.97 &lt;span class="o">(&lt;/span>52.93.68.97&lt;span class="o">)&lt;/span> 0.557 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl"> &lt;span class="m">5&lt;/span> 100.91.177.167 &lt;span class="o">(&lt;/span>100.91.177.167&lt;span class="o">)&lt;/span> 190.061 ms 100.106.85.41 &lt;span class="o">(&lt;/span>100.106.85.41&lt;span class="o">)&lt;/span> 191.664 ms 100.91.176.251 &lt;span class="o">(&lt;/span>100.91.176.251&lt;span class="o">)&lt;/span> 190.035 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl"> &lt;span class="m">6&lt;/span> * 240.0.184.13 &lt;span class="o">(&lt;/span>240.0.184.13&lt;span class="o">)&lt;/span> 1860.666 ms 240.0.236.34 &lt;span class="o">(&lt;/span>240.0.236.34&lt;span class="o">)&lt;/span> 1901.460 ms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl"> &lt;span class="m">7&lt;/span> 242.2.212.33 &lt;span class="o">(&lt;/span>242.2.212.33&lt;span class="o">)&lt;/span> 191.295 ms 242.3.84.161 &lt;span class="o">(&lt;/span>242.3.84.161&lt;span class="o">)&lt;/span> 192.339 ms 242.3.85.33 &lt;span class="o">(&lt;/span>242.3.85.33&lt;span class="o">)&lt;/span> 191.432 ms
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# mtr -b -T -r -c &lt;span class="m">30&lt;/span> 1.2.3.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Start: 2024-05-09T10:16:58+0000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">HOST: ip-172-31-41-190 Loss% Snt Last Avg Best Wrst StDev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> 1.&lt;span class="p">|&lt;/span>-- ??? 100.0 &lt;span class="m">30&lt;/span> 0.0 0.0 0.0 0.0 0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> 2.&lt;span class="p">|&lt;/span>-- 240.1.24.5 0.0% &lt;span class="m">30&lt;/span> 0.3 0.3 0.3 0.4 0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> 240.1.24.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> 240.1.24.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> 240.1.24.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> 3.&lt;span class="p">|&lt;/span>-- 242.3.42.135 0.0% &lt;span class="m">30&lt;/span> 2.8 5.7 2.5 20.4 5.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> 242.3.42.129
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> 242.3.43.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> 242.3.43.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> 242.3.43.133
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> 242.3.43.131
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> 242.3.43.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> 242.3.42.131
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> 4.&lt;span class="p">|&lt;/span>-- 52.93.68.95 0.0% &lt;span class="m">30&lt;/span> 0.7 4.7 0.6 21.9 5.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> 52.93.68.93
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> 52.93.68.45
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> 52.93.68.125
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> 52.93.68.79
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> 52.93.68.129
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> 52.93.68.143
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> 52.93.68.65
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> 5.&lt;span class="p">|&lt;/span>-- 100.106.85.13 0.0% &lt;span class="m">30&lt;/span> 193.4 193.8 190.2 211.9 5.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> 100.91.177.73
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> 100.91.176.243
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> 100.91.177.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> 100.91.176.221
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> 100.91.177.93
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> 100.106.86.73
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> 100.106.85.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> 100.91.177.113
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@ip-172-31-41-190:~# iperf3 -t &lt;span class="m">30&lt;/span> -c 1.2.3.4 -p &lt;span class="m">31987&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Connecting to host 1.2.3.4, port &lt;span class="m">31987&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> &lt;span class="nb">local&lt;/span> 172.31.41.190 port &lt;span class="m">42998&lt;/span> connected to 1.2.3.4 port &lt;span class="m">31987&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> ID&lt;span class="o">]&lt;/span> Interval Transfer Bitrate Retr Cwnd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 0.00-1.00 sec 2.25 MBytes 18.9 Mbits/sec &lt;span class="m">0&lt;/span> &lt;span class="m">440&lt;/span> KBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 1.00-2.00 sec 9.81 MBytes 82.3 Mbits/sec &lt;span class="m">61&lt;/span> 3.88 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 2.00-3.00 sec 10.0 MBytes 83.9 Mbits/sec &lt;span class="m">303&lt;/span> 2.84 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 3.00-4.00 sec 13.8 MBytes &lt;span class="m">115&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 4.00-5.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 5.00-6.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 6.00-7.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 7.00-8.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 8.00-9.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 9.00-10.00 sec 13.8 MBytes &lt;span class="m">115&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 10.00-11.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 11.00-12.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 12.00-13.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 13.00-14.00 sec 13.8 MBytes &lt;span class="m">115&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 14.00-15.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 15.00-16.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 16.00-17.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 17.00-18.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 18.00-19.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 19.00-20.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 20.00-21.00 sec 13.8 MBytes &lt;span class="m">115&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 21.00-22.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 22.00-23.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 23.00-24.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 24.00-25.00 sec 13.8 MBytes &lt;span class="m">115&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 25.00-26.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 26.00-27.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 27.00-28.00 sec 16.2 MBytes &lt;span class="m">136&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 28.00-29.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 29.00-30.00 sec 15.0 MBytes &lt;span class="m">126&lt;/span> Mbits/sec &lt;span class="m">0&lt;/span> 3.05 MBytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl">- - - - - - - - - - - - - - - - - - - - - - - - -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> ID&lt;span class="o">]&lt;/span> Interval Transfer Bitrate Retr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 0.00-30.00 sec &lt;span class="m">430&lt;/span> MBytes &lt;span class="m">120&lt;/span> Mbits/sec &lt;span class="m">364&lt;/span> sender
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 5&lt;span class="o">]&lt;/span> 0.00-30.19 sec &lt;span class="m">429&lt;/span> MBytes &lt;span class="m">119&lt;/span> Mbits/sec receiver
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>安裝 EMQX 到 Kubernetes 上</title><link>https://chiehting.com/posts/emqx-install/</link><pubDate>Mon, 06 May 2024 11:04:27 +0800</pubDate><guid>https://chiehting.com/posts/emqx-install/</guid><description>
&lt;p>如何使用 emqx-operator 建立 EMQX 服務到 Kubernetes 上。&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>&lt;a href="https://github.com/emqx/emqx-operator/tree/main/deploy/charts/emqx-operator">emqx-operator&lt;/a> 是用 Helm 的腳本，可以快速定義 EMXQ 服務。&lt;/p>
&lt;p>引用 Github 上的架構圖，如下：&lt;/p>
&lt;img src="https://github.com/emqx/emqx-operator/raw/main/docs/en_US/introduction/assets/architecture.png"/>
&lt;p>從架構圖上可以看到兩款 EMQX Operator、EMQX Cluster 則為我們要建立的服務。&lt;/p>
&lt;h4 id="emqx-operator">EMQX Operator&lt;/h4>
&lt;p>為 EMQX 的 CRD，是需要最先建立的資源，建立命令如下。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">helm upgrade --install emqx-operator emqx/emqx-operator &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span>--namespace emqx-operator-system &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span>--create-namespace &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span>--version 2.2.5 -f values.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上面命令包括了 &lt;code>values.yaml&lt;/code> 檔案，內容如下。主要是使服務更可以建立在指定的 nodes 中。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">repository&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">emqx/emqx-operator-controller&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">tag&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">2.2.5&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">imagePullSecrets&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">replicaCount&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">limits&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">500m&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">512Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">100m&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">128Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">affinity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nodeAffinity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">requiredDuringSchedulingIgnoredDuringExecution&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nodeSelectorTerms&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;lindu-tech/server&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">In&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;infra&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">tolerations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;lindu-tech/server&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;Exists&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">effect&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;NoSchedule&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">affinity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">podAntiAffinity&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">requiredDuringSchedulingIgnoredDuringExecution&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">labelSelector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">matchExpressions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;app.kubernetes.io/name&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">operator&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">In&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">values&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;emqx-operator&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">topologyKey&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;kubernetes.io/hostname&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="emqx-cluster">EMQX Cluster&lt;/h4>
&lt;p>建立好 EMQX Operator 後，可以使用 &lt;code>Kind: EMQX&lt;/code>，接著才建立 EMQX Cluster。&lt;/p>
&lt;p>創建一個 emqx-cluster.yaml 檔案，內容如下。服務只開啟了 &lt;code>listeners.tcp.default&lt;/code>，其他因為使用不到所以皆關閉。其服務是使用 nodePort 的方式揭露，port 的位置需自行地義，不要衝突。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps.emqx.io/v2beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">EMQX&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">emqx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">emqx:5.3.2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">config&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="sd"> listeners.tcp.default {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="sd"> enable = true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="sd"> bind = &amp;#34;0.0.0.0:1883&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="sd"> max_connections = 1024
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="sd"> max_conn_rate = &amp;#34;1000/s&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="sd"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="sd"> listeners.wss.default {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="sd"> enable = false
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="sd"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="sd"> listeners.ssl.default {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="sd"> enable = false
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="sd"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="sd"> listeners.ws.default {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="sd"> enable = false
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="sd"> }&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">coreTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeClaimTemplates&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sas&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">5Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">200m&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">256Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicantTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">41&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">42&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">43&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">250m&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">44&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">256Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">45&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">listenersServiceTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">46&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">47&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NodePort&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">48&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">49&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># - name: wss-default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">50&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># nodePort: 31081&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">51&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># port: 8084&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">52&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># protocol: TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">53&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># targetPort: 8084&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">54&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># - name: ssl-default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">55&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># nodePort: 31082&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">56&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># port: 8883&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">57&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># protocol: TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">58&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># targetPort: 8883&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">59&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tcp-default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">60&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nodePort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">31083&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">61&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1883&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">62&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">63&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1883&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">64&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># - name: ws-default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">65&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># nodePort: 31084&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">66&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># port: 8083&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">67&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># protocol: TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">68&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># targetPort: 8083&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">69&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dashboardServiceTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">70&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">71&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NodePort&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">72&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">73&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tcp-default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">74&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nodePort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">32083&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">75&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">18083&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">76&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">77&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">18083&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>定義建立好後，運行下面命令創建資源，資源會建立在預設的 namespace 中。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">kubectl apply -f emqx-cluster.yaml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1"># 確認資源狀態&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">kubectl get emqx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">NAME STATUS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">emqx Ready 5d18h
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="配置-ssl-連線">配置 SSL 連線&lt;/h4>
&lt;p>EMQX 有整合 &lt;code>cert-manager&lt;/code> 服務，可以透過配置執行憑證的申請，但是憑證只能在與 EMQX Operator 同個 namespace 中，以上面的命令為例就會建立在 namespace &lt;code>emqx-operator-system&lt;/code> 裡面。&lt;/p>
&lt;p>如果 EMQX Operator 與 EMQX Cluster 不在同個 namespace 中的話，就會取不到憑證，所以要另外配置，下面為配置方式。&lt;/p>
&lt;p>收先要先使用 cert-manager 做憑證的申請並建立 secret，建立一個 test-mqtt.example.com.yaml 檔案，內容如下。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cert-manager.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Certificate&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">app.kubernetes.io/instance&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">emqx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">app.kubernetes.io/name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">emqx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test-mqtt.example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dnsNames&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">test-mqtt.example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">duration&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2160h0m0s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">issuerRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">cert-manager.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterIssuer&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">letsencrypt-http01&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">renewBefore&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">360h0m0s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test-mqtt.example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">usages&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">digital signature&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">key encipherment&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>運行上面定義的 yaml 來建立資源，執行憑證的申請。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">kubectl apply -f test-mqtt.example.com.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>接著配置 EMQX Cluster 的憑證掛載，&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps.emqx.io/v2beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">EMQX&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">emqx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">emqx:5.3.2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">config&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">data&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="sd"> listeners.tcp.default {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 10&lt;/span>&lt;span class="cl">&lt;span class="sd"> enable = true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 11&lt;/span>&lt;span class="cl">&lt;span class="sd"> bind = &amp;#34;0.0.0.0:1883&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 12&lt;/span>&lt;span class="cl">&lt;span class="sd"> max_connections = 1024
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 13&lt;/span>&lt;span class="cl">&lt;span class="sd"> max_conn_rate = &amp;#34;1000/s&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 14&lt;/span>&lt;span class="cl">&lt;span class="sd"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 15&lt;/span>&lt;span class="cl">&lt;span class="sd"> listeners.ssl.default {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 16&lt;/span>&lt;span class="cl">&lt;span class="sd"> enable = true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 17&lt;/span>&lt;span class="cl">&lt;span class="sd"> bind = &amp;#34;0.0.0.0:8883&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 18&lt;/span>&lt;span class="cl">&lt;span class="sd"> max_connections = 1024
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 19&lt;/span>&lt;span class="cl">&lt;span class="sd"> max_conn_rate = &amp;#34;1000/s&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 20&lt;/span>&lt;span class="cl">&lt;span class="sd"> ssl_options {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 21&lt;/span>&lt;span class="cl">&lt;span class="sd"> cacertfile = &amp;#34;/mounted/cert/ca.crt&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 22&lt;/span>&lt;span class="cl">&lt;span class="sd"> certfile = &amp;#34;/mounted/cert/tls.crt&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 23&lt;/span>&lt;span class="cl">&lt;span class="sd"> keyfile = &amp;#34;/mounted/cert/tls.key&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 24&lt;/span>&lt;span class="cl">&lt;span class="sd"> gc_after_handshake = true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 25&lt;/span>&lt;span class="cl">&lt;span class="sd"> handshake_timeout = 5s
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 26&lt;/span>&lt;span class="cl">&lt;span class="sd"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 27&lt;/span>&lt;span class="cl">&lt;span class="sd"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 28&lt;/span>&lt;span class="cl">&lt;span class="sd"> listeners.wss.default {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 29&lt;/span>&lt;span class="cl">&lt;span class="sd"> enable = false
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 30&lt;/span>&lt;span class="cl">&lt;span class="sd"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 31&lt;/span>&lt;span class="cl">&lt;span class="sd"> listeners.ws.default {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 32&lt;/span>&lt;span class="cl">&lt;span class="sd"> enable = false
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 33&lt;/span>&lt;span class="cl">&lt;span class="sd"> }&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 34&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">coreTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 35&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 36&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumeClaimTemplates&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 37&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">storageClassName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">sas&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 38&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 39&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 40&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">storage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">5Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 41&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">accessModes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 42&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ReadWriteOnce&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 43&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 44&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 45&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 46&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">200m&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 47&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">256Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 48&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">extraVolumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 49&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">emqx-tls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 50&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">secret&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 51&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test-mqtt.example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 52&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">extraVolumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 53&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">emqx-tls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 54&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/mounted/cert&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 55&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicantTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 56&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 57&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">replicas&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 58&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 59&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">requests&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 60&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cpu&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">250m&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 61&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">memory&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">256Mi&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 62&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">extraVolumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 63&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">emqx-tls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 64&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">secret&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 65&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">secretName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">test-mqtt.example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 66&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">extraVolumeMounts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 67&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">emqx-tls&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 68&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">mountPath&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/mounted/cert&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 69&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">listenersServiceTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 70&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 71&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NodePort&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 72&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 73&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># - name: wss-default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 74&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># nodePort: 30712&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 75&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># port: 8084&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 76&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># protocol: TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 77&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># targetPort: 8084&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 78&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ssl-default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 79&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nodePort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">31082&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 80&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8883&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 81&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 82&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">8884&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 83&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tcp-default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 84&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nodePort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">31083&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 85&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1883&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 86&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 87&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1884&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 88&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># - name: ws-default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 89&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># nodePort: 31394&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 90&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># port: 8083&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 91&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># protocol: TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 92&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># targetPort: 8083&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 93&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dashboardServiceTemplate&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 94&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 95&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">NodePort&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 96&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ports&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 97&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">tcp-default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 98&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">nodePort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">32084&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 99&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">18083&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">100&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">protocol&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">TCP&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">101&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">targetPort&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">18083&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>接著執行配置更新，就可以使用 mqtts:// 來做連線。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="l">kubectl apply -f emqx-cluster.yaml&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="test">test&lt;/h3>
&lt;p>使用工具 &lt;a href="https://mqttx.app/">mqttx&lt;/a> 工具做測試，看連線次是否有成功建立。&lt;/p></description></item><item><title>DNS resolution takes a long time</title><link>https://chiehting.com/posts/dns-resolution-long-time/</link><pubDate>Fri, 19 Apr 2024 10:00:19 +0800</pubDate><guid>https://chiehting.com/posts/dns-resolution-long-time/</guid><description>
&lt;p>最近發現 CI/CD 流程中一直發生異常通知，異常的失敗率達 50%，排查之後發現是 DNS 解析異常導致流程無法順利執行。由於伺服器在內地，所以最後將 DNS 服務器更換成百度的服務器，當下異常問題則排除，後續持續做觀察。&lt;/p>
&lt;h3 id="evergreen-note">Evergreen Note&lt;/h3>
&lt;p>Question :: 這篇文章主要在說什麼?&lt;/p>
&lt;p>Answer :: 在排除 DNS 解析過慢的問題。這次的問題是阿里雲的 DNS 伺服器很慢甚至沒回應（這邊不討論阿里雲怎麼了，但...），所以要選用好的 DNS 伺服器，我通常是用 Google 的 &lt;code>8.8.8.8&lt;/code>，但是在牆內不是一個好的決定，經過一波測試後，最後選擇使用百度雲的 DNS 伺服器。&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;h4 id="log-analysis">Log analysis&lt;/h4>
&lt;p>這兩天一直發生 CI/CD 異常問題時好時壞。發生的太過頻繁近 20 筆資料的錯誤率達（10 error/20 tirgger）50%，覺得可能不是公司內部網路的問題，於是就查看了服務的 log，兩個服務的錯誤原因皆是 DNS 解析異常。&lt;/p>
&lt;p>GitLab log 上顯示異常原因為 DNS 解析異常，下面列出一筆 log 資訊。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">curl: (6) Could not resolve host: hooks.slack.com
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Harbor log 上顯示異常原因為 DNS 解析異常，下面列出一筆 log 資訊。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">2024-04-18T02:50:02Z [ERROR] [/controller/replication/transfer/image/transfer.go:335]::: dial tcp: lookup swr.cn-east-3.myhuaweicloud.com: No address associated with hostname
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="dns-resolve">DNS resolve&lt;/h4>
&lt;p>預設是使用阿里雲的 DNS 解析服務器 &lt;code>233.5.5.5&lt;/code>，看到解析不是超時就是過慢（約莫 1 min）。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@infra:~# resolvectl dns eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">Link 4 (eno1): 233.5.5.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">root@infra:~# resolvectl query hooks.slack.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">hooks.slack.com: resolve call failed: All attempts to contact name servers or networks failed
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>下意識就更換了 Google 的 DNS 解析服務器 &lt;code>8.8.8.8&lt;/code>，解析時間時好時壞（約莫 25.6ms ~ 1 min），也不知道取決於什麼。但是在牆內用 Google DNS 解析可能不是好的選則。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@infra:~# resolvectl dns eno1 8.8.8.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">root@infra:~# resolvectl dns eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">Link 4 (eno1): 8.8.8.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">root@infra:~# resolvectl query hooks.slack.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">hooks.slack.com: 52.192.46.121 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> 52.196.128.139 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> 35.74.58.174 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> 35.73.126.78 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">-- Information acquired via protocol DNS in 25.6ms.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">-- Data is authenticated: no; Data was acquired via local or encrypted transport: no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">-- Data from: network
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>下面更換了百度的 DNS 解析服務器 &lt;code>180.76.76.76&lt;/code>，效果就好很多，幾乎在 200 ms 內回覆，所以就決定是你了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@infra:~# resolvectl dns eno1 180.76.76.76
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">root@infra:~# resolvectl dns eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">Link 4 (eno1): 180.76.76.76
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">root@infra:~# resolvectl query hooks.slack.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">hooks.slack.com: 35.74.58.174 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> 35.73.126.78 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> 52.196.128.139 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> 52.192.46.121 -- link: eno1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">-- Information acquired via protocol DNS in 11.9ms.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">-- Data is authenticated: no; Data was acquired via local or encrypted transport: no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">-- Data from: cache network
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Macos 的 System Integrity Protection</title><link>https://chiehting.com/posts/moc-system-integrity-protection/</link><pubDate>Tue, 27 Feb 2024 17:06:07 +0800</pubDate><guid>https://chiehting.com/posts/moc-system-integrity-protection/</guid><description>
&lt;p>System Integrity Protection (SIP)，有時也被稱為 &amp;quot;rootless&amp;quot;，是 Apple 在 OS X El Capitan (10.11) 中引入的一項重要的安全技術。&lt;/p>
&lt;p>&lt;strong>它的主要作用是保護 macOS 系統的關鍵部分，使其免受惡意軟體和未經授權的修改。&lt;/strong>&lt;/p>
&lt;p>&lt;a href="https://support.apple.com/en-us/102149">About System Integrity Protection on your Mac&lt;/a>&lt;/p>
&lt;p>&lt;em>系統完整性保護&lt;/em> 可以預防惡意軟體竄改指定的檔案或目錄，功能預設為啟用。&lt;/p>
&lt;p>在開發測試擴充軟體時可以暫時性關閉，等測試完成後則要在開啟，否則會遇到系統未知的異常狀況，目前有碰到下面幾項：&lt;/p>
&lt;ol>
&lt;li>Apple Store 部分的 APP 無法開啟（例如 VoiceTube），提示說要 &lt;code>To open this app, you’ll need to start up your Mac from macOS Recovery and change the Security Policy to Full Security or Reduced Security.&lt;/code>。&lt;/li>
&lt;li>&lt;a href="https://apple.stackexchange.com/questions/384310/how-do-i-configure-camera-and-microphone-permission-on-macos-mojave">視訊與麥克風授權異常&lt;/a>。APP 在跟 MacOS 要權限時，沒有出現要求權限的視窗，也不會在 &lt;em>privacy &amp;amp; security&lt;/em> 中出現，且過程中沒任何錯誤訊息。&lt;/li>
&lt;/ol>
&lt;h3 id="關閉-sip">關閉 SIP&lt;/h3>
&lt;ol>
&lt;li>&lt;strong>重新啟動您的 Mac。&lt;/strong>&lt;/li>
&lt;li>&lt;strong>進入 macOS 恢復模式：&lt;/strong>
&lt;ul>
&lt;li>&lt;strong>對於 Apple Silicon 處理器的 Mac (M1, M2, M3 等晶片):&lt;/strong> 按住電源按鈕，直到看到啟動選項畫面。然後點擊「選項」並繼續。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>打開「終端機」應用程式：&lt;/strong> 一旦進入恢復模式，您會在螢幕頂部的菜單欄中看到「工具程式」(Utilities)。點擊「工具程式」，然後選擇「終端機」(Terminal)。&lt;/li>
&lt;li>&lt;strong>輸入關閉 SIP 的命令：&lt;/strong> 在終端機視窗中，輸入以下命令，然後按下 &lt;code>Return&lt;/code> 鍵：&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="sb">`&lt;/span>csrutil disable&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="5">
&lt;li>&lt;strong>確認操作：&lt;/strong> 系統可能會提示您確認此操作，請按照螢幕上的指示進行。&lt;/li>
&lt;li>&lt;strong>重新啟動您的 Mac：&lt;/strong> 關閉終端機，然後從 Apple 菜單中選擇「重新啟動」。&lt;/li>
&lt;/ol></description></item><item><title>rfc6265</title><link>https://chiehting.com/posts/internet-rfc-6265-server-requirements/</link><pubDate>Fri, 16 Feb 2024 11:28:57 +0800</pubDate><guid>https://chiehting.com/posts/internet-rfc-6265-server-requirements/</guid><description>
&lt;p>文章是在導讀 Set-Cookie header fields 規範以及重要屬性。&lt;/p>
&lt;h3 id="referances">Referances&lt;/h3>
&lt;p>&lt;a href="https://www.rfc-editor.org/rfc/rfc6265.html#section-4">HTTP State Management Mechanism&lt;/a>&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>第四章節是在說明 Set-Cookie 的方式，其中關鍵字為 &lt;code>Set-Cookie&lt;/code>，將 Set-Cookie 加到 response header 內容中，其格式是使用 name-value-pair，並返回給 user agent。&lt;/p>
&lt;p>user agent 收到 Set-Cookie 後會保存其資料，如果該資料已經存在則會覆蓋。這邊也建議伺服器將資料內容做編碼，例如 base64。&lt;/p>
&lt;p>在 4.1.2 的章節中有幾個重要的屬性，條列如下：&lt;/p>
&lt;p>4.1.2.1. The Expires Attribute：定義 Cookies 的過期時間，過期後則不保留 cookie。&lt;/p>
&lt;p>4.1.2.2. The Max-Age Attribute：定義 Cookies 的保留日期，過期後則不保留 cookie。&lt;/p>
&lt;p>4.1.2.3. The Domain Attribute：定義 Cookies 的域名。&lt;/p>
&lt;blockquote>
&lt;p>For example, if the value of the Domain attribute is
&amp;quot;example.com&amp;quot;, the user agent will include the cookie in the Cookie
header when making HTTP requests to example.com, &lt;a href="https://www.example.com">www.example.com&lt;/a>, and
&lt;a href="https://www.corp.example.com">www.corp.example.com&lt;/a>.&lt;/p>
&lt;/blockquote>
&lt;p>4.1.2.4. The Path Attribute：定義 Cookies 的路徑。配置 Path Attribute 後，就只會在指定的路徑中做 Cookies 的交互。&lt;/p>
&lt;p>4.1.2.5. The Secure Attribute：限制 Cookies 只能在 &amp;quot;安全&amp;quot; 頻道中做傳輸。配置 Secure Attribute 後，就只能在 HTTPS 的請求中做 Cookies 的交互。&lt;/p>
&lt;p>4.1.2.6. The HttpOnly Attribute：限制 Cookies 的存取方式。配置 HttpOnly Attribute 後，就只能使用 http 請求做 Cookies 的存取，否則會被省略，例如無法使用 javascript 來存取 Cookies 的內容。&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.rfc-editor.org/rfc/rfc6265.html#section-4">rfc6265&lt;/a>&lt;/p>
&lt;h4 id="4-server-requirements">4. Server Requirements&lt;/h4>
&lt;p>This section describes the syntax and semantics of a well-behaved
profile of the Cookie and Set-Cookie headers.&lt;/p>
&lt;p>4.1. Set-Cookie&lt;/p>
&lt;p>The Set-Cookie HTTP response header is used to send cookies from the
server to the user agent.&lt;/p>
&lt;p>4.1.1. Syntax&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red"> Informally, the Set-Cookie response header contains the header name
&amp;quot;Set-Cookie&amp;quot; followed by a &amp;quot;:&amp;quot; and a cookie.&lt;/span> Each cookie begins with
a name-value-pair, followed by zero or more attribute-value pairs.
Servers SHOULD NOT send Set-Cookie headers that fail to conform to
the following grammar:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">set-cookie-header = &amp;#34;Set-Cookie:&amp;#34; SP set-cookie-string
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">set-cookie-string = cookie-pair *( &amp;#34;;&amp;#34; SP cookie-av )
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">cookie-pair = cookie-name &amp;#34;=&amp;#34; cookie-value
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">cookie-name = token
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">cookie-value = *cookie-octet / ( DQUOTE *cookie-octet DQUOTE )
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">cookie-octet = %x21 / %x23-2B / %x2D-3A / %x3C-5B / %x5D-7E
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> ; US-ASCII characters excluding CTLs,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> ; whitespace DQUOTE, comma, semicolon,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> ; and backslash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">token = &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">token&lt;/span>&lt;span class="err">,&lt;/span> &lt;span class="na">defined&lt;/span> &lt;span class="na">in&lt;/span> &lt;span class="err">[&lt;/span>&lt;span class="na">RFC2616&lt;/span>&lt;span class="err">],&lt;/span> &lt;span class="na">Section&lt;/span> &lt;span class="na">2&lt;/span>&lt;span class="err">.&lt;/span>&lt;span class="na">2&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">cookie-av = expires-av / max-age-av / domain-av /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> path-av / secure-av / httponly-av /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> extension-av
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">expires-av = &amp;#34;Expires=&amp;#34; sane-cookie-date
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">sane-cookie-date = &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">rfc1123-date&lt;/span>&lt;span class="err">,&lt;/span> &lt;span class="na">defined&lt;/span> &lt;span class="na">in&lt;/span> &lt;span class="err">[&lt;/span>&lt;span class="na">RFC2616&lt;/span>&lt;span class="err">],&lt;/span> &lt;span class="na">Section&lt;/span> &lt;span class="na">3&lt;/span>&lt;span class="err">.&lt;/span>&lt;span class="na">3&lt;/span>&lt;span class="err">.&lt;/span>&lt;span class="na">1&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">max-age-av = &amp;#34;Max-Age=&amp;#34; non-zero-digit *DIGIT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> ; In practice, both expires-av and max-age-av
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> ; are limited to dates representable by the
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> ; user agent.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">non-zero-digit = %x31-39
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> ; digits 1 through 9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">domain-av = &amp;#34;Domain=&amp;#34; domain-value
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">domain-value = &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">subdomain&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> ; defined in [RFC1034], Section 3.5, as
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> ; enhanced by [RFC1123], Section 2.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">path-av = &amp;#34;Path=&amp;#34; path-value
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">path-value = &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">any&lt;/span> &lt;span class="na">CHAR&lt;/span> &lt;span class="na">except&lt;/span> &lt;span class="na">CTLs&lt;/span> &lt;span class="na">or&lt;/span> &lt;span class="err">&amp;#34;;&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">secure-av = &amp;#34;Secure&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">httponly-av = &amp;#34;HttpOnly&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">extension-av = &lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">any&lt;/span> &lt;span class="na">CHAR&lt;/span> &lt;span class="na">except&lt;/span> &lt;span class="na">CTLs&lt;/span> &lt;span class="na">or&lt;/span> &lt;span class="err">&amp;#34;;&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Note that some of the grammatical terms above reference documents
that use different grammatical notations than this document (which
uses ABNF from [RFC5234]).&lt;/p>
&lt;p>The semantics of the cookie-value are not defined by this document.&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">To maximize compatibility with user agents, servers that wish to
store arbitrary data in a cookie-value SHOULD encode that data, for
example, using Base64 [RFC4648].&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The portions of the set-cookie-string produced by the cookie-av term
are known as attributes. To maximize compatibility with user agents,
servers SHOULD NOT produce two attributes with the same name in the
same set-cookie-string. (See Section 5.3 for how user agents handle
this case.)&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">Servers SHOULD NOT include more than one Set-Cookie header field in
the same response with the same cookie-name. (See Section 5.2 for
how user agents handle this case.)&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">If a server sends multiple responses containing Set-Cookie headers
concurrently to the user agent (e.g., when communicating with the
user agent over multiple sockets), these responses create a &amp;quot;race
condition&amp;quot; that can lead to unpredictable behavior.&lt;/span>&lt;/p>
&lt;p>NOTE: Some existing user agents differ in their interpretation of
two-digit years. To avoid compatibility issues, servers SHOULD use
the rfc1123-date format, which requires a four-digit year.&lt;/p>
&lt;p>NOTE: Some user agents store and process dates in cookies as 32-bit
UNIX time_t values. Implementation bugs in the libraries supporting
time_t processing on some systems might cause such user agents to
process dates after the year 2038 incorrectly.&lt;/p>
&lt;p>4.1.2. Semantics (Non-Normative)&lt;/p>
&lt;p>This section describes simplified semantics of the Set-Cookie header.
These semantics are detailed enough to be useful for understanding
the most common uses of cookies by servers. The full semantics are
described in Section 5.&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">When the user agent receives a Set-Cookie header, the user agent
stores the cookie together with its attributes. Subsequently, when
the user agent makes an HTTP request, the user agent includes the
applicable, non-expired cookies in the Cookie header.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">If the user agent receives a new cookie with the same cookie-name,
domain-value, and path-value as a cookie that it has already stored,
the existing cookie is evicted and replaced with the new cookie.
Notice that servers can delete cookies by sending the user agent a
new cookie with an Expires attribute with a value in the past.&lt;/span>&lt;/p>
&lt;p>Unless the cookie's attributes indicate otherwise, the cookie is
returned only to the origin server (and not, for example, to any
subdomains), and it expires at the end of the current session (as
defined by the user agent). User agents ignore unrecognized cookie
attributes (but not the entire cookie).&lt;/p>
&lt;p>4.1.2.1. The Expires Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The Expires attribute indicates the maximum lifetime of the cookie,
represented as the date and time at which the cookie expires. The
user agent is not required to retain the cookie until the specified
date has passed. In fact, user agents often evict cookies due to
memory pressure or privacy concerns.&lt;/span>&lt;/p>
&lt;p>4.1.2.2. The Max-Age Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red"> The Max-Age attribute indicates the maximum lifetime of the cookie,
represented as the number of seconds until the cookie expires. The
user agent is not required to retain the cookie for the specified
duration. In fact, user agents often evict cookies due to memory
pressure or privacy concerns.&lt;/span>&lt;/p>
&lt;pre>&lt;code> NOTE: Some existing user agents do not support the Max-Age
attribute. User agents that do not support the Max-Age attribute
ignore the attribute.
&lt;/code>&lt;/pre>
&lt;p>If a cookie has both the Max-Age and the Expires attribute, the Max-
Age attribute has precedence and controls the expiration date of the
cookie. If a cookie has neither the Max-Age nor the Expires
attribute, the user agent will retain the cookie until &amp;quot;the current
session is over&amp;quot; (as defined by the user agent).&lt;/p>
&lt;p>4.1.2.3. The Domain Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The Domain attribute specifies those hosts to which the cookie will
be sent. For example, if the value of the Domain attribute is
&amp;quot;example.com&amp;quot;, the user agent will include the cookie in the Cookie
header when making HTTP requests to example.com, &lt;a href="https://www.example.com">www.example.com&lt;/a>, and
&lt;a href="https://www.corp.example.com">www.corp.example.com&lt;/a>.&lt;/span> (Note that a leading %x2E (&amp;quot;.&amp;quot;), if present,
is ignored even though that character is not permitted, but a
trailing %x2E (&amp;quot;.&amp;quot;), if present, will cause the user agent to ignore
the attribute.) If the server omits the Domain attribute, the user
agent will return the cookie only to the origin server.&lt;/p>
&lt;pre>&lt;code> WARNING: Some existing user agents treat an absent Domain
attribute as if the Domain attribute were present and contained
the current host name. For example, if example.com returns a Set-
Cookie header without a Domain attribute, these user agents will
erroneously send the cookie to www.example.com as well.
&lt;/code>&lt;/pre>
&lt;p>The user agent will reject cookies unless the Domain attribute
specifies a scope for the cookie that would include the origin
server. For example, the user agent will accept a cookie with a
Domain attribute of &amp;quot;example.com&amp;quot; or of &amp;quot;foo.example.com&amp;quot; from
foo.example.com, but the user agent will not accept a cookie with a
Domain attribute of &amp;quot;bar.example.com&amp;quot; or of &amp;quot;baz.foo.example.com&amp;quot;.&lt;/p>
&lt;p>NOTE: For security reasons, many user agents are configured to reject
Domain attributes that correspond to &amp;quot;public suffixes&amp;quot;. For example,
some user agents will reject Domain attributes of &amp;quot;com&amp;quot; or &amp;quot;co.uk&amp;quot;.
(See Section 5.3 for more information.)&lt;/p>
&lt;p>4.1.2.4. The Path Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The scope of each cookie is limited to a set of paths, controlled by
the Path attribute. If the server omits the Path attribute, the user
agent will use the &amp;quot;directory&amp;quot; of the request-uri's path component as
the default value. (See Section 5.1.4 for more details.)&lt;/span>&lt;/p>
&lt;p>The user agent will include the cookie in an HTTP request only if the
path portion of the request-uri matches (or is a subdirectory of) the
cookie's Path attribute, where the %x2F (&amp;quot;/&amp;quot;) character is
interpreted as a directory separator.&lt;/p>
&lt;p>Although seemingly useful for isolating cookies between different
paths within a given host, the Path attribute cannot be relied upon
for security (see Section 8).&lt;/p>
&lt;p>4.1.2.5. The Secure Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The Secure attribute limits the scope of the cookie to &amp;quot;secure&amp;quot;
channels (where &amp;quot;secure&amp;quot; is defined by the user agent). When a
cookie has the Secure attribute, the user agent will include the
cookie in an HTTP request only if the request is transmitted over a
secure channel (typically HTTP over Transport Layer Security (TLS)
[RFC2818]).&lt;/span>&lt;/p>
&lt;p>Although seemingly useful for protecting cookies from active network
attackers, the Secure attribute protects only the cookie's
confidentiality. An active network attacker can overwrite Secure
cookies from an insecure channel, disrupting their integrity (see
Section 8.6 for more details).&lt;/p>
&lt;p>4.1.2.6. The HttpOnly Attribute&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The HttpOnly attribute limits the scope of the cookie to HTTP
requests. In particular, the attribute instructs the user agent to
omit the cookie when providing access to cookies via &amp;quot;non-HTTP&amp;quot; APIs
(such as a web browser API that exposes cookies to scripts).&lt;/span>&lt;/p>
&lt;p>Note that the HttpOnly attribute is independent of the Secure
attribute: a cookie can have both the HttpOnly and the Secure
attribute.&lt;/p>
&lt;p>4.2. Cookie&lt;/p>
&lt;p>4.2.1. Syntax&lt;/p>
&lt;p>The user agent sends stored cookies to the origin server in the
Cookie header. If the server conforms to the requirements in
Section 4.1 (and the user agent conforms to the requirements in
Section 5), the user agent will send a Cookie header that conforms to
the following grammar:&lt;/p>
&lt;p>cookie-header = &amp;quot;Cookie:&amp;quot; OWS cookie-string OWS
cookie-string = cookie-pair *( &amp;quot;;&amp;quot; SP cookie-pair )&lt;/p>
&lt;p>4.2.2. Semantics&lt;/p>
&lt;p>Each cookie-pair represents a cookie stored by the user agent. The
cookie-pair contains the cookie-name and cookie-value the user agent
received in the Set-Cookie header.&lt;/p>
&lt;p>Notice that the cookie attributes are not returned. In particular,
the server cannot determine from the Cookie header alone when a
cookie will expire, for which hosts the cookie is valid, for which
paths the cookie is valid, or whether the cookie was set with the
Secure or HttpOnly attributes.&lt;/p>
&lt;p>The semantics of individual cookies in the Cookie header are not
defined by this document. Servers are expected to imbue these
cookies with application-specific semantics.&lt;/p>
&lt;p>Although cookies are serialized linearly in the Cookie header,
servers SHOULD NOT rely upon the serialization order. In particular,
if the Cookie header contains two cookies with the same name (e.g.,
that were set with different Path or Domain attributes), servers
SHOULD NOT rely upon the order in which these cookies appear in the
header.&lt;/p></description></item><item><title>rfc6265</title><link>https://chiehting.com/posts/internet-rfc-6265/</link><pubDate>Fri, 16 Feb 2024 11:28:57 +0800</pubDate><guid>https://chiehting.com/posts/internet-rfc-6265/</guid><description>
&lt;p>文章主要在研究 RFC 6265 - HTTP State Management Mechanism。文章是在定義 HTTP Cookie and Set-Cookie header fields 規範。&lt;/p>
&lt;h3 id="referances">Referances&lt;/h3>
&lt;p>&lt;a href="https://www.rfc-editor.org/rfc/rfc6265.txt">RFC 6265&lt;/a>&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>RFC 6265 - HTTP State Management Mechanism 是在定義 HTTP Cookies and Set-Cookie header fields。Cookie 是 Server / Client 資料交互的方法之一，是 developers of cookie-
generating servers 和 developers of cookie-consuming user agents 需要關心的重要議題。&lt;/p>
&lt;p>第四章節在說明 Set-Cookie header fields 規範以及重要屬性 ([[internet-rfc-6265-server-requirements]])。&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.rfc-editor.org/info/rfc6265">rfc6265&lt;/a>&lt;/p>
&lt;h4 id="abstract">Abstract&lt;/h4>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">This document defines the HTTP Cookie and Set-Cookie header fields. These header fields can be used by HTTP servers to store state (called cookies) at HTTP user agents, letting the servers maintain a stateful session over the mostly stateless HTTP protocol.&lt;/span> Although cookies have many historical infelicities that degrade their security and privacy, the Cookie and Set-Cookie header fields are widely used on the Internet. This document obsoletes RFC 2965. [STANDARDS-TRACK]&lt;/p>
&lt;p>Table of Contents&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">1. Introduction
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">2. Conventions
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> 2.1. Conformance Criteria
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> 2.2. Syntax Notation
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> 2.3. Terminology
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">3. Overview
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> 3.1. Examples
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">4. Server Requirements
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> 4.1. Set-Cookie
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> 4.1.1. Syntax
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> 4.1.2. Semantics (Non-Normative)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> 4.2. Cookie
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> 4.2.1. Syntax
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> 4.2.2. Semantics
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">5. User Agent Requirements
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> 5.1. Subcomponent Algorithms
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> 5.1.1. Dates
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> 5.1.2. Canonicalized Host Names
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> 5.1.3. Domain Matching
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> 5.1.4. Paths and Path-Match
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> 5.2. The Set-Cookie Header
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> 5.2.1. The Expires Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> 5.2.2. The Max-Age Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> 5.2.3. The Domain Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> 5.2.4. The Path Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> 5.2.5. The Secure Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> 5.2.6. The HttpOnly Attribute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> 5.3. Storage Model
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> 5.4. The Cookie Header
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">6. Implementation Considerations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> 6.1. Limits
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> 6.2. Application Programming Interfaces
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> 6.3. IDNA Dependency and Migration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">7. Privacy Considerations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl"> 7.1. Third-Party Cookies
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl"> 7.2. User Controls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl"> 7.3. Expiration Dates
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl">8. Security Considerations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl"> 8.1. Overview
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl"> 8.2. Ambient Authority
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">41&lt;/span>&lt;span class="cl"> 8.3. Clear Text
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">42&lt;/span>&lt;span class="cl"> 8.4. Session Identifiers
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">43&lt;/span>&lt;span class="cl"> 8.5. Weak Confidentiality
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">44&lt;/span>&lt;span class="cl"> 8.6. Weak Integrity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">45&lt;/span>&lt;span class="cl"> 8.7. Reliance on DNS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">46&lt;/span>&lt;span class="cl">9. IANA Considerations
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">47&lt;/span>&lt;span class="cl"> 9.1. Cookie
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">48&lt;/span>&lt;span class="cl"> 9.2. Set-Cookie
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">49&lt;/span>&lt;span class="cl"> 9.3. Cookie2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">50&lt;/span>&lt;span class="cl"> 9.4. Set-Cookie2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">51&lt;/span>&lt;span class="cl">10. References
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">52&lt;/span>&lt;span class="cl"> 10.1. Normative References
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">53&lt;/span>&lt;span class="cl"> 10.2. Informative References
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">54&lt;/span>&lt;span class="cl">Appendix A. Acknowledgements
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="introduction">Introduction&lt;/h4>
&lt;p>This document defines the HTTP Cookie and Set-Cookie header fields.
&lt;span style="background-color: #ffffcc; color: red">Using the Set-Cookie header field, an HTTP server can pass name/value
pairs and associated metadata (called cookies) to a user agent. When
the user agent makes subsequent requests to the server, the user
agent uses the metadata and other information to determine whether to
return the name/value pairs in the Cookie header.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">Although simple on their surface, cookies have a number of
complexities. For example, the server indicates a scope for each
cookie when sending it to the user agent. The scope indicates the
maximum amount of time in which the user agent should return the
cookie, the servers to which the user agent should return the cookie,
and the URI schemes for which the cookie is applicable.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">For historical reasons, cookies contain a number of security and
privacy infelicities. For example, a server can indicate that a
given cookie is intended for &amp;quot;secure&amp;quot; connections, but the Secure
attribute does not provide integrity in the presence of an active
network attacker. Similarly, cookies for a given host are shared
across all the ports on that host, even though the usual &amp;quot;same-origin
policy&amp;quot; used by web browsers isolates content retrieved via different
ports.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">There are two audiences for this specification: developers of cookie-
generating servers and developers of cookie-consuming user agents.&lt;/span>&lt;/p>
&lt;p>To maximize interoperability with user agents, servers SHOULD limit
themselves to the well-behaved profile defined in Section 4 when
generating cookies.&lt;/p>
&lt;p>User agents MUST implement the more liberal processing rules defined
in Section 5, in order to maximize interoperability with existing
servers that do not conform to the well-behaved profile defined in
Section 4.&lt;/p>
&lt;p>This document specifies the syntax and semantics of these headers as
they are actually used on the Internet. In particular, this document
does not create new syntax or semantics beyond those in use today.
The recommendations for cookie generation provided in Section 4
represent a preferred subset of current server behavior, and even the
more liberal cookie processing algorithm provided in Section 5 does
not recommend all of the syntactic and semantic variations in use
today. Where some existing software differs from the recommended
protocol in significant ways, the document contains a note explaining
the difference.&lt;/p></description></item><item><title>資安團隊的建議回饋</title><link>https://chiehting.com/posts/security-session-and-cookise/</link><pubDate>Fri, 16 Feb 2024 11:28:57 +0800</pubDate><guid>https://chiehting.com/posts/security-session-and-cookise/</guid><description>
&lt;p>資安小組回饋了些建議，讓我們可以強化安全線。主要回報內容為 Session 跟 Cookie 的配置項。&lt;/p>
&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>This document defines the HTTP Cookie and Set-Cookie header fields.&lt;a href="https://www.rfc-editor.org/info/rfc6265">&lt;/a>&lt;/li>
&lt;/ol>
&lt;h3 id="專案被回饋資安-issue資安回饋的建議大致如下">專案被回饋資安 issue，資安回饋的建議大致如下：&lt;/h3>
&lt;ol>
&lt;li>檢視認證 Session 的資料長度，64bit 以上為安全線。 若 Session ID 的長度、複雜度不夠， 可 能被攻擊者猜測 、利用 。&lt;/li>
&lt;li>檢視 Cookie Flag 相關設定 Host Only、Secure、HTTP Only。
&lt;ol>
&lt;li>Host Only：Cookie 只能傳送至 Domain 屬性完全對應的網域 ，不傳送至子網域。&lt;/li>
&lt;li>Secure：只在 HTTPS 連線中傳遞 Cookie 。&lt;/li>
&lt;li>HTTP Only：防止 Cookie 被 Ja v aScript 存取。&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;p>上面的問題，通常可以透過瀏覽器的開發工具來檢視是否符合，通常服務都會有配置可以設定。回報的內容是建議可以開啟 Cookies 的配置，例如 HTTP only、Secure，其定義在文章 [[internet-rfc-6265]]。&lt;/p></description></item><item><title>TCP of linux</title><link>https://chiehting.com/posts/linux-tcp/</link><pubDate>Mon, 08 Jan 2024 16:59:21 +0800</pubDate><guid>https://chiehting.com/posts/linux-tcp/</guid><description>
&lt;p>TCP（Transmission Control Protocol）在使用時，與每個 TCP 連接相關的狀態是動態變化的，而這些狀態通常被監控以確保系統的正常運作。以下是一些 TCP 狀態及其相關的描述：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>&lt;code>ALLOCATED&lt;/code>：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>這通常不是一個 TCP 狀態，而是表示資源已被分配（allocate）給一個 TCP 連接，但可能還沒有被使用。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>LISTEN&lt;/code>：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>當一個服務器正在等待客戶端連接時，該 TCP 連接處於 &lt;code>LISTEN&lt;/code> 狀態。在這種狀態下，該連接可以接受新的連接請求。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>SYN-SENT&lt;/code>：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>客戶端發送一個 SYN（同步）請求，進入 &lt;code>SYN-SENT&lt;/code> 狀態等待伺服器的確認。在這種狀態下，TCP 連接正在初始化。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>SYN-RECEIVED&lt;/code>：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>伺服器在接收到客戶端的 SYN 請求後，發送自己的 SYN 和 ACK（確認）請求，進入 &lt;code>SYN-RECEIVED&lt;/code> 狀態。在這種狀態下，TCP 連接正在確認並同時初始化。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>ESTABLISHED&lt;/code>：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>一旦三次握手完成，連接進入 &lt;code>ESTABLISHED&lt;/code> 狀態，表示數據可以在雙方之間傳輸。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>FIN-WAIT-1&lt;/code>、&lt;code>FIN-WAIT-2&lt;/code>：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>當一方（通常是客戶端或伺服器）決定結束連接，它會進入 &lt;code>FIN-WAIT-1&lt;/code> 狀態，等待對方的確認。在對方發送確認後，它進入 &lt;code>FIN-WAIT-2&lt;/code> 狀態，等待對方的結束請求。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>TIME-WAIT&lt;/code>：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>在一方發送結束請求後，進入 &lt;code>TIME-WAIT&lt;/code> 狀態，等待可能在網絡上延遲的最後一個 ACK。這是為了確保已傳送的 ACK 得到正確處理。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>CLOSE-WAIT&lt;/code>：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>表示對方已經結束連接，而自己還可以發送數據。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>CLOSING&lt;/code>：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>表示雙方都在同時結束連接，但仍然需要進行一些確認。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>LAST-ACK&lt;/code>：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>表示自己已經結束連接，並等待對方的確認。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>CLOSED&lt;/code>：&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>表示連接已經完全結束，不再存在。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>這些狀態描述了 TCP 連接的生命週期中的不同階段。關於 TCP 狀態的監控，通常會關注一些與之相關的指標，例如 &lt;code>node_sockstat_TCP_alloc&lt;/code>（如果有的話）以及 &lt;code>netstat&lt;/code> 命令的輸出。這些指標和工具可以提供關於 TCP 連接數量、狀態轉換等信息，進而幫助進行系統監控和調試。&lt;/p></description></item><item><title>MQTT 初學指南</title><link>https://chiehting.com/posts/mqtt-beginners-guide/</link><pubDate>Fri, 24 Nov 2023 16:20:49 +0800</pubDate><guid>https://chiehting.com/posts/mqtt-beginners-guide/</guid><description>
&lt;p>本篇文章說明了 MQTT 的相關知識，包括起源、版本、資安, etc。MQTT 用於 IoT 訊息傳遞的服務，由 client 跟 brokers 的架構組成。由於用於 IoT 設備，所以通常硬件的資源有限，MQTT 輕量且穩定的好處就很適合。&lt;/p>
&lt;h2 id="references">References&lt;/h2>
&lt;p>&lt;a href="http://www.steves-internet-guide.com/mqtt/">Beginners Guide To The MQTT Protocol&lt;/a>&lt;/p>
&lt;h2 id="mqtt">MQTT&lt;/h2>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>MQTT 是一個輕量且高效的訊息佇列遙測傳輸，常用於 IoT 系統。他是由 Andy Stanford-Clark (IBM) 和 Arlen Nipper 在 1999 年設計的，後來被 OASIS 在 2014 年標準化。&lt;/p>
&lt;p>MQTT 是讓兩的裝置可以透過 broker 進行交互溝通，例如 &amp;quot;智慧門鎖&amp;quot; 跟 &amp;quot;APP&amp;quot; 做訊息（開門、訪客, etc）的通知。&lt;/p>
&lt;p>目前 MQTT 的最新版本為 v5，是在 v3 的版本上做優化。但要使用 v5 版本必需要 broker 跟 client 都使用 v5 版本。所以目前主流的版本還是 v3.1.1。&lt;/p>
&lt;p>文章中也有列出一些常見的問題：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Question&lt;/th>
&lt;th>Answer&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>MQTT 可以不需要 broker 嗎？&lt;/td>
&lt;td>不行，必須要使用 brokers。因為 IoT 裝置上的限制。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>MQTT 使用的 Protocol 是什麼？&lt;/td>
&lt;td>MQTT 標準版本使用的是 TCP/IP&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>有可能從發布訊息中取得 client 的身份嗎？&lt;/td>
&lt;td>預設沒有這方面的資訊，除非在 topic or payload 中有配置。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>要如何找出已經 published topics？&lt;/td>
&lt;td>無法容易地做到，因為 MQTT 不要長久地保持 published topics。&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>訊息會被保存在 borker 上嗎？&lt;/td>
&lt;td>會暫時的保存在 broker 上，等訊息被發出後就會拋棄。&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="http://www.steves-internet-guide.com/mqtt/">Beginners Guide To The MQTT Protocol&lt;/a>&lt;/p>
&lt;h4 id="what-is-mqtt">What is MQTT?&lt;/h4>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">MQTT is a lightweight &lt;strong>publish/subscribe&lt;/strong> messaging protocol designed for M2M (machine to machine) telemetry in low bandwidth environments.&lt;/span>&lt;/p>
&lt;p>It was designed by Andy Stanford-Clark (IBM) and Arlen Nipper in 1999 for connecting Oil Pipeline telemetry systems over satellite.&lt;/p>
&lt;p>Although it started as a proprietary protocol it was released Royalty free in 2010 and became an OASIS standard in 2014.&lt;/p>
&lt;p>&lt;strong>MQTT&lt;/strong> stands for &lt;strong>MQ&lt;/strong> Telemetry Transport but previously was known as Message Queuing Telemetry Transport.&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">&lt;strong>MQTT&lt;/strong> is fast becoming one of the main protocols for &lt;strong>IOT&lt;/strong> (internet of things) deployments.&lt;/span>&lt;/p>
&lt;h4 id="mqtt-versions">MQTT Versions&lt;/h4>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">The original &lt;strong>MQTT&lt;/strong> which was designed in 1999 and has been in use for many years and is designed for &lt;strong>TCP/IP networks&lt;/strong>.&lt;/span>&lt;/p>
&lt;p>MQTTv3.1.1 is version in common use.&lt;/p>
&lt;p>There is very little difference between v3.10 and 3.1.1. Here is a &lt;a href="https://github.com/mqtt/mqtt.github.io/wiki/Differences-between-3.1.0-and-3.1.1">Github page&lt;/a> detailing the main differences&lt;/p>
&lt;p>Here is the actual Specification &lt;a href="http://public.dhe.ibm.com/software/dw/webservices/ws-mqtt/MQTT_V3.1_Protocol_Specific.pdf">MQTT V3.1&lt;/a> and here is a more detailed overview of the &lt;a href="http://www.steves-internet-guide.com/mqtt-protocol-messages-overview/">MQTT protocol packet structure,.&lt;/a>&lt;/p>
&lt;p>The latest MQTT version(v5) ,&lt;a href="https://www.oasis-open.org/news/announcements/mqtt-v5-0-is-an-approved-oasis-committee-specification">has now been approved&lt;/a> (Jan 2018).. You can download the specification &lt;a href="http://docs.oasis-open.org/mqtt/mqtt/v5.0/cs01/mqtt-v5.0-cs01.pdf">here&lt;/a>.&lt;/p>
&lt;h4 id="mqtt-sn-notes">&lt;strong>MQTT-SN Notes&lt;/strong>&lt;/h4>
&lt;p>&lt;strong>MQTT-SN&lt;/strong> which was specified in around 2013, and designed to work over &lt;strong>UDP&lt;/strong>, ZigBee and other transports.&lt;/p>
&lt;p>&lt;strong>MQTT-SN&lt;/strong> doesn’t currently appear to be very popular. and the specification hasn’t changed for several years, but I expect that to change as &lt;strong>IOT&lt;/strong> deployments start. See &lt;a href="http://www.steves-internet-guide.com/mqtt-sn/">MQTT-SN working Notes&lt;/a>. for more details on MQTT-SN.&lt;/p>
&lt;h4 id="mqtt-clients">MQTT Clients&lt;/h4>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">Because MQTT clients don’t have addresses like email addresses, phone numbers etc. you don’t need to assign addresses to clients like you do with most messaging systems.&lt;/span>&lt;/p>
&lt;h4 id="mqtt-brokers-or-servers">MQTT Brokers or Servers&lt;/h4>
&lt;p>&lt;strong>Note:&lt;/strong> The original term was &lt;strong>broker&lt;/strong> but it has now been standardized as &lt;strong>Server&lt;/strong>. You will see Both terms used.&lt;/p>
&lt;p>There are many MQTT brokers available that you can use for testing and for real applications.&lt;/p>
&lt;p>There are free self hosted brokers , the most popular being &lt;a href="https://mosquitto.org/">Mosquitto&lt;/a> and commercial ones like &lt;a href="http://www.hivemq.com/">HiveMQ.&lt;/a>&lt;/p>
&lt;p>There are many MQTT brokers available that you can use for testing and for real applications.&lt;/p>
&lt;h4 id="mqtt-over-websockets">MQTT Over WebSockets&lt;/h4>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">&lt;strong>Websockets&lt;/strong> allows you to receive MQTT data directly into a web browser.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">This is important as the web browser may become the DE-facto interface for displaying MQTT data.&lt;/span>&lt;/p>
&lt;p>MQTT websocket support for web browsers is provided by the &lt;strong>Javascript MQTT Client&lt;/strong>.&lt;/p>
&lt;p>See –&lt;a href="http://www.steves-internet-guide.com/mqtt-websockets/">Using MQTT Over WebSockets&lt;/a>&lt;/p>
&lt;h4 id="mqtt-security">MQTT Security&lt;/h4>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">MQTT supports various authentications and data security mechanisms.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">It is important to note that these security mechanisms are configured on the MQTT broker, and it is up to the client to comply with the mechanisms in place.&lt;/span>&lt;/p>
&lt;p>See &lt;a href="http://www.steves-internet-guide.com/mqtt-security-mechanisms/">An Introduction to MQTT security mechanisms&lt;/a>&lt;/p>
&lt;h4 id="common-questions">Common Questions&lt;/h4>
&lt;p>If you are familiar with the web and email then you will probably find, as I did, that MQTT is very different. These are some of the questions I had, and saw on other sites and forums that may clear things up a little.&lt;/p>
&lt;h5 id="q-what-port-does-mqtt-normally-use">Q, What Port does MQTT Normally Use?&lt;/h5>
&lt;p>&lt;strong>A-&lt;/strong> The standard port is 1883.&lt;/p>
&lt;h5 id="q--can-you-use-mqtt-without-a-broker">Q- Can you use MQTT without a broker?&lt;/h5>
&lt;p>A- No See &lt;a href="http://www.steves-internet-guide.com/mqtt-works/">How MQTT works&lt;/a>&lt;/p>
&lt;h5 id="q--what-protocol-does-mqtt-use">Q- What Protocol does MQTT use?&lt;/h5>
&lt;p>A- The standard version uses &lt;strong>TCP/IP&lt;/strong>.&lt;/p>
&lt;h5 id="q-can-multiple-clients-publish-to-the-same-topic">Q, Can multiple clients publish to the same topic?&lt;/h5>
&lt;p>&lt;strong>A-&lt;/strong> Yes&lt;/p>
&lt;h5 id="q--is-possible-to-know-the-identity-of-the-client-that-published-a-message">Q- Is possible to know the identity of the client that published a message?&lt;/h5>
&lt;p>&lt;strong>A-&lt;/strong> No not unless the client includes that information in the topic or payload.&lt;/p>
&lt;h5 id="q--what-happens-to-messages-that-get-published-to-topics-that-no-one-subscribes-to">Q- What happens to messages that get published to topics that no one subscribes to?&lt;/h5>
&lt;p>&lt;strong>A-&lt;/strong> They are discarded by the broker.&lt;/p>
&lt;h5 id="q-how-can-i-find-out-what-topics-have-been-published">Q-How can I find out what topics have been published?&lt;/h5>
&lt;p>&lt;strong>A-&lt;/strong> You can’t do this easily as the broker doesn’t seem to keep a list of published topics as they aren’t permanent.&lt;/p>
&lt;h5 id="q--can-i-subscribe-to-a-topic-that-no-one-is-publishing-to">Q- Can I subscribe to a topic that no one is publishing to?&lt;/h5>
&lt;p>&lt;strong>A-&lt;/strong> Yes&lt;/p>
&lt;h5 id="q--are-messages-stored-on-the-broker">Q- Are messages stored on the broker?&lt;/h5>
&lt;p>A- &lt;strong>Yes&lt;/strong> but only temporarily. Once they have been sent to all subscribers they are then discarded. But see next question.&lt;/p>
&lt;h5 id="q--what-are-retained-messages">Q- What are retained messages?&lt;/h5>
&lt;p>&lt;strong>A-&lt;/strong> When you publish a message you can have the broker store the last published message. This message will be the first message that new subscribers see when they subscribe to that topic. &lt;strong>MQTT only retains 1 message.&lt;/strong> See &lt;a href="http://www.steves-internet-guide.com/mqtt-retained-messages-example/">Understanding Retained Messages&lt;/a>&lt;/p>
&lt;h4 id="other-mqtt-tutorials">Other MQTT Tutorials&lt;/h4>
&lt;p>Here is a list of &lt;a href="http://www.steves-internet-guide.com/category/mqtt/">all MQTT tutorials&lt;/a> on this site&lt;/p>
&lt;h4 id="mqtt-vs-http">MQTT vs HTTP&lt;/h4>
&lt;p>If you are wondering if MQTT is the best choice for your project then here are a collection of articles comparing MQTT with HTTP.&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.linkedin.com/pulse/internet-things-http-vs-websockets-mqtt-ronak-singh-cspo/">Internet of Things: Battle of The Protocols (HTTP vs. Websockets vs. MQTT)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/mqtt-buddy/mqtt-vs-http-which-one-is-the-best-for-iot-c868169b3105">MQTT vs. HTTP: which one is the best for IoT?&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://flespi.com/blog/http-vs-mqtt-performance-tests">HTTP vs MQTT performance tests&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://iotdunia.com/mqtt-and-http/">MQTT and HTTP : Comparison between two IoT Protocols&lt;/a> – contains errors but chart useful&lt;/li>
&lt;/ul></description></item><item><title>什麼是 MQTT</title><link>https://chiehting.com/posts/mqtt-org/</link><pubDate>Fri, 24 Nov 2023 15:34:42 +0800</pubDate><guid>https://chiehting.com/posts/mqtt-org/</guid><description>
&lt;p>MQTT 是物聯網 (IoT) 的 OASIS 標準訊息傳遞協定。&lt;/p>
&lt;p>OASIS（Organization Advancement Structured Information Standards / 結構化資訊標準促進組織 ）：全球的非營利組織，主要在發展及整合物聯網、網路服務等領域的相關標準。&lt;/p>
&lt;h2 id="references">References&lt;/h2>
&lt;p>&lt;a href="https://mqtt.org/">https://mqtt.org/&lt;/a>&lt;/p>
&lt;h2 id="mqtt">MQTT&lt;/h2>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>MQTT 是設計給 IoT 作為訊息傳遞來使用的協定。通常 IoT 硬件通常會有資源上的限制，所以 MQTT 的特色就是輕量且高效。
下面列出了 MQTT 的特色：&lt;/p>
&lt;ol>
&lt;li>Lightweight and Efficient（輕量且高效）&lt;/li>
&lt;li>Bi-directional Communications（裝置跟服務可雙向溝通）&lt;/li>
&lt;li>Scale to Millions of Things（可平行擴充）&lt;/li>
&lt;li>Reliable Message Delivery（可靠的訊息傳遞）&lt;/li>
&lt;li>Support for Unreliable Networks（適用於網路不穩定的環境之下）&lt;/li>
&lt;li>Security Enabled （安全性，可使用 TLS 加密訊息）&lt;/li>
&lt;/ol>
&lt;h4 id="下圖為-mqtt-org-上的-publish--subscribe-架構也繪出一份-flowchart-供紀錄">下圖為 MQTT org 上的 Publish / Subscribe 架構，也繪出一份 flowchart 供紀錄。&lt;/h4>
&lt;p>&lt;em>MQTT pub/sub Flowchart&lt;/em>&lt;/p>
&lt;pre class="mermaid">flowchart LR
mc3[MQTT Client&lt;br>Subscriber: Mobile device] --"Subscribe to topic:temperature"--> mb
mc2[MQTT Client&lt;br>Subscriber: Backend device] --"Subscribe to topic:temperature"--> mb
mb --"Publish: 24°C"--> mc2
mb --"Publish: 24°C"--> mc3
subgraph MQtt Broker
mb[MQTT Broker]
end
subgraph MQTT Client
mc1[Publisher: Temperature Sensor] --"
Publish to topic: temperature&lt;br>Publish: 24°C"--> mb
end&lt;/pre>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://mqtt.org/">mqtt org&lt;/a>&lt;/p>
&lt;h4 id="mqtt-the-standard-for-iot-messaging">MQTT: The Standard for IoT Messaging&lt;/h4>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">MQTT is an OASIS standard messaging protocol for the Internet of Things (IoT).&lt;/span> It is designed as an extremely lightweight publish/subscribe messaging transport that is ideal for connecting remote devices with a small code footprint and minimal network bandwidth. MQTT today is used in a wide variety of industries, such as automotive, manufacturing, telecommunications, oil and gas, etc.&lt;/p>
&lt;h4 id="why-mqtt">Why MQTT?&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>&lt;em>Lightweight and Efficient&lt;/em>&lt;/p>
&lt;p>MQTT clients are very small, require minimal resources so can be used on small microcontrollers. MQTT message headers are small to optimize network bandwidth.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;em>Bi-directional Communications&lt;/em>&lt;/p>
&lt;p>MQTT allows for messaging between device to cloud and cloud to device. This makes for easy broadcasting messages to groups of things.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;em>Scale to Millions of Things&lt;/em>&lt;/p>
&lt;p>MQTT can scale to connect with millions of IoT devices.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;em>Reliable Message Delivery&lt;/em>&lt;/p>
&lt;p>Reliability of message delivery is important for many IoT use cases. This is why MQTT has 3 defined quality of service levels: 0 - at most once, 1- at least once, 2 - exactly once&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;em>Support for Unreliable Networks&lt;/em>&lt;/p>
&lt;p>Many IoT devices connect over unreliable cellular networks. MQTT’s support for persistent sessions reduces the time to reconnect the client with the broker.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;em>Security Enabled&lt;/em>&lt;/p>
&lt;p>MQTT makes it easy to encrypt messages using TLS and authenticate clients using modern authentication protocols, such as OAuth.&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="mqtt-publish--subscribe-architecture">MQTT Publish / Subscribe Architecture&lt;/h4>
&lt;p>&lt;em>MQTT publish subscribe image&lt;/em>&lt;/p>
&lt;p>&lt;img src="https://mqtt.org/assets/img/mqtt-publish-subscribe.png" alt="參考 MQTT org">&lt;/p>
&lt;h4 id="is-mqtt-a-standard">Is MQTT a standard?&lt;/h4>
&lt;p>v5.0 and v3.1.1 are now OASIS standards (v3.1.1 has also been ratified by ISO).&lt;/p></description></item><item><title>Apache Jmeter</title><link>https://chiehting.com/posts/testing-apache-jmeter/</link><pubDate>Thu, 16 Nov 2023 10:30:51 +0800</pubDate><guid>https://chiehting.com/posts/testing-apache-jmeter/</guid><description>
&lt;p>這篇文章主要在紀錄 Apache Jmeter 的使用筆記。&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>理解 Apache Jmeter 壓工具，研究其中的的元件&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>Apache Jmeter 是 Apache 研發的一個壓測軟體(在講廢話)，是使用 Java([[java-install]]) 編譯好的應用程式。&lt;/p>
&lt;h4 id="install">Install&lt;/h4>
&lt;p>當前版本為 Jmeter 5.6.3 的版本，下面操作皆是以這個版本為基礎。&lt;/p>
&lt;h5 id="required">Required&lt;/h5>
&lt;ol>
&lt;li>由於是 Java 編譯，所以需要先配置好 Jar([[java-install#Jar]]) 環境。&lt;/li>
&lt;/ol>
&lt;h5 id="download-jmeter">Download Jmeter&lt;/h5>
&lt;p>配置好環境後下載即可使用，下面為下載命令。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">curl -LO https://dlcdn.apache.org/jmeter/binaries/apache-jmeter-5.6.3.tgz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">tar zxf apache-jmeter-5.6.3.tgz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>插件安裝：&lt;/p>
&lt;ul>
&lt;li>[[jmeter-add-the-mqtt-plugin]]&lt;/li>
&lt;/ul>
&lt;h4 id="how-to-use">How to use&lt;/h4>
&lt;h5 id="編寫腳本">編寫腳本&lt;/h5>
&lt;p>Jmeter 有 IDE 可以使用，開啟 &lt;code>./bin/ApacheJMeter.jar&lt;/code> 就可以看到介面，可以透過 IDE 配置壓測流程。
官方也有提供一些範例在 &lt;code>./bin/examples&lt;/code> 底下，以及樣板 &lt;code>./bin/templates&lt;/code>，可以參考。&lt;/p>
&lt;p>&lt;em>Thread Group&lt;/em> 中有個配置 &lt;em>Ramp-up period&lt;/em>，這欄位的目的在於在 N 秒內執行指定的 thread number。
設定的話 thread 會線性執行，由於線性起初的壓力不會過大，產出的報表也相對好看；如果沒設定的話 thread 會在同一時間放行，在壓測的開始會對服務造成滿大的壓力，適合搶票的情境。&lt;/p>
&lt;p>&lt;em>JSR223 Sampler&lt;/em> 是滿好用的元件之一，可以使用多種語言（groovy、javascript, etc...）來編輯。&lt;/p>
&lt;p>&lt;em>If Controller&lt;/em> 可以做流程的判別式，要注意選項 &lt;em>Interpret Condition as Variable Expression?&lt;/em>，用來解義變數的擴展語言。使用 true or false 的變數內容的話，建議是開啟。&lt;/p>
&lt;h5 id="壓測機器">壓測機器&lt;/h5>
&lt;p>提升 Ubuntu server 22.04 的主機效能，設定配置。&lt;/p>
&lt;p>增加 ulimit 的配置，使主機能使用的 &lt;em>open file&lt;/em>、&lt;em>process&lt;/em> 都加大。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">vim /etc/pam.d/common-session
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">session required pam_limits.so
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">vim /etc/security/limits.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">* soft nproc &lt;span class="m">64000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">* hard nproc &lt;span class="m">64000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">* soft nofile &lt;span class="m">64000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">* hard nofile &lt;span class="m">64000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">root soft nofile &lt;span class="m">64000&lt;/span> &lt;span class="c1"># option&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">root hard nofile &lt;span class="m">64000&lt;/span> &lt;span class="c1"># option&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>調整 kernel 的配置。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">vim /etc/sysctl.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">net.ipv4.ip_local_port_range&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;15000 61000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">net.ipv4.tcp_fin_timeout&lt;span class="o">=&lt;/span>&lt;span class="m">30&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">net.ipv4.tcp_tw_recycle&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">net.ipv4.tcp_tw_reuse&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="c1"># 添加或修改以下参数，提高 TCP 缓冲区大小&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">net.core.rmem_max &lt;span class="o">=&lt;/span> &lt;span class="m">16777216&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">net.core.wmem_max &lt;span class="o">=&lt;/span> &lt;span class="m">16777216&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">net.ipv4.tcp_rmem &lt;span class="o">=&lt;/span> &lt;span class="m">4096&lt;/span> &lt;span class="m">87380&lt;/span> &lt;span class="m">16777216&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">net.ipv4.tcp_wmem &lt;span class="o">=&lt;/span> &lt;span class="m">4096&lt;/span> &lt;span class="m">87380&lt;/span> &lt;span class="m">16777216&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="c1"># 可開啟檔案數量&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">fs.file-max &lt;span class="o">=&lt;/span> &lt;span class="m">100000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">vm.swappiness&lt;span class="o">=&lt;/span>&lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>調整 &lt;em>transparent huge page&lt;/em> 策略。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">vim /etc/default/grub
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">GRUB_CMDLINE_LINUX&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;transparent_hugepage=never&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="壓力測試">壓力測試&lt;/h5>
&lt;p>可以直接使用 IDE 或 Command 來執行壓測，下面為使用 Command 的方式做執行。&lt;/p>
&lt;p>腳本編寫完成後保存成 jmx 檔案，jmeter 會使用腳本去執行壓測流程。壓測完成後會產生 jtl 檔案為壓測結果，dashboard 為 htlm 的報告書。&lt;/p>
&lt;p>其中有配置 &lt;em>JVM_ARGS&lt;/em> 參數，開大 &lt;em>-Xms&lt;/em>、&lt;em>-Xmx&lt;/em> 為記憶體可使用量。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">JVM_ARGS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;-Dnashorn.args=--no-deprecation-warning -Xms3g -Xmx3g&amp;#34;&lt;/span> apache-jmeter-5.6.3/bin/jmeter -n -t 20250430-v1.jmx -l jmeter-result.jtl -e -o dashboard
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="報告">報告&lt;/h5></description></item><item><title>比較專案管理系統</title><link>https://chiehting.com/posts/compare-project-management/</link><pubDate>Tue, 12 Sep 2023 10:00:34 +0800</pubDate><guid>https://chiehting.com/posts/compare-project-management/</guid><description>
&lt;p>本篇目標再評估三套專案管理系統 &lt;code>Redmine&lt;/code>、&lt;code>OpenProject&lt;/code> 和 &lt;code>禪道&lt;/code>。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>名稱&lt;/th>
&lt;th>開源&lt;/th>
&lt;th>版本/維護時間&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;a href="https://www.redmine.org/">Redmine&lt;/a>&lt;/td>
&lt;td>&lt;a href="https://github.com/redmine/redmine">Redmine GitHub&lt;/a>&lt;/td>
&lt;td>5.0.5/20230305&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;a href="https://www.openproject.org/">OpenProejct&lt;/a>&lt;/td>
&lt;td>&lt;a href="https://github.com/opf/openproject">OpenProject GitHub&lt;/a>&lt;/td>
&lt;td>13.0.1/20230829&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;a href="https://www.zentao.net">禪道&lt;/a> [[what-is-zentao]]&lt;/td>
&lt;td>&lt;a href="https://github.com/easysoft/zentaopms">禪道 GitHub&lt;/a>&lt;/td>
&lt;td>18.5/20230715&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="總結">總結&lt;/h3>
&lt;ul>
&lt;li>禪道原生就有豐富的功能，如果起初的專案管理流程有明確的定義，且需有功能豐富的專案管理系統，可以優先考慮；若是只是簡單的任務管理，則會太多用不到之功能，介面複雜增加學習成本。&lt;/li>
&lt;li>OpenProject 原生的含有基本功能，且原生有結合敏捷開發。有著社群的插件支持，未來也可隨著需求做功能擴展。介面使用起來有點像 Asana。&lt;/li>
&lt;li>Redmine 為老牌的專案管理工具已經是個穩定的工具，且簡單上手較快。有社群的插件支持，未來也可隨著需求做功能擴展。外觀生硬醜。&lt;/li>
&lt;/ul>
&lt;h3 id="特點比較">特點比較&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>特點&lt;/th>
&lt;th>禪道&lt;/th>
&lt;th>OpenProject&lt;/th>
&lt;th>Redmine&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>原生功能&lt;/td>
&lt;td>較多&lt;/td>
&lt;td>一般&lt;/td>
&lt;td>一般&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>使用介面&lt;/td>
&lt;td>複雜&lt;/td>
&lt;td>一般&lt;/td>
&lt;td>醜&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>使用難易度&lt;/td>
&lt;td>偏高&lt;/td>
&lt;td>適中&lt;/td>
&lt;td>適中&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>流程整合度&lt;/td>
&lt;td>高&lt;/td>
&lt;td>高&lt;/td>
&lt;td>高&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>插件數量&lt;/td>
&lt;td>中等&lt;/td>
&lt;td>多&lt;/td>
&lt;td>多&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>支持社群&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>開發程式&lt;/td>
&lt;td>PHP&lt;/td>
&lt;td>Ruby on Rails&lt;/td>
&lt;td>Ruby on Rails&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>多語系&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>文檔管理&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>時間追蹤&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>圖表和報告&lt;/td>
&lt;td>一般&lt;/td>
&lt;td>較多&lt;/td>
&lt;td>一般&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>整合性&lt;/td>
&lt;td>高(原生)&lt;/td>
&lt;td>高(插件)&lt;/td>
&lt;td>高(插件)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>支持 Scrum&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是(插件)&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>插件&lt;/td>
&lt;td>較少&lt;/td>
&lt;td>較多&lt;/td>
&lt;td>較多(需注意插件的相容性)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item><item><title>Managing the lifecycle of the objects on AWS S3</title><link>https://chiehting.com/posts/aws-s3-object-lifecycle-on-bucket/</link><pubDate>Mon, 11 Sep 2023 16:35:02 +0800</pubDate><guid>https://chiehting.com/posts/aws-s3-object-lifecycle-on-bucket/</guid><description>
&lt;p>如何管理 S3 上的物件生命週期？&lt;/p>
&lt;p>在做 S3 物件的管理時，若使用 HTTP request 做操作，會造成成本增加。所以若是物件有&lt;strong>轉換&lt;/strong>或是&lt;strong>過期&lt;/strong>的操作時，就可以考慮使用 S3 生命週期來做管理。&lt;/p>
&lt;h3 id="managing-your-storage-lifecycle">Managing your storage lifecycle&lt;/h3>
&lt;p>為管理您的物件，使其整個生命週期以更符合成本效益的方式儲存，請配置 &lt;em>Amazon S3 生命週期&lt;/em>。_S3 生命週期組態_是一組定義 Amazon S3 動作的規則，適用於一組物件。有兩種類型的動作：&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>轉換動作&lt;/strong> – 定義物件何時轉換成另一個儲存類別。例如，您可以選擇在建立物件後的 30 天，將物件轉換為 S3 標準 – IA 儲存類別，或者在建立物件一年後，將物件封存到 S3 Glacier Flexible Retrieval 儲存類別。如需詳細資訊，請參閱 &lt;a href="https://docs.aws.amazon.com/zh_tw/AmazonS3/latest/userguide/storage-class-intro.html">使用 Amazon S3 儲存體方案&lt;/a>。&lt;/p>
&lt;p>這些是與生命週期轉換請求相關聯的成本。如需定價資訊，請參閱 &lt;a href="https://aws.amazon.com/s3/pricing/">Amazon S3 定價&lt;/a>。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>過期動作&lt;/strong> – 這些動作會定義物件何時過期。Amazon S3 會為您刪除已過期的物件。&lt;/p>
&lt;p>生命週期過期成本，取決於您選擇物件的過期時間。如需詳細資訊，請參閱 &lt;a href="https://docs.aws.amazon.com/zh_tw/AmazonS3/latest/userguide/lifecycle-expire-general-considerations.html">即將到期的物件&lt;/a>。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>為已妥善定義生命週期的物件，定義 S3 生命週期組態規則。例如：&lt;/p>
&lt;ul>
&lt;li>如果您將定期日誌上傳到儲存貯體，您的應用程式可能需要使用它們一週或一個月。之後，您可能會想刪除它們。&lt;/li>
&lt;li>某些文件在一段有限的期間內會經常受到存取。而在該期間之後，存取它們的頻率很低。在某些時候，您可能不需要即時存取它們，但您的組織或法規可能要求您將其封存一段特定時間。之後，您可以刪除它們。&lt;/li>
&lt;li>您可能會將某些類型的資料上傳到 Amazon S3，主要為目的檔案用。例如，您可以使用它來封存數位媒體、財務及醫療保健記錄、原始基因序列資料、長期資料庫備份，以及為遵守法規而所必須保留的資料。&lt;/li>
&lt;/ul>
&lt;p>使用 S3 生命週期組態規則，您可以指示 Amazon S3 將物件轉換為較便宜的儲存體類別、封存或刪除物件。&lt;/p>
&lt;h3 id="指定篩選條件">指定篩選條件&lt;/h3>
&lt;p>每個 S3 生命週期規則都包含篩選條件，您可用於找出儲存貯體中將套用 S3 生命週期規則的一組物件。下列 S3 生命週期組態說明如何指定篩選條件的範例。&lt;/p>
&lt;ul>
&lt;li>
&lt;p>在此 S3 生命週期組態規則中，https://docs.aws.amazon.com/zh_tw/AmazonS3/latest/userguide/object-keys.html&lt;/p>
&lt;ul>
&lt;li>篩選條件指定了一個金鑰字首 (key prefix) (&lt;code>tax/&lt;/code>)。因此，規則將會套用至其金鑰名稱字首為 &lt;code>tax/&lt;/code> 的物件，例如 &lt;code>tax/doc1.txt&lt;/code> 與 &lt;code>tax/doc2.txt&lt;/code>。&lt;/li>
&lt;li>若篩選條件指定了一個金鑰字首&lt;code>1d&lt;/code>，&lt;strong>不會&lt;/strong>套用規則至物件 &lt;code>1d-doc1.txt&lt;/code>。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>您可以僅根據標籤來篩選物件。&lt;/p>
&lt;/li>
&lt;/ul></description></item><item><title>使用 Raspberry Pi 4 Model B 做反向代理伺服器</title><link>https://chiehting.com/posts/raspberry-pi-4b-setting-reverse-proxy/</link><pubDate>Fri, 08 Sep 2023 17:35:51 +0800</pubDate><guid>https://chiehting.com/posts/raspberry-pi-4b-setting-reverse-proxy/</guid><description>
&lt;p>目標是要使用硬體 Raspberry Pi 4 Model B - 8G 來做反向代理伺服器，並且服務需要可以轉發 TCP 與 UDP。此方案適用於少人數的反向代理伺服器，且成本較低。&lt;/p>
&lt;h3 id="初始化">初始化&lt;/h3>
&lt;p>由於是反向代理伺服器，所以需要 IP 固定。硬體為 Raspberry Pi 4 Model B，安裝了 OS ubuntu 22.04，設定方式如下。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">apt -y update &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> apt upgrade &lt;span class="c1"># 主機套件更新&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">ip a &lt;span class="c1"># 確認網路卡為 eth0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">vim /etc/netplan/50-cloud-init.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">network&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ethernets&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">eth0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">dhcp4&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">no&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">addresses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="m">192.168.1.100&lt;/span>&lt;span class="l">/24 &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Set your desired static IP address and subnet mask&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">routes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0.0.0.0&lt;/span>&lt;span class="l">/0 &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Define the default route&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">via&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">192.168.1.1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Set your gateway/router IP address&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">optional&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">netplan apply &lt;span class="c1"># 重新啟動服務&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="issue">issue&lt;/h3>
&lt;p>發現一個現象，當 DHCP 和靜態 IP 同時存在時的網路行為問題。&lt;/p>
&lt;p>透過設定 IP address，可以發送非本地的 IP。當設定 dhcp4: yes 且配置了 addresses 時，會是 dhcp 還是 static IP？測試下來機器的 IP 會是 dhcp 所配的 IP；發出去的封包會是以 addresses 所設定，且這現象無法跨網段.&lt;/p>
&lt;p>從上面的範例為案例，紀錄測試的結果，如下:&lt;/p>
&lt;ol>
&lt;li>dhcp 使用的網段是 192.168.1.0/24 被分配到的 IP 是 192.168.1.195，addresses 設定的是 192.168.1.100 的話，發出去的封包來源 IP 會是 192.168.1.100.&lt;/li>
&lt;li>dhcp 使用的網段是 192.168.1.0/24 被分配到的 IP 是 192.168.1.195，addresses 設定的是 192.168.2.100 的話，發出去的封包來源 IP 會是 192.168.1.195.&lt;/li>
&lt;/ol>
&lt;h4 id="分析">分析&lt;/h4>
&lt;p>同時啟用 DHCP 和靜態 IP 時，系統獲取 DHCP 的 IP 但發送封包的來源 IP 選擇取決於目的地與靜態 IP 的網段關係，是符合 Linux 核心處理多 IP 介面和來源 IP 選擇規則的&lt;strong>可能行為&lt;/strong>。&lt;/p>
&lt;ol>
&lt;li>&lt;strong>一個介面可以有多個 IP：&lt;/strong> Linux 允許一個網路介面綁定多個 IP 位址，即使它們屬於不同的子網路。&lt;/li>
&lt;li>&lt;strong>DHCP 的作用：&lt;/strong> 當 &lt;code>dhcp4: yes&lt;/code> 時，DHCP 客戶端會向伺服器請求 IP 位址、子網路遮罩、預設閘道、DNS 伺服器等資訊，並將這些設定應用到介面上。通常，DHCP 分配的 IP 會被視為該介面的主要 IP。&lt;/li>
&lt;li>&lt;strong>靜態 &lt;code>addresses&lt;/code> 的作用：&lt;/strong> 當同時設定 &lt;code>addresses&lt;/code> 時，這些 IP 位址會被添加到該介面上，成為介面的次要 IP。&lt;/li>
&lt;li>&lt;strong>來源 IP 的選擇 (Source Address Selection)：&lt;/strong> 當系統要發送一個網路封包時，如果介面有多個 IP，Linux 核心會根據一套規則來決定使用哪個 IP 作為封包的來源 IP。這些規則考慮了：
&lt;ul>
&lt;li>&lt;strong>目的地 IP：&lt;/strong> 如果目的地 IP 在介面某個 IP 的子網路內，系統會傾向於使用該子網路的 IP 作為來源。&lt;/li>
&lt;li>&lt;strong>路由表：&lt;/strong> 封包會根據路由表決定從哪個介面發出，來源 IP 通常會選自該出站介面上的 IP。&lt;/li>
&lt;li>&lt;strong>IP 範圍和作用域 (Scope)：&lt;/strong> 例如，本地環回地址不會用於外部通訊。&lt;/li>
&lt;li>&lt;strong>偏好設定或策略路由 (Policy Routing)：&lt;/strong> 雖然在這個簡單的 &lt;code>netplan&lt;/code> 設定中可能不明顯，但在複雜的設定中可以更精確地控制來源 IP。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="反向代理伺服器">反向代理伺服器&lt;/h3>
&lt;h4 id="nginx">Nginx&lt;/h4>
&lt;p>結果: 成功代理，upstream 收到的都是 reverse proxy 的 IP&lt;/p>
&lt;p>官方演示 &lt;a href="https://docs.nginx.com/nginx/admin-guide/load-balancer/tcp-udp-load-balancer/"># TCP and UDP Load Balancing&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">apt install nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /etc/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">cp -rf nginx.conf nginx.conf.origin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">cat &amp;gt;&amp;gt; sites-available/default &lt;span class="s">&amp;lt;&amp;lt; EOF
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="s">stream {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="s"> upstream backend {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="s"># hash $remote_addr consistent;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="s"> server 192.168.1.133:80 weight=5;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="s"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="s">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="s"> upstream dns {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="s"># hash $remote_addr consistent;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="s"> server 192.168.1.133:53;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="s"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="s">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="s"> server {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="s"> listen 80;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="s"> proxy_pass backend;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="s"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="s">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="s"> server {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="s"> listen 53 udp reuseport;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="s"> proxy_pass dns;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="s"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="s">}
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="haproxy">HAProxy&lt;/h4>
&lt;p>結果: 失敗代理，不支援 UDP.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">apt install haproxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">vim /etc/haproxy/haproxy.cfg
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="l">frontend external_tcp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">bind *:80&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">mode tcp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">default_backend internal_tcp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">backend internal_tcp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">mode tcp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">server webserver1 192.168.1.133:80&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">service haproxy restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>比較 GitLab 和 Gitea</title><link>https://chiehting.com/posts/compare-git-repository/</link><pubDate>Wed, 06 Sep 2023 16:19:12 +0800</pubDate><guid>https://chiehting.com/posts/compare-git-repository/</guid><description>
&lt;p>本篇目標再評估兩套 source code management &lt;a href="https://about.gitlab.com/">GitLab&lt;/a> 和 &lt;a href="https://docs.gitea.com/">Gitea&lt;/a>.&lt;/p>
&lt;p>評估的切入方向：&lt;/p>
&lt;ol>
&lt;li>團隊規模： 小型團隊或大型團隊。個人定義以 10 人為分水嶺&lt;/li>
&lt;li>功能需求：CICD、監控、系統整合&lt;/li>
&lt;li>成本和預算：官方建議的主機規格差一個等級&lt;/li>
&lt;li>維護成本：運維時需要付出的人力成本，例如系統配置、系統升級&lt;/li>
&lt;li>支援文件：運維時的文件支援程度&lt;/li>
&lt;/ol>
&lt;p>以下是 GitLab 和 Gitea 的比較表格：&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>特性&lt;/th>
&lt;th>GitLab&lt;/th>
&lt;th>Gitea&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>開源性&lt;/td>
&lt;td>有 CE 版本，EE 版本&lt;/td>
&lt;td>完全開源，無商業授權&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>社群和生態系統&lt;/td>
&lt;td>龐大的用戶社群，支援社群插件&lt;/td>
&lt;td>相對較小的社群，有一些插件&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>使用人數與情境&lt;/td>
&lt;td>大型團隊、適合需求複雜的功能和集成&lt;/td>
&lt;td>小型團隊、個人開發者、輕量級解決方案&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2FA&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>儲存庫管理&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>自動化CI/CD&lt;/td>
&lt;td>是&lt;/td>
&lt;td>部分支援，需要其他工具&lt;br>&lt;a href="https://docs.gitea.com/usage/actions/overview">gitea cicd&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>問題跟蹤&lt;/td>
&lt;td>是&lt;/td>
&lt;td>部分支援&lt;br>&lt;a href="https://docs.gitea.com/next/installation/comparison#issue-tracker">gitea issue tracker&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>合併請求&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>代碼審查&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>通知和集成&lt;/td>
&lt;td>多種通知方式和集成選項&lt;/td>
&lt;td>基本通知和集成&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>安全性&lt;/td>
&lt;td>強調安全性並提供相關工具&lt;/td>
&lt;td>基本的安全性&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>自托管和SaaS&lt;/td>
&lt;td>是&lt;/td>
&lt;td>是&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>學習曲線&lt;/td>
&lt;td>較高&lt;/td>
&lt;td>較低&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>資源需求&lt;/td>
&lt;td>較高&lt;/td>
&lt;td>較低&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>官方建議規格&lt;/td>
&lt;td>4 CPU/4GB RAM/100GB Disk&lt;br>&lt;a href="https://docs.gitlab.com/ee/install/requirements.html">gitlab system requirements&lt;/a>&lt;/td>
&lt;td>2 CPU/2GB RAM/50GB Disk&lt;br>&lt;a href="https://docs.gitea.com/?_highlight=cpu#system-requirements">gitea system requirements&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>專案群組管理&lt;/td>
&lt;td>專案群組，可做階層&lt;/td>
&lt;td>組織管理，無階層&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>高可用性&lt;/td>
&lt;td>是&lt;br>&lt;a href="https://about.gitlab.com/solutions/geo/">gitlab geo&lt;/a>&lt;/td>
&lt;td>部分支援，需要自定義和配置&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>備份還原機制&lt;/td>
&lt;td>是&lt;br>&lt;a href="https://docs.gitlab.com/ee/administration/backup_restore/">gitlab backup and restore&lt;/a>&lt;/td>
&lt;td>是&lt;br>&lt;a href="https://docs.gitea.com/administration/backup-and-restore?_highlight=backup">gitea backup and restore&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>身份認證機制&lt;/td>
&lt;td>AD、LDAP、OAuth SSO、SAML SSO&lt;/td>
&lt;td>LDAP、OAuth SSO、SAML SSO&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="references">References&lt;/h4>
&lt;ol>
&lt;li>&lt;a href="https://zhuanlan.zhihu.com/p/486410391">自建Git 服務器：Gitea 與Gitlab 部署踩坑經歷與對比總結&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Adelson-Velsky and Landis tree</title><link>https://chiehting.com/posts/algorithm-adelson-velsky-and-landis-tree/</link><pubDate>Thu, 10 Aug 2023 17:51:21 +0800</pubDate><guid>https://chiehting.com/posts/algorithm-adelson-velsky-and-landis-tree/</guid><description>
&lt;p>這個來源探討了 AVL 樹如何解決二元搜尋樹可能退化為鏈表的問題。元搜尋樹在退化為鏈表後，其操作的時間複雜度會從 O(log n) 惡化為 O(n)，導致效率大幅下降。為了解決這個問題，AVL 樹透過「右旋」、「左旋」、「先右旋後左旋」和「先左旋後右旋」這四種旋轉操作，確保樹節點保持平衡，維持 AVL 樹的操作效率維持在 O(log n) 的級別。&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>這個網站有圖形化說明 &lt;a href="https://visualgo.net/zh/bst?slide=1">二元樹操作&lt;/a> 的流程.&lt;/p>
&lt;p>樹為一種資料結構, 而 &lt;em>二元樹(Binary Tree)&lt;/em> 為樹結構的一種, &lt;em>二元搜尋樹(Binary Search Tree)&lt;/em> 為二元樹的應用之一.&lt;/p>
&lt;p>二元搜尋樹在做了多次的新增刪除操作後, 容易有二元樹退化的現象, 造成效率變差.
當二元搜尋樹退化成鍊表, 就會失去搜尋效率, 由 O(log n) 變為 O(n).
而 AVL 樹則以旋轉的方式保持二元樹平衡, 讓操作保持在 O(log n) 的級別裡.&lt;/p>
&lt;p>AVL 樹必須滿足 &lt;em>二元樹&lt;/em> 跟 &lt;em>二元搜尋樹&lt;/em> 的條件, 可以讓數自動的保持平衡, 再不刻意維護樹的情況下, 這是一種很好的方式.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>樹結構（Tree Structure）：&lt;/p>
&lt;ul>
&lt;li>樹結構是一種層次性的資料結構, 由節點（Node）和邊（Edge）組成.&lt;/li>
&lt;li>每個節點可以有零個或多個子節點, 其中一個節點稱為根節點（Root Node）.&lt;/li>
&lt;li>節點之間的關係是非線性的, 可以有多個子節點.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>二元樹（Binary Tree）：&lt;/p>
&lt;ul>
&lt;li>二元樹是一種特殊的樹結構, 每個節點最多只能有兩個子節點, 分別稱為左子節點和右子節點.&lt;/li>
&lt;li>二元樹有許多不同的變體, 如完美二元樹(Perfect Binary Tree)、完全二元樹等(Complete Binary Tree)、完滿二元樹(Full Binary Tree)、平衡二元樹(Balanced Binary Tree).&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>二元樹搜尋（Binary Search Tree）是一種特殊的二元樹，其具有以下特性：&lt;/p>
&lt;ul>
&lt;li>左子樹中的所有節點的值小於父節點的值.&lt;/li>
&lt;li>右子樹中的所有節點的值大於父節點的值.&lt;/li>
&lt;li>左右子樹本身也是二元樹搜尋.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.hello-algo.com/chapter_tree/avl_tree/">AVL 樹&lt;/a>&lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">二叉搜索樹可能退化為鏈表。這種情況下，所有操作的時間復雜度將從 O(log n) 惡化為 O(n)。&lt;/span>&lt;/strong>&lt;/p>
&lt;p>&lt;strong>G. M. Adelson-Velsky 和 E. M. Landis 在其 1962 年發表的論文 &amp;quot;An algorithm for the organization of information&amp;quot; 中提出了「AVL 樹」。論文中詳細描述了一系列操作，確保在持續添加和刪除節點後，AVL 樹不會退化，從而使得各種操作的時間復雜度保持在 O(log n)級別。&lt;span style="background-color: #ffffcc; color: red">換句話說，在需要頻繁進行增刪查改操作的場景中，AVL 樹能始終保持高效的數據操作性能，具有很好的應用價值。&lt;/span>&lt;/strong>&lt;/p>
&lt;h4 id="avl-樹常見術語">AVL 樹常見術語&lt;/h4>
&lt;p>節點高度&lt;/p>
&lt;p>「節點高度」是指從該節點到最遠葉節點的距離，即所經過的「邊」的數量。需要特別注意的是，葉節點的高度為 0 ，而空節點的高度為 -1 。我們將創建兩個工具函數，分別用於獲取和更新節點的高度。&lt;/p>
&lt;p>節點平衡因子&lt;/p>
&lt;p>節點的「平衡因子 Balance Factor」定義為節點左子樹的高度減去右子樹的高度，同時規定空節點的平衡因子為 0 。我們同樣將獲取節點平衡因子的功能封裝成函數，方便後續使用。&lt;/p>
&lt;h4 id="avl-樹旋轉">AVL 樹旋轉&lt;/h4>
&lt;p>AVL 樹的特點在於「旋轉 Rotation」操作，它能夠在不影響二叉樹的中序遍歷序列的前提下，使失衡節點重新恢復平衡。換句話說，旋轉操作既能保持樹的「二叉搜索樹」屬性，也能使樹重新變為「平衡二叉樹」。&lt;/p>
&lt;p>&lt;strong>我們將平衡因子絕對值 &amp;gt; 1 的節點稱為「失衡節點」。根據節點失衡情況的不同，旋轉操作分為四種：右旋、左旋、先右旋後左旋、先左旋後右旋。&lt;/strong> 下面我們將詳細介紹這些旋轉操作。&lt;/p>
&lt;p>可以觀察到右旋和左旋操作在邏輯上是鏡像對稱的，它們分別解決的兩種失衡情況也是對稱的。基於對稱性，我們可以輕松地從右旋的代碼推導出左旋的代碼。具體地，只需將「右旋」代碼中的把所有的 &lt;code>left&lt;/code> 替換為 &lt;code>right&lt;/code> ，將所有的 &lt;code>right&lt;/code> 替換為 &lt;code>left&lt;/code> ，即可得到「左旋」代碼。&lt;/p>
&lt;p>代碼中，我們通過判斷失衡節點的平衡因子以及較高一側子節點的平衡因子的正負號，來確定失衡節點屬於上圖中的哪種情況。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>失衡節點的平衡因子&lt;/th>
&lt;th>子節點的平衡因子&lt;/th>
&lt;th>應采用的旋轉方法&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&amp;gt;1 （即左偏樹）&lt;/td>
&lt;td>≧0&lt;/td>
&lt;td>右旋&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&amp;gt;1 （即左偏樹）&lt;/td>
&lt;td>&amp;lt;0&lt;/td>
&lt;td>先左旋後右旋&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&amp;lt;−1 （即右偏樹）&lt;/td>
&lt;td>≦0&lt;/td>
&lt;td>左旋&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&amp;lt;−1 （即右偏樹）&lt;/td>
&lt;td>&amp;gt;0&lt;/td>
&lt;td>先右旋後左旋&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item><item><title>MacOS permissions for microphone and camera</title><link>https://chiehting.com/posts/macos-apps-dont-show-in-camera-and-microphone-privacy-security/</link><pubDate>Thu, 10 Aug 2023 17:51:21 +0800</pubDate><guid>https://chiehting.com/posts/macos-apps-dont-show-in-camera-and-microphone-privacy-security/</guid><description>
&lt;h1 id="macos-相機和麥克風權限設定問題與解決方案">macOS 相機和麥克風權限設定問題與解決方案&lt;/h1>
&lt;h2 id="references">References&lt;/h2>
&lt;p>&lt;a href="https://apple.stackexchange.com/questions/459474/macos-ventura-13-3-apps-dont-show-in-camera-and-microphone-privacy-security-s">MacOS Ventura 13.3 apps don't show in Camera and Microphone Privacy &amp;amp; Security settings&lt;/a>&lt;/p>
&lt;h2 id="問題背景">問題背景&lt;/h2>
&lt;ul>
&lt;li>&lt;strong>系統版本&lt;/strong>：MacOS Ventura 13.3&lt;/li>
&lt;li>&lt;strong>問題描述&lt;/strong>：應用程式無法在「系統設定 &amp;gt; 隱私權與安全性 &amp;gt; 麥克風和相機」中顯示&lt;/li>
&lt;li>&lt;strong>常見場景&lt;/strong>：使用 OpenCore Patcher 升級的舊 Mac 設備&lt;/li>
&lt;li>&lt;strong>根本原因&lt;/strong>：與 SIP（系統完整性保護）被關閉有關，特別是在使用 OpenCore 時必須關閉 SIP 的情況&lt;/li>
&lt;/ul>
&lt;h2 id="解決方案使用-tcc-資料庫">解決方案：使用 TCC 資料庫&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 備份 TCC 資料庫&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">cp ~/Library/Application&lt;span class="se">\ &lt;/span>Support/com.apple.TCC/TCC.db ~/TCC.db.bak
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="c1"># 1. 開啟 TCC 資料庫&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">sudo sqlite3 ~/Library/Application&lt;span class="se">\ &lt;/span>Support/com.apple.TCC/TCC.db
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="c1"># 2. 插入權限設定&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">INSERT into access &lt;span class="o">(&lt;/span>service, client, client_type, auth_value, auth_reason, auth_version&lt;span class="o">)&lt;/span> VALUES &lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;kTCCServiceCamera&amp;#39;&lt;/span>,&lt;span class="s1">&amp;#39;com.google.Chrome&amp;#39;&lt;/span>,0,2,0,1&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">INSERT into access &lt;span class="o">(&lt;/span>service, client, client_type, auth_value, auth_reason, auth_version&lt;span class="o">)&lt;/span> VALUES &lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;kTCCServiceMicrophone&amp;#39;&lt;/span>,&lt;span class="s1">&amp;#39;com.google.Chrome&amp;#39;&lt;/span>,0,2,0,1&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="c1"># 3. 退出資料庫&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">.quit
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>注意：將 &lt;code>&amp;lt;AppBundleURLname&amp;gt;&lt;/code> 替換為實際的應用程式 Bundle ID&lt;/p>
&lt;h2 id="獲取應用程式識別碼-appbundleurlname">獲取應用程式識別碼 AppBundleURLname&lt;/h2>
&lt;ol>
&lt;li>獲取應用程式識別碼 identifier：&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">codesign -dr - /Applications/應用程式.app
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="macos-sonoma-特別說明">macOS Sonoma 特別說明&lt;/h2>
&lt;h3 id="準備工作">準備工作&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 備份 TCC 資料庫&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">cp ~/Library/Application&lt;span class="se">\ &lt;/span>Support/com.apple.TCC/TCC.db ~/TCC.db.bak
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="重要提醒">重要提醒&lt;/h2>
&lt;ul>
&lt;li>在進行任何修改前，務必先備份 TCC.db 檔案&lt;/li>
&lt;li>確保正確獲取應用程式的 Bundle ID&lt;/li>
&lt;li>修改完成後可能需要重新啟動應用程式或系統&lt;/li>
&lt;/ul></description></item><item><title>DevOps 面試問題</title><link>https://chiehting.com/posts/devops-exam-for-interview/</link><pubDate>Thu, 10 Aug 2023 01:01:00 +0800</pubDate><guid>https://chiehting.com/posts/devops-exam-for-interview/</guid><description>
&lt;p>為什麼要做 DevOps 面試問題？旨在於發現自己的知識盲點與提升該領域的能力。
將不定期更新題目，提升面試或被面試的能力。&lt;/p>
&lt;h4 id="面試的流程構思">面試的流程構思&lt;/h4>
&lt;p>假設筆試做題時間 30 分鐘的話, 可以抽個 6 ~ 10 題（每題作答時間約 3~5 分鐘）。 個人習慣抽一個做不完的數量，一來可以評估程度；二來可以評估如何應對做不完的考題。&lt;/p>
&lt;p>主要目的是評估能力，做與沒做完並不是重點。
當答案與預期的不符時需釐清原因，有可能有其他觀點或者是自身有盲區。&lt;/p>
&lt;h4 id="筆試">筆試&lt;/h4>
&lt;ol>
&lt;li>
&lt;p>請簡述 DevOps 的核心原則和目標是什麼？&lt;/p>
&lt;p>DevOps 是增強開發(DEV)和運營(OPS)之間的協作和整合之文化，解決傳統兩個團隊之間的隔閡和摩擦，將問題以軟體工程的方式處理實現更快速、更穩定的交付流程。其目標為：&lt;code>協作和整合&lt;/code>、&lt;code>持續整合與持續交付&lt;/code>、&lt;code>自動化&lt;/code>、&lt;code>可靠性和穩定性&lt;/code>、&lt;code>文化轉變&lt;/code>、&lt;code>迭代和持續改進&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>什麼是版本控制？版本控制在 DevOps 中有什麼作用？&lt;/p>
&lt;p>軟體工程上的版本控制，是軟體開發過程中程式碼管理和追蹤的方法。它允許團隊在多人協作的情況下，確保團隊成員能夠同時進行軟體開發，而不會干擾彼此的工作，且幫助開發人員追蹤程式碼的變更歷史。&lt;/p>
&lt;p>版本控制在 DevOps 中是重要功能之一，可以幫助開發團隊更好地管理程式碼，提高協作效率，確保代碼的品質。在自動化部署流程中，可以使用版本控制系統中的特定標籤或分支，確保在不同環境中部署一致的程式碼，使系統有更好的可靠性和穩定性。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>請簡述如何管理版本控制的衝突（conflict）和合併（merge）。&lt;/p>
&lt;p>版本控制的衝突和合併是在多人協作開發的過程中常見的任務，目的是為了確保程式碼的一致性。其管理流程為：&lt;/p>
&lt;ol>
&lt;li>創建分支&lt;/li>
&lt;li>提交變更&lt;/li>
&lt;li>拉取main -&amp;gt; 解決衝突&lt;/li>
&lt;li>提交衝突變更 -&amp;gt; 進行合併&lt;/li>
&lt;/ol>
&lt;pre class="mermaid">gitGraph
commit id: "0"
commit id: "1"
branch develop
commit id: "2"
checkout main
checkout develop
commit id: "3"
commit id: "4"
checkout main
commit id: "5"
merge develop
commit id: "6"&lt;/pre>
&lt;/li>
&lt;li>
&lt;p>請解釋容器化技術中的 uid、gid 與宿主機的關係為何？&lt;/p>
&lt;p>Linux 中使用 uid 與 gid 作為使用者和群組的唯一識別碼。在容器中進程的 uid 和 gid 通常是在創建容器映像時所定義，以實現隔離和安全性。&lt;/p>
&lt;p>容器映像中可以包含使用者和群組配置，以及對應的 uid 和 gid。當容器運行時，容器運行時環境會使用這些設定來創建容器內的使用者和群組。但如果容器中進程的 uid 和 gid 與宿主機上的 uid 和 gid 相同，可能會導致安全性問題，&lt;/p>
&lt;/li>
&lt;li>
&lt;p>請簡述 Docker 和 Kubernetes 之間的關係，以及它們分別有什麼作用？&lt;/p>
&lt;p>Docker 為容器化技術之一，用以封裝應用程序和其相關的依賴套件，創建獨立的且可移植的運行環境。Kubernetes 是一個開源的容器管理平台，用於自動化容器的部署、維護、擴展和調度。它可以管理大規模的容器集群，確保應用程序的高可用性、自動擴展和動態調整。&lt;/p>
&lt;p>Docker 與 Kubernetes 的關係為容器封裝與容器管理，確保應用程序可以在不同的運行環境中實現高可用性和彈性的部署。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>請依據您個人的經驗設計 CI/CD 流程，並請說明使用到的工具及目的？&lt;/p>
&lt;ol>
&lt;li>提交程式碼，可使用 Git、SVN&lt;/li>
&lt;li>程式碼審核，可使用 GitHub、GitLab&lt;/li>
&lt;li>執行編譯產出結果，例如 JAR、Image、static file，可使用 Docker、Podman 容器技術產生映像檔&lt;/li>
&lt;li>單元測試、整合測試，可使用 Cucumber、SoapUI&lt;/li>
&lt;li>程式漏洞掃描，可使用 SonarQube、Trivy&lt;/li>
&lt;li>產出物存儲庫，可使用 Sonatype Nexus、Harbor&lt;/li>
&lt;li>產出物簽章， 可使用 Cosign&lt;/li>
&lt;li>部署執行工具，可使用 Jenkins、Drone、Ansible&lt;/li>
&lt;li>機敏資訊管理，可使用 HashiCrop vault&lt;/li>
&lt;li>運行環境，可使用 Kubernetes&lt;/li>
&lt;/ol>
&lt;pre class="mermaid">flowchart TB
1((developer))
2[source]
3{code review}
4[build]
5[test]
6[scan]
7[artifacts repository]
8[signature]
9[deploy]
10[secrets]
11[production]
1 -->|code commit|2
subgraph SCM
2 --> 3
3 --> |pass| 2
end
3 --> |reject| 1
subgraph CI
2 --> 4
4 --> 5
5 --> 6
8
end
8 --> 7
6-->7
7 --> 9
subgraph CD
9
10 -.-> 9
end
9 --> 11&lt;/pre>
&lt;/li>
&lt;li>
&lt;p>您如何確保在不同環境中的一致性，例如開發、測試和生產環境？&lt;/p>
&lt;p>基礎建設的部分可以使用基礎設施即代碼工具，例如 Terraform、Ansible 等，使各個環境的架構相同；而服務運行的程式部分則可以透過容器化技術建立可移植的映像檔，讓映像檔有可複使用之特性，利於部署到不同環境上。當有環境架構相同性與服務程式的可移植性就可以確保各環境的狀態一致。&lt;/p>
&lt;p>當部署完成後，各環境可能會因為不同的壓力負荷導致系統產生不易發現之狀況。所以可在各環境中實施監控和追蹤，以便及時發現並解決問題，確保系統的健康運行。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>說明你在雲端平台上的經驗（AWS、Azure 或 Google Cloud），例如資源管理、自動縮放和成本優化。&lt;/p>
&lt;p>我擁有豐富的資源管理、自動縮放和成本優化經驗，透過 Infrastructure as Code 建置雲上的各個資源。並且確保在雲端平台上實施最佳的安全性，包括設定安全組、IAM 角色和權限，並遵循適用的合規性要求。&lt;/p>
&lt;p>再者使用雲平台的 Kubernetes 技術，例如 AWS 的 EKS、GCP 的 GKE 作為容器管理工具。由 Kubernets 的 Horizontal Pod Autoscaling 功能與雲平台的 Autoscaling 功能做搭配，達到依據負載量做自動調整資源，可以有效的優化成本，來依據服務負載量來做資源調度。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>什麼是基礎設施即代碼（Infrastructure as Code，IaC）？有使用過哪些 IaC 工具？&lt;/p>
&lt;p>基礎設施即代碼（Infrastructure as Code，IaC）是通過程式碼的方式進行描述來管理與操作基礎設施的配置，實現自動化的基礎設施部署、管理和變更。我目前使用過的 IaC 工具有 Terraform、Terragrun 用來管理雲平台資源，並使用 Ansible 做組態配置管理。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>請問如何檢測 DNS Server 解析正常？&lt;/p>
&lt;p>要檢測 DNS Server 的狀況可以使用 nslookup、dig 等命令來查詢特定域名的解析結果。若要排查路由狀況可以使用 traceroute、ping、mtr 等命令來進行分析。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>你有使用過哪些自動化工具，例如 Ansible、Chef 或 Puppet？請舉例說明你如何使用它們。&lt;/p>
&lt;p>我擁有豐富的 Ansible 工具使用經驗，透過 Ansible 執行自動化任務，例如：實例的組態設定與權限配置、自動部署任務、操作防火牆規則、架設 web server 等。並且搭配 Ansible AWX 介面，可以綁定角色權限做任務調度，也可做稽核審查。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>如何監控和管理應用程式的運行狀況？你使用過哪些監控工具？&lt;/p>
&lt;p>基於 Kubernetes 架構上，可以透過探針 (Probes) 來確認應用程式的運行狀態。為了可以保存週期性的資料，使用了 Prometheus 用於多維度數據收集和警報，並採用可視化監控數據工具 Grafana 做數據整理與分析，將結果呈現在儀表板上，進而達到監控和管理應用程式的運行狀況。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>你在監控和日誌分析方面使用過哪些工具？如何確保及時發現問題並進行故障排除？&lt;/p>
&lt;p>基於 Kubernetes 架構上，建置了 Fluent Bit 作為日誌搜集與過濾之工具，並將其結果儲存在 AWS CloudWatch 上的 Log Stream 中，最後使用數據可視化和監控工具 Grafana 創建圖表和儀表板。&lt;/p>
&lt;p>基於上述的日誌系統架構，可以設定告警規則、實時監控、日誌分析和查找等，綜合使用這些方法，可以在及早發現問題並快速進行故障排除方面實現更好的效果。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>你在持續備份和數據恢復方面的經驗是什麼？請描述你的方法和工具。&lt;/p>
&lt;p>收先需確認備份資的對象，假設以 AWS RDS 為例子，RDS 服務有提供多種備份機制，我過往的經驗是採用快照備份，快照是一個靈活的備份方式，它可以保存 RDS 實例的當前狀態，包括數據庫、日誌和配置等。&lt;/p>
&lt;p>RDS 快照保存為 1 天 1 次，所以還是有可能造成 24 小時內的資料遺失。為了解決資料遺失區間過大，所以也導入了增量備份的策略。我採用的增量備份策略是備份一定時間內的 Binary Logs，並設定自動化備份流程執行定期備份，使資料遺失的區間減少。&lt;/p>
&lt;p>當 RDS 毀損時，即可以使用 &amp;quot;快照&amp;quot; 與 &amp;quot;Binary Logs&amp;quot; 做數據恢復，盡可能減少資料遺失過多導致損失過大的風險。資料毀損已經是很嚴重的災情，為了避免到這一步，通常也會把系統設計為高可用性架構。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>請簡述 Container 的生命週期 (基於 OCI 標準)？&lt;/p>
&lt;p>基於 OCI (Open Container Initiative) 標準，容器的生命週期可以簡述如下:&lt;/p>
&lt;ol>
&lt;li>Image 準備階段：這個階段包括 Dockerfile 或其他容器設定檔的編寫，來定義映像檔，然後使用 Docker 或其他容器引擎來建立 Image。&lt;/li>
&lt;li>Container 建立階段：這個階段為運行容器引擎命令，並指示引擎使用指定的 Image 和配置來啟動容器。&lt;/li>
&lt;li>Container 執行階段： 在此階段，容器內運行的應用程式開始處於運行狀態，並根據設定執行所需的工作。&lt;/li>
&lt;li>Container 停止階段： 當應用程式完成其工作，或者其他原因來停止容器。停止後，容器不再執行應用程式並且可以從系統中移除。&lt;/li>
&lt;li>Container 刪除階段： 容器停止後，可以從系統中刪除容器實例。刪除容器將釋放系統資源，並清理容器的臨時數據等。&lt;/li>
&lt;/ol>
&lt;pre class="mermaid">flowchart LR
1[Create Image]
2[Container registry]
3[Container creation]
4[Container execution]
5[Container stop]
6[Container Deletion]
image-spec --> distribution-spec
distribution-spec --> runtime-spec
subgraph image-spec
1
end
subgraph distribution-spec
2
end
subgraph runtime-spec
3 --> 4
4 --> 5
5 --> 6
end&lt;/pre>
&lt;/li>
&lt;/ol>
&lt;h4 id="面談">面談&lt;/h4>
&lt;ol>
&lt;li>如何處理服務的擴展和負載均衡？&lt;/li>
&lt;li>如何管理機密資料和敏感設定，例如密碼和 API 金鑰？&lt;/li>
&lt;li>你如何確保應用程式和基礎設施的安全性？有哪些安全實踐？&lt;/li>
&lt;li>如何優化應用程式和基礎設施的性能？&lt;/li>
&lt;li>你有使用過 Configuration Management 工具嗎？請舉例說明。&lt;/li>
&lt;li>什麼是微服務架構，你認為它有哪些優勢和挑戰？&lt;/li>
&lt;li>解釋 CI/CD 的概念以及它如何有助於軟體交付流程。&lt;/li>
&lt;li>什麼是 Kubernetes？請說明它的主要功能和優點。&lt;/li>
&lt;li>談談你如何確保基礎設施的高可用性和彈性。&lt;/li>
&lt;li>如何在高可用性環境中設計和部署應用程式？依據你過往的經驗說明。&lt;/li>
&lt;li>請描述一個你曾經處理過的緊急系統故障的經驗，以及你是如何排除。&lt;/li>
&lt;li>談談容錯和災難恢復（Disaster Recovery）的策略，以及你如何確保系統的高可用性和故障容忍性。&lt;/li>
&lt;li>解釋軟體部署的藍綠部署（Blue-Green Deployment）和金絲雀部署（Canary Deployment），以及它們的優點和用途。&lt;/li>
&lt;li>請談談你如何監控和管理日誌（log），以確保系統的可追蹤性和故障排查。&lt;/li>
&lt;li>最近你學習或採用的新技術、工具或實踐是什麼？請講述你學習和應用它們的經驗。&lt;/li>
&lt;li>在你的過去經驗中，你覺得自己在哪些方面最具有優勢，可以為團隊帶來最大的價值？&lt;/li>
&lt;/ol>
&lt;h4 id="進階問題">進階問題&lt;/h4>
&lt;ol>
&lt;li>請解釋一下軟件定義網絡（SDN）在 DevOps 中的應用。&lt;/li>
&lt;li>你如何處理系統中的數據安全和隱私問題？&lt;/li>
&lt;li>如何進行流量規劃，確保系統在負載高峰期仍然可用？&lt;/li>
&lt;li>解釋一下無服務區（Dark Launch）的概念，以及在實際應用中的優勢。&lt;/li>
&lt;li>你曾經遇到過一個數據庫性能下降的情況，你會如何診斷和解決這個問題？&lt;/li>
&lt;li>如果你需要設計一個分佈式系統的負載均衡策略，你會考慮哪些因素？&lt;/li>
&lt;li>你如何處理分佈式系統中的一致性和異常情況？&lt;/li>
&lt;li>你如何測試和確保新的代碼變更不會影響現有系統的穩定性？&lt;/li>
&lt;li>如果系統的壓力測試顯示出性能問題，你會如何分析並解決這些問題？&lt;/li>
&lt;li>請描述你如何設計和實現自動化的故障回滾（Rollback）策略。&lt;/li>
&lt;/ol></description></item><item><title>What Is the Data, Information, Knowledge, Wisdom (DIKW) Pyramid?</title><link>https://chiehting.com/posts/note-data-information-knowledge-wisdom/</link><pubDate>Mon, 31 Jul 2023 17:58:32 +0800</pubDate><guid>https://chiehting.com/posts/note-data-information-knowledge-wisdom/</guid><description>
&lt;p>這篇文章主要在了解 DIKW 的知識模型，DIKW 金字塔模型是知名的知識架構之ㄧ, 使我們了解到知識的轉化過程. 如諺語 &amp;quot;師父領進門, 修煉在個人&amp;quot;, 當師傅講得再多; 給的資料再多, 如果自身沒有想要深入理解的話, 永遠都不會轉化成智慧. 這也有關於自身的態度.&lt;/p>
&lt;h3 id="reference">Reference&lt;/h3>
&lt;p>&lt;a href="https://www.ontotext.com/knowledgehub/fundamentals/dikw-pyramid/">What Is the Data, Information, Knowledge, Wisdom (DIKW) Pyramid?&lt;/a>&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>DIKW 金字塔模型, 是知識管理的著名架構之一. DIKW 為金字塔的四個階段的字首, 分別為 Data、Information、Knowledge、Wisdom, 透過這幾個階段將從資料轉變成自身的智慧.&lt;/p>
&lt;p>知識的形成之初都是由 Data 開始的, Data 尚未被賦予意義也未組織的資料源. 文章將到一個範例就是 &lt;em>12012012&lt;/em> 是一組數字, 當被賦予了日期這個意義後, 就會變成 &lt;em>12月1號2012年&lt;/em>. Data 通常為龐大且短暫的資訊, 如果沒特別感興趣或是去深入了解, 滿容易就忘記了.&lt;/p>
&lt;p>當我們對資料做進一步的了解, 去理解資料如何使用的時候就會升為資訊的階段, 通常可以透過 'who', 'what', 'when', 'where' 這些問題來深入了解資料. 在這個階段, 只是知道怎麼使用資訊, 但如果談到 'how' 的時候, 嘗試去理解其原理, 就會再升為下一個階段 &amp;quot;知識&amp;quot;.&lt;/p>
&lt;p>當達到 &amp;quot;知識&amp;quot; 階段時, 會將這份知識跟其他的部分做連結, 進而深入理解這份知識. 例如談到 TCP 時, 為了理解其運作原理, 就會與 &amp;quot;封包的組成&amp;quot; 和 &amp;quot;OSI model&amp;quot; 做連結, 進而給予 TPC 更多的意義與價值. 當我們可以解釋知識, 並給出觀點與建議時, 就再升為下一個階段 &amp;quot;智慧&amp;quot;.&lt;/p>
&lt;p>&amp;quot;智慧&amp;quot; 為整個金字塔的最上層, 這階段我們應該要可以侃侃而談, 說明 &amp;quot;為什麼要這樣做&amp;quot; 或者 &amp;quot;給出更好的建議&amp;quot;, 在這個階段也可以做出較精準的抉擇跟判斷.&lt;/p>
&lt;p>這篇文章的自問 'who', 'what', 'when', 'where', 'how' 可以關聯到另一種分析法 [[5w1h]]. 透過自問的方式來做思考, 這方式也可以很好的收斂問題.&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.ontotext.com/knowledgehub/fundamentals/dikw-pyramid/">What is the Data, Information, Knowledge, Wisdom (DIKW) Pyramid?&lt;/a>&lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">The DIKW Pyramid represents the relationships between data, information, knowledge and wisdom.&lt;/span> Each building block is a step towards a higher level - first comes data, then is information, next is knowledge and finally comes wisdom. Each step answers different questions about the initial data and adds value to it. &lt;span style="background-color: #ffffcc; color: red">The more we enrich our data with meaning and context, the more knowledge and insights we get out of it so we can take better, informed and data-based decisions.&lt;/span>&lt;/strong>&lt;/p>
&lt;p>&lt;strong>Each step up the pyramid answers questions about the initial data and adds value to it. &lt;span style="background-color: #ffffcc; color: red">The more questions we answer, the higher we move up the pyramid.&lt;/span> In other words, the more we enrich our data with meaning and context, the more knowledge and insights we get out of it.&lt;/strong> At the top of the pyramid, we have turned the knowledge and insights into a learning experience that guides our actions.&lt;/p>
&lt;h4 id="data">&lt;strong>Data&lt;/strong>&lt;/h4>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">Data is a collection of facts in a raw or unorganized form such as numbers or characters.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">However, without context, data can mean little.&lt;/span> For example, &lt;em>12012012&lt;/em> is just a sequence of numbers without apparent importance. But if we view it in the context of ‘this is a date’, we can easily recognize &lt;em>12th of January, 2012&lt;/em>. By adding context and value to the numbers, they now have more meaning.&lt;/p>
&lt;p>In this way, we have transformed the raw sequence of numbers into&lt;/p>
&lt;h4 id="information">&lt;strong>Information&lt;/strong>&lt;/h4>
&lt;p>Information is the next building block of the DIKW Pyramid. &lt;span style="background-color: #ffffcc; color: red">This is data that has been “cleaned” of errors and further processed in a way that makes it easier to measure, visualize and analyze for a specific purpose.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">Depending on this purpose, data processing can involve different operations such as combining different sets of data (aggregation), ensuring that the collected data is relevant and accurate (validation), etc.&lt;/span> For example, we can organize our data in a way that exposes relationships between various seemingly disparate and disconnected data points. More specifically, we can analyze the Dow Jones index performance by creating a graph of data points for a particular period of time, based on the data at each day’s closing.&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">By asking relevant questions about ‘who’, ‘what’, ‘when’, ‘where’, etc., we can derive valuable information from the data and make it more useful for us.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">But when we get to the question of  ‘how’, this is what makes the leap from information to&lt;/span>&lt;/p>
&lt;h4 id="knowledge">&lt;strong>Knowledge&lt;/strong>&lt;/h4>
&lt;p>“How” is the information, derived from the collected data, relevant to our goals? “How” are the pieces of this information connected to other pieces to add more meaning and value? And, maybe most importantly, “how” can we apply the information to achieve our goal?&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">When we don’t just view information as a description of collected facts, but also understand how to apply it to achieve our goals, we turn it into knowledge.&lt;/span> This knowledge is often the edge that enterprises have over their competitors. As we uncover relationships that are not explicitly stated as information, we get deeper insights that take us higher up the DIKW pyramid.&lt;/p>
&lt;p>But only when we use the knowledge and insights gained from the information to take proactive decisions, we can say that we have reached the final – ‘wisdom’ – step of the Knowledge Pyramid.&lt;/p>
&lt;h4 id="wisdom">&lt;strong>Wisdom&lt;/strong>&lt;/h4>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">Wisdom is the top of the DIKW hierarchy and to get there, we must answer questions such as ‘why do something’ and ‘what is best’. In other words, wisdom is knowledge applied in action.&lt;/span>&lt;/p>
&lt;p>&lt;span style="background-color: #ffffcc; color: red">We can also say that, if data and information are like a look back to the past, knowledge and wisdom are associated with what we do now and what we want to achieve in the future.&lt;/span>&lt;/p></description></item><item><title>Laravel 框架產生的 cookie XSRF-TOKEN 需不需要使用 HttpOnly</title><link>https://chiehting.com/posts/laravel-xsrf-token-needless-httponly/</link><pubDate>Thu, 27 Jul 2023 17:02:44 +0800</pubDate><guid>https://chiehting.com/posts/laravel-xsrf-token-needless-httponly/</guid><description>
&lt;p>Question :: Does a CSRF cookie need to be HttpOnly such as XSRF-TOKEN cookie from Laravel.&lt;/p>
&lt;p>Answer :: CSRF cookie 可以不用使用 HttpOnly flag([[internet-rfc-6265-server-requirements]]), 因為 HttpOnly flag 保護的前提下已經是被 XSS([[cross-site-scripting]]) 攻擊, 同域的狀況下 CSRF cookie 已經失去其保護作用. 而且 XSS is a much bigger hole than CSRF. 所以 Laravel 產生的 XSRF-TOKEN cookie 可以不使用 HttpOnly flag.&lt;/p>
&lt;h3 id="referances">Referances&lt;/h3>
&lt;p>&lt;a href="https://security.stackexchange.com/questions/175536/does-a-csrf-cookie-need-to-be-httponly">Does a CSRF cookie need to be HttpOnly?&lt;/a>&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>這篇再討論防止 Cross Site Request Forgery(CSRF) 使用的 cookie 需不需要使用 HttpOnly. 像是 Laravel 框架中的 XSRF-TOKEN. 要理解這個問題, 首先要先釐清 CSRF 與 Cookie HttpOnly 的作用.&lt;/p>
&lt;p>CSRF 攻擊是惡意網站偽造我的網站並發送請求到我的服務, 一般情況下會透過用戶的瀏覽器發送請求, 所以儲存在用戶上的 cookie 也都會被帶上, 我的服務就會判定就是該用戶的請求. 而 CSRF token 則可以保護我的服務收到的請求都是同域, 因為跨域取不到 CSRF token.&lt;/p>
&lt;p>Cookie 的 HttpOnly flag 其目的是防止 Javascript 可以讀寫 cookie, 透過禁用 &lt;code>document.cookie&lt;/code> 的方式防止某些攻擊, 例如 Cross-Site Scripting(XSS) 攻擊時其更難執行. XSS 會注入攻擊碼至我的服務中, 使我的服務執行攻擊腳本, 進而對用戶造成傷害.&lt;/p>
&lt;p>現在回到 XSRF-TOKEN 需不需要使用 HttpOnly. 由於 XSRF-TOKEN 是防止跨站攻擊, HttpOnly flag 是 XSS 後防止 JS 竊取. 所以已經被 XSS 的話 XSRF-TOKEN 應該就失去保護之目的了, 因為是同域. 在被 XSS 的情況下, 攻擊者已經沒有竊取 XSRF-TOKEN 的必要, 因為每次請求用戶瀏覽器都會帶上; 攻擊者已經沒有改寫 XSRF-TOKEN 的必要, 因為改寫了用戶請求就會失敗. 所以 XSRF-TOKEN 可以不用 HttpOnly flag.&lt;/p>
&lt;p>另外 &lt;a href="https://laravel.com/docs/10.x/csrf#csrf-x-xsrf-token">Laravel 文件&lt;/a> 也明確表明 XSRF-TOKEN 創建是為了給 JavaScript 框架或套件使用的, 用於在同域下設置表頭 X-XSRF-TOKEN, 所以理應要給 JavaScript 讀取. Laravel 框架下產生的 XSRF-TOKEN 可以不用 HttpOnly flag.&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://security.stackexchange.com/questions/175536/does-a-csrf-cookie-need-to-be-httponly">Does a CSRF cookie need to be HttpOnly?&lt;/a>&lt;/p>
&lt;p>We were recently handed a security report containing the following:&lt;/p>
&lt;blockquote>
&lt;p>Cookie(s) without HttpOnly flag set&lt;/p>
&lt;/blockquote>
&lt;p>vulnerability, which we apparently had in one of our internal applications.&lt;/p>
&lt;p>The applied fix was as simple as setting Django's &lt;a href="https://docs.djangoproject.com/en/2.0/ref/settings/#csrf-cookie-httponly">&lt;code>CSRF_COOKIE_HTTPONLY&lt;/code> configuration parameter&lt;/a> to &lt;code>True&lt;/code>.&lt;/p>
&lt;p>But, this is what got me confused. The Django documentation says:&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Designating the CSRF cookie as HttpOnly doesn’t offer any practical protection because CSRF is only to protect against cross-domain attacks.&lt;/span> If an attacker can read the cookie via JavaScript, they’re already on the same domain as far as the browser knows, so they can do anything they like anyway. (XSS is a much bigger hole than CSRF.)&lt;/strong>&lt;/p>
&lt;p>Although the setting offers little practical benefit, it’s sometimes required by security auditors.&lt;/p>
&lt;/blockquote>
&lt;p>Does this mean that &lt;strong>&lt;span style="background-color: #ffffcc; color: red">there is no actual vulnerability here&lt;/span> and we just have to be compliant with the security auditing rules&lt;/strong>?&lt;/p>
&lt;h4 id="97-樓">97 樓&lt;/h4>
&lt;p>As &lt;a href="https://security.stackexchange.com/a/175538/98538">joe says&lt;/a>, &lt;strong>there is no real security benefit to this&lt;/strong>. It is pure security theater. I'd like to highlight this from &lt;a href="https://docs.djangoproject.com/en/2.0/ref/settings/#csrf-cookie-httponly">the documentation&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>If you enable this and need to send the value of the CSRF token with an AJAX request, your JavaScript must pull the value from a hidden CSRF token form input on the page instead of from the cookie.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>The purpose of the HttpOnly flag is to make the value of the cookie unavailable from JavaScript, so that it can not be stolen if there is a XSS vulnerability. But the CSRF-token must somehow be available so it can be double submitted&lt;/strong> - thats the whole point with it, after all. So Django solves this by including the value in a hidden form field. This negates the whole benefit of HttpOnly, since an attacker can just read the value of the form field instead of the cookie.&lt;/p>
&lt;h4 id="18-樓">18 樓&lt;/h4>
&lt;p>I think the main point of confusion here is that the Django docs are specifically talking about the &lt;em>CSRF&lt;/em> use case for a cookie. &lt;strong>In order to understand why the &lt;code>httpOnly&lt;/code> flag adds no value in preventing CSRF, you need to understand both CSRF and how cookies work.&lt;/strong>&lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">CSRF is when a 3rd party triggers your user's browser to make a request to your server, and their browser automatically sends your server's cookies along with the request, as expected&lt;/span>. What you don't want is for your server to interpret this request as actually coming from your user, so you use a &lt;a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">CSRF mitigation&lt;/a> technique.&lt;/strong> The whole point of CSRF mitigation is &lt;strong>to be able to detect when the request didn't come from your own domain (i.e. from your user interacting with your application)&lt;/strong>.&lt;/p>
&lt;p>Briefly, how cookies work: &lt;strong>Whenever a user's browser sends a request to your domain/server, it automatically sends all the cookies associated with your domain, regardless of the &lt;code>httpOnly&lt;/code> flag. Cookies therefore allow your client or your server to attach information to a user's browser that will be returned to your server automatically along with any follow-on requests. &lt;span style="background-color: #ffffcc; color: red">Cookies with the &lt;code>httpOnly&lt;/code> flag cannot be accessed from javascript.&lt;/span> They probably shouldn't be considered a secure place to store information, but they do provide the advertised functionality.&lt;/strong>&lt;/p>
&lt;p>Back to CSRF implemented using a cookie — &lt;span style="background-color: #ffffcc; color: red">&lt;strong>in this case&lt;/strong> the &lt;code>httpOnly&lt;/code> flag is pointless&lt;/span> — &lt;span style="background-color: #ffffcc; color: red">the crux of CSRF is that they don't need to read your user's cookies, they just need your user's browser to send the associated cookies to your server along with the network request they forced it to send.&lt;/span> The &lt;code>httpOnly&lt;/code> flag, in general, does provide value in that it prevents client access to those cookies, and if your server returns any cookies, you should probably make them &lt;code>httpOnly&lt;/code>. If you are using a cookie for CSRF, then, you shouldn't do that, and you should spend your time rethinking that rather than making it an &lt;code>httpOnly&lt;/code> cookie. So, in general, it seems like that is a good rule of thumb — your server shouldn't send any non-&lt;code>httpOnly&lt;/code> cookies unless it is specifically intended to be accessed by the client javascript.&lt;/p></description></item><item><title>What is electronic wallet</title><link>https://chiehting.com/posts/electronic-wallet-introduction/</link><pubDate>Mon, 24 Jul 2023 11:27:29 +0800</pubDate><guid>https://chiehting.com/posts/electronic-wallet-introduction/</guid><description>
&lt;p>電子錢包的分類方式?&lt;/p>
&lt;p>電子錢包可以分成幾種類型, 一種是給金融機構使用的錢包,像是 &lt;code>Apple Pay&lt;/code> ; 一種是給商家業者使用的錢包, 像是 &lt;code>LINE Pay&lt;/code>. 另外還有一種為商家開發的預先儲值型電子錢包, 這種錢包儲值只有該商家可以使用, 像是 &lt;code>星巴克 APP&lt;/code>.&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>首先要注意, 文中提到的分類名詞, 不確定是不是高鉅自定義的名詞. 但概念上還是可釐清錢包的分類.&lt;/p>
&lt;p>透過高鉅的文章來理解台灣的電子錢包生態, 文中提到電子錢包可以分為 &amp;quot;開放式&amp;quot; 和 &amp;quot;閉鎖式&amp;quot; 兩種模式的電子錢包.&lt;/p>
&lt;p>這兩種模式的差異主要在於錢包的建立對象不同, 開放式模式將錢包建立給發卡中心使用, 封閉式模式將錢包建立給商家業者使用.&lt;/p>
&lt;p>也因為錢包對象不同, 所以營收來源也不同. 開放式就是向金融機構收手續費;封閉式就是向店家業者收手續費. 上面提到了兩種都可以跨商家做使用, 只要商家有申請.&lt;/p>
&lt;p>還有另一種為 &amp;quot;商店閉鎖式&amp;quot; 的電子錢包, 這種錢包只能對單一店家消費, 並不能跨商家使用. 也就是錢包裡面的幣不受其他商家承認.&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.mypay.com.tw/main_article2.html">電子錢包系列專文一&lt;/a>&lt;/p>
&lt;h4 id="什麼是電子錢包">什麼是電子錢包？&lt;/h4>
&lt;p>&lt;strong>在現實生活中，信用卡與現金存放在錢包中，&lt;span style="background-color: #ffffcc; color: red">「電子錢包」顧名思義--電子化的錢包，透過手機（或是可以保存信用卡或金融卡的&lt;a href="https://www.bnext.com.tw/px/article/44023/slekt-record-multiple-credit-card-information-can-switch-any-time">載具&lt;/a>）來取代錢包&lt;/span>，在結帳時打開手機，就能選擇你想使用的信用卡或金融卡來付款。&lt;/strong>&lt;/p>
&lt;h4 id="電子錢包兩種型態開放vs閉鎖">電子錢包兩種型態：開放vs.閉鎖&lt;/h4>
&lt;p>&lt;strong>根據&lt;span style="background-color: #ffffcc; color: red">電子錢包業者服務方式，我們將電子錢包分為「開放式」以及「閉鎖式」兩種模式。&lt;/span>&lt;/strong>&lt;/p>
&lt;h5 id="開放式的電子錢包">「開放式」的電子錢包&lt;/h5>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">「開放式」的電子錢包，意指電子錢包業者提供的系統是開放給支付生態系中的發卡銀行使用。&lt;/span>&lt;/strong> 支付形式上錢包只是單純取代原卡片，付款仍然是透過傳統的刷卡機進行交易，如Apple pay模式。 &lt;/p>
&lt;h5 id="閉鎖式的電子錢包">「閉鎖式」的電子錢包&lt;/h5>
&lt;p>「閉鎖式」又分為 &amp;quot;生態圈閉鎖&amp;quot; 與 &amp;quot;商店閉鎖&amp;quot; 兩種模式。
生態圈閉鎖，意即業者建立一個平台，招攬會員使用平台的錢包，同時招攬商店使用平台來收款。&lt;br>
這類型的錢包目前主要透過使用QRcode掃碼交易，如街口支付、Pi行動錢包、支付寶及微信支付等。&lt;br>
商店閉鎖模式，這種電子錢包服務對象是以各別商家為中心，電子錢包系統是做為支持商家收款的工具。舉例來說，星巴克電子錢包App中的儲值卡，只能在星巴克使用。&lt;/p>
&lt;h4 id="兩種錢包營收來源大不同">兩種錢包營收來源大不同&lt;/h4>
&lt;p>「開放式」和 「閉鎖式」兩種模式的電子錢包，營收對象不同：&lt;/p>
&lt;h5 id="類型一開放式電子錢包服務--營收對象為銀行">類型一：「開放式」電子錢包服務--營收對象為銀行&lt;/h5>
&lt;p>舉例：Apple Pay與Samsung Pay&lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">業者提供銀行「電子錢包」服務&lt;/span>，消費者支付方式的差異只在改拿手機，因此消費者使用上幾乎沒有障礙。&lt;/strong> 此種錢包金流模式與本站首文提到的實體信用卡相同，然而，以利潤角度來觀察，過往支付服務業者是透過壓低收單銀行手續費成本來賺取中間價差。但是，&lt;/p>
&lt;p>Apple Pay與Samsung Pay則利用自身手機優勢與用戶黏著度，提供電子錢包服務向發卡銀行業者收「過路費」（這還是第一次有人這樣做）。&lt;/p>
&lt;p>也就是說，若如果發卡銀行要讓持卡人透過Apple Pay使用信用卡支付，就要付手續費給Apple，在簽約時對Apple還有綁定卡量的業績承諾，因此還得幫Apple Pay行銷。&lt;/p>
&lt;p>&lt;strong>這樣類型的錢包在原本的交易體系內就能順暢進行，商戶端幾乎不需改變硬體設備&lt;/strong>（有感應式付款功能的終端機就可以）、消費者端則從拿卡片改用手機來做交易，沒有什麼適應問題，達到一個接近完美的轉換，從Apple Pay綁定卡片的速度就可以證明。&lt;/p>
&lt;h5 id="類型二閉鎖式電子錢包--營收對象為店家">類型二：閉鎖式電子錢包--營收對象為店家&lt;/h5>
&lt;p>舉例：LINE Pay、街口支付、Pi 行動錢包、friDay錢包等 &lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">此類業者為B2B2C模式&lt;/span>：建立自有的支付生態圈，招募消費者使用自己的錢包與店家簽約合作，從中賺取交易手續費。&lt;/strong>&lt;/p>
&lt;p>消費者透過錢包業者綁定信用卡，就可在業者配合的店家消費，較熟知的錢包業者包括LINE Pay、街口支付、Pi 行動錢包、friDay錢包等。&lt;/p>
&lt;p>此種類型的電子錢包業者，其角色就是第一篇文章中提到的「第三方支付業者」，&lt;a href="https://www.mypay.com.tw/main_article1.html">金流模式與第三方支付業者流程完全相同&lt;/a>。&lt;/p>
&lt;h5 id="商店閉鎖式的電子錢包">「商店閉鎖式」的電子錢包&lt;/h5>
&lt;p>**這種模式，&lt;span style="background-color: #ffffcc; color: red">基本上就是儲值卡的電子化&lt;/span>，消費者預先儲值（現金或信用卡）在店家提供的電子錢包中，才在商店進行消費。**這種電子錢包服務對象以店家為中心，店家使用電子錢包做為店內支付工具。舉例來說，星巴克的儲值卡，只能在星巴克使用。&lt;/p>
&lt;p>之所以將此種模式特別獨立出來，是因其採用儲值的方式，金流模式跟一般信用卡交易一樣，但因為是預收款，必須將款項信託，以確保支付款項安全性。&lt;/p>
&lt;h2 id="reference">Reference&lt;/h2>
&lt;p>&lt;a href="https://www.mypay.com.tw/main_article2.html">https://www.mypay.com.tw/main_article2.html&lt;/a>&lt;/p></description></item><item><title>Service Level Indicator</title><link>https://chiehting.com/posts/service-level-indicator/</link><pubDate>Thu, 13 Jul 2023 15:45:24 +0800</pubDate><guid>https://chiehting.com/posts/service-level-indicator/</guid><description>
&lt;h3 id="evergreen-note">Evergreen Note&lt;/h3>
&lt;p>Question :: 什麼是 SLI?&lt;/p>
&lt;p>Answer :: SLI 為 SLO 的指標數據, SLI 為 IT 團隊跟系統間的狀態確認. 但與以往的監控不同, SLO 的目標是以用戶體驗為導向. SLI 在擷取的過程中, 要保持單純與精確, 可以參考文章的 SLI 分類.&lt;/p>
&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://www.datadoghq.com/blog/establishing-service-level-objectives/#getting-from-slis-to-slos">SLOs 101: How to establish and define service level objectives&lt;/a>&lt;/li>
&lt;/ol>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>Service Level Indicator (服務水平指標) 是根據 SLO 目標所衡量的指標, 通常是&lt;strong>可量化的數值&lt;/strong>, 文章中建議將指標做主要的分類 (e.g., response/request, storage, data pipeline).&lt;/p>
&lt;pre>&lt;code>e.g., HTTP 狀態碼為 200 的回應次數, 佔總回應次數的比率
&lt;/code>&lt;/pre>
&lt;p>每個指標不要過於複雜, 盡量保持簡單且要是有關用戶的體驗. 例如一個購物車系統結帳, 當購物車系統的 CPU 過高、MEM 過高, 但不直接影響用戶體驗, 就不是個好的 SLI 指標; 例如加入購物車 API 等待時間, 直接影響用戶的體驗, 就是個需關注的 SLI 指標. 這段注意是在講如何提取好的 SLI 指標, 不是說不要監控 CPU、MEM 等數據. 個人認為監控目標被分成兩種, 一種是系統狀態; 一種是用戶體驗.&lt;/p>
&lt;p>通常一個系統可能由多個組件來組成, 文中建議從最接近用戶的組件中提取數據. 指標要貼近用戶體驗且獨立分開, 單位例如以: cluster, host or component, ext.&lt;/p>
&lt;p>延伸閱讀, &lt;a href="https://www.coursera.org/lecture/site-reliability-engineering-slos/the-sli-menu-CST0V">The SLI menu&lt;/a>, 可參考影片中對 SLI 的指標分類：&lt;/p>
&lt;ol>
&lt;li>請求/回應（Request/Response）
&lt;ul>
&lt;li>可用性指標（Availability）&lt;/li>
&lt;li>回應時間指標（Latency）&lt;/li>
&lt;li>回應品質指標（Quality）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>數據處理（Data Processing）
&lt;ul>
&lt;li>覆蓋率指標（Coverage）&lt;/li>
&lt;li>正確性指標（Correctness）&lt;/li>
&lt;li>新鮮度指標（Freshness）&lt;/li>
&lt;li>吞吐量指標（Throughput）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>資料存儲（Storage）
&lt;ul>
&lt;li>持久性指標（Durability）&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.datadoghq.com/blog/establishing-service-level-objectives/#getting-from-slis-to-slos">Getting from SLIs to SLOs&lt;/a>&lt;/p>
&lt;h4 id="getting-form-slis-to-slos">Getting form SLIs to SLOs&lt;/h4>
&lt;p>Now that we’ve defined some key concepts related to SLOs, it’s time to begin thinking about how to craft them. &lt;strong>&lt;span style="background-color: #ffffcc; color: red">Developing a good understanding of how your users experience your product—and which user journeys are most critical—is the first and most important step in creating useful SLOs.&lt;/span>&lt;/strong> Here are a few questions you should consider:&lt;/p>
&lt;ul>
&lt;li>How are your users interacting with your application?&lt;/li>
&lt;li>What is their journey through the application?&lt;/li>
&lt;li>Which parts of your infrastructure do these journeys interact with?&lt;/li>
&lt;li>What are they expecting from your systems and what are they hoping to accomplish?&lt;/li>
&lt;/ul>
&lt;h4 id="picking-good-slis">Picking good SLIs&lt;/h4>
&lt;p>&lt;strong>As your infrastructure grows in complexity, it becomes more cumbersome to set external SLOs for every single database, message queue, and load balancer. Instead, &lt;span style="background-color: #ffffcc; color: red">we recommend organizing your system components into a few main categories (e.g., response/request, storage, data pipeline), and specifying SLIs within each of these categories.&lt;/span>&lt;/strong>&lt;/p>
&lt;p>&lt;strong>As you start selecting SLIs, &lt;span style="background-color: #ffffcc; color: red">a short but important saying to keep in mind is: “All SLIs are metrics, but not all metrics make good SLIs.” This means that while you might be tracking hundreds or even thousands of metrics, you should focus on the indicators that matter most: the ones that best capture your users’ experience.&lt;/span>&lt;/strong>&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Service type&lt;/th>
&lt;th>SLI type&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>Response/Request&lt;/strong>&lt;/td>
&lt;td>&lt;strong>Availability:&lt;/strong> Could the server respond to the request successfully? &lt;br>&lt;strong>Latency:&lt;/strong> How long did it take for the server to respond to the request? &lt;br>&lt;strong>Throughput:&lt;/strong> How many requests can be handled?&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>Storage&lt;/strong>&lt;/td>
&lt;td>&lt;strong>Availability:&lt;/strong> Can the data be accessed on demand? &lt;br>&lt;strong>Latency:&lt;/strong> How long does it take to read and write data? &lt;br>&lt;strong>Durability:&lt;/strong> Is the data still there when it is needed?&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>Pipeline&lt;/strong>&lt;/td>
&lt;td>&lt;strong>Correctness:&lt;/strong> Was the right data returned? &lt;br>&lt;strong>Freshness:&lt;/strong> How long does it take for new data or processed results to appear?&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;strong>Contrast this with a metric that will almost certainly never make a good SLI: CPU utilization. Even if your servers were experiencing a surge in CPU usage—and your infrastructure teams were getting alerted more often on this high usage—your end users might still be able to seamlessly check out. &lt;span style="background-color: #ffffcc; color: red">The takeaway here is that regardless of how important a metric might be to your internal teams, if its value does not directly affect user satisfaction, then it will not be useful as an SLI.&lt;/span>&lt;/strong>&lt;/p>
&lt;p>&lt;strong>Once you have identified good SLIs, you’ll need to measure them with data from your monitoring system. Again, &lt;span style="background-color: #ffffcc; color: red">we recommend pulling data from the components that are in closest proximity to the user.&lt;/span>&lt;/strong> For instance, you might use a payments API to accept and authorize credit card transactions as part of your checkout service. While numerous other internal components might make up this service (e.g., servers, background job processors), they are typically abstracted away from the user’s view. &lt;span style="background-color: #ffffcc; color: red">Since SLIs serve to quantify your end user experience, it is sufficient to only gather data from the payments endpoint, as it exposes functionalities to the user&lt;/span>.&lt;/p>
&lt;h4 id="turning-slis-into-slos">Turning SLIs into SLOs&lt;/h4>
&lt;p>&lt;strong>Finally, you will need to set a target value—or range of values—for an SLI to transform it into an SLO. &lt;span style="background-color: #ffffcc; color: red">You should state what your best- and worst-case standard would be—and over what period of time this condition should remain valid&lt;/span>.&lt;/strong> For example, an SLO tracking request latency might be “The latency of 99 percent of requests to the authentication service will be less than 250 ms over a 30-day period.”&lt;/p>
&lt;p>As you start to create SLOs, you should keep the following points in mind.&lt;/p>
&lt;h5 id="be-realistic">Be realistic&lt;/h5>
&lt;p>&lt;strong>No matter how tempting it might be to set an SLO to 100 percent, it is essentially impossible to achieve in practice.&lt;/strong> Without factoring in an error budget, your development teams might feel overly cautious about experimenting with new features, which will inhibit the growth of your product. &lt;strong>The typical industry standard is to set SLO targets as a number of nines&lt;/strong> (e.g., 99.9 percent is known as “three nines”, 99.95 percent is known as “three and a half nines”).&lt;/p>
&lt;p>&lt;strong>And as a general rule of thumb, &lt;span style="background-color: #ffffcc; color: red">you should keep your SLOs slightly stricter than what you detail in your SLAs.&lt;/span>&lt;/strong> It’s always better to err on the side of caution to ensure you are meeting your SLAs rather than consistently under-delivering.&lt;/p>
&lt;h5 id="experiment-away">Experiment away&lt;/h5>
&lt;p>&lt;strong>There is no hard-and-fast rule for perfecting SLOs. &lt;span style="background-color: #ffffcc; color: red">Each organization’s SLOs will differ depending on the nature of the product, the priorities of the teams that manage them, and the expectations of the end users. Remember that you can always continue to refine your targets until you find the most optimal values.&lt;/span>&lt;/strong> For instance, if your team is consistently beating the targets by a large amount, you might want to tighten those values or capitalize on your unused error budgets by investing more heavily in product development. But if your team is consistently failing to meet its targets, it might be wise to drop them down to more achievable levels or invest more time in stabilizing the product.&lt;/p>
&lt;h5 id="dont-overcomplicate-it">Don’t overcomplicate it&lt;/h5>
&lt;p>&lt;strong>Last but not least, &lt;span style="background-color: #ffffcc; color: red">resist the temptation to set too many SLOs or to overcomplicate your SLI aggregations when defining your SLO targets.&lt;/span> Instead of setting an individual SLI for each and every single cluster, host, or component that makes up a critical journey, you should try to aggregate them in a meaningful way as a single SLI. In general, &lt;span style="background-color: #ffffcc; color: red">you should restrict your SLOs and SLIs to only ones that are absolutely critical to your end user experience.&lt;/span> This helps cut through the noise so you can focus on what’s truly important.&lt;/strong>&lt;/p></description></item><item><title>Red Hat 所定義的 SRE 角色</title><link>https://chiehting.com/posts/sre-devops-difference/</link><pubDate>Wed, 12 Jul 2023 17:36:48 +0800</pubDate><guid>https://chiehting.com/posts/sre-devops-difference/</guid><description>
&lt;p>&lt;a href="https://www.coursera.org/learn/site-reliability-engineering-slos/lecture/XCfHn/whats-the-difference-between-devops-and-sre">https://www.coursera.org/learn/site-reliability-engineering-slos/lecture/XCfHn/whats-the-difference-between-devops-and-sre&lt;/a>&lt;/p>
&lt;p>It's sounding very familiar because if you think about DevOps as a philosophy, SRE is a prescriptive way of accomplishing that philosophy so if DevOps were an interface and programming language, you might almost say that SRE is a concrete class that implements DevOps.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-java" data-lang="java">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="kd">class&lt;/span> &lt;span class="nc">SRE&lt;/span> &lt;span class="kd">implements&lt;/span> &lt;span class="n">DevOps&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="sre-跟-devops-的差別">SRE 跟 DevOps 的差別&lt;/h3></description></item><item><title>Service Level Ojbective</title><link>https://chiehting.com/posts/service-level-objective/</link><pubDate>Wed, 12 Jul 2023 16:14:50 +0800</pubDate><guid>https://chiehting.com/posts/service-level-objective/</guid><description>
&lt;p>為什麼 SLO 這麼重要?&lt;/p>
&lt;p>SLO 是為滿足 SLA 的目標設立, 將客戶對系統穩定度的期待轉換成目標. 之所以重要是因為 IT 團隊直接關注客戶所在乎的重點, 讓系統的穩定度保持在可接受的範圍內. 當然服務越可靠; 成本就越高.&lt;/p>
&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://www.atlassian.com/blog/opsgenie/measuring-and-evaluating-service-level-objectives">Measuring and evaluating Service Level Objectives (SLOs)&lt;/a>&lt;/li>
&lt;/ol>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>Service level objective (服務水準目標) 是系統監控的目標, 為了滿足 SLA 所承諾之協議. SLO 的組成是由 &lt;strong>SLI、一段時間區間、目標(通常以百分比呈現)&lt;/strong>, 公式如下:&lt;/p>
&lt;p>$$ SLO = SLI + period\ of\ time + valid\ conditions $$&lt;/p>
&lt;p>在建立 SLOs 的時候目標必須是明確且清晰的. 在文中出指出五點來測量與評估 SLOs, 我個人的經驗裡, 在執行上會有些困難點, 在下面一併列出.&lt;/p>
&lt;ul>
&lt;li>&lt;strong>設定準確的目標&lt;/strong>: 須將目標收斂. 設定人需明確目標, 不要過於發散, 讓指標精確以利於後許的衡量.&lt;/li>
&lt;li>&lt;strong>搜集監控數據&lt;/strong>: 數據需要定義清楚且完善, 可視覺化輔助. 工具例如: DataDog, Grafana. 設立人需對目標清楚與系統了解, 使得資訊搜集完全且正確.&lt;/li>
&lt;li>&lt;strong>對收集的指標發出警報&lt;/strong>: 對於告警要透明且公開很認同, 但大量的警報會讓 IT 團隊感受到變弱. 這邊可以做警報權重的配置, 讓 IT 團隊對於警報事件是要繃緊神經的. 工具例如: Opsgenie&lt;/li>
&lt;li>&lt;strong>建立警報報告&lt;/strong>: 取得事件的數據報告, 包括每項服務解決和關閉事件的平均時間、服務健康百分比、事件的嚴重性、事件的關聯性等等. 關鍵的數據報告可以讓評估準確.&lt;/li>
&lt;li>&lt;strong>報告的評估與分享&lt;/strong>: 警報事件要設立負責人, 來對該事件作分析與回饋. 負責人不是單個團隊的職責, 可以是 Dev、Ops、PMs, etc. 依據目標不同, 負責人也會不同. 依據狀況與相關利益者分享報告分析.&lt;/li>
&lt;/ul>
&lt;p>上述幾點是循環且持續執行的優化項目, 不會是一次性任務.&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.atlassian.com/blog/opsgenie/measuring-and-evaluating-service-level-objectives">Measuring and evaluating Service Level Objectives (SLOs)&lt;/a>&lt;/p>
&lt;p>In this context, SLAs (Service Level Agreement) are likely familiar. &lt;strong>&lt;span style="background-color: #ffffcc; color: red">An SLA is a written agreement between the client and the service provider to ensure a healthy level of quality.&lt;/span> If specified conditions aren’t met there are consequences, and they are often financial.&lt;/strong>&lt;/p>
&lt;p>However, the real world isn’t this simple. Service owners are accountable to serve both outside and inside stakeholders. These stakeholders depend on the services to meet their business objectives. This is especially common in microservices architectures, where one service is dependent on another. &lt;strong>As it doesn’t make sense to have written contracts for everything, &lt;span style="background-color: #ffffcc; color: red">service owners should be held responsible by defining clear objectives.&lt;/span>&lt;/strong> There are no severe penalties if those objectives aren’t met. Yet, this doesn’t mean they are there for nothing. There are some consequences, or rather– corrective actions, needed to improve those services.&lt;/p>
&lt;p>&lt;em>A simple equation to define SLA and SLO relationship is:&lt;/em>&lt;/p>
&lt;p>$$ SLA = SLO + written\ and\ signed\ consequences $$&lt;/p>
&lt;p>Let’s focus on 5 key steps while measuring and evaluating SLOs.&lt;/p>
&lt;h5 id="set-the-right-objectives">Set the right objectives&lt;/h5>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Setting the right objectives is the first important step towards building proper SLOs.&lt;/span>&lt;/strong> There are some important things to consider at this point:&lt;/p>
&lt;ul>
&lt;li>Identify key metrics (service level indicators — SLIs) from the end-user viewpoint, such as latency&lt;/li>
&lt;li>Make it measurable– such as 100 ms. latency&lt;/li>
&lt;li>Allow some space (error budget) such as 100 ms. 99.9% of the time&lt;/li>
&lt;li>Be clear on what you promise, for example 99.9% of the time (averaged over 10 minutes), HTTP calls are completed under 100 ms.&lt;/li>
&lt;li>Consider product and business implications because setting the right objectives for SLOs aren’t purely technical as stated the &lt;a href="https://landing.google.com/sre/book/chapters/service-level-objectives.html">in SRE Book&lt;/a>.&lt;/li>
&lt;/ul>
&lt;p>Although these points are important and seem obvious, it is really hard to identify the right metrics. Talk openly with users and be clear on what is promised.&lt;/p>
&lt;h5 id="collect-monitoring-data">Collect monitoring data&lt;/h5>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Once important metrics have been identified, they need to be collected.&lt;/span> This stage depends heavily on SLOs and what the service means to others. Different things may need to be monitored depending on the level of abstraction.&lt;/strong> Often what is needed is a monitoring tool like DataDog to collect and visualize the data. These tools allow for aggregation and alerting when the metric reaches the threshold defined.&lt;/p>
&lt;h5 id="alert-on-collected-metrics">Alert on collected metrics&lt;/h5>
&lt;p>&lt;strong>Alerting is a critical and a complex job by itself. Filtering out low priority alerts and letting the team know about these are important for the health of on-call.&lt;/strong> But these are not the only places where an incident management solution such as &lt;em>Opsgenie&lt;/em> helps. A proper incident management tool does “a lot” more than that. It centralizes all alerts from different monitoring tools in one dashboard and allows users to &lt;a href="https://docs.opsgenie.com/docs/filters">categorize important alerts&lt;/a> for later analysis.&lt;/p>
&lt;h5 id="create-reports-from-alerts">Create reports from alerts&lt;/h5>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Once all of the alerts are in one place it’s important to setup alert reporting&lt;/span>, which makes it easy to see important data points in a structured view.&lt;/strong> To report on SLOs, Service and Infrastructure Health Reports are used at Opsgenie which include key indicators that can be used to evaluate metrics and share with customers as a team. Examples of these metrics are mean time to resolve and close incidents per service, Service health percentage (healthy/unhealthy state by outages and disruptions), severity of incidents that arise in a service and the alerts associated with all incidents (so that insight is gained into which monitoring systems reported the incident in which way) and how stakeholders were affected by the service disruptions – whether they were notified in a timely and proper way. The infrastructure health reports provide infrastructure-wide context by allowing stakeholders to see all alerts and incidents across an entire infrastructure in a single view.&lt;/p>
&lt;h5 id="evaluate-and-share-the-reports">Evaluate and share the reports&lt;/h5>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Reports mean nothing if left un-evaluated. As they are the written proof of performance on the service level indicators defined internally, and they help to see if SLOs were met or not.&lt;/span> Evaluation should include every team member and stakeholder. This means transparency is crucial– be open about them and share the results with others.&lt;/strong> To dig a little bit deeper with analytics tools or create more sophisticated reports for stakeholders, export the reports for easy sharing.&lt;/p>
&lt;h4 id="slos-dont-matter-if-the-cycle-isnt-repeated">SLOs don’t matter if the cycle isn’t repeated&lt;/h4>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Once the cycle is completed– from creating the objectives and finishing with evaluating– the job still isn’t done. It starts all over again. Reevaluate objectives and take corrective actions either by refining the indicators or making services more robust.&lt;/span> Clearly examine error budgets to make sure that overachievement is avoided (yes, that is bad too).&lt;/strong> It is important to design objectives taking into account that tools and services will fail, because they will.&lt;/p></description></item><item><title>Service Level Agreement</title><link>https://chiehting.com/posts/service-level-agreement/</link><pubDate>Mon, 10 Jul 2023 18:02:11 +0800</pubDate><guid>https://chiehting.com/posts/service-level-agreement/</guid><description>
&lt;h3 id="evergreen-note">Evergreen Note&lt;/h3>
&lt;p>Question :: 為什麼 SLA 這麼重要?&lt;/p>
&lt;p>Answer :: 身為 SRE, 要確保系統的可靠性, 並且滿足客戶的期待. 所以訂定協議可以增加客戶與
對服務的信任; 也可以讓 IT 團隊知道系統穩定的目標在哪, 達到客戶與 IT 團隊擁有共識. 並且可以設立 error budget 來應對意外狀況, 讓用戶了解系統碰到異常, 並知道在多少時間內可修復; 讓團隊有排除系統異常的空間, 並了解要在多少時間內修復完畢.&lt;/p>
&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>
&lt;h1 id="what-is-an-sla-learn-best-practices-and-how-to-write-onehttpswwwatlassiancomitsmservice-request-managementslas">&lt;a href="https://www.atlassian.com/itsm/service-request-management/slas">What is an SLA? Learn best practices and how to write one&lt;/a>&lt;/h1>
&lt;/li>
&lt;/ol>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>Service level agreement (服務水準協議) 是在訂定服務可以提供的承諾. SLA 的組成會是由 &lt;strong>SLO 與未達成賠償&lt;/strong>, 公式如下:&lt;/p>
&lt;p>$$ SLA = SLO + written\ and\ signed\ consequences $$&lt;/p>
&lt;p>作為一個服務提供商, 會讓客戶 (外部客戶或內部客戶) 保持對服務的信任. 而協議可讓客戶跟 IT 團隊知道我們提供的服務水準在哪, 進而達成共識.&lt;/p>
&lt;p>當然水準也不會亂承諾 100% 的事情, 因爲總是會有例外狀況. 所以會設立 error budget 來應對意外的發生.&lt;/p>
&lt;p>下面為產業的 SLA 範例:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://aws.amazon.com/tw/legal/service-level-agreements/">AWS&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cloud.google.com/terms/sla?hl=zh-tw">GCP&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://azure.microsoft.com/zh-tw/support/legal/sla/">Azure&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.atlassian.com/legal/sla">Atlassian&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="amazon-api-gateway-service-level-agreement">Amazon API Gateway Service Level Agreement&lt;/h4>
&lt;p>AWS 將努力使API Gateway 在每個 AWS 區域正常運行時間百分比至少達到 99.95％. 如果不能滿足則給出服務積分,用來計算賠償使用.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Monthly Uptime Percentage&lt;/th>
&lt;th>Service Credit Percentage&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Less than 99.95% but greater than or equal to 99.0%&lt;/td>
&lt;td>10%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Less than 99.0% but greater than or equal to 95.0%&lt;/td>
&lt;td>25%&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Less than 95.0%&lt;/td>
&lt;td>100%&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="pchome-24h-購物">PChome 24h 購物&lt;/h4>
&lt;p>全台灣保證24h到貨,遲到將提供100元現金積點;週末假日照常出貨.&lt;/p>
&lt;h4 id="sla-裡常用的服務關鍵績效指標">SLA 裡常用的服務關鍵績效指標:&lt;/h4>
&lt;ol>
&lt;li>系統可用性(System Availability): 客戶使用系統正常運作率會達到 X% 以上, 一般以月份為基準單位進行度量.&lt;/li>
&lt;li>系統回復性(System Recovery): 系統中斷時會在 X 小時內回復正常運作, 系統資料會復原到發生中斷前 X 小時內的狀態.&lt;/li>
&lt;li>系統回應時間(System Response): 系統反應時間不會超過 X 秒.&lt;/li>
&lt;li>網路服務品質(Quality of Service, QoS): 封包遺失比率(Packet Loss)&amp;lt; X%、封包發送延遲時間(Latency)&amp;lt; X 毫秒(ms)、封包發送延遲時間變異數(Jitter)&amp;lt; X 毫秒(ms)等.&lt;/li>
&lt;li>問題回應時間(Incident Response): 系統發生問題後於 X 分鐘內回應, 一般會將問題區分為不同優先等級, 並設定不同的回應時間標準.&lt;/li>
&lt;li>問題解決時間(Incident Resolution): 系統發生問題後於 X 小時內解決, 一般會將問題區分為不同優先等級，並設定不同的解決時間標準.&lt;/li>
&lt;li>平均故障時間(Mean Time to Failurel, MTTF): 指工作系統直到發生故障失效的平均時間. 這表示此系統僅能失效一次且不可修復, 對於不可修復的系統而言, MTTF 為系統可靠度中極為重要的指標. 例如: 筆電電池平均充電循環次數 100 次後損壞, 則 MTTF 就是 100 次.&lt;/li>
&lt;li>平均修復時間(Mean Time To Repair, MTTR): 描述系統從故障狀態轉為工作狀態的平均修理時間. MTTR 越短, 表示恢復性越好.&lt;/li>
&lt;li>平均故障間隔時間(Mean Time Between Failures, MTBF): 指可修復系統兩次故障相鄰之間的平均時間值. MTBF 越長, 系統的可靠性越高, 工作能力越強.&lt;/li>
&lt;li>客服支援時段: 明確訂定出支援小組可提供服務的方式和時段, 例如: 周一到周五上午 9:00 至下午 18:00.&lt;/li>
&lt;/ol>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.atlassian.com/itsm/service-request-management/slas">SLAs: The what, the why, the how&lt;/a>&lt;/p>
&lt;h4 id="what-is-a-service-level-agreement-sla">What is a service level agreement (SLA)?&lt;/h4>
&lt;p>**&lt;span style="background-color: #ffffcc; color: red">As a service provider, a service level agreement is a plain-language agreement between you and your customer (whether internal or external)&lt;/span> that defines the services you will deliver, the responsiveness that can be expected, and how you will measure performance. **&lt;/p>
&lt;p>SLAs define contractually agreed upon terms for services including things like uptime and support responsiveness. For instance, promising customers 99.9% service uptime or a response from support within 24 hours. In addition to formalizing service expectations, SLAs set forth the terms for redress when requirements are breached.&lt;/p>
&lt;h4 id="the-importance-of-slas">The importance of SLAs&lt;/h4>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">SLAs are a foundational agreement between your IT team and customers that are important in building trust.&lt;/span> They manage customer expectations and allow your team to know which issues you are responsible for resolving.&lt;/strong>&lt;/p>
&lt;p>With SLAs in place, there is mutual understanding of service expectations. Implementing SLAs can benefit your IT team in numerous ways that include:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Strengthening IT’s relationship with customers&lt;/strong> - SLAs ease the concern over risk, which improves trust between parties. By defining what happens in the event of a breach, they reduce uncertainty. &lt;/li>
&lt;li>&lt;strong>Formalizing communication&lt;/strong> - Conversations with stakeholders about IT issues can be difficult. Nobody wants to be hearing from a customer ten times a day or,on the other hand, allowing a customer to quietly stew over their unspoken expectations for service performance. An SLA enables stakeholders to have structured conversations based on already agreed-upon terms. &lt;/li>
&lt;li>&lt;strong>Improving productivity and morale&lt;/strong> - SLAs define the urgency of incoming requests. They focus IT teams on which incoming issues matter the most.&lt;/li>
&lt;/ul>
&lt;h4 id="the-difference-between-slas-and-kpis">The difference between SLAs and KPIs&lt;/h4>
&lt;p>An SLA is an agreement between you and your customer that defines how your relationship will work in the future. Key performance indicators (KPIs) are the metrics chosen to gauge how well a team performed against agreed standards.&lt;/p>
&lt;p>An IT service desk, for example, typically agrees to provide technical support for a wide variety of services and devices within the business, and offers guarantees around things like uptime, first-call resolution, and time-to-recovery after service outages. KPIs are the specific metrics that are chosen to track whether the IT service desk fulfills these guarantees.&lt;/p>
&lt;h4 id="the-challenges-of-slas">The challenges of SLAs&lt;/h4>
&lt;p>This all sounds simple, right? In theory, yes. In practice, though, IT teams often run into one or more major challenges:&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Tracking SLAs is difficult, and changing them is even harder&lt;/strong>. To see how they’re performing against SLA, many IT managers have to extract a ton of raw data, write custom queries, and build elaborate Excel formulas and reports. Plus, the SLAs often have to be custom or hard-coded into many service desks, meaning it can take days of development effort to change them.&lt;/li>
&lt;li>&lt;strong>SLAs don’t always align with business priorities&lt;/strong>. SLAs seldom seem to change or evolve at the same pace the business does. In fact, more often than not, they’re inherited. Someone set an SLA a decade ago, and today it’s honored simply because it’s there. &lt;/li>
&lt;li>&lt;strong>There is little flexibility in reporting&lt;/strong>. Even though there are a ton of unique circumstances influencing SLA attainment (like how long it takes for a customer to reply to you, etc.) most SLA reports don’t easily account for them. You either met your SLA or you didn’t. There’s no way to highlight something in a report that shows why, or helps you continually improve.&lt;/li>
&lt;/ul>
&lt;h4 id="how-to-set-slas-and-measure-your-performance">How to set SLAs and measure your performance&lt;/h4>
&lt;p>Above, we talked about how SLAs can feel a bit arbitrary and like you’re not always measuring things that directly support your company’s bigger business objectives. To make sure you’re measuring the right things, and meeting the expectations that other parts of the business have of you, we recommend revisiting your SLAs regularly. Follow this process:&lt;/p>
&lt;ol>
&lt;li>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Set a baseline.&lt;/span>&lt;/strong> The best place to start is by looking at your current SLAs, and how you’re performing against them. Take an inventory of what you offer, and how it aligns to the business goals of your company and your customers.&lt;/li>
&lt;li>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Ask how you’re doing.&lt;/span>&lt;/strong> Talk directly with your customers and solicit constructive feedback. What are you doing well, and what could you do better? Are you offering the right services?&lt;/li>
&lt;li>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Build a draft of new SLAs based on the results of the steps above.&lt;/span>&lt;/strong> Get rid of the services you no longer need, and add the ones that will make customers even happier and bring more value to both the business and IT.&lt;/li>
&lt;li>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Get support from management.&lt;/span>&lt;/strong> To be successful, SLAs need the blessing of your IT leaders, and the leaders of your customer organizations, too. Start by getting your own management to buy in, and then ask them to help you negotiate with your customer’s management team.&lt;/li>
&lt;/ol>
&lt;p>If you've followed the above process, your SLAs should be in pretty good shape.&lt;/p></description></item><item><title>什麼是 Metadata</title><link>https://chiehting.com/posts/metadata/</link><pubDate>Mon, 10 Jul 2023 11:34:49 +0800</pubDate><guid>https://chiehting.com/posts/metadata/</guid><description>
&lt;p>Metadata 在電腦科學裡, 應用的範圍相當廣泛, 例如: 文件、圖檔、影像檔、網站、數據分析、數位資產管理、物聯網等等. 因此，它可以幫助您了解特定資料集的相關性並指導您如何使用它. 此篇目的為理解 Metadata 的概念為何.&lt;/p>
&lt;h2 id="references">References&lt;/h2>
&lt;p>&lt;a href="https://atlan.com/what-is-metadata/">What Is Metadata?&lt;/a>&lt;/p>
&lt;h2 id="metadata">Metadata&lt;/h2>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>Metadata (元數據) 為描述檔案的擴展資料, 提供檔案的相關資訊. 以我個人管理筆記的狀況來理解, Metadata 用以記錄筆記檔案的資訊, 但無關筆記的內容, 例如: 建立日期、分類、類型、狀態等等, 都是在描述筆記檔案的資訊.&lt;/p>
&lt;p>Metadata 的紀錄可以讓我了解筆記當時的狀態, 類型, 或跟其他筆記的關聯等等.
&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2023-07-10-metadata-1.png" alt="筆記關連圖">&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>Metadata is defined as &lt;strong>the information that describes and explains data&lt;/strong>. It provides context with details such as the &lt;strong>source, type, owner, and relationships to other data sets&lt;/strong>. So, it can help you understand the relevance of a particular data set and guide you on how to use it. In a nutshell: Metadata is a cornerstone of a modern enterprise data stack.&lt;/p>
&lt;p>As Ashish Thusoo and Joydeep Sen Sarma put it in their book titled &lt;a href="https://www.oreilly.com/library/view/creating-a-data-driven/9781492049227/ch07.html">Creating a Data-Driven Enterprise with DataOps&lt;/a>, metadata is &lt;strong>data about data.&lt;/strong>&lt;/p>
&lt;p>Here’s how the &lt;a href="https://guides.lib.unc.edu/metadata/definition">University Libraries&lt;/a> from the University of North Carolina lend more context to the definition of metadata:&lt;/p>
&lt;p>&lt;em>Metadata describes a data set (by providing answers to questions such as):&lt;/em>&lt;/p>
&lt;ul>
&lt;li>&lt;em>How it was collected?&lt;/em>&lt;/li>
&lt;li>&lt;em>When was it collected?&lt;/em>&lt;/li>
&lt;li>What assumptions were made in the data collection methodology?&lt;/li>
&lt;li>What is the geographic scope?&lt;/li>
&lt;li>Are there multiple files? If yes, how do they relate to one another?&lt;/li>
&lt;li>What are the definitions of individual variables and, if applicable, what were the possible answers?&lt;/li>
&lt;li>What was the calibration of any equipment used in data collection? And the version of software used for analysis?&lt;/li>
&lt;/ul></description></item><item><title>Red Hat 所定義的 SRE 角色</title><link>https://chiehting.com/posts/sre-definition-from-redhat/</link><pubDate>Mon, 10 Jul 2023 10:23:37 +0800</pubDate><guid>https://chiehting.com/posts/sre-definition-from-redhat/</guid><description>
&lt;h3 id="evergreen-note">Evergreen Note&lt;/h3>
&lt;p>Question :: 這篇文章主要在說什麼?&lt;/p>
&lt;p>Answer :: 透過 &lt;em>Red Hat&lt;/em> 文件來理解什麼是 SRE, 其闡述與 Google 所提出的核心觀念一樣. 並衍伸此概念提出了兩個實踐模型&lt;strong>標準化&lt;/strong>和&lt;strong>自動化&lt;/strong>. 應用這兩個模型, SRE 團隊可以建立標準化的流程和自動化的工具, 進而提升運維的效率、可靠性和可重複性. 這樣可以減少人為錯誤, 加快問題解決速度, 並確保系統運行在穩定和可預測的狀態下.&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>文章為 &lt;em>Red Hat&lt;/em> 來解釋什麼是 SRE, 與 &lt;em>Google&lt;/em> 所提出的核心觀念 &amp;quot;使用軟體工具來執行 IT 運維的任務&amp;quot; 一致. 這邊還有提到說 SRE 可以幫助團隊們在更新新功能與系統穩定間找到平衡, 確保每次的部署都在可控範圍內.&lt;/p>
&lt;p>文件中還講到 SRE 有兩個重要的準則, 為&lt;strong>標準化&lt;/strong>跟&lt;strong>自動化&lt;/strong>. 這兩個準則我認為是實踐 &lt;em>Ben Treynor Sloss&lt;/em> 所提出之理念的方法. 其中標準化為之重要, 若標準化定義不夠精確, 則會造成系統可靠性降低. 而自動化則有關維運的效率.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>標準化: 標準化模型旨在確保運維任務的一致性和可重複性. 這包括定義和實踐運維流程、流程標準、準則和最佳實踐. 通過標準化, SRE 團隊可以確保不同的運維任務都按照相同的標準進行, 減少人為錯誤和不一致性. 例如, SRE 可以制定標準化的網站部署流程, 確保每次部署都遵循相同的步驟和標準, 從而提高部署的效率和可靠性.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>自動化: 自動化模型旨在利用軟體工程和自動化技術來自動執行運維任務, 減少手動操作和人為錯誤的風險. 通過自動化, SRE團隊可以自動化許多重複性、繁瑣的運維任務，從而節省時間和資源. 例如, SRE 可以開發腳本或工具來自動監控系統的健康狀態、自動擴展資源、自動備份數據等. 這樣一來, SRE團隊可以專注於解決更具挑戰性的問題, 並提高系統的穩定性和可靠性.&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.redhat.com/en/topics/devops/what-is-sre">What is SRE (site reliability engineering)?&lt;/a>&lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">&lt;em>Site reliability engineering&lt;/em> (SRE) is a software engineering approach to IT operations. SRE teams use software as a tool to manage systems, solve problems, and automate operations tasks.&lt;/span>&lt;/strong>&lt;/p>
&lt;p>SRE takes the tasks that have historically been done by operations teams, often manually, and instead gives them to engineers or operations teams who use software and automation to solve problems and manage production systems.&lt;/p>
&lt;p>&lt;strong>SRE is a valuable practice when creating scalable and highly reliable software systems. &lt;span style="background-color: #ffffcc; color: red">It helps  manage large systems through code, which is more scalable and sustainable for system administrators (sysadmins) managing thousands or hundreds of thousands of machines.&lt;/span>&lt;/strong>&lt;/p>
&lt;p>The concept of site reliability engineering comes from the &lt;em>Google&lt;/em> engineering team and is credited to &lt;em>Ben Treynor Sloss&lt;/em>.&lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">SRE helps teams find a balance between releasing new features and ensuring reliability for users.&lt;/span>&lt;/strong>&lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">In this context, standardization and automation are 2 important components of the SRE model.&lt;/span>&lt;/strong> Here, site reliability engineers seek to enhance and automate operations tasks.&lt;/p></description></item><item><title>IBM 所定義的 SRE 角色</title><link>https://chiehting.com/posts/sre-definition-from-ibm/</link><pubDate>Fri, 07 Jul 2023 14:46:24 +0800</pubDate><guid>https://chiehting.com/posts/sre-definition-from-ibm/</guid><description>
&lt;h3 id="evergreen-note">Evergreen Note&lt;/h3>
&lt;p>Question :: 這篇文章主要在說什麼?&lt;/p>
&lt;p>Answer :: 透過 IBM 文件來理解 SRE. 觀點跟 Google 所提倡的相差不遠, 說明角色是使用軟體軟體工程自動化的處理運維的任務. 此外, 還有講到 SRE 跟 DevOps 相輔相成的關係 , 並強調 SRE 可在 DevOps 中發揮重要的作用.&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>此篇文章由 IBM 所撰寫, 定義什麼是 SRE. 這角色的目標是使用軟體軟體工程自動化的處理運維[[operations-what-it]]的任務. 其核心是強化運維的效率跟可靠度, 降低手動操作的行為.&lt;/p>
&lt;p>這邊有提到運為在系統做擴展或遷移的時候, 使用軟體工程是個不錯的策略. 當看到這段話時, 個人是有感觸的, 因為曾經有導入 Infrastructure as code (IaC), 將手動建立的雲架構寫成定義檔. 之後再做系統的克隆或架構的調整, 都可以明確的同步到所有雲上, 穩定且可靠.&lt;/p>
&lt;ul>
&lt;li>案例分享: 系統 Load Balancer 的 endpoint 發生變更, 需要快速的變更所有 DNS. 此時有定義好 endpoint 的變數, 將其改為新的位置後, 同意即可變更. 過程中穩定且速度快.&lt;/li>
&lt;li>案例分享: 上頭說要 clone 一整個系統, 此時已將系統架構定義好, 同意即可變更.&lt;/li>
&lt;/ul>
&lt;p>文章還有提到 SRE 可以減少開發團隊跟運維團隊的摩擦, 這邊是引用 DevOps 文化的概念. &lt;strong>DevOps 的概念是使用流程跟軟體來縮短服務開發的生命週期, 這是所有團隊之的責任; SRE 的概念是使用軟體工程來做運維.&lt;/strong> 兩者的概念上有交集, 但個人認爲不能混淆.&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.ibm.com/topics/site-reliability-engineering">What is site reliability engineering?&lt;/a>&lt;/p>
&lt;h4 id="what-is-site-reliability-engineering">What is site reliability engineering?&lt;/h4>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Site reliability engineering (SRE) uses software engineering to automate IT operations tasks&lt;/span>&lt;/strong> - e.g. production system management, change management, incident response, even emergency response - **that would otherwise be performed manually by systems administrators (sysadmins). **&lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">The principle behind SRE is that using software code to automate oversight of large software systems is a more scalable and sustainable strategy than manual intervention&lt;/span> - especially as those systems extend or migrate to the cloud.&lt;/strong>&lt;/p>
&lt;p>&lt;strong>SRE can also reduce or remove much of the natural friction between development teams who want to continually release new or updated software into production, and operations teams who don't want to release any type of update or new software without being absolutely sure it won't cause outages or other operations problems.&lt;/strong> As a result, while not strictly required for &lt;a href="https://www.ibm.com/topics/devops" title="devops-a-complete-guide">DevOps&lt;/a>, SRE aligns closely with DevOps principles and can be play an important role in DevOps success.&lt;/p>
&lt;p>The concept of SRE is credited to Ben Treynor Sloss, VP of engineering at Google, &lt;strong>who famously wrote that &amp;quot;&lt;span style="background-color: #ffffcc; color: red">SRE is what happens when you ask a software engineer to design an operations team.&lt;/span>&amp;quot;&lt;/strong>&lt;/p></description></item><item><title>什麼是運維(Operations)?</title><link>https://chiehting.com/posts/operations-what-it/</link><pubDate>Thu, 06 Jul 2023 16:42:36 +0800</pubDate><guid>https://chiehting.com/posts/operations-what-it/</guid><description>
&lt;h3 id="evergreen-note">Evergreen Note&lt;/h3>
&lt;p>Question :: 這篇文章主要在說什麼?&lt;/p>
&lt;p>Answer :: 根據軟體業來定義運維. 而運維之核心價值在於維持系統的穩定度, 其手段根據不同公司會有不同的方式.&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>運維管理可以應用在不同產業上, 而此篇文章則關注在軟體產業, 所以這邊選擇了 &lt;em>ASANA&lt;/em> 跟 &lt;em>IBM&lt;/em> 做研讀.&lt;/p>
&lt;p>對於 OPS 所需的技能跟責任根據所待的公司有所不同, 但運維的目的其繞著確保系統的可靠性、穩定性和高效運作進行.&lt;/p>
&lt;p>以我在其產業中的經驗, 大致列幾個方向:&lt;/p>
&lt;ol>
&lt;li>監控和警報&lt;/li>
&lt;li>備份機制和還原機制&lt;/li>
&lt;li>故障排除和系統分析&lt;/li>
&lt;li>設備資源規劃和優化&lt;/li>
&lt;li>安全和合規性&lt;/li>
&lt;/ol>
&lt;h3 id="note">Note&lt;/h3>
&lt;h4 id="what-is-operations-management">What is operations management?&lt;/h4>
&lt;p>Operations management is the implementation of business strategies in order to create the highest level of &lt;a href="https://asana.com/zh-tw/resources/efficiency-vs-effectiveness-whats-the-difference">efficiency&lt;/a> possible within your organization.&lt;/p>
&lt;p>Operations management involves planning, organizing, and overseeing processes such as inventory management, the production process, service operations, and other business processes. &lt;strong>&lt;span style="background-color: #ffffcc; color: red">The goal of an operations strategy is to make these processes more efficient, so you can balance cost and revenue and generate the highest possible profit.&lt;/span>&lt;/strong>&lt;/p>
&lt;h4 id="what-is-it-operations-itops">What is IT operations (ITOps)?&lt;/h4>
&lt;p>Whether it’s the financial industry, telecommunications or retail, today’s businesses and their customers rely on immediate access to applications and expect seamless customer experiences. This requires optimal performance from applications and the supporting IT resources that the applications run on, such as &lt;a href="https://www.ibm.com/topics/public-cloud">public cloud&lt;/a> and &lt;a href="https://www.ibm.com/topics/private-cloud">private cloud&lt;/a> infrastructure, data, networks and services. Even a brief IT outage can have a significant impact on business operations and quickly become costly. &lt;strong>&lt;span style="background-color: #ffffcc; color: red">The primary role of IT operations is to ensure the smooth performance of IT and business technologies so that business operations can proceed uninterrupted.&lt;/span>&lt;/strong>&lt;/p></description></item><item><title>Google 所定義的 SRE 角色</title><link>https://chiehting.com/posts/sre-definition-from-google/</link><pubDate>Thu, 06 Jul 2023 15:57:40 +0800</pubDate><guid>https://chiehting.com/posts/sre-definition-from-google/</guid><description>
&lt;h3 id="evergreen-note">Evergreen Note&lt;/h3>
&lt;p>Question :: 這篇文章主要在說什麼?&lt;/p>
&lt;p>Answer :: Google SRE 的定義是將運維(operations)視為軟體問題. 而運維之核心價值在於維持系統的穩定度, 依據不同企業會有不同的方式. 也就是説 SRE 在每間企業所做的事情都不盡相同.&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>此篇原文來源於 &lt;a href="https://sre.google/">Google Site Reliability Engineering&lt;/a> 其中提供了許多值得一看的 &lt;a href="https://sre.google/resources/">Resources&lt;/a>.&lt;/p>
&lt;p>其內容節錄至 &lt;a href="https://sre.google/">Google Site Reliability Engineering&lt;/a> 的網站首頁, 簡要介紹了什麼是 SRE. &lt;strong>其中的核心概念為 &amp;quot;當我們將運維[[operations-what-it]]視為軟體問題時就是 SRE&amp;quot;&lt;/strong>. 這句話我理解為將&lt;strong>運維任務視為軟體工程的一部分來處理&lt;/strong>, 意指要制定運維任務的標準流程, 將其流程使用軟體或自動化來進行, 以確保系統的可靠性和穩定性.&lt;/p>
&lt;p>在傳統的運維觀念中, 系統運維和軟體開發通常視為兩個獨立的領域, 這可能導致隔閡存在. 因此提倡 DevOps 的文化, 旨在促進開發團隊和運維團隊之間的合作與溝通. 然而, SRE 與 DevOps 在本質上有所不同, 市場上也容易將兩個混為一談.&lt;/p>
&lt;p>延伸閱讀, &lt;a href="https://sre.google/in-conversation/">Google 訪談 Ben Treynor&lt;/a>&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://sre.google/">What is Site Reliability Engineering (SRE)?&lt;/a>&lt;/p>
&lt;h5 id="what-is-site-reliability-engineering-sre">What is Site Reliability Engineering (SRE)?&lt;/h5>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">SRE is what you get when you treat operations as if it’s a software problem. Our mission is to protect, provide for, and progress the software and systems behind all of Google’s public services&lt;/span>&lt;/strong> — Google Search, Ads, Gmail, Android, YouTube, and App Engine, to name just a few — with an ever-watchful eye on their availability, latency, performance, and capacity.&lt;/p>
&lt;p>On top of that, in Google, &lt;strong>&lt;span style="background-color: #ffffcc; color: red">we have a bunch of rules of engagement, and principles for how SRE teams interact with their environment&lt;/span> -- not only the production environment, but also the development teams, the testing teams, the users, and so on. &lt;span style="background-color: #ffffcc; color: red">Those rules and work practices help us to keep doing primarily engineering work and not operations work.&lt;/span>&lt;/strong>&lt;/p>
&lt;h5 id="what-we-do-assre">What we do as SRE&lt;/h5>
&lt;p>Our job is a combination not found elsewhere in the industry. Like traditional operations groups, &lt;span style="background-color: #ffffcc; color: red">we keep important, revenue-critical systems up and running despite hurricanes, bandwidth outages, and configuration errors.&lt;/span>&lt;/p>
&lt;h4 id="how-we-sre-atgoogle">How We SRE At Google&lt;/h4>
&lt;p>As SRE, we flip between the fine-grained detail of disk driver IO scheduling to the big picture of continental-level service capacity, across a range of systems and a user population measured in billions.&lt;/p></description></item><item><title>漸進式總結法</title><link>https://chiehting.com/posts/note-progressive-summarization/</link><pubDate>Mon, 03 Jul 2023 13:55:10 +0800</pubDate><guid>https://chiehting.com/posts/note-progressive-summarization/</guid><description>
&lt;p>漸進式總結法是一種知識管理辦法, 透過 5 個 Layer 來將數位資訊收成筆記. 不單存是複製貼上, 要盡可能轉成知識體系.&lt;/p>
&lt;h3 id="reference">Reference&lt;/h3>
&lt;p>&lt;a href="https://fortelabs.com/blog/progressive-summarization-a-practical-technique-for-designing-discoverable-notes/">Progressive Summarization: A Practical Technique for Designing Discoverable Notes&lt;/a>&lt;/p>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>這是一個使用&lt;strong>漸進式總結數位資訊&lt;/strong>的方法, 此篇透過 5 個 Layer 來將數位資訊總結成文件.
文件可以進而轉成知識建構模型 DIKW([[note-data-information-knowledge-wisdom]]) 中的 data、information 甚至是 knowledge, 為金字塔的底層是築起知識的根基. 另外也有提到使用 PARA([[what-is-the-para-method]]) 來做文件的分類.&lt;/p>
&lt;p>再來提及了目前主流的兩種知識管理之方法 &lt;em>Tagging-first&lt;/em>、&lt;em>notebook-first&lt;/em>, 但作者列出了兩種方法的優劣, 並提出了 &lt;em>note-first approach&lt;/em>.&lt;/p>
&lt;p>數位資訊大多是擷取其他來源, 在擷取的過程中不外乎會做壓縮, 作者提到摘錄重點, 但不要過度壓縮. 若失去了上下文的意義, 可能會造成未來的我看不懂; 但也不要摘錄過於攏長, 將重要資訊淹沒在文字中. 這是個兩者的 &lt;code>COMPRESSION VS. CONTEXT&lt;/code> 平衡.&lt;/p>
&lt;p>下面則為 5 個 Layer, 少說至少會看文章 5 遍:&lt;/p>
&lt;ul>
&lt;li>Layer 5: 最後混合 Layer 1~4 做不同角度的頗析, 融會貫通.&lt;/br>&lt;/br>&lt;/li>
&lt;li>Layer 4: 第三次的總節. 用自己的觀點來描述 Layer 2~3 的內容, 並將內容另放在筆記上方.&lt;/br>&lt;/br>&lt;/li>
&lt;li>Layer 3: 第二次的總節. 透過 Layer 2 做螢光筆, 此次螢光部分為重點中的重點, 可節省我們以後閱讀的時間成本. 再做一次審視, 做筆記螢光最獨特且有價值的部分.&lt;/br>&lt;/br>&lt;/li>
&lt;li>Layer 2: 第一次的總節. 透過 Layer 1 的節錄將重要的資訊標註成&lt;strong>粗體重點&lt;/strong>. 再做一遍審視, 補充筆記的不夠明確的部分, 尋找原文的關鍵字、片段文章、句子來解釋不夠明確的核心.&lt;/br>&lt;/br>&lt;/li>
&lt;li>Layer 1: 擷取數位資訊, 將有興趣的部分剪貼至筆記中. 要注意&lt;strong>擷取但不失上下文&lt;/strong>, 保持文章的語境通順.&lt;/li>
&lt;/ul>
&lt;h3 id="note">Note&lt;/h3>
&lt;h4 id="起言">起言&lt;/h4>
&lt;p>Modern digital tools make it easy to “capture” information from a wide variety of sources. We know how to snap a picture, type out some notes, record a video, or scan a document. Getting this content from the outside world into the digital world is trivial.&lt;/p>
&lt;p>&lt;span style="background-color:yellow;color:red">What is difficult is not transferring content from place to place, but &lt;strong>transferring it through time&lt;/strong>.&lt;/span>&lt;/p>
&lt;p>You read a book, investing hours of mental labor in understanding the ideas it presents. You finish the book with a feeling of triumph that you’ve gained a valuable body of knowledge.&lt;/p>
&lt;p>But then what?&lt;/p>
&lt;p>&lt;strong>You may try to apply the science-based methods the book recommends, only to realize it’s not quite as clear-cut as you thought&lt;/strong>. You may try to change the way you eat, exercise, communicate, or work, trusting in the power of habits. But then the everyday demands of life come rushing back, and you forget what motivated you in the first place.&lt;/p>
&lt;p>At this point, people take different paths. Some give up, labeling all &amp;quot;self-help&amp;quot; books a waste of time. Others decide it’s just a problem of remembering everything they read, and invest in fancy memorization techniques. And many people become &amp;quot;infovores,&amp;quot; force-feeding themselves endless books, articles, and courses, in the hope that something will stick.&lt;/p>
&lt;p>At that future point, when you’re applying that knowledge directly to a real-world challenge, you won’t have to worry about memorizing it, integrating it, or even fully understanding it. You will only have to apply it, and any gaps in your understanding will very quickly reveal themselves. &lt;span style="background-color:yellow;color:red">&lt;strong>By the time you’re done solving a real problem with it, book knowledge has become experiential knowledge.&lt;/strong> And experiential knowledge is something you carry with you forever.&lt;/span>&lt;/p>
&lt;p>This is the job of a &amp;quot;second brain&amp;quot; -  an external, integrated digital repository for the things you learn and the resources from which they come. It is a storage and retrieval system, packaging bits of knowledge into discrete packets that can be forwarded to various points in time to be reviewed, utilized, or deleted.&lt;/p>
&lt;p>In The PARA Method([[what-is-the-para-method]]), I described a universal system for organizing any kind of digital information from any source. It is a “good enough” system, maintaining notes according to their &lt;em>actionability&lt;/em> (which takes just a moment to determine), instead of their &lt;em>meaning&lt;/em> (which is ambiguous and depends on the context).&lt;/p>
&lt;h4 id="note-first-knowledge-management">NOTE-FIRST KNOWLEDGE MANAGEMENT&lt;/h4>
&lt;p>There are two primary schools of thought on how to organize a note-taking program (or really any body of information, but I’ll use terms specific to note-taking apps):&lt;/p>
&lt;p>&lt;strong>Tagging-first approaches&lt;/strong> argue that there should be no explicit hierarchy of notes, notebooks, and stacks. Notes are envisioned as an ever-changing, virtual matrix of interconnected, free-floating ideas. Because many tags can be applied to one note, there are multiple pathways to discover any given note. Locating notes in specific notebooks and folders is seen as limiting and static.&lt;/p>
&lt;p>The second conventional approach to organizing notes is &lt;strong>notebook-first&lt;/strong>. This basically translates how we organize things in the physical world — in a series of discrete containers — into the digital world.&lt;/p>
&lt;p>I propose we make the &lt;strong>design of individual notes&lt;/strong> the primary factor, instead of tags or notebooks. &lt;span style="background-color:yellow;color:red">With a note-first approach, your notes become like individual &lt;strong>atoms&lt;/strong> — each with its own unique properties, but ready to be assembled into &lt;strong>elements, molecules, and compounds&lt;/strong> that are far more powerful.&lt;/span>&lt;/p>
&lt;h4 id="designing-discoverable-notes">DESIGNING DISCOVERABLE NOTES&lt;/h4>
&lt;p>A note-first approach to knowledge management means we have to think about design. You are, in a very real sense, designing a product for a demanding customer — Future You.&lt;/p>
&lt;p>Future You doesn’t necessarily trust that everything Past You put into your notes is valuable. Future You is impatient and skeptical, demanding proof upfront that the time they spend reviewing notes will be worthwhile. You’ve gotta “sell them” on the idea of reviewing a given note, including &lt;a href="https://www.thebalance.com/get-to-know-and-use-aida-39273">all the stages&lt;/a> any salesperson has to master: gaining &lt;strong>attention&lt;/strong>, inspiring &lt;strong>interest&lt;/strong>, establishing &lt;strong>credibility&lt;/strong>, stoking &lt;strong>desire&lt;/strong>, and making a case for &lt;strong>action&lt;/strong> NOW.&lt;/p>
&lt;h4 id="compression-vscontext">COMPRESSION VS. CONTEXT&lt;/h4>
&lt;p>There’s a natural tension between the two, compression and context.&lt;/p>
&lt;p>&lt;strong>To communicate anything, you have to compress it, like communicating a huge amount of life experience in a wise saying. But in doing so, you lose a lot of the context that made that wisdom valuable in the first place.&lt;/strong>&lt;/p>
&lt;h4 id="opportunistic-compression">OPPORTUNISTIC COMPRESSION&lt;/h4>
&lt;p>Progressive Summarization works in “layers” of summarization. Layer 0 is the original, full-length source text.&lt;/p>
&lt;p>Layer 1 is the content that I initially bring into my note-taking program. I don’t have an explicit set of criteria on what to keep. &lt;span style="background-color:yellow;color:red">I just capture anything that feels insightful, interesting, or useful.&lt;/span>&lt;/p>
&lt;p>Layer 2 is the first round of true summarization, &lt;span style="background-color:yellow;color:red">in which I bold only the best parts of the passages I’ve imported.&lt;/span> Again, I have no explicit criteria. I look for keywords, key phrases, and key sentences that I feel represent the core or essence of the idea being discussed.&lt;/p>
&lt;p>For Layer 3, &lt;span style="background-color:yellow;color:red">I switch to highlighting&lt;/span>, so I can make out the smaller number of highlighted passages among all the bolded ones. This time, I’m looking for the “best of the best,” only highlighting something if it is truly unique or valuable. And again, I’m only adding this third layer when I’m already reviewing the note anyway.&lt;/p>
&lt;p>For Layer 4, I’m still summarizing, but going beyond highlighting the words of others, to recording my own. For a small number of notes that are the most insightful, I summarize layers 2 and 3 in an informal executive summary at the top of the note, &lt;span style="background-color:yellow;color:red">restating the key points in my own words.&lt;/span>&lt;/p>
&lt;p>And finally , for a tiny minority of sources, the ones that are so powerful and exciting I want them to become part of how I think and work &lt;em>immediately&lt;/em>, I remix them. After pulling them apart and dissecting them from every angle in layers 1–4, &lt;span style="background-color:yellow;color:red">I add my own personality and creativity and turn them into something else.&lt;/span>&lt;/p></description></item><item><title>Metadata of the Markdown</title><link>https://chiehting.com/posts/markdown-metadata/</link><pubDate>Mon, 03 Jul 2023 10:25:14 +0800</pubDate><guid>https://chiehting.com/posts/markdown-metadata/</guid><description>
&lt;p>&lt;em>&lt;a href="%5B%5Bmarkdown%5D%5D">[markdown]&lt;/a>&lt;/em> 支援 YAML 格式的 metadata, 可以提供進階的描述資料屬性(property).&lt;/p>
&lt;h2 id="references">References&lt;/h2>
&lt;p>&lt;a href="https://medium.com/pm%E7%9A%84%E7%94%9F%E7%94%A2%E5%8A%9B%E5%B7%A5%E5%85%B7%E7%AE%B1/obsidian-%E4%BD%BF%E7%94%A8%E6%95%99%E5%AD%B8-%E7%AD%86%E8%A8%98%E7%AF%87-01-%E4%BA%86%E8%A7%A3-obsidian-%E7%9A%84-metadata-f8602bbddade">【Obsidian 使用教學】筆記篇 01 — 了解 Obsidian 的 Metadata，建立一套可持續迭代的筆記系統&lt;/a>&lt;/p>
&lt;h2 id="metadata">Metadata&lt;/h2>
&lt;p>什麼是 Metadata([[metadata]])? 用於定義資的資料.
在 Markdown 中, 欄位可以自定義, 以我個人目前所需要的資料如下.&lt;/p>
&lt;h4 id="date">date&lt;/h4>
&lt;p>日期使用台灣時區, 格式如: &amp;quot;2023-06-26T13:55:19+0800&amp;quot;&lt;/p>
&lt;h4 id="title">title&lt;/h4>
&lt;p>表頭格式不限, 可使用中英文、數字、符號.&lt;/p>
&lt;h4 id="category">category&lt;/h4>
&lt;p>使用英文, 採用小駝峰格式, 分類只會有單一分類, 例如: blockChain.&lt;/p>
&lt;h4 id="tags">tags&lt;/h4>
&lt;p>使用英文, 採用蛇行格式, 標籤會有多個使用陣列表示, 陣列不留空白.
例如: [system-desing,distributed].&lt;/p>
&lt;h4 id="author">author&lt;/h4>
&lt;p>作者格式不限, 可使用中英文、數字、符號.&lt;/p>
&lt;h4 id="status">status&lt;/h4>
&lt;p>狀態可分為下面幾種, 是參考 &lt;a href="https://medium.com/pm%E7%9A%84%E7%94%9F%E7%94%A2%E5%8A%9B%E5%B7%A5%E5%85%B7%E7%AE%B1/obsidian-%E4%BD%BF%E7%94%A8%E6%95%99%E5%AD%B8-%E7%AD%86%E8%A8%98%E7%AF%87-04-%E5%9C%A8-obsidian-%E4%B8%AD%E5%AF%A6%E4%BD%9C-evergreen-note-%E7%9A%84%E6%A6%82%E5%BF%B5-cd776b051a0e">Evergreen Note&lt;/a> .&lt;/p>
&lt;p>🌱 發芽期: 筆記剛寫下, 對於裡面的內容還在消化理解
🌤 培育期: 重新複習一次筆記, 並對筆記進行內容摘要
🌲 長青期: 能將筆記內容精煉出一句話、一段句子&lt;/p>
&lt;h4 id="sourcetype">sourceType&lt;/h4>
&lt;p>筆記發起來源, 包括了下面幾種, 參考 &lt;a href="https://medium.com/pm%E7%9A%84%E7%94%9F%E7%94%A2%E5%8A%9B%E5%B7%A5%E5%85%B7%E7%AE%B1/%E5%A6%82%E4%BD%95%E6%95%B4%E7%90%86%E5%AD%B8%E7%BF%92%E7%AD%86%E8%A8%98-ad42796c9e08">如何整理學習筆記？分享我的學習筆記整理流程&lt;/a> .&lt;/p>
&lt;p>📚️: 實體書
📮: 社群貼文 (Facebook/Twitter/Instagram)
🎧️: Podcasts/音頻節目
▶️: YouTube
🎬: 網路課程
📰️: 網路文章
📜️: PDF/研究論文
💭️: 個人想法
🗣️: 聊天&lt;/p>
&lt;h4 id="sourceurl">sourceURL&lt;/h4>
&lt;p>筆記來源, 主要從哪邊的資訊來源&lt;/p></description></item><item><title>Design a distributed job scheduler</title><link>https://chiehting.com/posts/system-desing-distributed-job-scheduler/</link><pubDate>Tue, 27 Jun 2023 10:44:44 +0800</pubDate><guid>https://chiehting.com/posts/system-desing-distributed-job-scheduler/</guid><description>
&lt;p>文章主要在做系統設計, 使用排成系統做範例來設計分散式架構服務. 這邊從 &lt;em>需求-&amp;gt;規格分析-&amp;gt;系統架構-&amp;gt;軟體設計&lt;/em> 的脈絡來做演示.&lt;/p>
&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://medium.com/@raxshah/system-design-design-a-distributed-job-scheduler-kiss-interview-series-753107c0104c">System Design — Design a distributed job scheduler (KISS Interview series)&lt;/a>&lt;/li>
&lt;/ol>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>文章中, 作者規劃如何設計排程系統.&lt;/p>
&lt;p>首先分析排程系統的需求. 需求分成兩個面向, 其一為功能性, 列出系統該有的功能; 另一為非功能性但也相對重要的系統穩定度.&lt;/p>
&lt;p>再來依據規格, 期望一天有 100 萬 (or 1000 QPS) 個任務量, 來佐證這個量級的任務, 單台機器與單體式架構是不能使用的. 所以需要設計分散式架構.&lt;/p>
&lt;p>接著文章開始做整個排程系統的架構設計, 這邊文章中作者採用 &lt;code>poll tasks&lt;/code> 做撈取任務的機制, 也就是說任務排成設定的最小單位就是 &lt;code>poll tasks&lt;/code> 的單位.&lt;/p>
&lt;p>最後是設計排成軟體的細節,&lt;/p>
&lt;ul>
&lt;li>API 開了三個接口 &lt;code>submitJob&lt;/code> ，&lt;code>viewJob&lt;/code> 與 &lt;code>listJobs&lt;/code>.&lt;/li>
&lt;li>DB 這邊選用 NoSQL, 原因是在於規模、維護和成本方面有明顯優勢, 所以選擇使用 DynamoDb 的 NoSQL 解決方案.&lt;/li>
&lt;li>系統的穩定度需求, 設計成 HA 架構 與監控服務來保證. 但這邊也要注意 &lt;code>health checker service&lt;/code> 也是系統的一環, 若異常也會造成穩定度下降.&lt;/li>
&lt;li>檔案系統採用 S3 做異地儲存.&lt;/li>
&lt;/ul>
&lt;h3 id="note">Note&lt;/h3>
&lt;h4 id="introduction">Introduction&lt;/h4>
&lt;p>Job scheduling is a well known system design interview question. Below are some areas where one might need to design a job scheduler.&lt;/p>
&lt;ul>
&lt;li>Design a system for payment processing. (i.e. monthly/weekly/daily payout etc.)&lt;/li>
&lt;li>Design a code deployment system. (i.e. code pipeline)&lt;/li>
&lt;/ul>
&lt;h4 id="requirement">Requirement&lt;/h4>
&lt;p>功能性需求&lt;/p>
&lt;ul>
&lt;li>使用者可以安排任務與檢視任務.&lt;/li>
&lt;li>使用者可以檢視任務清單跟任務當前狀態.&lt;/li>
&lt;li>任務可以執行一次或多次. 且可以定義任務 X 時間後結束任務. (let x = 15 minutes)&lt;/li>
&lt;li>任務的執行時間不可抄錯超過 X 分鐘. (let x = 5 minutes)&lt;/li>
&lt;li>任務有權重配置, 權重高須比權限低的優先執行.&lt;/li>
&lt;li>任務結果需要儲存在檔案系統中.&lt;/li>
&lt;/ul>
&lt;p>非功能性需求&lt;/p>
&lt;ul>
&lt;li>高可用性, 系統任何時刻都可讓使用者做新增任務與檢視任務.&lt;/li>
&lt;li>可擴展性, 系統要可以擴展以容納數百萬的任務.&lt;/li>
&lt;li>可靠性, 如有多程序時, 系統在同一時間至少執行一次, 但不可重複執行.&lt;/li>
&lt;li>耐用性, 如果出現任何故障, 系統不應遺失任務訊息.&lt;/li>
&lt;li>即時性, 系統需立即納入使用者接受的任務. 使用者不需等待任務完成.&lt;/li>
&lt;/ul>
&lt;h4 id="traffic--storage-estimation-back-of-envelope-calculation">Traffic &amp;amp; Storage Estimation (Back of envelope calculation)&lt;/h4>
&lt;ul>
&lt;li>Total submitted jobs daily = 100 M (or 1000 QPS)&lt;/li>
&lt;/ul>
&lt;p>如果每個單獨的任務最多只可以執行 5 分鐘, 則可以看出 CPU 的限制.&lt;/p>
&lt;p>&lt;strong>CPU 限制&lt;/strong>&lt;/p>
&lt;p>假設使用的 CPU 為 16 核, 且每個核心可跑 2 個線程, 每個任務最多可以跑 5 分鐘.&lt;/p>
&lt;blockquote>
&lt;p># jobs can be executed by one machine = (16 cores * 2 threads)/ (5 minutes * 60) = &lt;strong>0.10 jobs per second&lt;/strong> (or ~8000 jobs per day)&lt;/p>
&lt;p># of machines needed to run 1000 QPS = 1000/0.10 = &lt;strong>10000&lt;/strong> (wow 😮 !)&lt;/p>
&lt;/blockquote>
&lt;p>也就是每一次可以執行 32 個 jobs, 且每個 job 執行 300 秒. 上面的公式等式如下.
$$ (16 * 2) * (24 * 60^2) / (5 * 60) = 9216 $$&lt;/p>
&lt;p>&lt;strong>Memory 限制&lt;/strong>&lt;/p>
&lt;p>假設使用 16 GB 的記憶體, 假設每個任務使用 5 MB 的記憶體&lt;/p>
&lt;blockquote>
&lt;p>A modern machine with 16 GB ram can hold up-to = (16 GB / (5 MB * 5 minutes * 60)) =&lt;strong>10 jobs per second&lt;/strong>&lt;/p>
&lt;p># of machines needed to run 1000 QPS = 1000 / 10= &lt;strong>100&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>架構分析&lt;/strong>&lt;/p>
&lt;p>分析上述的條件, 如果使用單機不可擴展的機器是不可能設計出排程系統, 結論是必須設計分散式架構系統&lt;/p>
&lt;h3 id="system-interface">System interface&lt;/h3>
&lt;p>Three APIs can be exposed to the user&lt;/p>
&lt;ol>
&lt;li>submitJob(api_key, user_id, job_schedule_time, job_type, priority, result_location)&lt;/li>
&lt;/ol>
&lt;p>Here, &lt;em>job_type = ONCE or RECURRING,&lt;/em> and &lt;em>result_location&lt;/em> could be s3 location&lt;/p>
&lt;p>API can return http response code 202 after accepting the job&lt;/p>
&lt;ol start="2">
&lt;li>viewJob(api_key, user_id, job_id)&lt;/li>
&lt;/ol>
&lt;p>Response includes the status as NOT_STARTED, STARTED or COMPLETED&lt;/p>
&lt;ol start="3">
&lt;li>listJobs(api_key, user_id, pagination_token)&lt;/li>
&lt;/ol>
&lt;p>User can query all jobs submitted, and a paginated response is returned&lt;/p></description></item><item><title>keep it simple stupid.!</title><link>https://chiehting.com/posts/keep-it-simple-stupid/</link><pubDate>Mon, 26 Jun 2023 13:38:19 +0800</pubDate><guid>https://chiehting.com/posts/keep-it-simple-stupid/</guid><description>
&lt;p>&lt;em>KISS&lt;/em> 全名為 &lt;code>Keep it simple, stupid!&lt;/code>, 在 &lt;a href="https://en.wikipedia.org/wiki/KISS_principle">Wiki&lt;/a> 上寫說為一種 &lt;strong>設計原則&lt;/strong>, 但個人體悟也為一種思考模式, 目的在於 &amp;quot;化繁為簡&amp;quot;. 這邊的 stupid 不是貶義詞, 是表示易於理解.&lt;/p>
&lt;p>在可能的情況下, 避免寫出複雜的邏輯、命名、結構、排版, 讓程式碼保持淺顯易懂.&lt;/p>
&lt;h3 id="範例">範例&lt;/h3>
&lt;h4 id="python-範例">python 範例&lt;/h4>
&lt;p>下面為計算 &lt;strong>購物車含稅總金額&lt;/strong> 的範例碼, 邏輯為將車裡的所有品項做加總.&lt;/p>
&lt;p>before&lt;/p>
&lt;p>可以看到修改前的邏輯為 &lt;strong>取物&lt;/strong> 後做 &lt;strong>計算&lt;/strong>, 並將每次的結果加入到總金額中.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">calculate_total_price&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cart&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">cart&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;quantity&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="n">price&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;price&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="n">quantity&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;quantity&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="n">tax&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;tax&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="n">discount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;discount&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">price&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">quantity&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">tax&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">discount&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">total&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>after&lt;/p>
&lt;p>修改後將 &lt;strong>取物&lt;/strong> 與 &lt;strong>計算&lt;/strong> 的邏輯拆成兩個函示, 保持函式的單一職責性.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">calculate_total_price&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cart&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">item&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">cart&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="n">total&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">calculate_item_price&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">total&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">calculate_item_price&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="n">price&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;price&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="n">quantity&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;quantity&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="n">tax&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;tax&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="n">discount&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;discount&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">price&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">quantity&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">tax&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">discount&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>The para mothed</title><link>https://chiehting.com/posts/what-is-the-para-method/</link><pubDate>Fri, 23 Jun 2023 02:28:08 +0800</pubDate><guid>https://chiehting.com/posts/what-is-the-para-method/</guid><description>
&lt;p>The PARA Method 是一種簡單且高效的數位資訊管理系統，它的目的是幫助人們有效地組織和管理數位資訊，從而提升工作效率並減輕資訊過載的壓力。&lt;/p>
&lt;p>主要是四個分類 &lt;code>Projects (專案)&lt;/code>、&lt;code>Areas (領域)&lt;/code>、&lt;code>Resources (資源)&lt;/code>、&lt;code>Archive (檔案)&lt;/code>，可以靈活調整細節，但核心原則是保持結構簡單且易於維護！&lt;/p>
&lt;p>&lt;strong>PARA&lt;/strong> 是以下四個分類的縮寫：&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>Projects (專案)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>包含你目前正在進行的、需要完成的目標或任務。&lt;/li>
&lt;li>例如：寫一篇報告、完成一個設計、策劃一場活動。&lt;/li>
&lt;li>專案是有明確目標和期限的。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Areas (領域)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>包含你需要負責的持續性責任或關注的領域，但沒有明確的期限。&lt;/li>
&lt;li>例如：健康管理、財務規劃、職業發展、家庭生活。&lt;/li>
&lt;li>這些領域是你生活中需要定期維護的部分。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Resources (資源)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>包含你感興趣的或可能在未來有用的參考資料或資訊。&lt;/li>
&lt;li>例如：學習筆記、文章收藏、書籍摘錄、教程資料。&lt;/li>
&lt;li>資源是支持你專案和領域的知識庫。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>Archive (檔案)&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>包含已完成的專案或不再活躍的資訊。&lt;/li>
&lt;li>例如：完成的報告、過期的活動計畫、舊的參考資料。&lt;/li>
&lt;li>這是用來存放過去的內容，方便未來查閱。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="para-的核心理念">PARA 的核心理念&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>專注於行動&lt;/strong>：將資訊根據用途分類，而不是根據來源（例如文件夾、應用程式）。&lt;/li>
&lt;li>&lt;strong>減少混亂&lt;/strong>：將資訊分為活躍（Projects, Areas, Resources）和非活躍（Archive）兩部分，避免資訊堆積。&lt;/li>
&lt;li>&lt;strong>靈活性&lt;/strong>：可以適用於不同的工具（如 Notion、Evernote、Google Drive 等）和不同的工作流。&lt;/li>
&lt;/ul>
&lt;h4 id="如何實施-para-method">如何實施 PARA Method&lt;/h4>
&lt;ol>
&lt;li>&lt;strong>整理你的數位資訊&lt;/strong>：
&lt;ul>
&lt;li>將所有文件、筆記、待辦事項等，分類到 Projects、Areas、Resources 或 Archive 中。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>定期檢查和更新&lt;/strong>：
&lt;ul>
&lt;li>每週或每月回顧你的專案和領域，確保它們是最新的。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>選擇適合的工具&lt;/strong>：
&lt;ul>
&lt;li>使用數位筆記應用程式（如 Notion、Obsidian）或雲端存儲工具（如 Google Drive）來實現 PARA 系統。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h3 id="實際應用">實際應用&lt;/h3>
&lt;p>假設我要在電腦科學的領域深耕，要如何規劃一個基於 PARA 方法論的資料夾結構。&lt;/p>
&lt;ul>
&lt;li>操作多個雲的應用項目&lt;/li>
&lt;li>做資料庫的操作與管理&lt;/li>
&lt;li>AI、ML 議題的研究&lt;/li>
&lt;li>我有 MySQL、Golang、AWS、Huawei、Terraform、Kubernetes、AI、ML 等等的研究項目。&lt;/li>
&lt;/ul>
&lt;h4 id="頂層資料夾">頂層資料夾&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/PARA
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> /Projects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> /Areas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> /Resources
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> /Archive
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="projects">Projects&lt;/h4>
&lt;p>&lt;strong>目標&lt;/strong>：存放當前正在進行的具體項目，這些項目是短期且有明確目標的。&lt;/p>
&lt;p>&lt;strong>資料夾結構&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">/Projects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> /CloudApp-Development
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> /Frontend
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> /Backend
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> /Infrastructure
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> /Database-Optimization
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> /MySQL-Tuning
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> /PostgreSQL-Indexing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> /AI-ML-Experimentation
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> /Image-Classification
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> /NLP-Chatbot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> /Kubernetes-Migration
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> /Cluster-Setup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> /Service-Migration
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>示例說明&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>CloudApp-Development&lt;/strong>：一個專注於多雲應用開發的項目，細分為前端、後端和基礎設施。&lt;/li>
&lt;li>&lt;strong>AI-ML-Experimentation&lt;/strong>：一個專注於 AI 和 ML 的實驗性項目，根據具體研究方向（如圖像分類、自然語言處理）進一步細分。&lt;/li>
&lt;/ul>
&lt;h4 id="areas">Areas&lt;/h4>
&lt;p>&lt;strong>目標&lt;/strong>：存放需要長期維護的專業領域或責任範疇，這些內容與你的專業方向緊密相關。&lt;/p>
&lt;p>&lt;strong>資料夾結構&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">/Areas
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> /Cloud-Computing
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> /AWS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> /Huawei
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> /Terraform
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> /Databases
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> /MySQL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> /PostgreSQL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> /MongoDB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> /AI-ML
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> /Deep-Learning
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> /Reinforcement-Learning
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> /Programming
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> /Golang
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> /Python
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> /Rust
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>示例說明&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Cloud-Computing&lt;/strong>：專注於雲端計算的研究和實踐，根據不同平台（如 AWS、Huawei）進行分類。&lt;/li>
&lt;li>&lt;strong>AI-ML&lt;/strong>：AI 和 ML 的長期研究方向，根據不同技術（如深度學習、強化學習）進行劃分。&lt;/li>
&lt;li>&lt;strong>Programming&lt;/strong>：長期學習和使用的程式語言，每種語言可存放相關的學習資源、工具或範例程式碼。&lt;/li>
&lt;/ul>
&lt;h4 id="resources">Resources&lt;/h4>
&lt;p>&lt;strong>目標&lt;/strong>：存放可以重複使用的參考資料、教程、工具文檔或學習資源。&lt;/p>
&lt;p>&lt;strong>資料夾結構&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">/Resources
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> /Books
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> /AI-Books
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> /Cloud-Computing-Books
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> /Tutorials
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> /Golang-Tutorials
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> /AWS-Tutorials
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> /Tools
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> /Terraform-Scripts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> /Kubernetes-Helm-Charts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> /Research-Papers
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> /AI-ML
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> /Databases
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>示例說明&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Books&lt;/strong>：電子書或 PDF 文件，根據主題分類。&lt;/li>
&lt;li>&lt;strong>Tools&lt;/strong>：常用工具的腳本或配置文件，例如 Terraform 腳本、Kubernetes Helm Charts。&lt;/li>
&lt;li>&lt;strong>Research-Papers&lt;/strong>：研究論文集合，按主題（如 AI/ML、資料庫）進一步劃分。&lt;/li>
&lt;/ul>
&lt;h4 id="archive檔案庫">&lt;strong>Archive（檔案庫）&lt;/strong>&lt;/h4>
&lt;p>&lt;strong>目標&lt;/strong>：存放已完成的項目或暫時不需要的資料，方便未來查閱。&lt;/p>
&lt;p>&lt;strong>資料夾結構&lt;/strong>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/Archive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> /Completed-Projects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> /Old-CloudApp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> /Legacy-Database-Scripts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> /Old-Resources
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> /Deprecated-Tools
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl"> /Archived-Books
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>示例說明&lt;/strong>：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Completed-Projects&lt;/strong>：存放已完成或關閉的項目。&lt;/li>
&lt;li>&lt;strong>Old-Resources&lt;/strong>：存放過時的資源或工具，供未來參考。&lt;/li>
&lt;/ul>
&lt;h3 id="問題">問題&lt;/h3>
&lt;p>在 PARA 系統中，&lt;strong>Areas&lt;/strong> 和 &lt;strong>Resources&lt;/strong> 是兩個核心的資料夾類別，它們的主要區別在於用途和內容的性質。&lt;/p>
&lt;h3 id="areas-與-resources-的主要區別">&lt;strong>Areas 與 Resources 的主要區別&lt;/strong>&lt;/h3>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;strong>特徵&lt;/strong>&lt;/th>
&lt;th>&lt;strong>Areas（領域）&lt;/strong>&lt;/th>
&lt;th>&lt;strong>Resources（資源）&lt;/strong>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;strong>目的&lt;/strong>&lt;/td>
&lt;td>維持某個領域的穩定性與標準&lt;/td>
&lt;td>提供支持或參考資料&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>性質&lt;/strong>&lt;/td>
&lt;td>動態、需要定期檢查與更新&lt;/td>
&lt;td>靜態、不需要頻繁更新&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>與角色的關聯性&lt;/strong>&lt;/td>
&lt;td>與你的生活或工作角色直接相關&lt;/td>
&lt;td>與角色無直接關聯，更多是主題性資料&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>使用方式&lt;/strong>&lt;/td>
&lt;td>持續管理，處理當前進行中的責任&lt;/td>
&lt;td>作為工具或參考資料，支持項目或領域&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;strong>範例&lt;/strong>&lt;/td>
&lt;td>健康管理、財務管理、專業技能&lt;/td>
&lt;td>書籍、教程、研究論文、工具模板&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;strong>如何正確分類 Areas 與 Resources&lt;/strong>&lt;/p>
&lt;p>以下是一些實際操作的建議，幫助你正確區分資料應該放在 Areas 還是 Resources：&lt;/p>
&lt;h4 id="1-問自己一個問題">&lt;strong>1. 問自己一個問題&lt;/strong>&lt;/h4>
&lt;ul>
&lt;li>&lt;strong>「這是我需要持續管理的責任嗎？」&lt;/strong>
&lt;ul>
&lt;li>如果答案是「是」，那麼它屬於 Areas。&lt;/li>
&lt;li>如果答案是「否」，那麼它屬於 Resources。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h4 id="2-具體情境分析">&lt;strong>2. 具體情境分析&lt;/strong>&lt;/h4>
&lt;ul>
&lt;li>&lt;strong>健康管理&lt;/strong>：
&lt;ul>
&lt;li>健康計畫（如運動紀錄、飲食追蹤）屬於 Areas，因為需要定期維護。&lt;/li>
&lt;li>健康相關的文章或運動指南屬於 Resources，因為這些是靜態參考資料。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>專業技能&lt;/strong>：
&lt;ul>
&lt;li>你正在學習的技能（如程式語言學習進度）屬於 Areas。&lt;/li>
&lt;li>教程、書籍或程式碼片段屬於 Resources。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h4 id="3-避免混淆">&lt;strong>3. 避免混淆&lt;/strong>&lt;/h4>
&lt;ul>
&lt;li>如果某個資料夾同時包含動態管理的內容和靜態參考資料，建議將它們拆分：
&lt;ul>
&lt;li>將動態內容放入 Areas。&lt;/li>
&lt;li>將靜態內容放入 Resources。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></description></item><item><title>The para mothed</title><link>https://chiehting.com/posts/%E5%A6%82%E4%BD%95%E5%88%86%E9%A1%9E%E7%AD%86%E8%A8%98%E4%B8%80%E5%A5%97%E7%B0%A1%E5%96%AE%E5%8F%88%E9%80%9A%E7%94%A8%E7%9A%84%E5%88%86%E9%A1%9E%E6%9E%B6%E6%A7%8B-para/</link><pubDate>Fri, 23 Jun 2023 02:28:08 +0800</pubDate><guid>https://chiehting.com/posts/%E5%A6%82%E4%BD%95%E5%88%86%E9%A1%9E%E7%AD%86%E8%A8%98%E4%B8%80%E5%A5%97%E7%B0%A1%E5%96%AE%E5%8F%88%E9%80%9A%E7%94%A8%E7%9A%84%E5%88%86%E9%A1%9E%E6%9E%B6%E6%A7%8B-para/</guid><description>
&lt;p>文章中 &lt;a href="https://medium.com/pm%E7%9A%84%E7%94%9F%E7%94%A2%E5%8A%9B%E5%B7%A5%E5%85%B7%E7%AE%B1/%E5%A6%82%E4%BD%95%E5%88%86%E9%A1%9E%E7%AD%86%E8%A8%98-e25c4cc39dba">如何分類筆記？一套簡單又通用的分類架構-PARA&lt;/a> 說講述了筆記分類碰到的問題，以及如何應用 PARA 的分類架構來解決問題。&lt;/p>
&lt;h3 id="para--架構">PARA 架構&lt;/h3>
&lt;p>PARA 是由四個單字組成的，如下：&lt;/p>
&lt;ul>
&lt;li>Projects&lt;/li>
&lt;li>Areas of responsibility (下方講解均簡稱 Area)&lt;/li>
&lt;li>Resources&lt;/li>
&lt;li>Archives&lt;/li>
&lt;/ul>
&lt;p>這套架構是由生產力專家 — Tiago Forte 所提出，有以下 5 點特色讓作者覺得很棒：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>泛用性&lt;/strong>：適用在任何型態的資源，你不但可以用在筆記軟體、也可以用在雲端硬碟、個人電腦的檔案分類。&lt;/li>
&lt;li>&lt;strong>行動性&lt;/strong>：筆記不再只是死板的資訊，而是可以讓你知道下一步的行動是什麼。&lt;/li>
&lt;li>&lt;strong>產出導向&lt;/strong>：分類的目標是提升你的產出能力。&lt;/li>
&lt;li>&lt;strong>可縮放性&lt;/strong>：可以讓你依據需求調整檢視筆記內容的顆粒度，可以快速總覽也可以深入細節。&lt;/li>
&lt;li>&lt;strong>機動性&lt;/strong>：可直接從既有的筆記開始使用，不需要大幅顛覆整個既有的筆記系統。&lt;/li>
&lt;/ul>
&lt;h3 id="筆記的可行動性-actionable">筆記的可行動性 (actionable)&lt;/h3>
&lt;p>我們寫下的筆記，只有少數的筆記我們會花時間更新與維護 ; 而大多數都不會再被看第二遍，更不用說在上面記錄待辦清單、思考過程。&lt;/p>
&lt;p>然而人的專注力是有限制的。在現實生活中，我一段時間 ( 2–3 個月) 只能專注在 1–3 個子專案，其他的子專案筆記可能 1 個月都不會開啟一次。&lt;/p>
&lt;p>上述的結果會讓筆記的維護性變低；資料內容變舊，不容易讓知識累積。&lt;/p>
&lt;h3 id="作者心得">作者心得&lt;/h3>
&lt;p>這篇文章快速地介紹了 PARA 這套筆記架構。就算已經有自己的分類方式，但想要讓自己的筆記更有行動力，也可以採用 PARA 的架構做分類。&lt;/p>
&lt;p>在文章的一開頭提到了 PARA 的 5 個特點：&lt;/p>
&lt;ul>
&lt;li>&lt;strong>泛用性&lt;/strong>：適用在任何型態的資源，你不但可以用在筆記軟體、也可以用在雲端硬碟、個人電腦的檔案分類。&lt;/li>
&lt;li>&lt;strong>行動性&lt;/strong>：筆記不再只是死板的資訊，而是可以讓你知道下一步的行動是什麼。&lt;/li>
&lt;li>&lt;strong>產出導向&lt;/strong>：分類的目標是提升你的產出能力。&lt;/li>
&lt;li>&lt;strong>可縮放性&lt;/strong>：可以讓你依據需求調整檢視筆記內容的顆粒度，可以快速總覽也可以深入細節。&lt;/li>
&lt;li>&lt;strong>可立即開始的&lt;/strong>：可直接從既有的筆記開始使用，不需要大幅顛覆整個既有的筆記系統。&lt;/li>
&lt;/ul></description></item><item><title>比較 SSL Certificates 的驗證效率</title><link>https://chiehting.com/posts/kubernetes-compare-ssl-speed/</link><pubDate>Wed, 01 Mar 2023 14:27:00 +0800</pubDate><guid>https://chiehting.com/posts/kubernetes-compare-ssl-speed/</guid><description>
&lt;p>由於調整 DNS namespace 由 Cloudflare 改為 Amazon Route 53，做架構調整，這將會影響到 SSL Certificates 的申請。&lt;/p>
&lt;p>而原本就有 AWS Certificate Manager (ACM)，申請好的憑證可以跟 Amazon Route 53 做整合；
而現有的憑證管理方式是 Cloudflare + cert-manager。&lt;/p>
&lt;p>所以想要知道哪種架構的效率較好。&lt;/p>
&lt;h3 id="分析結果">分析結果&lt;/h3>
&lt;p>就分析報告來看，將 &amp;quot;SSL verifiation&amp;quot; 的工作放在 Ingress-NGINX 效率較好。&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2023-03-01-compare-the-authentication-efficiency-of-ssl-certificates-4.png" alt="Response Time Percentiles">&lt;/p>
&lt;h3 id="架構變更">架構變更&lt;/h3>
&lt;p>原本是使用 Cloudflare DNS01 challenge，透過 cert-manager([[using-ssl-certificates-on-kubernetes-ingress-via-cert-manager]]) 申請憑證；改為使用 ACM + Amazon Route 53 管理。&lt;/p>
&lt;p>架構為調整，將 &amp;quot;SSL verifiation&amp;quot; 由 Ingress-NGINX 改到 Network Load balancers。&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2023-03-01-compare-the-authentication-efficiency-of-ssl-certificates-1.png" alt="architecture">&lt;/p>
&lt;h3 id="jmeter-測試">Jmeter 測試&lt;/h3>
&lt;p>測試條件如下為: 總共循環 20 次，間隔 10 秒；每次觸發會有 10 個 threads；每個 thread 會請求發送一次請求。&lt;/p>
&lt;p>所以一次測試會有 &lt;code>20 * 10 = 200&lt;/code> 個取樣。&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2023-03-01-compare-the-authentication-efficiency-of-ssl-certificates-3.png" alt="summary">&lt;/p>
&lt;h4 id="報告靜態檔">報告靜態檔&lt;/h4>
&lt;p>&lt;a href="https://storage.googleapis.com/chiehting.com/blog/2023-03-01-compare-the-authentication-efficiency-of-ssl-certificates-2/index.html">jmeter report&lt;/a>&lt;/p></description></item><item><title>Set the Domain's record to the CoreDNS</title><link>https://chiehting.com/posts/kubernetes-add-domain-record-to-coredns/</link><pubDate>Thu, 19 Jan 2023 12:20:00 +0800</pubDate><guid>https://chiehting.com/posts/kubernetes-add-domain-record-to-coredns/</guid><description>
&lt;p>這兩天在處理 DNS 的問題, 看到可以直接在 CoreDNS 中塞 record。&lt;/p>
&lt;p>Kubernetes 官方文件 &lt;a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-custom-nameservers/">dns custom nemeservers&lt;/a> 有寫到配置方式&lt;/p>
&lt;h3 id="多配置-dns-server">多配置 DNS Server&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">kubectl edit configmap coredns -n kube-system
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>下面為配置 db.example.com.tw 的 dns 範例&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="l">.:53 {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">errors&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">health&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">kubernetes cluster.local in-addr.arpa ip6.arpa {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">pods insecure&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">fallthrough in-addr.arpa ip6.arpa&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">prometheus :9153&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">forward . /etc/resolv.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">cache 30&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">loop&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">reload&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">loadbalance&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">db.example.com.tw:53 {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">errors&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">cache 30&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">forward . 192.168.1.130&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">reload&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="配置-hosts">配置 hosts&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="l">.:53 {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">errors&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">health&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">kubernetes cluster.local in-addr.arpa ip6.arpa {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">pods insecure&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">fallthrough in-addr.arpa ip6.arpa&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">hosts {&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="m">127.0.0.1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="p">::&lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">localhost&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="m">10.1.2.3&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">abc.example.com&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">fallthrough&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># If you want to pass the request to the rest of the plugin chain if there is no match in the _hosts_ plugin, you must specify the `fallthrough` option.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">prometheus :9153&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">forward . /etc/resolv.conf&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">cache 30&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">loop&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">reload&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">loadbalance&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>}&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="同時配置時">同時配置時&lt;/h3>
&lt;p>若同時配置時, 則會以 DNS Server 為優先.&lt;/p>
&lt;h3 id="禁止-coredns-對-ipv6-類型的-aaaa-紀錄查詢返回">禁止 CoreDNS 對 IPv6 類型的 AAAA 紀錄查詢返回&lt;/h3>
&lt;p>當業務容器不需要AAAA記錄類型時，可以在CoreDNS中將AAAA記錄類型攔截並返回空值（NODATA），以減少不必要的網路通信。示例配置如下：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nt">Corefile&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">|&lt;/span>&lt;span class="sd">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="sd"> .:53 {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="sd"> errors
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="sd"> health {
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="sd"> lameduck 15s
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="sd"> }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="sd"> #新增以下一行Template插件，其它数据请保持不变。
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">&lt;span class="sd"> template IN AAAA .
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">&lt;span class="sd"> }&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>How to send log from AWS eks to cloudwatch.</title><link>https://chiehting.com/posts/kubernetes-send-log-to-cloudwatch/</link><pubDate>Thu, 24 Nov 2022 10:00:00 +0800</pubDate><guid>https://chiehting.com/posts/kubernetes-send-log-to-cloudwatch/</guid><description>
&lt;p>研究如何使用 AWS 的 CloudWatch 來收集 EKS 的 log. 並使用 Grafana 做 log search.&lt;/p>
&lt;p>原本的 logging architecture 是使用 Elasticsearch + Filebeat + Kibana; 現在改用 AWS CloudWatch + Fluent Bit + Grafana.&lt;/p>
&lt;h3 id="問題描述">問題描述&lt;/h3>
&lt;p>原架構為 Elasticsearch + Filebeat + Kibana, 基於下述狀況決定改架構, 來減少維護成本.&lt;/p>
&lt;ul>
&lt;li>目前開發使用情境, 之需要查看 log 且可以搜尋, 不需要做資料探勘. 殺雞用牛刀了.&lt;/li>
&lt;li>Elasticsearch 在 Basic License 下, 無法使用 LDAP, PKI3, Active Directory authentication 功能.&lt;/li>
&lt;li>Elasticsearch &lt;a href="https://www.elastic.co/guide/en/cloud-enterprise/current/ece-hardware-prereq.html">硬體需求&lt;/a>較高, 最低的硬體需求為 t2.large (2 vCPU, 8 Mem).&lt;/li>
&lt;li>Elasticsearch 使用門檻較高, 能維護的人員不多, 維護上困難.&lt;/li>
&lt;/ul>
&lt;h3 id="日誌蒐集狀況">日誌蒐集狀況&lt;/h3>
&lt;h4 id="index-lifecycle-management-配置">Index lifecycle Management 配置&lt;/h4>
&lt;p>取 kubernetes 的 ilm 配置, 看到熱資料配置為 20gb or 15d 做 rollover.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">elasticsearch:/opt$ curl -XGET --user &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$account&lt;/span>&lt;span class="s2">:&lt;/span>&lt;span class="nv">$password&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;http://&lt;/span>&lt;span class="nv">$host&lt;/span>&lt;span class="s2">/_ilm/policy/kubernetes?pretty&amp;#34;&lt;/span>&lt;span class="p">|&lt;/span>jq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;kubernetes&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;version&amp;#34;&lt;/span> : 23,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;modified_date&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;2021-07-07T07:58:49.033Z&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;policy&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;phases&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> ..................
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;hot&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;min_age&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;0ms&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;actions&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;rollover&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;max_primary_shard_size&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;20gb&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;max_age&amp;#34;&lt;/span> : &lt;span class="s2">&amp;#34;15d&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;forcemerge&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;max_num_segments&amp;#34;&lt;/span> : &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;readonly&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;shrink&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;number_of_shards&amp;#34;&lt;/span> : &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;set_priority&amp;#34;&lt;/span> : &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;priority&amp;#34;&lt;/span> : &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> ..................
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="資料使用量">資料使用量&lt;/h4>
&lt;p>目前資料使用量為 167G (./elasticsearch/data).&lt;/p>
&lt;p>取其中一個 site 的 production 環境資料,平均 index 約 9.62 GB.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">curl -XGET --user &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$account&lt;/span>&lt;span class="s2">:&lt;/span>&lt;span class="nv">$password&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;http://&lt;/span>&lt;span class="nv">$host&lt;/span>&lt;span class="s2">/_cat/indices/*prod*?v=true&amp;amp;pretty&amp;amp;s=index&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">health status index uuid pri rep docs.count docs.deleted store.size pri.store.size
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">green open kubernetes-prod-000039 co5bX1YqSOu11BaKVkUnKw &lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">10075181&lt;/span> &lt;span class="m">0&lt;/span> 6.5gb 6.5gb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">green open shrink-arvp-kubernetes-prod-000036 tgcGQwEZSliq9H2R4QJDCQ &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">16602612&lt;/span> &lt;span class="m">0&lt;/span> 10gb 10gb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">green open shrink-kvlp-kubernetes-prod-000038 g0if66MHTDmyWm4vcuX9cw &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">15674075&lt;/span> &lt;span class="m">0&lt;/span> 9.7gb 9.7gb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">green open shrink-laqk-kubernetes-prod-000035 FxLNQzpjQRKjsz_H8Vkl5w &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">20661224&lt;/span> &lt;span class="m">0&lt;/span> 12.7gb 12.7gb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">green open shrink-ttkl-kubernetes-prod-000037 DpeVcQVgTg-VKfOykWkN3Q &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">15092948&lt;/span> &lt;span class="m">0&lt;/span> 9.2gb 9.2gb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="執行">執行&lt;/h3>
&lt;p>照著 AWS 教學文件 &lt;a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-logs-FluentBit.html">Set up Fluent Bit as a DaemonSet to send logs to CloudWatch Logs&lt;/a> 實作.&lt;/p>
&lt;h4 id="create-aws-cloudwatch-logs">Create AWS CloudWatch Logs&lt;/h4>
&lt;p>首先需要建立 AWS CloudWatch 的 Log groups for log stream. 其中 &lt;code>Cluster_Name&lt;/code> 為 EKS cluster 名稱.&lt;/p>
&lt;ul>
&lt;li>/aws/containerinsights/&lt;code>Cluster_Name&lt;/code>/application&lt;/li>
&lt;li>/aws/containerinsights/&lt;code>Cluster_Name&lt;/code>/host&lt;/li>
&lt;li>/aws/containerinsights/&lt;code>Cluster_Name&lt;/code>/dataplane&lt;/li>
&lt;/ul>
&lt;p>在這邊使用 Terraform &lt;a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/cloudwatch_log_group">aws_cloudwatch_log_group&lt;/a> 來實作.&lt;/p>
&lt;h4 id="quick-start-setup-for-container-insights-on-amazon-eks-and-kubernetes">Quick Start setup for Container Insights on Amazon EKS and Kubernetes&lt;/h4>
&lt;h5 id="配置-iam-權限-eks-的-node-iam-role-需含下面權限">配置 IAM 權限. EKS 的 Node IAM role 需含下面權限&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-terraform" data-lang="terraform">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kr">data&lt;/span> &lt;span class="s2">&amp;#34;aws_iam_policy_document&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;eks_node_group_cloudwatch_role&amp;#34;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nx">statement&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="na">actions&lt;/span> = &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;logs:CreateLogStream&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;logs:CreateLogGroup&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;logs:DescribeLogStreams&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;logs:PutLogEvents&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="na">effect&lt;/span> = &lt;span class="s2">&amp;#34;Allow&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="na">resources&lt;/span> = &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>接著按照文件 &lt;a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/Container-Insights-setup-EKS-quickstart.html">Quick Start setup for Container Insights on Amazon EKS and Kubernetes&lt;/a> 安裝 DaemonSet of Fluent Bit.&lt;/p>
&lt;h5 id="建立-kubernetes-namespace">建立 kubernetes namespace&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">kubectl apply -f https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/cloudwatch-namespace.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="執行-fluent-bityaml">執行 fluent-bit.yaml&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">ClusterName&lt;/span>&lt;span class="o">=&lt;/span>production
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">RegionName&lt;/span>&lt;span class="o">=&lt;/span>us-east-1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="nv">FluentBitHttpPort&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;2020&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="nv">FluentBitReadFromHead&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;Off&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="o">[[&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitReadFromHead&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;On&amp;#39;&lt;/span> &lt;span class="o">]]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">FluentBitReadFromTail&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;Off&amp;#39;&lt;/span>&lt;span class="o">||&lt;/span> &lt;span class="nv">FluentBitReadFromTail&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;On&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="o">[[&lt;/span> -z &lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitHttpPort&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="o">]]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">FluentBitHttpServer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;Off&amp;#39;&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nv">FluentBitHttpServer&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;On&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">curl https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/k8s-deployment-manifest-templates/deployment-mode/daemonset/container-insights-monitoring/quickstart/cwagent-fluent-bit-quickstart.yaml &lt;span class="p">|&lt;/span> sed &lt;span class="s1">&amp;#39;s/{{cluster_name}}/&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">ClusterName&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;/;s/{{region_name}}/&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">RegionName&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;/;s/{{http_server_toggle}}/&amp;#34;&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitHttpServer&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;/;s/{{http_server_port}}/&amp;#34;&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitHttpPort&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;/;s/{{read_from_head}}/&amp;#34;&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitReadFromHead&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;/;s/{{read_from_tail}}/&amp;#34;&amp;#39;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">FluentBitReadFromTail&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&amp;#34;/&amp;#39;&lt;/span> &lt;span class="p">|&lt;/span> kubectl apply -f -
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="調整-application-logconf">調整 application-log.conf&lt;/h5>
&lt;p>由於有做 healthcheck, 所以在 log 希望可以過濾掉 healthcheck 的資料.&lt;/p>
&lt;p>需要再 application-log.conf 中加入下面資訊&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">[FILTER]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> Name grep
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> Match application.*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> Exclude log /.*healthcheck.*/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">kubectl edit configmap/fluent-bit-config -n amazon-cloudwatch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="使用-grafana-做-dashborad">使用 Grafana 做 Dashborad&lt;/h4>
&lt;h5 id="帳戶管理-ldap">帳戶管理 LDAP&lt;/h5>
&lt;p>上面提到痛點之一就是帳戶無法統一管理, 容易遺漏. 這邊 Grafana 原生就提供 LDAP 的功能.&lt;/p>
&lt;p>確認 LDAP 功能有 enable, 在 &lt;code>/usr/share/grafana/conf/defaults.ini&lt;/code>.
這邊以 &lt;code>image: grafana/grafana:8.3.1&lt;/code> 為例, 編輯 &lt;code>/usr/share/grafana/conf/ldap.toml&lt;/code> 檔案.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-toml" data-lang="toml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">[[&lt;/span>&lt;span class="nx">servers&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="nx">host&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;ldap.example.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="nx">port&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">389&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="nx">use_ssl&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="nx">start_tls&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="nx">ssl_skip_verify&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">false&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="nx">bind_dn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;uid=uid,cn=users,cn=accounts,dc=example,dc=com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="nx">bind_password&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s1">&amp;#39;passowrd&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="nx">search_filter&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;(uid=%s)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="nx">search_base_dns&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;cn=users,cn=accounts,dc=example,dc=com&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="nx">servers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">attributes&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="nx">name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;givenName&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="nx">surname&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;sn&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="nx">username&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;uid&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="nx">member_of&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;memberOf&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="nx">email&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;email&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="p">[[&lt;/span>&lt;span class="nx">servers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">group_mappings&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="nx">group_dn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;cn=admins,cn=groups,cn=accounts,dc=example,dc=com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="nx">org_role&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Admin&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="p">[[&lt;/span>&lt;span class="nx">servers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">group_mappings&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="nx">group_dn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;cn=groups,ou=accounts,dc=example,dc=com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="nx">org_role&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Editor&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="p">[[&lt;/span>&lt;span class="nx">servers&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">group_mappings&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">&lt;span class="nx">group_dn&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="nx">org_role&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Viewer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="create-data-source">Create Data Source&lt;/h4>
&lt;p>進到 Grafana 中的 Data Source, 加入 CloudWatch 源.&lt;/p>
&lt;h3 id="完成效果">完成效果&lt;/h3>
&lt;p>完成後會在 AWS CloudWatch 的 log groups 有接收到 log streams.&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2022-11-24-how-to-send-eks-log-to-cloudwatch-1.png" alt="AWS CloudWatch Logs Insights">&lt;/p>
&lt;p>在 Grafana 中建立 Dashboard.&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2022-11-24-how-to-send-eks-log-to-cloudwatch-2.png" alt="Grafana Dashboard">&lt;/p>
&lt;h4 id="結論">結論&lt;/h4>
&lt;p>上面提到的問題, 改了架構後做觀察.&lt;/p>
&lt;blockquote>
&lt;p>目前開發使用情境, 之需要查看 log 且可以搜尋, 不需要做 log 分析..&lt;/p>
&lt;/blockquote>
&lt;p>這邊換了架構對開發並無影響. (開發沒過多反應, 平時有在使用嗎?)&lt;/p>
&lt;blockquote>
&lt;p>Elasticsearch 在 Basic License 下, 無法使用 LDAP, PKI3, Active Directory authentication 功能.&lt;/p>
&lt;/blockquote>
&lt;p>這邊改用 Grafana 的 LDAP 功能做改善, 帳密的管理統一, 維護上變簡單.&lt;/p>
&lt;blockquote>
&lt;p>Elasticsearch 硬體需求較高, 為 t2.large (2 vCPU, 8 Mem).&lt;/p>
&lt;/blockquote>
&lt;p>原本 t2.large, 使用 AWS 計算機算出的費用約 108.96 USD/Monthly cost
更改 CloudWatch, 收到的費用為 108.96 USD/Monthly cost (這邊為所有 groups 的費用, 包括 application, EKS, RDS 等)&lt;/p>
&lt;p>這邊比較尷尬, 由於兩邊收集的 log 量不同, 不容易比較.&lt;/p>
&lt;blockquote>
&lt;p>Elasticsearch 能維護的人員不多, 維護上困難.&lt;/p>
&lt;/blockquote>
&lt;p>在寫這篇文章的同時, 也看到一些新的 index 配置並無做優化. 相關配置也已經被動到. 很難受.&lt;br/>
改新架構後維護應該要變簡單, 因為不用去搞 index 跟 ilm.&lt;/p></description></item><item><title>FreeIPA certificate renews problem</title><link>https://chiehting.com/posts/freeipa-cert-renews-problem/</link><pubDate>Thu, 19 May 2022 15:00:00 +0800</pubDate><guid>https://chiehting.com/posts/freeipa-cert-renews-problem/</guid><description>
&lt;p>近期 FreeIPA SSL 憑證過期了，這邊憑證是自動跟 Let's Encrypt 重新申請，過期了代表出現異常。在這邊紀錄處理過程。&lt;/p>
&lt;h3 id="憑證過期了想說重新申請">憑證過期了想說重新申請&lt;/h3>
&lt;p>更新憑證前先把中間憑證裝起來，但在做 &lt;code>ipa-certupdate&lt;/code> 時發生錯誤。
跟我說 &lt;code>certificate verify failed&lt;/code>，這邊沒有講失敗的原因，我猜測是前端 https 憑證過期了，所以先手動更換 httpd 的憑證。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ldap script&lt;span class="o">]&lt;/span>&lt;span class="c1"># ipa-certupdate -v&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">・・・・・
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">ipapython.admintool: DEBUG: The ipa-certupdate &lt;span class="nb">command&lt;/span> failed, exception: NetworkError: cannot connect to &lt;span class="s1">&amp;#39;https://ldap.example.com/ipa/json&amp;#39;&lt;/span>: &lt;span class="o">[&lt;/span>SSL: CERTIFICATE_VERIFY_FAILED&lt;span class="o">]&lt;/span> certificate verify failed &lt;span class="o">(&lt;/span>_ssl.c:897&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">ipapython.admintool: ERROR: cannot connect to &lt;span class="s1">&amp;#39;https://ldap.example.com/ipa/json&amp;#39;&lt;/span>: &lt;span class="o">[&lt;/span>SSL: CERTIFICATE_VERIFY_FAILED&lt;span class="o">]&lt;/span> certificate verify failed &lt;span class="o">(&lt;/span>_ssl.c:897&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">ipapython.admintool: ERROR: The ipa-certupdate &lt;span class="nb">command&lt;/span> failed.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="手動更換-httpd-的憑證">手動更換 httpd 的憑證&lt;/h3>
&lt;p>先去跟 Let's Encrypt 重新申請憑證（使用 dns 認證方式），然後將憑證換上並重啟。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ldap script&lt;span class="o">]&lt;/span>&lt;span class="c1"># printf &amp;#34;\n\n&amp;#34;|ipa-server-certinstall -w -d /etc/letsencrypt/live/${IPA_SERVER_HOSTNAME}/privkey.pem /etc/letsencrypt/live/${IPA_SERVER_HOSTNAME}/cert.pem&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Directory Manager password:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">Enter private key unlock password:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">Please restart ipa services after installing certificate &lt;span class="o">(&lt;/span>ipactl restart&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">The ipa-server-certinstall &lt;span class="nb">command&lt;/span> was successful
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ldap script&lt;span class="o">]&lt;/span>&lt;span class="c1"># restorecon -v /var/lib/ipa/certs/httpd.crt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ldap script&lt;span class="o">]&lt;/span>&lt;span class="c1"># ipactl restart&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">ipa: INFO: The ipactl &lt;span class="nb">command&lt;/span> was successful
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ldap script&lt;span class="o">]&lt;/span>&lt;span class="c1"># ipactl status&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">ipa: INFO: The ipactl &lt;span class="nb">command&lt;/span> was successful
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="錯誤-gost_yescrypt_pwd_storage_scheme_init">錯誤 gost_yescrypt_pwd_storage_scheme_init&lt;/h3>
&lt;p>Directory Service 啟動失敗&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ldap:/opt/freeipa/build&lt;span class="o">]&lt;/span>&lt;span class="c1"># docker exec -it ldap.example.com systemctl status dirsrv@HEARTS-TW.service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">ERR - symload_report_error - Netscape Portable Runtime error-5975: /usr/lib64/dirsrv/plugins/libpwdstorage-plugin.so: undefined symbol: gost_yescrypt_pwd_storage_scheme_init
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># seems like a &amp;#34;fix&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ldap:/opt/freeipa/build&lt;span class="o">]&lt;/span>&lt;span class="c1"># docker exec -it ldap.example.com dnf downgrade 389-ds-base*&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="錯誤-更新異常">錯誤 更新異常&lt;/h3>
&lt;p>由於啟動會執行 &lt;code>ipa-server-upgrade&lt;/code> 出錯後，資料就毀損了，所以先停止啟動自動更新。&lt;/p>
&lt;p>FreeIPA 的 docker image 中，Entrypoint 是設置 &lt;code>/usr/local/sbin/init&lt;/code>。
將檔案複製出來並將下面改寫，重啟並使用改寫後的 Entrypoint 檔案。&lt;/p>
&lt;p>移除 exec 中的 &lt;code>$SYSTEMD_OPTS&lt;/code> 參數。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@ldap /&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat /usr/local/sbin/init | grep SYSTEMD_OPTS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="nv">SYSTEMD_OPTS&lt;/span>&lt;span class="o">=&lt;/span>--unit&lt;span class="o">=&lt;/span>ipa-server-upgrade.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="nb">exec&lt;/span> /usr/sbin/init --show-status&lt;span class="o">=&lt;/span>&lt;span class="nb">false&lt;/span> &lt;span class="nv">$SYSTEMD_OPTS&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="操作時查到的指令確認憑證清單">操作時查到的指令，確認憑證清單&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">getcert list &lt;span class="p">|&lt;/span> egrep &lt;span class="s1">&amp;#39;^Request|status:|subject:&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">certutil -L -d /etc/pki/pki-tomcat/alias
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">certutil -L -d /etc/ipa/nssdb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Setup FreeIPA client on Ubuntu</title><link>https://chiehting.com/posts/freeipa-ssh-with-ldap/</link><pubDate>Wed, 19 Jan 2022 15:43:00 +0800</pubDate><guid>https://chiehting.com/posts/freeipa-ssh-with-ldap/</guid><description>
&lt;p>開發者有需求要連線至 server via ssh, 一般情況下需要在 server 中建立帳號並配置金鑰.
但目前公司的人員管理政策是使用 FreeIPA 做管理, 所以不想要另外在 server 建立帳號, 造成管理複雜.&lt;/p>
&lt;p>所以這採用的解決方案是使用 freeipa-client 套件, 讓主機跟 FreeIPA 做人員權限認證.&lt;/p>
&lt;h3 id="install-freeipa-client-package">Install FreeIPA client package&lt;/h3>
&lt;p>server OS is Ubuntu 20.04.&lt;/p>
&lt;p>在開始前, 先更新主機套件, 讓軟體升級到最新.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@edge:/root# apt-get update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">root@edge:/root# apt-get upgrade
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>確認防火牆是否有開通, 規則如下.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">Please make sure the following ports are opened in the firewall settings:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">TCP: 80, 88, 389
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">UDP: 88 (at least one of TCP/UDP ports 88 has to be open)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">Also note that following ports are necessary for ipa-client working
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">properly after enrollment:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">TCP: 464
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">UDP: 464, 123 (if NTP enabled)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>安裝 &amp;amp; 配置 freeipa-client 套件.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@edge:/root# apt-get install -y freeipa-client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">root@edge:/root# ipa-client-install --hostname&lt;span class="o">=&lt;/span>&lt;span class="sb">`&lt;/span>hostname -f&lt;span class="sb">`&lt;/span> --mkhomedir --server&lt;span class="o">=&lt;/span>ldap.example.com --domain example.com --realm EXAMPLE.COM
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">WARNING: conflicting time&lt;span class="p">&amp;amp;&lt;/span>date synchronization service &lt;span class="s1">&amp;#39;ntp&amp;#39;&lt;/span> will be disabled
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">in favor of chronyd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">Autodiscovery of servers &lt;span class="k">for&lt;/span> failover cannot work with this configuration.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">If you proceed with the installation, services will be configured to always access the discovered server &lt;span class="k">for&lt;/span> all operations and will not fail over to other servers in &lt;span class="k">case&lt;/span> of failure.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">Proceed with fixed values and no DNS discovery? &lt;span class="o">[&lt;/span>no&lt;span class="o">]&lt;/span>: yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">Client hostname: edge.example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">Realm: EXAMPLE.COM
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">DNS Domain: example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">IPA Server: ldap.example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">BaseDN: &lt;span class="nv">dc&lt;/span>&lt;span class="o">=&lt;/span>example,dc&lt;span class="o">=&lt;/span>com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">Continue to configure the system with these values? &lt;span class="o">[&lt;/span>no&lt;span class="o">]&lt;/span>: yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">Synchronizing &lt;span class="nb">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">No SRV records of NTP servers found and no NTP server or pool address was provided.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">Using default chrony configuration.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">Attempting to sync &lt;span class="nb">time&lt;/span> with chronyc.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">Time synchronization was successful.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">User authorized to enroll computers: admin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">Password &lt;span class="k">for&lt;/span> admin@EXAMPLE.COM:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">・・・
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">The ipa-client-install &lt;span class="nb">command&lt;/span> was successful
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="setup-policy">Setup policy&lt;/h3>
&lt;p>安裝完成後, 登入 FreeIPA website 在 Host 可以看到已經有新增剛剛那台主機.&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2022-01-19-install-freeipa-client-on-ubuntu-1.png" alt="hosts">&lt;/p>
&lt;p>接著到 Policy 裡面配置 HBAC Rules, 建議 disable allow_all 關閉預設允許全部用戶訪問.
再來新增一個權限 &lt;code>allow_edge&lt;/code>, 預計讓開發可以進入到邊緣節點.&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2022-01-19-install-freeipa-client-on-ubuntu-2.png" alt="hbac-rules">&lt;/p>
&lt;p>接著配置 HBAC, &amp;quot;Who&amp;quot; 可以操作哪些 &amp;quot;Accessing&amp;quot; 的 &amp;quot;Service&amp;quot;, 以下圖的範例為：&lt;/p>
&lt;ol>
&lt;li>backend group 可以操作 edge.example.com 的 login&lt;/li>
&lt;li>backend group 可以操作 edge.example.com 的 sshd&lt;/li>
&lt;li>admins group 可以操作 edge.example.com 的 login&lt;/li>
&lt;li>admins group 可以操作 edge.example.com 的 sshd&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2022-01-19-install-freeipa-client-on-ubuntu-3.png" alt="policys">&lt;/p>
&lt;p>完成後可測試 ssh login, 看使否可以登入&lt;/p>
&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://computingforgeeks.com/how-to-configure-freeipa-client-on-ubuntu-centos/">how to configure freeipa client on ubuntu centos&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Authenticate OpenVPN using LDAP</title><link>https://chiehting.com/posts/openvpn-authenticate-with-ldap/</link><pubDate>Tue, 11 Jan 2022 10:13:00 +0800</pubDate><guid>https://chiehting.com/posts/openvpn-authenticate-with-ldap/</guid><description>
&lt;p>要解決 OpenVPN 的憑證過多不好管理的問題。由於公司人數增加, 要使用 &lt;em>VPN&lt;/em> 的人變多, 若每個人的 .open 檔案都手動生成的話, 在管理上會有點麻煩. 所以這邊讓 &lt;em>OpenVPN&lt;/em> 透過 &lt;em>LDAP&lt;/em> 去認證用戶是否可以使用 &lt;em>VPN&lt;/em>.&lt;/p>
&lt;p>建立完 &lt;em>OpenVPN([[openvpn-install]])&lt;/em> 後, 安裝 LDAP 套件跟配置設定, 使 &lt;em>OpenVPN&lt;/em> 登入時可以使用 &lt;em>LDAP&lt;/em> 做認證.&lt;/p>
&lt;h3 id="configure-openvpn-for-ldap-authentication">Configure OpenVPN for LDAP authentication&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 需要安裝 openvpn-auth-ldap library&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">root@vpn:/opt/vpn# apt-get install -y openvpn-auth-ldap
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="c1"># 查看 .so 檔案是否存在&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">root@vpn:/opt/vpn# ls /usr/lib/openvpn/openvpn-auth-ldap.so
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">/usr/lib/openvpn/openvpn-auth-ldap.so
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">root@vpn:/opt/vpn# mkdir /etc/openvpn/auth
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">root@vpn:/opt/vpn# cp /usr/share/doc/openvpn-auth-ldap/examples/auth-ldap.conf /etc/openvpn/auth/auth-ldap.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="c1"># 將設定配置到 OpenVPN server configuration file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">root@vpn:/opt/vpn# &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;plugin /usr/lib/openvpn/openvpn-auth-ldap.so /etc/openvpn/auth/auth-ldap.conf&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/openvpn/server.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>配置 /etc/openvpn/auth/auth-ldap.conf 檔案&lt;/strong>。這邊要自行創建 /usr/local/etc/ssl 內的憑證, 可以參考 references。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">&amp;lt;LDAP&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> # LDAP server URL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> URL ldap://ldap.example.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> # Bind DN (If your LDAP server doesn&amp;#39;t support anonymous binds)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> BindDN uid=admin, cn=users, cn=accounts, dc=example, dc=com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> # Bind Password
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> Password password
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> # Necomork timeout (in seconds)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> Timeout 15
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> # Enable Start TLS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> TLSEnable yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> # Follow LDAP Referrals (anonymously)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> FollowReferrals yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> # TLS CA Certificate File
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> TLSCACertFile /usr/local/etc/ssl/ca-certificates.crt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> # TLS CA Certificate Directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> TLSCACertDir /etc/ssl/certs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> # Client Certificate and key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> # If TLS client authentication is required
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> TLSCertFile /usr/local/etc/ssl/ca.cert.pem
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> TLSKeyFile /usr/local/etc/ssl/ca.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">&lt;span class="nt">&amp;lt;/LDAP&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">&lt;span class="nt">&amp;lt;Authorization&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> # Base DN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl"> BaseDN &amp;#34;cn=users, cn=accounts, dc=example, dc=com&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl"> # User Search Filter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl"> SearchFilter &amp;#34;(uid=%u)&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl"> # Require Group Membership
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl"> RequireGroup true
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">41&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">42&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;Group&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">43&lt;/span>&lt;span class="cl"> BaseDN &amp;#34;cn=groups, cn=accounts, dc=example, dc=com&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">44&lt;/span>&lt;span class="cl"> SearchFilter &amp;#34;(|(cn=admin)(cn=vpn)(cn=ipausers))&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">45&lt;/span>&lt;span class="cl"> MemberAttribute member
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">46&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;/Group&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">47&lt;/span>&lt;span class="cl">&lt;span class="nt">&amp;lt;/Authorization&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置完成後, 重新啟動 &lt;em>OpenVPN&lt;/em> 服務。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@vpn:/opt/vpn# systemctl restart openvpn
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="編輯組態檔案">編輯組態檔案&lt;/h4>
&lt;p>編輯一下之前透過腳本 ./openvpn-install.sh 建立的 .open file.
&lt;strong>加入 auth-user-pass 參數, 讓使用者在登入的時候使用 LDAP 的帳密.&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">proto udp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">・・・
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">remote vpn.example.com 1194
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">auth-user-pass
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">・・・
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://kifarunix.com/configure-openvpn-ldap-based-authentication/">configure-openvpn-ldap-based-authentication&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://computingforgeeks.com/secure-ldap-server-with-ssl-tls-on-ubuntu/">secure-ldap-server-with-ssl-tls-on-ubuntu&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Create an OpenVPN service</title><link>https://chiehting.com/posts/openvpn-install/</link><pubDate>Tue, 11 Jan 2022 10:00:00 +0800</pubDate><guid>https://chiehting.com/posts/openvpn-install/</guid><description>
&lt;p>原本使用 &lt;em>Wireless Access Points&lt;/em>（ASUS 路由器）內建的 VPN 連到內部服務， 但隨著公司人數增加 AP 負載量過大， 導致硬體無法負荷和效率變差， 所以這邊改使用 &lt;em>OpenVPN&lt;/em> 做替換。&lt;/p>
&lt;h3 id="install-openvpn-to-ubuntu-2004">Install OpenVPN to Ubuntu 20.04&lt;/h3>
&lt;p>GitHub 上有個很好用的腳本 &lt;a href="https://github.com/angristan/openvpn-install">angristan/openvpn-install&lt;/a>，支持的 &lt;a href="https://github.com/angristan/openvpn-install#compatibility">compatibility OS&lt;/a> 也包括我們要使用的 Ubuntu 20.04，所以這邊直接使用該腳本做安裝.&lt;/p>
&lt;p>完成後會在家目錄產生一個 .open 的檔案，用戶端即可以匯入 .open 檔案來連線 VPN.
這邊要注意，如果是放在 Cloud 上的話，要記得配置 Security Groups 設定開啟 OpenVPN 的 port 號.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@vpn:/root# apt-get update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">root@vpn:/root# apt-get -y upgrade
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">root@vpn:/root# mkdir /opt/vpn &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nb">cd&lt;/span> /opt/vpn
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">root@vpn:/opt/vpn# curl -O https://raw.githubusercontent.com/angristan/openvpn-install/master/openvpn-install.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">root@vpn:/opt/vpn# chmod +x openvpn-install.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">root@vpn:/opt/vpn# ./openvpn-install.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>再執行一次腳本，可以執行其他公能.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@vpn:/opt/vpn# ./openvpn-install.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Welcome to OpenVPN-install!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">The git repository is available at: https://github.com/angristan/openvpn-install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">It looks like OpenVPN is already installed.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">What &lt;span class="k">do&lt;/span> you want to &lt;span class="k">do&lt;/span>?
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> 1&lt;span class="o">)&lt;/span> Add a new user
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> 2&lt;span class="o">)&lt;/span> Revoke existing user
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> 3&lt;span class="o">)&lt;/span> Remove OpenVPN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> 4&lt;span class="o">)&lt;/span> Exit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">Select an option &lt;span class="o">[&lt;/span>1-4&lt;span class="o">]&lt;/span>:
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Apache Log4j Security Vulnerabilities</title><link>https://chiehting.com/posts/security-apache-log4j-security-vulnerabilities/</link><pubDate>Tue, 21 Dec 2021 13:55:00 +0800</pubDate><guid>https://chiehting.com/posts/security-apache-log4j-security-vulnerabilities/</guid><description>
&lt;p>在 2021 年 12 月 CVE 發布了一系列有關 Apache Log4j 的漏洞. 這邊初步了解 Log4j 的漏洞狀況跟應對.&lt;/p>
&lt;h3 id="apache-log4j-security-vulnerabilities">Apache Log4j Security Vulnerabilities&lt;/h3>
&lt;p>2021 年的 12 月 10 號發布了 public disclosure of the Apache Log4j vulnerability &lt;a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228">CVE-2021-44228&lt;/a>, 且風險分數為 CVSS 3.1 的滿分 10 分. 攻擊者若可以控制 log messages or log message parameters 就有機會在 LDAP 或 JNDI（Java Naming and Directory Interface）有關的服務加載任意程式碼. Log4j 在 2.15.0 版本中預設關閉了 message lookup substitution 功能; 在 2.16.0 版本中則完全移除了此功能.&lt;/p>
&lt;p>2021 年的 12 月 14 號發布了 &lt;a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046">CVE-2021-45046&lt;/a>, 且風險分數為 CVSS 3.1 的 9.0 分. 此漏洞是 CVE-2021-44228 的延伸, 於 Apache Log4j 2.15.0 中的預設配置不完整, 攻擊者可以透過 Thread Context Map (MDC) 上下文映射功能執行遠端程式碼或本地程式碼. 再 Log4j 2.16.0 (Java 8) and 2.12.2 (Java 7) 中移除 message lookup patterns 和預設關閉 JNDI functionality.&lt;/p>
&lt;p>2021 年的 12 月 18 號發布了 &lt;a href="https://nvd.nist.gov/vuln/detail/CVE-2021-45105">CVE-2021-45105&lt;/a>, 且風險分數為 CVSS 3.1 的 7.5 分. 再 2.16.0 版本沒有保護自身的遞迴查找, 所以攻擊者還能透過設計過的字串進行攻擊. 再 Log4j 2.17.0 and 2.12.3 中有修復此問題.&lt;/p>
&lt;h3 id="應對">應對&lt;/h3>
&lt;p>依據 CVE 報告, 服務需將 Log4j 升級到 2.17.0 的版本. 所以這邊目標是盤查系統是否有使用到 Log4j, 如果有就做升級.&lt;/p>
&lt;p>確認系統.&lt;/p>
&lt;ol>
&lt;li>Redmine is built with Ruby on Rails. &lt;a href="https://www.redmine.org/builds/">build status&lt;/a>.&lt;/li>
&lt;li>FreeIPA itself does not have Java components.&lt;/li>
&lt;li>Harbor is built with Golang, and is not running or using the JVM. &lt;a href="https://github.com/goharbor/harbor/issues/16136">issues&lt;/a>&lt;/li>
&lt;li>Grafana are chose not to use Java as a core part of our stack and have minimal dependencies on services and applications that make use of it. &lt;a href="https://grafana.com/blog/2021/12/14/grafana-labs-core-products-not-impacted-by-log4j-cve-2021-44228-and-related-vulnerabilities/">grafana blog&lt;/a>&lt;/li>
&lt;li>GitLAB is a low impact. &lt;a href="https://about.gitlab.com/blog/2021/12/15/updates-and-actions-to-address-logj-in-gitlab/">gitlab blog&lt;/a>&lt;/li>
&lt;li>Elasticsearch and Kibana needs to be upgrade to the 7.16.2 and 6.8.22 of Apache Log4j and address false positive concerns with some vulnerability scanners. &lt;a href="https://www.elastic.co/blog/new-elasticsearch-and-logstash-releases-upgrade-apache-log4j2">elastic blog&lt;/a>&lt;/li>
&lt;li>Ansible AWX does not depend on log4j. &lt;a href="https://github.com/ansible/awx/issues/11457">issue&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>盤查完後, 得知只有 Elasticsearch and Kibana 有使用到 log4j 的套件.&lt;/p>
&lt;h3 id="elasticsearch-and-kibana">Elasticsearch and Kibana&lt;/h3>
&lt;p>我之前是使用 Ansible 透過 apt-get 安裝 Elasitcsearch, 所以這邊更新 Elasticsearch role 版本參數為 7.16.2 並執行 playbook, 完成後 Elasticsearch 就升級完畢. 至於 Kibana 是使用 docker compose 執行, 更新 Kibana 的 container image 至 7.16.2 就可以了.&lt;/p>
&lt;h4 id="更新時碰到的問題">更新時碰到的問題&lt;/h4>
&lt;p>無法重新啟動 Elasticsearch 服務, 因為 ingest-attachment 版本是舊的. 這邊做重新安裝 ingest-attachment 來排除異常.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/usr/share/elasticsearch/bin/elasticsearch-plugin remove ingest-attachment
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">/usr/share/elasticsearch/bin/elasticsearch-plugin install ingest-attachment
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>啟動 Kibana 時偵測到 .kibana 的 indexes 已經存在. 這邊做移除所有 .kibana* 的 indexes, 讓 Kibana 重新建立 indexes.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># Elasticsearch 服務地址為 127.0.0.1:9200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">curl --user &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$account&lt;/span>&lt;span class="s2">:&lt;/span>&lt;span class="nv">$password&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -XDELETE http://127.0.0.1:9200/.kibana*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>How to use certbot to renew SSL certification</title><link>https://chiehting.com/posts/certbot-renew-ssl-certification/</link><pubDate>Thu, 28 Oct 2021 15:24:00 +0800</pubDate><guid>https://chiehting.com/posts/certbot-renew-ssl-certification/</guid><description>
&lt;p>使用 Certbot 來申請 Web Site 的 SSL 憑證. Certbot 是一個開源軟體, 可以自動(手動)執行域名的驗證與透過憑證頒發機構 &lt;a href="https://letsencrypt.org/">Let’s Encrypt&lt;/a> 來取得憑證.&lt;/p>
&lt;h3 id="安裝套件">安裝套件&lt;/h3>
&lt;p>ubuntu 20.04 上安裝套件&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">bash$ sudo apt-get install -y certbot
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Centos 7 上安裝套件&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">bash$ sudo yum -y install epel-release mod_ssl certbot
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="使用-dns-challenges-申請憑證">使用 dns challenges 申請憑證&lt;/h3>
&lt;p>完成後憑證會在 /etc/letsencrypt/live/harbor.example.com 底下, 這邊要注意檔案是軟連結.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">certbot -d redmine.example.com --manual --preferred-challenges dns certonly
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">Please deploy a DNS TXT record under the name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">_acme-challenge.harbor.example.com with the following value:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">go3M8xPHJKhOp2_Wuwnh4PaOUiOlMtiMiuRCX026WRo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">Before continuing, verify the record is deployed.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">Press Enter to Continue
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">Waiting &lt;span class="k">for&lt;/span> verification...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">Cleaning up challenges
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">IMPORTANT NOTES:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> - Congratulations! Your certificate and chain have been saved at:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> /etc/letsencrypt/live/harbor.example.com/fullchain.pem
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> Your key file has been saved at:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> /etc/letsencrypt/live/harbor.example.com/privkey.pem
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> Your cert will expire on 2022-01-26. To obtain a new or tweaked
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> version of this certificate in the future, simply run certbot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> again. To non-interactively renew *all* of your certificates, run
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;certbot renew&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> - Your account credentials have been saved in your Certbot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> configuration directory at /etc/letsencrypt. You should make a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> secure backup of this folder now. This configuration directory will
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> also contain certificates and private keys obtained by Certbot so
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> making regular backups of this folder is ideal.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> - If you like Certbot, please consider supporting our work by:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> Donating to ISRG / Let&lt;span class="err">&amp;#39;&lt;/span>s Encrypt: https://letsencrypt.org/donate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> Donating to EFF: https://eff.org/donate-le
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>淺談加密標準</title><link>https://chiehting.com/posts/encryption-standard/</link><pubDate>Fri, 01 Oct 2021 16:35:00 +0800</pubDate><guid>https://chiehting.com/posts/encryption-standard/</guid><description>
&lt;p>在開發上常會用到資料加密，例如雜湊函式（MD5、SHA-2）、對稱式加密（AES、DES、3DES)、非對稱式加密（RSA演算法）等方式，這篇就來研究一下這些加密方式之差異。&lt;/p>
&lt;h3 id="references">References&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://ithelp.ithome.com.tw/articles/10251031">IThome&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zhuanlan.zhihu.com/p/26029199">知乎&lt;/a>&lt;/li>
&lt;/ul>
&lt;h3 id="cryptography">Cryptography&lt;/h3>
&lt;p>在密碼學當中，加密的形式包含了下面幾種：&lt;/p>
&lt;ul>
&lt;li>Hash Function（雜湊函式）&lt;/li>
&lt;li>Symmetric Encryption（對稱加密）&lt;/li>
&lt;li>Asymmetric Encryption（非對稱加密）&lt;/li>
&lt;/ul>
&lt;h4 id="hash-function">Hash Function&lt;/h4>
&lt;p>雜湊函式是將資料中的，具有不可逆的特性。但是輸入和輸出並不是為一對對應的關係，若同一個函式的雜湊值結果&lt;strong>不同&lt;/strong>，代表原始輸入值也&lt;strong>不同&lt;/strong>；若同一個函式的雜湊值結果&lt;strong>相同&lt;/strong>，不代表原始輸入值也&lt;strong>相同&lt;/strong>。&lt;/p>
&lt;p>雜湊碰撞（collision）意指同一個函式的雜湊值結果&lt;strong>相同&lt;/strong>，但原始輸入值&lt;strong>不相同&lt;/strong>的情況，&lt;a href="https://github.com/corkami/collisions">corkami/collisions&lt;/a> 範例。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$bash&lt;/span> python
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">Python 3.9.6 &lt;span class="o">(&lt;/span>default, Jun &lt;span class="m">29&lt;/span> 2021, 05:25:02&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Clang 12.0.5 &lt;span class="o">(&lt;/span>clang-1205.0.22.9&lt;span class="o">)]&lt;/span> on darwin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">Type &lt;span class="s2">&amp;#34;help&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;copyright&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;credits&amp;#34;&lt;/span> or &lt;span class="s2">&amp;#34;license&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> more information.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; import crypt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; crypt.crypt&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;5dUD&amp;amp;66&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;br&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="s1">&amp;#39;brokenOz4KxMc&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; crypt.crypt&lt;span class="o">(&lt;/span>&lt;span class="s2">&amp;#34;O!&amp;gt;&amp;#39;,%&lt;/span>$&lt;span class="s2">&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;br&amp;#34;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">&lt;span class="s1">&amp;#39;brokenOz4KxMc&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>常見的 Hash Function：&lt;/p>
&lt;ul>
&lt;li>SHA-256：生成256位元值的雜湊值，為常見的雜湊函式之一&lt;/li>
&lt;li>MD5&lt;/li>
&lt;/ul>
&lt;h4 id="symmetric-encryption">Symmetric Encryption&lt;/h4>
&lt;p>對稱式加密為使用同一把金鑰做解密／解密。&lt;/p>
&lt;h5 id="data-encryption-standard">Data Encryption Standard&lt;/h5>
&lt;p>Data Encryption Standard（DES）是基於 56 bits 金鑰 + 8 bits 的奇偶校驗的大小。&lt;a href="https://www.tutorialspoint.com/cryptography/data_encryption_standard.htm">此篇&lt;/a>有加密教學。&lt;/p>
&lt;h5 id="triple-des">Triple DES&lt;/h5>
&lt;p>然而在硬體效能越來越強的情況下，DES 已經不是安全的加密方法，然而用戶不希望花大量的時間跟成本取代 DES 加密，所以衍生出了 Triple DES（3DES）。3DES 是 DES 的變體，也就是將原本使用的金鑰大小變成 56 bits * 3 = 168 bits。&lt;a href="https://www.tutorialspoint.com/cryptography/triple_des.htm">此篇&lt;/a>有加密教學。&lt;/p>
&lt;h5 id="advanced-encryption-standard">Advanced Encryption Standard&lt;/h5>
&lt;p>Advanced Encryption Standard（AES）是用來替代 DES 的加密標準，由於目前的硬體設備的進步使 DES 金鑰 56 bits 已經顯得過小，然後延生的 3DES 雖然可以解決安全性問題但付出的是時間成本。AES 金鑰大小為 128 bits，而效率也比 3DES 來得快，&lt;a href="https://www.tutorialspoint.com/cryptography/advanced_encryption_standard.htm">此篇&lt;/a>有加密教學。&lt;/p>
&lt;h4 id="asymmetric-encryption">Asymmetric Encryption&lt;/h4>
&lt;p>由於對稱式加／解密的金鑰是同一把，若是其中一方金鑰洩露了，就會破壞原本的安全機制。而非對稱式加密是改良了這點，採用了公鑰（public key）與私鑰（private key），公鑰作加密；私鑰做解密。值得注意的是一對鑰匙只能做單向的加解密，大部分的內文加密／解密是採用 &lt;a href="https://ithelp.ithome.com.tw/articles/10188528">RSA + AES&lt;/a> 達到雙向加密。&lt;/p>
&lt;h5 id="rsa">RSA&lt;/h5>
&lt;p>RSA 是基於大數因數分解的加密方式。另外 RSA-155 (512 bits) 被成功分解，所以已經威脅到 1024-bit 金鑰的安全性，普遍認為使用者應儘快升級到2048-bit或以上。&lt;/p>
&lt;h5 id="elliptic-curve-cryptography">Elliptic Curve Cryptography&lt;/h5>
&lt;p>ECC 可以透過較小的密鑰長度提供相當的安全性，但實作起來較複雜。&lt;/p></description></item><item><title>使用 Helm 建立 AWS network load balancer</title><link>https://chiehting.com/posts/kubernetes-install-ingress-nginx/</link><pubDate>Wed, 01 Sep 2021 14:44:00 +0800</pubDate><guid>https://chiehting.com/posts/kubernetes-install-ingress-nginx/</guid><description>
&lt;p>Kubernetes 揭露服務有多種方式，例如 Ingres、NodePort、LoadBalancer。
次篇紀錄使用 Helm 來安裝 &lt;a href="https://kubernetes.github.io/ingress-nginx/">ingress-nginx&lt;/a> 與 AWS 的 &lt;a href="https://docs.aws.amazon.com/zh_tw/elasticloadbalancing/latest/network/introduction.html">network load balancer&lt;/a>，將流量通道指定的 Pods 上。&lt;/p>
&lt;p>Kubernetes &lt;a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">ingress controllers&lt;/a> 的供應商很多，目前服務使用 Nginx 和 Traefik 來做 ingress controllers。另外 Istio service mesh 也是滿知名的 controllers 之一。&lt;/p>
&lt;h3 id="add-ingress-nginx-repository">Add ingress-nginx repository&lt;/h3>
&lt;p>要先加入 ingress-nginx repo 至 Helm 中。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1"># show repository list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">bash$ helm repo list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">NAME URL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">ingress-nginx https://kubernetes.github.io/ingress-nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">stable https://charts.helm.sh/stable
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">prometheus-community https://prometheus-community.github.io/helm-charts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">jetstack https://charts.jetstack.io
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="install-ingress-nginx">Install ingress-nginx&lt;/h2>
&lt;p>透過 Helm 安裝 ingress-nginx，其中有一併設定 annotations 跟 config。&lt;/p>
&lt;p>&lt;a href="https://docs.nginx.com/nginx/deployment-guides/amazon-web-services/ingress-controller-elastic-kubernetes-services/">annotations&lt;/a>：是宣吿在安裝時配置為 AWS network load balancer。&lt;/p>
&lt;p>&lt;a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#worker-processes">config&lt;/a>：是 Nginx config 的相關配置。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">helm install ingress-nginx-nlb ingress-nginx/ingress-nginx -n kube-system &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span>--set controller.service.annotations.&lt;span class="s2">&amp;#34;service\.beta\.kubernetes\.io\/aws-load-balancer-type&amp;#34;&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;nlb&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span>--set controller.config.&lt;span class="s2">&amp;#34;use-proxy-protocol&amp;#34;&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;true&amp;#34;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span>--set controller.config.&lt;span class="s2">&amp;#34;ssl-redirect&amp;#34;&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;false&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>由於 network load balancer 是 OSI Layer 4，所以取 client real IP 會取用到 private IP。可以看到下面的 &lt;code>X-Real-Ip&lt;/code> 欄位。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">bash$ curl https://justin.example.com/server &lt;span class="p">|&lt;/span> jq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;clientIP&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;10.0.75.140&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;header&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;Accept&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;*/*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;User-Agent&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;curl/7.64.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Forwarded-For&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;10.0.75.140&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Forwarded-Host&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;justin.example.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Forwarded-Port&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;443&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Forwarded-Proto&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;https&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Forwarded-Scheme&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;https&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Real-Ip&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;10.0.75.140&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Request-Id&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;8c4991c13d1497362ddb513e02f3c859&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Scheme&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;https&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>為了抓取正確的 real IP，需要開啟 network load balancer 的 &lt;a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-target-groups.html#client-ip-preservation">Proxy protocol v2&lt;/a> 功能，等配置生效後即可看到取到 client real IP。可以看到下面的 &lt;code>X-Real-Ip&lt;/code> 欄位。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">bash$ curl https://justin.example.com/server &lt;span class="p">|&lt;/span> jq
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;clientIP&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;1.34.113.121&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;header&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;Accept&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;*/*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;User-Agent&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;curl/7.64.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Forwarded-For&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;1.34.113.121&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Forwarded-Host&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;justin.example.com&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Forwarded-Port&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;443&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Forwarded-Proto&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;https&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Forwarded-Scheme&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;https&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Real-Ip&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;1.34.113.121&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Request-Id&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;f4c4490b0919271b5e9d5d0a5dc37089&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;X-Scheme&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;https&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl"> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>The Namespace is stuck the terminating state</title><link>https://chiehting.com/posts/kubernetes-namespace-stuck-terminating/</link><pubDate>Thu, 19 Aug 2021 17:22:00 +0800</pubDate><guid>https://chiehting.com/posts/kubernetes-namespace-stuck-terminating/</guid><description>
&lt;p>使用 kubectl 刪除 Kubernetes namespace 時，發生狀態卡在 &lt;code>Terminating&lt;/code> 無法移除。原因是相關資源未被釋放，所以卡住。&lt;/p>
&lt;p>下面列出 namespace cert-manager 的狀態。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">bash$ kubectl describe namespace cert-manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">Name: cert-manager
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">Labels: &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">Annotations: &amp;lt;none&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">Status: Terminating
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">No resource quota.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">No LimitRange resource.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>下面將匯出 namespace cert-manager 當前的定義 json。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">bash$ kubectl get namespace cert-manager -o json &amp;gt; tmp.json
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="原因">原因&lt;/h3>
&lt;p>從 json 檔案中可看到目前 namespace 中的狀況，有 conditions 執行未完成，所以造成 namespace 卡住。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="s2">&amp;#34;status&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;conditions&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;lastTransitionTime&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2021-08-19T09:14:05Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Discovery failed for some groups, 1 failing: unable to retrieve the complete list of server APIs: metrics.k8s.io/v1beta1: the server is currently unable to handle the request&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;reason&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;DiscoveryFailed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;status&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;True&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;NamespaceDeletionDiscoveryFailure&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;lastTransitionTime&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2021-08-19T09:14:06Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;All legacy kube types successfully parsed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;reason&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ParsedGroupVersions&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;status&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;False&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;NamespaceDeletionGroupVersionParsingFailure&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;lastTransitionTime&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2021-08-19T09:14:06Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;All content successfully deleted, may be waiting on finalization&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;reason&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ContentDeleted&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;status&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;False&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;NamespaceDeletionContentFailure&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;lastTransitionTime&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2021-08-19T09:14:06Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;All content successfully removed&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;reason&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ContentRemoved&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;status&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;False&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;NamespaceContentRemaining&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;lastTransitionTime&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2021-08-19T09:14:06Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;All content-preserving finalizers finished&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;reason&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ContentHasNoFinalizers&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;status&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;False&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;NamespaceFinalizersRemaining&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;phase&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Terminating&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="排除">排除&lt;/h3>
&lt;p>可以看到在 json 檔中有 &lt;code>spec.finalizers&lt;/code> 讀欄位，在 kubernetes 官網中有解釋 &lt;a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/">Finalizers&lt;/a> 會等到 conditions 內的資源都移除後才會標記為 deletion，確保 namespace 擁有的資源已被釋放。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="s2">&amp;#34;spec&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;finalizers&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;kubernetes&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;span class="err">,&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>我們可以手動變更定義，不要等待其他資源。搜尋 json 檔案中的 &lt;code>spec.finalizers&lt;/code>，把 &lt;code>kubernetes&lt;/code> 字串給刪掉，會變成像下面的結構。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="s2">&amp;#34;spec&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;finalizers&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>&lt;span class="err">,&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>開啟 kubectl proxy，直接對 API 發變更過後的請求。完成後就換看到 namespace 被移除。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">bash$ kubectl proxy &lt;span class="p">&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">bash$ &lt;span class="nv">PID&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">bash$ curl -X PUT http://localhost:8001/api/v1/namespaces/cert-manager/finalize -H &lt;span class="s2">&amp;#34;Content-Type: application/json&amp;#34;&lt;/span> --data-binary @tmp.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">bash$ &lt;span class="nb">kill&lt;/span> &lt;span class="nv">$PID&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Cloudfloar proxy slow</title><link>https://chiehting.com/posts/cloudflare-proxy-slow-issue/</link><pubDate>Mon, 16 Aug 2021 14:55:00 +0800</pubDate><guid>https://chiehting.com/posts/cloudflare-proxy-slow-issue/</guid><description>
&lt;p>今天收到反應說服務 API 的反應速度有變慢, 盤查結果發現目前使用的 Cloudflare 中的 proxy 功能造成的, 這邊紀錄盤查過程.&lt;/p>
&lt;p>從下圖可以看到有多支 API 變慢，這邊先分析變慢的原因。&lt;/p>
&lt;p>&lt;img src="https://storage.googleapis.com/chiehting.com/blog/2021-08-16-cloudflare-proxy-issu-1.jpg" alt="api request is slow">&lt;/p>
&lt;h3 id="分析">分析&lt;/h3>
&lt;ol>
&lt;li>測試網路節點狀況，看是否有節點異常緩慢&lt;/li>
&lt;li>測試 API 請求狀況，查看請求是否有緩慢的階段&lt;/li>
&lt;/ol>
&lt;h4 id="測試網路節點狀況">測試網路節點狀況&lt;/h4>
&lt;p>MTR 分析網路節點狀況，可以看到節點的響應速度在 200 ms 內，看起來還在可接受範圍內。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">➜ sudo mtr --tcp --port &lt;span class="m">443&lt;/span> --report --report-cycles &lt;span class="m">5&lt;/span> api.bitwin.ai
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Start: 2021-08-13T17:28:56+0800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">HOST: JustinLee Loss% Snt Last Avg Best Wrst StDev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> 1.&lt;span class="p">|&lt;/span>-- rt-ac68u-2ad0 0.0% &lt;span class="m">5&lt;/span> 2.5 2.4 1.8 3.5 0.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> 2.&lt;span class="p">|&lt;/span>-- h254.s98.ts.hinet.net 0.0% &lt;span class="m">5&lt;/span> 11.7 7.9 6.1 11.7 2.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> 3.&lt;span class="p">|&lt;/span>-- tpn2-3301.hinet.net 0.0% &lt;span class="m">5&lt;/span> 20.0 11.2 5.8 20.0 6.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> 4.&lt;span class="p">|&lt;/span>-- tpdb-3031.hinet.net 40.0% &lt;span class="m">5&lt;/span> 9.9 9.5 9.1 9.9 0.4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> 5.&lt;span class="p">|&lt;/span>-- 220-128-8-121.hinet-ip.hi 0.0% &lt;span class="m">5&lt;/span> 8.5 10.7 7.5 18.5 4.5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> 6.&lt;span class="p">|&lt;/span>-- tyfo-4011.hinet.net 0.0% &lt;span class="m">5&lt;/span> 12.0 9.1 6.8 12.0 2.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> 7.&lt;span class="p">|&lt;/span>-- r31-la.us.hinet.net 0.0% &lt;span class="m">5&lt;/span> 142.5 142.9 140.1 148.3 3.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> 8.&lt;span class="p">|&lt;/span>-- r32-la.us.hinet.net 0.0% &lt;span class="m">5&lt;/span> 139.9 141.4 139.0 143.1 1.9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> 9.&lt;span class="p">|&lt;/span>-- 141.101.72.250 0.0% &lt;span class="m">5&lt;/span> 153.2 146.1 139.4 153.3 6.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> 10.&lt;span class="p">|&lt;/span>-- 104.21.33.138 0.0% &lt;span class="m">5&lt;/span> 140.3 141.2 139.8 142.6 1.2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="測試-api-請求狀況">測試 API 請求狀況&lt;/h4>
&lt;p>使用 curl 命令對 api/ping 做請求, 這支 API 非常輕量, 但響應時間需要 1144 ms, 有點不合理.&lt;/p>
&lt;p>由下面資訊可以看到在 time_appconnect 這邊花了比較長的時間, 也就是可能在做 TLS 的時候佔了很長的時間, 而因為有使用 Cloudflare proxy, 所以 client 端在是對 proxy 的機器做 TLS Handshake.&lt;/p>
&lt;blockquote>
&lt;p>time_appconnect here is TLS setup. The client is then ready to send it’s HTTP GET request.&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">➜ bash curl_timetrace.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1"># starting_time: Fri Aug 13 17:43:56 CST 2021&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> time_namelookup: 0.002113
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> time_connect: 0.187355
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> time_appconnect: 0.521270
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> time_redirect: 0.000000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> time_pretransfer: 0.521435
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">time_starttransfer: 1.144257
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> ---------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> time_total: 1.144484 seconds
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="troubleshoot">Troubleshoot&lt;/h3>
&lt;p>經由上面分析觀察到可能是 TLS 耗時太久. 嘗試移除 Cloudflare proxy 的功能, 讓 Cloudflare 只單純的做 DNS.&lt;/p>
&lt;p>目前路由狀況如下圖. 由於網站上的 SSL 綁定都是使用 &lt;a href="https://www.cloudflare.com/zh-tw/ssl/">Cloudflare 免費 SSL/TLS&lt;/a>, 這功能必須啟用 proxy. 若要禁用 proxy 的話, 必須將 SSL 憑證在其他地方綁定. 測試時先暫時把 SSL 憑證改綁在 AWS Elastic Load Balancing 上.&lt;/p>
&lt;pre class="mermaid">flowchart LR
client --> cloudflare["Cloudflare proxy"]
cloudflare --> originServer["origin server"]&lt;/pre>
&lt;h3 id="比較結果">比較結果&lt;/h3>
&lt;p>可以看到調整過後, 約提升了 60% 的效率. 這邊評估可能是 proxy 的節點較遠, 而 client 需要先經過 proxy 才能到達 origin server, 所以導致變慢.&lt;/p>
&lt;p>這邊有一個網站 &lt;a href="https://cloudflare-test.judge.sh/">cloudflare-test&lt;/a>，可以測試 proxy 的地理位置，另外 proxy 會隨時間作變動非固定。&lt;/p>
&lt;p>&lt;strong>Before&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">➜ bash curl_timetrace.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1"># starting_time: Fri Aug 13 17:43:56 CST 2021&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> time_namelookup: 0.002113
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> time_connect: 0.187355
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> time_appconnect: 0.521270
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> time_redirect: 0.000000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> time_pretransfer: 0.521435
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">time_starttransfer: 1.144257
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> ---------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> time_total: 1.144484 seconds
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>After&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">➜ bash curl_timetrace.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1">##### starting_time: Fri Aug 13 20:31:22 CST 2021&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> time_namelookup: 0.002898
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> time_connect: 0.117132
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> time_appconnect: 0.344409
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> time_redirect: 0.000000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> time_pretransfer: 0.344475
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> time_starttransfer: 0.453052
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> ---------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> time_total: 0.453251 seconds
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Uber's Golang code style guide</title><link>https://chiehting.com/posts/golang-code-style-on-uber/</link><pubDate>Thu, 12 Aug 2021 10:58:00 +0800</pubDate><guid>https://chiehting.com/posts/golang-code-style-on-uber/</guid><description>
&lt;p>學習 Uber 在 Golang 上的規範。
這裡做個筆記，主要還是去原文裡面看會比較詳細。&lt;/p>
&lt;h3 id="referances">Referances&lt;/h3>
&lt;p>&lt;a href="https://github.com/uber-go/guide/blob/master/style.md">uber style guide&lt;/a>。&lt;/p>
&lt;h3 id="table-of-contents">Table of Contents&lt;/h3>
&lt;p>Uber 的 style guild 目錄列表中，看到 Uber style 的幾個大指標。&lt;/p>
&lt;ul>
&lt;li>Introduction&lt;/li>
&lt;li>Guidelines&lt;/li>
&lt;li>Performance&lt;/li>
&lt;li>Style&lt;/li>
&lt;li>Patterns&lt;/li>
&lt;li>Linting&lt;/li>
&lt;/ul>
&lt;h3 id="introduction">Introduction&lt;/h3>
&lt;p>在 Uber 的規範中，大部分使用了 Go 的一般標準，如下&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://golang.org/doc/effective_go.html">Effective Go&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/golang/go/wiki/CommonMistakes">Go Common Mistakes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/golang/go/wiki/CodeReviewComments">Go Code Review Comments&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>所有程式碼都必須透過 golint 和 go vet 來檢查是否有問題。也最好將其設定在編輯工具中。&lt;/p>
&lt;ul>
&lt;li>Run &lt;code>goimports -w .&lt;/code> on save&lt;/li>
&lt;li>Run &lt;code>golint ./...&lt;/code> and &lt;code>go vet&lt;/code> to check for errors&lt;/li>
&lt;/ul>
&lt;h3 id="guidelines">Guidelines&lt;/h3>
&lt;h4 id="pointers-to-interfaces">Pointers to Interfaces&lt;/h4>
&lt;p>通常會包括兩個欄位：&lt;/p>
&lt;ol>
&lt;li>指標類型資訊&lt;/li>
&lt;li>資料指標，須以地址放入. 如果資料是一個記憶體位置則直接放入，如果是一個值則使用這個值的記憶體位置放入。&lt;/li>
&lt;/ol>
&lt;h4 id="start-enums-at-one">Start Enums at One&lt;/h4>
&lt;p>在使用常數與 iota 時， 建議起始值為 1。
關於這點，我有碰過相關的坑，例如 &lt;a href="https://gorm.io/docs/update.html#Updates-multiple-columns">gorm update&lt;/a> 預設只會更新非零的值。&lt;/p>
&lt;blockquote>
&lt;p>updating with struct it will only update non-zero fields by default&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Operation&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="nx">Add&lt;/span> &lt;span class="nx">Operation&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="nx">Subtract&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="nx">Multiply&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>但是在特定情況下，0 具有代表意義的話，則使用 0。 例如：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">LogOutput&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="nx">LogToStdout&lt;/span> &lt;span class="nx">LogOutput&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="nx">LogToFile&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="nx">LogToRemote&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">&lt;span class="c1">// LogToStdout=0, LogToFile=1, LogToRemote=2
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="use-time-to-handle-time">Use &amp;quot;time&amp;quot; to handle time&lt;/h4>
&lt;p>時間會被假定錯誤，&lt;a href="https://infiniteundo.com/post/25326999628/falsehoods-programmers-believe-about-time">例如&lt;/a>：&lt;/p>
&lt;ul>
&lt;li>A day has 24 hours&lt;/li>
&lt;li>An hour has 60 minutes&lt;/li>
&lt;li>A week has 7 days&lt;/li>
&lt;li>A year has 365 days&lt;/li>
&lt;/ul>
&lt;p>以第一條為來說，加入 24 小時不一定會隔天。在做時間處理時使用 &lt;code>time&lt;/code> package 可以確保安全。&lt;/p>
&lt;table>&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>&lt;tbody>&lt;tr>&lt;td>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">isActive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">start&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stop&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">start&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="nx">now&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">now&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="nx">stop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">isActive&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">start&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">stop&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="kt">bool&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">start&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Before&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nx">start&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Equal&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">now&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nx">now&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Before&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">stop&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/td>&lt;/tr>&lt;/tbody>&lt;/table>
&lt;h4 id="error-types">Error Types&lt;/h4>
&lt;p>you should use a custom type, and implement the Error() method.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1">// package foo
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">ErrCouldNotOpen&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">New&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;could not open&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">Open&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">error&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">ErrCouldNotOpen&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="c1">// package bar
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">foo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Open&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="nx">err&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">errors&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Is&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">err&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">foo&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">ErrCouldNotOpen&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="c1">// handle
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="nb">panic&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;unknown error&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="avoid-mutable-globals">Avoid Mutable Globals&lt;/h4>
&lt;p>勁量避免在全域變數中定義可變的變數，例如 &lt;code>var _timeNow = time.Now&lt;/code>。&lt;/p>
&lt;h4 id="avoid-using-built-in-names">Avoid Using Built-In Names&lt;/h4>
&lt;p>不要使用容易令人混淆的關鍵字，例如 &lt;code>var error string&lt;/code>。&lt;/p>
&lt;h3 id="performance">Performance&lt;/h3>
&lt;h4 id="prefer-strconv-over-fmt">Prefer strconv over fmt&lt;/h4>
&lt;p>字串轉換使用 &lt;code>strconv&lt;/code> 代替 &lt;code>fmt&lt;/code>，約提高 55% 的效能。&lt;/p>
&lt;h4 id="prefer-specifying-container-capacity">Prefer Specifying Container Capacity&lt;/h4>
&lt;p>在使用 make 函式時，使用 &lt;code>length&lt;/code>、&lt;code>capacity&lt;/code> 參數，約提高 91% 的效能。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nb">make&lt;/span>&lt;span class="p">([]&lt;/span>&lt;span class="nx">T&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">length&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">capacity&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="style">Style&lt;/h3>
&lt;h4 id="group-similar-declarations">Group Similar Declarations&lt;/h4>
&lt;p>將同屬性相關的變數，用群組做分類例如：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="s">&amp;#34;a&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="s">&amp;#34;b&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="nx">b&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nx">b&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="nx">Area&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="nx">Volume&lt;/span> &lt;span class="kt">float64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>如果變數屬不相關的，明確分開。&lt;/p>
&lt;h4 id="import-group-ordering">Import Group Ordering&lt;/h4>
&lt;p>There should be two import groups:&lt;/p>
&lt;ul>
&lt;li>Standard library&lt;/li>
&lt;li>Everything else&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="s">&amp;#34;os&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="s">&amp;#34;go.uber.org/atomic&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="s">&amp;#34;golang.org/x/sync/errgroup&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="package-names">Package Names&lt;/h4>
&lt;p>要命名 package 時，採用下面規範：&lt;/p>
&lt;ul>
&lt;li>全部小寫，也沒字母大寫跟底線&lt;/li>
&lt;li>名稱定義清楚，使引用 package 時不用重新命名&lt;/li>
&lt;li>名稱短而簡潔，但要有明確的識別度&lt;/li>
&lt;li>不使用負數，例如 &lt;code>net/url&lt;/code>，而不是 &lt;code>net/urls&lt;/code>&lt;/li>
&lt;li>別使用 &amp;quot;common&amp;quot;, &amp;quot;util&amp;quot;, &amp;quot;shared&amp;quot;, or &amp;quot;lib&amp;quot;。這名稱沒有有用的資訊&lt;/li>
&lt;/ul>
&lt;p>See also &lt;a href="https://blog.golang.org/package-names">Package Names&lt;/a> and &lt;a href="https://rakyll.org/style-packages/">Style guideline for Go packages&lt;/a>.&lt;/p>
&lt;h4 id="function-grouping-and-ordering">Function Grouping and Ordering&lt;/h4>
&lt;p>function 必須放置在全域定義 struct, const, var 之後。
並且做分群分類。&lt;/p>
&lt;h4 id="reduce-nesting">Reduce Nesting&lt;/h4>
&lt;p>if、for 減少槽狀式的寫法&lt;/p>
&lt;h4 id="unnecessary-else">Unnecessary Else&lt;/h4>
&lt;p>不用 else 就別硬用&lt;/p>
&lt;table>&lt;thead>&lt;tr>&lt;th>Bad&lt;/th>&lt;th>Good&lt;/th>&lt;/tr>&lt;/thead>&lt;tbody>&lt;tr>&lt;td>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/td>&lt;td>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nx">a&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="nx">a&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/td>&lt;/tr>&lt;/tbody>&lt;/table>
&lt;h4 id="prefix-unexported-globals-with-_">Prefix Unexported Globals with _&lt;/h4>
&lt;p>在全域 var 和 const 變數加上前綴 &lt;code>_&lt;/code>，在使用時可以明確的知道該變數是全域變數。
例外: 如果是 error 的變數，前綴應該使用 &lt;code>err&lt;/code>。&lt;/p>
&lt;h4 id="use-raw-string-literals-to-avoid-escaping">Use Raw String Literals to Avoid Escaping&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nx">wantError&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="s">`unknown error:&amp;#34;test&amp;#34;`&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="initializing-maps">Initializing Maps&lt;/h4>
&lt;p>Prefer make(..) for empty maps, and maps populated programmatically. This makes map initialization visually distinct from declaration, and it makes it easy to add size hints later if available.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="kd">var&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="c1">// m1 is safe to read and write;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// m2 will panic on writes.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">m1&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">T1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">T2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="nx">m2&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">T1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="nx">T2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>什麼是 QUIC</title><link>https://chiehting.com/posts/quick-udp-internet-connections/</link><pubDate>Wed, 21 Jul 2021 13:55:00 +0800</pubDate><guid>https://chiehting.com/posts/quick-udp-internet-connections/</guid><description>
&lt;p>QUIC(Quick UDP Internet Connections) 為 OSI model 中 &amp;quot;傳輸層&amp;quot; 和 &amp;quot;應用層&amp;quot; 之間的一個新的協議層. 是基於 UDP 之上的, 但它在傳輸層和應用層之間引入了自己的協議層, 用於處理連接、可靠性、流控制和安全性等問題. 所以 QUIC 不好用 OSI model 去區分, 而是稱為 &amp;quot;安全的通用傳輸協議(secure general-purpose transport protocol)&amp;quot;.&lt;/p>
&lt;p>HTTP/3 是個新的 HTTP 版本，使用 QUIC 作為傳輸協議，與 HTTP/1.1、HTTP/2.0 使用的 TCP/IP 不同。相較於 TCP/IP 協議；QUIC 提高了網路效能。&lt;/p>
&lt;p>HTTP 是網際網路上重要的網路協議之一，至今已經發行了多個版本。在 &lt;a href="http://www.http2demo.io/">demo&lt;/a> 中可以看到 HTTP/1.1 與 HTTP/2.0 的差異。&lt;/p>
&lt;ul>
&lt;li>HTTP/1.0&lt;/li>
&lt;li>HTTP/1.1&lt;/li>
&lt;li>HTTP/2.0&lt;/li>
&lt;/ul>
&lt;p>HTTP（Hypertext Transfer Protocol）協議是 application-level protocol (OSI model: layer 7)，在 RFC 2616 中描述 HTTP 傳輸層預設是使用 TCP/IP 作為連線，原因是因為要基於可靠的傳輸方式，但不排除 HTTP 也可以使用在其他協議上，前提是需要可靠的傳輸。&lt;/p>
&lt;blockquote>
&lt;p>HTTP communication usually takes place over TCP/IP connections. The
default port is TCP 80 [19], but other ports can be used. This does
not preclude HTTP from being implemented on top of any other protocol
on the Internet, or on other networks. HTTP only presumes a reliable
transport; any protocol that provides such guarantees can be used;
the mapping of the HTTP/1.1 request and response structures onto the
transport data units of the protocol in question is outside the scope
of this specification.&lt;/p>
&lt;/blockquote>
&lt;p>HTTP/1.1 是使用多個 TCP 連接，一個連接的問題不會影響其他連接。&lt;/p>
&lt;p>而 HTTP/2.0 也是基於 TCP/IP 協議之上，在單個 TCP 連接上實現了多個請求的並行傳輸（多路復用），也就是多個 stream 在同一個 TCP 上做封包的傳送，但基於 TCP/IP 的關鍵機制 Retransmission Timer（重傳計時器），只要某個 tcp package 遺失就會觸發重傳封包進而造成隊頭阻塞（head of line blocking），在未收到該 ack 之前，所有 stream 都須等待。&lt;/p>
&lt;p>而在極端的網路環境之下，HTTP/2.0 可能比 HTTP/1.1 之效率來得差。&lt;/p>
&lt;h3 id="quic">QUIC&lt;/h3>
&lt;p>&lt;a href="https://www.chromium.org/quic/">QUIC, a multiplexed transport over UDP&lt;/a> 是由 Google 所提出的設計，後來演變為一個 IETF 標準化的協議（RFC 9000）。而這協議是在端點間建立數個 Multiplexing 的 UDP 連線。&lt;/p>
&lt;blockquote>
&lt;p>QUIC is a new multiplexed transport built on top of UDP. HTTP/3 is designed to take advantage of QUIC's features, including lack of Head-Of-Line blocking between streams.&lt;/p>
&lt;/blockquote>
&lt;p>而 QUIC 的優點：&lt;/p>
&lt;ul>
&lt;li>使用 UDP 連線，所以減少了三次握手的效能消耗&lt;/li>
&lt;li>封包遺失只會影響到對應的 stream，&lt;/li>
&lt;li>實現了 TCP 的可靠性，使用 Packet Number 來代替 TCP 的 sequence number&lt;/li>
&lt;li>實現了 HTTP/2.0 的多路復用（multiplexed），但相較於 HTTP/2.0 協議 QUIC 每個 stream 間沒有依賴關係，也就是說大幅減少隊頭阻塞(lack of Head-Of-Line)&lt;/li>
&lt;li>實現了 TLS 的安全性&lt;/li>
&lt;/ul>
&lt;h3 id="references">References&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://javascript.plainenglish.io/what-is-http-3-and-why-does-it-matter-cb7d7b4b600f">What is http/3&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://xiaorui.cc/archives/6117">技术分享之http2和quic的那些事儿&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/@the.real.yushuf/benchmarking-quic-1fd043e944c7">benchmarking quic&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://datatracker.ietf.org/doc/html/rfc2616">Hypertext Transfer Protocol&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.chromium.org/quic">QUIC&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://datatracker.ietf.org/doc/html/rfc9000">IETF rfc9000&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Supply chain Levels for Software Artifacts</title><link>https://chiehting.com/posts/supply-chain-levels-for-software-artifacts/</link><pubDate>Fri, 16 Jul 2021 10:00:00 +0800</pubDate><guid>https://chiehting.com/posts/supply-chain-levels-for-software-artifacts/</guid><description>
&lt;p>Google 分析目前供應鏈攻擊的嚴重性, 文中也有指出目前大多 CI 的流程中存在著弱點, 並提出 SLSA 框架來避免被攻擊.&lt;/p>
&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://security.googleblog.com/2021/06/introducing-slsa-end-to-end-framework.html" title="Introducing SLSA, an End-to-End Framework for Supply Chain Integrity">Introducing SLSA, an End-to-End Framework for Supply Chain Integrity&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.ithome.com.tw/news/137953">供應鏈攻擊鎖定GitHub開源軟體專案&lt;/a>&lt;/li>
&lt;/ol>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>&lt;a href="https://docs.microsoft.com/zh-tw/windows/security/threat-protection/intelligence/supply-chain-malware">Supply chain integrity attacks&lt;/a>（供應鏈攻擊），在 source ➞ build ➞ publish 的 workflow 中存在著許多威脅，此手法為在使用 software package 的時候被注入惡意的行為，進而去感染用戶端，而且此方法在近幾年中也被證實可行性。&lt;/p>
&lt;p>在近幾個月也數以百萬的攻擊(e.g. &lt;a href="https://www.solarwinds.com/sa-overview/securityadvisory">SolarWinds&lt;/a>, &lt;a href="https://about.codecov.io/security-update/">Codecov&lt;/a>)。目前就很需要一個架構讓開發者們使用，來阻擋這些惡意攻擊。&lt;/p>
&lt;p>而 Google 就提出一個解決方案 &lt;a href="https://github.com/slsa-framework/slsa">Supply chain Levels for Software Artifacts&lt;/a> (SLSA, pronounced “salsa”)，此方案為 end-to-end 的框架，來確軟體供應鏈的安全。&lt;/p>
&lt;p>SLSA 主要增強目前軟體安全性的狀況，特別是針對 open source，來防止威脅。
在文中有張圖在講解軟體流程中的攻擊環節, 也有列出各個環節產生的問題以及解決方案.&lt;/p>
&lt;h2 id="what-is-slsa">What is SLSA&lt;/h2>
&lt;p>SLSA 的框架是由 4 個階段所組成。&lt;/p>
&lt;ul>
&lt;li>SLSA 1 要求構建過程完全腳本化 / 自動化並標示編譯出處.&lt;/li>
&lt;li>SLSA 2 需要使用版本控制和編譯後的識別碼.&lt;/li>
&lt;li>SLSA 3 進一步要求源和構建平台滿足特定標準, 以分別保證來源的可審計性和出處的完整性.&lt;/li>
&lt;li>SLSA 4 是目前最高級別, 需要兩個人審查所有更改和密封、可重複的構建過程.&lt;/li>
&lt;/ul>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>Supply chain integrity attacks—unauthorized modifications to software packages—have been &lt;a href="https://www.sonatype.com/hubfs/Corporate/Software%20Supply%20Chain/2020/SON_SSSC-Report-2020_final_aug11.pdf#page=7">on the rise&lt;/a> in the past two years, and are proving to be common and reliable attack vectors that affect all consumers of software. &lt;strong>&lt;span style="background-color: #ffffcc; color: red">The software development and deployment supply chain is quite complicated, with numerous threats along the source ➞ build ➞ publish workflow.&lt;/span> While point solutions do exist for some specific vulnerabilities, there is no comprehensive end-to-end framework that both defines how to mitigate threats across the software supply chain, and provides reasonable security guarantees.&lt;/strong>&lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">Our proposed solution is &lt;a href="https://github.com/slsa-framework/slsa">Supply chain Levels for Software Artifacts&lt;/a> (SLSA, pronounced “salsa”), an end-to-end framework for ensuring the integrity of software artifacts throughout the software supply chain.&lt;/span>&lt;/strong> It is inspired by Google’s internal “&lt;a href="https://cloud.google.com/security/binary-authorization-for-borg">Binary Authorization for Borg&lt;/a>” which has been in use for the past 8+ years and is mandatory for all of Google's production workloads.&lt;/p>
&lt;p>&lt;strong>How SLSA helps&lt;/strong>&lt;/p>
&lt;p>SLSA helps to protect against common supply chain attacks. The following image illustrates a typical software supply chain and includes examples of attacks that can occur at every link in the chain. Each type of attack has occurred over the past several years and, unfortunately, is increasing as time goes on.&lt;/p>
&lt;blockquote>
&lt;p>&lt;img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiuGpVbHMZ5-LDbnSMAQ-yTIyD-ghWpj_J3eQGamf2BrgSHm5VsrHZmTkXTaJtWTFycMnALI5d-8wRRxtfgOvtuHByRXUqVONyZYZicxP8g14pNTYpZrco-ZBxy5lYvBBoXLUBg1DFhmhZNxYiRYWznXwLc84AKYK3nHFehxQIBS3QRFpIHyxXe9IKi/s690/slsa%20threas.png" alt="">&lt;/p>
&lt;/blockquote>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>環節&lt;/th>
&lt;th>問題&lt;/th>
&lt;th>改善&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>A&lt;/td>
&lt;td>推了有漏洞的 code 上 SCM&lt;/td>
&lt;td>找 2 人以上做 code review,但無法確保找出全部漏洞&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>B&lt;/td>
&lt;td>軟弱的 SCM,被推送惡意代碼&lt;/td>
&lt;td>更好的保護 SCM 讓攻擊變困難&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>C&lt;/td>
&lt;td>SCM 上的 CICD 代碼被修改&lt;/td>
&lt;td>SLSA產生鑑定代碼,提供使用者查明來源&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>D&lt;/td>
&lt;td>Build platform 被安裝惡意行為的代碼,隨後將惡意代碼植入到被編譯的軟體上&lt;/td>
&lt;td>Build platform 進行更有效的安全機制,使攻擊變困難&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>E&lt;/td>
&lt;td>攻擊者注入無害的相依套件, 隨後修改其套件加入惡意行為&lt;/td>
&lt;td>檢查所有相依套件,檢查是否有參照其他來源&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>F&lt;/td>
&lt;td>攻擊者獲取 bucket 上傳密鑰,並上傳檔案到 GCS bucket。檔案上傳並非 CICD 流程的產出物&lt;/td>
&lt;td>GCS bucket上的檔案必須顯示檔案來源是否為 CICD 產出物&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>G&lt;/td>
&lt;td>軟弱的軟體庫,研究顯示流行的鏡像軟體庫,使用有惡意的軟體套件&lt;/td>
&lt;td>惡意套件顯示不是按照預期的流程與來源建構的&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>H&lt;/td>
&lt;td>攻擊者上傳名稱與流行套件很像的惡意套件,欺騙開發者使用&lt;/td>
&lt;td>SLSA不解決這問題,但可以增強代碼控制或其他解決方案&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;strong>What is SLSA&lt;/strong>&lt;/p>
&lt;p>&lt;strong>SLSA 1&lt;/strong> &lt;strong>&lt;span style="background-color: #ffffcc; color: red">requires that the build process be fully scripted/automated and generate provenance. Provenance is metadata about how an artifact was built, including the build process, top-level source, and dependencies.&lt;/span> Knowing the provenance allows software consumers to make risk-based security decisions.&lt;/strong> Though provenance at SLSA 1 does not protect against tampering, it offers a basic level of code source identification and may aid in vulnerability management.&lt;/p>
&lt;p>&lt;strong>SLSA 2&lt;/strong>  &lt;strong>&lt;span style="background-color: #ffffcc; color: red">requires using version control and a hosted build service that generates authenticated provenance.&lt;/span> These additional requirements give the consumer greater confidence in the origin of the software.&lt;/strong> At this level, the provenance prevents tampering to the extent that the build service is trusted. SLSA 2 also provides an easy upgrade path to SLSA 3.&lt;/p>
&lt;p>&lt;strong>SLSA 3&lt;/strong> &lt;strong>&lt;span style="background-color: #ffffcc; color: red">further requires that the source and build platforms meet specific standards to guarantee the auditability of the source and the integrity of the provenance, respectively.&lt;/span> We envision an accreditation process whereby auditors certify that platforms meet the requirements, which consumers can then rely on.&lt;/strong> SLSA 3 provides much stronger protections against tampering than earlier levels by preventing specific classes of threats, such as cross-build contamination.&lt;/p>
&lt;p>&lt;strong>SLSA 4&lt;/strong> &lt;strong>&lt;span style="background-color: #ffffcc; color: red">is currently the highest level, requiring two-person review of all changes and a hermetic, reproducible build process. Two-person review is an industry best practice for catching mistakes and deterring bad behavior.&lt;/span> Hermetic builds guarantee that the provenance’s list of dependencies is complete. Reproducible builds, though not strictly required, provide many auditability and reliability benefits.&lt;/strong> Overall, SLSA 4 gives the consumer a high degree of confidence that the software has not been tampered with.&lt;/p></description></item><item><title>Linux kernel 的網路參數 rp_filter</title><link>https://chiehting.com/posts/linux-kernel-rp-filter/</link><pubDate>Thu, 24 Jun 2021 14:39:00 +0800</pubDate><guid>https://chiehting.com/posts/linux-kernel-rp-filter/</guid><description>
&lt;p>這篇來記錄有關 Linux kernel 的 network 參數。&lt;/p>
&lt;h3 id="references">References&lt;/h3>
&lt;p>&lt;a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt">ip-sysctl&lt;/a>&lt;/p>
&lt;h3 id="rp_filter">rp_filter&lt;/h3>
&lt;p>為逆向路徑過濾 (Reverse Path Filtering)，其作用為為過濾反向不通的封包，將其丟棄。
而原理為由 NIC1 (network interface card) 進來的封包，reverse path filtering 模塊會將其封包的源地址（source ip）與目標地址（destination ip）做對調，然後再路由表中查找，如果出去的介面是 NIC1 則通過；反之不是 NIC1 則丟棄該封包。&lt;/p>
&lt;h4 id="功能概述">功能概述&lt;/h4>
&lt;p>&lt;code>rp_filter&lt;/code> 的主要作用是檢查接收到的資料包的來源位址是否是通過正確的網路介面到達的。如果資料包的來源位址與路由表中的反向路徑不匹配，&lt;code>rp_filter&lt;/code> 就會丟棄該資料包，從而防止偽造的 IP 資料包進入系統。&lt;/p>
&lt;h3 id="工作原理">工作原理&lt;/h3>
&lt;ol>
&lt;li>當系統接收到一個資料包時，&lt;code>rp_filter&lt;/code> 會檢查該資料包的來源位址。&lt;/li>
&lt;li>它根據路由表計算，若系統要將一個資料包發送到該來源位址，會使用哪個網路介面。&lt;/li>
&lt;li>如果接收到的資料包實際上是通過另一個介面到達的，而不是路由表中計算出的介面，&lt;code>rp_filter&lt;/code> 會認為這個資料包是偽造的，並將其丟棄。&lt;/li>
&lt;/ol>
&lt;p>可以從 &lt;a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt">ip-sysctl&lt;/a> 文件中找到參數的用法。其中該參數為整數型，其值包括了 0：不做來源驗證；1：嚴謹認證模式；2：寬鬆認證模式。&lt;/p>
&lt;pre>&lt;code>rp_filter - INTEGER
0 - No source validation.
1 - Strict mode as defined in RFC3704 Strict Reverse Path
Each incoming packet is tested against the FIB and if the interface
is not the best reverse path the packet check will fail.
By default failed packets are discarded.
2 - Loose mode as defined in RFC3704 Loose Reverse Path
Each incoming packet's source address is also tested against the FIB
and if the source address is not reachable via any interface
the packet check will fail.
Current recommended practice in RFC3704 is to enable strict mode
to prevent IP spoofing from DDos attacks. If using asymmetric routing
or other complicated routing, then loose mode is recommended.
The max value from conf/{all,interface}/rp_filter is used
when doing source validation on the {interface}.
Default value is 0. Note that some distributions enable it
in startup scripts.
&lt;/code>&lt;/pre>
&lt;h4 id="source-code">Source code&lt;/h4>
&lt;p>可以上網找到原始碼 &lt;a href="https://elixir.bootlin.com/linux/latest/source/net/ipv4/fib_frontend.c#L419">fib_frontend.c&lt;/a>，這邊來看一下實作方法。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="cm">/* Ignore rp_filter for packets protected by IPsec. */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">fib_validate_source&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__be32&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__be32&lt;/span> &lt;span class="n">dst&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="n">u8&lt;/span> &lt;span class="n">tos&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">oif&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">in_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">idev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">u32&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">itag&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="cm">/* 是否啟用反向封包過濾功能，這邊注意如果封包受 IPSec 保護則忽略反向封包過濾功能 */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">secpath_exists&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">IN_DEV_RPFILTER&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">idev&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">net&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">net&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dev_net&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">r&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">fib_num_tclassid_users&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">net&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ifindex&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">oif&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">IN_DEV_TX_REDIRECTS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">idev&lt;/span>&lt;span class="p">)))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="cm">/* 本地源的封包不執行反向封包過濾功能 */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">IN_DEV_ACCEPT_LOCAL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">idev&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="k">goto&lt;/span> &lt;span class="n">ok&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="cm">/* with custom local routes in place, checking local addresses
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="cm"> * only will be too optimistic, with custom rules, checking
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="cm"> * local addresses only can be too strict, e.g. due to vrf
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">net&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ipv4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">fib_has_custom_local_routes&lt;/span> &lt;span class="o">||&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="n">fib4_has_custom_rules&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">net&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="k">goto&lt;/span> &lt;span class="n">full_check&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">inet_lookup_ifaddr_rcu&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">net&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">EINVAL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="nl">ok&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="n">itag&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">&lt;span class="nl">full_check&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">__fib_validate_source&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dst&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tos&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">oif&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">r&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">idev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">itag&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">__fib_validate_source&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__be32&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">__be32&lt;/span> &lt;span class="n">dst&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="n">u8&lt;/span> &lt;span class="n">tos&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">oif&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">rpf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">in_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">idev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">u32&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">itag&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">net&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">net&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dev_net&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">flow_keys&lt;/span> &lt;span class="n">flkeys&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">no_addr&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">fib_result&lt;/span> &lt;span class="n">res&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">flowi4&lt;/span> &lt;span class="n">fl4&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="kt">bool&lt;/span> &lt;span class="n">dev_match&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_oif&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_iif&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">l3mdev_master_ifindex_rcu&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_iif&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_iif&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">oif&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="n">LOOPBACK_IFINDEX&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="cm">/* 可以看到這邊做反轉了 */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">daddr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">src&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">saddr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dst&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_tos&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tos&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_scope&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">RT_SCOPE_UNIVERSE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_tun_key&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">tun_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_flags&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_uid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sock_net_uid&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">net&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_multipath_hash&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> &lt;span class="n">no_addr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">idev&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ifa_list&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_mark&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">IN_DEV_SRC_VMARK&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">idev&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="nl">mark&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">fib4_rules_early_flow_dissect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">net&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">fl4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">flkeys&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_proto&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">fl4_sport&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">fl4_dport&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">fib_lookup&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">net&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">fl4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl"> &lt;span class="k">goto&lt;/span> &lt;span class="n">last_resort&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">type&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">RTN_UNICAST&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl"> &lt;span class="p">(&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">type&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">RTN_LOCAL&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">IN_DEV_ACCEPT_LOCAL&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">idev&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl"> &lt;span class="k">goto&lt;/span> &lt;span class="n">e_inval&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl"> &lt;span class="n">fib_combine_itag&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">itag&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">41&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">42&lt;/span>&lt;span class="cl"> &lt;span class="n">dev_match&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fib_info_nh_uses_dev&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">fi&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">43&lt;/span>&lt;span class="cl"> &lt;span class="cm">/* This is not common, loopback packets retain skb_dst so normally they
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">44&lt;/span>&lt;span class="cl">&lt;span class="cm"> * would not even hit this slow path.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">45&lt;/span>&lt;span class="cl">&lt;span class="cm"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">46&lt;/span>&lt;span class="cl"> &lt;span class="n">dev_match&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dev_match&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">RTN_LOCAL&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">47&lt;/span>&lt;span class="cl"> &lt;span class="n">dev&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">net&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">loopback_dev&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">48&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">dev_match&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">49&lt;/span>&lt;span class="cl"> &lt;span class="n">ret&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FIB_RES_NHC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">nhc_scope&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">RT_SCOPE_HOST&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">50&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">51&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">52&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">no_addr&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">53&lt;/span>&lt;span class="cl"> &lt;span class="k">goto&lt;/span> &lt;span class="n">last_resort&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">54&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">rpf&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">55&lt;/span>&lt;span class="cl"> &lt;span class="k">goto&lt;/span> &lt;span class="n">e_rpf&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">56&lt;/span>&lt;span class="cl"> &lt;span class="n">fl4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">flowi4_oif&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dev&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">ifindex&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">57&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">58&lt;/span>&lt;span class="cl"> &lt;span class="n">ret&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">59&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">fib_lookup&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">net&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">fl4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">FIB_LOOKUP_IGNORE_LINKSTATE&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">60&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">type&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">RTN_UNICAST&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">61&lt;/span>&lt;span class="cl"> &lt;span class="n">ret&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FIB_RES_NHC&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">res&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">nhc_scope&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">RT_SCOPE_HOST&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">62&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">63&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">ret&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">64&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">65&lt;/span>&lt;span class="cl">&lt;span class="nl">last_resort&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">66&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">rpf&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">67&lt;/span>&lt;span class="cl"> &lt;span class="k">goto&lt;/span> &lt;span class="n">e_rpf&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">68&lt;/span>&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="n">itag&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">69&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">70&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">71&lt;/span>&lt;span class="cl">&lt;span class="nl">e_inval&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">72&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">EINVAL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">73&lt;/span>&lt;span class="cl">&lt;span class="nl">e_rpf&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">74&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">EXDEV&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">75&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>參數：&lt;/p>
&lt;ul>
&lt;li>struct sk_buff - socket buffer&lt;/li>
&lt;li>__be32 src - source&lt;/li>
&lt;li>__be32 dst - destination&lt;/li>
&lt;li>&lt;a href="https://elixir.bootlin.com/linux/latest/source/include/linux/netdevice.h#L1853">struct net_device&lt;/a> - 網路結構體&lt;/li>
&lt;li>&lt;a href="https://elixir.bootlin.com/linux/latest/source/include/linux/inetdevice.h#L25">struct in_device&lt;/a> - 網路結構體&lt;/li>
&lt;li>saddr - start address&lt;/li>
&lt;li>daddr - destination address&lt;/li>
&lt;/ul>
&lt;p>科普：&lt;/p>
&lt;ul>
&lt;li>__bet32 - le 與 be 分別表示 little endian 和 big endian&lt;/li>
&lt;li>u8、u32 - 表示無符號 char 字符類型&lt;/li>
&lt;/ul>
&lt;h4 id="作用">作用&lt;/h4>
&lt;p>當前RFC3704文檔建議使用嚴謹認證模式。如果網路是非對稱網路或複雜的網路 rp_filter 建議配置為 2，做寬鬆認證。
而 rp_filter 配置作用通常為下列：&lt;/p>
&lt;ol>
&lt;li>減少 DDoS 攻擊，注意是減少不是防止&lt;/li>
&lt;li>防止 IP Spoofing&lt;/li>
&lt;/ol>
&lt;h3 id="問題">問題&lt;/h3>
&lt;h4 id="當系統只有一個網路介面時是否需要開啟-rp_filter-取決於具體的需求和安全性考量">當系統只有一個網路介面時，是否需要開啟 &lt;code>rp_filter&lt;/code> 取決於具體的需求和安全性考量。&lt;/h4>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>只有一個網路介面，且無特殊路由需求&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>如果系統只有一個網路介面，且路由配置相對簡單（例如，所有流量都通過該介面進出），那麼來源 IP 位址欺騙的風險較低。&lt;/li>
&lt;li>在這種情況下，開啟 &lt;code>rp_filter&lt;/code> 的作用有限，因為所有資料包都只能通過這唯一的網路介面進出。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>只有一個網路介面，但存在潛在的安全威脅&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>即使系統只有一個網路介面，攻擊者仍可能試圖通過偽造來源 IP 位址向系統發送惡意資料包。&lt;/li>
&lt;li>開啟 &lt;code>rp_filter&lt;/code> 可以增加一層安全性，確保接收到的資料包符合路由規則，從而防止這類攻擊。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>未來可能擴展到多網路介面&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>如果系統未來可能會增加更多網路介面，建議養成良好的安全習慣，提前配置 &lt;code>rp_filter&lt;/code>，以避免多介面時的安全漏洞。&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol></description></item><item><title>Understanding Docker network through iptables</title><link>https://chiehting.com/posts/docker-understanding-network-through-iptables/</link><pubDate>Mon, 21 Jun 2021 16:46:00 +0800</pubDate><guid>https://chiehting.com/posts/docker-understanding-network-through-iptables/</guid><description>
&lt;p>Docker 為主流的容器化技術之一，而 Docker 則是使用 iptables 做 provide network isolation。
這篇來了解 Docker 預設的 iptables 規則是什麼。&lt;/p>
&lt;p>之前有寫過 iptables guide([[iptables-guide]])，知道 iptables 底層是使用 Netfilter 模組作封包的控制。&lt;/p>
&lt;p>官方也有相關的資料可以參考 &lt;a href="https://docs.docker.com/network/iptables/">Docker and iptables&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>On Linux, Docker manipulates &lt;code>iptables&lt;/code> rules to provide network isolation. While this is an implementation detail and you should not modify the rules Docker inserts into your &lt;code>iptables&lt;/code> policies, it does have some implications on what you need to do if you want to have your own policies in addition to those managed by Docker.&lt;/p>
&lt;/blockquote>
&lt;h3 id="思路">思路&lt;/h3>
&lt;ol>
&lt;li>建立虛擬機，確認初始 network interface 與 iptables&lt;/li>
&lt;li>安裝 Docker 並確認 network interface 與 iptables&lt;/li>
&lt;li>建置 nginx 容器，測試封包走向&lt;/li>
&lt;/ol>
&lt;h3 id="環境與版本">環境與版本&lt;/h3>
&lt;p>OS：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# cat /etc/os-release
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">NAME&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;Ubuntu&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="nv">VERSION&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;20.04.2 LTS (Focal Fossa)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">・・・・・・
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Docker：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# docker version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Client: Docker Engine - Community
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> Version: 20.10.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> API version: 1.41
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">・・・・・・
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">Server: Docker Engine - Community
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> Engine:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> Version: 20.10.7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> API version: 1.41 &lt;span class="o">(&lt;/span>minimum version 1.12&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">・・・・・・
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> containerd:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> Version: 1.4.6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> GitCommit: d71fcd7d8303cbf684402823e425e9dd2e99285d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> runc:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> Version: 1.0.0-rc95
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> GitCommit: b9ee9c6314599f1b4a7f497e1f1f856fe433d3b7
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> docker-init:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> Version: 0.19.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> GitCommit: de40ad0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="確認初始的-iptables-rules">確認初始的 iptables rules&lt;/h3>
&lt;p>在一個新的虛擬機中，一開始的網路介面有 lo 跟 eth0。
其中 lo 為這虛擬機的 LOOPBACK 使用; 而 eth0 則為可廣播的網路介面使用。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# ip a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">65536&lt;/span> qdisc noqueue state UNKNOWN group default qlen &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> inet 127.0.0.1/8 scope host lo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> inet6 ::1/128 scope host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">9001&lt;/span> qdisc fq_codel state UP group default qlen &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> link/ether 06:3d:47:e2:09:ba brd ff:ff:ff:ff:ff:ff
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> inet 172.31.37.164/20 brd 172.31.47.255 scope global dynamic eth0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> valid_lft 3514sec preferred_lft 3514sec
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> inet6 fe80::43d:47ff:fee2:9ba/64 scope link
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>新的虛擬機中，一開始是沒有配置 Chain、Table 的。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t nat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Chain PREROUTING &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">6&lt;/span> packets, &lt;span class="m">328&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">Chain INPUT &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">6&lt;/span> packets, &lt;span class="m">328&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">Chain OUTPUT &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">0&lt;/span> packets, &lt;span class="m">0&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">Chain POSTROUTING &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">0&lt;/span> packets, &lt;span class="m">0&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t filter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">Chain INPUT &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">58&lt;/span> packets, &lt;span class="m">5352&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">Chain FORWARD &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">0&lt;/span> packets, &lt;span class="m">0&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">Chain OUTPUT &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">48&lt;/span> packets, &lt;span class="m">6066&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="安裝-docker-並且確認-iptables-rules">安裝 Docker 並且確認 iptables rules&lt;/h3>
&lt;h4 id="確認網路介面">確認網路介面&lt;/h4>
&lt;p>Docker 安裝完成後，看到新增了一個網路介面 docker0。
其 docker0 的網路介面 ip 位置可以看到被分配到 172.17.0.1/16 的 private ip。而 router 部分則看到 172.17.0.0/16 網段都 link src 172.17.0.1。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># ip address&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# ip a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">・・・・・・
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">3: docker0: &amp;lt;NO-CARRIER,BROADCAST,MULTICAST,UP&amp;gt; mtu &lt;span class="m">1500&lt;/span> qdisc noqueue state DOWN group default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> link/ether 02:42:d3:81:15:1c brd ff:ff:ff:ff:ff:ff
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="c1"># ip route&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# ip r
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">default via 172.31.32.1 dev eth0 proto dhcp src 172.31.37.164 metric &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">172.31.32.0/20 dev eth0 proto kernel scope link src 172.31.37.164
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">172.31.32.1 dev eth0 proto dhcp scope link src 172.31.37.164 metric &lt;span class="m">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="c1"># ip route show table local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# ip r show table &lt;span class="nb">local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="nb">local&lt;/span> 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="nb">local&lt;/span> 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">broadcast 172.17.0.0 dev docker0 proto kernel scope link src 172.17.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="nb">local&lt;/span> 172.17.0.1 dev docker0 proto kernel scope host src 172.17.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">broadcast 172.17.255.255 dev docker0 proto kernel scope link src 172.17.0.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">broadcast 172.31.32.0 dev eth0 proto kernel scope link src 172.31.37.164
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="nb">local&lt;/span> 172.31.37.164 dev eth0 proto kernel scope host src 172.31.37.164
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">broadcast 172.31.47.255 dev eth0 proto kernel scope link src 172.31.37.164
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="確認-iptables-的-nat-table">確認 iptables 的 NAT Table&lt;/h4>
&lt;p>下面列出了 nat table 的 Chain。看到新增了多個 Chain &lt;code>DOCKER&lt;/code>，而這 Chain 被 references 在 PREROUTING、OUTPUT 中。
而我們知道 iptables 的規則是從上至下順序執行，直至匹配的的規則為止，否則執行預設 policy。&lt;/p>
&lt;p>下面說明 nat table 的 Chain：&lt;/p>
&lt;ol>
&lt;li>&lt;code>PREROUTING num 1&lt;/code> 是指如果進來的封包目的地址 match LOCAL 都跳到 Chain DOCKER，這邊要注意 LOCAL 並不是指本地，可以使用 &amp;quot;ip route show table local&amp;quot; 命令來確認哪些 ip 為 LOCAL
&lt;ol>
&lt;li>&lt;code>DOCKER num 1&lt;/code> 指如果封包是從 docker0 網路介面進來的，則結束 Chain DOCKER 然後返回原來的 Chain 繼續跑規則&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&lt;code>OUTPUT num 1&lt;/code> 是指如果出去封包目的地址 match LOCAL 都跳到 Chain DOCKER，除了 127.0.0.0/8 網段
&lt;ol>
&lt;li>&lt;code>DOCKER num 1&lt;/code> 指如果封包是從 docker0 網路介面進來的，則結束 Chain DOCKER 然後返回原來的 Chain 繼續跑規則&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&lt;code>POSTROUTING num 1&lt;/code> 是指如果出去封包不是 docker0 網路介面和 ip 來源是 172.17.0.0/16 時，不做修改&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t nat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Chain PREROUTING &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">6&lt;/span> packets, &lt;span class="m">328&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">14138&lt;/span> 743K DOCKER all -- * * 0.0.0.0/0 0.0.0.0/0 ADDRTYPE match dst-type LOCAL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">Chain INPUT &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">6&lt;/span> packets, &lt;span class="m">328&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">Chain OUTPUT &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">0&lt;/span> packets, &lt;span class="m">0&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">4&lt;/span> &lt;span class="m">240&lt;/span> DOCKER all -- * * 0.0.0.0/0 !127.0.0.0/8 ADDRTYPE match dst-type LOCAL
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">Chain POSTROUTING &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">0&lt;/span> packets, &lt;span class="m">0&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">34&lt;/span> &lt;span class="m">2073&lt;/span> MASQUERADE all -- * !docker0 172.17.0.0/16 0.0.0.0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">Chain DOCKER &lt;span class="o">(&lt;/span>&lt;span class="m">2&lt;/span> references&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">19&lt;/span> &lt;span class="m">1140&lt;/span> RETURN all -- docker0 * 0.0.0.0/0 0.0.0.0/0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="確認-iptables-的-filter-table">確認 iptables 的 Filter Table&lt;/h4>
&lt;p>可以看到新增了多個 Chain &lt;code>DOCKER&lt;/code>、&lt;code>DOCKER-ISOLATION-STAGE-1&lt;/code>、&lt;code>DOCKER-ISOLATION-STAGE-2&lt;/code>、&lt;code>DOCKER-USER&lt;/code>，而這些 Chain 都被 references 在 FORWARD 中。
可以看到 Chain FORWARD 的預設 policy 已經被改為 DROP，而我們知道 iptables 的規則是從上至下順序執行，直至匹配的的規則為止，否則執行預設 policy。&lt;/p>
&lt;p>看到 FORWARD 的規則：&lt;/p>
&lt;ol>
&lt;li>&lt;code>FORWARD num 1&lt;/code> 規則是跳到 &lt;code>DOCKER-USER&lt;/code> 鏈中
&lt;ol>
&lt;li>&lt;code>DOCKER-USER num 1&lt;/code> 規則是 RETURN 封包，回 &lt;code>FORWARD&lt;/code> 中繼續直執行其他的規則&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&lt;code>FORWARD num 2&lt;/code> 規則是跳到 &lt;code>DOCKER-ISOLATION-STAGE-1&lt;/code> 鏈中
&lt;ol>
&lt;li>&lt;code>DOCKER-ISOLATION-STAGE-1 num 1&lt;/code> 封包又跳到 &lt;code>DOCKER-ISOLATION-STAGE-2&lt;/code> 鏈中
&lt;ol>
&lt;li>&lt;code>DOCKER-ISOLATION-STAGE-2 num 1&lt;/code> 丟棄所有 docker0 網路介面出去的封包&lt;/li>
&lt;li>&lt;code>DOCKER-ISOLATION-STAGE-2 num 2&lt;/code> RETURN 所有封包繼續執封包繼續執行 &lt;code>DOCKER-ISOLATION-STAGE-1&lt;/code> 的其他規則&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&lt;code>DOCKER-ISOLATION-STAGE-1 num 2&lt;/code> RETURN 所有封包繼續執封包繼續執行 &lt;code>FORWARD&lt;/code> 的其他規則&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&lt;code>FORWARD num 3&lt;/code> 規則為允許由 docker0 網路介面出去的封包，但封包狀態是 RELATED,ESTABLISHED&lt;/li>
&lt;li>&lt;code>FORWARD num 4&lt;/code> 規則為當封包是 docker0 網路介面出去的，則跳到 &lt;code>DOCKER&lt;/code> 鏈中
&lt;ol>
&lt;li>&lt;code>DOCKER&lt;/code> 暫無規則&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>&lt;code>FORWARD num 5&lt;/code>、&lt;code>FORWARD num 6&lt;/code> 為允許經由 docker0 網路介面近來的所有封包進出&lt;/li>
&lt;li>不在上述規則中的封包全部都 drop&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t fillter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Chain INPUT &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">385&lt;/span> packets, &lt;span class="m">28200&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">Chain FORWARD &lt;span class="o">(&lt;/span>policy DROP &lt;span class="m">0&lt;/span> packets, &lt;span class="m">0&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> DOCKER-USER all -- * * 0.0.0.0/0 0.0.0.0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> DOCKER-ISOLATION-STAGE-1 all -- * * 0.0.0.0/0 0.0.0.0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="m">3&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> ACCEPT all -- * docker0 0.0.0.0/0 0.0.0.0/0 ctstate RELATED,ESTABLISHED
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="m">4&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> DOCKER all -- * docker0 0.0.0.0/0 0.0.0.0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="m">5&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> ACCEPT all -- docker0 !docker0 0.0.0.0/0 0.0.0.0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="m">6&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> ACCEPT all -- docker0 docker0 0.0.0.0/0 0.0.0.0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">Chain OUTPUT &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">304&lt;/span> packets, &lt;span class="m">59638&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">Chain DOCKER &lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> references&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">Chain DOCKER-ISOLATION-STAGE-1 &lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> references&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> DOCKER-ISOLATION-STAGE-2 all -- docker0 !docker0 0.0.0.0/0 0.0.0.0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> RETURN all -- * * 0.0.0.0/0 0.0.0.0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">Chain DOCKER-ISOLATION-STAGE-2 &lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> references&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> DROP all -- * docker0 0.0.0.0/0 0.0.0.0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> RETURN all -- * * 0.0.0.0/0 0.0.0.0/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">Chain DOCKER-USER &lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> references&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> RETURN all -- * * 0.0.0.0/0 0.0.0.0/0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="建置-nginx-容器測試封包走向">建置 nginx 容器，測試封包走向&lt;/h3>
&lt;p>啟動 container nginx&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">docker run --name nginx -p 80:80 -d nginx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="查看本機-listen-port">查看本機 listen port&lt;/h4>
&lt;p>看到 port 80 被 docker-proxy 監聽著&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# netstat -tlnp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">Active Internet connections &lt;span class="o">(&lt;/span>only servers&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">tcp &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 0.0.0.0:80 0.0.0.0:* LISTEN 253681/docker-proxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">tcp &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 127.0.0.53:53 0.0.0.0:* LISTEN 370/systemd-resolve
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">tcp &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 0.0.0.0:22 0.0.0.0:* LISTEN 576/sshd: /usr/sbin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">tcp6 &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> :::80 :::* LISTEN 253686/docker-proxy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">tcp6 &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> :::22 :::* LISTEN 576/sshd: /usr/sbin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="確認網路變化">確認網路變化&lt;/h4>
&lt;p>網路介面新增了 &lt;code>veth3ce1bed&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:~# ip link
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">65536&lt;/span> qdisc noqueue state UNKNOWN mode DEFAULT group default qlen &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">9001&lt;/span> qdisc fq_codel state UP mode DEFAULT group default qlen &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> link/ether 06:3d:47:e2:09:ba brd ff:ff:ff:ff:ff:ff
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">18: docker0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">1500&lt;/span> qdisc noqueue state UP mode DEFAULT group default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl"> link/ether 02:42:55:24:1f:ed brd ff:ff:ff:ff:ff:ff
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">22: veth3ce1bed@if21: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">1500&lt;/span> qdisc noqueue master docker0 state UP mode DEFAULT group default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl"> link/ether ea:ba:b9:7b:48:ea brd ff:ff:ff:ff:ff:ff link-netnsid &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>還有將新增的網路介面 &lt;code>veth3ce1bed&lt;/code> 橋接在 &lt;code>docker0&lt;/code> 上。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:~# brctl show
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">bridge name bridge id STP enabled interfaces
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">docker0 8000.024255241fed no veth3ce1bed
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>iptables NAT table 新增了兩條規則。&lt;/p>
&lt;ol>
&lt;li>&lt;code>POSTROUTING&lt;/code> 封包來源為封包目的為 172.17.0.2 地址為裝封包內容 tcp dpt:80&lt;/li>
&lt;li>&lt;code>DOCKER num 2&lt;/code> 規則為所有非 docker0 網路介面近來且 tcp dpt:80 的封包，改到 172.17.0.2:80&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">iptables -L -n -v --line-numbers -t nat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">Chain POSTROUTING &lt;span class="o">(&lt;/span>policy ACCEPT &lt;span class="m">266&lt;/span> packets, &lt;span class="m">17090&lt;/span> bytes&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="m">2&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> MASQUERADE tcp -- * * 172.17.0.2 172.17.0.2 tcp dpt:80
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">Chain DOCKER &lt;span class="o">(&lt;/span>&lt;span class="m">2&lt;/span> references&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">&lt;span class="m">2&lt;/span> &lt;span class="m">136&lt;/span> &lt;span class="m">7472&lt;/span> DNAT tcp -- !docker0 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:80 to:172.17.0.2:80
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# iptables -L -n -v --line-numbers -t filter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">Chain DOCKER &lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> references&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">num pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> &lt;span class="m">123&lt;/span> &lt;span class="m">6692&lt;/span> ACCEPT tcp -- !docker0 docker0 0.0.0.0/0 172.17.0.2 tcp dpt:80
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="測試封包走向">測試封包走向&lt;/h4>
&lt;p>在不同 client 端嘗試連上 nginx 服務，觀察封包所經過的網路規則。&lt;/p>
&lt;p>監控 iptalbes 的 pkts 變化。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# watch iptables -L -n -v --line-numbers -t nat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">root@ip-172-31-37-164:/home/ubuntu# watch iptables -L -n -v --line-numbers -t filter
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>監控 docker0 網路介面的封包裝況。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">tcpdump -i docker0 -q -v tcp port &lt;span class="m">80&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Elasticsearch 效率優化 (1)</title><link>https://chiehting.com/posts/elasticsearch-enhance-performance-1/</link><pubDate>Fri, 04 Jun 2021 15:42:00 +0800</pubDate><guid>https://chiehting.com/posts/elasticsearch-enhance-performance-1/</guid><description>
&lt;p>現在使用 Kubernetes 容器架構，搭配了 elk 做為我們的 logging solution。
但是目前使用預設的配置，在搜尋 log 時效率很慢。
這邊紀錄排查 index 的狀況，並且嘗試做改善。&lt;/p>
&lt;h3 id="思路">思路&lt;/h3>
&lt;ol>
&lt;li>先確認目前 index 狀況，評估可以優化的部分。&lt;/li>
&lt;li>新建兩個 index，分別為原本的設定 test-old；調整過後的設定 test-new。&lt;/li>
&lt;li>從舊有的 index 中抓出 n 筆資料，分邊寫入新建的兩的 index。&lt;/li>
&lt;li>比較兩個 index 效率。&lt;/li>
&lt;/ol>
&lt;h4 id="先確認目前-index-狀況評估可以優化的部分">先確認目前 index 狀況，評估可以優化的部分&lt;/h4>
&lt;p>Index 的設定：可以看到第 9、13、27 行被折疊了大量的行數，也就是說我們使用了很多不必要的欄位。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">GET /kubernetes-prod
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl"> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="err">1&lt;/span> &lt;span class="nt">&amp;#34;kubernetes-prod&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="err">2&lt;/span> &lt;span class="nt">&amp;#34;aliases&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="err">3&lt;/span> &lt;span class="nt">&amp;#34;mappings&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="err">4&lt;/span> &lt;span class="nt">&amp;#34;_meta&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="err">5&lt;/span> &lt;span class="nt">&amp;#34;beat&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;filebeat&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="err">6&lt;/span> &lt;span class="nt">&amp;#34;version&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;7.9.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="mi">7&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="err">8&lt;/span> &lt;span class="nt">&amp;#34;dynamic_templates&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="mi">9&lt;/span> &lt;span class="err">+----&lt;/span>&lt;span class="mi">-132&lt;/span> &lt;span class="err">lines:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">································&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="err">10&lt;/span> &lt;span class="err">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="err">11&lt;/span> &lt;span class="nt">&amp;#34;date_detection&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="err">12&lt;/span> &lt;span class="nt">&amp;#34;properties&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="err">13&lt;/span> &lt;span class="err">+-----20620&lt;/span> &lt;span class="err">lines:&lt;/span> &lt;span class="nt">&amp;#34;@timestamp&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">···············&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="err">14&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="mi">15&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="err">16&lt;/span> &lt;span class="nt">&amp;#34;settings&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="err">17&lt;/span> &lt;span class="nt">&amp;#34;index&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="err">18&lt;/span> &lt;span class="nt">&amp;#34;mapping&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="err">19&lt;/span> &lt;span class="nt">&amp;#34;total_fields&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="err">20&lt;/span> &lt;span class="nt">&amp;#34;limit&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;10000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="mi">21&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="mi">22&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="err">23&lt;/span> &lt;span class="nt">&amp;#34;refresh_interval&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;5s&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> &lt;span class="err">24&lt;/span> &lt;span class="nt">&amp;#34;provided_name&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;kubernetes-prod&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> &lt;span class="err">25&lt;/span> &lt;span class="nt">&amp;#34;query&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> &lt;span class="err">26&lt;/span> &lt;span class="nt">&amp;#34;default_field&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> &lt;span class="mi">27&lt;/span> &lt;span class="err">+------&lt;/span>&lt;span class="mi">-875&lt;/span> &lt;span class="err">lines:&lt;/span> &lt;span class="s2">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="err">······················&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> &lt;span class="mi">28&lt;/span> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> &lt;span class="mi">29&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> &lt;span class="err">30&lt;/span> &lt;span class="nt">&amp;#34;creation_date&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1623044585326&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> &lt;span class="err">31&lt;/span> &lt;span class="nt">&amp;#34;priority&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;100&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> &lt;span class="err">32&lt;/span> &lt;span class="nt">&amp;#34;number_of_replicas&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl"> &lt;span class="err">33&lt;/span> &lt;span class="nt">&amp;#34;uuid&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;uuid&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl"> &lt;span class="err">34&lt;/span> &lt;span class="nt">&amp;#34;version&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl"> &lt;span class="err">35&lt;/span> &lt;span class="nt">&amp;#34;created&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;7100099&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl"> &lt;span class="mi">36&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl"> &lt;span class="err">37&lt;/span> &lt;span class="nt">&amp;#34;lifecycle&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl"> &lt;span class="err">38&lt;/span> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;kubernetes-prod&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl"> &lt;span class="err">39&lt;/span> &lt;span class="nt">&amp;#34;rollover_alias&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;kubernetes-prod&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">41&lt;/span>&lt;span class="cl"> &lt;span class="mi">40&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">42&lt;/span>&lt;span class="cl"> &lt;span class="err">41&lt;/span> &lt;span class="nt">&amp;#34;routing&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">43&lt;/span>&lt;span class="cl"> &lt;span class="err">42&lt;/span> &lt;span class="nt">&amp;#34;allocation&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">44&lt;/span>&lt;span class="cl"> &lt;span class="err">43&lt;/span> &lt;span class="nt">&amp;#34;include&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">45&lt;/span>&lt;span class="cl"> &lt;span class="err">44&lt;/span> &lt;span class="nt">&amp;#34;_tier_preference&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;data_content&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">46&lt;/span>&lt;span class="cl"> &lt;span class="mi">45&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">47&lt;/span>&lt;span class="cl"> &lt;span class="mi">46&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">48&lt;/span>&lt;span class="cl"> &lt;span class="mi">47&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">49&lt;/span>&lt;span class="cl"> &lt;span class="err">48&lt;/span> &lt;span class="nt">&amp;#34;number_of_shards&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">50&lt;/span>&lt;span class="cl"> &lt;span class="err">49&lt;/span> &lt;span class="nt">&amp;#34;max_docvalue_fields_search&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;200&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">51&lt;/span>&lt;span class="cl"> &lt;span class="mi">50&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">52&lt;/span>&lt;span class="cl"> &lt;span class="mi">51&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">53&lt;/span>&lt;span class="cl"> &lt;span class="mi">52&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">54&lt;/span>&lt;span class="cl"> &lt;span class="mi">53&lt;/span> &lt;span class="err">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Index lifecycle policies 的配置：原本 index 設計為 一天一個 index，ilm 的部分規則就是 60 天後刪除。這部分 index 太零散。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">GET _ilm/policy/kubernetes-prod
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;kubernetes-prod&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;version&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;modified_date&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2021-02-01T12:37:13.306Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;policy&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;phases&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;hot&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;min_age&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;0ms&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;actions&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;set_priority&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;priority&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;delete&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;min_age&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;60d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;actions&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;delete&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;delete_searchable_snapshot&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>這邊預計優化 index 的部分如下：&lt;/p>
&lt;ol>
&lt;li>移除不必要的屬性。&lt;/li>
&lt;li>不需要動態配置 index 結構，使用 &lt;code>dynamic: false&lt;/code>。&lt;/li>
&lt;li>配置正確的欄位資料型態。&lt;/li>
&lt;li>Index 改為一個環境一個，並配置 ilm 的 rollover 配置。&lt;/li>
&lt;li>Kibana 的 index patterns 使用 filter 處理。&lt;/li>
&lt;/ol>
&lt;h4 id="新建兩個-index分別為-test-oldtest-new">新建兩個 index，分別為 test-old、test-new&lt;/h4>
&lt;p>test-old 的 json 檔案又臭又長，這邊就不記錄了。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">PUT /test-old
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="o">{&lt;/span>json&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>test-new 的 json 範例檔案放在 &lt;a href="https://raw.githubusercontent.com/chiehting/lab/master/elasticsearch/index-template-kubernetes.json">Github&lt;/a> 上。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 建立 index template&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">PUT /_index_template/test-new
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="o">{&lt;/span>json&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1"># 建立 index&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">PUT /test-new
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看結果，可以看到 index 已經被建立，並且沒有任何 documents。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">GET _cat/indices?v&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="nv">index&lt;/span>&lt;span class="o">=&lt;/span>test*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">health status index uuid pri rep docs.count docs.deleted store.size pri.store.size
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">green open test-new oaQjuBzFTiKLhnzPpm6bXQ &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 208b 208b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">green open test-old iMNI2tWAQASzUCjYHrWB6Q &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> 208b 208b
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="從舊有的-index-中抓出-n-筆資料分邊寫入新建的兩的-index">從舊有的 index 中抓出 n 筆資料，分邊寫入新建的兩的 index&lt;/h4>
&lt;p>使用 bulk 批次插入資料，注意 json 不可以斷行（資料量過多會出錯）。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="err">POST&lt;/span> &lt;span class="err">/test-new/_bulk&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">:{}&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;message&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;foo&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">:{}&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span> &lt;span class="nt">&amp;#34;message&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;bar&amp;#34;&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>由於資料過多，使用 Dev Tools 出錯，改使用 curl 匯入，分別匯入 test-old、test-new。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">curl -XPOST --user elastic:password http://elasticsearch.example.com:9200/test-old/_bulk -H &lt;span class="s2">&amp;#34;Content-Type: application/json&amp;#34;&lt;/span> --data-binary @/Users/chiehtinglee/tmp.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">curl -XPOST --user elastic:password http://elasticsearch.example.com:9200/test-old/_bulk -H &lt;span class="s2">&amp;#34;Content-Type: application/json&amp;#34;&lt;/span> --data-binary @/Users/chiehtinglee/tmp.json
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看是否有執行成功，這邊可以看到 docs.count 各為 1000 筆資料。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">GET _cat/indices?v&lt;span class="p">&amp;amp;&lt;/span>&lt;span class="nv">index&lt;/span>&lt;span class="o">=&lt;/span>test*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">health status index uuid pri rep docs.count docs.deleted store.size pri.store.size
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">green open test-new _DvAB-_rQvKJ1lG1eWsj6Q &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1000&lt;/span> &lt;span class="m">0&lt;/span> 210.3kb 210.3kb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">green open test-old iMNI2tWAQASzUCjYHrWB6Q &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1000&lt;/span> &lt;span class="m">0&lt;/span> 210.3kb 210.3kb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="比較兩個-index-效率">比較兩個 index 效率&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>record&lt;/th>
&lt;th>old time&lt;/th>
&lt;th>old size&lt;/th>
&lt;th>new time&lt;/th>
&lt;th>new size&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>1049 ms&lt;/td>
&lt;td>23.8 kB&lt;/td>
&lt;td>669 ms&lt;/td>
&lt;td>22.7 kB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>1321 ms&lt;/td>
&lt;td>24.0 kB&lt;/td>
&lt;td>907 ms&lt;/td>
&lt;td>22.6 kB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>1414 ms&lt;/td>
&lt;td>24.0 kB&lt;/td>
&lt;td>728 ms&lt;/td>
&lt;td>22.6 kB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>1818 ms&lt;/td>
&lt;td>23.9 kB&lt;/td>
&lt;td>932 ms&lt;/td>
&lt;td>22.8 kB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>5&lt;/td>
&lt;td>1302 ms&lt;/td>
&lt;td>23.8 kB&lt;/td>
&lt;td>641 ms&lt;/td>
&lt;td>22.8 kB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>6&lt;/td>
&lt;td>1620 ms&lt;/td>
&lt;td>23.8 kB&lt;/td>
&lt;td>685 ms&lt;/td>
&lt;td>22.8 kB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>7&lt;/td>
&lt;td>1505 ms&lt;/td>
&lt;td>23.8 kB&lt;/td>
&lt;td>686 ms&lt;/td>
&lt;td>22.7 kB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>7&lt;/td>
&lt;td>1505 ms&lt;/td>
&lt;td>23.8 kB&lt;/td>
&lt;td>908 ms&lt;/td>
&lt;td>22.6 kB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>8&lt;/td>
&lt;td>1334 ms&lt;/td>
&lt;td>23.9 kB&lt;/td>
&lt;td>794 ms&lt;/td>
&lt;td>22.9 kB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>9&lt;/td>
&lt;td>1535 ms&lt;/td>
&lt;td>23.9 kB&lt;/td>
&lt;td>831 ms&lt;/td>
&lt;td>22.7 kB&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>10&lt;/td>
&lt;td>1479 ms&lt;/td>
&lt;td>23.8 kB&lt;/td>
&lt;td>889 ms&lt;/td>
&lt;td>22.7 kB&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>這邊比較結果，效率提升約 183%。&lt;/p>
&lt;ul>
&lt;li>舊的 index 花費時間平均為 sum(old time) / 10 = 1588.2&lt;/li>
&lt;li>新的 index 花費時間平均為 sum(new time) / 10 = 867&lt;/li>
&lt;/ul>
&lt;h4 id="補充">補充&lt;/h4>
&lt;h5 id="clone-index">clone index&lt;/h5>
&lt;p>確認目前 index 的 setting 狀況，確認有沒有 &lt;code>index.blocks.write&lt;/code> 為 &lt;code>true&lt;/code> 的設定。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">GET /kubernetes-prod-2021.06.02/_settings
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>若沒有就配置 &lt;code>index.blocks.write&lt;/code> 為 &lt;code>true&lt;/code>，如果要移除則設定為 &lt;code>null&lt;/code>。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">PUT /kubernetes-prod-2021.06.02/_settings
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;settings&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;index.blocks.write&amp;#34;&lt;/span>: &lt;span class="nb">true&lt;/span> &lt;span class="c1"># null&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>執行 clone index &lt;code>kubernetes-prod-2021.06.02&lt;/code> 為 &lt;code>old&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">POST /kubernetes-prod-2021.06.02/_clone/old
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Elasticsearch 效率優化 (2)</title><link>https://chiehting.com/posts/elasticsearch-enhance-performance-2/</link><pubDate>Fri, 04 Jun 2021 15:42:00 +0800</pubDate><guid>https://chiehting.com/posts/elasticsearch-enhance-performance-2/</guid><description>
&lt;p>在 elasticsearch performance 1([[elasticsearch-enhance-performance-1]]) 中做了第一階段的優化。
這篇再來強化 index 的管理。&lt;/p>
&lt;h3 id="思路">思路&lt;/h3>
&lt;ol>
&lt;li>Log 量變大直接影響到 index 的大小，所以要讓 index 做 rollover。&lt;/li>
&lt;li>由於做了 rollover，所以 index 名稱會不固定，所以使用 alias，並且做 filter 的處理。&lt;/li>
&lt;li>調整 Filebeat 的 index 名稱，改用 alias 寫入 log。&lt;/li>
&lt;/ol>
&lt;h4 id="log-量變大直接影響到-index-的大小所以要讓-index-做-rollover">Log 量變大直接影響到 index 的大小，所以要讓 index 做 rollover&lt;/h4>
&lt;p>先建立一個 index lifecycle management，名稱為 kubernetes。
可以看到 hot 階段的 rollover 配置，如果 index size 大於 20G 或者 index age 大於 15 天，就自動生成一個新的 index。&lt;/p>
&lt;p>API：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">PUT _ilm/policy/&amp;lt;policy_id&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Json：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;kubernetes&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;version&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;modified_date&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2021-06-18T06:24:15.524Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;policy&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;phases&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="err">+--&lt;/span> &lt;span class="err">21&lt;/span> &lt;span class="err">lines:&lt;/span> &lt;span class="nt">&amp;#34;warm&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">···········································&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="err">+--&lt;/span> &lt;span class="err">10&lt;/span> &lt;span class="err">lines:&lt;/span> &lt;span class="nt">&amp;#34;cold&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">···········································&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;hot&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;min_age&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;0ms&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;actions&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;readonly&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;shrink&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;number_of_shards&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;rollover&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;max_primary_shard_size&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;20gb&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;max_age&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;15d&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;forcemerge&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;max_num_segments&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;set_priority&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;priority&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="err">+---&lt;/span> &lt;span class="err">8&lt;/span> &lt;span class="err">lines:&lt;/span> &lt;span class="nt">&amp;#34;delete&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>&lt;span class="err">········································&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="由於做了-rollover所以-index-名稱會不固定所以使用-alias並且做-filter-的處理">由於做了 rollover，所以 index 名稱會不固定，所以使用 alias，並且做 filter 的處理&lt;/h4>
&lt;p>這邊建立一個 index，注意如果使用 rollover，index 名稱的結尾必須以 &lt;code>-&lt;/code> 加 &lt;code>number&lt;/code> 作為結為，例如 kubernetes-dev-000001。
之後 ilm 在做 rollover 時會自動遞增 &lt;code>number&lt;/code>。&lt;/p>
&lt;p>先建置一個 index，並使用 index template 指定 ilm 為剛剛建立的 kubernetes。&lt;/p>
&lt;p>API：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">PUT kubernetes-dev-000001
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>建立一個 alias dev 並指向 index kubernetes-dev-000001。其中要注意 &lt;code>&amp;quot;is_write_index&amp;quot;: true&lt;/code>，這個配置是讓 Filebeat 可以使用 alias 寫入 log。
下面範例可以看到建置了 filter，包括了限制這個 alias 只能查到近 60 天的資料，以及 kubernets 的 namespace 必須為 dev。&lt;/p>
&lt;p>API：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">POST /_aliases
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Json：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;actions&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;add&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;index&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;kubernetes-dev-000001&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;alias&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;dev&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;is_write_index&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">true&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;filter&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;bool&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>&lt;span class="nt">&amp;#34;filter&amp;#34;&lt;/span>&lt;span class="p">:[{&lt;/span>&lt;span class="nt">&amp;#34;range&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>&lt;span class="nt">&amp;#34;@timestamp&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>&lt;span class="nt">&amp;#34;gte&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;now-60d/d&amp;#34;&lt;/span>&lt;span class="p">}}},{&lt;/span>&lt;span class="nt">&amp;#34;term&amp;#34;&lt;/span>&lt;span class="p">:{&lt;/span>&lt;span class="nt">&amp;#34;kubernetes.namespace&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="s2">&amp;#34;dev&amp;#34;&lt;/span>&lt;span class="p">}}]}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="調整-filebeat-的-index-名稱改用-alias-寫入-log">調整 Filebeat 的 index 名稱，改用 alias 寫入 log&lt;/h4>
&lt;p>這邊為 Filebeat 的設定檔，可以看到 &lt;code>output.elasticsearch.inde: 'dev'&lt;/code> 是指向我們所建立的 alias dev。就不用管 ilm 遞增 index 的 &lt;code>number&lt;/code> 時會影響到我們的寫入。&lt;/p>
&lt;p>Yaml：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">filebeat.autodiscover&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">providers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubernetes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">node&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${NODE_NAME}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">templates&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">config&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">container&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">paths&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;/var/log/containers/*-${data.kubernetes.container.id}.log&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">exclude_files&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">+-- 3 lines&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="l">/var/log/containers/filebeat.*.log················&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">exclude_lines&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">+-- 3 lines&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>- &lt;span class="s2">&amp;#34;^$&amp;#34;&lt;/span>&lt;span class="l">··············································&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">output.elasticsearch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hosts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;${ELASTICSEARCH_HOST:elasticsearch}:${ELASTICSEARCH_PORT:9200}&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">index&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;dev&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">username&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${ELASTICSEARCH_USERNAME}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">password&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${ELASTICSEARCH_PASSWORD}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">setup.ilm.enabled&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">setup.ilm.policy_name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;kubernetes&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">setup.template.name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;kubernetes&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">setup.template.pattern&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;kubernetes-*&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">setup.template.settings.index.lifecycle.name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;kubernetes&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">setup.template.settings.index.lifecycle.rollover_alias&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;dev&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="補充">補充&lt;/h4>
&lt;p>碰到 index 被鎖住時，將其開啟。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">PUT /_all/_settings
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &amp;#34;index.blocks.write&amp;#34;: null
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">PUT /_all/_settings
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &amp;#34;index.blocks.read_only_allow_delete&amp;#34;: null
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Elasticsearch 用戶管理</title><link>https://chiehting.com/posts/elasticsearch-bind-ldap/</link><pubDate>Thu, 03 Jun 2021 14:00:00 +0800</pubDate><guid>https://chiehting.com/posts/elasticsearch-bind-ldap/</guid><description>
&lt;p>本來想使用 LDAP 管理登入帳號，但看到 log 顯示目前的 license (Basic license) 不支援 LDAP。&lt;/p>
&lt;p>&lt;a href="https://discuss.elastic.co/t/ldap-needs-a-license-for-use/213536">LDAP needs a license for use&lt;/a>&lt;/p>
&lt;h3 id="版本資訊">版本資訊&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;node1&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;cluster_name&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;elasticsearch&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;cluster_uuid&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;xxxxxxxxxxxxxxxx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;version&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;number&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;7.10.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;build_flavor&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;default&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;build_type&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;deb&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;build_hash&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;xxxxxxxxxxxxxxxx&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;build_date&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2020-11-09T21:30:33.964949Z&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;build_snapshot&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="kc">false&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;lucene_version&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;8.7.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;minimum_wire_compatibility_version&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;6.8.0&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;minimum_index_compatibility_version&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;6.0.0-beta1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;tagline&amp;#34;&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;You Know，for Search&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="log">Log&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">tail /opt/elasticsearch/logs/elasticsearch.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>2021-06-03T09:13:12,744&lt;span class="o">][&lt;/span>WARN &lt;span class="o">][&lt;/span>o.e.x.s.a.AuthenticationService&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>node1&lt;span class="o">]&lt;/span> Authentication failed using realms &lt;span class="o">[&lt;/span>reserved/reserved,file/default_file,native/default_native&lt;span class="o">]&lt;/span>. Realms &lt;span class="o">[&lt;/span>ldap/ldap1&lt;span class="o">]&lt;/span> were skipped because they are not permitted on the current license
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="配置-ldap">配置 LDAP&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">vim /etc/elasticsearch/elasticsearch.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">xpack:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> security:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> authc:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> realms:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> ldap:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> ldap1:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> order: &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> url: &lt;span class="s2">&amp;#34;ldaps://ldap.example.tw:636&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> bind_dn: &lt;span class="s2">&amp;#34;uid=admin,cn=users,cn=accounts,dc=example,dc=tw&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> user_search:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> base_dn: &lt;span class="s2">&amp;#34;cn=users,cn=accounts,dc=example,dc=tw&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> filter: &lt;span class="s2">&amp;#34;(memberUid={1})&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> group_search:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> base_dn: &lt;span class="s2">&amp;#34;dc=example,dc=tw&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> files:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> role_mapping: &lt;span class="s2">&amp;#34;/etc/elasticsearch/role_mapping.yml&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> unmapped_groups_as_roles: &lt;span class="nb">false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">/usr/share/elasticsearch/bin/elasticsearch-keystore add &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="se">&lt;/span>xpack.security.authc.realms.ldap.ldap1.secure_bind_password
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Troubleshoot the eks creating load balancer access denied</title><link>https://chiehting.com/posts/troubleshoot-the-eks-creating-load-balancer-access-denied/</link><pubDate>Wed, 02 Jun 2021 16:12:00 +0800</pubDate><guid>https://chiehting.com/posts/troubleshoot-the-eks-creating-load-balancer-access-denied/</guid><description>
&lt;p>排除 ingress-nginx 的 &lt;code>Error syncing load balancer: failed to ensure load balancer: error creating load balancer: &amp;quot;AccessDenied:&lt;/code> 異常.&lt;/p>
&lt;h3 id="issue">Issue&lt;/h3>
&lt;p>&lt;a href="https://github.com/terraform-aws-modules/terraform-aws-eks/issues/183">https://github.com/terraform-aws-modules/terraform-aws-eks/issues/183&lt;/a>&lt;/p>
&lt;h3 id="error-message">Error message&lt;/h3>
&lt;p>helm install ingress-nginx 時發生錯誤, 盤查後發現下面錯誤&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">Warning SyncLoadBalancerFailed 24m (x10 over 69m) service-controller (combined from similar events): Error syncing load balancer: failed to ensure load balancer: error creating load balancer: &amp;#34;AccessDenied:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">is not authorized to perform: ec2:DescribeAccountAttributes\n\tstatus code: 403
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">Warning SyncLoadBalancerFailed 25s service-controller Error syncing load balancer: failed to ensure load balancer: error creating load balancer: &amp;#34;AccessDenied: is not authorized to perform: ec2:D
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">escribeInternetGateways\n\tstatus code: 403, request id: ba2ab5e2-9690-498a-aad3-3e46fb693588&amp;#34;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="solution">Solution&lt;/h3>
&lt;p>從上面錯誤可以看到缺少 policy, 這邊建立 policy eks-cluster-ingress-loadbalancer-creation 後並配置給我們自建的 AWSEKSClusterRole&lt;/p>
&lt;p>arn:aws:iam::xxxxxxxxxx:policy/eks-cluster-ingress-loadbalancer-creation&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Version&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;2012-10-17&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Statement&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Effect&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Allow&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Action&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:DescribeAccountAttributes&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;ec2:DescribeInternetGateways&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;#34;Resource&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Iptables guide</title><link>https://chiehting.com/posts/iptables-guide/</link><pubDate>Tue, 04 May 2021 10:30:00 +0800</pubDate><guid>https://chiehting.com/posts/iptables-guide/</guid><description>
&lt;p>iptables 被許多服務廣泛的運用著, 例如 Docker, Kubernetes 都是基於 iptables 來管理網路封包的處理, 所以此篇來研究 iptables 工具, 看看這些服務底層究竟在做些什麼事.&lt;/p>
&lt;p>Linux 核心 &lt;a href="https://www.netfilter.org/">Netfilter&lt;/a> 模組提供了網路的框架, 用於管理 Linux 主機的封包, 包括了&lt;code>過濾封包&lt;/code>、&lt;code>NAT&lt;/code>、&lt;code>Port 轉發&lt;/code>. 而 Linux 系統上有許多軟體是基於 &lt;a href="https://www.netfilter.org/">Netfilter&lt;/a> 模組實作網路管理介面, 例如 firewalld、ntw、iptables、nftables.&lt;/p>
&lt;p>iptables and ip6tables 分別為 IPv4 and IPv6, 組成包括了 &lt;code>Chain&lt;/code>、&lt;code>Target&lt;/code>、&lt;code>Table&lt;/code>、&lt;code>Match&lt;/code>, 而規則方面有 &lt;code>PREROUTING&lt;/code>、&lt;code>INPUT&lt;/code>、&lt;code>FORWARD&lt;/code>、&lt;code>OUTPUT&lt;/code>、&lt;code>POSTROUTIONG&lt;/code>.&lt;/p>
&lt;h3 id="packet-flow">Packet flow&lt;/h3>
&lt;p>引用 wiki &lt;a href="https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg">netfilter packet flow&lt;/a> 的圖, 可以看到封包在主機中的流量.&lt;/p>
&lt;h3 id="tables-與-chain">Tables 與 chain&lt;/h3>
&lt;p>下面列出 &lt;code>tables&lt;/code> 內建 &lt;code>chain&lt;/code> 關係&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>&lt;/th>
&lt;th>PREROUTING&lt;/th>
&lt;th>INPUT&lt;/th>
&lt;th>FORWARD&lt;/th>
&lt;th>OUTPUT&lt;/th>
&lt;th>POSTROUTIONG&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>raw&lt;/td>
&lt;td>o&lt;/td>
&lt;td>x&lt;/td>
&lt;td>x&lt;/td>
&lt;td>o&lt;/td>
&lt;td>x&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>mangle&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>nat&lt;/td>
&lt;td>o&lt;/td>
&lt;td>x&lt;/td>
&lt;td>x&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>filter&lt;/td>
&lt;td>x&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;td>x&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="tables">Tables&lt;/h4>
&lt;p>優先層級為 &lt;code>raw&lt;/code> -&amp;gt; &lt;code>mangle&lt;/code> -&amp;gt; &lt;code>nat&lt;/code> -&amp;gt; &lt;code>filter&lt;/code>.&lt;/p>
&lt;ul>
&lt;li>raw: 於處理異常(優先層級最高).&lt;/li>
&lt;li>mangle: 提供改寫封包的功能.&lt;/li>
&lt;li>nat(network address translation): IP 轉發; port 轉發.&lt;/li>
&lt;li>filter: 封包過濾 (此為預設表).&lt;/li>
&lt;/ul>
&lt;h4 id="chain">Chain&lt;/h4>
&lt;ul>
&lt;li>PREROUTING: 數據包進入路由表之前.&lt;/li>
&lt;li>INPUT: 通過路由表後目的地為本機.&lt;/li>
&lt;li>FORWARD: 通過路由表後, 目的地不為本機.&lt;/li>
&lt;li>OUTPUT: 由本機產生, 向外轉發.&lt;/li>
&lt;li>POSTROUTIONG: 發送到網卡接口之前.&lt;/li>
&lt;/ul>
&lt;h4 id="state">State&lt;/h4>
&lt;ul>
&lt;li>NEW: 一個新的連線封包 (建立新連線後的第一個封包).&lt;/li>
&lt;li>ESTABLISHED: 成功建立的連線, 即建立追蹤連線後所有封包狀態 (跟在 NEW 封包後面的所有封包).&lt;/li>
&lt;li>RELATED: 新建連線,由 ESTABLISHED session 所建立的新獨立連線 (ex. ftp-data 連線).&lt;/li>
&lt;li>INVALID: 非法連線狀態的封包 (DROP 封包).&lt;/li>
&lt;li>UNKOWN: 不明連線狀態的封包.&lt;/li>
&lt;/ul>
&lt;h4 id="policy-and-target">Policy and target&lt;/h4>
&lt;ul>
&lt;li>ACCEPT: 允許封包移動至目的地或另一個 chain.&lt;/li>
&lt;li>DROP: 丟棄封包,不回應要求,不傳送失敗訊息.&lt;/li>
&lt;li>REJECT: 拒絕封包,回應要求,傳送失敗訊息.&lt;/li>
&lt;li>SNAT: 修改 Source Socket.&lt;/li>
&lt;li>DNAT: 修改 Destination Socket.&lt;/li>
&lt;li>MASQUERADE: 動態修改 Source Socket (無法指定 IP,取當時網卡的 IP),較方便但效率較差.&lt;/li>
&lt;li>REDIRECT: 將連線導至本機行程 (Local Process).&lt;/li>
&lt;li>RETURN: 結束自行定義的 Chain 然後返回原來的 Chain 繼續跑規則 (rules).&lt;/li>
&lt;li>QUEUE: 封包排隊等待處理.&lt;/li>
&lt;li>LOG: 記錄指定的規則封包 (/etc/syslog.conf , default /var/log/messges).&lt;/li>
&lt;/ul>
&lt;h3 id="iptables-輸出格式說明">iptables 輸出格式說明&lt;/h3>
&lt;p>下面指令可以列出表 &lt;code>filter&lt;/code> 的規則清單, 可以看到有三條 &lt;code>Chain&lt;/code>, 有九個欄位, 說明如下:&lt;/p>
&lt;ul>
&lt;li>pkts: 總共通過的封包的數量&lt;/li>
&lt;li>bytes: 總共通過的流量大小&lt;/li>
&lt;li>target: 執行的動作, 例如 &lt;code>ACCEPT&lt;/code>、&lt;code>REJECT&lt;/code>、&lt;code>RETURN&lt;/code>、&lt;code>DROP&lt;/code>、&lt;code>LOG&lt;/code>,也可以參照到其他 &lt;code>Chain&lt;/code>.&lt;/li>
&lt;li>port: 使用封包的協定, 例如 &lt;code>all&lt;/code>、&lt;code>tcp&lt;/code>、&lt;code>udp&lt;/code>、&lt;code>icmp&lt;/code>&lt;/li>
&lt;li>opt: 額外的選項說明&lt;/li>
&lt;li>in: 進入的網路介面&lt;/li>
&lt;li>out: 出去的網路介面&lt;/li>
&lt;li>source: 此規則是針對哪個來源進行限制,例如 &lt;code>0.0.0.0/0&lt;/code>&lt;/li>
&lt;li>destination: 此規則是針對哪個目標進行限制,例如 &lt;code>0.0.0.0/0&lt;/code>&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@server:~ iptables -L -n -v --line-numbers -t filter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">Chain INPUT &lt;span class="o">(&lt;/span>policy ACCEPT&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">Chain FORWARD &lt;span class="o">(&lt;/span>policy ACCEPT&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">Chain OUTPUT &lt;span class="o">(&lt;/span>policy ACCEPT&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl"> pkts bytes target prot opt in out &lt;span class="nb">source&lt;/span> destination
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="iptables-應用">iptables 應用&lt;/h3>
&lt;h4 id="參數說明">參數說明&lt;/h4>
&lt;ul>
&lt;li>-P chain target: 變更 chain 的預設政策.&lt;/li>
&lt;li>-A chain: 加入規則至 chain 的最後.&lt;/li>
&lt;li>-I chain [rulenum]: 插入規則至 chain.&lt;/li>
&lt;li>-D chain [rulenum]: 刪除 chain 上的規則.&lt;/li>
&lt;li>-R chain [rulenum]: 取代 chain 上的規則.&lt;/li>
&lt;li>-L [chain [rulenum]]: 列出 chain 上的規則.&lt;/li>
&lt;li>-F [chain]: 刪除 chain 上的所有規則.&lt;/li>
&lt;li>-Z [chain [rulenum]]: 將計數器歸零.&lt;/li>
&lt;li>-N chain: 建立使用者定義的 chain.&lt;/li>
&lt;li>-X [chain]: 刪除使用者定義的 chain.&lt;/li>
&lt;li>-E old-chain new-chain: 變更 chain 的名稱.&lt;/li>
&lt;/ul>
&lt;p>其中 rulenum 是從上至下順序執行，直至匹配的的規則為止，否則執行預設政策。&lt;/p>
&lt;h4 id="狀況題">狀況題&lt;/h4>
&lt;p>測試主機有網路介面有 &lt;code>lo&lt;/code> and &lt;code>eth0&lt;/code>.&lt;/p>
&lt;h5 id="查看-table-filter-的規則">查看 table filter 的規則&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">root@server:~ iptables -L -n -v --line-numbers -t filter
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="修改-chain-的預設政策">修改 chain 的預設政策&lt;/h5>
&lt;p>先將 22 port 打開, 以免被擋在家門外. INPUT 預設政策為 DROP.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># INPUT chain accept port 22&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">root@server:~ iptables -I INPUT -i eth0 -p tcp --dport &lt;span class="m">22&lt;/span> -m state --state NEW,ESTABLISHED -j ACCEPT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1"># OUTPUT chain accept port 22&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">root@server:~ iptables -I OUTPUT -o eth0 -p tcp --sport &lt;span class="m">22&lt;/span> -m state --state ESTABLISHED -j ACCEPT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="c1"># INPUT chain default drop&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">root@server:~ iptables -P INPUT DROP
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>還原&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># INPUT chain default accept&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">root@server:~ iptables -P INPUT ACCEPT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1"># Delete the INPUT chain first rule&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">root@server:~ iptables -D INPUT &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="c1"># Delete the OUTPUT chain first rule&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">root@server:~ iptables -D OUTPUT &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="封鎖-input-chain-指定的-port">封鎖 INPUT chain 指定的 port&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">＃ 拒絕由網卡 eth0 進來的 tcp port &lt;span class="m">80&lt;/span> 所有封包
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">iptables -A INPUT -p tcp -dport &lt;span class="m">80&lt;/span> -i eth0 -j REJECT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">＃ 拒絕由網卡 eth0 進來的 tcp port &lt;span class="m">7000&lt;/span> ~ &lt;span class="m">7005&lt;/span> 所有封包
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">iptables -A INPUT -p tcp -sport 7000:7005 -i eth0 -j REJECT
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="封鎖-input-chain-指定的-來源">封鎖 INPUT chain 指定的 來源&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">iptables -I INPUT -p tcp --dport &lt;span class="m">80&lt;/span> -s 1.34.113.121/32 -m state --state ESTABLISHED -j REJECT
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="刪除-input-chain-所有的規則">刪除 INPUT chain 所有的規則&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">iptables -F INPUT
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="rafances">Rafances&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="http://linux.vbird.org/linux_server/0250simple_firewall.php#netfilter_chain">iptables 的表格 (table) 與鏈 (chain)&lt;/a>&lt;/li>
&lt;li>&lt;/li>
&lt;/ul></description></item><item><title>rds binlog 留存機制</title><link>https://chiehting.com/posts/rds-binary-logs-backup/</link><pubDate>Fri, 16 Apr 2021 14:48:00 +0800</pubDate><guid>https://chiehting.com/posts/rds-binary-logs-backup/</guid><description>
&lt;p>AWS RDS 的 snapshot 備份為一天一次，由於間隔過長, 所以需要抓取 RDS binlog 做差異備份。&lt;/p>
&lt;p>參照這篇範例 &lt;a href="https://aws.amazon.com/cn/premiumsupport/knowledge-center/rds-mysql-schedule-binlog-uploads/">如何計劃 Amazon RDS MySQL 數據庫實例二進制日誌文件向 Amazon S3 的上傳?&lt;/a> 做調整.&lt;/p>
&lt;h3 id="install-mysql-57">Install mysql 5.7&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">apt update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">apt-cache policy mysql-server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">apt install -y mysql-server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="登入-mysql-延長-rds-binlog-retention-hours-保留時間為-2h">登入 mysql, 延長 rds binlog retention hours, 保留時間為 2h&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">show master status&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">show BINARY LOGS&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">show binlog events&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">call mysql.rds_show_configuration&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">call mysql.rds_set_configuration&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;binlog retention hours&amp;#39;&lt;/span>, 2&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="建立-ec2-主機-並作初始化">建立 EC2 主機, 並作初始化&lt;/h3>
&lt;h4 id="建立資料夾">建立資料夾&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">mkdir -p /opt/mysql-binlog-backup/binlog/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="建立-shell-secipt-注意編輯參數">建立 shell secipt, 注意編輯參數&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">touch /opt/mysql-binlog-backup/rds-binlog-to-s3.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">chmod +x /opt/mysql-binlog-backup/rds-binlog-to-s3.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">vim /opt/mysql-binlog-backup/rds-binlog-to-s3.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>貼上 rds-binlog-to-s3.sh 內容&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1">#Script to download RDS MySQL binlog files using mysqlbinlog command and the AWS CLI tools to upload them to S3.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="c1">#Install AWS CLI tools see: &amp;#34;http://docs.aws.amazon.com/cli/latest/userguide/installing.html&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="c1">#Config your AWS config File (aws configure)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="nv">AWS_PATH&lt;/span>&lt;span class="o">=&lt;/span>/opt/aws
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="nv">Binlog_dir&lt;/span>&lt;span class="o">=&lt;/span>/opt/mysql-binlog-backup/binlog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="nv">Backup_dir&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$Binlog_dir&lt;/span>/&lt;span class="k">$(&lt;/span>date &lt;span class="s2">&amp;#34;+%Y-%m-%d&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="nv">Bucket&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;rds-binlogs&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="nv">RDS&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;host.rds.amazonaws.com&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="nv">master&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;admin&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">MYSQL_PWD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;password&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="nv">mysql_binlog_filename&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>mysql -u &lt;span class="nv">$master&lt;/span> -h &lt;span class="nv">$RDS&lt;/span> -e &lt;span class="s2">&amp;#34;show master logs&amp;#34;&lt;/span>&lt;span class="p">|&lt;/span>grep &lt;span class="s2">&amp;#34;mysql-bin&amp;#34;&lt;/span>&lt;span class="p">|&lt;/span>awk &lt;span class="s1">&amp;#39;{print $1}&amp;#39;&lt;/span>&lt;span class="k">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="k">for&lt;/span> file in &lt;span class="nv">$mysql_binlog_filename&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="k">do&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> ! &lt;span class="nb">test&lt;/span> -d &lt;span class="nv">$Backup_dir&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> mkdir -p &lt;span class="nv">$Backup_dir&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="c1">#remote read binlog&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="sb">`&lt;/span>mysqlbinlog -u &lt;span class="nv">$master&lt;/span> -h &lt;span class="nv">$RDS&lt;/span> --read-from-remote-server &lt;span class="nv">$file&lt;/span> --result-file&lt;span class="o">=&lt;/span>&lt;span class="nv">$Backup_dir&lt;/span>/ --raw&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="k">done&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="c1"># Upload to S3 bucket&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">&lt;span class="c1">#aws s3 sync $Backup_dir s3://$Bucket/binlog&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="c1"># Clean binlog on disk 7 day ago&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">&lt;span class="sb">`&lt;/span>find &lt;span class="nv">$Binlog_dir&lt;/span> -mtime +7 -name &lt;span class="s2">&amp;#34;*&amp;#34;&lt;/span> -exec rm -rf &lt;span class="o">{}&lt;/span> &lt;span class="se">\;&lt;/span>&lt;span class="sb">`&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="設立排程-下面為每-15-分鐘執行一次的-cron">設立排程, 下面為每 15 分鐘執行一次的 cron&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;*/15 * * * * root bash /opt/mysql-binlog-backup/rds-binlog-to-s3.sh&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/crontab
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Concept of MySQL transaction</title><link>https://chiehting.com/posts/mysql-transaction-type/</link><pubDate>Wed, 17 Mar 2021 11:28:00 +0800</pubDate><guid>https://chiehting.com/posts/mysql-transaction-type/</guid><description>
&lt;p>在處理事務時, 一件事務通常是由多個的 sql 來操作完成. 為了不讓同時執行多件事情造成資料互相干擾, 所以就會採用事務 (transaction) 功能來維護資料的準確性. 但是要注意的是 MYISAM not supports transaction, 所以要使用 transaction 必須採用 InnoDB.&lt;/p>
&lt;p>下面命令可以查詢 MySQL 的引擎.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-mysql" data-lang="mysql">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="n">mysql&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">SHOW&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">ENGINES&lt;/span>&lt;span class="err">\&lt;/span>&lt;span class="n">G&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">***************************&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">***************************&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kp">Engine&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CSV&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Support&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">YES&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Comment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">CSV&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">storage&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kp">engine&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Transactions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Savepoints&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">***************************&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">***************************&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kp">Engine&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Support&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">DEFAULT&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Comment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">Supports&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">transactions&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">level&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">locking&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">and&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">foreign&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">keys&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Transactions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">YES&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">YES&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Savepoints&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">YES&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="o">***************************&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="mi">8&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">row&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">***************************&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="kp">Engine&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MyISAM&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Support&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">YES&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Comment&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">MyISAM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">storage&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kp">engine&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="n">Transactions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">XA&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="n">Savepoints&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">NO&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="mi">9&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">rows&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">in&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">set&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">00&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">sec&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="acid">ACID&lt;/h3>
&lt;p>這是 MySQL 中滿重要的觀念之一, 定義如下.&lt;/p>
&lt;ul>
&lt;li>Atomicity (原子性): 資料操作不能只有部分完成.一次的 transaction 只能有兩種結果: 成功或失敗&lt;/li>
&lt;li>Consistency (一致性): transaction 完成前後, 資料都必須永遠符合 schema 的規範,保持資料與資料庫的一致性&lt;/li>
&lt;li>Isolation (隔離性): 資料庫允許多個 transactions 同時對其資料進行操作,但也同時確保這些 transaction 的交叉執行,不會導致數據的不一致&lt;/li>
&lt;li>Durability (耐久性): transaction 完成後,對資料的操作就是永久的,即便系統故障也不會丟失&lt;/li>
&lt;/ul>
&lt;h3 id="事務的隔離性">事務的隔離性&lt;/h3>
&lt;p>ISO 和 ANIS SQL 標準制定了四種事務隔離級別的標準,分別為:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>type&lt;/th>
&lt;th>descript&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>read uncommitted&lt;br>讀未提交&lt;/td>
&lt;td>一個事務還沒提交時,它做的變更就能被別的事務看到&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>read committed&lt;br>讀提交&lt;/td>
&lt;td>一個事務提交之後,它做的變更才會被其他事務看到&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>repeatable read&lt;br>可重複讀&lt;/td>
&lt;td>一個事務執行過程中看到的資料,總是跟這個事務在啟動時看到的資料是一致的.當然在可重複讀隔離級別下,未提交的變更對其他事務也是不可見的&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>serializable&lt;br>序列化&lt;/td>
&lt;td>顧名思義是對於同一行記錄,「寫」會加「寫鎖」,「讀」會加「讀鎖」.當出現讀寫鎖衝突的時候,後存取的事務必須等前一個事務執行完成,才能繼續執行&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>SQL 標準中規定, 針對不同的隔離級別,並行事務發生不同嚴重程度的問題為:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>隔離級別&lt;/th>
&lt;th>髒讀&lt;/th>
&lt;th>不可重複讀&lt;/th>
&lt;th>幻讀&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>read uncommitted&lt;br>讀未提交&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>read committed&lt;br>讀提交&lt;/td>
&lt;td>x&lt;/td>
&lt;td>o&lt;/td>
&lt;td>o&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>repeatable read&lt;br>可重複讀&lt;/td>
&lt;td>x&lt;/td>
&lt;td>x&lt;/td>
&lt;td>o&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>serializable&lt;br>序列化&lt;/td>
&lt;td>x&lt;/td>
&lt;td>x&lt;/td>
&lt;td>x&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="範例">範例&lt;/h3>
&lt;p>初始資料&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-mysql" data-lang="mysql">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1">-- create table
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">CREATE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">TABLE&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">account&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kp">AUTO_INCREMENT&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">varchar&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">money&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">NOT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="no">NULL&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="k">PRIMARY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">KEY&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="n">id&lt;/span>&lt;span class="o">`&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kp">ENGINE&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">InnoDB&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kp">AUTO_INCREMENT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c1">-- insert data
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">insert&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">into&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">account&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">values&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;justin&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">500&lt;/span>&lt;span class="p">),(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;tom&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">800&lt;/span>&lt;span class="p">),(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;bill&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">1200&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="dirty-read-髒讀">Dirty Read 髒讀&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>step&lt;/th>
&lt;th>transaction A&lt;/th>
&lt;th>transaction B&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&lt;/td>
&lt;td>SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>BEGIN;&lt;/td>
&lt;td>BEGIN;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>&lt;/td>
&lt;td>select count(*) from account; -- 此時count=3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>insert into account values (4,'set',500);&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>5&lt;/td>
&lt;td>&lt;/td>
&lt;td>select count(*) from account; -- 此時count=4&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>6&lt;/td>
&lt;td>rollback;&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>7&lt;/td>
&lt;td>&lt;/td>
&lt;td>select count(*) from account; -- 此時count=3&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>8&lt;/td>
&lt;td>&lt;/td>
&lt;td>commit;&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="non-repeatable-read-不可重複讀">Non-Repeatable Read 不可重複讀&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>step&lt;/th>
&lt;th>transaction A&lt;/th>
&lt;th>transaction B&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>SET TRANSACTION ISOLATION LEVEL READ COMMITTED;&lt;/td>
&lt;td>SET TRANSACTION ISOLATION LEVEL READ COMMITTED;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>BEGIN;&lt;/td>
&lt;td>BEGIN;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>&lt;/td>
&lt;td>select money from account where id=1; -- 此時money=500&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>update account set money=100 where id=1;&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>5&lt;/td>
&lt;td>commit;&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>6&lt;/td>
&lt;td>&lt;/td>
&lt;td>select money from account where id=1; -- 此時money=100&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>7&lt;/td>
&lt;td>&lt;/td>
&lt;td>commit;&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="phantom-read-幻讀">Phantom Read 幻讀&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>step&lt;/th>
&lt;th>transaction A&lt;/th>
&lt;th>transaction B&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;&lt;/td>
&lt;td>SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>BEGIN;&lt;/td>
&lt;td>BEGIN;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>&lt;/td>
&lt;td>select money from account where id=4; -- 此時not find&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>insert into account values (4,'set',300);&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>5&lt;/td>
&lt;td>commit;&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>6&lt;/td>
&lt;td>&lt;/td>
&lt;td>update account set money=500 where id=4;&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>7&lt;/td>
&lt;td>&lt;/td>
&lt;td>select money from account where id=4; -- 此時money=500&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>8&lt;/td>
&lt;td>&lt;/td>
&lt;td>commit;&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://dev.mysql.com/doc/refman/8.0/en/storage-engines.html">storage engines&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>More types structs, slices, and maps.</title><link>https://chiehting.com/posts/golang-more-data-types/</link><pubDate>Fri, 12 Mar 2021 11:00:00 +0800</pubDate><guid>https://chiehting.com/posts/golang-more-data-types/</guid><description>
&lt;p>了解 Golang 有哪些進階型態. 官網上的 &lt;a href="https://tour.golang.org/moretypes/11">More types&lt;/a>&lt;/p>
&lt;h3 id="pointers">Pointers&lt;/h3>
&lt;p>Go has pointers. A pointer holds the memory address of a value.
The type &lt;code>*T&lt;/code> is a pointer to a &lt;code>T&lt;/code> value. Its zero value is &lt;code>nil&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">p&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// &amp;lt;nil&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="nx">p&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nx">i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">p&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 0xc0000be020
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">p&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">21&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 21
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="structs">Structs&lt;/h3>
&lt;p>用結構來定義同類型的屬性/欄位.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="kd">type&lt;/span> &lt;span class="nx">Vertex&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nx">X&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nx">Y&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="nx">v&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">Vertex&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">X&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;v.X=%d, v.Y=%d&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">X&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="array-and-slices">Array and Slices&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="err">#&lt;/span> &lt;span class="nx">array&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nx">primes&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">11&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">13&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">primes&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="err">#&lt;/span> &lt;span class="nx">slices&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">primes&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>這邊要注意切片會取得陣列的指標, 而不是重新賦予值. 所以&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="p">[]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">11&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">13&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nx">t&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;len:%d, cap:%d, content:%v, %p\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">cap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="c1">// len:2, cap:5, content:[3 5], 0xc00007a038
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nx">t&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">[:]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;len:%d, cap:%d, content:%v, %p\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">cap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="c1">// len:6, cap:6, content:[2 3 5 7 11 13], 0xc00007a030
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="nx">t&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;len:%d, cap:%d, content:%v, %p\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nb">cap&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">t&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">t&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="c1">// len:2, cap:5, content:[3 5], 0xc00007a038
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%v, %p\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="c1">// [2 3 5 7], 0xc00007a030, 超過 t 的 len and capality
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="nx">t&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%v, %p&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">],&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">[:&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="c1">// [2 3 0 7], 0xc00007a030, array s also change
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="nil">Nil&lt;/h3>
&lt;ul>
&lt;li>Nil 很特別並不是&lt;code>關鍵字&lt;/code>&lt;/li>
&lt;li>不同類型的 nil 都只到同一個記憶體位置&lt;/li>
&lt;li>不同類型的 nil 不能比較, 轉型後做比較為 false&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%p\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 0x0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="kd">var&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="kt">int&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%p\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1">// 0x0
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">s&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="c1">// true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="nx">a&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">nil&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="c1">// true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})(&lt;/span>&lt;span class="nx">s&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})(&lt;/span>&lt;span class="nx">a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="c1">// false
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kd">interface&lt;/span>&lt;span class="p">{})(&lt;/span>&lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="kc">nil&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">)&lt;/span> &lt;span class="c1">// false
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="maps">Maps&lt;/h3>
&lt;p>key-value 結構&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nx">m&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">make&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">string&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;Answer&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">42&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;The value:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;Answer&amp;#34;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;Answer&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">48&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;The value:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;Answer&amp;#34;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nb">delete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">m&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Answer&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;The value:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;Answer&amp;#34;&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nx">m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s">&amp;#34;Answer&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;The value:&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">v&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s">&amp;#34;Present?&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ok&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="function-closures">Function closures&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">fibonacci&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nx">p&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nx">pp&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nx">sum&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nx">sum&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">p&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nx">pp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="nx">p&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">pp&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nx">pp&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">sum&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nx">sum&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nx">p&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">sum&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="nx">f&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">fibonacci&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span> &lt;span class="p">&amp;lt;&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="o">++&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nf">f&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="references">References&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://tour.golang.org/moretypes/1">More type&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://hsinyu.gitbooks.io/golang_note/content/slice.html">slice&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Basic types in Golang</title><link>https://chiehting.com/posts/golang-data-types/</link><pubDate>Thu, 11 Mar 2021 11:17:00 +0800</pubDate><guid>https://chiehting.com/posts/golang-data-types/</guid><description>
&lt;p>了解 Golang 有哪些資料型態. 官網上的 &lt;a href="https://go.dev/tour/basics/11">Basic types&lt;/a> 列出了多種的型態.&lt;/p>
&lt;h3 id="variables">Variables&lt;/h3>
&lt;p>下面列出資料類型, 其中可分為 &lt;code>Booleans&lt;/code>、&lt;code>Numeric Types&lt;/code>、&lt;code>Complex Numbers&lt;/code>、&lt;code>Strings&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-text" data-lang="text">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">bool
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">string
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">int int8 int16 int32 int64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">uint uint8 uint16 uint32 uint64 uintptr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">byte // alias for uint8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">rune // alias for int32
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> // represents a Unicode code point
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">float32 float64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">complex64 complex128
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">string
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>變數宣告與印出&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-golang" data-lang="golang">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nx">i&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">100&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nx">ui&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nb">uint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nx">f&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mf">1.425&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="nx">b&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="kc">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nx">s&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="s">&amp;#34;Hello World&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="nx">c&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="mi">3&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="m">4i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;%T, %T,%T,%T,%T,%T&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">i&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">ui&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">s&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="booleans">Booleans&lt;/h4>
&lt;p>Booleans have two possible values &lt;code>true&lt;/code> and &lt;code>fales&lt;/code>.&lt;/p>
&lt;h4 id="numeric-types">Numeric Types&lt;/h4>
&lt;p>Signed Integers&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>type&lt;/th>
&lt;th>size&lt;/th>
&lt;th>十進制範圍&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>int&lt;/td>
&lt;td>依據系統&lt;/td>
&lt;td>依據系統&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>int8&lt;/td>
&lt;td>8 bits&lt;/td>
&lt;td>-128 ~ 127&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>int16&lt;/td>
&lt;td>16 bits&lt;/td>
&lt;td>-32768 ~ 32767&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>int32&lt;/td>
&lt;td>32 bits&lt;/td>
&lt;td>-2147483648 ~ 2147483647&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>int64&lt;/td>
&lt;td>64 bits&lt;/td>
&lt;td>-9223372036854775808 ~ 9223372036854775807&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>Unsigned Integers&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>type&lt;/th>
&lt;th>size&lt;/th>
&lt;th>十進制範圍&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>uint&lt;/td>
&lt;td>依據系統&lt;/td>
&lt;td>依據系統&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>uint8&lt;/td>
&lt;td>8 bits&lt;/td>
&lt;td>0 ~ 255&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>uint16&lt;/td>
&lt;td>16 bits&lt;/td>
&lt;td>0 ~ 65535&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>uint32&lt;/td>
&lt;td>32 bits&lt;/td>
&lt;td>0 ~ 4294967295&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>uint64&lt;/td>
&lt;td>64 bits&lt;/td>
&lt;td>0 ~ 18446744073709551615&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="float">Float&lt;/h4>
&lt;p>&lt;strong>float64&lt;/strong> is the default float type. When you initialize a variable with a decimal value and don’t specify the float type, the default type inferred will be &lt;strong>float64&lt;/strong>.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>type&lt;/th>
&lt;th>size&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>float32&lt;/td>
&lt;td>32 bits or 4 bytes&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>float64&lt;/td>
&lt;td>64 bits or 8 bytes&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="complex-numbers">Complex Numbers&lt;/h4>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>type&lt;/th>
&lt;th>property&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>complex64&lt;/td>
&lt;td>實數與虛數都是 float32&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>complex128&lt;/td>
&lt;td>實數與虛數都是 float64&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="references">References&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://tour.golang.org/basics/11">Basic types&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.callicoder.com/golang-basic-types-operators-type-conversion/">Golang Basic Types, Operators and Type Conversion&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>帳本技術的演化</title><link>https://chiehting.com/posts/ledger-technology-history/</link><pubDate>Wed, 03 Mar 2021 14:00:00 +0800</pubDate><guid>https://chiehting.com/posts/ledger-technology-history/</guid><description>
&lt;p>記帳技術的演化可分為四個階段.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>階段&lt;/th>
&lt;th>時期&lt;/th>
&lt;th>主要特點&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>階段一：簡單賬本&lt;/td>
&lt;td>約公元前 3500 年 ~ 15 世紀&lt;/td>
&lt;td>使用原始的單式記賬法（Single Entry Bookkeeping）&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>階段二：複式賬本&lt;/td>
&lt;td>15 世紀 ~ 20 世紀中期&lt;/td>
&lt;td>現代複式記賬法（Double Entry Bookkeeping）出現和應用&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>階段三：數字化賬本&lt;/td>
&lt;td>20 世紀中期 ~ 21 世紀初&lt;/td>
&lt;td>物理媒介賬本演化到數字化賬本&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>階段四：分佈式賬本&lt;/td>
&lt;td>2009 年至今&lt;/td>
&lt;td>區塊鏈為代表的分佈式賬本相關思想和技術出現&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>從技術角度, 一般認為, 區塊鏈具有如下特點：&lt;/p>
&lt;ul>
&lt;li>分佈式容錯性：分佈式賬本網絡極其魯棒,能夠容忍部分節點的異常狀態；&lt;/li>
&lt;li>不可篡改性：共識提交後的數據會一直存在,不可被銷燬或修改；&lt;/li>
&lt;li>隱私保護性：密碼學保證了數據隱私,即便數據洩露,也無法解析。&lt;/li>
&lt;/ul></description></item><item><title>區塊鏈上的智能合約(smart contract)</title><link>https://chiehting.com/posts/blockchain-smart-contract/</link><pubDate>Thu, 25 Feb 2021 16:12:00 +0800</pubDate><guid>https://chiehting.com/posts/blockchain-smart-contract/</guid><description>
&lt;p>智能合約是 &lt;a href="https://en.wikipedia.org/wiki/Nick_Szabo">Nick Szabo&lt;/a> 在 1990 年代提出用語及概念. 是透過網際網路與他人互動的一種概念與協議&lt;/p>
&lt;blockquote>
&lt;p>The phrase and concept of &amp;quot;smart contracts&amp;quot; was developed by Szabo with the goal of bringing what he calls the &amp;quot;highly evolved&amp;quot; practices of contract law and practice to the design of electronic commerce protocols between strangers on the Internet.&lt;/p>
&lt;/blockquote>
&lt;p>智能合約為將雙方買賣的協議寫成程式碼, 而程式會發佈在區塊鏈上, 所以有去中心化且事務是可跟踪與不可逆的特性. 而智能合約的構成要素如下.&lt;/p>
&lt;ul>
&lt;li>合約主體 (Subject of Contract)&lt;/li>
&lt;li>數位簽名(Digital Signature)&lt;/li>
&lt;li>合約條款(Contract Terms)&lt;/li>
&lt;li>去中心化平台(Decentralized Platform)&lt;/li>
&lt;/ul>
&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://www.thenewslens.com/article/120557">智能合約的實際運用&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.investopedia.com/terms/s/smart-contracts.asp">Smart Contracts&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>區塊鏈的共識機制(consensus)</title><link>https://chiehting.com/posts/blockchain-consensus/</link><pubDate>Thu, 25 Feb 2021 14:00:00 +0800</pubDate><guid>https://chiehting.com/posts/blockchain-consensus/</guid><description>
&lt;p>區塊鏈是採用去中心化的設計，且人人都可參加成為節點，當完節點完成紀錄工作時需要分配獎勵，此時就要透過共識機制來分配獎勵，下面列出幾種不同的機制。&lt;/p>
&lt;h3 id="proof-of-workpow工作量證明">Proof of Work(PoW，工作量證明)&lt;/h3>
&lt;p>區塊鏈透過評估每個節點的算力來決定記帳權的機率，當算力越高就越有機會獲得記帳權。在完成記帳後就會獲得記帳獎勵。&lt;/p>
&lt;p>優點:&lt;/p>
&lt;ul>
&lt;li>有付出有收穫，算力越高就能獲得越多的獎勵。&lt;/li>
&lt;li>驗證機制單純，容易實踐。&lt;/li>
&lt;/ul>
&lt;p>缺點:&lt;/p>
&lt;ul>
&lt;li>高算力代表高耗能，比較算力的結果導致能源被大量消耗。&lt;/li>
&lt;li>需經過全網驗證區塊鏈內容，過程耗時。&lt;/li>
&lt;/ul>
&lt;h3 id="proof-of-stakepos持有量證明">Proof-of-Stake(PoS，持有量證明)&lt;/h3>
&lt;p>這裡的權益指的事所擁有的&lt;strong>貨幣數量 x 持有時間&lt;/strong>，在這共識下只要持有貨幣就有機會獲得記帳權。而在同等的算力之下，益越大者獲得記帳權。完成記帳後一樣獲得獎勵。&lt;/p>
&lt;p>優點:&lt;/p>
&lt;ul>
&lt;li>不過度消耗能源，記帳權依據數量而非算力。&lt;/li>
&lt;/ul>
&lt;p>缺點:&lt;/p>
&lt;ul>
&lt;li>會有富者恆富的情形，容易造成屯幣現象，降低貨幣流通性。&lt;/li>
&lt;li>需經過全網驗證區塊鏈內容，過程耗時。&lt;/li>
&lt;/ul>
&lt;h3 id="delegated-proof-of-stake-dpos權益委託證明">Delegated Proof-of-Stake (DPoS，權益委託證明)&lt;/h3>
&lt;p>為PoS的進階版，持有貨幣的人都有投票權，選出固定數量的代表人做驗證與記帳。 代表人會輪流生成區塊做記帳，完成記帳後一樣會獲得獎勵，所以大家會爭取成為代表人的機會。只要委託的代表人效率不佳，則會透過投票機制做汰換。&lt;/p>
&lt;p>優點:&lt;/p>
&lt;ul>
&lt;li>參與驗證與計算的節點大幅減少，使其效率提升且不過度消耗能源。&lt;/li>
&lt;/ul>
&lt;p>缺點:&lt;/p>
&lt;ul>
&lt;li>依賴代幣運作，卻缺乏代幣相關的商業應用。&lt;/li>
&lt;/ul>
&lt;h2 id="references">References&lt;/h2>
&lt;p>1。 &lt;a href="https://poweichen%E3%80%82gitbook%E3%80%82io/blockchain-guide-zh/bitcoin/consensus">區塊鏈技術指南&lt;/a>
2。 &lt;a href="https://tino28082000%E3%80%82medium%E3%80%82com/eos%E7%B3%BB%E5%88%97-%E5%85%B1%E8%AD%98%E6%A9%9F%E5%88%B6-978eb6eee27b">什麼是共識機制&lt;/a>
3。 &lt;a href="https://medium%E3%80%82com/7sevencoin/%E5%85%B1%E8%AD%98%E6%A9%9F%E5%88%B6%E6%98%AF%E4%BB%80%E9%BA%BC%E5%91%A2-1d5565b80e52">共識機制是什麼呢&lt;/a>&lt;/p></description></item><item><title>eosio 節點操作工具 cleos</title><link>https://chiehting.com/posts/cleos/</link><pubDate>Wed, 24 Feb 2021 16:12:00 +0800</pubDate><guid>https://chiehting.com/posts/cleos/</guid><description>
&lt;p>cleos 是個公開工具, 使用 command line 請求 nodeos 做部署或測試智能合約.&lt;/p>
&lt;h3 id="install">install&lt;/h3>
&lt;p>&lt;a href="https://github.com/EOSIO/eos/blob/master/README.md">Github README&lt;/a>&lt;/p>
&lt;p>MacOS 安裝 cleos command line&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">brew tap eosio/eosio
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">brew install eosio
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="how-to-use">how to use&lt;/h3>
&lt;h4 id="帳號">帳號&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 查看帳號資訊&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">bash-3.2$ cleos -u https://node1.eosphere.io:443 get account accountcreat
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="錢包">錢包&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 停止使用錢包&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">bash-3.2$ cleos wallet stop
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="c1"># 建立錢包 (console 使用)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">bash-3.2$ cleos -u https://node1.eosphere.io:443 wallet create -n eos --to-console
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">Creating wallet: eos
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">Save password to use in the future to unlock this wallet.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">Without password imported keys will not be retrievable.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="s2">&amp;#34;PW5KS..........uoX&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="c1"># 匯入private key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">bash-3.2$ cleos wallet import -n eos
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">private key: imported private key &lt;span class="k">for&lt;/span>: EOS......7hcQ
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="智能合約">智能合約&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># Deploy A Smart Contract&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">bash-3.2$ cleos -u https://node1.eosphere.io:443 &lt;span class="nb">set&lt;/span> contract bbingamebac1 /projects/eos-go/contracts/heart bbingamebac1@active
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://developers.eos.io/manuals/eos/latest/cleos/index">Eos (V2.0) / Cleos&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>eosio</title><link>https://chiehting.com/posts/eosio/</link><pubDate>Tue, 23 Feb 2021 16:12:00 +0800</pubDate><guid>https://chiehting.com/posts/eosio/</guid><description>
&lt;p>EOS.IO 為區塊列操作平台,透過 EOS.IO 發行的加密貨幣就叫做 EOS。而 EOS 採用的 &lt;strong>共識機制&lt;/strong> 為 Delegated Proof-of-Stake (DPoS, 權益委託證明)。&lt;/p>
&lt;p>開發者透過 &lt;strong>智能合約(smart contract)&lt;/strong> 的協議，來訂定對區塊鏈的互動、決策、儲存資料及傳送虛擬幣等功能。&lt;/p>
&lt;p>共識機制([[blockchain-consensus]])
智能合約([[blockchain-smart-contract]])&lt;/p>
&lt;p>區塊鏈應用的要求：&lt;/p>
&lt;ul>
&lt;li>支持成百上千的用戶&lt;/li>
&lt;li>免費的使用&lt;/li>
&lt;li>簡單升級和bug修復&lt;/li>
&lt;li>低延遲&lt;/li>
&lt;li>初步性能&lt;/li>
&lt;li>並發性能&lt;/li>
&lt;/ul>
&lt;h3 id="blockchain-的鏈節點">Blockchain 的鏈節點&lt;/h3>
&lt;p>選用 [[cleos]] 工具，透過 command line 請求 nodeos 做部署或測試智能合約。&lt;/p>
&lt;h2 id="references">References&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://github.com/EOSIO/Documentation/blob/master/zh-CN/TechnicalWhitePaper.md">EOS.IO Technical White Paper v2&lt;/a>, 白皮書必看有簡體中文版本&lt;/li>
&lt;li>&lt;a href="https://kknews.cc/tech/ygp5vmj.html">區塊鏈的優缺點&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blockbar.io/blockchain-investment-analytics/eos%E6%98%AF%E4%BB%80%E9%BA%BC-what-is-eos/">EOS是什麼&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Visual Studio Code 使用 Terminal 時, 隨機性的停頓問題</title><link>https://chiehting.com/posts/vscode-integrated-terminal-lags-intermittently/</link><pubDate>Sat, 21 Nov 2020 14:28:50 +0800</pubDate><guid>https://chiehting.com/posts/vscode-integrated-terminal-lags-intermittently/</guid><description>
&lt;p>Visual Studio Code 使用 Terminal 時, 隨機性的停頓. 有相關 issue 回報狀況.&lt;/p>
&lt;p>下面有兩張在 GitHub 上的 issue 在討論此件事.&lt;/p>
&lt;p>&lt;a href="https://github.com/microsoft/vscode/issues/105446">vscode issues 105446&lt;/a>
&lt;a href="https://github.com/microsoft/vscode/issues/108544">vscode issues 108544&lt;/a>&lt;/p>
&lt;h4 id="workaround">workaround&lt;/h4>
&lt;p>這個命令使用 &lt;code>codesign&lt;/code> 工具來從 Visual Studio Code 應用程式的特定檔案中移除數位簽名. 數位簽名是一種機制, 用於驗證應用程式的來源和完整性, 確保它來自合法的發行者並未被更改或損壞.&lt;/p>
&lt;p>下面的命令是從 Visual Studio Code 應用程式內部的一個組件檔案「Code Helper (Renderer).app」中移除現有的數位簽名.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">codesign --remove-signature /Applications/Visual&lt;span class="se">\\&lt;/span> Studio&lt;span class="se">\\&lt;/span> Code.app/Contents/Frameworks/Code&lt;span class="se">\\&lt;/span> Helper&lt;span class="se">\\&lt;/span> &lt;span class="se">\\&lt;/span>&lt;span class="o">(&lt;/span>Renderer&lt;span class="se">\\&lt;/span>&lt;span class="o">)&lt;/span>.app
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Script management with launchd in Terminal on Mac</title><link>https://chiehting.com/posts/macos-script-management-with-launchd/</link><pubDate>Thu, 12 Nov 2020 17:45:00 +0800</pubDate><guid>https://chiehting.com/posts/macos-script-management-with-launchd/</guid><description>
&lt;p>在 macOS 上使用 launchd 來管理服務與進程. 使用者不會直接與 launchd 做互動, 是透過 launchctl 指令來載入或取消載入 launchd 服務程式和代理程式.&lt;/p>
&lt;h2 id="references">References&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://support.apple.com/guide/terminal/script-management-with-launchd-apdc6c1077b-5d5d-4d35-9c19-60f2397b2369/mac">在Mac 上的「終端機」中使用launchd 管理腳本&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/Introduction.html#//apple_ref/doc/uid/10000172i-SW1-SW1">about daemons and services
&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://support.apple.com/zh-tw/guide/terminal/apdc6c1077b-5d5d-4d35-9c19-60f2397b2369/mac">launchd&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://support.apple.com/zh-hk/guide/terminal/apda49a1bb2-577e-4721-8f25-ffc0836f6997/mac">plist&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="launchd">launchd&lt;/h2>
&lt;p>使用 launchdctl 指令來管理守護程式。&lt;/p>
&lt;p>例如:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 查看資源限制&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">$ launchctl limit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1"># 列出服務清單&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">$ launchctl list
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="c1"># 列出服務說明&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">$ launchctl print system/com.apple.timed
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="plists-property-list">plists (property list)&lt;/h3>
&lt;p>plist 檔案是用來定義服務的屬性檔案, 可分系統服務與第三方服務, 而 plist 檔案會放置在下面路徑.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>檔案夾&lt;/th>
&lt;th>使用情況&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>/System/Library/LaunchDaemons&lt;/td>
&lt;td>Apple 提供的系統服務程式&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/System/Library/LaunchAgents&lt;/td>
&lt;td>Apple 提供的代理程式，適用於以使用者為基礎的所有使用者&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/Library/LaunchDaemons&lt;/td>
&lt;td>第三方系統服務程式&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>/Library/LaunchAgents&lt;/td>
&lt;td>第三方代理程式，適用於以使用者為基礎的所有使用者&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>~/Library/LaunchAgents&lt;/td>
&lt;td>第三方代理程式，僅適用於已登入的使用者&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>如下指令,查看 dock 服務的 plist 檔案內容. 可以看到是 DTD (Document Type Definition) 格式.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 查看 plist&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">cat /System/Library/LaunchAgents/com.apple.Dock.plist
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &amp;lt;key&amp;gt;Program&amp;lt;/key&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &amp;lt;string&amp;gt;/System/Library/CoreServices/Dock.app/Contents/MacOS/Dock&amp;lt;/string&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>SLA、SLO、SLI的概念</title><link>https://chiehting.com/posts/service-level/</link><pubDate>Wed, 04 Nov 2020 17:22:00 +0800</pubDate><guid>https://chiehting.com/posts/service-level/</guid><description>
&lt;p>拜讀 Atlassian 的文章, 暸解如何訂定服務的穩定性, 以及如何量化他們. 這邊定義了三件事情 SLA、SLO、SLI, 從對用戶的承諾, 到設定系統目標, 至搜集服務指標, 達到使用戶感受到系統的穩定, 但如果承諾未達成, 系統商也應該付出所承諾之代價.&lt;/p>
&lt;h3 id="references">References&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://www.atlassian.com/incident-management/kpis/sla-vs-slo-vs-sli">SLA vs. SLO vs. SLI: What’s the difference?&lt;/a>&lt;/li>
&lt;/ol>
&lt;h3 id="summary">Summary&lt;/h3>
&lt;p>SRE ([[what-is-sre]]) 的核心價值之一是維持系統的穩定度, 但怎麽樣叫做穩定? 這邊拜讀 &lt;em>Atlassian&lt;/em> 的文章來了解穩定的目標. 這邊定義三件事 SLA ([[service-level-agreement]])、SLO ([[service-level-objective]])、SLI ([[service-level-indicator]]), 使其讓用戶跟服務提供商達成共識, 例如用戶會想知道:&lt;/p>
&lt;ul>
&lt;li>系統可以使用多久?&lt;/li>
&lt;li>系統出現故障, 維護團隊多久可以給出回饋?&lt;/li>
&lt;li>系統對響應速度做什麼樣的承諾?&lt;/li>
&lt;/ul>
&lt;p>SLA 是提供商對用戶承諾的協議. 例如承諾系統使用時間、響應時間. 通常會由公司的商務團隊或法務團隊來訂定對客戶的承諾. 如未達到承諾之協議, 則需要承擔後果. 而且非技術團隊所做出的承諾, 容易無法做出衡量. 所以如果是提供免費的服務, 就不太需要訂定承諾.&lt;/p>
&lt;p>SLO 是系統對 SLA 所承諾之衡量目標的設定. 這邊感覺起來如果 SLA 是對用戶做承諾, SLO 就是將承諾提交給相關的團隊, 來做數據化的監控. 例如: 承諾系統要在 99.95% 的時間可使用, 就要將此承諾交給 IT team 來設定系統運行時間的目標要在 99.95% 內.&lt;/p>
&lt;p>SLI 是系統對 SLO 所設定衡量目標之衡量指標. 是對 SLO 所衡量之目標所所測量的實際指標. 例如: 設定了 SLO 系統運行時間的目標在 99.95%, 而衡量指標就是這個目標目前實際的值, 可能是 99.9%.&lt;/p>
&lt;p>延伸閱讀, &lt;a href="https://ikala.cloud/understanding-sli-slo-sla-in-sre/">iKala - 一次搞懂 SLI、SLO、SLA 差異，Google DevOps 理念實踐&lt;/a>&lt;/p>
&lt;h3 id="note">Note&lt;/h3>
&lt;p>原文 :: &lt;a href="https://www.atlassian.com/incident-management/kpis/sla-vs-slo-vs-sli">SLA vs. SLO vs. SLI: What’s the difference?&lt;/a>&lt;/p>
&lt;p>&lt;strong>And in today’s always-on world, people’s expectations—for free and paid services alike—are high. Speed. Uptime. Useful UX. Today’s user base expects everything to meet a high standard.&lt;/strong>&lt;/p>
&lt;p>Which is why it’s important for companies to understand and maintain SLAs, SLOs, and SLIs—three initialisms that represent the promises we make to our users, the internal objectives that help us keep those promises, and the trackable measurements that tell us how we’re doing.&lt;/p>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">The goal of all three things is to get everybody—vendor and client alike—on the same page about system performance.&lt;/span>&lt;/strong> How often will your systems be available? How quickly will your team respond if the system goes down? What kind of promises are you making about speed and functionality? Users want to know—and so you need SLAs, SLOs, and SLIs.&lt;/p>
&lt;ul>
&lt;li>Service Level Agreement (SLA), the agreement you make with your clients or users.&lt;/li>
&lt;li>Service Level Objective (SLOs), the objectives your team must hit to meet that agreement.&lt;/li>
&lt;li>Services Level Indicator (SLIs), the real numbers on your performance.&lt;/li>
&lt;/ul>
&lt;h4 id="what-is-an-sla">What is an SLA?&lt;/h4>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">An SLA (service level agreement) is an agreement between provider and client about measurable metrics like uptime, responsiveness, and responsibilities.&lt;/span>&lt;/strong>&lt;/p>
&lt;p>These agreements are typically drawn up by a company’s new business and legal teams and they represent the promises you’re making to customers—and the consequences if you fail to live up to those promises. Typically, consequences include financial penalties, service credits, or license extensions.&lt;/p>
&lt;h5 id="the-challenge-of-slas">The challenge of SLAs&lt;/h5>
&lt;p>&lt;a href="https://www.atlassian.com/it-unplugged/best-practices-and-trends/stop-hating-on-slas">SLAs are notoriously difficult to measure, report on, and meet&lt;/a>. These agreements—generally written by people who aren’t in the tech trenches themselves—often make promises that are difficult for teams to measure, don’t always align with current and ever-evolving business priorities, and don’t account for nuance.&lt;/p>
&lt;h5 id="who-needs-an-sla">Who needs an SLA?&lt;/h5>
&lt;p>&lt;strong>&lt;span style="background-color: #ffffcc; color: red">An SLA is an agreement between a vendor and a paying customer.&lt;/span> Companies providing a service to users for free are unlikely to want or need an SLA for those free users.&lt;/strong>&lt;/p>
&lt;h4 id="what-is-an-slo">What is an SLO?&lt;/h4>
&lt;p>An SLO (service level objective) is an agreement within an SLA about a specific metric like uptime or response time. So, &lt;strong>&lt;span style="background-color: #ffffcc; color: red">if the SLA is the formal agreement between you and your customer, SLOs are the individual promises you’re making to that customer. SLOs are what set customer expectations and tell IT and DevOps teams &lt;a href="https://www.atlassian.com/blog/opsgenie/measuring-and-evaluating-service-level-objectives">what goals they need to hit and measure themselves against&lt;/a>.&lt;/span>&lt;/strong>&lt;/p>
&lt;h5 id="the-challenges-of-slos">The challenges of SLOs&lt;/h5>
&lt;p>SLOs get less hate than SLAs, but they can create just as many problems if they’re vague, overly complicated, or impossible to measure. The key to SLOs that don’t make your engineers want to tear their hair out is simplicity and clarity. &lt;strong>Only the most important metrics should qualify for SLO status, the objectives should be spelled out in plain language, and, as with SLAs, they should always account for issues such as client-side delays.&lt;/strong>&lt;/p>
&lt;h5 id="who-needs-slos">Who needs SLOs?&lt;/h5>
&lt;p>Where SLAs are only relevant in the case of paying customers, SLOs can be useful for both paid and unpaid accounts, as well as internal and external customers. &lt;/p>
&lt;p>Internal systems, such as CRMs, client data repositories, and intranet, can be just as important as external-facing systems. And having SLOs for those internal systems is an important piece of not only meeting business goals but enabling internal teams to meet their own customer-facing goals.&lt;/p>
&lt;h4 id="what-is-an-sli">What is an SLI?&lt;/h4>
&lt;p>An SLI (service level indicator) measures compliance with an SLO (service level objective). So, for example, &lt;strong>&lt;span style="background-color: #ffffcc; color: red">if your SLA specifies that your systems will be available 99.95% of the time, your SLO is likely 99.95% uptime and your SLI is the actual measurement of your uptime. Maybe it’s 99.96%. Maybe 99.99%.&lt;/span>&lt;/strong> To stay in compliance with your SLA, the SLI will need to meet or exceed the promises made in that document.&lt;/p>
&lt;h5 id="the-challenges-of-slis">The challenges of SLIs&lt;/h5>
&lt;p>As with SLOs, &lt;span style="background-color: #ffffcc; color: red">the challenge of SLIs is keeping them simple, choosing the right metrics to track, and not overcomplicating IT’s job by tracking too many metrics that don’t actually matter to clients.&lt;/span>&lt;/p>
&lt;h5 id="who-needs-slis">Who needs SLIs?&lt;/h5>
&lt;p>Any company measuring their performance against SLOs needs SLIs in order to make those measurements. You can’t really have SLOs without SLIs.&lt;/p></description></item><item><title>設定 macOS 的 open files 上限</title><link>https://chiehting.com/posts/macos-open-files-limit/</link><pubDate>Mon, 27 Apr 2020 12:21:00 +0800</pubDate><guid>https://chiehting.com/posts/macos-open-files-limit/</guid><description>
&lt;p>今天在做壓力測試,使用 command line 做 websocket client connection.
大約到250左右的連線數後回應錯誤 too many open files, 盤查後發現 macOS 預設的配置不敷使用, 需要加大 maxfiles 的限制.&lt;/p>
&lt;h3 id="環境">環境&lt;/h3>
&lt;p>macOS Catalina 10.15.4&lt;/p>
&lt;h3 id="查看">查看&lt;/h3>
&lt;p>可以看到被 LaunchDaemons([[macos-script-management-with-launchd]]) 給限制住了 maxfiles&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 12:30:01 &lt;span class="o">]&lt;/span> ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">➜ sysctl kern.maxfiles
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">kern.maxfiles: &lt;span class="m">200000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 12:30:08 &lt;span class="o">]&lt;/span> ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">➜ sysctl kern.maxfilesperproc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">kern.maxfilesperproc: &lt;span class="m">65536&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 12:30:24 &lt;span class="o">]&lt;/span> ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">➜ launchctl limit maxfiles
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">maxfiles &lt;span class="m">256&lt;/span> unlimited
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 12:31:06 &lt;span class="o">]&lt;/span> ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">➜ &lt;span class="nb">ulimit&lt;/span> -n
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="m">65536&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="解決方法">解決方法&lt;/h3>
&lt;h4 id="新增文件">新增文件&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 12:35:49 &lt;span class="o">]&lt;/span> ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">➜ sudo vim /Library/LaunchDaemons/limit.maxfiles.plist
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-xml" data-lang="xml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="cp">&amp;lt;?xml version=&amp;#34;1.0&amp;#34; encoding=&amp;#34;UTF-8&amp;#34;?&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="cp">&amp;lt;!DOCTYPE plist PUBLIC &amp;#34;-//Apple//DTD PLIST 1.0//EN&amp;#34; &amp;#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd&amp;#34;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="nt">&amp;lt;plist&lt;/span> &lt;span class="na">version=&lt;/span>&lt;span class="s">&amp;#34;1.0&amp;#34;&lt;/span>&lt;span class="nt">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;dict&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;key&amp;gt;&lt;/span>Label&lt;span class="nt">&amp;lt;/key&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;string&amp;gt;&lt;/span>limit.maxfiles&lt;span class="nt">&amp;lt;/string&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;key&amp;gt;&lt;/span>ProgramArguments&lt;span class="nt">&amp;lt;/key&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;array&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;string&amp;gt;&lt;/span>launchctl&lt;span class="nt">&amp;lt;/string&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;string&amp;gt;&lt;/span>limit&lt;span class="nt">&amp;lt;/string&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;string&amp;gt;&lt;/span>maxfiles&lt;span class="nt">&amp;lt;/string&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;string&amp;gt;&lt;/span>64000&lt;span class="nt">&amp;lt;/string&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;string&amp;gt;&lt;/span>200000&lt;span class="nt">&amp;lt;/string&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;/array&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;key&amp;gt;&lt;/span>RunAtLoad&lt;span class="nt">&amp;lt;/key&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;true/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;key&amp;gt;&lt;/span>ServiceIPC&lt;span class="nt">&amp;lt;/key&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;false/&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="nt">&amp;lt;/dict&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="nt">&amp;lt;/plist&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="修改權限">修改權限&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 12:36:34 &lt;span class="o">]&lt;/span> ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">➜ sudo chown root:wheel /Library/LaunchDaemons/limit.maxfiles.plist
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span> 12:36:44 &lt;span class="o">]&lt;/span> ./
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">➜ sudo chmod &lt;span class="m">644&lt;/span> /Library/LaunchDaemons/limit.maxfiles.plist
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="重啟系統">重啟系統&lt;/h4>
&lt;p>重啟完成後再次執行程序,問題排除&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">sudo reboot
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>了解 linux ulimit</title><link>https://chiehting.com/posts/linux-ulimit/</link><pubDate>Tue, 14 Jan 2020 17:23:00 +0800</pubDate><guid>https://chiehting.com/posts/linux-ulimit/</guid><description>
&lt;p>有時候為了榨出主機上的效能，需要去調整 Linux 的配置，ulimit 就是其中一項可控配置。&lt;/p>
&lt;p>參考 &lt;a href="https://man.linuxde.net/ulimit">ulimit&lt;/a>&lt;/p>
&lt;blockquote>
&lt;p>ulimit用於限制shell啟動進程所佔用的資源，支持以下各種類型的限制：所創建的內核文件的大小，進程數據塊的大小，Shell進程創建文件的大小，內存鎖住的大小，常駐內存 集的大小，打開文件大小的數量，分配大小的最大大小，CPU時間，單獨用戶的最大線程數，Shell進程所能使用的最大虛擬內存。同時，它支持硬資源和軟資源的限制。&lt;/p>
&lt;/blockquote>
&lt;h3 id="注意">注意&lt;/h3>
&lt;p>這邊使用配置 &lt;code>/etc/security/limits.conf&lt;/code> 檔案，透過PAM來加載用戶的資源限制。但在 Centos 7 使用 Systemd 替代了之前的 SysV，所以配置會對 Systemd 的 service 不生效.&lt;/p>
&lt;h3 id="確認環境">確認環境&lt;/h3>
&lt;p>查看主機資訊。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ uname -a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">Linux dev-db2.solartninc.com 3.10.0-1062.9.1.el7.x86_64 &lt;span class="c1">#1 SMP Fri Dec 6 15:49:49 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ cat /etc/redhat-release
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">CentOS Linux release 7.7.1908 &lt;span class="o">(&lt;/span>Core&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ lscpu
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">Architecture: x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">CPU op-mode&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>: 32-bit, 64-bit
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">Byte Order: Little Endian
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">CPU&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>: &lt;span class="m">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">On-line CPU&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span> list: 0-3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">Thread&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span> per core: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">Core&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span> per socket: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">Socket&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>: &lt;span class="m">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">NUMA node&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">Vendor ID: GenuineIntel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">CPU family: &lt;span class="m">6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">Model: &lt;span class="m">158&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">Model name: Intel&lt;span class="o">(&lt;/span>R&lt;span class="o">)&lt;/span> Core&lt;span class="o">(&lt;/span>TM&lt;span class="o">)&lt;/span> i7-8700 CPU @ 3.20GHz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">Stepping: &lt;span class="m">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">CPU MHz: 3192.000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">BogoMIPS: 6384.00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">Hypervisor vendor: VMware
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">Virtualization type: full
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">L1d cache: 32K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">L1i cache: 32K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">L2 cache: 256K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">L3 cache: 12288K
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">NUMA node0 CPU&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>: 0-3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">Flags: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon nopl xtopology tsc_reliable nonstop_tsc eagerfpu pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single ssbd ibrs ibpb stibp fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 invpcid rtm mpx rdseed adx smap clflushopt xsaveopt xsavec arat spec_ctrl intel_stibp flush_l1d arch_capabilities
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ free -h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl"> total used free shared buff/cache available
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl">Mem: 3.7G 274M 3.1G 8.8M 320M 3.2G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl">Swap: 2.0G 0B 2.0G
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ulimit 預設配置，Linux 系統的檔案描述符預設是 1024，負載變大時有可能會造成錯誤 &lt;code>open too many files&lt;/code>。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ &lt;span class="nb">ulimit&lt;/span> -a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">core file size &lt;span class="o">(&lt;/span>blocks, -c&lt;span class="o">)&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">data seg size &lt;span class="o">(&lt;/span>kbytes, -d&lt;span class="o">)&lt;/span> unlimited
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">scheduling priority &lt;span class="o">(&lt;/span>-e&lt;span class="o">)&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">file size &lt;span class="o">(&lt;/span>blocks, -f&lt;span class="o">)&lt;/span> unlimited
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">pending signals &lt;span class="o">(&lt;/span>-i&lt;span class="o">)&lt;/span> &lt;span class="m">15064&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">max locked memory &lt;span class="o">(&lt;/span>kbytes, -l&lt;span class="o">)&lt;/span> &lt;span class="m">64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">max memory size &lt;span class="o">(&lt;/span>kbytes, -m&lt;span class="o">)&lt;/span> unlimited
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">open files &lt;span class="o">(&lt;/span>-n&lt;span class="o">)&lt;/span> &lt;span class="m">1024&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">pipe size &lt;span class="o">(&lt;/span>&lt;span class="m">512&lt;/span> bytes, -p&lt;span class="o">)&lt;/span> &lt;span class="m">8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">POSIX message queues &lt;span class="o">(&lt;/span>bytes, -q&lt;span class="o">)&lt;/span> &lt;span class="m">819200&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">real-time priority &lt;span class="o">(&lt;/span>-r&lt;span class="o">)&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">stack size &lt;span class="o">(&lt;/span>kbytes, -s&lt;span class="o">)&lt;/span> &lt;span class="m">8192&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">cpu &lt;span class="nb">time&lt;/span> &lt;span class="o">(&lt;/span>seconds, -t&lt;span class="o">)&lt;/span> unlimited
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">max user processes &lt;span class="o">(&lt;/span>-u&lt;span class="o">)&lt;/span> &lt;span class="m">4096&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">virtual memory &lt;span class="o">(&lt;/span>kbytes, -v&lt;span class="o">)&lt;/span> unlimited
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">file locks &lt;span class="o">(&lt;/span>-x&lt;span class="o">)&lt;/span> unlimited
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="調整配置">調整配置&lt;/h3>
&lt;ul>
&lt;li>&lt;code>ulimit&lt;/code> 有分軟限制和硬限制，而 &lt;code>noproc&lt;/code> 是代表最大程序數；&lt;code>nofile&lt;/code>是代表最大檔案開啟數。&lt;/li>
&lt;li>&lt;code>ulimit -n&lt;/code> 的最大值限制是 1048576 (2^20)。&lt;/li>
&lt;li>網路上很多都配置為 65535，這邊我還沒搞懂為什麼是這個數字。&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ sudo vim /etc/security/limits.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">* hard noproc &lt;span class="m">65535&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">* soft noproc &lt;span class="m">65535&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">* hard nofile &lt;span class="m">65535&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">* soft nofile &lt;span class="m">65535&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>上面配置好後，需要確認有引入 pam 的 pam_limits.so 模塊，在下面可以發現預設在 &lt;code>/etc/pam.d/system-auth&lt;/code> 檔案中有找到被 required。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ cat /etc/pam.d/login
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">session optional pam_keyinit.so force revoke
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">session include system-auth
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">session include postlogin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ cat /etc/pam.d/system-auth
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">session optional pam_keyinit.so revoke
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">session required pam_limits.so
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">-session optional pam_systemd.so
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Creating Redis Cluster</title><link>https://chiehting.com/posts/redis-cluster-install-again/</link><pubDate>Tue, 14 Jan 2020 10:56:00 +0800</pubDate><guid>https://chiehting.com/posts/redis-cluster-install-again/</guid><description>
&lt;p>後端服務需要使用 Redis Cluster, 此篇紀錄在 Centos 7 安裝 Redis Cluster 的過程.&lt;/p>
&lt;p>Cluster教學 &lt;code>https://redis.io/topics/cluster-tutorial&lt;/code>&lt;/p>
&lt;h3 id="注意-binary-file放置位置會造成selinux異常">注意: binary file放置位置,會造成SELinux異常&lt;/h3>
&lt;p>在 Build Redis 時,其中有一個參數 PREFIX 是編譯完成後 binary 的位置,如下. 使用 Centos7 時,有變更這個參數,導致 redis-server 無法在 &lt;code>/var/log/redis&lt;/code> 底下建立檔案,碰到 &lt;code>avc denied open&lt;/code>,若不異動則正常, 原因是SELinux引起的.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-cache redis-5.0.7&lt;span class="o">]&lt;/span>$ cat src/Makefile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">PREFIX?&lt;span class="o">=&lt;/span>/usr/local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="nv">INSTALL_BIN&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">$(&lt;/span>PREFIX&lt;span class="k">)&lt;/span>/bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="nv">INSTALL&lt;/span>&lt;span class="o">=&lt;/span>install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="注意-建置-redis-cluster-群集時-密碼配置時要注意">注意: 建置 Redis Cluster 群集時, 密碼配置時要注意&lt;/h3>
&lt;p>建立 Redis Cluster 時有配置密碼, 第一次建立沒問題, 但是若做restart時, 報錯誤說&lt;code>NOAUTH Authentication required.&lt;/code>,原因是因為設定檔內只有配置 requirepass 參數未配置 masterauth 參數導致的,補上排除.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-cache redis&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat /etc/redis/redis_7000.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">requirepass &lt;span class="o">{{&lt;/span> redis_config_requirepass &lt;span class="o">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="c1"># If the master is password protected (using the &amp;#34;requirepass&amp;#34; configuration&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="c1"># directive below) it is possible to tell the replica to authenticate before&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="c1"># starting the replication synchronization process, otherwise the master will&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="c1"># refuse the replica request.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">masterauth &lt;span class="o">{{&lt;/span> redis_config_requirepass &lt;span class="o">}}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>error log&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-cache redis&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat /var/log/redis/redis_7004.log&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">10920:S &lt;span class="m">20&lt;/span> Jan &lt;span class="m">2020&lt;/span> 02:29:51.238 &lt;span class="c1"># MASTER aborted replication with an error: NOAUTH Authentication required.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">10920:S &lt;span class="m">20&lt;/span> Jan &lt;span class="m">2020&lt;/span> 02:29:52.240 * Connecting to MASTER 192.168.20.188:7002
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">10920:S &lt;span class="m">20&lt;/span> Jan &lt;span class="m">2020&lt;/span> 02:29:52.240 * MASTER &amp;lt;-&amp;gt; REPLICA sync started
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">10920:S &lt;span class="m">20&lt;/span> Jan &lt;span class="m">2020&lt;/span> 02:29:52.240 * Non blocking connect &lt;span class="k">for&lt;/span> SYNC fired the event.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">10920:S &lt;span class="m">20&lt;/span> Jan &lt;span class="m">2020&lt;/span> 02:29:52.240 * Master replied to PING, replication can &lt;span class="k">continue&lt;/span>...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">10920:S &lt;span class="m">20&lt;/span> Jan &lt;span class="m">2020&lt;/span> 02:29:52.240 * &lt;span class="o">(&lt;/span>Non critical&lt;span class="o">)&lt;/span> Master does not understand REPLCONF listening-port: -NOAUTH Authentication required.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">10920:S &lt;span class="m">20&lt;/span> Jan &lt;span class="m">2020&lt;/span> 02:29:52.240 * &lt;span class="o">(&lt;/span>Non critical&lt;span class="o">)&lt;/span> Master does not understand REPLCONF capa: -NOAUTH Authentication required.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">10920:S &lt;span class="m">20&lt;/span> Jan &lt;span class="m">2020&lt;/span> 02:29:52.240 * Partial resynchronization not possible &lt;span class="o">(&lt;/span>no cached master&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">10920:S &lt;span class="m">20&lt;/span> Jan &lt;span class="m">2020&lt;/span> 02:29:52.240 &lt;span class="c1"># Unexpected reply to PSYNC from master: -NOAUTH Authentication required.&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="確認主機配置">確認主機配置&lt;/h3>
&lt;h4 id="firewall">firewall&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ sudo firewall-cmd --list-all
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">public &lt;span class="o">(&lt;/span>active&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> target: default
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> icmp-block-inversion: no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> interfaces: ens192
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> sources:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> services: ssh dhcpv6-client
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> protocols:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> masquerade: no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> forward-ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> source-ports:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> icmp-blocks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> rich rules:
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="ip-address">ip address&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ ip a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">1: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">65536&lt;/span> qdisc noqueue state UNKNOWN group default qlen &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> inet 127.0.0.1/8 scope host lo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> inet6 ::1/128 scope host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">2: ens192: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m">1500&lt;/span> qdisc mq state UP group default qlen &lt;span class="m">1000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> link/ether 00:0c:29:90:78:61 brd ff:ff:ff:ff:ff:ff
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> inet 192.168.20.189/24 brd 192.168.20.255 scope global noprefixroute ens192
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> inet6 fe80::13b6:9f1a:cc9f:b263/64 scope link noprefixroute
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> valid_lft forever preferred_lft forever
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="before-starting">before starting&lt;/h3>
&lt;h4 id="redis-cluster-tcp-ports">Redis Cluster TCP ports&lt;/h4>
&lt;blockquote>
&lt;p>Every Redis Cluster node requires two TCP connections open. The normal Redis TCP port used to serve clients, for example 6379, plus the port obtained by adding 10000 to the data port, so 16379 in the example.&lt;/p>
&lt;/blockquote>
&lt;h4 id="redis-cluster-data-sharding">Redis Cluster data sharding&lt;/h4>
&lt;blockquote>
&lt;p>Redis Cluster does not use consistent hashing, but a different form of sharding where every key is conceptually part of what we call an hash slot.&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>There are 16384 hash slots in Redis Cluster, and to compute what is the hash slot of a given key, we simply take the CRC16 of the key modulo 16384.&lt;/p>
&lt;/blockquote>
&lt;h3 id="install-redis-507">install Redis 5.0.7&lt;/h3>
&lt;p>安裝 remi-release-7.rpm&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ yum.repos.d&lt;span class="o">]&lt;/span>$ sudo yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>安裝Redis 5.0.7-1.el7.remi&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ sudo yum list redis --enablerepo&lt;span class="o">=&lt;/span>remi --showduplicates
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ sudo yum install redis-5.0.7-1.el7.remi --enablerepo&lt;span class="o">=&lt;/span>remi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Redis service disable&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ sudo systemctl disable redis
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="setting-redis-configuration">setting Redis configuration&lt;/h3>
&lt;p>配置其中一個 redis.conf, 其中7000單一個 Redis 的 port 號. 其他的 redis.conf 就依序更改 7000 的數字.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># Redis 5.0.7 configuration file example.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="nb">bind&lt;/span> 0.0.0.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">protected-mode no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">port &lt;span class="m">7000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">daemonize yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">pidfile /var/run/redis_7000.pid
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">logfile /var/log/redis/redis_7000.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">dir /var/lib/redis
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">appendonly yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">cluster-enabled yes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">cluster-config-file nodes-6379.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">cluster-node-timeout &lt;span class="m">15000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">cluster-require-full-coverage no
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>確認 port 後, 必須開啟防火牆, 例如 port 7000, 就必須要開起 7000/tcp 跟 17000/tcp.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-cache ~&lt;span class="o">]&lt;/span>$ sudo firewall-cmd --add-port&lt;span class="o">=&lt;/span>7000/tcp --permanent
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-cache ~&lt;span class="o">]&lt;/span>$ sudo firewall-cmd --add-port&lt;span class="o">=&lt;/span>17000/tcp --permanent
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-cache ~&lt;span class="o">]&lt;/span>$ sudo firewall-cmd --reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-cache ~&lt;span class="o">]&lt;/span>$ sudo firewall-cmd --list-all
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="creating-the-cluster">Creating the cluster&lt;/h3>
&lt;p>最少需要 3 個 master, 參數&lt;code>--cluster-replicas&lt;/code>為一個 master 需要幾個 slave, 如下依此類推.&lt;/p>
&lt;p>每群Redis Cluster&lt;/p>
&lt;ul>
&lt;li>--cluster-replicas 0, 1 master 0 slave&lt;/li>
&lt;li>--cluster-replicas 1, 1 master 1 slave&lt;/li>
&lt;li>--cluster-replicas 2, 1 master 2 slave&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ redis-cli --cluster &lt;span class="nb">help&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ redis-cli --cluster create 192.168.20.189:7000 192.168.20.189:7001 192.168.20.189:7002 192.168.20.189:7003 192.168.20.189:7004 192.168.20.189:7005 --cluster-replicas &lt;span class="m">1&lt;/span> -a password
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; Performing &lt;span class="nb">hash&lt;/span> slots allocation on &lt;span class="m">6&lt;/span> nodes...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">Master&lt;span class="o">[&lt;/span>0&lt;span class="o">]&lt;/span> -&amp;gt; Slots &lt;span class="m">0&lt;/span> - &lt;span class="m">5460&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">Master&lt;span class="o">[&lt;/span>1&lt;span class="o">]&lt;/span> -&amp;gt; Slots &lt;span class="m">5461&lt;/span> - &lt;span class="m">10922&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">Master&lt;span class="o">[&lt;/span>2&lt;span class="o">]&lt;/span> -&amp;gt; Slots &lt;span class="m">10923&lt;/span> - &lt;span class="m">16383&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">Adding replica 127.0.0.1:7004 to 127.0.0.1:7000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">Adding replica 127.0.0.1:7005 to 127.0.0.1:7001
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">Adding replica 127.0.0.1:7003 to 127.0.0.1:7002
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; Trying to optimize slaves allocation &lt;span class="k">for&lt;/span> anti-affinity
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>WARNING&lt;span class="o">]&lt;/span> Some slaves are in the same host as their master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">M: 99ff53a04d977692016e7df517533226ff3bd218 127.0.0.1:7000
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> slots:&lt;span class="o">[&lt;/span>0-5460&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="m">5461&lt;/span> slots&lt;span class="o">)&lt;/span> master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">M: 4f9af42e6c6e2239e46cf9cd14af3e8c688638d5 127.0.0.1:7001
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> slots:&lt;span class="o">[&lt;/span>5461-10922&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="m">5462&lt;/span> slots&lt;span class="o">)&lt;/span> master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">M: 01279d2e588ac7b25da2df232412153b26950184 127.0.0.1:7002
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> slots:&lt;span class="o">[&lt;/span>10923-16383&lt;span class="o">]&lt;/span> &lt;span class="o">(&lt;/span>&lt;span class="m">5461&lt;/span> slots&lt;span class="o">)&lt;/span> master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">S: c12c3b7aed21133f078a3262ec201ec9106a6ae0 127.0.0.1:7003
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> replicates 99ff53a04d977692016e7df517533226ff3bd218
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">S: ea108846aba5cd010feebe8482f29babcbc51ee0 127.0.0.1:7004
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> replicates 4f9af42e6c6e2239e46cf9cd14af3e8c688638d5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">S: 7ea79aec309af8048453c6059d3cd35da57468df 127.0.0.1:7005
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> replicates 01279d2e588ac7b25da2df232412153b26950184
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="驗證">驗證&lt;/h3>
&lt;p>連至其中一台Redis後可以開始做查詢,例如下面的命令.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 ~&lt;span class="o">]&lt;/span>$ redis-cli -c -p &lt;span class="m">7000&lt;/span> -h 192.168.20.189 -a password
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">192.168.20.189:7000&amp;gt; cluster info
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">192.168.20.189:7000&amp;gt; cluster nodes
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看log,發現有些warning,依照建議去調整主機配置.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>Justin.Lee@dev-db2 redis&lt;span class="o">]&lt;/span>$ cat redis_7000.log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">2030:C &lt;span class="m">16&lt;/span> Jan &lt;span class="m">2020&lt;/span> 01:27:43.297 &lt;span class="c1"># Redis version=5.0.7, bits=64, commit=00000000, modified=0, pid=2030, just started&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">2031:M &lt;span class="m">16&lt;/span> Jan &lt;span class="m">2020&lt;/span> 01:27:43.301 &lt;span class="c1"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">2031:M &lt;span class="m">16&lt;/span> Jan &lt;span class="m">2020&lt;/span> 01:27:43.301 &lt;span class="c1"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &amp;#39;vm.overcommit_memory = 1&amp;#39; to /etc/sysctl.conf and then reboot or run the command &amp;#39;sysctl vm.overcommit_memory=1&amp;#39; for this to take effect.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">2031:M &lt;span class="m">16&lt;/span> Jan &lt;span class="m">2020&lt;/span> 01:27:43.301 &lt;span class="c1"># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command &amp;#39;echo never &amp;gt; /sys/kernel/mm/transparent_hugepage/enabled&amp;#39; as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Active Directory authentication on centos 7</title><link>https://chiehting.com/posts/ssh-enable-authentication-with-ad/</link><pubDate>Thu, 17 Oct 2019 18:05:00 +0800</pubDate><guid>https://chiehting.com/posts/ssh-enable-authentication-with-ad/</guid><description>
&lt;p>這篇在記錄如何再 Centos 7 上執行 AD 認證.
在建設 develop 的環境時, 有需求是允許 RD 可以進入 server, 這邊期望可以透過 Active Directory (AD) 統一管理員工帳戶, 不用另外開帳號或放 ssh public key.&lt;/p>
&lt;p>目前註冊帳戶的方式有兩種, 一種是執行 Ansible 腳本, 建立使用者帳戶與配置權限以及放入ssh key, 適合特殊權限的人; 另一種是透過AD, 一般開發者權限.&lt;/p>
&lt;h3 id="環境">環境&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@localhost ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># uname -a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">Linux localhost.localdomain 3.10.0-1062.1.2.el7.x86_64 &lt;span class="c1">#1 SMP Mon Sep 30 14:19:46 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@localhost ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># cat /etc/redhat-release&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">CentOS Linux release 7.7.1908 &lt;span class="o">(&lt;/span>Core&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="設定">設定&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1">## install package&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">yum install -y krb5-workstation realmd sssd samba-common-tools adcli oddjob oddjob-mkhomedir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="c1"># 加入域名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@localhost ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># realm join --user=itadmin --client-software=sssd solartninc.com&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">Password &lt;span class="k">for&lt;/span> itadmin:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="c1"># 查看域名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@localhost ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># realm list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">solartninc.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> type: kerberos
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> realm-name: SOLARTNINC.COM
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> domain-name: solartninc.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> configured: kerberos-member
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> server-software: active-directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> client-software: sssd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> required-package: oddjob
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> required-package: oddjob-mkhomedir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> required-package: sssd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> required-package: adcli
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> required-package: samba-common-tools
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> login-formats: %U@solartninc.com
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> login-policy: allow-realm-logins
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">&lt;span class="c1"># 測試登入&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@localhost ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># id justin@solartninc.com&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">&lt;span class="c1"># 修改設定. 拿掉完全匹配方便登入,登入時只需要打帳號不用帶上域名&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@localhost ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># vi /etc/sssd/sssd.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl">&lt;span class="nv">use_fully_qualified_names&lt;/span> &lt;span class="o">=&lt;/span> False
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">&lt;span class="nv">fallback_homedir&lt;/span> &lt;span class="o">=&lt;/span> /home/%u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl">&lt;span class="c1"># 從起sssd服務&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@localhost ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># systemctl restart sssd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>root@localhost ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># systemctl daemon-reload&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Integrate Redmine with GitLab</title><link>https://chiehting.com/posts/redmine-integrate-with-gitlab/</link><pubDate>Tue, 01 Oct 2019 11:00:00 +0800</pubDate><guid>https://chiehting.com/posts/redmine-integrate-with-gitlab/</guid><description>
&lt;p>部門選用了 &lt;em>Redmine&lt;/em> 當作我們的專案管理系統.想要規範 &lt;code>git commit&lt;/code> 的訊息,並將這些訊息自動發佈到 GitLab 上, 來節省開發人員的時間.&lt;/p>
&lt;h3 id="測試環境">測試環境&lt;/h3>
&lt;h4 id="使用docker建立測試環境">使用docker建立測試環境&lt;/h4>
&lt;p>先啟動Redmine在啟動Gitlab&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/chiehting/docker-redmine">Redmine&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/chiehting/docker-gitlab">Gitlab&lt;/a>&lt;/li>
&lt;/ul>
&lt;h4 id="網段配置">網段配置&lt;/h4>
&lt;p>在docker-gitlab/docker-compose.yml中新增下面設定,為了將兩個服務在同一網段下.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nt">services&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">web&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;gitlab/gitlab-ce:12.3.1-ce.0&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">...&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">networks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">networks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">external&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">docker-redmine_default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h5 id="本次測試服務ip位置">本次測試服務IP位置&lt;/h5>
&lt;ul>
&lt;li>gitlab: 172.30.0.4&lt;/li>
&lt;li>redmine: 172.30.0.3&lt;/li>
&lt;/ul>
&lt;h5 id="設定hosts透過域名互通">設定hosts,透過域名互通&lt;/h5>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">sudo &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;172.30.0.4 gitlab.example.com&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/hosts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">sudo &lt;span class="nb">echo&lt;/span> &lt;span class="s1">&amp;#39;172.30.0.3 redmine.example.com&amp;#39;&lt;/span> &amp;gt;&amp;gt; /etc/hosts
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="設定redmine">設定redmine&lt;/h3>
&lt;h4 id="安裝plugin">安裝plugin&lt;/h4>
&lt;p>希望 git push 時觸發 Redmine, 所以要加入此 plugin. git clone &lt;a href="https://github.com/phlegx/redmine_gitlab_hook">redmine_gitlba_hook&lt;/a>到 plugins 的資料夾中.
再來可以在&lt;code>Administration » Plugins » GitLab Authentication&lt;/code>中做設定,目前設定如下.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>參數&lt;/th>
&lt;th>值&lt;/th>
&lt;th>說明&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>All branches&lt;/td>
&lt;td>v&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Prune&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Auto create&lt;/td>
&lt;td>v&lt;/td>
&lt;td>自動建立repo&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Local repositories path&lt;/td>
&lt;td>/usr/src/redmine/repo&lt;/td>
&lt;td>redmine拉repo的位置,要注意權限,需要redmine可以寫入的權限&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Git command prefix&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Fetch updates from repository&lt;/td>
&lt;td>v&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h4 id="設定api-key">設定API Key&lt;/h4>
&lt;p>在&lt;code>Administration » Settings » Repositories&lt;/code>中Enable WS for repository management再Generate a key.
這裡取得了&lt;code>Key:rYtIYdc2zR9ZvZ8M24L8&lt;/code>&lt;/p>
&lt;h4 id="建立專案">建立專案&lt;/h4>
&lt;p>建立一個專案叫做DevOps&lt;/p>
&lt;h4 id="建立議題">建立議題&lt;/h4>
&lt;p>需要先設定trackers,在建立一筆Issue,建立完成後index應該是#1.&lt;/p>
&lt;h4 id="設定專案">設定專案&lt;/h4>
&lt;p>建立一個叫做DevOps的專案,設定專案下的&lt;code>integrations » redmine&lt;/code>.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>參數&lt;/th>
&lt;th>值&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Active&lt;/td>
&lt;td>V&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Description&lt;/td>
&lt;td>Redmine issue tracker&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Project url&lt;/td>
&lt;td>&lt;a href="http://redmine.example.com/projects/devops">http://redmine.example.com/projects/devops&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Issues url&lt;/td>
&lt;td>&lt;a href="http://redmine.example.com/issues/:id">http://redmine.example.com/issues/:id&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>New issue url&lt;/td>
&lt;td>&lt;a href="http://redmine.example.com/projects/devops/issues/new">http://redmine.example.com/projects/devops/issues/new&lt;/a>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>建立一個&lt;code>webhook&lt;/code>來觸發redmine_gitlba_hook,設定專案下的&lt;code>integrations&lt;/code>.&lt;/p>
&lt;p>URL如下:&lt;/p>
&lt;ul>
&lt;li>&lt;code>http://redmine.example.com/gitlab_hook?key=rYtIYdc2zR9ZvZ8M24L8&amp;amp;project_id=devops&amp;amp;repository_name=devops&amp;amp;repository_namespace=root&amp;amp;repository_git_url=http://gitlab.example.com/root/devops&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>or&lt;/p>
&lt;ul>
&lt;li>&lt;code>http://redmine.example.com/gitlab_hook?key=rYtIYdc2zR9ZvZ8M24L8&amp;amp;project_id=devops&amp;amp;repository_name=devops&amp;amp;repository_namespace=root&amp;amp;repository_git_url=git@gitlab.example.com:root/devops.git&lt;/code>&lt;/li>
&lt;/ul></description></item><item><title>redis-trib.rb reshard problem</title><link>https://chiehting.com/posts/redis-trib-reshard-problem/</link><pubDate>Sun, 07 Apr 2019 00:38:19 +0800</pubDate><guid>https://chiehting.com/posts/redis-trib-reshard-problem/</guid><description>
&lt;p>Redis 跟 redis-trib.rb 遷移工具有版本不相容, 這邊紀錄解決過程.&lt;/p>
&lt;h3 id="redis-版本問題">Redis 版本問題&lt;/h3>
&lt;blockquote>
&lt;p>We also used redis-cluster ver3.0.6, but redis.trib.rb reshard did not work as 3.0.6 MIGRATE command returns an ASK response.
redis.trib.rb reshard would always fail, and nodes.conf would be corrupted at that time.
This problem has been fixed in 3.0.7. In redis-cluster ver 3.0.7, redsi-trib.rb works fine at all.&lt;/p>
&lt;/blockquote>
&lt;p>在做slot轉移時,碰到異常,網路上說v3.0.6會出現這錯誤,需要做升級.
之後決定升級到4.0版本, 下面為升級過程.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 碰到error,先做下面加入ARRAY&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1"># W: mdadm: /etc/mdadm/mdadm.conf defines no arrays.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">sudo vim /etc/mdadm/mdadm.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="c1"># add line : ARRAY &amp;lt;ignore&amp;gt; devices=/dev/sda&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">sudo add-apt-repository ppa:chris-lea/redis-server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">sudo apt-get update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">sudo apt-get upgrade redis-server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="c1"># 裡面有個選擇&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="c1"># Y保留正在運行的服務,並將redis.conf複製成redis.blk.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="c1"># N終止服務,並直接將新的設定檔覆蓋redis.conf&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="redis-釋出版本-408">Redis 釋出版本 4.0.8&lt;/h3>
&lt;p>官方釋出版本 4.0.8, 但 apt 套件安裝工具並未更新的這麼即時.
所以選擇自行編譯原始碼來安裝 redis-cli 4.0.8.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">wget -c http://download.redis.io/releases/redis-4.0.8.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">tar -xvf redis-4.0.8.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="nb">cd&lt;/span> redis-4.0.8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">mv redis-4.0.8 /etc/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">make
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">sudo make install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="nb">cd&lt;/span> utils/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">sudo ./install_server.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">sudo systemctl status redis
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">redis-cli -v
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="gem-版本問題">gem 版本問題&lt;/h3>
&lt;p>在做 reshard 的 slot 遷移時碰到錯誤 [ERR] Calling MIGRATE: ERR Syntax error, try CLIENT (LIST | KILL | GETNAME | SETNAME | PAUSE | REPLY)&lt;/p>
&lt;p>Fix:&lt;/p>
&lt;blockquote>
&lt;p>Just installing an earlier version of redis.rb fixes the issue. This worked for me:
gem install redis -v 3.3.3&lt;/p>
&lt;/blockquote>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># install redis.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">sudo gem install redis -v 3.3.3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1"># list all package&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">sudo gem list &lt;span class="p">|&lt;/span>grep redis
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="c1"># uninstall old version of redis.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">sudo gem uninstall redis --version 4.0.1
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="其他指令">其他指令&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 加入slave節點&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">./redis-trib.rb add-node --slave --master-id 38ad774c7edaff3e93cf1a07926cd00312b93db7 10.0.2.12:6380 10.0.2.12:6379
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Install Redis Cluster</title><link>https://chiehting.com/posts/redis-cluster-install/</link><pubDate>Tue, 02 Apr 2019 21:45:40 +0800</pubDate><guid>https://chiehting.com/posts/redis-cluster-install/</guid><description>
&lt;p>在 Ubuntu 上安裝 Redis cluster 過程紀錄.&lt;/p>
&lt;h3 id="setting-ubuntu">setting Ubuntu&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">sudo apt-get update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1"># 北京時區+8&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">sudo dpkg-reconfigure tzdata
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>配置 ulimit 來解除 Linux 系統的最大進程數和最大文件打開數限制, *代表針對所有用戶，noproc 是代表最大進程數，nofile 是代表最大文件打開數.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 編輯檔案 /etc/security/limits.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">* soft noproc &lt;span class="m">65535&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">* hard noproc &lt;span class="m">65535&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">* soft nofile &lt;span class="m">65535&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">* hard nofile &lt;span class="m">65535&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>編輯檔案 &lt;code>/etc/pam.d/common-session&lt;/code> 讓 Ubuntu 使用 &lt;code>pam_limits.so&lt;/code> 模組.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># required pam_limits.so at common-session file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">sudo vim /etc/pam.d/common-session
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">session required pam_limits.so
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># required pam_limits.so at common-session-noninteractive file&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">sudo vim /etc/pam.d/common-session-noninteractive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">session required pam_limits.so
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>開啟指定的 port , 讓 Redis cluster 可以做網路的溝通.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># redis集群不僅需要開通redis客戶端連接的端口，而且需要開通集群總線端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1"># 集群總線端口為redis客戶端連接的端口+ 10000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="c1"># 如redis端口為6379&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="c1"># 則集群總線端口為16379,故，所有服務器的點需要開通redis的客戶端連接端口和集群總線端口&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">sudo ufw allow &lt;span class="m">6379&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">sudo ufw allow &lt;span class="m">16379&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">sudo ufw allow &lt;span class="m">6380&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">sudo ufw allow &lt;span class="m">16380&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="c1"># 啟動防火牆&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">sudo ufw &lt;span class="nb">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="c1"># 刪除防火牆用&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="c1"># sudo ufw delete allow 6379,6380/tcp&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>重新啟動, 並確認上面的設定有再重開機後有啟用.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">sudo reboot
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="install-redis-cluster">Install Redis cluster&lt;/h3>
&lt;h4 id="方法一-透過套件安裝工具安裝">方法一: 透過套件安裝工具安裝&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 安裝套件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">sudo apt-get install redis-server redis-tools ruby
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1"># 確認版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">redis-server --version
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">Redis server &lt;span class="nv">v&lt;/span>&lt;span class="o">=&lt;/span>3.0.6 &lt;span class="nv">sha&lt;/span>&lt;span class="o">=&lt;/span>00000000:0 &lt;span class="nv">malloc&lt;/span>&lt;span class="o">=&lt;/span>jemalloc-3.6.0 &lt;span class="nv">bits&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">64&lt;/span> &lt;span class="nv">build&lt;/span>&lt;span class="o">=&lt;/span>687a2a319020fa42
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">&lt;span class="c1"># 安裝完成後,應該就會看到process再跑&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">sudo ss -ln &lt;span class="p">|&lt;/span> grep &lt;span class="m">6379&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="方法二-下載原始碼編譯">方法二: 下載原始碼編譯&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># install build base&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">sudo apt-get update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">sudo apt-get install build-essential ruby
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">wget http://download.redis.io/releases/redis-4.0.11.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">tar xzf redis-4.0.11.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="nb">cd&lt;/span> redis-4.0.11
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">sudo make &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> make install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="nb">cd&lt;/span> utils
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">sudo ./install_server.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="setting-redis-configuration">setting Redis configuration&lt;/h3>
&lt;p>配置 Redis 服務, 有三台 host, 每台主機上有兩個 Redis 服務, 下面為一台主機的設定：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 先將服務停止&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">sudo systemctl stop redis
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 複製redis的設定檔案&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">sudo cp /etc/redis/redis.conf /etc/redis/redis_6379.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">sudo cp /etc/redis/redis.conf /etc/redis/redis_6380.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">sudo vim /etc/redis/redis_6379.conf /etc/redis/redis_6380.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1"># modified content&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">pidfile /var/run/redis/redi_6379.pid &lt;span class="c1"># 依據master,slave起 redi_6379.pid,redi_6380.pid&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">port &lt;span class="m">6379&lt;/span> &lt;span class="c1"># 依據master,slave起 6379,6380兩個port&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="c1"># bind 0.0.0.0 # 取消綁定網段&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">protected-mode no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">logfile /var/log/redis/redis_6379.log &lt;span class="c1"># redis_6379.log,redis_6380.log&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">dbfilename dump.rdb &lt;span class="c1"># 統一dump.rdb&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">dir /www/redis_6379 &lt;span class="c1"># 變更目錄redis_6379,redis_6380&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">appendonly yes &lt;span class="c1"># 啟用持久化&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">cluster-enabled yes &lt;span class="c1"># 啟用Redis Cluster&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">cluster-config-file nodes.conf &lt;span class="c1"># 指定Redis Cluster Config存放檔案,nodes_6379.conf,nodes_6380.conf&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">cluster-node-timeout &lt;span class="m">5000&lt;/span> &lt;span class="c1"># Cluster Node TimeOut，超過視為Fail Node&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">repl-diskless-sync no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">appendfsync no
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">hash-max-ziplist-value &lt;span class="m">1024&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 若有變更目錄記得建立,可以不用複製原目錄 sudo cp -r /var/lib/redis /www/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">sudo mkdir -p /www/redis_6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">sudo chown -R redis:redis /www/redis_6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">sudo chown redis:redis /etc/redis/redis_6379.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">sudo mkdir -p /www/redis_6380
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">sudo chown -R redis:redis /www/redis_6380
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">sudo chown redis:redis /etc/redis/redis_6380.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="c1"># 關閉deamon&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">sudo systemctl stop redis
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">sudo systemctl disable redis
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="c1"># sudo systemctl start redis&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="c1"># 記得起動服務&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">sudo redis-server /etc/redis/redis_6379.conf &lt;span class="c1"># 若systemctl遇到異常,採用systemctl啟動不了,採用此方式啟動&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">sudo redis-server /etc/redis/redis_6380.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>所有 host 都完成上述步驟之後, 在其中一部建立 Redis cluster&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">sudo gem install redis
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">sudo gem install redis -v 3.3.3 &lt;span class="c1"># 指定版本&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">sudo find / -name redis-trib.rb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="c1"># --replicas 1 表示每個Master帶有一個Slave&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">sudo ./redis-trib.rb create --replicas &lt;span class="m">0&lt;/span> 10.0.0.17:6379 10.0.0.11:6379 10.0.0.16:6379 &lt;span class="c1"># 這是Master,Master,Master的架構&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">sudo ./redis-trib.rb create --replicas &lt;span class="m">1&lt;/span> 10.0.0.5:6379 10.0.0.5:6380 10.0.0.11:6379 10.0.0.11:6380 10.0.0.16:6379 10.0.0.16:6380 &lt;span class="c1"># 這是Master,Slave,Master,Slave,Master,Slave的架構&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="c1"># 若被中斷,遇到ERR Slot 0 is already busy (Redis::CommandError),對所有node執行下面命令&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="c1"># 127.0.0.1:6379&amp;gt; FLUSHALL&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="c1"># 127.0.0.1:6380&amp;gt; CLUSTER RESET SOFT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="c1"># 添加節點&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="c1"># ruby ./redis-trib.rb add-node 192.168.3.15:6390 192.168.3.12:6390&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="c1"># 分配槽空間，根據嚮導分配對應的槽給心得節點&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="c1"># ruby ./redis-trib.rb reshard 192.168.3.15:6390&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="c1"># 確認群集狀態&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">redis-cli -c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">127.0.0.1:6379&amp;gt; CLUSTER NODES
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">a1c717fe107 10.0.0.16:6380 slave fa1685991b3 &lt;span class="m">0&lt;/span> &lt;span class="m">1515476872739&lt;/span> &lt;span class="m">6&lt;/span> connected
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">fa1685991b3 10.0.0.16:6379 master - &lt;span class="m">0&lt;/span> &lt;span class="m">1515476872238&lt;/span> &lt;span class="m">5&lt;/span> connected 10923-16383
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">e356bc7bc46 10.0.0.11:6379 master - &lt;span class="m">0&lt;/span> &lt;span class="m">1515476873241&lt;/span> &lt;span class="m">3&lt;/span> connected 5461-10922
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">e3423dd62fa 10.0.0.17:6379 myself,master - &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span> &lt;span class="m">1&lt;/span> connected 0-5460
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">63a93b44330 10.0.0.11:6380 slave e3423dd62fa &lt;span class="m">0&lt;/span> &lt;span class="m">1515476873241&lt;/span> &lt;span class="m">4&lt;/span> connected
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">590885b4164 10.0.0.17:6380 slave e356bc7bc46 &lt;span class="m">0&lt;/span> &lt;span class="m">1515476873742&lt;/span> &lt;span class="m">3&lt;/span> connected
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># automation start redis service at reboot&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">sudo vim /etc/rc.local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">sudo redis-server /etc/redis/redis_6379.conf &lt;span class="c1"># append content&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">sudo redis-server /etc/redis/redis_6380.conf &lt;span class="c1"># append content&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>執行測試&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">redis-cli -c -p &lt;span class="m">6379&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">127.0.0.1:6379&amp;gt; &lt;span class="nb">set&lt;/span> foo bar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">127.0.0.1:6379&amp;gt; get goo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">-&amp;gt; Redirected to slot &lt;span class="o">[&lt;/span>6310&lt;span class="o">]&lt;/span> located at 10.0.0.11:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="o">(&lt;/span>nil&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">10.0.0.11:6379&amp;gt; get foo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">-&amp;gt; Redirected to slot &lt;span class="o">[&lt;/span>12182&lt;span class="o">]&lt;/span> located at 10.0.0.16:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="s2">&amp;#34;bar&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">10.0.0.16:6379&amp;gt; &lt;span class="nb">set&lt;/span> hello world
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">-&amp;gt; Redirected to slot &lt;span class="o">[&lt;/span>866&lt;span class="o">]&lt;/span> located at 10.0.0.17:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">10.0.0.17:6379&amp;gt; get hello world
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="o">(&lt;/span>error&lt;span class="o">)&lt;/span> ERR wrong number of arguments &lt;span class="k">for&lt;/span> &lt;span class="s1">&amp;#39;get&amp;#39;&lt;/span> &lt;span class="nb">command&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">10.0.0.17:6379&amp;gt; get hello
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="s2">&amp;#34;world&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">10.0.0.17:6379&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>測試完畢後可以查閱 log 確認有沒有異常, 若看到警告 warning 可以做排除.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">7439:M &lt;span class="m">19&lt;/span> Jun 14:11:51.373 &lt;span class="c1"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add &amp;#39;vm.overcommit_memory = 1&amp;#39; to /etc/sysctl.conf and then reboot or run the command &amp;#39;sysctl vm.overcommit_memory=1&amp;#39; for this to take effect.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">sudo &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;vm.overcommit_memory = 1&amp;#34;&lt;/span> &amp;gt;&amp;gt; /etc/sysctl.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">sudo sysctl vm.overcommit_memory&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h3 id="一主二從三衛兵">一主二從三衛兵&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">sudo apt-get update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">//北京時區+8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">sudo dpkg-reconfigure tzdata
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">sudo apt-get install redis-server redis-sentinel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">//安裝完成後,應該就會看到process再跑
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">sudo ss -ln &lt;span class="p">|&lt;/span> grep &lt;span class="m">6379&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Create a Self-Signed SSL Certificate for Nginx</title><link>https://chiehting.com/posts/nginx-self-signed-ssl-certificate/</link><pubDate>Tue, 02 Apr 2019 13:00:49 +0800</pubDate><guid>https://chiehting.com/posts/nginx-self-signed-ssl-certificate/</guid><description>
&lt;p>紀錄在 Nginx 安裝自簽的 SSL 憑證.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 生成私钥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">openssl genpkey -algorithm RSA -out ca.key -aes256
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1"># 生成自签名 CA 证书&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">openssl req -new -x509 -key ca.key -out ca.crt -days &lt;span class="m">3650&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 生成私钥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">openssl genpkey -algorithm RSA -out registry.key
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="c1"># 生成证书签署请求 (CSR)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">openssl req -new -key registry.key -out registry.csr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="c1"># 使用 CA 证书签署请求，生成 Docker registry 证书&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">openssl x509 -req -in registry.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out registry.crt -days &lt;span class="m">3650&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">openssl x509 -req -in registry.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out registry.crt -days &lt;span class="m">3650&lt;/span> -extensions v3_usr -extfile openssl.cnf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="使用-openssl-建立自簽憑證">使用 openssl 建立自簽憑證&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">sudo openssl req -x509 -nodes -days &lt;span class="m">3650&lt;/span> -newkey rsa:2048 -keyout /etc/nginx/certs/nginx-selfsigned.key -out /etc/nginx/certs/nginx-selfsigned.crt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">sudo openssl dhparam -out /etc/nginx/certs/dhparam.pem &lt;span class="m">2048&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="生成带有-sans-的证书">生成带有 SANs 的证书&lt;/h4>
&lt;p>如果你使用 OpenSSL 生成自簽名證書 &lt;code>openssl.cnf&lt;/code>，確保包含 SANs，可以通過以下命令實現：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-toml" data-lang="toml">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="p">[&lt;/span> &lt;span class="nx">req&lt;/span> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="nx">default_bits&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">2048&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="nx">distinguished_name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">lindu&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="nx">req_extensions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">req_ext&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="nx">x509_extensions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">v3_ca&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="nx">default_bits&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">2048&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="nx">default_keyfile&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">registry&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="nx">default_md&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">sha256&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="nx">default_days&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">365&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="nx">distinguished_name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">lindu&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="nx">req_extensions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">req_ext&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="nx">x509_extensions&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">v3_usr&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="p">[&lt;/span> &lt;span class="nx">lindu&lt;/span> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="nx">countryName&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">CN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="nx">countryName_default&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">CN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">&lt;span class="nx">stateOrProvinceName&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">Shenzhen&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="nx">stateOrProvinceName_default&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">Shenzhen&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="nx">localityName&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">Shenzhen&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="nx">localityName_default&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">Shenzhen&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="nx">organizationName&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">Lindu&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&lt;span class="nx">organizationName_default&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">Lindu&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="nx">commonName&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">lindu-lab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">com&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="nx">commonName_max&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">64&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">&lt;span class="p">[&lt;/span> &lt;span class="nx">req_ext&lt;/span> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">&lt;span class="nx">subjectAltName&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="err">@&lt;/span>&lt;span class="nx">alt_names&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">&lt;span class="p">[&lt;/span> &lt;span class="nx">v3_ca&lt;/span> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">&lt;span class="nx">subjectAltName&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="err">@&lt;/span>&lt;span class="nx">alt_names&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl">&lt;span class="p">[&lt;/span> &lt;span class="nx">alt_names&lt;/span> &lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">&lt;span class="nx">DNS&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">lindu-lab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">com&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl">&lt;span class="nx">DNS&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">reg&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">lindu-lab&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">com&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl">&lt;span class="nx">IP&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mf">192.168&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="mf">2.8&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">sudo openssl req -x509 -nodes -days &lt;span class="m">3650&lt;/span> -newkey rsa:2048 -keyout /etc/nginx/certs/nginx-selfsigned-reg.key -out /etc/nginx/certs/nginx-selfsigned-reg.crt -config openssl.cnf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="setting-nginx-configuration">Setting Nginx configuration&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">ssl_certificate /etc/nginx/certs/nginx-selfsigned.crt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">ssl_dhparam /etc/nginx/certs/dhparam.pem;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">server {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> listen 443 ssl;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> server_name _;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> index index.html index.php;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> access_log /var/log/nginx/access.log main;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> error_log /var/log/nginx/error.log error;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> location / {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> proxy_pass http://backend;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> location ~ /\.ht {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> deny all;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="references">References&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="http://nginx.org/en/docs/http/configuring_https_servers.html">configuring https servers of Nginx&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Relearn PHP</title><link>https://chiehting.com/posts/php7-document/</link><pubDate>Thu, 21 Dec 2017 00:00:00 +0800</pubDate><guid>https://chiehting.com/posts/php7-document/</guid><description>
&lt;p>PHP7 release也一段時間了,最近在開發常會看到相關的文章,最近抽個空好好來重新學習PHP.&lt;/p>
&lt;h2 id="preface">Preface&lt;/h2>
&lt;p>&amp;quot;PHP: Hypertext Preprocessor&amp;quot;,官方網站表明PHP很適合做web development,但是並不局限於此,亦可做Process Control,但是依據個人經驗,PHP5.3以下的版本做浮點數的運算不是很精準.&lt;/p>
&lt;p>另外在2015年PHP7問世,效率更是翻倍,但是有著相容性問題,系統升級前需要做好測試.&lt;/p>
&lt;h2 id="環境建置">環境建置&lt;/h2>
&lt;p>採用&lt;a href="https://www.virtualbox.org/">Virtualbox&lt;/a>+&lt;a href="https://www.vagrantup.com/">Vagrant&lt;/a>來架設環境,執行步驟如下:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>安裝Virtualbox與Vagrant,這邊就不講解了,幾本上下一步到底&lt;/p>
&lt;/li>
&lt;li>
&lt;p>下載Vagrant box&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">$ vagrant box add rasmus/php7dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">$ vagrant init rasmus/php7dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1"># 確認box list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">$ vagrant box list
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>git clone&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">git clone https://github.com/rlerdorf/php7dev.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nb">cd&lt;/span> php7dev
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>共享目錄設定,編輯php7dev.yaml檔案&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nt">folders&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">map&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">www&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">to&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">/var/www/default&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>啟動VM、進入VM、暫停VM、註銷VM&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 啟動VM&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">$ vagrnat up
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1"># 進入VM&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">$ vagrant ssh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1"># 暫停VM&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">$ vagrant halt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="c1"># 註銷VM&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">$ vagrant destroy --force
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>建立檔案&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 建立一個 index.php 檔案, 運行可以顯示 PHP 資訊&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">$ &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;?php echo phpinfo(); ?&amp;gt;&amp;#34;&lt;/span> &amp;gt; /var/www/default/index.php
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>環境建立完成,再來可以透過Browser輸入&lt;code>http://192.168.7.7/&lt;/code>來進入站台.&lt;/p>
&lt;hr>
&lt;h2 id="type">Type&lt;/h2>
&lt;p>PHP是屬於弱型別的語言,也就是變數不用宣告就直接可以做assign,但是資料型態還是程式語言的重點基礎之一,還是要好好的認識一下.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Boolean:通常是一個常量&lt;code>true&lt;/code>或&lt;code>false&lt;/code>,不區分大小寫.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$var1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">$var2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">False&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Integer:是一個&lt;em>有限整數&lt;/em>((2^32)-1),集合中的某個數Z = {..., -2, -1, 0, 1, 2, ...}&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1">//自PHP5.4.0後可以採用十進制、十六進制、八進制、二進制
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1234&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//十進制
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">123&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//負數
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mo">0123&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//八進制
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mh">0x1A&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//十六進制
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="nx">b11111111&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//二進制
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Float:也就是小數,長度取決於平台. 另外不要相信浮點數結果精確到了最後一位,也永遠不要比較兩個浮點數是否相等,如果確實需要更高的精度,應該使用&lt;em>任意精度數學函數&lt;/em>或者&lt;em>gmp函數&lt;/em>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1.23456789&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>String:每個字都是由一系列的character(字元)組成(字的編碼),每個字元相當於一個byte(2^8),也就是說PHP只支援到256-character,因此不支援Unicode(因為過長).&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nv">$name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;ting&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;my name is $name&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//全視為為字串
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;my name is &lt;/span>&lt;span class="si">$name&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//對$name進行解析
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="c1">//Heredoc結構,自PHP5.3起,會對變數進行解析
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;lt;&amp;lt;&amp;lt;&lt;/span>&lt;span class="dl">EOT&lt;/span>&lt;span class="s">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="s">my name is $name
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="s"> &lt;/span>&lt;span class="dl">EOT&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="c1">//newcode結構,全視為字串,不對變數進行解析
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;lt;&amp;lt;&amp;lt;&amp;#39;&lt;/span>&lt;span class="dl">EOT&lt;/span>&lt;span class="s">&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="s">my name is $name
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="s"> &lt;/span>&lt;span class="dl">EOT&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Array:是一組有序映射,官網說&amp;quot;it can be treated as an array, list (vector), hash table (an implementation of a map), dictionary, collection, stack, queue, and probably more.&amp;quot;,由此可見他的功能很廣.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$array&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;foo&amp;#34;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;bar&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">// 自 PHP 5.4 起
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$array&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="s2">&amp;#34;foo&amp;#34;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;bar&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Object:物件.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">foo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="nf">do_foo&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;Doing foo.&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">&lt;span class="nv">$bar&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">foo&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">&lt;span class="nv">$bar&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">do_foo&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Resource:資源,通常可能是連接資料庫、開啟文件.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>NULL:指一個變數還未被assign,或著被釋放&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">NULL&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Callback&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nx">error_reporting&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">E_ALL&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="k">function&lt;/span> &lt;span class="nf">increment&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nv">$var&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="nv">$var&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="nx">call_user_func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;increment&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$a&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">$a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="nx">call_user_func_array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;increment&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nv">$a&lt;/span>&lt;span class="p">));&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">$a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="variables">Variables&lt;/h2>
&lt;p>變數的命名很重要,程式要寫的漂亮的重點之一就是變數的命名.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>基本變數:PHP中宣告變數是使用符號*$*後面再跟上'^[a-zA-Z][_]?[\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*',且命名是有大小寫的區別.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;Bob&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">$bar&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="nv">$var&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//$bar被assign變數$var,且記憶體位置相同
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>全域變數與區域變數&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="k">function&lt;/span> &lt;span class="nf">Test&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="k">global&lt;/span> &lt;span class="nv">$a&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="nv">$b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$a&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="nv">$b&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">$b&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//Undefined variable
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">Test&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Static variable:靜態變數只會在函數中出現,當程序離開函式,其值不丟失.從下面範例可以發現,在$b被宣告時,都還是NULL的狀態,宣告後才會取回值.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">function&lt;/span> &lt;span class="nf">Test&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$b&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="k">static&lt;/span> &lt;span class="nv">$b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$b&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="nv">$b&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">&lt;span class="nx">Test&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Variable variables:變數的名稱也是變數,這樣的特性讓程式變得更彈性.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;hello&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">$hello&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;world&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="nv">$world&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;a&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">$a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;br/&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">$$a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;br/&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">$$$a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s1">&amp;#39;&amp;lt;br/&amp;gt;&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">$a&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">$a&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> &amp;lt;br/&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">$a&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">$hello&lt;/span>&lt;span class="s2"> &amp;lt;br/&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h2 id="constants">Constants&lt;/h2>
&lt;p>常量定義好後,就無法變更,且長量名稱區分大小寫.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="nx">define&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;version&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s2">&amp;#34;0.1&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1">//magic constants
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">function&lt;/span> &lt;span class="nf">a&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="no">__function__&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="k">function&lt;/span> &lt;span class="nf">b&lt;/span>&lt;span class="p">(){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="no">__function__&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nx">b&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;hr>
&lt;h2 id="operators">Operators&lt;/h2>
&lt;p>運算子有先後順序,個人習慣將運算子拆開,一來確保程式的穩定度,二來增加程式的可讀性&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">true&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="k">true&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// (true ? 0 : true) ? 1 : 2 = 2
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="nv">$b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$b&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// $a = ($b += 3) -&amp;gt; $a = 5, $b = 5
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>
&lt;p>算數運算子&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//prints 8
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//prints 2
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//prints 15
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">15&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//prints 5
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//prints 2
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">5&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//prints 125
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>位元運算子&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="nx">b0010&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="nx">b0010&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//print 2
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="nx">b0010&lt;/span> &lt;span class="o">|&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="nx">b0010&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//print 2
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="nx">b0010&lt;/span> &lt;span class="o">^&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="nx">b0011&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//print 1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="o">~&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="nx">b0101&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//print -6
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="nx">b0010&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//print 1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="nx">b0010&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//print 4
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>比較運算子&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;a&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//0 == 0 -&amp;gt; true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;1&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;01&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//1 == 1 -&amp;gt; true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;10&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;1e1&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//10 == 10 -&amp;gt; true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">100&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;1e2&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//100 == 100 -&amp;gt; true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;1e1&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//string &amp;#39;1e1&amp;#39;
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>錯誤控制運算子&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="o">@&lt;/span>&lt;span class="k">include&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;./not_exist_file.php&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">$x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">@&lt;/span>&lt;span class="nv">$a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Execution Operators:以前都用exec(),這個好方便&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$mkdir&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sb">`mkdir new floder`&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">$output&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="sb">`ls -al`&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;pre&amp;gt;&lt;/span>&lt;span class="si">$output&lt;/span>&lt;span class="s2">&amp;lt;/pre&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>遞增/遞減運算子&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">$a&lt;/span>&lt;span class="o">++.&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;br /&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//print 5
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="nv">$a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;br /&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//print 7
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="nv">$a&lt;/span>&lt;span class="o">--.&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;br /&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//print 7
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="nv">$a&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="s2">&amp;#34;&amp;lt;br /&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//print 5
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Logical Operators&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1">//&amp;#34;||&amp;#34; 比 &amp;#34;or&amp;#34; 的優先级高,&amp;#34;&amp;amp;&amp;amp;&amp;#34; 比 &amp;#34;and&amp;#34; 的優先级高
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$e&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">false&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="k">true&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//bool(true),等同于：($e = (false || true))
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$f&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">false&lt;/span> &lt;span class="k">or&lt;/span> &lt;span class="k">true&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//bool(false),等同于：(($f = false) or true)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$g&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">true&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="k">false&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//bool(false),等同于：($g = (true &amp;amp;&amp;amp; false))
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">true&lt;/span> &lt;span class="k">and&lt;/span> &lt;span class="k">false&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//bool(true),等同于：(($h = true) and false)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>String Operators&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Hello &amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">$b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$a&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s2">&amp;#34;World!&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// now $b contains &amp;#34;Hello World!&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Hello &amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="nv">$a&lt;/span> &lt;span class="o">.=&lt;/span> &lt;span class="s2">&amp;#34;World!&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// now $a contains &amp;#34;Hello World!&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Array Operators&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;a&amp;#34;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;apple&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;b&amp;#34;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;banana&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="nv">$b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;a&amp;#34;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;pear&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;b&amp;#34;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;strawberry&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;c&amp;#34;&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="s2">&amp;#34;cherry&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="nv">$c&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$a&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nv">$b&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// Union of $a and $b
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$c&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// print array(3) {[&amp;#34;a&amp;#34;]=&amp;gt;&amp;#34;apple&amp;#34;,[&amp;#34;b&amp;#34;]=&amp;gt;&amp;#34;banana&amp;#34;,[&amp;#34;c&amp;#34;]=&amp;gt;&amp;#34;cherry&amp;#34;}
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Type Operators&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">ParentClass&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MyClass&lt;/span> &lt;span class="k">extends&lt;/span> &lt;span class="nx">ParentClass&lt;/span>&lt;span class="p">{}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">MyClass&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$a&lt;/span> &lt;span class="nx">instanceof&lt;/span> &lt;span class="nx">MyClass&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//bool(true)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$a&lt;/span> &lt;span class="nx">instanceof&lt;/span> &lt;span class="nx">ParentClass&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//bool(true)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h2 id="control-structures">Control Structures&lt;/h2>
&lt;p>通常要呈現一個商業邏輯都會透過流程控制來表示,而每種商業邏輯呈現的方法百百種,所以要築構一支好的程式,對流程控制的熟悉度不可少.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>if else&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$a&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="nv">$b&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;a is bigger than b&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="k">elseif&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$a&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="nv">$b&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;a is smaller than b&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="k">else&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;a is equal b&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="k">endif&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>while:循環語法之一,在遞迴中很好用&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$i&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="k">endwhile&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>do-while:跟while很像,差異在於while在執行前做判斷,do-while在執行後做判斷.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">do&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$i&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>for&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="p">(;;)&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$i&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="k">endif&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="nv">$i&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="nv">$i&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="k">endfor&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>foreach:用來解構array很好用&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">foreach&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nv">$value&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="nv">$value&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$value&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="k">endforeach&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>break&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nv">$arr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;one&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;two&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;three&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;four&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;stop&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;five&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="k">list&lt;/span> &lt;span class="p">(,&lt;/span> &lt;span class="nv">$val&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">each&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$arr&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$val&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;stop&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="cm">/* You could also write &amp;#39;break 1;&amp;#39; here. */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">$val&lt;/span>&lt;span class="s2">&amp;lt;br /&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>continue&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="nv">$i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="nv">$i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$i&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="k">print&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">$i\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>switch:在做Boolean值判斷的時候建議使用if else,若做值得判斷則可使用switch&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">switch&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;i equals 0&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="k">case&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;i equals to 1, 2&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="k">default&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;i is not equal to 0, 1 or 2&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>declare:Zend引擎每執行1條低級語句就去執行一次register_tick_function()注冊的函數&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">declare&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">ticks&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="c1">// A function called on each tick event
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">function&lt;/span> &lt;span class="nf">tick_handler&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;tick_handler() called&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="nx">register_tick_function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;tick_handler&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="nv">$a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$a&lt;/span> &lt;span class="o">&amp;gt;&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="nv">$a&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="k">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$a&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>return:如果在全局範圍中調用,則當前腳本文件中止運行.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>require/include/require_once/include_once&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">require&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;somefile.php&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//若找不到檔案發出E_COMPILE_ERROR级别錯誤,並終止程序
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">include&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;somefile.php&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//若找不到檔案發出E_WARNING级别錯誤,繼續程序
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">require_once&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;somefile.php&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//和require一樣,但已經包含過的檔案則不會再包含
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">include_once&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;somefile.php&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//和include一樣,但已經包含過的檔案則不會再包含
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>goto:只在PHP 5.3以上版本有效,跳轉至改文件的目標.目標位置只能位於同一個文件和作用域,也就是說無法跳出一個函數或類方法,也無法跳入到另一個函數.也無法跳入到任何循環或者switch結構中.可以跳出循環或者switch,通常的用法是用goto代替多層的break.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1">//下面結果輸出Bar
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">goto&lt;/span> &lt;span class="nx">a&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;Foo&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="nx">a&lt;/span>&lt;span class="o">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="s1">&amp;#39;Bar&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h3 id="function">Function&lt;/h3>
&lt;p>這邊要注意部分預設函式是跟著extension加載的,例如mysql_connect()、imagecreatetruecolor()等,所以必須知道自己的環境是否有這些extension,可以用phpinfo()或get_loaded_extensions()來查詢.
函數名稱的命名很重要,好的命名可以讓程式可讀性提升,更好維護.&lt;/p>
&lt;ol>
&lt;li>
&lt;p>User-defined functions&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">function&lt;/span> &lt;span class="nf">sum&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$b&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">:&lt;/span> &lt;span class="nx">float&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$a&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="nv">$b&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Variable functions&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">function&lt;/span> &lt;span class="nf">foo&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;In foo()&amp;lt;br /&amp;gt;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="nv">$func&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;foo&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="nv">$func&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">//This calls foo()
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Anonymous functions&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nx">preg_replace_callback&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;~-([a-z])~&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$match&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">strtoupper&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$match&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">},&lt;/span> &lt;span class="s1">&amp;#39;hello-world&amp;#39;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h3 id="classes-and-objects">Classes and Objects&lt;/h3>
&lt;p>自從PHP5後的版本有著較好的效能與功能&lt;/p>
&lt;ol>
&lt;li>
&lt;p>class:每個類別都有自己的constants、variables與function,並且可使用$this來調用自己.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">SimpleClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="c1">// property declaration
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">public&lt;/span> &lt;span class="nv">$var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;a default value&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="c1">// method declaration
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">displayVar&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">var&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Object Assignment:宣告物件的兩種方式.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">Class&lt;/span> &lt;span class="nc">Object&lt;/span>&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="nv">$foo&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;bar&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="nv">$objectVar&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">Object&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="nv">$reference&lt;/span> &lt;span class="o">=&amp;amp;&lt;/span> &lt;span class="nv">$objectVar&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="nv">$assignment&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$objectVar&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="nv">$objectVar&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="k">null&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$objectVar&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//NULL
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$reference&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//NULL,指向同樣的記憶體,所以$objectVar=null被註銷時,一併註銷
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$assignment&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">//object(Object),被clone
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>extends:一個class可以申明繼承另一個class的方法與屬性,不支援多個繼承.可以使用同名稱覆蓋父類別的方法,但是父類別使用final,則不能被覆蓋.被覆蓋的方法或屬性,可以透過parent::來訪問.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">ExtendClass&lt;/span> &lt;span class="k">extends&lt;/span> &lt;span class="nx">SimpleClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="c1">// Redefine the parent method
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">displayVar&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;Extending class&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl"> &lt;span class="k">parent&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">displayVar&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">8&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">9&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Properties,類別的成員.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">SimpleClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="nv">$var1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="nv">$var2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">myConstant&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="nv">$var3&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">true&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">false&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Class Constants:在類別中不變的值.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MyClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="no">constant&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;constant value&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="nf">showConstant&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="nx">self&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">constant&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">6&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">7&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Autoloading Classes:可以不用透過include檔案來加載類別,可以透過__autoload()或spl_autoload_register() 函数自動註冊類別.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="nx">spl_autoload_register&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">function&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$class_name&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">require_once&lt;/span> &lt;span class="nv">$class_name&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s1">&amp;#39;.php&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">});&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="nv">$obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">MyClass1&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">5&lt;/span>&lt;span class="cl">&lt;span class="nv">$obj2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">MyClass2&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Constructors and Destructors,在創建時會先調用__construct,註銷或程序結束時會調用__destruct.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MyDestructableClass&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="fm">__construct&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="k">print&lt;/span> &lt;span class="s2">&amp;#34;In constructor&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;MyDestructableClass&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="fm">__destruct&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="k">print&lt;/span> &lt;span class="s2">&amp;#34;Destroying &amp;#34;&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">name&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">&lt;span class="nv">$obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">MyDestructableClass&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">&lt;span class="nx">unset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$obj&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Visibility:包含public、protected、private.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MyClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="nv">$public&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;Public&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="k">protected&lt;/span> &lt;span class="nv">$protected&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;Protected&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="k">private&lt;/span> &lt;span class="nv">$private&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;Private&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="k">function&lt;/span> &lt;span class="nf">printHello&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">public&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">protected&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">private&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">&lt;span class="nv">$obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">MyClass&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">$obj&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">public&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//public
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="nv">$obj&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">protected&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//產生錯誤
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="nv">$obj&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">private&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//產生錯誤
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nv">$obj&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">printHello&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">//印出Public、Protected和Private
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Scope Resolution Operator(::):用於訪問類別的靜態成員、常量或函式.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MyClass&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="no">CONST_VALUE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;A constant value&amp;#39;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">3&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">4&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nx">MyClass&lt;/span>&lt;span class="o">::&lt;/span>&lt;span class="na">CONST_VALUE&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Class Abstraction:繼承抽象類別的子類別,強制要求一定要有父類別定義的抽象函式的實作.這樣的好處是統一子類別中的實作格式.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">abstract&lt;/span> &lt;span class="k">class&lt;/span> &lt;span class="nc">AbstractClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="c1">//抽象方法僅需要定義需要的参数
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">abstract&lt;/span> &lt;span class="k">protected&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">prefixName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">ConcreteClass&lt;/span> &lt;span class="k">extends&lt;/span> &lt;span class="nx">AbstractClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="c1">//子類別可以定義父類別抽象方法中不存在的可選参数
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">prefixName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$separator&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;Pacman&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nv">$prefix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Mr&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">elseif&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s2">&amp;#34;Pacwoman&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="nv">$prefix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;Mrs&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="nv">$prefix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$prefix&lt;/span>&lt;span class="si">}{&lt;/span>&lt;span class="nv">$separator&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2"> &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="nv">$class&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">ConcreteClass&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">$class&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">prefixName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Pacman&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//Mr. Pacman
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">echo&lt;/span> &lt;span class="nv">$class&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">prefixName&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;Pacwoman&amp;#34;&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//Mrs. Pacwoman
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Object Interfaces,透過implements導入多個介面接口,只能定義方法,但不能實作.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">interface&lt;/span> &lt;span class="nx">iTemplate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">setVariable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$var&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">getHtml&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$template&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Template&lt;/span> &lt;span class="k">implements&lt;/span> &lt;span class="nx">iTemplate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="k">private&lt;/span> &lt;span class="nv">$vars&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">setVariable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$var&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">vars&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$var&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">getHtml&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$template&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="k">foreach&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">vars&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="o">=&amp;gt;&lt;/span> &lt;span class="nv">$value&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="nv">$template&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">str_replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;{&amp;#39;&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="s1">&amp;#39;}&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$value&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$template&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$template&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Class Abstraction(抽象類別)與Object Interfaces(介面)的差異性如下面表格.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">&lt;/th>
&lt;th style="text-align:center">類別(Class)&lt;/th>
&lt;th style="text-align:center">抽象類別(Abstract Class)&lt;/th>
&lt;th style="text-align:right">介面(Interface)&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">宣告屬性(attribute)&lt;/td>
&lt;td style="text-align:center">O&lt;/td>
&lt;td style="text-align:center">O&lt;/td>
&lt;td style="text-align:right">X&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">常數(const)&lt;/td>
&lt;td style="text-align:center">O&lt;/td>
&lt;td style="text-align:center">O&lt;/td>
&lt;td style="text-align:right">O&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">實例化(new class)&lt;/td>
&lt;td style="text-align:center">O&lt;/td>
&lt;td style="text-align:center">X&lt;/td>
&lt;td style="text-align:right">X&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">抽象方法(abstract function)&lt;/td>
&lt;td style="text-align:center">X&lt;/td>
&lt;td style="text-align:center">O&lt;/td>
&lt;td style="text-align:right">O&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">實作方法內容(functoin())&lt;/td>
&lt;td style="text-align:center">O&lt;/td>
&lt;td style="text-align:center">O&lt;/td>
&lt;td style="text-align:right">X&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">類別是否可繼承多個&lt;/td>
&lt;td style="text-align:center">X&lt;/td>
&lt;td style="text-align:center">X&lt;/td>
&lt;td style="text-align:right">O&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;/li>
&lt;li>
&lt;p>Trait:自PHP5.4.0起可使用.介於繼承與介面之間的功能,可以參考&lt;a href="http://oomusou.io/php/php-trait/">Trait&lt;/a>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">trait&lt;/span> &lt;span class="nx">PrivateTrait&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl"> &lt;span class="k">private&lt;/span> &lt;span class="nx">privateFunc&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl"> &lt;span class="k">echo&lt;/span> &lt;span class="s2">&amp;#34;This is private&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">PrivateClass&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="k">use&lt;/span> &lt;span class="nx">privateTrait&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="c1">// This is allowed.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">public&lt;/span> &lt;span class="nx">publicFunc&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">privateFunc&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Anonymous classes.PHP7開始支持匿名類別.匿名類別可以創建一次性的簡單對象.&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Overloading:動態創建成員與方法.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-php" data-lang="php">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="nx">void&lt;/span> &lt;span class="nx">__set&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nx">string&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="p">,&lt;/span> &lt;span class="nx">mixed&lt;/span> &lt;span class="nv">$value&lt;/span> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="nx">mixed&lt;/span> &lt;span class="nx">__get&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nx">string&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="nx">bool&lt;/span> &lt;span class="nx">__isset&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nx">string&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="k">public&lt;/span> &lt;span class="nx">void&lt;/span> &lt;span class="nx">__unset&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="nx">string&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">PropertyTest&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="k">private&lt;/span> &lt;span class="nv">$data&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">array&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="nv">$declared&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl"> &lt;span class="k">private&lt;/span> &lt;span class="nv">$hidden&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="fm">__set&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nv">$value&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="fm">__get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">array_key_exists&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">data&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl"> &lt;span class="nv">$trace&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">debug_backtrace&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="nx">trigger_error&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="s1">&amp;#39;Undefined property via __get(): &amp;#39;&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nv">$name&lt;/span> &lt;span class="o">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="s1">&amp;#39; in &amp;#39;&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nv">$trace&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="s1">&amp;#39;file&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl"> &lt;span class="s1">&amp;#39; on line &amp;#39;&lt;/span> &lt;span class="o">.&lt;/span> &lt;span class="nv">$trace&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">][&lt;/span>&lt;span class="s1">&amp;#39;line&amp;#39;&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="nx">E_USER_NOTICE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="k">null&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="fm">__isset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="fm">__unset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> &lt;span class="nx">unset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nv">$name&lt;/span>&lt;span class="p">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl"> &lt;span class="k">public&lt;/span> &lt;span class="k">function&lt;/span> &lt;span class="nf">getHidden&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nv">$this&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">hidden&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl">&lt;span class="nv">$obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">new&lt;/span> &lt;span class="nx">PropertyTest&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">41&lt;/span>&lt;span class="cl">&lt;span class="nv">$obj&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">42&lt;/span>&lt;span class="cl">&lt;span class="k">echo&lt;/span> &lt;span class="nv">$obj&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">a&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">//1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">43&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$obj&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">a&lt;/span>&lt;span class="p">));&lt;/span> &lt;span class="c1">//true
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">44&lt;/span>&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nx">unset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$obj&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">a&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">45&lt;/span>&lt;span class="cl">&lt;span class="nx">var_dump&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">isset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nv">$obj&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="na">a&lt;/span>&lt;span class="p">));&lt;/span> &lt;span class="c1">//false
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>Magic Methods&lt;/p>
&lt;ul>
&lt;li>__sleep()&lt;/li>
&lt;li>__wakeup()&lt;/li>
&lt;li>__construct()&lt;/li>
&lt;li>__destruct()&lt;/li>
&lt;li>__call()&lt;/li>
&lt;li>__callStatic()&lt;/li>
&lt;li>__get()&lt;/li>
&lt;li>__set()&lt;/li>
&lt;li>__isset()&lt;/li>
&lt;li>__unset()&lt;/li>
&lt;li>__sleep()&lt;/li>
&lt;li>__wakeup()&lt;/li>
&lt;li>__toString()&lt;/li>
&lt;li>__invoke()&lt;/li>
&lt;li>__set_state()&lt;/li>
&lt;li>__clone()&lt;/li>
&lt;li>__debugInfo()&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol></description></item><item><title>Microsoft MarkItDown 工具摘要與使用範例</title><link>https://chiehting.com/posts/markitdown/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://chiehting.com/posts/markitdown/</guid><description>
&lt;p>MarkItDown 是由微軟開發的 Python 工具，專門用於將各種文件格式和辦公文檔轉換為 Markdown 格式。這個工具在發布後迅速獲得了廣泛關注。&lt;/p>
&lt;h2 id="github">Github&lt;/h2>
&lt;p>&lt;a href="https://github.com/microsoft/markitdown">https://github.com/microsoft/markitdown&lt;/a>&lt;/p>
&lt;h2 id="格式轉換">格式轉換&lt;/h2>
&lt;p>MarkItDown 支援多種文件格式的轉換，包括：
- PDF
- PowerPoint
- Word
- Excel
- Images (EXIF metadata and OCR)
- Audio (EXIF metadata and speech transcription)
- HTML
- Text-based formats (CSV, JSON, XML)
- ZIP files (iterates over contents)
- Youtube URLs
- EPubs
- ... and more!&lt;/p>
&lt;h2 id="使用範例">使用範例&lt;/h2>
&lt;h3 id="安裝方法">安裝方法&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">pip install markitdown&lt;span class="o">[&lt;/span>all&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="使用命令轉換格式">使用命令轉換格式&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">&lt;span class="c1"># 基本轉換&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">markitdown 1_PDFsam_pool_charlie.pdf -o 1_PDFsam_pool_charlie.md
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="markitdown-將-youtube-轉換成-markdown-的範例">MarkItDown 將 YouTube 轉換成 Markdown 的範例&lt;/h3>
&lt;p>沒什麼作用，因為只是提取了字幕文本，但沒任何 Markdown 語法元素，就結果來說只是個純文本。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">markitdown&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">MarkItDown&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">youtube_transcript_api&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">youtube_to_markdown&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">video_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">languages&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;en&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="s1">&amp;#39;zh-Hant&amp;#39;&lt;/span>&lt;span class="p">]):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl"> &lt;span class="c1"># 使用 youtube_transcript_api 獲取字幕&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl"> &lt;span class="n">transcript&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">youtube_transcript_api&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">YouTubeTranscriptApi&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_transcript&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">video_id&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">languages&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">languages&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl"> &lt;span class="c1"># 將字幕轉換為純文本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl"> &lt;span class="n">transcript_text&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">transcript&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl"> &lt;span class="n">transcript_text&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">line&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;text&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl"> &lt;span class="c1"># 保存為臨時文本文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl"> &lt;span class="n">temp_file&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;temp_transcript.txt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">temp_file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;w&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;utf-8&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">transcript_text&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl"> &lt;span class="c1"># 使用 MarkItDown 轉換為 Markdown&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl"> &lt;span class="n">md&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">MarkItDown&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">md&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">convert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">temp_file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl"> &lt;span class="c1"># 清理臨時文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl"> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">remove&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">temp_file&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl"> &lt;span class="c1"># 從結果對象中提取文本內容&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl"> &lt;span class="c1"># 嘗試可能的屬性或方法&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;text&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">text&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;content&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">content&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;get_text&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_text&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;get_content&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">result&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">get_content&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl"> &lt;span class="c1"># 如果以上都不存在，則嘗試直接將結果轉換為字符串&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">Exception&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">41&lt;/span>&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;轉換失敗: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">42&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">43&lt;/span>&lt;span class="cl">&lt;span class="c1"># 使用示例，如果影片本身沒字幕，則會下載失敗&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">44&lt;/span>&lt;span class="cl">&lt;span class="n">video_id&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;TQDHGswF67Q&amp;#34;&lt;/span> &lt;span class="c1"># YouTube ID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">45&lt;/span>&lt;span class="cl">&lt;span class="n">markdown&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">youtube_to_markdown&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">video_id&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">46&lt;/span>&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">markdown&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">47&lt;/span>&lt;span class="cl">&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">markdown&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">48&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">49&lt;/span>&lt;span class="cl">&lt;span class="c1"># 保存為 Markdown 文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">50&lt;/span>&lt;span class="cl">&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">video_id&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">.md&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;w&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;utf-8&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">51&lt;/span>&lt;span class="cl"> &lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">write&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">markdown&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Redis cluster reshard slots</title><link>https://chiehting.com/posts/redis-cluster-reshard-slots/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://chiehting.com/posts/redis-cluster-reshard-slots/</guid><description>
&lt;p>修復 Redis cluster 節點異常過程紀錄.&lt;/p>
&lt;h3 id="建立新節點">建立新節點&lt;/h3>
&lt;p>進入 Redis cluster&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">redis-cli -c -h 10.0.0.11 -p &lt;span class="m">6379&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>查看 Redis 資訊&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">sudo find / -name redis-trib.rb
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&lt;span class="c1"># 確認節點狀態,這邊發現節點有異常&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">&lt;span class="c1"># [WARNING] Node 10.0.2.12:6379 has slots in migrating state (5489).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">&lt;span class="c1"># [WARNING] Node 10.0.2.13:6380 has slots in importing state (5489).&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="c1"># [WARNING] The following slots are open: 5489&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">./redis-trib.rb check 10.0.2.12:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="c1"># ubuntu @ cache-lottery-staging1 in /usr/share/doc/redis-tools/examples [13:29:42]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">$ ./redis-trib.rb check 10.0.2.12:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">./redis-trib.rb:1573: warning: key &lt;span class="s2">&amp;#34;threshold&amp;#34;&lt;/span> is duplicated and overwritten on line &lt;span class="m">1573&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; Performing Cluster Check &lt;span class="o">(&lt;/span>using node 10.0.2.12:6379&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">M: 752a7943a7a9d1be5e25b73766a2362f89870b87 10.0.2.12:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">slots:5564-10922 &lt;span class="o">(&lt;/span>&lt;span class="m">5359&lt;/span> slots&lt;span class="o">)&lt;/span> master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> additional replica&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">S: 6375a4556ac673c41392e08ca48d43d74b37b3c2 10.0.2.11:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">slots: &lt;span class="o">(&lt;/span>&lt;span class="m">0&lt;/span> slots&lt;span class="o">)&lt;/span> slave
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">replicates 92dd7f73bb6b3aba30b527744057308bc869d48f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">M: 92dd7f73bb6b3aba30b527744057308bc869d48f 10.0.2.12:6380
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">slots:297-5460 &lt;span class="o">(&lt;/span>&lt;span class="m">5164&lt;/span> slots&lt;span class="o">)&lt;/span> master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> additional replica&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">M: 3729b01a6feb9e7b674458355615c17dc2291a12 10.0.2.13:6380
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">slots:0-296,5461-5563,10923-16383 &lt;span class="o">(&lt;/span>&lt;span class="m">5861&lt;/span> slots&lt;span class="o">)&lt;/span> master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> additional replica&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">S: ddfe4daca54b3d07ed3bbd5cb751ea2802ecaec2 10.0.2.13:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">slots: &lt;span class="o">(&lt;/span>&lt;span class="m">0&lt;/span> slots&lt;span class="o">)&lt;/span> slave
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">replicates 3729b01a6feb9e7b674458355615c17dc2291a12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">S: c5433165800a6c0019436891663aa3e9e2da8532 10.0.2.11:6380
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">slots: &lt;span class="o">(&lt;/span>&lt;span class="m">0&lt;/span> slots&lt;span class="o">)&lt;/span> slave
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">replicates 752a7943a7a9d1be5e25b73766a2362f89870b87
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>OK&lt;span class="o">]&lt;/span> All nodes agree about slots configuration.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; Check &lt;span class="k">for&lt;/span> open slots...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">33&lt;/span>&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; Check slots coverage...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">34&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>OK&lt;span class="o">]&lt;/span> All &lt;span class="m">16384&lt;/span> slots covered.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">35&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">36&lt;/span>&lt;span class="cl">&lt;span class="c1"># 修復節點&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">37&lt;/span>&lt;span class="cl">./redis-trib.rb fix 10.0.2.12:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">38&lt;/span>&lt;span class="cl">./redis-trib.rb fix 10.0.2.13:6380
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">39&lt;/span>&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">40&lt;/span>&lt;span class="cl">&lt;span class="c1"># delete solts&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">41&lt;/span>&lt;span class="cl">CLUSTER DELSLOTS &lt;span class="m">297&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">42&lt;/span>&lt;span class="cl">CLUSTER ADDSLOTS &lt;span class="m">297&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">43&lt;/span>&lt;span class="cl">CLUSTER SETSLOT &lt;span class="m">297&lt;/span> STABLE
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>刪除 slave 節點&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">./redis-trib.rb del-node 10.0.2.11:6379 6375a4556ac673c41392e08ca48d43d74b37b3c2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">./redis-trib.rb del-node 10.0.2.11:6380 c5433165800a6c0019436891663aa3e9e2da8532
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>加入節點&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln">1&lt;/span>&lt;span class="cl">./redis-trib.rb add-node 10.0.2.11:6379 10.0.2.12:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">2&lt;/span>&lt;span class="cl">./redis-trib.rb add-node 10.0.2.11:6380 10.0.2.12:6379
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="將-master-的-slots-移到其他-master-節點上">將 master 的 slots 移到其他 master 節點上&lt;/h3>
&lt;p>過程:&lt;/p>
&lt;p>How many slots do you want to move (from 1 to 16384)? 5331 # 移除多少個hash,10.0.2.12:6380有5331個 全部移走&lt;/p>
&lt;p>What is the receiving node ID? 3729b01a6feb9e7b674458355615c17dc2291a12 //接收10.0.2.12:6380節點slot的master 我用10.0.2.13:6380来接收&lt;/p>
&lt;p>Source node #1:92dd7f73bb6b3aba30b527744057308bc869d48f //被删除master的node-id&lt;/p>
&lt;p>Source node #2:done&lt;/p>
&lt;p>Do you want to proceed with the proposed reshard plan (yes/no)? yes //取消slot后，reshard&lt;/p>
&lt;p>執行:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="ln"> 1&lt;/span>&lt;span class="cl">$ ./redis-trib.rb reshard 10.0.2.12:6380
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 2&lt;/span>&lt;span class="cl">./redis-trib.rb:1573: warning: key &lt;span class="s2">&amp;#34;threshold&amp;#34;&lt;/span> is duplicated and overwritten on line &lt;span class="m">1573&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 3&lt;/span>&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; Performing Cluster Check &lt;span class="o">(&lt;/span>using node 10.0.2.12:6380&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 4&lt;/span>&lt;span class="cl">M: 92dd7f73bb6b3aba30b527744057308bc869d48f 10.0.2.12:6380
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 5&lt;/span>&lt;span class="cl">slots:130-5460 &lt;span class="o">(&lt;/span>&lt;span class="m">5331&lt;/span> slots&lt;span class="o">)&lt;/span> master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 6&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> additional replica&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 7&lt;/span>&lt;span class="cl">M: 752a7943a7a9d1be5e25b73766a2362f89870b87 10.0.2.12:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 8&lt;/span>&lt;span class="cl">slots:5490-10922 &lt;span class="o">(&lt;/span>&lt;span class="m">5433&lt;/span> slots&lt;span class="o">)&lt;/span> master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln"> 9&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> additional replica&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">10&lt;/span>&lt;span class="cl">S: ddfe4daca54b3d07ed3bbd5cb751ea2802ecaec2 10.0.2.13:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">11&lt;/span>&lt;span class="cl">slots: &lt;span class="o">(&lt;/span>&lt;span class="m">0&lt;/span> slots&lt;span class="o">)&lt;/span> slave
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">12&lt;/span>&lt;span class="cl">replicates 3729b01a6feb9e7b674458355615c17dc2291a12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">13&lt;/span>&lt;span class="cl">S: c5433165800a6c0019436891663aa3e9e2da8532 10.0.2.11:6380
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">14&lt;/span>&lt;span class="cl">slots: &lt;span class="o">(&lt;/span>&lt;span class="m">0&lt;/span> slots&lt;span class="o">)&lt;/span> slave
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">15&lt;/span>&lt;span class="cl">replicates 752a7943a7a9d1be5e25b73766a2362f89870b87
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">16&lt;/span>&lt;span class="cl">S: 6375a4556ac673c41392e08ca48d43d74b37b3c2 10.0.2.11:6379
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">17&lt;/span>&lt;span class="cl">slots: &lt;span class="o">(&lt;/span>&lt;span class="m">0&lt;/span> slots&lt;span class="o">)&lt;/span> slave
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">18&lt;/span>&lt;span class="cl">replicates 92dd7f73bb6b3aba30b527744057308bc869d48f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">19&lt;/span>&lt;span class="cl">M: 3729b01a6feb9e7b674458355615c17dc2291a12 10.0.2.13:6380
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">20&lt;/span>&lt;span class="cl">slots:0-129,5461-5489,10923-16383 &lt;span class="o">(&lt;/span>&lt;span class="m">5620&lt;/span> slots&lt;span class="o">)&lt;/span> master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">21&lt;/span>&lt;span class="cl">&lt;span class="m">1&lt;/span> additional replica&lt;span class="o">(&lt;/span>s&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">22&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>OK&lt;span class="o">]&lt;/span> All nodes agree about slots configuration.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">23&lt;/span>&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; Check &lt;span class="k">for&lt;/span> open slots...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">24&lt;/span>&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt; Check slots coverage...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">25&lt;/span>&lt;span class="cl">&lt;span class="o">[&lt;/span>OK&lt;span class="o">]&lt;/span> All &lt;span class="m">16384&lt;/span> slots covered.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">26&lt;/span>&lt;span class="cl">How many slots &lt;span class="k">do&lt;/span> you want to move &lt;span class="o">(&lt;/span>from &lt;span class="m">1&lt;/span> to 16384&lt;span class="o">)&lt;/span>? &lt;span class="m">5331&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">27&lt;/span>&lt;span class="cl">What is the receiving node ID? 3729b01a6feb9e7b674458355615c17dc2291a12
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">28&lt;/span>&lt;span class="cl">Please enter all the &lt;span class="nb">source&lt;/span> node IDs.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">29&lt;/span>&lt;span class="cl">Type &lt;span class="s1">&amp;#39;all&amp;#39;&lt;/span> to use all the nodes as &lt;span class="nb">source&lt;/span> nodes &lt;span class="k">for&lt;/span> the &lt;span class="nb">hash&lt;/span> slots.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">30&lt;/span>&lt;span class="cl">Type &lt;span class="s1">&amp;#39;done&amp;#39;&lt;/span> once you entered all the &lt;span class="nb">source&lt;/span> nodes IDs.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">31&lt;/span>&lt;span class="cl">Source node &lt;span class="c1">#1:92dd7f73bb6b3aba30b527744057308bc869d48f&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="ln">32&lt;/span>&lt;span class="cl">Source node &lt;span class="c1">#2:done&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>